import{c as Vl,l as Ll,m as $l,a as $,d as _e,j as Ht,f as te,o as St,t as yr}from"../chunks/B7hL-_wf.js";import{o as xa}from"../chunks/CVCaHu-P.js";import{I as sc,h as At,J as Va,l as _,an as Wl,ah as Hl,L as jl,_ as to,Y as zi,aa as oa,e as oi,K as ql,af as Kl,X as ro,c as vi,a as Ra,a$ as Dr,b as Ls,s as Gl,D as io,aB as Ql,ad as gn,aP as Xl,b0 as Zl,b1 as Yl,b2 as Jl,r as nc,p as oc,b3 as us,a8 as ed,ac as td,d as rd,a6 as cc,b4 as lc,G as dc,b5 as id,H as La,a1 as uc,b6 as ad,aM as sd,ai as nd,i as ma,b7 as od,aI as fc,aw as cd,b8 as Yi,b9 as ld,ba as dd,bb as ud,bc as fd,aH as hd,bd as hc,E as mc,aD as md,be as pd,v as Xt,y as Zt,n as Ji,z as I,B as O,A as P,w as pe,aE as Ge,bf as gd,x as Te,ap as se,aC as We,Z as Ie,ao as Mi,g as qi,bg as ca}from"../chunks/BeLsdaSC.js";import{a as vd,b as Ia,s as ke}from"../chunks/Ddfo-JlV.js";import{l as Oe,p as wr,s as Ve,i as oe,b as Vi,c as vn}from"../chunks/BPYUTvN7.js";import{a as ao,s as pt,b as at,c as kr,r as Da,d as so}from"../chunks/Bnfb8612.js";import{b as no}from"../chunks/y-LOXg8N.js";import{i as bd}from"../chunks/CSbSVjP0.js";import{B as wd}from"../chunks/gOPg38Gg.js";function Ct(r,e){return e}function kd(r,e,t){for(var i=[],a=e.length,n,s=e.length,o=0;o<a;o++){let u=e[o];oc(u,()=>{if(n){if(n.pending.delete(u),n.done.add(u),n.pending.size===0){var f=r.outrogroups;$s(gn(n.done)),f.delete(n),f.size===0&&(r.outrogroups=null)}}else s-=1},!1)}if(s===0){var c=i.length===0&&t!==null;if(c){var l=t,d=l.parentNode;td(d),d.append(l),r.items.clear()}$s(e,!c)}else n={pending:new Set(e),done:new Set},(r.outrogroups??=new Set).add(n)}function $s(r,e=!0){for(var t=0;t<r.length;t++)rd(r[t],e)}var oo;function _t(r,e,t,i,a,n=null){var s=r,o=new Map,c=(e&lc)!==0;if(c){var l=r;s=At?zi(cc(l)):l.appendChild(Ra())}At&&Va();var d=null,u=Wl(()=>{var v=t();return Xl(v)?v:v==null?[]:gn(v)}),f,h=!0;function g(){p.fallback=d,yd(p,f,s,e,i),d!==null&&(f.length===0?(d.f&Dr)===0?nc(d):(d.f^=Dr,aa(d,null,s)):oc(d,()=>{d=null}))}var m=sc(()=>{f=_(u);var v=f.length;let b=!1;if(At){var w=Hl(s)===jl;w!==(v===0)&&(s=to(),zi(s),oa(!1),b=!0)}for(var x=new Set,T=vi,A=Gl(),B=0;B<v;B+=1){At&&oi.nodeType===ql&&oi.data===Kl&&(s=oi,b=!0,oa(!1));var z=f[B],M=i(z,B),W=h?null:o.get(M);W?(W.v&&ro(W.v,z),W.i&&ro(W.i,B),A&&T.skipped_effects.delete(W.e)):(W=xd(o,h?s:oo??=Ra(),z,M,B,a,e,t),h||(W.e.f|=Dr),o.set(M,W)),x.add(M)}if(v===0&&n&&!d&&(h?d=Ls(()=>n(s)):(d=Ls(()=>n(oo??=Ra())),d.f|=Dr)),At&&v>0&&zi(to()),!h)if(A){for(const[G,C]of o)x.has(G)||T.skipped_effects.add(C.e);T.oncommit(g),T.ondiscard(()=>{})}else g();b&&oa(!0),_(u)}),p={effect:m,items:o,outrogroups:null,fallback:d};h=!1,At&&(s=oi)}function yd(r,e,t,i,a){var n=(i&id)!==0,s=e.length,o=r.items,c=r.effect.first,l,d=null,u,f=[],h=[],g,m,p,v;if(n)for(v=0;v<s;v+=1)g=e[v],m=a(g,v),p=o.get(m).e,(p.f&Dr)===0&&(p.nodes?.a?.measure(),(u??=new Set).add(p));for(v=0;v<s;v+=1){if(g=e[v],m=a(g,v),p=o.get(m).e,r.outrogroups!==null)for(const W of r.outrogroups)W.pending.delete(p),W.done.delete(p);if((p.f&Dr)!==0)if(p.f^=Dr,p===c)aa(p,null,t);else{var b=d?d.next:c;p===r.effect.last&&(r.effect.last=p.prev),p.prev&&(p.prev.next=p.next),p.next&&(p.next.prev=p.prev),Lr(r,d,p),Lr(r,p,b),aa(p,b,t),d=p,f=[],h=[],c=d.next;continue}if((p.f&us)!==0&&(nc(p),n&&(p.nodes?.a?.unfix(),(u??=new Set).delete(p))),p!==c){if(l!==void 0&&l.has(p)){if(f.length<h.length){var w=h[0],x;d=w.prev;var T=f[0],A=f[f.length-1];for(x=0;x<f.length;x+=1)aa(f[x],w,t);for(x=0;x<h.length;x+=1)l.delete(h[x]);Lr(r,T.prev,A.next),Lr(r,d,T),Lr(r,A,w),c=w,d=A,v-=1,f=[],h=[]}else l.delete(p),aa(p,c,t),Lr(r,p.prev,p.next),Lr(r,p,d===null?r.effect.first:d.next),Lr(r,d,p),d=p;continue}for(f=[],h=[];c!==null&&c!==p;)(l??=new Set).add(c),h.push(c),c=c.next;if(c===null)continue}(p.f&Dr)===0&&f.push(p),d=p,c=p.next}if(r.outrogroups!==null){for(const W of r.outrogroups)W.pending.size===0&&($s(gn(W.done)),r.outrogroups?.delete(W));r.outrogroups.size===0&&(r.outrogroups=null)}if(c!==null||l!==void 0){var B=[];if(l!==void 0)for(p of l)(p.f&us)===0&&B.push(p);for(;c!==null;)(c.f&us)===0&&c!==r.fallback&&B.push(c),c=c.next;var z=B.length;if(z>0){var M=(i&lc)!==0&&s===0?t:null;if(n){for(v=0;v<z;v+=1)B[v].nodes?.a?.measure();for(v=0;v<z;v+=1)B[v].nodes?.a?.fix()}kd(r,B,M)}}n&&dc(()=>{if(u!==void 0)for(p of u)p.nodes?.a?.apply()})}function xd(r,e,t,i,a,n,s,o){var c=(s&Zl)!==0?(s&Yl)===0?Ql(t,!1,!1):io(t):null,l=(s&Jl)!==0?io(a):null;return{v:c,i:l,e:Ls(()=>(n(e,c??t,l??a,o),()=>{r.delete(i)}))}}function aa(r,e,t){if(r.nodes)for(var i=r.nodes.start,a=r.nodes.end,n=e&&(e.f&Dr)===0?e.nodes.start:t;i!==null;){var s=ed(i);if(n.before(i),i===a)return;i=s}}function Lr(r,e,t){e===null?r.effect.first=t:e.next=t,t===null?r.effect.last=e:t.prev=e}function Ne(r,e,t,i,a){At&&Va();var n=e.$$slots?.[t],s=!1;n===!0&&(n=e.children,s=!0),n===void 0||n(r,s?()=>i:i)}const _d=()=>performance.now(),zr={tick:r=>requestAnimationFrame(r),now:()=>_d(),tasks:new Set};function pc(){const r=zr.now();zr.tasks.forEach(e=>{e.c(r)||(zr.tasks.delete(e),e.f())}),zr.tasks.size!==0&&zr.tick(pc)}function Td(r){let e;return zr.tasks.size===0&&zr.tick(pc),{promise:new Promise(t=>{zr.tasks.add(e={c:r,f:t})}),abort(){zr.tasks.delete(e)}}}function Aa(r,e){fc(()=>{r.dispatchEvent(new CustomEvent(e))})}function Sd(r){if(r==="float")return"cssFloat";if(r==="offset")return"cssOffset";if(r.startsWith("--"))return r;const e=r.split("-");return e.length===1?e[0]:e[0]+e.slice(1).map(t=>t[0].toUpperCase()+t.slice(1)).join("")}function co(r){const e={},t=r.split(";");for(const i of t){const[a,n]=i.split(":");if(!a||n===void 0)break;const s=Sd(a.trim());e[s]=n.trim()}return e}const Cd=r=>r;let gc=null;function lo(r){gc=r}function Pd(r,e,t){var i=gc??La,a=i.nodes,n,s,o,c=null;a.a??={element:r,measure(){n=this.element.getBoundingClientRect()},apply(){if(o?.abort(),s=this.element.getBoundingClientRect(),n.left!==s.left||n.right!==s.right||n.top!==s.top||n.bottom!==s.bottom){const l=e()(this.element,{from:n,to:s},t?.());o=$a(this.element,l,void 0,1,()=>{o?.abort(),o=void 0})}},fix(){if(!r.getAnimations().length){var{position:l,width:d,height:u}=getComputedStyle(r);if(l!=="absolute"&&l!=="fixed"){var f=r.style;c={position:f.position,width:f.width,height:f.height,transform:f.transform},f.position="absolute",f.width=d,f.height=u;var h=r.getBoundingClientRect();if(n.left!==h.left||n.top!==h.top){var g=`translate(${n.left-h.left}px, ${n.top-h.top}px)`;f.transform=f.transform?`${f.transform} ${g}`:g}}}},unfix(){if(c){var l=r.style;l.position=c.position,l.width=c.width,l.height=c.height,l.transform=c.transform}}},a.a.element=r}function ut(r,e,t,i){var a=(r&ld)!==0,n=(r&dd)!==0,s=a&&n,o=(r&od)!==0,c=s?"both":a?"in":"out",l,d=e.inert,u=e.style.overflow,f,h;function g(){return fc(()=>l??=t()(e,i?.()??{},{direction:c}))}var m={is_global:o,in(){if(e.inert=d,!a){h?.abort(),h?.reset?.();return}n||f?.abort(),Aa(e,"introstart"),f=$a(e,g(),h,1,()=>{Aa(e,"introend"),f?.abort(),f=l=void 0,e.style.overflow=u})},out(w){if(!n){w?.(),l=void 0;return}e.inert=!0,Aa(e,"outrostart"),h=$a(e,g(),f,0,()=>{Aa(e,"outroend"),w?.()})},stop:()=>{f?.abort(),h?.abort()}},p=La;if((p.nodes.t??=[]).push(m),a&&vd){var v=o;if(!v){for(var b=p.parent;b&&(b.f&uc)!==0;)for(;(b=b.parent)&&(b.f&ad)===0;);v=!b||(b.f&sd)!==0}v&&nd(()=>{ma(()=>m.in())})}}function $a(r,e,t,i,a){var n=i===1;if(cd(e)){var s,o=!1;return dc(()=>{if(!o){var p=e({direction:n?"in":"out"});s=$a(r,p,t,i,a)}}),{abort:()=>{o=!0,s?.abort()},deactivate:()=>s.deactivate(),reset:()=>s.reset(),t:()=>s.t()}}if(t?.deactivate(),!e?.duration)return a(),{abort:Yi,deactivate:Yi,reset:Yi,t:()=>i};const{delay:c=0,css:l,tick:d,easing:u=Cd}=e;var f=[];if(n&&t===void 0&&(d&&d(0,1),l)){var h=co(l(0,1));f.push(h,h)}var g=()=>1-i,m=r.animate(f,{duration:c,fill:"forwards"});return m.onfinish=()=>{m.cancel();var p=t?.t()??1-i;t?.abort();var v=i-p,b=e.duration*Math.abs(v),w=[];if(b>0){var x=!1;if(l)for(var T=Math.ceil(b/16.666666666666668),A=0;A<=T;A+=1){var B=p+v*u(A/T),z=co(l(B,1-B));w.push(z),x||=z.overflow==="hidden"}x&&(r.style.overflow="hidden"),g=()=>{var M=m.currentTime;return p+v*u(M/b)},d&&Td(()=>{if(m.playState!=="running")return!1;var M=g();return d(M,1-M),!0})}m=r.animate(w,{duration:b,fill:"forwards"}),m.onfinish=()=>{g=()=>i,d?.(i,1-i),a()}},{abort:()=>{m&&(m.cancel(),m.effect=null,m.onfinish=Yi)},deactivate:()=>{a=Yi},reset:()=>{i===0&&d?.(1,0)},t:()=>g()}}function Ed(r,e,t,i,a,n){let s=At;At&&Va();var o=null;At&&oi.nodeType===ud&&(o=oi,Va());var c=At?oi:r,l=La,d=new wd(c,!1);sc(()=>{const u=e()||null;var f=fd;if(u===null){d.ensure(null,null),Ia(!0);return}return d.ensure(u,h=>{if(u){if(o=At?o:document.createElementNS(f,u),Vl(o,o),i){At&&Ll(u)&&o.append(document.createComment(""));var g=At?cc(o):o.appendChild(Ra());At&&(g===null?oa(!1):zi(g)),lo(l),i(o,g),lo(null)}La.nodes.end=o,h.before(o)}At&&zi(h)}),Ia(!0),()=>{u&&Ia(!1)}},uc),hd(()=>{Ia(!0)}),s&&(oa(!0),zi(c))}function Id(r,e,t=e){var i=new WeakSet;hc(r,"input",async a=>{var n=a?r.defaultValue:r.value;if(n=fs(r)?hs(n):n,t(n),vi!==null&&i.add(vi),await md(),n!==(n=e())){var s=r.selectionStart,o=r.selectionEnd,c=r.value.length;if(r.value=n??"",o!==null){var l=r.value.length;s===o&&o===c&&l>c?(r.selectionStart=l,r.selectionEnd=l):(r.selectionStart=s,r.selectionEnd=Math.min(o,l))}}}),(At&&r.defaultValue!==r.value||ma(e)==null&&r.value)&&(t(fs(r)?hs(r.value):r.value),vi!==null&&i.add(vi)),mc(()=>{var a=e();if(r===document.activeElement){var n=pd??vi;if(i.has(n))return}fs(r)&&a===hs(r.value)||r.type==="date"&&!a&&!r.value||a!==r.value&&(r.value=a??"")})}function Ad(r,e,t=e){hc(r,"change",i=>{var a=i?r.defaultChecked:r.checked;t(a)}),(At&&r.defaultChecked!==r.checked||ma(e)==null)&&t(r.checked),mc(()=>{var i=e();r.checked=!!i})}function fs(r){var e=r.type;return e==="number"||e==="range"}function hs(r){return r===""?null:+r}const Fd={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":2,"stroke-linecap":"round","stroke-linejoin":"round"};var Bd=$l("<svg><!><!></svg>");function Le(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]),i=Oe(t,["name","color","size","strokeWidth","absoluteStrokeWidth","iconNode"]);Xt(e,!1);let a=wr(e,"name",8,void 0),n=wr(e,"color",8,"currentColor"),s=wr(e,"size",8,24),o=wr(e,"strokeWidth",8,2),c=wr(e,"absoluteStrokeWidth",8,!1),l=wr(e,"iconNode",24,()=>[]);const d=(...g)=>g.filter((m,p,v)=>!!m&&v.indexOf(m)===p).join(" ");bd();var u=Bd();ao(u,(g,m)=>({...Fd,...i,width:s(),height:s(),stroke:n(),"stroke-width":g,class:m}),[()=>(Ji(c()),Ji(o()),Ji(s()),ma(()=>c()?Number(o())*24/Number(s()):o())),()=>(Ji(a()),Ji(t),ma(()=>d("lucide-icon","lucide",a()?`lucide-${a()}`:"",t.class)))]);var f=I(u);_t(f,1,l,Ct,(g,m)=>{var p=Ge(()=>gd(_(m),2));let v=()=>_(p)[0],b=()=>_(p)[1];var w=_e(),x=pe(w);Ed(x,v,!0,(T,A)=>{ao(T,()=>({...b()}))}),$(g,w)});var h=O(f);Ne(h,e,"default",{}),P(u),$(r,u),Zt()}function vc(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2"}]];Le(r,Ve({name:"activity"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function Ws(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M5 12h14"}],["path",{d:"m12 5 7 7-7 7"}]];Le(r,Ve({name:"arrow-right"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function la(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M20 6 9 17l-5-5"}]];Le(r,Ve({name:"check"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function Wa(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"m6 9 6 6 6-6"}]];Le(r,Ve({name:"chevron-down"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function zd(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"m15 18-6-6 6-6"}]];Le(r,Ve({name:"chevron-left"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function Md(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"m9 18 6-6-6-6"}]];Le(r,Ve({name:"chevron-right"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function Rd(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"m18 15-6-6-6 6"}]];Le(r,Ve({name:"chevron-up"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function bc(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["circle",{cx:"12",cy:"12",r:"10"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16"}]];Le(r,Ve({name:"circle-alert"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function Dd(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"}]];Le(r,Ve({name:"clipboard"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function Od(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M10 2v2"}],["path",{d:"M14 2v2"}],["path",{d:"M16 8a1 1 0 0 1 1 1v8a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4V9a1 1 0 0 1 1-1h14a4 4 0 1 1 0 8h-1"}],["path",{d:"M6 2v2"}]];Le(r,Ve({name:"coffee"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function Hs(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M12 20v2"}],["path",{d:"M12 2v2"}],["path",{d:"M17 20v2"}],["path",{d:"M17 2v2"}],["path",{d:"M2 12h2"}],["path",{d:"M2 17h2"}],["path",{d:"M2 7h2"}],["path",{d:"M20 12h2"}],["path",{d:"M20 17h2"}],["path",{d:"M20 7h2"}],["path",{d:"M7 20v2"}],["path",{d:"M7 2v2"}],["rect",{x:"4",y:"4",width:"16",height:"16",rx:"2"}],["rect",{x:"8",y:"8",width:"8",height:"8",rx:"1"}]];Le(r,Ve({name:"cpu"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function Nd(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["circle",{cx:"12",cy:"12",r:"10"}],["path",{d:"M6 12c0-1.7.7-3.2 1.8-4.2"}],["circle",{cx:"12",cy:"12",r:"2"}],["path",{d:"M18 12c0 1.7-.7 3.2-1.8 4.2"}]];Le(r,Ve({name:"disc-3"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function Ha(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M12 15V3"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}],["path",{d:"m7 10 5 5 5-5"}]];Le(r,Ve({name:"download"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function Ud(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z"}],["path",{d:"M14 2v5a1 1 0 0 0 1 1h5"}],["path",{d:"M10 9H8"}],["path",{d:"M16 13H8"}],["path",{d:"M16 17H8"}]];Le(r,Ve({name:"file-text"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function Li(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2"}],["path",{d:"M7 3v18"}],["path",{d:"M3 7.5h4"}],["path",{d:"M3 12h18"}],["path",{d:"M3 16.5h4"}],["path",{d:"M17 3v18"}],["path",{d:"M17 7.5h4"}],["path",{d:"M17 16.5h4"}]];Le(r,Ve({name:"film"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function Vd(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"m12 14 4-4"}],["path",{d:"M3.34 19a10 10 0 1 1 17.32 0"}]];Le(r,Ve({name:"gauge"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function wc(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"}],["path",{d:"M9 18c-4.51 2-5-2-7-2"}]];Le(r,Ve({name:"github"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function js(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M2 21V3"}],["path",{d:"M2 5h18a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2.26"}],["path",{d:"M7 17v3a1 1 0 0 0 1 1h5a1 1 0 0 0 1-1v-3"}],["circle",{cx:"16",cy:"11",r:"2"}],["circle",{cx:"8",cy:"11",r:"2"}]];Le(r,Ve({name:"gpu"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function Ld(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["circle",{cx:"9",cy:"12",r:"1"}],["circle",{cx:"9",cy:"5",r:"1"}],["circle",{cx:"9",cy:"19",r:"1"}],["circle",{cx:"15",cy:"12",r:"1"}],["circle",{cx:"15",cy:"5",r:"1"}],["circle",{cx:"15",cy:"19",r:"1"}]];Le(r,Ve({name:"grip-vertical"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function $d(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["line",{x1:"22",x2:"2",y1:"12",y2:"12"}],["path",{d:"M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"}],["line",{x1:"6",x2:"6.01",y1:"16",y2:"16"}],["line",{x1:"10",x2:"10.01",y1:"16",y2:"16"}]];Le(r,Ve({name:"hard-drive"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function Wd(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5"}]];Le(r,Ve({name:"heart"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function Hd(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2"}],["circle",{cx:"9",cy:"9",r:"2"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"}]];Le(r,Ve({name:"image"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function bn(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["circle",{cx:"12",cy:"12",r:"10"}],["path",{d:"M12 16v-4"}],["path",{d:"M12 8h.01"}]];Le(r,Ve({name:"info"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function kc(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M10 8h.01"}],["path",{d:"M12 12h.01"}],["path",{d:"M14 8h.01"}],["path",{d:"M16 12h.01"}],["path",{d:"M18 8h.01"}],["path",{d:"M6 8h.01"}],["path",{d:"M7 16h10"}],["path",{d:"M8 12h.01"}],["rect",{width:"20",height:"16",x:"2",y:"4",rx:"2"}]];Le(r,Ve({name:"keyboard"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function jd(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83z"}],["path",{d:"M2 12a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 12"}],["path",{d:"M2 17a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 17"}]];Le(r,Ve({name:"layers"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function qd(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"}],["rect",{width:"4",height:"12",x:"2",y:"9"}],["circle",{cx:"4",cy:"4",r:"2"}]];Le(r,Ve({name:"linkedin"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function Kd(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56"}]];Le(r,Ve({name:"loader-circle"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function Gd(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M8 3H5a2 2 0 0 0-2 2v3"}],["path",{d:"M21 8V5a2 2 0 0 0-2-2h-3"}],["path",{d:"M3 16v3a2 2 0 0 0 2 2h3"}],["path",{d:"M16 21h3a2 2 0 0 0 2-2v-3"}]];Le(r,Ve({name:"maximize"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function wn(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z"}]];Le(r,Ve({name:"play"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function uo(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"}],["path",{d:"M21 3v5h-5"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"}],["path",{d:"M8 16H3v5"}]];Le(r,Ve({name:"refresh-cw"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function Qd(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"}],["path",{d:"M3 3v5h5"}]];Le(r,Ve({name:"rotate-ccw"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function fo(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["circle",{cx:"6",cy:"6",r:"3"}],["path",{d:"M8.12 8.12 12 12"}],["path",{d:"M20 4 8.12 15.88"}],["circle",{cx:"6",cy:"18",r:"3"}],["path",{d:"M14.8 14.8 20 20"}]];Le(r,Ve({name:"scissors"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function ho(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["rect",{width:"20",height:"8",x:"2",y:"2",rx:"2",ry:"2"}],["rect",{width:"20",height:"8",x:"2",y:"14",rx:"2",ry:"2"}],["line",{x1:"6",x2:"6.01",y1:"6",y2:"6"}],["line",{x1:"6",x2:"6.01",y1:"18",y2:"18"}]];Le(r,Ve({name:"server"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function mo(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M14 17H5"}],["path",{d:"M19 7h-9"}],["circle",{cx:"17",cy:"17",r:"3"}],["circle",{cx:"7",cy:"7",r:"3"}]];Le(r,Ve({name:"settings-2"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function yc(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"}]];Le(r,Ve({name:"shield"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function Xd(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M10 8h4"}],["path",{d:"M12 21v-9"}],["path",{d:"M12 8V3"}],["path",{d:"M17 16h4"}],["path",{d:"M19 12V3"}],["path",{d:"M19 21v-5"}],["path",{d:"M3 14h4"}],["path",{d:"M5 10V3"}],["path",{d:"M5 21v-7"}]];Le(r,Ve({name:"sliders-vertical"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function po(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M11.017 2.814a1 1 0 0 1 1.966 0l1.051 5.558a2 2 0 0 0 1.594 1.594l5.558 1.051a1 1 0 0 1 0 1.966l-5.558 1.051a2 2 0 0 0-1.594 1.594l-1.051 5.558a1 1 0 0 1-1.966 0l-1.051-5.558a2 2 0 0 0-1.594-1.594l-5.558-1.051a1 1 0 0 1 0-1.966l5.558-1.051a2 2 0 0 0 1.594-1.594z"}],["path",{d:"M20 2v4"}],["path",{d:"M22 4h-4"}],["circle",{cx:"4",cy:"20",r:"2"}]];Le(r,Ve({name:"sparkles"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function Zd(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M8 19H5c-1 0-2-1-2-2V7c0-1 1-2 2-2h3"}],["path",{d:"M16 5h3c1 0 2 1 2 2v10c0 1-1 2-2 2h-3"}],["line",{x1:"12",x2:"12",y1:"4",y2:"20"}]];Le(r,Ve({name:"square-split-horizontal"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function Yd(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M10 11v6"}],["path",{d:"M14 11v6"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"}],["path",{d:"M3 6h18"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"}]];Le(r,Ve({name:"trash-2"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function xc(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"}],["path",{d:"M12 9v4"}],["path",{d:"M12 17h.01"}]];Le(r,Ve({name:"triangle-alert"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function qs(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M12 3v12"}],["path",{d:"m17 8-5-5-5 5"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}]];Le(r,Ve({name:"upload"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function Jd(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z"}],["path",{d:"M16 9a5 5 0 0 1 0 6"}],["path",{d:"M19.364 18.364a9 9 0 0 0 0-12.728"}]];Le(r,Ve({name:"volume-2"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function go(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M12 20h.01"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0"}],["path",{d:"M5 12.859a10 10 0 0 1 5.17-2.69"}],["path",{d:"M19 12.859a10 10 0 0 0-2.007-1.523"}],["path",{d:"M2 8.82a15 15 0 0 1 4.177-2.643"}],["path",{d:"M22 8.82a15 15 0 0 0-11.288-3.764"}],["path",{d:"m2 2 20 20"}]];Le(r,Ve({name:"wifi-off"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function _r(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M18 6 6 18"}],["path",{d:"m6 6 12 12"}]];Le(r,Ve({name:"x"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}function _c(r,e){const t=Oe(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z"}]];Le(r,Ve({name:"zap"},()=>t,{get iconNode(){return i},children:(a,n)=>{var s=_e(),o=pe(s);Ne(o,e,"default",{}),$(a,s)},$$slots:{default:!0}}))}const eu=r=>r;function kn(r){const e=r-1;return e*e*e+1}function vo(r){const e=typeof r=="string"&&r.match(/^\s*(-?[\d.]+)([^\s]*)\s*$/);return e?[parseFloat(e[1]),e[2]||"px"]:[r,"px"]}function Qt(r,{delay:e=0,duration:t=400,easing:i=eu}={}){const a=+getComputedStyle(r).opacity;return{delay:e,duration:t,easing:i,css:n=>`opacity: ${n*a}`}}function Tc(r,{delay:e=0,duration:t=400,easing:i=kn,x:a=0,y:n=0,opacity:s=0}={}){const o=getComputedStyle(r),c=+o.opacity,l=o.transform==="none"?"":o.transform,d=c*(1-s),[u,f]=vo(a),[h,g]=vo(n);return{delay:e,duration:t,easing:i,css:(m,p)=>`
			transform: ${l} translate(${(1-m)*u}${f}, ${(1-m)*h}${g});
			opacity: ${c-d*p}`}}function ja(r,{delay:e=0,duration:t=400,easing:i=kn,axis:a="y"}={}){const n=getComputedStyle(r),s=+n.opacity,o=a==="y"?"height":"width",c=parseFloat(n[o]),l=a==="y"?["top","bottom"]:["left","right"],d=l.map(v=>`${v[0].toUpperCase()}${v.slice(1)}`),u=parseFloat(n[`padding${d[0]}`]),f=parseFloat(n[`padding${d[1]}`]),h=parseFloat(n[`margin${d[0]}`]),g=parseFloat(n[`margin${d[1]}`]),m=parseFloat(n[`border${d[0]}Width`]),p=parseFloat(n[`border${d[1]}Width`]);return{delay:e,duration:t,easing:i,css:v=>`overflow: hidden;opacity: ${Math.min(v*20,1)*s};${o}: ${v*c}px;padding-${l[0]}: ${v*u}px;padding-${l[1]}: ${v*f}px;margin-${l[0]}: ${v*h}px;margin-${l[1]}: ${v*g}px;border-${l[0]}-width: ${v*m}px;border-${l[1]}-width: ${v*p}px;min-${o}: 0`}}function Ri(r,{delay:e=0,duration:t=400,easing:i=kn,start:a=0,opacity:n=0}={}){const s=getComputedStyle(r),o=+s.opacity,c=s.transform==="none"?"":s.transform,l=1-a,d=o*(1-n);return{delay:e,duration:t,easing:i,css:(u,f)=>`
			transform: ${c} scale(${1-l*f});
			opacity: ${o-d*f}
		`}}var tu=te(`<div class="flex items-center gap-2 rounded-xl bg-amber-500/20 px-3 py-2 text-amber-400" title="You're offline - app still works!"><!> <span class="hidden text-sm font-medium sm:inline">Offline</span></div>`),ru=te(`<div class="fixed left-1/2 top-20 z-50 flex -translate-x-1/2 items-center gap-3 rounded-xl bg-amber-500 px-4 py-3 text-white shadow-lg"><!> <div><p class="font-medium">You're offline</p> <p class="text-sm text-amber-100">Don't worry, Squash works offline!</p></div></div>`),iu=te('<header class="fixed left-0 right-0 top-0 z-50 px-4 py-4 sm:px-6 lg:px-8"><div class="mx-auto max-w-7xl"><nav class="glass flex items-center justify-between rounded-2xl px-4 py-3 shadow-lg shadow-black/5 sm:px-6"><a class="group flex items-center gap-3"><div class="from-accent-start to-accent-end shadow-accent-start/30 flex h-10 w-10 items-center justify-center rounded-xl bg-gradient-to-br shadow-lg transition-transform group-hover:scale-110"><!></div> <span class="text-xl font-semibold tracking-tight"><span class="gradient-text">Squash</span></span></a> <div class="flex items-center gap-2"><!> <a href="https://github.com/ishanjalan/Neutron/tree/main/apps/squash" target="_blank" rel="noopener noreferrer" class="text-surface-400 hover:bg-surface-800 hover:text-surface-100 flex h-10 w-10 items-center justify-center rounded-xl transition-all" title="View on GitHub"><!></a></div></nav></div></header> <!>',1);function au(r,e){Xt(e,!0);let t=We(!0),i=We(!1);xa(()=>{se(t,navigator.onLine,!0);const b=()=>{se(t,!0),se(i,!1)},w=()=>{se(t,!1),se(i,!0),setTimeout(()=>{se(i,!1)},5e3)};return window.addEventListener("online",b),window.addEventListener("offline",w),()=>{window.removeEventListener("online",b),window.removeEventListener("offline",w)}});var a=iu(),n=pe(a),s=I(n),o=I(s),c=I(o);c.__click=b=>{b.preventDefault(),window.scrollTo({top:0,behavior:"smooth"}),window.scrollY===0&&(window.location.href=`${no}/`)};var l=I(c),d=I(l);Li(d,{class:"h-5 w-5 text-white",strokeWidth:2.5}),P(l),Ie(2),P(c);var u=O(c,2),f=I(u);{var h=b=>{var w=tu(),x=I(w);go(x,{class:"h-4 w-4"}),Ie(2),P(w),ut(3,w,()=>Qt,()=>({duration:150})),$(b,w)};oe(f,b=>{_(t)||b(h)})}var g=O(f,2),m=I(g);wc(m,{class:"h-5 w-5"}),P(g),P(u),P(o),P(s),P(n);var p=O(n,2);{var v=b=>{var w=ru(),x=I(w);go(x,{class:"h-5 w-5"}),Ie(2),P(w),ut(3,w,()=>Qt,()=>({duration:200})),$(b,w)};oe(p,b=>{_(i)&&b(v)})}Te(()=>pt(c,"href",`${no??""}/`)),$(r,a),Zt()}Ht(["click"]);var su=te('<footer class="mt-16 border-t border-white/5 bg-black/30 py-12"><div class="mx-auto max-w-6xl px-4 sm:px-6"><div class="mb-8 text-center"><div class="mb-6 inline-flex items-center gap-2 text-xs font-semibold uppercase tracking-wider text-white/50"><!> <span>The Neutron Suite</span> <!></div> <div class="grid grid-cols-4 gap-3 sm:gap-4"><a href="https://ishanjalan.github.io/ImageOptimser/" class="group relative overflow-hidden rounded-xl bg-white/5 transition-all duration-200 hover:scale-105 hover:bg-white/10"><div class="flex flex-col items-center gap-2 px-3 py-5 sm:gap-3 sm:py-6"><div class="flex h-10 w-10 items-center justify-center rounded-lg bg-white/5 transition-all duration-200 group-hover:scale-110 group-hover:bg-gradient-to-br group-hover:from-emerald-500 group-hover:to-teal-500 sm:h-12 sm:w-12"><!></div> <span class="text-xs font-bold uppercase tracking-wide text-white/40 transition-colors duration-200 group-hover:text-white sm:text-sm">Squish</span></div></a> <div class="relative overflow-hidden rounded-xl bg-gradient-to-br from-orange-500 to-amber-500 p-px"><div class="relative flex flex-col items-center gap-2 rounded-xl bg-black/70 px-3 py-5 sm:gap-3 sm:py-6"><div class="flex h-10 w-10 items-center justify-center rounded-lg bg-gradient-to-br from-orange-500 to-amber-500 sm:h-12 sm:w-12"><!></div> <span class="text-xs font-bold uppercase tracking-wide text-white sm:text-sm">Squash</span> <div class="absolute right-1.5 top-1.5 flex h-1.5 w-1.5 sm:right-2 sm:top-2 sm:h-2 sm:w-2"><span class="absolute inline-flex h-full w-full animate-ping rounded-full bg-green-400 opacity-75"></span> <span class="relative inline-flex h-full w-full rounded-full bg-green-500"></span></div></div></div> <a href="https://ishanjalan.github.io/Smash/" class="group relative overflow-hidden rounded-xl bg-white/5 transition-all duration-200 hover:scale-105 hover:bg-white/10"><div class="flex flex-col items-center gap-2 px-3 py-5 sm:gap-3 sm:py-6"><div class="flex h-10 w-10 items-center justify-center rounded-lg bg-white/5 transition-all duration-200 group-hover:scale-110 group-hover:bg-gradient-to-br group-hover:from-sky-500 group-hover:to-cyan-500 sm:h-12 sm:w-12"><!></div> <span class="text-xs font-bold uppercase tracking-wide text-white/40 transition-colors duration-200 group-hover:text-white sm:text-sm">Smash</span></div></a> <a href="https://ishanjalan.github.io/Swirl/" class="group relative overflow-hidden rounded-xl bg-white/5 transition-all duration-200 hover:scale-105 hover:bg-white/10"><div class="flex flex-col items-center gap-2 px-3 py-5 sm:gap-3 sm:py-6"><div class="flex h-10 w-10 items-center justify-center rounded-lg bg-white/5 transition-all duration-200 group-hover:scale-110 group-hover:bg-gradient-to-br group-hover:from-fuchsia-500 group-hover:to-pink-500 sm:h-12 sm:w-12"><!></div> <span class="text-xs font-bold uppercase tracking-wide text-white/40 transition-colors duration-200 group-hover:text-white sm:text-sm">Swirl</span></div></a></div></div> <div class="my-8 h-px bg-gradient-to-r from-transparent via-white/10 to-transparent"></div> <div class="space-y-6 text-center"><div class="inline-flex items-center gap-2 rounded-full bg-green-500/10 px-4 py-2 ring-1 ring-green-500/20"><!> <span class="text-xs font-medium text-green-400 sm:text-sm">Your videos never leave your device</span></div> <div class="flex flex-wrap items-center justify-center gap-2 sm:gap-3"><a href="https://github.com/ishanjalan/Neutron/tree/main/apps/squash" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1.5 rounded-full bg-white/5 px-4 py-2 text-xs font-medium text-white/70 ring-1 ring-white/10 transition-all duration-200 hover:bg-white/10 hover:text-white sm:text-sm"><!> <span>View Source</span></a> <a href="https://www.linkedin.com/in/ishanjalan93/" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1.5 rounded-full bg-white/5 px-4 py-2 text-xs font-medium text-white/70 ring-1 ring-white/10 transition-all duration-200 hover:bg-sky-500/20 hover:text-sky-400 sm:text-sm"><!> <span>Connect</span></a> <a href="https://buymeacoffee.com/ishanjalan" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1.5 rounded-full bg-gradient-to-r from-amber-500/15 to-orange-500/15 px-4 py-2 text-xs font-medium text-amber-400 ring-1 ring-amber-500/30 transition-all duration-200 sm:text-sm"><!> <span>Buy me a coffee</span></a></div> <div class="flex items-center justify-center gap-1.5 text-xs text-white/40 sm:text-sm"><span>Crafted with</span> <!> <span>by</span> <a href="https://github.com/ishanjalan" target="_blank" rel="noopener noreferrer" class="font-medium text-white/60 transition-colors hover:text-white">Ishan Jalan</a></div></div></div></footer>');function nu(r){var e=su(),t=I(e),i=I(t),a=I(i),n=I(a);po(n,{class:"h-3.5 w-3.5 text-amber-400"});var s=O(n,4);po(s,{class:"h-3.5 w-3.5 text-amber-400"}),P(a);var o=O(a,2),c=I(o),l=I(c),d=I(l),u=I(d);Hd(u,{class:"h-5 w-5 text-white/40 transition-colors duration-200 group-hover:text-white sm:h-6 sm:w-6"}),P(d),Ie(2),P(l),P(c);var f=O(c,2),h=I(f),g=I(h),m=I(g);Li(m,{class:"h-5 w-5 text-white sm:h-6 sm:w-6"}),P(g),Ie(4),P(h),P(f);var p=O(f,2),v=I(p),b=I(v),w=I(b);Ud(w,{class:"h-5 w-5 text-white/40 transition-colors duration-200 group-hover:text-white sm:h-6 sm:w-6"}),P(b),Ie(2),P(v),P(p);var x=O(p,2),T=I(x),A=I(T),B=I(A);Nd(B,{class:"h-5 w-5 text-white/40 transition-colors duration-200 group-hover:text-white sm:h-6 sm:w-6"}),P(A),Ie(2),P(T),P(x),P(o),P(i);var z=O(i,4),M=I(z),W=I(M);yc(W,{class:"h-3.5 w-3.5 text-green-400"}),Ie(2),P(M);var G=O(M,2),C=I(G),N=I(C);wc(N,{class:"h-3.5 w-3.5"}),Ie(2),P(C);var y=O(C,2),q=I(y);qd(q,{class:"h-3.5 w-3.5"}),Ie(2),P(y);var ne=O(y,2),Y=I(ne);Od(Y,{class:"h-3.5 w-3.5"}),Ie(2),P(ne),P(G);var fe=O(G,2),ee=O(I(fe),2);Wd(ee,{class:"h-3.5 w-3.5 fill-red-500 text-red-500"}),Ie(4),P(fe),P(z),P(t),P(e),$(r,e)}const ou={whatsapp:{label:"WhatsApp",sizeMB:16,icon:"ðŸ“±"},email:{label:"Email",sizeMB:25,icon:"ðŸ“§"},discord:{label:"Discord",sizeMB:50,icon:"ðŸ’¬"},telegram:{label:"Telegram",sizeMB:100,icon:"âœˆï¸"}},is={tiny:{crf:35,label:"Tiny",desc:"Max compression",targetBitrate:"500k",preset:"fast"},web:{crf:28,label:"Web",desc:"Balanced",targetBitrate:"1000k",preset:"medium"},social:{crf:23,label:"Social",desc:"Social media",targetBitrate:"2000k",preset:"medium"},high:{crf:18,label:"High",desc:"High quality",targetBitrate:"4000k",preset:"slow"},lossless:{crf:0,label:"Max Quality",desc:"Visually lossless",targetBitrate:"0",preset:"veryslow"}},cu=[{value:"original",label:"Original",pixels:""},{value:"2160p",label:"4K",pixels:"3840Ã—2160"},{value:"1440p",label:"2K",pixels:"2560Ã—1440"},{value:"1080p",label:"Full HD",pixels:"1920Ã—1080"},{value:"720p",label:"HD",pixels:"1280Ã—720"},{value:"480p",label:"SD",pixels:"854Ã—480"},{value:"360p",label:"Low",pixels:"640Ã—360"}],lu=[{value:"64k",label:"64 kbps",desc:"Low"},{value:"128k",label:"128 kbps",desc:"Standard"},{value:"192k",label:"192 kbps",desc:"Good"},{value:"256k",label:"256 kbps",desc:"High"},{value:"320k",label:"320 kbps",desc:"Best"}],Sc="squash-settings-v2";function du(){if(typeof localStorage>"u")return ms();try{const r=localStorage.getItem(Sc);if(r)return{...ms(),...JSON.parse(r)}}catch(r){console.warn("Failed to load settings from localStorage:",r)}return ms()}function uu(r){if(!(typeof localStorage>"u"))try{localStorage.setItem(Sc,JSON.stringify(r))}catch(e){console.warn("Failed to save settings to localStorage:",e)}}function ms(){return{quality:"web",outputFormat:"mp4",resolution:"original",audioBitrate:"128k",audioCodec:"aac",stripMetadata:!1,twoPass:!1,preset:"medium",targetSizeMB:void 0}}function fu(r){const e=r.match(/^(\d+)([kmg])?$/i);if(!e)return 1e6;const t=parseInt(e[1],10);switch(e[2]?.toLowerCase()){case"k":return t*1e3;case"m":return t*1e6;case"g":return t*1e9;default:return t}}function hu(r,e){if(e.targetSizeMB)return e.targetSizeMB*1024*1024;const t=yn(r);if(!t||t<=0)return 0;const i=is[e.quality],a=fu(i.targetBitrate);if(e.quality==="lossless")return r.originalSize*.9;let n=0;e.audioCodec!=="none"&&(n={"64k":64e3,"128k":128e3,"192k":192e3,"256k":256e3,"320k":32e4}[e.audioBitrate]||128e3);const o=(a+n)*t/8;return Math.round(o)}function mu(r,e,t){const i=yn(r);if(!i||i<=0)return 2e6;const a=e*1024*1024;let n=0;t.audioCodec!=="none"&&(n={"64k":64e3,"128k":128e3,"192k":192e3,"256k":256e3,"320k":32e4}[t.audioBitrate]||128e3);const s=n*i/8,o=a-s;if(o<=0)return 1e5;const c=o*8/i;return Math.max(1e5,Math.min(2e7,Math.round(c)))}function yn(r){const e=r.duration||0;if(r.trimStart!==void 0||r.trimEnd!==void 0){const t=r.trimStart||0,i=r.trimEnd??e;return Math.max(0,i-t)}return e}async function pu(r){return new Promise((e,t)=>{const i=document.createElement("video");i.preload="metadata";const a=URL.createObjectURL(r);i.onloadedmetadata=()=>{URL.revokeObjectURL(a);const n=r.size*8/i.duration;e({width:i.videoWidth,height:i.videoHeight,duration:i.duration,bitrate:n})},i.onerror=()=>{URL.revokeObjectURL(a),t(new Error("Failed to load video metadata"))},i.src=a})}function gu(r,e){const{width:t=1920,height:i=1080,duration:a=60}=r,n=t*i;is[e.quality];let s=1;const o=n/(1920*1080);s*=Math.sqrt(o),s*={ultrafast:.3,veryfast:.5,fast:.7,medium:1,slow:1.5,veryslow:2.5}[e.preset]||1,e.outputFormat==="webm"?s*=1.5:e.outputFormat==="av1"&&(s*=.8),e.twoPass&&(s*=1.8);const l=Math.max(2,navigator.hardwareConcurrency-2);return s/=Math.sqrt(l/4),Math.round(a*s)}function vu(){let r=We(Mi([])),e=We(Mi(du()));function t(a,n){const s={"video/mp4":"mp4","video/webm":"webm","video/quicktime":"mov","video/x-msvideo":"avi","video/avi":"avi","video/x-matroska":"mkv"};if(s[a])return s[a];const o=n.toLowerCase().split(".").pop();return{mp4:"mp4",m4v:"mp4",webm:"webm",mov:"mov",avi:"avi",mkv:"mkv"}[o||""]||"mp4"}function i(){return`vid_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}return{get items(){return _(r)},get settings(){return _(e)},async addFiles(a){const n=["video/mp4","video/webm","video/quicktime","video/x-msvideo","video/avi","video/x-matroska"],s=["mp4","m4v","webm","mov","avi","mkv"],o=[];for(const c of a){const l=c.name.toLowerCase().split(".").pop()||"",d=n.includes(c.type),u=s.includes(l);if(!d&&!u)continue;const f=t(c.type,c.name);let h,g,m,p;try{const v=await pu(c);h=v.width,g=v.height,m=v.duration,p=v.bitrate}catch{console.warn("Failed to get metadata for",c.name)}o.push({id:i(),file:c,name:c.name,originalSize:c.size,originalUrl:URL.createObjectURL(c),format:f,outputFormat:_(e).outputFormat,status:"pending",progress:0,width:h,height:g,duration:m,bitrate:p})}return se(r,[..._(r),...o],!0),o},updateItem(a,n){se(r,_(r).map(s=>s.id===a?{...s,...n}:s),!0)},removeItem(a){const n=_(r).find(s=>s.id===a);n&&(URL.revokeObjectURL(n.originalUrl),n.compressedUrl&&URL.revokeObjectURL(n.compressedUrl),n.previewUrl&&URL.revokeObjectURL(n.previewUrl)),se(r,_(r).filter(s=>s.id!==a),!0)},clearAll(){_(r).forEach(a=>{URL.revokeObjectURL(a.originalUrl),a.compressedUrl&&URL.revokeObjectURL(a.compressedUrl),a.previewUrl&&URL.revokeObjectURL(a.previewUrl)}),se(r,[],!0)},updateSettings(a){se(e,{..._(e),...a},!0),uu(_(e)),a.outputFormat!==void 0&&se(r,_(r).map(n=>n.status==="pending"?{...n,outputFormat:a.outputFormat}:n),!0)},getItemById(a){return _(r).find(n=>n.id===a)},reorderItems(a,n){const s=[..._(r)],[o]=s.splice(a,1);s.splice(n,0,o),se(r,s,!0)},getPendingItems(){return _(r).filter(a=>a.status==="pending")},getCompletedItems(){return _(r).filter(a=>a.status==="completed")}}}const le=vu();var bu=te('<span class="text-accent-start font-medium">Release to add more</span>'),wu=te('Drop more videos or <span class="text-accent-start font-medium">click to browse</span>',1),ku=te('<div><div class="bg-surface-800 group-hover:bg-accent-start/10 flex h-10 w-10 items-center justify-center rounded-xl transition-colors"><!></div> <p class="text-surface-500 text-base"><!></p></div>'),yu=te('<p class="text-accent-start text-xl font-semibold">Release to upload</p> <p class="text-accent-start/70 mt-2 text-base">Your videos are ready to be compressed</p>',1),xu=te('<p class="text-surface-300 text-xl font-semibold">Drop videos here</p> <p class="text-surface-500 mt-2 text-base">or <span class="text-accent-start font-medium underline-offset-2 hover:underline">click to browse</span></p>',1),_u=te("<span> </span>"),Tu=te(`<div><div class="absolute inset-0 opacity-[0.05]" style="background-image: url(&quot;data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23f97316' fill-opacity='1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E&quot;);"></div> <div class="relative flex flex-col items-center justify-center px-6 text-center"><div><!></div> <!> <div class="mt-6 flex flex-wrap items-center justify-center gap-2"></div> <p class="text-surface-400 mt-5 text-sm">Max file size: Unlimited â€¢ Batch upload supported</p></div></div>`),Su=te('<div class="relative" role="button" tabindex="0"><input type="file" multiple class="hidden"/> <!></div>');function bo(r,e){Xt(e,!0);let t=We(!1),i;const a=".mp4,.webm,.mov,.avi,.mkv",n=Ge(()=>le.items.length>0),s=[{name:"MP4",color:"from-orange-500 to-red-500"},{name:"WebM",color:"from-green-500 to-emerald-500"},{name:"MOV",color:"from-blue-500 to-indigo-500"},{name:"AVI",color:"from-purple-500 to-pink-500"},{name:"MKV",color:"from-cyan-500 to-teal-500"}];function o(b){b.preventDefault(),se(t,!0)}function c(b){b.preventDefault();const w=b.currentTarget.getBoundingClientRect(),x=b.clientX,T=b.clientY;(x<w.left||x>w.right||T<w.top||T>w.bottom)&&se(t,!1)}function l(b){b.preventDefault()}async function d(b){b.preventDefault(),se(t,!1);const w=b.dataTransfer?.files;w&&w.length>0&&await le.addFiles(w)}async function u(b){const w=b.target,x=w.files;x&&x.length>0&&await le.addFiles(x),w.value=""}function f(){i?.click()}var h=Su();h.__click=f,h.__keydown=b=>b.key==="Enter"&&f();var g=I(h);pt(g,"accept",a),g.__change=u,Vi(g,b=>i=b,()=>i);var m=O(g,2);{var p=b=>{var w=ku(),x=I(w),T=I(x);{var A=C=>{Li(C,{class:"text-accent-start h-5 w-5 animate-pulse"})},B=C=>{qs(C,{class:"text-surface-400 group-hover:text-accent-start h-5 w-5"})};oe(T,C=>{_(t)?C(A):C(B,!1)})}P(x);var z=O(x,2),M=I(z);{var W=C=>{var N=bu();$(C,N)},G=C=>{var N=wu();Ie(),$(C,N)};oe(M,C=>{_(t)?C(W):C(G,!1)})}P(z),P(w),Te(()=>at(w,1,`group flex cursor-pointer items-center justify-center gap-4 rounded-2xl border-2 border-dashed px-6 py-4 transition-all duration-300 sm:py-5 ${_(t)?"border-accent-start bg-accent-start/5":"border-surface-700 hover:border-accent-start/50"}`)),$(b,w)},v=b=>{var w=Tu(),x=O(I(w),2),T=I(x),A=I(T);{var B=N=>{Li(N,{class:"text-accent-start h-8 w-8 animate-pulse"})},z=N=>{qs(N,{class:"text-surface-400 group-hover:text-accent-start h-8 w-8 transition-all group-hover:-translate-y-1"})};oe(A,N=>{_(t)?N(B):N(z,!1)})}P(T);var M=O(T,2);{var W=N=>{var y=yu();Ie(2),$(N,y)},G=N=>{var y=xu();Ie(2),$(N,y)};oe(M,N=>{_(t)?N(W):N(G,!1)})}var C=O(M,2);_t(C,21,()=>s,Ct,(N,y)=>{var q=_u(),ne=I(q,!0);P(q),Te(()=>{at(q,1,`rounded-lg bg-gradient-to-r ${_(y).color??""} px-3 py-1 text-xs font-semibold text-white shadow-sm transition-transform hover:scale-105`),ke(ne,_(y).name)}),$(N,q)}),P(C),Ie(2),P(x),P(w),Te(()=>{at(w,1,`group relative cursor-pointer overflow-hidden rounded-2xl border-2 border-dashed py-12 transition-all duration-300 sm:py-16 ${_(t)?"border-accent-start bg-accent-start/5 scale-[1.01]":"border-surface-700 hover:border-accent-start/50"}`),at(T,1,`mb-5 flex h-16 w-16 items-center justify-center rounded-2xl transition-all duration-300 ${_(t)?"bg-accent-start/20 rotate-3 scale-110":"bg-surface-800 group-hover:bg-accent-start/10 group-hover:scale-105"}`)}),$(b,w)};oe(m,b=>{_(n)?b(p):b(v,!1)})}P(h),St("dragenter",h,o),St("dragleave",h,c),St("dragover",h,l),St("drop",h,d),$(r,h),Zt()}Ht(["click","keydown","change"]);var Fa=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Cu(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}function Ba(r){throw new Error('Could not dynamically require "'+r+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var ps={exports:{}};var wo;function Pu(){return wo||(wo=1,(function(r,e){(function(t){r.exports=t()})(function(){return(function t(i,a,n){function s(l,d){if(!a[l]){if(!i[l]){var u=typeof Ba=="function"&&Ba;if(!d&&u)return u(l,!0);if(o)return o(l,!0);var f=new Error("Cannot find module '"+l+"'");throw f.code="MODULE_NOT_FOUND",f}var h=a[l]={exports:{}};i[l][0].call(h.exports,function(g){var m=i[l][1][g];return s(m||g)},h,h.exports,t,i,a,n)}return a[l].exports}for(var o=typeof Ba=="function"&&Ba,c=0;c<n.length;c++)s(n[c]);return s})({1:[function(t,i,a){var n=t("./utils"),s=t("./support"),o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";a.encode=function(c){for(var l,d,u,f,h,g,m,p=[],v=0,b=c.length,w=b,x=n.getTypeOf(c)!=="string";v<c.length;)w=b-v,u=x?(l=c[v++],d=v<b?c[v++]:0,v<b?c[v++]:0):(l=c.charCodeAt(v++),d=v<b?c.charCodeAt(v++):0,v<b?c.charCodeAt(v++):0),f=l>>2,h=(3&l)<<4|d>>4,g=1<w?(15&d)<<2|u>>6:64,m=2<w?63&u:64,p.push(o.charAt(f)+o.charAt(h)+o.charAt(g)+o.charAt(m));return p.join("")},a.decode=function(c){var l,d,u,f,h,g,m=0,p=0,v="data:";if(c.substr(0,v.length)===v)throw new Error("Invalid base64 input, it looks like a data url.");var b,w=3*(c=c.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(c.charAt(c.length-1)===o.charAt(64)&&w--,c.charAt(c.length-2)===o.charAt(64)&&w--,w%1!=0)throw new Error("Invalid base64 input, bad content length.");for(b=s.uint8array?new Uint8Array(0|w):new Array(0|w);m<c.length;)l=o.indexOf(c.charAt(m++))<<2|(f=o.indexOf(c.charAt(m++)))>>4,d=(15&f)<<4|(h=o.indexOf(c.charAt(m++)))>>2,u=(3&h)<<6|(g=o.indexOf(c.charAt(m++))),b[p++]=l,h!==64&&(b[p++]=d),g!==64&&(b[p++]=u);return b}},{"./support":30,"./utils":32}],2:[function(t,i,a){var n=t("./external"),s=t("./stream/DataWorker"),o=t("./stream/Crc32Probe"),c=t("./stream/DataLengthProbe");function l(d,u,f,h,g){this.compressedSize=d,this.uncompressedSize=u,this.crc32=f,this.compression=h,this.compressedContent=g}l.prototype={getContentWorker:function(){var d=new s(n.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new c("data_length")),u=this;return d.on("end",function(){if(this.streamInfo.data_length!==u.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),d},getCompressedWorker:function(){return new s(n.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},l.createWorkerFrom=function(d,u,f){return d.pipe(new o).pipe(new c("uncompressedSize")).pipe(u.compressWorker(f)).pipe(new c("compressedSize")).withStreamInfo("compression",u)},i.exports=l},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(t,i,a){var n=t("./stream/GenericWorker");a.STORE={magic:"\0\0",compressWorker:function(){return new n("STORE compression")},uncompressWorker:function(){return new n("STORE decompression")}},a.DEFLATE=t("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(t,i,a){var n=t("./utils"),s=(function(){for(var o,c=[],l=0;l<256;l++){o=l;for(var d=0;d<8;d++)o=1&o?3988292384^o>>>1:o>>>1;c[l]=o}return c})();i.exports=function(o,c){return o!==void 0&&o.length?n.getTypeOf(o)!=="string"?(function(l,d,u,f){var h=s,g=f+u;l^=-1;for(var m=f;m<g;m++)l=l>>>8^h[255&(l^d[m])];return-1^l})(0|c,o,o.length,0):(function(l,d,u,f){var h=s,g=f+u;l^=-1;for(var m=f;m<g;m++)l=l>>>8^h[255&(l^d.charCodeAt(m))];return-1^l})(0|c,o,o.length,0):0}},{"./utils":32}],5:[function(t,i,a){a.base64=!1,a.binary=!1,a.dir=!1,a.createFolders=!0,a.date=null,a.compression=null,a.compressionOptions=null,a.comment=null,a.unixPermissions=null,a.dosPermissions=null},{}],6:[function(t,i,a){var n=null;n=typeof Promise<"u"?Promise:t("lie"),i.exports={Promise:n}},{lie:37}],7:[function(t,i,a){var n=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",s=t("pako"),o=t("./utils"),c=t("./stream/GenericWorker"),l=n?"uint8array":"array";function d(u,f){c.call(this,"FlateWorker/"+u),this._pako=null,this._pakoAction=u,this._pakoOptions=f,this.meta={}}a.magic="\b\0",o.inherits(d,c),d.prototype.processChunk=function(u){this.meta=u.meta,this._pako===null&&this._createPako(),this._pako.push(o.transformTo(l,u.data),!1)},d.prototype.flush=function(){c.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},d.prototype.cleanUp=function(){c.prototype.cleanUp.call(this),this._pako=null},d.prototype._createPako=function(){this._pako=new s[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var u=this;this._pako.onData=function(f){u.push({data:f,meta:u.meta})}},a.compressWorker=function(u){return new d("Deflate",u)},a.uncompressWorker=function(){return new d("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(t,i,a){function n(h,g){var m,p="";for(m=0;m<g;m++)p+=String.fromCharCode(255&h),h>>>=8;return p}function s(h,g,m,p,v,b){var w,x,T=h.file,A=h.compression,B=b!==l.utf8encode,z=o.transformTo("string",b(T.name)),M=o.transformTo("string",l.utf8encode(T.name)),W=T.comment,G=o.transformTo("string",b(W)),C=o.transformTo("string",l.utf8encode(W)),N=M.length!==T.name.length,y=C.length!==W.length,q="",ne="",Y="",fe=T.dir,ee=T.date,he={crc32:0,compressedSize:0,uncompressedSize:0};g&&!m||(he.crc32=h.crc32,he.compressedSize=h.compressedSize,he.uncompressedSize=h.uncompressedSize);var K=0;g&&(K|=8),B||!N&&!y||(K|=2048);var L=0,be=0;fe&&(L|=16),v==="UNIX"?(be=798,L|=(function(j,ie){var me=j;return j||(me=ie?16893:33204),(65535&me)<<16})(T.unixPermissions,fe)):(be=20,L|=(function(j){return 63&(j||0)})(T.dosPermissions)),w=ee.getUTCHours(),w<<=6,w|=ee.getUTCMinutes(),w<<=5,w|=ee.getUTCSeconds()/2,x=ee.getUTCFullYear()-1980,x<<=4,x|=ee.getUTCMonth()+1,x<<=5,x|=ee.getUTCDate(),N&&(ne=n(1,1)+n(d(z),4)+M,q+="up"+n(ne.length,2)+ne),y&&(Y=n(1,1)+n(d(G),4)+C,q+="uc"+n(Y.length,2)+Y);var ce="";return ce+=`
\0`,ce+=n(K,2),ce+=A.magic,ce+=n(w,2),ce+=n(x,2),ce+=n(he.crc32,4),ce+=n(he.compressedSize,4),ce+=n(he.uncompressedSize,4),ce+=n(z.length,2),ce+=n(q.length,2),{fileRecord:u.LOCAL_FILE_HEADER+ce+z+q,dirRecord:u.CENTRAL_FILE_HEADER+n(be,2)+ce+n(G.length,2)+"\0\0\0\0"+n(L,4)+n(p,4)+z+q+G}}var o=t("../utils"),c=t("../stream/GenericWorker"),l=t("../utf8"),d=t("../crc32"),u=t("../signature");function f(h,g,m,p){c.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=g,this.zipPlatform=m,this.encodeFileName=p,this.streamFiles=h,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}o.inherits(f,c),f.prototype.push=function(h){var g=h.meta.percent||0,m=this.entriesCount,p=this._sources.length;this.accumulate?this.contentBuffer.push(h):(this.bytesWritten+=h.data.length,c.prototype.push.call(this,{data:h.data,meta:{currentFile:this.currentFile,percent:m?(g+100*(m-p-1))/m:100}}))},f.prototype.openedSource=function(h){this.currentSourceOffset=this.bytesWritten,this.currentFile=h.file.name;var g=this.streamFiles&&!h.file.dir;if(g){var m=s(h,g,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:m.fileRecord,meta:{percent:0}})}else this.accumulate=!0},f.prototype.closedSource=function(h){this.accumulate=!1;var g=this.streamFiles&&!h.file.dir,m=s(h,g,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(m.dirRecord),g)this.push({data:(function(p){return u.DATA_DESCRIPTOR+n(p.crc32,4)+n(p.compressedSize,4)+n(p.uncompressedSize,4)})(h),meta:{percent:100}});else for(this.push({data:m.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},f.prototype.flush=function(){for(var h=this.bytesWritten,g=0;g<this.dirRecords.length;g++)this.push({data:this.dirRecords[g],meta:{percent:100}});var m=this.bytesWritten-h,p=(function(v,b,w,x,T){var A=o.transformTo("string",T(x));return u.CENTRAL_DIRECTORY_END+"\0\0\0\0"+n(v,2)+n(v,2)+n(b,4)+n(w,4)+n(A.length,2)+A})(this.dirRecords.length,m,h,this.zipComment,this.encodeFileName);this.push({data:p,meta:{percent:100}})},f.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},f.prototype.registerPrevious=function(h){this._sources.push(h);var g=this;return h.on("data",function(m){g.processChunk(m)}),h.on("end",function(){g.closedSource(g.previous.streamInfo),g._sources.length?g.prepareNextSource():g.end()}),h.on("error",function(m){g.error(m)}),this},f.prototype.resume=function(){return!!c.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},f.prototype.error=function(h){var g=this._sources;if(!c.prototype.error.call(this,h))return!1;for(var m=0;m<g.length;m++)try{g[m].error(h)}catch{}return!0},f.prototype.lock=function(){c.prototype.lock.call(this);for(var h=this._sources,g=0;g<h.length;g++)h[g].lock()},i.exports=f},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(t,i,a){var n=t("../compressions"),s=t("./ZipFileWorker");a.generateWorker=function(o,c,l){var d=new s(c.streamFiles,l,c.platform,c.encodeFileName),u=0;try{o.forEach(function(f,h){u++;var g=(function(b,w){var x=b||w,T=n[x];if(!T)throw new Error(x+" is not a valid compression method !");return T})(h.options.compression,c.compression),m=h.options.compressionOptions||c.compressionOptions||{},p=h.dir,v=h.date;h._compressWorker(g,m).withStreamInfo("file",{name:f,dir:p,date:v,comment:h.comment||"",unixPermissions:h.unixPermissions,dosPermissions:h.dosPermissions}).pipe(d)}),d.entriesCount=u}catch(f){d.error(f)}return d}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(t,i,a){function n(){if(!(this instanceof n))return new n;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var s=new n;for(var o in this)typeof this[o]!="function"&&(s[o]=this[o]);return s}}(n.prototype=t("./object")).loadAsync=t("./load"),n.support=t("./support"),n.defaults=t("./defaults"),n.version="3.10.1",n.loadAsync=function(s,o){return new n().loadAsync(s,o)},n.external=t("./external"),i.exports=n},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(t,i,a){var n=t("./utils"),s=t("./external"),o=t("./utf8"),c=t("./zipEntries"),l=t("./stream/Crc32Probe"),d=t("./nodejsUtils");function u(f){return new s.Promise(function(h,g){var m=f.decompressed.getContentWorker().pipe(new l);m.on("error",function(p){g(p)}).on("end",function(){m.streamInfo.crc32!==f.decompressed.crc32?g(new Error("Corrupted zip : CRC32 mismatch")):h()}).resume()})}i.exports=function(f,h){var g=this;return h=n.extend(h||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:o.utf8decode}),d.isNode&&d.isStream(f)?s.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):n.prepareContent("the loaded zip file",f,!0,h.optimizedBinaryString,h.base64).then(function(m){var p=new c(h);return p.load(m),p}).then(function(m){var p=[s.Promise.resolve(m)],v=m.files;if(h.checkCRC32)for(var b=0;b<v.length;b++)p.push(u(v[b]));return s.Promise.all(p)}).then(function(m){for(var p=m.shift(),v=p.files,b=0;b<v.length;b++){var w=v[b],x=w.fileNameStr,T=n.resolve(w.fileNameStr);g.file(T,w.decompressed,{binary:!0,optimizedBinaryString:!0,date:w.date,dir:w.dir,comment:w.fileCommentStr.length?w.fileCommentStr:null,unixPermissions:w.unixPermissions,dosPermissions:w.dosPermissions,createFolders:h.createFolders}),w.dir||(g.file(T).unsafeOriginalName=x)}return p.zipComment.length&&(g.comment=p.zipComment),g})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(t,i,a){var n=t("../utils"),s=t("../stream/GenericWorker");function o(c,l){s.call(this,"Nodejs stream input adapter for "+c),this._upstreamEnded=!1,this._bindStream(l)}n.inherits(o,s),o.prototype._bindStream=function(c){var l=this;(this._stream=c).pause(),c.on("data",function(d){l.push({data:d,meta:{percent:0}})}).on("error",function(d){l.isPaused?this.generatedError=d:l.error(d)}).on("end",function(){l.isPaused?l._upstreamEnded=!0:l.end()})},o.prototype.pause=function(){return!!s.prototype.pause.call(this)&&(this._stream.pause(),!0)},o.prototype.resume=function(){return!!s.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},i.exports=o},{"../stream/GenericWorker":28,"../utils":32}],13:[function(t,i,a){var n=t("readable-stream").Readable;function s(o,c,l){n.call(this,c),this._helper=o;var d=this;o.on("data",function(u,f){d.push(u)||d._helper.pause(),l&&l(f)}).on("error",function(u){d.emit("error",u)}).on("end",function(){d.push(null)})}t("../utils").inherits(s,n),s.prototype._read=function(){this._helper.resume()},i.exports=s},{"../utils":32,"readable-stream":16}],14:[function(t,i,a){i.exports={isNode:typeof Buffer<"u",newBufferFrom:function(n,s){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(n,s);if(typeof n=="number")throw new Error('The "data" argument must not be a number');return new Buffer(n,s)},allocBuffer:function(n){if(Buffer.alloc)return Buffer.alloc(n);var s=new Buffer(n);return s.fill(0),s},isBuffer:function(n){return Buffer.isBuffer(n)},isStream:function(n){return n&&typeof n.on=="function"&&typeof n.pause=="function"&&typeof n.resume=="function"}}},{}],15:[function(t,i,a){function n(T,A,B){var z,M=o.getTypeOf(A),W=o.extend(B||{},d);W.date=W.date||new Date,W.compression!==null&&(W.compression=W.compression.toUpperCase()),typeof W.unixPermissions=="string"&&(W.unixPermissions=parseInt(W.unixPermissions,8)),W.unixPermissions&&16384&W.unixPermissions&&(W.dir=!0),W.dosPermissions&&16&W.dosPermissions&&(W.dir=!0),W.dir&&(T=v(T)),W.createFolders&&(z=p(T))&&b.call(this,z,!0);var G=M==="string"&&W.binary===!1&&W.base64===!1;B&&B.binary!==void 0||(W.binary=!G),(A instanceof u&&A.uncompressedSize===0||W.dir||!A||A.length===0)&&(W.base64=!1,W.binary=!0,A="",W.compression="STORE",M="string");var C=null;C=A instanceof u||A instanceof c?A:g.isNode&&g.isStream(A)?new m(T,A):o.prepareContent(T,A,W.binary,W.optimizedBinaryString,W.base64);var N=new f(T,C,W);this.files[T]=N}var s=t("./utf8"),o=t("./utils"),c=t("./stream/GenericWorker"),l=t("./stream/StreamHelper"),d=t("./defaults"),u=t("./compressedObject"),f=t("./zipObject"),h=t("./generate"),g=t("./nodejsUtils"),m=t("./nodejs/NodejsStreamInputAdapter"),p=function(T){T.slice(-1)==="/"&&(T=T.substring(0,T.length-1));var A=T.lastIndexOf("/");return 0<A?T.substring(0,A):""},v=function(T){return T.slice(-1)!=="/"&&(T+="/"),T},b=function(T,A){return A=A!==void 0?A:d.createFolders,T=v(T),this.files[T]||n.call(this,T,null,{dir:!0,createFolders:A}),this.files[T]};function w(T){return Object.prototype.toString.call(T)==="[object RegExp]"}var x={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(T){var A,B,z;for(A in this.files)z=this.files[A],(B=A.slice(this.root.length,A.length))&&A.slice(0,this.root.length)===this.root&&T(B,z)},filter:function(T){var A=[];return this.forEach(function(B,z){T(B,z)&&A.push(z)}),A},file:function(T,A,B){if(arguments.length!==1)return T=this.root+T,n.call(this,T,A,B),this;if(w(T)){var z=T;return this.filter(function(W,G){return!G.dir&&z.test(W)})}var M=this.files[this.root+T];return M&&!M.dir?M:null},folder:function(T){if(!T)return this;if(w(T))return this.filter(function(M,W){return W.dir&&T.test(M)});var A=this.root+T,B=b.call(this,A),z=this.clone();return z.root=B.name,z},remove:function(T){T=this.root+T;var A=this.files[T];if(A||(T.slice(-1)!=="/"&&(T+="/"),A=this.files[T]),A&&!A.dir)delete this.files[T];else for(var B=this.filter(function(M,W){return W.name.slice(0,T.length)===T}),z=0;z<B.length;z++)delete this.files[B[z].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(T){var A,B={};try{if((B=o.extend(T||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:s.utf8encode})).type=B.type.toLowerCase(),B.compression=B.compression.toUpperCase(),B.type==="binarystring"&&(B.type="string"),!B.type)throw new Error("No output type specified.");o.checkSupport(B.type),B.platform!=="darwin"&&B.platform!=="freebsd"&&B.platform!=="linux"&&B.platform!=="sunos"||(B.platform="UNIX"),B.platform==="win32"&&(B.platform="DOS");var z=B.comment||this.comment||"";A=h.generateWorker(this,B,z)}catch(M){(A=new c("error")).error(M)}return new l(A,B.type||"string",B.mimeType)},generateAsync:function(T,A){return this.generateInternalStream(T).accumulate(A)},generateNodeStream:function(T,A){return(T=T||{}).type||(T.type="nodebuffer"),this.generateInternalStream(T).toNodejsStream(A)}};i.exports=x},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(t,i,a){i.exports=t("stream")},{stream:void 0}],17:[function(t,i,a){var n=t("./DataReader");function s(o){n.call(this,o);for(var c=0;c<this.data.length;c++)o[c]=255&o[c]}t("../utils").inherits(s,n),s.prototype.byteAt=function(o){return this.data[this.zero+o]},s.prototype.lastIndexOfSignature=function(o){for(var c=o.charCodeAt(0),l=o.charCodeAt(1),d=o.charCodeAt(2),u=o.charCodeAt(3),f=this.length-4;0<=f;--f)if(this.data[f]===c&&this.data[f+1]===l&&this.data[f+2]===d&&this.data[f+3]===u)return f-this.zero;return-1},s.prototype.readAndCheckSignature=function(o){var c=o.charCodeAt(0),l=o.charCodeAt(1),d=o.charCodeAt(2),u=o.charCodeAt(3),f=this.readData(4);return c===f[0]&&l===f[1]&&d===f[2]&&u===f[3]},s.prototype.readData=function(o){if(this.checkOffset(o),o===0)return[];var c=this.data.slice(this.zero+this.index,this.zero+this.index+o);return this.index+=o,c},i.exports=s},{"../utils":32,"./DataReader":18}],18:[function(t,i,a){var n=t("../utils");function s(o){this.data=o,this.length=o.length,this.index=0,this.zero=0}s.prototype={checkOffset:function(o){this.checkIndex(this.index+o)},checkIndex:function(o){if(this.length<this.zero+o||o<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+o+"). Corrupted zip ?")},setIndex:function(o){this.checkIndex(o),this.index=o},skip:function(o){this.setIndex(this.index+o)},byteAt:function(){},readInt:function(o){var c,l=0;for(this.checkOffset(o),c=this.index+o-1;c>=this.index;c--)l=(l<<8)+this.byteAt(c);return this.index+=o,l},readString:function(o){return n.transformTo("string",this.readData(o))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var o=this.readInt(4);return new Date(Date.UTC(1980+(o>>25&127),(o>>21&15)-1,o>>16&31,o>>11&31,o>>5&63,(31&o)<<1))}},i.exports=s},{"../utils":32}],19:[function(t,i,a){var n=t("./Uint8ArrayReader");function s(o){n.call(this,o)}t("../utils").inherits(s,n),s.prototype.readData=function(o){this.checkOffset(o);var c=this.data.slice(this.zero+this.index,this.zero+this.index+o);return this.index+=o,c},i.exports=s},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(t,i,a){var n=t("./DataReader");function s(o){n.call(this,o)}t("../utils").inherits(s,n),s.prototype.byteAt=function(o){return this.data.charCodeAt(this.zero+o)},s.prototype.lastIndexOfSignature=function(o){return this.data.lastIndexOf(o)-this.zero},s.prototype.readAndCheckSignature=function(o){return o===this.readData(4)},s.prototype.readData=function(o){this.checkOffset(o);var c=this.data.slice(this.zero+this.index,this.zero+this.index+o);return this.index+=o,c},i.exports=s},{"../utils":32,"./DataReader":18}],21:[function(t,i,a){var n=t("./ArrayReader");function s(o){n.call(this,o)}t("../utils").inherits(s,n),s.prototype.readData=function(o){if(this.checkOffset(o),o===0)return new Uint8Array(0);var c=this.data.subarray(this.zero+this.index,this.zero+this.index+o);return this.index+=o,c},i.exports=s},{"../utils":32,"./ArrayReader":17}],22:[function(t,i,a){var n=t("../utils"),s=t("../support"),o=t("./ArrayReader"),c=t("./StringReader"),l=t("./NodeBufferReader"),d=t("./Uint8ArrayReader");i.exports=function(u){var f=n.getTypeOf(u);return n.checkSupport(f),f!=="string"||s.uint8array?f==="nodebuffer"?new l(u):s.uint8array?new d(n.transformTo("uint8array",u)):new o(n.transformTo("array",u)):new c(u)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(t,i,a){a.LOCAL_FILE_HEADER="PK",a.CENTRAL_FILE_HEADER="PK",a.CENTRAL_DIRECTORY_END="PK",a.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",a.ZIP64_CENTRAL_DIRECTORY_END="PK",a.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(t,i,a){var n=t("./GenericWorker"),s=t("../utils");function o(c){n.call(this,"ConvertWorker to "+c),this.destType=c}s.inherits(o,n),o.prototype.processChunk=function(c){this.push({data:s.transformTo(this.destType,c.data),meta:c.meta})},i.exports=o},{"../utils":32,"./GenericWorker":28}],25:[function(t,i,a){var n=t("./GenericWorker"),s=t("../crc32");function o(){n.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}t("../utils").inherits(o,n),o.prototype.processChunk=function(c){this.streamInfo.crc32=s(c.data,this.streamInfo.crc32||0),this.push(c)},i.exports=o},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(t,i,a){var n=t("../utils"),s=t("./GenericWorker");function o(c){s.call(this,"DataLengthProbe for "+c),this.propName=c,this.withStreamInfo(c,0)}n.inherits(o,s),o.prototype.processChunk=function(c){if(c){var l=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=l+c.data.length}s.prototype.processChunk.call(this,c)},i.exports=o},{"../utils":32,"./GenericWorker":28}],27:[function(t,i,a){var n=t("../utils"),s=t("./GenericWorker");function o(c){s.call(this,"DataWorker");var l=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,c.then(function(d){l.dataIsReady=!0,l.data=d,l.max=d&&d.length||0,l.type=n.getTypeOf(d),l.isPaused||l._tickAndRepeat()},function(d){l.error(d)})}n.inherits(o,s),o.prototype.cleanUp=function(){s.prototype.cleanUp.call(this),this.data=null},o.prototype.resume=function(){return!!s.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,n.delay(this._tickAndRepeat,[],this)),!0)},o.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(n.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},o.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var c=null,l=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":c=this.data.substring(this.index,l);break;case"uint8array":c=this.data.subarray(this.index,l);break;case"array":case"nodebuffer":c=this.data.slice(this.index,l)}return this.index=l,this.push({data:c,meta:{percent:this.max?this.index/this.max*100:0}})},i.exports=o},{"../utils":32,"./GenericWorker":28}],28:[function(t,i,a){function n(s){this.name=s||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}n.prototype={push:function(s){this.emit("data",s)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(s){this.emit("error",s)}return!0},error:function(s){return!this.isFinished&&(this.isPaused?this.generatedError=s:(this.isFinished=!0,this.emit("error",s),this.previous&&this.previous.error(s),this.cleanUp()),!0)},on:function(s,o){return this._listeners[s].push(o),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(s,o){if(this._listeners[s])for(var c=0;c<this._listeners[s].length;c++)this._listeners[s][c].call(this,o)},pipe:function(s){return s.registerPrevious(this)},registerPrevious:function(s){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=s.streamInfo,this.mergeStreamInfo(),this.previous=s;var o=this;return s.on("data",function(c){o.processChunk(c)}),s.on("end",function(){o.end()}),s.on("error",function(c){o.error(c)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var s=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),s=!0),this.previous&&this.previous.resume(),!s},flush:function(){},processChunk:function(s){this.push(s)},withStreamInfo:function(s,o){return this.extraStreamInfo[s]=o,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var s in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,s)&&(this.streamInfo[s]=this.extraStreamInfo[s])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var s="Worker "+this.name;return this.previous?this.previous+" -> "+s:s}},i.exports=n},{}],29:[function(t,i,a){var n=t("../utils"),s=t("./ConvertWorker"),o=t("./GenericWorker"),c=t("../base64"),l=t("../support"),d=t("../external"),u=null;if(l.nodestream)try{u=t("../nodejs/NodejsStreamOutputAdapter")}catch{}function f(g,m){return new d.Promise(function(p,v){var b=[],w=g._internalType,x=g._outputType,T=g._mimeType;g.on("data",function(A,B){b.push(A),m&&m(B)}).on("error",function(A){b=[],v(A)}).on("end",function(){try{var A=(function(B,z,M){switch(B){case"blob":return n.newBlob(n.transformTo("arraybuffer",z),M);case"base64":return c.encode(z);default:return n.transformTo(B,z)}})(x,(function(B,z){var M,W=0,G=null,C=0;for(M=0;M<z.length;M++)C+=z[M].length;switch(B){case"string":return z.join("");case"array":return Array.prototype.concat.apply([],z);case"uint8array":for(G=new Uint8Array(C),M=0;M<z.length;M++)G.set(z[M],W),W+=z[M].length;return G;case"nodebuffer":return Buffer.concat(z);default:throw new Error("concat : unsupported type '"+B+"'")}})(w,b),T);p(A)}catch(B){v(B)}b=[]}).resume()})}function h(g,m,p){var v=m;switch(m){case"blob":case"arraybuffer":v="uint8array";break;case"base64":v="string"}try{this._internalType=v,this._outputType=m,this._mimeType=p,n.checkSupport(v),this._worker=g.pipe(new s(v)),g.lock()}catch(b){this._worker=new o("error"),this._worker.error(b)}}h.prototype={accumulate:function(g){return f(this,g)},on:function(g,m){var p=this;return g==="data"?this._worker.on(g,function(v){m.call(p,v.data,v.meta)}):this._worker.on(g,function(){n.delay(m,arguments,p)}),this},resume:function(){return n.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(g){if(n.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new u(this,{objectMode:this._outputType!=="nodebuffer"},g)}},i.exports=h},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(t,i,a){if(a.base64=!0,a.array=!0,a.string=!0,a.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",a.nodebuffer=typeof Buffer<"u",a.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")a.blob=!1;else{var n=new ArrayBuffer(0);try{a.blob=new Blob([n],{type:"application/zip"}).size===0}catch{try{var s=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);s.append(n),a.blob=s.getBlob("application/zip").size===0}catch{a.blob=!1}}}try{a.nodestream=!!t("readable-stream").Readable}catch{a.nodestream=!1}},{"readable-stream":16}],31:[function(t,i,a){for(var n=t("./utils"),s=t("./support"),o=t("./nodejsUtils"),c=t("./stream/GenericWorker"),l=new Array(256),d=0;d<256;d++)l[d]=252<=d?6:248<=d?5:240<=d?4:224<=d?3:192<=d?2:1;l[254]=l[254]=1;function u(){c.call(this,"utf-8 decode"),this.leftOver=null}function f(){c.call(this,"utf-8 encode")}a.utf8encode=function(h){return s.nodebuffer?o.newBufferFrom(h,"utf-8"):(function(g){var m,p,v,b,w,x=g.length,T=0;for(b=0;b<x;b++)(64512&(p=g.charCodeAt(b)))==55296&&b+1<x&&(64512&(v=g.charCodeAt(b+1)))==56320&&(p=65536+(p-55296<<10)+(v-56320),b++),T+=p<128?1:p<2048?2:p<65536?3:4;for(m=s.uint8array?new Uint8Array(T):new Array(T),b=w=0;w<T;b++)(64512&(p=g.charCodeAt(b)))==55296&&b+1<x&&(64512&(v=g.charCodeAt(b+1)))==56320&&(p=65536+(p-55296<<10)+(v-56320),b++),p<128?m[w++]=p:(p<2048?m[w++]=192|p>>>6:(p<65536?m[w++]=224|p>>>12:(m[w++]=240|p>>>18,m[w++]=128|p>>>12&63),m[w++]=128|p>>>6&63),m[w++]=128|63&p);return m})(h)},a.utf8decode=function(h){return s.nodebuffer?n.transformTo("nodebuffer",h).toString("utf-8"):(function(g){var m,p,v,b,w=g.length,x=new Array(2*w);for(m=p=0;m<w;)if((v=g[m++])<128)x[p++]=v;else if(4<(b=l[v]))x[p++]=65533,m+=b-1;else{for(v&=b===2?31:b===3?15:7;1<b&&m<w;)v=v<<6|63&g[m++],b--;1<b?x[p++]=65533:v<65536?x[p++]=v:(v-=65536,x[p++]=55296|v>>10&1023,x[p++]=56320|1023&v)}return x.length!==p&&(x.subarray?x=x.subarray(0,p):x.length=p),n.applyFromCharCode(x)})(h=n.transformTo(s.uint8array?"uint8array":"array",h))},n.inherits(u,c),u.prototype.processChunk=function(h){var g=n.transformTo(s.uint8array?"uint8array":"array",h.data);if(this.leftOver&&this.leftOver.length){if(s.uint8array){var m=g;(g=new Uint8Array(m.length+this.leftOver.length)).set(this.leftOver,0),g.set(m,this.leftOver.length)}else g=this.leftOver.concat(g);this.leftOver=null}var p=(function(b,w){var x;for((w=w||b.length)>b.length&&(w=b.length),x=w-1;0<=x&&(192&b[x])==128;)x--;return x<0||x===0?w:x+l[b[x]]>w?x:w})(g),v=g;p!==g.length&&(s.uint8array?(v=g.subarray(0,p),this.leftOver=g.subarray(p,g.length)):(v=g.slice(0,p),this.leftOver=g.slice(p,g.length))),this.push({data:a.utf8decode(v),meta:h.meta})},u.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:a.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},a.Utf8DecodeWorker=u,n.inherits(f,c),f.prototype.processChunk=function(h){this.push({data:a.utf8encode(h.data),meta:h.meta})},a.Utf8EncodeWorker=f},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(t,i,a){var n=t("./support"),s=t("./base64"),o=t("./nodejsUtils"),c=t("./external");function l(m){return m}function d(m,p){for(var v=0;v<m.length;++v)p[v]=255&m.charCodeAt(v);return p}t("setimmediate"),a.newBlob=function(m,p){a.checkSupport("blob");try{return new Blob([m],{type:p})}catch{try{var v=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return v.append(m),v.getBlob(p)}catch{throw new Error("Bug : can't construct the Blob.")}}};var u={stringifyByChunk:function(m,p,v){var b=[],w=0,x=m.length;if(x<=v)return String.fromCharCode.apply(null,m);for(;w<x;)p==="array"||p==="nodebuffer"?b.push(String.fromCharCode.apply(null,m.slice(w,Math.min(w+v,x)))):b.push(String.fromCharCode.apply(null,m.subarray(w,Math.min(w+v,x)))),w+=v;return b.join("")},stringifyByChar:function(m){for(var p="",v=0;v<m.length;v++)p+=String.fromCharCode(m[v]);return p},applyCanBeUsed:{uint8array:(function(){try{return n.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}})(),nodebuffer:(function(){try{return n.nodebuffer&&String.fromCharCode.apply(null,o.allocBuffer(1)).length===1}catch{return!1}})()}};function f(m){var p=65536,v=a.getTypeOf(m),b=!0;if(v==="uint8array"?b=u.applyCanBeUsed.uint8array:v==="nodebuffer"&&(b=u.applyCanBeUsed.nodebuffer),b)for(;1<p;)try{return u.stringifyByChunk(m,v,p)}catch{p=Math.floor(p/2)}return u.stringifyByChar(m)}function h(m,p){for(var v=0;v<m.length;v++)p[v]=m[v];return p}a.applyFromCharCode=f;var g={};g.string={string:l,array:function(m){return d(m,new Array(m.length))},arraybuffer:function(m){return g.string.uint8array(m).buffer},uint8array:function(m){return d(m,new Uint8Array(m.length))},nodebuffer:function(m){return d(m,o.allocBuffer(m.length))}},g.array={string:f,array:l,arraybuffer:function(m){return new Uint8Array(m).buffer},uint8array:function(m){return new Uint8Array(m)},nodebuffer:function(m){return o.newBufferFrom(m)}},g.arraybuffer={string:function(m){return f(new Uint8Array(m))},array:function(m){return h(new Uint8Array(m),new Array(m.byteLength))},arraybuffer:l,uint8array:function(m){return new Uint8Array(m)},nodebuffer:function(m){return o.newBufferFrom(new Uint8Array(m))}},g.uint8array={string:f,array:function(m){return h(m,new Array(m.length))},arraybuffer:function(m){return m.buffer},uint8array:l,nodebuffer:function(m){return o.newBufferFrom(m)}},g.nodebuffer={string:f,array:function(m){return h(m,new Array(m.length))},arraybuffer:function(m){return g.nodebuffer.uint8array(m).buffer},uint8array:function(m){return h(m,new Uint8Array(m.length))},nodebuffer:l},a.transformTo=function(m,p){if(p=p||"",!m)return p;a.checkSupport(m);var v=a.getTypeOf(p);return g[v][m](p)},a.resolve=function(m){for(var p=m.split("/"),v=[],b=0;b<p.length;b++){var w=p[b];w==="."||w===""&&b!==0&&b!==p.length-1||(w===".."?v.pop():v.push(w))}return v.join("/")},a.getTypeOf=function(m){return typeof m=="string"?"string":Object.prototype.toString.call(m)==="[object Array]"?"array":n.nodebuffer&&o.isBuffer(m)?"nodebuffer":n.uint8array&&m instanceof Uint8Array?"uint8array":n.arraybuffer&&m instanceof ArrayBuffer?"arraybuffer":void 0},a.checkSupport=function(m){if(!n[m.toLowerCase()])throw new Error(m+" is not supported by this platform")},a.MAX_VALUE_16BITS=65535,a.MAX_VALUE_32BITS=-1,a.pretty=function(m){var p,v,b="";for(v=0;v<(m||"").length;v++)b+="\\x"+((p=m.charCodeAt(v))<16?"0":"")+p.toString(16).toUpperCase();return b},a.delay=function(m,p,v){setImmediate(function(){m.apply(v||null,p||[])})},a.inherits=function(m,p){function v(){}v.prototype=p.prototype,m.prototype=new v},a.extend=function(){var m,p,v={};for(m=0;m<arguments.length;m++)for(p in arguments[m])Object.prototype.hasOwnProperty.call(arguments[m],p)&&v[p]===void 0&&(v[p]=arguments[m][p]);return v},a.prepareContent=function(m,p,v,b,w){return c.Promise.resolve(p).then(function(x){return n.blob&&(x instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(x))!==-1)&&typeof FileReader<"u"?new c.Promise(function(T,A){var B=new FileReader;B.onload=function(z){T(z.target.result)},B.onerror=function(z){A(z.target.error)},B.readAsArrayBuffer(x)}):x}).then(function(x){var T=a.getTypeOf(x);return T?(T==="arraybuffer"?x=a.transformTo("uint8array",x):T==="string"&&(w?x=s.decode(x):v&&b!==!0&&(x=(function(A){return d(A,n.uint8array?new Uint8Array(A.length):new Array(A.length))})(x))),x):c.Promise.reject(new Error("Can't read the data of '"+m+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(t,i,a){var n=t("./reader/readerFor"),s=t("./utils"),o=t("./signature"),c=t("./zipEntry"),l=t("./support");function d(u){this.files=[],this.loadOptions=u}d.prototype={checkSignature:function(u){if(!this.reader.readAndCheckSignature(u)){this.reader.index-=4;var f=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+s.pretty(f)+", expected "+s.pretty(u)+")")}},isSignature:function(u,f){var h=this.reader.index;this.reader.setIndex(u);var g=this.reader.readString(4)===f;return this.reader.setIndex(h),g},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var u=this.reader.readData(this.zipCommentLength),f=l.uint8array?"uint8array":"array",h=s.transformTo(f,u);this.zipComment=this.loadOptions.decodeFileName(h)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var u,f,h,g=this.zip64EndOfCentralSize-44;0<g;)u=this.reader.readInt(2),f=this.reader.readInt(4),h=this.reader.readData(f),this.zip64ExtensibleData[u]={id:u,length:f,value:h}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var u,f;for(u=0;u<this.files.length;u++)f=this.files[u],this.reader.setIndex(f.localHeaderOffset),this.checkSignature(o.LOCAL_FILE_HEADER),f.readLocalPart(this.reader),f.handleUTF8(),f.processAttributes()},readCentralDir:function(){var u;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(o.CENTRAL_FILE_HEADER);)(u=new c({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(u);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var u=this.reader.lastIndexOfSignature(o.CENTRAL_DIRECTORY_END);if(u<0)throw this.isSignature(0,o.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(u);var f=u;if(this.checkSignature(o.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===s.MAX_VALUE_16BITS||this.diskWithCentralDirStart===s.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===s.MAX_VALUE_16BITS||this.centralDirRecords===s.MAX_VALUE_16BITS||this.centralDirSize===s.MAX_VALUE_32BITS||this.centralDirOffset===s.MAX_VALUE_32BITS){if(this.zip64=!0,(u=this.reader.lastIndexOfSignature(o.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(u),this.checkSignature(o.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,o.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(o.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(o.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var h=this.centralDirOffset+this.centralDirSize;this.zip64&&(h+=20,h+=12+this.zip64EndOfCentralSize);var g=f-h;if(0<g)this.isSignature(f,o.CENTRAL_FILE_HEADER)||(this.reader.zero=g);else if(g<0)throw new Error("Corrupted zip: missing "+Math.abs(g)+" bytes.")},prepareReader:function(u){this.reader=n(u)},load:function(u){this.prepareReader(u),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},i.exports=d},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(t,i,a){var n=t("./reader/readerFor"),s=t("./utils"),o=t("./compressedObject"),c=t("./crc32"),l=t("./utf8"),d=t("./compressions"),u=t("./support");function f(h,g){this.options=h,this.loadOptions=g}f.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(h){var g,m;if(h.skip(22),this.fileNameLength=h.readInt(2),m=h.readInt(2),this.fileName=h.readData(this.fileNameLength),h.skip(m),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((g=(function(p){for(var v in d)if(Object.prototype.hasOwnProperty.call(d,v)&&d[v].magic===p)return d[v];return null})(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+s.pretty(this.compressionMethod)+" unknown (inner file : "+s.transformTo("string",this.fileName)+")");this.decompressed=new o(this.compressedSize,this.uncompressedSize,this.crc32,g,h.readData(this.compressedSize))},readCentralPart:function(h){this.versionMadeBy=h.readInt(2),h.skip(2),this.bitFlag=h.readInt(2),this.compressionMethod=h.readString(2),this.date=h.readDate(),this.crc32=h.readInt(4),this.compressedSize=h.readInt(4),this.uncompressedSize=h.readInt(4);var g=h.readInt(2);if(this.extraFieldsLength=h.readInt(2),this.fileCommentLength=h.readInt(2),this.diskNumberStart=h.readInt(2),this.internalFileAttributes=h.readInt(2),this.externalFileAttributes=h.readInt(4),this.localHeaderOffset=h.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");h.skip(g),this.readExtraFields(h),this.parseZIP64ExtraField(h),this.fileComment=h.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var h=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),h==0&&(this.dosPermissions=63&this.externalFileAttributes),h==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var h=n(this.extraFields[1].value);this.uncompressedSize===s.MAX_VALUE_32BITS&&(this.uncompressedSize=h.readInt(8)),this.compressedSize===s.MAX_VALUE_32BITS&&(this.compressedSize=h.readInt(8)),this.localHeaderOffset===s.MAX_VALUE_32BITS&&(this.localHeaderOffset=h.readInt(8)),this.diskNumberStart===s.MAX_VALUE_32BITS&&(this.diskNumberStart=h.readInt(4))}},readExtraFields:function(h){var g,m,p,v=h.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});h.index+4<v;)g=h.readInt(2),m=h.readInt(2),p=h.readData(m),this.extraFields[g]={id:g,length:m,value:p};h.setIndex(v)},handleUTF8:function(){var h=u.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=l.utf8decode(this.fileName),this.fileCommentStr=l.utf8decode(this.fileComment);else{var g=this.findExtraFieldUnicodePath();if(g!==null)this.fileNameStr=g;else{var m=s.transformTo(h,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(m)}var p=this.findExtraFieldUnicodeComment();if(p!==null)this.fileCommentStr=p;else{var v=s.transformTo(h,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(v)}}},findExtraFieldUnicodePath:function(){var h=this.extraFields[28789];if(h){var g=n(h.value);return g.readInt(1)!==1||c(this.fileName)!==g.readInt(4)?null:l.utf8decode(g.readData(h.length-5))}return null},findExtraFieldUnicodeComment:function(){var h=this.extraFields[25461];if(h){var g=n(h.value);return g.readInt(1)!==1||c(this.fileComment)!==g.readInt(4)?null:l.utf8decode(g.readData(h.length-5))}return null}},i.exports=f},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(t,i,a){function n(g,m,p){this.name=g,this.dir=p.dir,this.date=p.date,this.comment=p.comment,this.unixPermissions=p.unixPermissions,this.dosPermissions=p.dosPermissions,this._data=m,this._dataBinary=p.binary,this.options={compression:p.compression,compressionOptions:p.compressionOptions}}var s=t("./stream/StreamHelper"),o=t("./stream/DataWorker"),c=t("./utf8"),l=t("./compressedObject"),d=t("./stream/GenericWorker");n.prototype={internalStream:function(g){var m=null,p="string";try{if(!g)throw new Error("No output type specified.");var v=(p=g.toLowerCase())==="string"||p==="text";p!=="binarystring"&&p!=="text"||(p="string"),m=this._decompressWorker();var b=!this._dataBinary;b&&!v&&(m=m.pipe(new c.Utf8EncodeWorker)),!b&&v&&(m=m.pipe(new c.Utf8DecodeWorker))}catch(w){(m=new d("error")).error(w)}return new s(m,p,"")},async:function(g,m){return this.internalStream(g).accumulate(m)},nodeStream:function(g,m){return this.internalStream(g||"nodebuffer").toNodejsStream(m)},_compressWorker:function(g,m){if(this._data instanceof l&&this._data.compression.magic===g.magic)return this._data.getCompressedWorker();var p=this._decompressWorker();return this._dataBinary||(p=p.pipe(new c.Utf8EncodeWorker)),l.createWorkerFrom(p,g,m)},_decompressWorker:function(){return this._data instanceof l?this._data.getContentWorker():this._data instanceof d?this._data:new o(this._data)}};for(var u=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],f=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},h=0;h<u.length;h++)n.prototype[u[h]]=f;i.exports=n},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(t,i,a){(function(n){var s,o,c=n.MutationObserver||n.WebKitMutationObserver;if(c){var l=0,d=new c(g),u=n.document.createTextNode("");d.observe(u,{characterData:!0}),s=function(){u.data=l=++l%2}}else if(n.setImmediate||n.MessageChannel===void 0)s="document"in n&&"onreadystatechange"in n.document.createElement("script")?function(){var m=n.document.createElement("script");m.onreadystatechange=function(){g(),m.onreadystatechange=null,m.parentNode.removeChild(m),m=null},n.document.documentElement.appendChild(m)}:function(){setTimeout(g,0)};else{var f=new n.MessageChannel;f.port1.onmessage=g,s=function(){f.port2.postMessage(0)}}var h=[];function g(){var m,p;o=!0;for(var v=h.length;v;){for(p=h,h=[],m=-1;++m<v;)p[m]();v=h.length}o=!1}i.exports=function(m){h.push(m)!==1||o||s()}}).call(this,typeof Fa<"u"?Fa:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(t,i,a){var n=t("immediate");function s(){}var o={},c=["REJECTED"],l=["FULFILLED"],d=["PENDING"];function u(v){if(typeof v!="function")throw new TypeError("resolver must be a function");this.state=d,this.queue=[],this.outcome=void 0,v!==s&&m(this,v)}function f(v,b,w){this.promise=v,typeof b=="function"&&(this.onFulfilled=b,this.callFulfilled=this.otherCallFulfilled),typeof w=="function"&&(this.onRejected=w,this.callRejected=this.otherCallRejected)}function h(v,b,w){n(function(){var x;try{x=b(w)}catch(T){return o.reject(v,T)}x===v?o.reject(v,new TypeError("Cannot resolve promise with itself")):o.resolve(v,x)})}function g(v){var b=v&&v.then;if(v&&(typeof v=="object"||typeof v=="function")&&typeof b=="function")return function(){b.apply(v,arguments)}}function m(v,b){var w=!1;function x(B){w||(w=!0,o.reject(v,B))}function T(B){w||(w=!0,o.resolve(v,B))}var A=p(function(){b(T,x)});A.status==="error"&&x(A.value)}function p(v,b){var w={};try{w.value=v(b),w.status="success"}catch(x){w.status="error",w.value=x}return w}(i.exports=u).prototype.finally=function(v){if(typeof v!="function")return this;var b=this.constructor;return this.then(function(w){return b.resolve(v()).then(function(){return w})},function(w){return b.resolve(v()).then(function(){throw w})})},u.prototype.catch=function(v){return this.then(null,v)},u.prototype.then=function(v,b){if(typeof v!="function"&&this.state===l||typeof b!="function"&&this.state===c)return this;var w=new this.constructor(s);return this.state!==d?h(w,this.state===l?v:b,this.outcome):this.queue.push(new f(w,v,b)),w},f.prototype.callFulfilled=function(v){o.resolve(this.promise,v)},f.prototype.otherCallFulfilled=function(v){h(this.promise,this.onFulfilled,v)},f.prototype.callRejected=function(v){o.reject(this.promise,v)},f.prototype.otherCallRejected=function(v){h(this.promise,this.onRejected,v)},o.resolve=function(v,b){var w=p(g,b);if(w.status==="error")return o.reject(v,w.value);var x=w.value;if(x)m(v,x);else{v.state=l,v.outcome=b;for(var T=-1,A=v.queue.length;++T<A;)v.queue[T].callFulfilled(b)}return v},o.reject=function(v,b){v.state=c,v.outcome=b;for(var w=-1,x=v.queue.length;++w<x;)v.queue[w].callRejected(b);return v},u.resolve=function(v){return v instanceof this?v:o.resolve(new this(s),v)},u.reject=function(v){var b=new this(s);return o.reject(b,v)},u.all=function(v){var b=this;if(Object.prototype.toString.call(v)!=="[object Array]")return this.reject(new TypeError("must be an array"));var w=v.length,x=!1;if(!w)return this.resolve([]);for(var T=new Array(w),A=0,B=-1,z=new this(s);++B<w;)M(v[B],B);return z;function M(W,G){b.resolve(W).then(function(C){T[G]=C,++A!==w||x||(x=!0,o.resolve(z,T))},function(C){x||(x=!0,o.reject(z,C))})}},u.race=function(v){var b=this;if(Object.prototype.toString.call(v)!=="[object Array]")return this.reject(new TypeError("must be an array"));var w=v.length,x=!1;if(!w)return this.resolve([]);for(var T=-1,A=new this(s);++T<w;)B=v[T],b.resolve(B).then(function(z){x||(x=!0,o.resolve(A,z))},function(z){x||(x=!0,o.reject(A,z))});var B;return A}},{immediate:36}],38:[function(t,i,a){var n={};(0,t("./lib/utils/common").assign)(n,t("./lib/deflate"),t("./lib/inflate"),t("./lib/zlib/constants")),i.exports=n},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(t,i,a){var n=t("./zlib/deflate"),s=t("./utils/common"),o=t("./utils/strings"),c=t("./zlib/messages"),l=t("./zlib/zstream"),d=Object.prototype.toString,u=0,f=-1,h=0,g=8;function m(v){if(!(this instanceof m))return new m(v);this.options=s.assign({level:f,method:g,chunkSize:16384,windowBits:15,memLevel:8,strategy:h,to:""},v||{});var b=this.options;b.raw&&0<b.windowBits?b.windowBits=-b.windowBits:b.gzip&&0<b.windowBits&&b.windowBits<16&&(b.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new l,this.strm.avail_out=0;var w=n.deflateInit2(this.strm,b.level,b.method,b.windowBits,b.memLevel,b.strategy);if(w!==u)throw new Error(c[w]);if(b.header&&n.deflateSetHeader(this.strm,b.header),b.dictionary){var x;if(x=typeof b.dictionary=="string"?o.string2buf(b.dictionary):d.call(b.dictionary)==="[object ArrayBuffer]"?new Uint8Array(b.dictionary):b.dictionary,(w=n.deflateSetDictionary(this.strm,x))!==u)throw new Error(c[w]);this._dict_set=!0}}function p(v,b){var w=new m(b);if(w.push(v,!0),w.err)throw w.msg||c[w.err];return w.result}m.prototype.push=function(v,b){var w,x,T=this.strm,A=this.options.chunkSize;if(this.ended)return!1;x=b===~~b?b:b===!0?4:0,typeof v=="string"?T.input=o.string2buf(v):d.call(v)==="[object ArrayBuffer]"?T.input=new Uint8Array(v):T.input=v,T.next_in=0,T.avail_in=T.input.length;do{if(T.avail_out===0&&(T.output=new s.Buf8(A),T.next_out=0,T.avail_out=A),(w=n.deflate(T,x))!==1&&w!==u)return this.onEnd(w),!(this.ended=!0);T.avail_out!==0&&(T.avail_in!==0||x!==4&&x!==2)||(this.options.to==="string"?this.onData(o.buf2binstring(s.shrinkBuf(T.output,T.next_out))):this.onData(s.shrinkBuf(T.output,T.next_out)))}while((0<T.avail_in||T.avail_out===0)&&w!==1);return x===4?(w=n.deflateEnd(this.strm),this.onEnd(w),this.ended=!0,w===u):x!==2||(this.onEnd(u),!(T.avail_out=0))},m.prototype.onData=function(v){this.chunks.push(v)},m.prototype.onEnd=function(v){v===u&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=s.flattenChunks(this.chunks)),this.chunks=[],this.err=v,this.msg=this.strm.msg},a.Deflate=m,a.deflate=p,a.deflateRaw=function(v,b){return(b=b||{}).raw=!0,p(v,b)},a.gzip=function(v,b){return(b=b||{}).gzip=!0,p(v,b)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(t,i,a){var n=t("./zlib/inflate"),s=t("./utils/common"),o=t("./utils/strings"),c=t("./zlib/constants"),l=t("./zlib/messages"),d=t("./zlib/zstream"),u=t("./zlib/gzheader"),f=Object.prototype.toString;function h(m){if(!(this instanceof h))return new h(m);this.options=s.assign({chunkSize:16384,windowBits:0,to:""},m||{});var p=this.options;p.raw&&0<=p.windowBits&&p.windowBits<16&&(p.windowBits=-p.windowBits,p.windowBits===0&&(p.windowBits=-15)),!(0<=p.windowBits&&p.windowBits<16)||m&&m.windowBits||(p.windowBits+=32),15<p.windowBits&&p.windowBits<48&&(15&p.windowBits)==0&&(p.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new d,this.strm.avail_out=0;var v=n.inflateInit2(this.strm,p.windowBits);if(v!==c.Z_OK)throw new Error(l[v]);this.header=new u,n.inflateGetHeader(this.strm,this.header)}function g(m,p){var v=new h(p);if(v.push(m,!0),v.err)throw v.msg||l[v.err];return v.result}h.prototype.push=function(m,p){var v,b,w,x,T,A,B=this.strm,z=this.options.chunkSize,M=this.options.dictionary,W=!1;if(this.ended)return!1;b=p===~~p?p:p===!0?c.Z_FINISH:c.Z_NO_FLUSH,typeof m=="string"?B.input=o.binstring2buf(m):f.call(m)==="[object ArrayBuffer]"?B.input=new Uint8Array(m):B.input=m,B.next_in=0,B.avail_in=B.input.length;do{if(B.avail_out===0&&(B.output=new s.Buf8(z),B.next_out=0,B.avail_out=z),(v=n.inflate(B,c.Z_NO_FLUSH))===c.Z_NEED_DICT&&M&&(A=typeof M=="string"?o.string2buf(M):f.call(M)==="[object ArrayBuffer]"?new Uint8Array(M):M,v=n.inflateSetDictionary(this.strm,A)),v===c.Z_BUF_ERROR&&W===!0&&(v=c.Z_OK,W=!1),v!==c.Z_STREAM_END&&v!==c.Z_OK)return this.onEnd(v),!(this.ended=!0);B.next_out&&(B.avail_out!==0&&v!==c.Z_STREAM_END&&(B.avail_in!==0||b!==c.Z_FINISH&&b!==c.Z_SYNC_FLUSH)||(this.options.to==="string"?(w=o.utf8border(B.output,B.next_out),x=B.next_out-w,T=o.buf2string(B.output,w),B.next_out=x,B.avail_out=z-x,x&&s.arraySet(B.output,B.output,w,x,0),this.onData(T)):this.onData(s.shrinkBuf(B.output,B.next_out)))),B.avail_in===0&&B.avail_out===0&&(W=!0)}while((0<B.avail_in||B.avail_out===0)&&v!==c.Z_STREAM_END);return v===c.Z_STREAM_END&&(b=c.Z_FINISH),b===c.Z_FINISH?(v=n.inflateEnd(this.strm),this.onEnd(v),this.ended=!0,v===c.Z_OK):b!==c.Z_SYNC_FLUSH||(this.onEnd(c.Z_OK),!(B.avail_out=0))},h.prototype.onData=function(m){this.chunks.push(m)},h.prototype.onEnd=function(m){m===c.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=s.flattenChunks(this.chunks)),this.chunks=[],this.err=m,this.msg=this.strm.msg},a.Inflate=h,a.inflate=g,a.inflateRaw=function(m,p){return(p=p||{}).raw=!0,g(m,p)},a.ungzip=g},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(t,i,a){var n=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";a.assign=function(c){for(var l=Array.prototype.slice.call(arguments,1);l.length;){var d=l.shift();if(d){if(typeof d!="object")throw new TypeError(d+"must be non-object");for(var u in d)d.hasOwnProperty(u)&&(c[u]=d[u])}}return c},a.shrinkBuf=function(c,l){return c.length===l?c:c.subarray?c.subarray(0,l):(c.length=l,c)};var s={arraySet:function(c,l,d,u,f){if(l.subarray&&c.subarray)c.set(l.subarray(d,d+u),f);else for(var h=0;h<u;h++)c[f+h]=l[d+h]},flattenChunks:function(c){var l,d,u,f,h,g;for(l=u=0,d=c.length;l<d;l++)u+=c[l].length;for(g=new Uint8Array(u),l=f=0,d=c.length;l<d;l++)h=c[l],g.set(h,f),f+=h.length;return g}},o={arraySet:function(c,l,d,u,f){for(var h=0;h<u;h++)c[f+h]=l[d+h]},flattenChunks:function(c){return[].concat.apply([],c)}};a.setTyped=function(c){c?(a.Buf8=Uint8Array,a.Buf16=Uint16Array,a.Buf32=Int32Array,a.assign(a,s)):(a.Buf8=Array,a.Buf16=Array,a.Buf32=Array,a.assign(a,o))},a.setTyped(n)},{}],42:[function(t,i,a){var n=t("./common"),s=!0,o=!0;try{String.fromCharCode.apply(null,[0])}catch{s=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{o=!1}for(var c=new n.Buf8(256),l=0;l<256;l++)c[l]=252<=l?6:248<=l?5:240<=l?4:224<=l?3:192<=l?2:1;function d(u,f){if(f<65537&&(u.subarray&&o||!u.subarray&&s))return String.fromCharCode.apply(null,n.shrinkBuf(u,f));for(var h="",g=0;g<f;g++)h+=String.fromCharCode(u[g]);return h}c[254]=c[254]=1,a.string2buf=function(u){var f,h,g,m,p,v=u.length,b=0;for(m=0;m<v;m++)(64512&(h=u.charCodeAt(m)))==55296&&m+1<v&&(64512&(g=u.charCodeAt(m+1)))==56320&&(h=65536+(h-55296<<10)+(g-56320),m++),b+=h<128?1:h<2048?2:h<65536?3:4;for(f=new n.Buf8(b),m=p=0;p<b;m++)(64512&(h=u.charCodeAt(m)))==55296&&m+1<v&&(64512&(g=u.charCodeAt(m+1)))==56320&&(h=65536+(h-55296<<10)+(g-56320),m++),h<128?f[p++]=h:(h<2048?f[p++]=192|h>>>6:(h<65536?f[p++]=224|h>>>12:(f[p++]=240|h>>>18,f[p++]=128|h>>>12&63),f[p++]=128|h>>>6&63),f[p++]=128|63&h);return f},a.buf2binstring=function(u){return d(u,u.length)},a.binstring2buf=function(u){for(var f=new n.Buf8(u.length),h=0,g=f.length;h<g;h++)f[h]=u.charCodeAt(h);return f},a.buf2string=function(u,f){var h,g,m,p,v=f||u.length,b=new Array(2*v);for(h=g=0;h<v;)if((m=u[h++])<128)b[g++]=m;else if(4<(p=c[m]))b[g++]=65533,h+=p-1;else{for(m&=p===2?31:p===3?15:7;1<p&&h<v;)m=m<<6|63&u[h++],p--;1<p?b[g++]=65533:m<65536?b[g++]=m:(m-=65536,b[g++]=55296|m>>10&1023,b[g++]=56320|1023&m)}return d(b,g)},a.utf8border=function(u,f){var h;for((f=f||u.length)>u.length&&(f=u.length),h=f-1;0<=h&&(192&u[h])==128;)h--;return h<0||h===0?f:h+c[u[h]]>f?h:f}},{"./common":41}],43:[function(t,i,a){i.exports=function(n,s,o,c){for(var l=65535&n|0,d=n>>>16&65535|0,u=0;o!==0;){for(o-=u=2e3<o?2e3:o;d=d+(l=l+s[c++]|0)|0,--u;);l%=65521,d%=65521}return l|d<<16|0}},{}],44:[function(t,i,a){i.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(t,i,a){var n=(function(){for(var s,o=[],c=0;c<256;c++){s=c;for(var l=0;l<8;l++)s=1&s?3988292384^s>>>1:s>>>1;o[c]=s}return o})();i.exports=function(s,o,c,l){var d=n,u=l+c;s^=-1;for(var f=l;f<u;f++)s=s>>>8^d[255&(s^o[f])];return-1^s}},{}],46:[function(t,i,a){var n,s=t("../utils/common"),o=t("./trees"),c=t("./adler32"),l=t("./crc32"),d=t("./messages"),u=0,f=4,h=0,g=-2,m=-1,p=4,v=2,b=8,w=9,x=286,T=30,A=19,B=2*x+1,z=15,M=3,W=258,G=W+M+1,C=42,N=113,y=1,q=2,ne=3,Y=4;function fe(k,J){return k.msg=d[J],J}function ee(k){return(k<<1)-(4<k?9:0)}function he(k){for(var J=k.length;0<=--J;)k[J]=0}function K(k){var J=k.state,X=J.pending;X>k.avail_out&&(X=k.avail_out),X!==0&&(s.arraySet(k.output,J.pending_buf,J.pending_out,X,k.next_out),k.next_out+=X,J.pending_out+=X,k.total_out+=X,k.avail_out-=X,J.pending-=X,J.pending===0&&(J.pending_out=0))}function L(k,J){o._tr_flush_block(k,0<=k.block_start?k.block_start:-1,k.strstart-k.block_start,J),k.block_start=k.strstart,K(k.strm)}function be(k,J){k.pending_buf[k.pending++]=J}function ce(k,J){k.pending_buf[k.pending++]=J>>>8&255,k.pending_buf[k.pending++]=255&J}function j(k,J){var X,F,S=k.max_chain_length,R=k.strstart,V=k.prev_length,H=k.nice_match,U=k.strstart>k.w_size-G?k.strstart-(k.w_size-G):0,Z=k.window,re=k.w_mask,Q=k.prev,ae=k.strstart+W,we=Z[R+V-1],ye=Z[R+V];k.prev_length>=k.good_match&&(S>>=2),H>k.lookahead&&(H=k.lookahead);do if(Z[(X=J)+V]===ye&&Z[X+V-1]===we&&Z[X]===Z[R]&&Z[++X]===Z[R+1]){R+=2,X++;do;while(Z[++R]===Z[++X]&&Z[++R]===Z[++X]&&Z[++R]===Z[++X]&&Z[++R]===Z[++X]&&Z[++R]===Z[++X]&&Z[++R]===Z[++X]&&Z[++R]===Z[++X]&&Z[++R]===Z[++X]&&R<ae);if(F=W-(ae-R),R=ae-W,V<F){if(k.match_start=J,H<=(V=F))break;we=Z[R+V-1],ye=Z[R+V]}}while((J=Q[J&re])>U&&--S!=0);return V<=k.lookahead?V:k.lookahead}function ie(k){var J,X,F,S,R,V,H,U,Z,re,Q=k.w_size;do{if(S=k.window_size-k.lookahead-k.strstart,k.strstart>=Q+(Q-G)){for(s.arraySet(k.window,k.window,Q,Q,0),k.match_start-=Q,k.strstart-=Q,k.block_start-=Q,J=X=k.hash_size;F=k.head[--J],k.head[J]=Q<=F?F-Q:0,--X;);for(J=X=Q;F=k.prev[--J],k.prev[J]=Q<=F?F-Q:0,--X;);S+=Q}if(k.strm.avail_in===0)break;if(V=k.strm,H=k.window,U=k.strstart+k.lookahead,Z=S,re=void 0,re=V.avail_in,Z<re&&(re=Z),X=re===0?0:(V.avail_in-=re,s.arraySet(H,V.input,V.next_in,re,U),V.state.wrap===1?V.adler=c(V.adler,H,re,U):V.state.wrap===2&&(V.adler=l(V.adler,H,re,U)),V.next_in+=re,V.total_in+=re,re),k.lookahead+=X,k.lookahead+k.insert>=M)for(R=k.strstart-k.insert,k.ins_h=k.window[R],k.ins_h=(k.ins_h<<k.hash_shift^k.window[R+1])&k.hash_mask;k.insert&&(k.ins_h=(k.ins_h<<k.hash_shift^k.window[R+M-1])&k.hash_mask,k.prev[R&k.w_mask]=k.head[k.ins_h],k.head[k.ins_h]=R,R++,k.insert--,!(k.lookahead+k.insert<M)););}while(k.lookahead<G&&k.strm.avail_in!==0)}function me(k,J){for(var X,F;;){if(k.lookahead<G){if(ie(k),k.lookahead<G&&J===u)return y;if(k.lookahead===0)break}if(X=0,k.lookahead>=M&&(k.ins_h=(k.ins_h<<k.hash_shift^k.window[k.strstart+M-1])&k.hash_mask,X=k.prev[k.strstart&k.w_mask]=k.head[k.ins_h],k.head[k.ins_h]=k.strstart),X!==0&&k.strstart-X<=k.w_size-G&&(k.match_length=j(k,X)),k.match_length>=M)if(F=o._tr_tally(k,k.strstart-k.match_start,k.match_length-M),k.lookahead-=k.match_length,k.match_length<=k.max_lazy_match&&k.lookahead>=M){for(k.match_length--;k.strstart++,k.ins_h=(k.ins_h<<k.hash_shift^k.window[k.strstart+M-1])&k.hash_mask,X=k.prev[k.strstart&k.w_mask]=k.head[k.ins_h],k.head[k.ins_h]=k.strstart,--k.match_length!=0;);k.strstart++}else k.strstart+=k.match_length,k.match_length=0,k.ins_h=k.window[k.strstart],k.ins_h=(k.ins_h<<k.hash_shift^k.window[k.strstart+1])&k.hash_mask;else F=o._tr_tally(k,0,k.window[k.strstart]),k.lookahead--,k.strstart++;if(F&&(L(k,!1),k.strm.avail_out===0))return y}return k.insert=k.strstart<M-1?k.strstart:M-1,J===f?(L(k,!0),k.strm.avail_out===0?ne:Y):k.last_lit&&(L(k,!1),k.strm.avail_out===0)?y:q}function ge(k,J){for(var X,F,S;;){if(k.lookahead<G){if(ie(k),k.lookahead<G&&J===u)return y;if(k.lookahead===0)break}if(X=0,k.lookahead>=M&&(k.ins_h=(k.ins_h<<k.hash_shift^k.window[k.strstart+M-1])&k.hash_mask,X=k.prev[k.strstart&k.w_mask]=k.head[k.ins_h],k.head[k.ins_h]=k.strstart),k.prev_length=k.match_length,k.prev_match=k.match_start,k.match_length=M-1,X!==0&&k.prev_length<k.max_lazy_match&&k.strstart-X<=k.w_size-G&&(k.match_length=j(k,X),k.match_length<=5&&(k.strategy===1||k.match_length===M&&4096<k.strstart-k.match_start)&&(k.match_length=M-1)),k.prev_length>=M&&k.match_length<=k.prev_length){for(S=k.strstart+k.lookahead-M,F=o._tr_tally(k,k.strstart-1-k.prev_match,k.prev_length-M),k.lookahead-=k.prev_length-1,k.prev_length-=2;++k.strstart<=S&&(k.ins_h=(k.ins_h<<k.hash_shift^k.window[k.strstart+M-1])&k.hash_mask,X=k.prev[k.strstart&k.w_mask]=k.head[k.ins_h],k.head[k.ins_h]=k.strstart),--k.prev_length!=0;);if(k.match_available=0,k.match_length=M-1,k.strstart++,F&&(L(k,!1),k.strm.avail_out===0))return y}else if(k.match_available){if((F=o._tr_tally(k,0,k.window[k.strstart-1]))&&L(k,!1),k.strstart++,k.lookahead--,k.strm.avail_out===0)return y}else k.match_available=1,k.strstart++,k.lookahead--}return k.match_available&&(F=o._tr_tally(k,0,k.window[k.strstart-1]),k.match_available=0),k.insert=k.strstart<M-1?k.strstart:M-1,J===f?(L(k,!0),k.strm.avail_out===0?ne:Y):k.last_lit&&(L(k,!1),k.strm.avail_out===0)?y:q}function xe(k,J,X,F,S){this.good_length=k,this.max_lazy=J,this.nice_length=X,this.max_chain=F,this.func=S}function Re(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=b,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new s.Buf16(2*B),this.dyn_dtree=new s.Buf16(2*(2*T+1)),this.bl_tree=new s.Buf16(2*(2*A+1)),he(this.dyn_ltree),he(this.dyn_dtree),he(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new s.Buf16(z+1),this.heap=new s.Buf16(2*x+1),he(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new s.Buf16(2*x+1),he(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function Be(k){var J;return k&&k.state?(k.total_in=k.total_out=0,k.data_type=v,(J=k.state).pending=0,J.pending_out=0,J.wrap<0&&(J.wrap=-J.wrap),J.status=J.wrap?C:N,k.adler=J.wrap===2?0:1,J.last_flush=u,o._tr_init(J),h):fe(k,g)}function st(k){var J=Be(k);return J===h&&(function(X){X.window_size=2*X.w_size,he(X.head),X.max_lazy_match=n[X.level].max_lazy,X.good_match=n[X.level].good_length,X.nice_match=n[X.level].nice_length,X.max_chain_length=n[X.level].max_chain,X.strstart=0,X.block_start=0,X.lookahead=0,X.insert=0,X.match_length=X.prev_length=M-1,X.match_available=0,X.ins_h=0})(k.state),J}function ct(k,J,X,F,S,R){if(!k)return g;var V=1;if(J===m&&(J=6),F<0?(V=0,F=-F):15<F&&(V=2,F-=16),S<1||w<S||X!==b||F<8||15<F||J<0||9<J||R<0||p<R)return fe(k,g);F===8&&(F=9);var H=new Re;return(k.state=H).strm=k,H.wrap=V,H.gzhead=null,H.w_bits=F,H.w_size=1<<H.w_bits,H.w_mask=H.w_size-1,H.hash_bits=S+7,H.hash_size=1<<H.hash_bits,H.hash_mask=H.hash_size-1,H.hash_shift=~~((H.hash_bits+M-1)/M),H.window=new s.Buf8(2*H.w_size),H.head=new s.Buf16(H.hash_size),H.prev=new s.Buf16(H.w_size),H.lit_bufsize=1<<S+6,H.pending_buf_size=4*H.lit_bufsize,H.pending_buf=new s.Buf8(H.pending_buf_size),H.d_buf=1*H.lit_bufsize,H.l_buf=3*H.lit_bufsize,H.level=J,H.strategy=R,H.method=X,st(k)}n=[new xe(0,0,0,0,function(k,J){var X=65535;for(X>k.pending_buf_size-5&&(X=k.pending_buf_size-5);;){if(k.lookahead<=1){if(ie(k),k.lookahead===0&&J===u)return y;if(k.lookahead===0)break}k.strstart+=k.lookahead,k.lookahead=0;var F=k.block_start+X;if((k.strstart===0||k.strstart>=F)&&(k.lookahead=k.strstart-F,k.strstart=F,L(k,!1),k.strm.avail_out===0)||k.strstart-k.block_start>=k.w_size-G&&(L(k,!1),k.strm.avail_out===0))return y}return k.insert=0,J===f?(L(k,!0),k.strm.avail_out===0?ne:Y):(k.strstart>k.block_start&&(L(k,!1),k.strm.avail_out),y)}),new xe(4,4,8,4,me),new xe(4,5,16,8,me),new xe(4,6,32,32,me),new xe(4,4,16,16,ge),new xe(8,16,32,32,ge),new xe(8,16,128,128,ge),new xe(8,32,128,256,ge),new xe(32,128,258,1024,ge),new xe(32,258,258,4096,ge)],a.deflateInit=function(k,J){return ct(k,J,b,15,8,0)},a.deflateInit2=ct,a.deflateReset=st,a.deflateResetKeep=Be,a.deflateSetHeader=function(k,J){return k&&k.state?k.state.wrap!==2?g:(k.state.gzhead=J,h):g},a.deflate=function(k,J){var X,F,S,R;if(!k||!k.state||5<J||J<0)return k?fe(k,g):g;if(F=k.state,!k.output||!k.input&&k.avail_in!==0||F.status===666&&J!==f)return fe(k,k.avail_out===0?-5:g);if(F.strm=k,X=F.last_flush,F.last_flush=J,F.status===C)if(F.wrap===2)k.adler=0,be(F,31),be(F,139),be(F,8),F.gzhead?(be(F,(F.gzhead.text?1:0)+(F.gzhead.hcrc?2:0)+(F.gzhead.extra?4:0)+(F.gzhead.name?8:0)+(F.gzhead.comment?16:0)),be(F,255&F.gzhead.time),be(F,F.gzhead.time>>8&255),be(F,F.gzhead.time>>16&255),be(F,F.gzhead.time>>24&255),be(F,F.level===9?2:2<=F.strategy||F.level<2?4:0),be(F,255&F.gzhead.os),F.gzhead.extra&&F.gzhead.extra.length&&(be(F,255&F.gzhead.extra.length),be(F,F.gzhead.extra.length>>8&255)),F.gzhead.hcrc&&(k.adler=l(k.adler,F.pending_buf,F.pending,0)),F.gzindex=0,F.status=69):(be(F,0),be(F,0),be(F,0),be(F,0),be(F,0),be(F,F.level===9?2:2<=F.strategy||F.level<2?4:0),be(F,3),F.status=N);else{var V=b+(F.w_bits-8<<4)<<8;V|=(2<=F.strategy||F.level<2?0:F.level<6?1:F.level===6?2:3)<<6,F.strstart!==0&&(V|=32),V+=31-V%31,F.status=N,ce(F,V),F.strstart!==0&&(ce(F,k.adler>>>16),ce(F,65535&k.adler)),k.adler=1}if(F.status===69)if(F.gzhead.extra){for(S=F.pending;F.gzindex<(65535&F.gzhead.extra.length)&&(F.pending!==F.pending_buf_size||(F.gzhead.hcrc&&F.pending>S&&(k.adler=l(k.adler,F.pending_buf,F.pending-S,S)),K(k),S=F.pending,F.pending!==F.pending_buf_size));)be(F,255&F.gzhead.extra[F.gzindex]),F.gzindex++;F.gzhead.hcrc&&F.pending>S&&(k.adler=l(k.adler,F.pending_buf,F.pending-S,S)),F.gzindex===F.gzhead.extra.length&&(F.gzindex=0,F.status=73)}else F.status=73;if(F.status===73)if(F.gzhead.name){S=F.pending;do{if(F.pending===F.pending_buf_size&&(F.gzhead.hcrc&&F.pending>S&&(k.adler=l(k.adler,F.pending_buf,F.pending-S,S)),K(k),S=F.pending,F.pending===F.pending_buf_size)){R=1;break}R=F.gzindex<F.gzhead.name.length?255&F.gzhead.name.charCodeAt(F.gzindex++):0,be(F,R)}while(R!==0);F.gzhead.hcrc&&F.pending>S&&(k.adler=l(k.adler,F.pending_buf,F.pending-S,S)),R===0&&(F.gzindex=0,F.status=91)}else F.status=91;if(F.status===91)if(F.gzhead.comment){S=F.pending;do{if(F.pending===F.pending_buf_size&&(F.gzhead.hcrc&&F.pending>S&&(k.adler=l(k.adler,F.pending_buf,F.pending-S,S)),K(k),S=F.pending,F.pending===F.pending_buf_size)){R=1;break}R=F.gzindex<F.gzhead.comment.length?255&F.gzhead.comment.charCodeAt(F.gzindex++):0,be(F,R)}while(R!==0);F.gzhead.hcrc&&F.pending>S&&(k.adler=l(k.adler,F.pending_buf,F.pending-S,S)),R===0&&(F.status=103)}else F.status=103;if(F.status===103&&(F.gzhead.hcrc?(F.pending+2>F.pending_buf_size&&K(k),F.pending+2<=F.pending_buf_size&&(be(F,255&k.adler),be(F,k.adler>>8&255),k.adler=0,F.status=N)):F.status=N),F.pending!==0){if(K(k),k.avail_out===0)return F.last_flush=-1,h}else if(k.avail_in===0&&ee(J)<=ee(X)&&J!==f)return fe(k,-5);if(F.status===666&&k.avail_in!==0)return fe(k,-5);if(k.avail_in!==0||F.lookahead!==0||J!==u&&F.status!==666){var H=F.strategy===2?(function(U,Z){for(var re;;){if(U.lookahead===0&&(ie(U),U.lookahead===0)){if(Z===u)return y;break}if(U.match_length=0,re=o._tr_tally(U,0,U.window[U.strstart]),U.lookahead--,U.strstart++,re&&(L(U,!1),U.strm.avail_out===0))return y}return U.insert=0,Z===f?(L(U,!0),U.strm.avail_out===0?ne:Y):U.last_lit&&(L(U,!1),U.strm.avail_out===0)?y:q})(F,J):F.strategy===3?(function(U,Z){for(var re,Q,ae,we,ye=U.window;;){if(U.lookahead<=W){if(ie(U),U.lookahead<=W&&Z===u)return y;if(U.lookahead===0)break}if(U.match_length=0,U.lookahead>=M&&0<U.strstart&&(Q=ye[ae=U.strstart-1])===ye[++ae]&&Q===ye[++ae]&&Q===ye[++ae]){we=U.strstart+W;do;while(Q===ye[++ae]&&Q===ye[++ae]&&Q===ye[++ae]&&Q===ye[++ae]&&Q===ye[++ae]&&Q===ye[++ae]&&Q===ye[++ae]&&Q===ye[++ae]&&ae<we);U.match_length=W-(we-ae),U.match_length>U.lookahead&&(U.match_length=U.lookahead)}if(U.match_length>=M?(re=o._tr_tally(U,1,U.match_length-M),U.lookahead-=U.match_length,U.strstart+=U.match_length,U.match_length=0):(re=o._tr_tally(U,0,U.window[U.strstart]),U.lookahead--,U.strstart++),re&&(L(U,!1),U.strm.avail_out===0))return y}return U.insert=0,Z===f?(L(U,!0),U.strm.avail_out===0?ne:Y):U.last_lit&&(L(U,!1),U.strm.avail_out===0)?y:q})(F,J):n[F.level].func(F,J);if(H!==ne&&H!==Y||(F.status=666),H===y||H===ne)return k.avail_out===0&&(F.last_flush=-1),h;if(H===q&&(J===1?o._tr_align(F):J!==5&&(o._tr_stored_block(F,0,0,!1),J===3&&(he(F.head),F.lookahead===0&&(F.strstart=0,F.block_start=0,F.insert=0))),K(k),k.avail_out===0))return F.last_flush=-1,h}return J!==f?h:F.wrap<=0?1:(F.wrap===2?(be(F,255&k.adler),be(F,k.adler>>8&255),be(F,k.adler>>16&255),be(F,k.adler>>24&255),be(F,255&k.total_in),be(F,k.total_in>>8&255),be(F,k.total_in>>16&255),be(F,k.total_in>>24&255)):(ce(F,k.adler>>>16),ce(F,65535&k.adler)),K(k),0<F.wrap&&(F.wrap=-F.wrap),F.pending!==0?h:1)},a.deflateEnd=function(k){var J;return k&&k.state?(J=k.state.status)!==C&&J!==69&&J!==73&&J!==91&&J!==103&&J!==N&&J!==666?fe(k,g):(k.state=null,J===N?fe(k,-3):h):g},a.deflateSetDictionary=function(k,J){var X,F,S,R,V,H,U,Z,re=J.length;if(!k||!k.state||(R=(X=k.state).wrap)===2||R===1&&X.status!==C||X.lookahead)return g;for(R===1&&(k.adler=c(k.adler,J,re,0)),X.wrap=0,re>=X.w_size&&(R===0&&(he(X.head),X.strstart=0,X.block_start=0,X.insert=0),Z=new s.Buf8(X.w_size),s.arraySet(Z,J,re-X.w_size,X.w_size,0),J=Z,re=X.w_size),V=k.avail_in,H=k.next_in,U=k.input,k.avail_in=re,k.next_in=0,k.input=J,ie(X);X.lookahead>=M;){for(F=X.strstart,S=X.lookahead-(M-1);X.ins_h=(X.ins_h<<X.hash_shift^X.window[F+M-1])&X.hash_mask,X.prev[F&X.w_mask]=X.head[X.ins_h],X.head[X.ins_h]=F,F++,--S;);X.strstart=F,X.lookahead=M-1,ie(X)}return X.strstart+=X.lookahead,X.block_start=X.strstart,X.insert=X.lookahead,X.lookahead=0,X.match_length=X.prev_length=M-1,X.match_available=0,k.next_in=H,k.input=U,k.avail_in=V,X.wrap=R,h},a.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(t,i,a){i.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(t,i,a){i.exports=function(n,s){var o,c,l,d,u,f,h,g,m,p,v,b,w,x,T,A,B,z,M,W,G,C,N,y,q;o=n.state,c=n.next_in,y=n.input,l=c+(n.avail_in-5),d=n.next_out,q=n.output,u=d-(s-n.avail_out),f=d+(n.avail_out-257),h=o.dmax,g=o.wsize,m=o.whave,p=o.wnext,v=o.window,b=o.hold,w=o.bits,x=o.lencode,T=o.distcode,A=(1<<o.lenbits)-1,B=(1<<o.distbits)-1;e:do{w<15&&(b+=y[c++]<<w,w+=8,b+=y[c++]<<w,w+=8),z=x[b&A];t:for(;;){if(b>>>=M=z>>>24,w-=M,(M=z>>>16&255)===0)q[d++]=65535&z;else{if(!(16&M)){if((64&M)==0){z=x[(65535&z)+(b&(1<<M)-1)];continue t}if(32&M){o.mode=12;break e}n.msg="invalid literal/length code",o.mode=30;break e}W=65535&z,(M&=15)&&(w<M&&(b+=y[c++]<<w,w+=8),W+=b&(1<<M)-1,b>>>=M,w-=M),w<15&&(b+=y[c++]<<w,w+=8,b+=y[c++]<<w,w+=8),z=T[b&B];r:for(;;){if(b>>>=M=z>>>24,w-=M,!(16&(M=z>>>16&255))){if((64&M)==0){z=T[(65535&z)+(b&(1<<M)-1)];continue r}n.msg="invalid distance code",o.mode=30;break e}if(G=65535&z,w<(M&=15)&&(b+=y[c++]<<w,(w+=8)<M&&(b+=y[c++]<<w,w+=8)),h<(G+=b&(1<<M)-1)){n.msg="invalid distance too far back",o.mode=30;break e}if(b>>>=M,w-=M,(M=d-u)<G){if(m<(M=G-M)&&o.sane){n.msg="invalid distance too far back",o.mode=30;break e}if(N=v,(C=0)===p){if(C+=g-M,M<W){for(W-=M;q[d++]=v[C++],--M;);C=d-G,N=q}}else if(p<M){if(C+=g+p-M,(M-=p)<W){for(W-=M;q[d++]=v[C++],--M;);if(C=0,p<W){for(W-=M=p;q[d++]=v[C++],--M;);C=d-G,N=q}}}else if(C+=p-M,M<W){for(W-=M;q[d++]=v[C++],--M;);C=d-G,N=q}for(;2<W;)q[d++]=N[C++],q[d++]=N[C++],q[d++]=N[C++],W-=3;W&&(q[d++]=N[C++],1<W&&(q[d++]=N[C++]))}else{for(C=d-G;q[d++]=q[C++],q[d++]=q[C++],q[d++]=q[C++],2<(W-=3););W&&(q[d++]=q[C++],1<W&&(q[d++]=q[C++]))}break}}break}}while(c<l&&d<f);c-=W=w>>3,b&=(1<<(w-=W<<3))-1,n.next_in=c,n.next_out=d,n.avail_in=c<l?l-c+5:5-(c-l),n.avail_out=d<f?f-d+257:257-(d-f),o.hold=b,o.bits=w}},{}],49:[function(t,i,a){var n=t("../utils/common"),s=t("./adler32"),o=t("./crc32"),c=t("./inffast"),l=t("./inftrees"),d=1,u=2,f=0,h=-2,g=1,m=852,p=592;function v(C){return(C>>>24&255)+(C>>>8&65280)+((65280&C)<<8)+((255&C)<<24)}function b(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new n.Buf16(320),this.work=new n.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function w(C){var N;return C&&C.state?(N=C.state,C.total_in=C.total_out=N.total=0,C.msg="",N.wrap&&(C.adler=1&N.wrap),N.mode=g,N.last=0,N.havedict=0,N.dmax=32768,N.head=null,N.hold=0,N.bits=0,N.lencode=N.lendyn=new n.Buf32(m),N.distcode=N.distdyn=new n.Buf32(p),N.sane=1,N.back=-1,f):h}function x(C){var N;return C&&C.state?((N=C.state).wsize=0,N.whave=0,N.wnext=0,w(C)):h}function T(C,N){var y,q;return C&&C.state?(q=C.state,N<0?(y=0,N=-N):(y=1+(N>>4),N<48&&(N&=15)),N&&(N<8||15<N)?h:(q.window!==null&&q.wbits!==N&&(q.window=null),q.wrap=y,q.wbits=N,x(C))):h}function A(C,N){var y,q;return C?(q=new b,(C.state=q).window=null,(y=T(C,N))!==f&&(C.state=null),y):h}var B,z,M=!0;function W(C){if(M){var N;for(B=new n.Buf32(512),z=new n.Buf32(32),N=0;N<144;)C.lens[N++]=8;for(;N<256;)C.lens[N++]=9;for(;N<280;)C.lens[N++]=7;for(;N<288;)C.lens[N++]=8;for(l(d,C.lens,0,288,B,0,C.work,{bits:9}),N=0;N<32;)C.lens[N++]=5;l(u,C.lens,0,32,z,0,C.work,{bits:5}),M=!1}C.lencode=B,C.lenbits=9,C.distcode=z,C.distbits=5}function G(C,N,y,q){var ne,Y=C.state;return Y.window===null&&(Y.wsize=1<<Y.wbits,Y.wnext=0,Y.whave=0,Y.window=new n.Buf8(Y.wsize)),q>=Y.wsize?(n.arraySet(Y.window,N,y-Y.wsize,Y.wsize,0),Y.wnext=0,Y.whave=Y.wsize):(q<(ne=Y.wsize-Y.wnext)&&(ne=q),n.arraySet(Y.window,N,y-q,ne,Y.wnext),(q-=ne)?(n.arraySet(Y.window,N,y-q,q,0),Y.wnext=q,Y.whave=Y.wsize):(Y.wnext+=ne,Y.wnext===Y.wsize&&(Y.wnext=0),Y.whave<Y.wsize&&(Y.whave+=ne))),0}a.inflateReset=x,a.inflateReset2=T,a.inflateResetKeep=w,a.inflateInit=function(C){return A(C,15)},a.inflateInit2=A,a.inflate=function(C,N){var y,q,ne,Y,fe,ee,he,K,L,be,ce,j,ie,me,ge,xe,Re,Be,st,ct,k,J,X,F,S=0,R=new n.Buf8(4),V=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!C||!C.state||!C.output||!C.input&&C.avail_in!==0)return h;(y=C.state).mode===12&&(y.mode=13),fe=C.next_out,ne=C.output,he=C.avail_out,Y=C.next_in,q=C.input,ee=C.avail_in,K=y.hold,L=y.bits,be=ee,ce=he,J=f;e:for(;;)switch(y.mode){case g:if(y.wrap===0){y.mode=13;break}for(;L<16;){if(ee===0)break e;ee--,K+=q[Y++]<<L,L+=8}if(2&y.wrap&&K===35615){R[y.check=0]=255&K,R[1]=K>>>8&255,y.check=o(y.check,R,2,0),L=K=0,y.mode=2;break}if(y.flags=0,y.head&&(y.head.done=!1),!(1&y.wrap)||(((255&K)<<8)+(K>>8))%31){C.msg="incorrect header check",y.mode=30;break}if((15&K)!=8){C.msg="unknown compression method",y.mode=30;break}if(L-=4,k=8+(15&(K>>>=4)),y.wbits===0)y.wbits=k;else if(k>y.wbits){C.msg="invalid window size",y.mode=30;break}y.dmax=1<<k,C.adler=y.check=1,y.mode=512&K?10:12,L=K=0;break;case 2:for(;L<16;){if(ee===0)break e;ee--,K+=q[Y++]<<L,L+=8}if(y.flags=K,(255&y.flags)!=8){C.msg="unknown compression method",y.mode=30;break}if(57344&y.flags){C.msg="unknown header flags set",y.mode=30;break}y.head&&(y.head.text=K>>8&1),512&y.flags&&(R[0]=255&K,R[1]=K>>>8&255,y.check=o(y.check,R,2,0)),L=K=0,y.mode=3;case 3:for(;L<32;){if(ee===0)break e;ee--,K+=q[Y++]<<L,L+=8}y.head&&(y.head.time=K),512&y.flags&&(R[0]=255&K,R[1]=K>>>8&255,R[2]=K>>>16&255,R[3]=K>>>24&255,y.check=o(y.check,R,4,0)),L=K=0,y.mode=4;case 4:for(;L<16;){if(ee===0)break e;ee--,K+=q[Y++]<<L,L+=8}y.head&&(y.head.xflags=255&K,y.head.os=K>>8),512&y.flags&&(R[0]=255&K,R[1]=K>>>8&255,y.check=o(y.check,R,2,0)),L=K=0,y.mode=5;case 5:if(1024&y.flags){for(;L<16;){if(ee===0)break e;ee--,K+=q[Y++]<<L,L+=8}y.length=K,y.head&&(y.head.extra_len=K),512&y.flags&&(R[0]=255&K,R[1]=K>>>8&255,y.check=o(y.check,R,2,0)),L=K=0}else y.head&&(y.head.extra=null);y.mode=6;case 6:if(1024&y.flags&&(ee<(j=y.length)&&(j=ee),j&&(y.head&&(k=y.head.extra_len-y.length,y.head.extra||(y.head.extra=new Array(y.head.extra_len)),n.arraySet(y.head.extra,q,Y,j,k)),512&y.flags&&(y.check=o(y.check,q,j,Y)),ee-=j,Y+=j,y.length-=j),y.length))break e;y.length=0,y.mode=7;case 7:if(2048&y.flags){if(ee===0)break e;for(j=0;k=q[Y+j++],y.head&&k&&y.length<65536&&(y.head.name+=String.fromCharCode(k)),k&&j<ee;);if(512&y.flags&&(y.check=o(y.check,q,j,Y)),ee-=j,Y+=j,k)break e}else y.head&&(y.head.name=null);y.length=0,y.mode=8;case 8:if(4096&y.flags){if(ee===0)break e;for(j=0;k=q[Y+j++],y.head&&k&&y.length<65536&&(y.head.comment+=String.fromCharCode(k)),k&&j<ee;);if(512&y.flags&&(y.check=o(y.check,q,j,Y)),ee-=j,Y+=j,k)break e}else y.head&&(y.head.comment=null);y.mode=9;case 9:if(512&y.flags){for(;L<16;){if(ee===0)break e;ee--,K+=q[Y++]<<L,L+=8}if(K!==(65535&y.check)){C.msg="header crc mismatch",y.mode=30;break}L=K=0}y.head&&(y.head.hcrc=y.flags>>9&1,y.head.done=!0),C.adler=y.check=0,y.mode=12;break;case 10:for(;L<32;){if(ee===0)break e;ee--,K+=q[Y++]<<L,L+=8}C.adler=y.check=v(K),L=K=0,y.mode=11;case 11:if(y.havedict===0)return C.next_out=fe,C.avail_out=he,C.next_in=Y,C.avail_in=ee,y.hold=K,y.bits=L,2;C.adler=y.check=1,y.mode=12;case 12:if(N===5||N===6)break e;case 13:if(y.last){K>>>=7&L,L-=7&L,y.mode=27;break}for(;L<3;){if(ee===0)break e;ee--,K+=q[Y++]<<L,L+=8}switch(y.last=1&K,L-=1,3&(K>>>=1)){case 0:y.mode=14;break;case 1:if(W(y),y.mode=20,N!==6)break;K>>>=2,L-=2;break e;case 2:y.mode=17;break;case 3:C.msg="invalid block type",y.mode=30}K>>>=2,L-=2;break;case 14:for(K>>>=7&L,L-=7&L;L<32;){if(ee===0)break e;ee--,K+=q[Y++]<<L,L+=8}if((65535&K)!=(K>>>16^65535)){C.msg="invalid stored block lengths",y.mode=30;break}if(y.length=65535&K,L=K=0,y.mode=15,N===6)break e;case 15:y.mode=16;case 16:if(j=y.length){if(ee<j&&(j=ee),he<j&&(j=he),j===0)break e;n.arraySet(ne,q,Y,j,fe),ee-=j,Y+=j,he-=j,fe+=j,y.length-=j;break}y.mode=12;break;case 17:for(;L<14;){if(ee===0)break e;ee--,K+=q[Y++]<<L,L+=8}if(y.nlen=257+(31&K),K>>>=5,L-=5,y.ndist=1+(31&K),K>>>=5,L-=5,y.ncode=4+(15&K),K>>>=4,L-=4,286<y.nlen||30<y.ndist){C.msg="too many length or distance symbols",y.mode=30;break}y.have=0,y.mode=18;case 18:for(;y.have<y.ncode;){for(;L<3;){if(ee===0)break e;ee--,K+=q[Y++]<<L,L+=8}y.lens[V[y.have++]]=7&K,K>>>=3,L-=3}for(;y.have<19;)y.lens[V[y.have++]]=0;if(y.lencode=y.lendyn,y.lenbits=7,X={bits:y.lenbits},J=l(0,y.lens,0,19,y.lencode,0,y.work,X),y.lenbits=X.bits,J){C.msg="invalid code lengths set",y.mode=30;break}y.have=0,y.mode=19;case 19:for(;y.have<y.nlen+y.ndist;){for(;xe=(S=y.lencode[K&(1<<y.lenbits)-1])>>>16&255,Re=65535&S,!((ge=S>>>24)<=L);){if(ee===0)break e;ee--,K+=q[Y++]<<L,L+=8}if(Re<16)K>>>=ge,L-=ge,y.lens[y.have++]=Re;else{if(Re===16){for(F=ge+2;L<F;){if(ee===0)break e;ee--,K+=q[Y++]<<L,L+=8}if(K>>>=ge,L-=ge,y.have===0){C.msg="invalid bit length repeat",y.mode=30;break}k=y.lens[y.have-1],j=3+(3&K),K>>>=2,L-=2}else if(Re===17){for(F=ge+3;L<F;){if(ee===0)break e;ee--,K+=q[Y++]<<L,L+=8}L-=ge,k=0,j=3+(7&(K>>>=ge)),K>>>=3,L-=3}else{for(F=ge+7;L<F;){if(ee===0)break e;ee--,K+=q[Y++]<<L,L+=8}L-=ge,k=0,j=11+(127&(K>>>=ge)),K>>>=7,L-=7}if(y.have+j>y.nlen+y.ndist){C.msg="invalid bit length repeat",y.mode=30;break}for(;j--;)y.lens[y.have++]=k}}if(y.mode===30)break;if(y.lens[256]===0){C.msg="invalid code -- missing end-of-block",y.mode=30;break}if(y.lenbits=9,X={bits:y.lenbits},J=l(d,y.lens,0,y.nlen,y.lencode,0,y.work,X),y.lenbits=X.bits,J){C.msg="invalid literal/lengths set",y.mode=30;break}if(y.distbits=6,y.distcode=y.distdyn,X={bits:y.distbits},J=l(u,y.lens,y.nlen,y.ndist,y.distcode,0,y.work,X),y.distbits=X.bits,J){C.msg="invalid distances set",y.mode=30;break}if(y.mode=20,N===6)break e;case 20:y.mode=21;case 21:if(6<=ee&&258<=he){C.next_out=fe,C.avail_out=he,C.next_in=Y,C.avail_in=ee,y.hold=K,y.bits=L,c(C,ce),fe=C.next_out,ne=C.output,he=C.avail_out,Y=C.next_in,q=C.input,ee=C.avail_in,K=y.hold,L=y.bits,y.mode===12&&(y.back=-1);break}for(y.back=0;xe=(S=y.lencode[K&(1<<y.lenbits)-1])>>>16&255,Re=65535&S,!((ge=S>>>24)<=L);){if(ee===0)break e;ee--,K+=q[Y++]<<L,L+=8}if(xe&&(240&xe)==0){for(Be=ge,st=xe,ct=Re;xe=(S=y.lencode[ct+((K&(1<<Be+st)-1)>>Be)])>>>16&255,Re=65535&S,!(Be+(ge=S>>>24)<=L);){if(ee===0)break e;ee--,K+=q[Y++]<<L,L+=8}K>>>=Be,L-=Be,y.back+=Be}if(K>>>=ge,L-=ge,y.back+=ge,y.length=Re,xe===0){y.mode=26;break}if(32&xe){y.back=-1,y.mode=12;break}if(64&xe){C.msg="invalid literal/length code",y.mode=30;break}y.extra=15&xe,y.mode=22;case 22:if(y.extra){for(F=y.extra;L<F;){if(ee===0)break e;ee--,K+=q[Y++]<<L,L+=8}y.length+=K&(1<<y.extra)-1,K>>>=y.extra,L-=y.extra,y.back+=y.extra}y.was=y.length,y.mode=23;case 23:for(;xe=(S=y.distcode[K&(1<<y.distbits)-1])>>>16&255,Re=65535&S,!((ge=S>>>24)<=L);){if(ee===0)break e;ee--,K+=q[Y++]<<L,L+=8}if((240&xe)==0){for(Be=ge,st=xe,ct=Re;xe=(S=y.distcode[ct+((K&(1<<Be+st)-1)>>Be)])>>>16&255,Re=65535&S,!(Be+(ge=S>>>24)<=L);){if(ee===0)break e;ee--,K+=q[Y++]<<L,L+=8}K>>>=Be,L-=Be,y.back+=Be}if(K>>>=ge,L-=ge,y.back+=ge,64&xe){C.msg="invalid distance code",y.mode=30;break}y.offset=Re,y.extra=15&xe,y.mode=24;case 24:if(y.extra){for(F=y.extra;L<F;){if(ee===0)break e;ee--,K+=q[Y++]<<L,L+=8}y.offset+=K&(1<<y.extra)-1,K>>>=y.extra,L-=y.extra,y.back+=y.extra}if(y.offset>y.dmax){C.msg="invalid distance too far back",y.mode=30;break}y.mode=25;case 25:if(he===0)break e;if(j=ce-he,y.offset>j){if((j=y.offset-j)>y.whave&&y.sane){C.msg="invalid distance too far back",y.mode=30;break}ie=j>y.wnext?(j-=y.wnext,y.wsize-j):y.wnext-j,j>y.length&&(j=y.length),me=y.window}else me=ne,ie=fe-y.offset,j=y.length;for(he<j&&(j=he),he-=j,y.length-=j;ne[fe++]=me[ie++],--j;);y.length===0&&(y.mode=21);break;case 26:if(he===0)break e;ne[fe++]=y.length,he--,y.mode=21;break;case 27:if(y.wrap){for(;L<32;){if(ee===0)break e;ee--,K|=q[Y++]<<L,L+=8}if(ce-=he,C.total_out+=ce,y.total+=ce,ce&&(C.adler=y.check=y.flags?o(y.check,ne,ce,fe-ce):s(y.check,ne,ce,fe-ce)),ce=he,(y.flags?K:v(K))!==y.check){C.msg="incorrect data check",y.mode=30;break}L=K=0}y.mode=28;case 28:if(y.wrap&&y.flags){for(;L<32;){if(ee===0)break e;ee--,K+=q[Y++]<<L,L+=8}if(K!==(4294967295&y.total)){C.msg="incorrect length check",y.mode=30;break}L=K=0}y.mode=29;case 29:J=1;break e;case 30:J=-3;break e;case 31:return-4;default:return h}return C.next_out=fe,C.avail_out=he,C.next_in=Y,C.avail_in=ee,y.hold=K,y.bits=L,(y.wsize||ce!==C.avail_out&&y.mode<30&&(y.mode<27||N!==4))&&G(C,C.output,C.next_out,ce-C.avail_out)?(y.mode=31,-4):(be-=C.avail_in,ce-=C.avail_out,C.total_in+=be,C.total_out+=ce,y.total+=ce,y.wrap&&ce&&(C.adler=y.check=y.flags?o(y.check,ne,ce,C.next_out-ce):s(y.check,ne,ce,C.next_out-ce)),C.data_type=y.bits+(y.last?64:0)+(y.mode===12?128:0)+(y.mode===20||y.mode===15?256:0),(be==0&&ce===0||N===4)&&J===f&&(J=-5),J)},a.inflateEnd=function(C){if(!C||!C.state)return h;var N=C.state;return N.window&&(N.window=null),C.state=null,f},a.inflateGetHeader=function(C,N){var y;return C&&C.state?(2&(y=C.state).wrap)==0?h:((y.head=N).done=!1,f):h},a.inflateSetDictionary=function(C,N){var y,q=N.length;return C&&C.state?(y=C.state).wrap!==0&&y.mode!==11?h:y.mode===11&&s(1,N,q,0)!==y.check?-3:G(C,N,q,q)?(y.mode=31,-4):(y.havedict=1,f):h},a.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(t,i,a){var n=t("../utils/common"),s=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],o=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],c=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],l=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];i.exports=function(d,u,f,h,g,m,p,v){var b,w,x,T,A,B,z,M,W,G=v.bits,C=0,N=0,y=0,q=0,ne=0,Y=0,fe=0,ee=0,he=0,K=0,L=null,be=0,ce=new n.Buf16(16),j=new n.Buf16(16),ie=null,me=0;for(C=0;C<=15;C++)ce[C]=0;for(N=0;N<h;N++)ce[u[f+N]]++;for(ne=G,q=15;1<=q&&ce[q]===0;q--);if(q<ne&&(ne=q),q===0)return g[m++]=20971520,g[m++]=20971520,v.bits=1,0;for(y=1;y<q&&ce[y]===0;y++);for(ne<y&&(ne=y),C=ee=1;C<=15;C++)if(ee<<=1,(ee-=ce[C])<0)return-1;if(0<ee&&(d===0||q!==1))return-1;for(j[1]=0,C=1;C<15;C++)j[C+1]=j[C]+ce[C];for(N=0;N<h;N++)u[f+N]!==0&&(p[j[u[f+N]]++]=N);if(B=d===0?(L=ie=p,19):d===1?(L=s,be-=257,ie=o,me-=257,256):(L=c,ie=l,-1),C=y,A=m,fe=N=K=0,x=-1,T=(he=1<<(Y=ne))-1,d===1&&852<he||d===2&&592<he)return 1;for(;;){for(z=C-fe,W=p[N]<B?(M=0,p[N]):p[N]>B?(M=ie[me+p[N]],L[be+p[N]]):(M=96,0),b=1<<C-fe,y=w=1<<Y;g[A+(K>>fe)+(w-=b)]=z<<24|M<<16|W|0,w!==0;);for(b=1<<C-1;K&b;)b>>=1;if(b!==0?(K&=b-1,K+=b):K=0,N++,--ce[C]==0){if(C===q)break;C=u[f+p[N]]}if(ne<C&&(K&T)!==x){for(fe===0&&(fe=ne),A+=y,ee=1<<(Y=C-fe);Y+fe<q&&!((ee-=ce[Y+fe])<=0);)Y++,ee<<=1;if(he+=1<<Y,d===1&&852<he||d===2&&592<he)return 1;g[x=K&T]=ne<<24|Y<<16|A-m|0}}return K!==0&&(g[A+K]=C-fe<<24|64<<16|0),v.bits=ne,0}},{"../utils/common":41}],51:[function(t,i,a){i.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(t,i,a){var n=t("../utils/common"),s=0,o=1;function c(S){for(var R=S.length;0<=--R;)S[R]=0}var l=0,d=29,u=256,f=u+1+d,h=30,g=19,m=2*f+1,p=15,v=16,b=7,w=256,x=16,T=17,A=18,B=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],z=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],M=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],W=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],G=new Array(2*(f+2));c(G);var C=new Array(2*h);c(C);var N=new Array(512);c(N);var y=new Array(256);c(y);var q=new Array(d);c(q);var ne,Y,fe,ee=new Array(h);function he(S,R,V,H,U){this.static_tree=S,this.extra_bits=R,this.extra_base=V,this.elems=H,this.max_length=U,this.has_stree=S&&S.length}function K(S,R){this.dyn_tree=S,this.max_code=0,this.stat_desc=R}function L(S){return S<256?N[S]:N[256+(S>>>7)]}function be(S,R){S.pending_buf[S.pending++]=255&R,S.pending_buf[S.pending++]=R>>>8&255}function ce(S,R,V){S.bi_valid>v-V?(S.bi_buf|=R<<S.bi_valid&65535,be(S,S.bi_buf),S.bi_buf=R>>v-S.bi_valid,S.bi_valid+=V-v):(S.bi_buf|=R<<S.bi_valid&65535,S.bi_valid+=V)}function j(S,R,V){ce(S,V[2*R],V[2*R+1])}function ie(S,R){for(var V=0;V|=1&S,S>>>=1,V<<=1,0<--R;);return V>>>1}function me(S,R,V){var H,U,Z=new Array(p+1),re=0;for(H=1;H<=p;H++)Z[H]=re=re+V[H-1]<<1;for(U=0;U<=R;U++){var Q=S[2*U+1];Q!==0&&(S[2*U]=ie(Z[Q]++,Q))}}function ge(S){var R;for(R=0;R<f;R++)S.dyn_ltree[2*R]=0;for(R=0;R<h;R++)S.dyn_dtree[2*R]=0;for(R=0;R<g;R++)S.bl_tree[2*R]=0;S.dyn_ltree[2*w]=1,S.opt_len=S.static_len=0,S.last_lit=S.matches=0}function xe(S){8<S.bi_valid?be(S,S.bi_buf):0<S.bi_valid&&(S.pending_buf[S.pending++]=S.bi_buf),S.bi_buf=0,S.bi_valid=0}function Re(S,R,V,H){var U=2*R,Z=2*V;return S[U]<S[Z]||S[U]===S[Z]&&H[R]<=H[V]}function Be(S,R,V){for(var H=S.heap[V],U=V<<1;U<=S.heap_len&&(U<S.heap_len&&Re(R,S.heap[U+1],S.heap[U],S.depth)&&U++,!Re(R,H,S.heap[U],S.depth));)S.heap[V]=S.heap[U],V=U,U<<=1;S.heap[V]=H}function st(S,R,V){var H,U,Z,re,Q=0;if(S.last_lit!==0)for(;H=S.pending_buf[S.d_buf+2*Q]<<8|S.pending_buf[S.d_buf+2*Q+1],U=S.pending_buf[S.l_buf+Q],Q++,H===0?j(S,U,R):(j(S,(Z=y[U])+u+1,R),(re=B[Z])!==0&&ce(S,U-=q[Z],re),j(S,Z=L(--H),V),(re=z[Z])!==0&&ce(S,H-=ee[Z],re)),Q<S.last_lit;);j(S,w,R)}function ct(S,R){var V,H,U,Z=R.dyn_tree,re=R.stat_desc.static_tree,Q=R.stat_desc.has_stree,ae=R.stat_desc.elems,we=-1;for(S.heap_len=0,S.heap_max=m,V=0;V<ae;V++)Z[2*V]!==0?(S.heap[++S.heap_len]=we=V,S.depth[V]=0):Z[2*V+1]=0;for(;S.heap_len<2;)Z[2*(U=S.heap[++S.heap_len]=we<2?++we:0)]=1,S.depth[U]=0,S.opt_len--,Q&&(S.static_len-=re[2*U+1]);for(R.max_code=we,V=S.heap_len>>1;1<=V;V--)Be(S,Z,V);for(U=ae;V=S.heap[1],S.heap[1]=S.heap[S.heap_len--],Be(S,Z,1),H=S.heap[1],S.heap[--S.heap_max]=V,S.heap[--S.heap_max]=H,Z[2*U]=Z[2*V]+Z[2*H],S.depth[U]=(S.depth[V]>=S.depth[H]?S.depth[V]:S.depth[H])+1,Z[2*V+1]=Z[2*H+1]=U,S.heap[1]=U++,Be(S,Z,1),2<=S.heap_len;);S.heap[--S.heap_max]=S.heap[1],(function(ye,Pe){var Ae,Ue,Ke,De,Je,mt,tt=Pe.dyn_tree,gt=Pe.max_code,jt=Pe.stat_desc.static_tree,Jt=Pe.stat_desc.has_stree,ze=Pe.stat_desc.extra_bits,Ee=Pe.stat_desc.extra_base,He=Pe.stat_desc.max_length,lt=0;for(De=0;De<=p;De++)ye.bl_count[De]=0;for(tt[2*ye.heap[ye.heap_max]+1]=0,Ae=ye.heap_max+1;Ae<m;Ae++)He<(De=tt[2*tt[2*(Ue=ye.heap[Ae])+1]+1]+1)&&(De=He,lt++),tt[2*Ue+1]=De,gt<Ue||(ye.bl_count[De]++,Je=0,Ee<=Ue&&(Je=ze[Ue-Ee]),mt=tt[2*Ue],ye.opt_len+=mt*(De+Je),Jt&&(ye.static_len+=mt*(jt[2*Ue+1]+Je)));if(lt!==0){do{for(De=He-1;ye.bl_count[De]===0;)De--;ye.bl_count[De]--,ye.bl_count[De+1]+=2,ye.bl_count[He]--,lt-=2}while(0<lt);for(De=He;De!==0;De--)for(Ue=ye.bl_count[De];Ue!==0;)gt<(Ke=ye.heap[--Ae])||(tt[2*Ke+1]!==De&&(ye.opt_len+=(De-tt[2*Ke+1])*tt[2*Ke],tt[2*Ke+1]=De),Ue--)}})(S,R),me(Z,we,S.bl_count)}function k(S,R,V){var H,U,Z=-1,re=R[1],Q=0,ae=7,we=4;for(re===0&&(ae=138,we=3),R[2*(V+1)+1]=65535,H=0;H<=V;H++)U=re,re=R[2*(H+1)+1],++Q<ae&&U===re||(Q<we?S.bl_tree[2*U]+=Q:U!==0?(U!==Z&&S.bl_tree[2*U]++,S.bl_tree[2*x]++):Q<=10?S.bl_tree[2*T]++:S.bl_tree[2*A]++,Z=U,we=(Q=0)===re?(ae=138,3):U===re?(ae=6,3):(ae=7,4))}function J(S,R,V){var H,U,Z=-1,re=R[1],Q=0,ae=7,we=4;for(re===0&&(ae=138,we=3),H=0;H<=V;H++)if(U=re,re=R[2*(H+1)+1],!(++Q<ae&&U===re)){if(Q<we)for(;j(S,U,S.bl_tree),--Q!=0;);else U!==0?(U!==Z&&(j(S,U,S.bl_tree),Q--),j(S,x,S.bl_tree),ce(S,Q-3,2)):Q<=10?(j(S,T,S.bl_tree),ce(S,Q-3,3)):(j(S,A,S.bl_tree),ce(S,Q-11,7));Z=U,we=(Q=0)===re?(ae=138,3):U===re?(ae=6,3):(ae=7,4)}}c(ee);var X=!1;function F(S,R,V,H){ce(S,(l<<1)+(H?1:0),3),(function(U,Z,re,Q){xe(U),be(U,re),be(U,~re),n.arraySet(U.pending_buf,U.window,Z,re,U.pending),U.pending+=re})(S,R,V)}a._tr_init=function(S){X||((function(){var R,V,H,U,Z,re=new Array(p+1);for(U=H=0;U<d-1;U++)for(q[U]=H,R=0;R<1<<B[U];R++)y[H++]=U;for(y[H-1]=U,U=Z=0;U<16;U++)for(ee[U]=Z,R=0;R<1<<z[U];R++)N[Z++]=U;for(Z>>=7;U<h;U++)for(ee[U]=Z<<7,R=0;R<1<<z[U]-7;R++)N[256+Z++]=U;for(V=0;V<=p;V++)re[V]=0;for(R=0;R<=143;)G[2*R+1]=8,R++,re[8]++;for(;R<=255;)G[2*R+1]=9,R++,re[9]++;for(;R<=279;)G[2*R+1]=7,R++,re[7]++;for(;R<=287;)G[2*R+1]=8,R++,re[8]++;for(me(G,f+1,re),R=0;R<h;R++)C[2*R+1]=5,C[2*R]=ie(R,5);ne=new he(G,B,u+1,f,p),Y=new he(C,z,0,h,p),fe=new he(new Array(0),M,0,g,b)})(),X=!0),S.l_desc=new K(S.dyn_ltree,ne),S.d_desc=new K(S.dyn_dtree,Y),S.bl_desc=new K(S.bl_tree,fe),S.bi_buf=0,S.bi_valid=0,ge(S)},a._tr_stored_block=F,a._tr_flush_block=function(S,R,V,H){var U,Z,re=0;0<S.level?(S.strm.data_type===2&&(S.strm.data_type=(function(Q){var ae,we=4093624447;for(ae=0;ae<=31;ae++,we>>>=1)if(1&we&&Q.dyn_ltree[2*ae]!==0)return s;if(Q.dyn_ltree[18]!==0||Q.dyn_ltree[20]!==0||Q.dyn_ltree[26]!==0)return o;for(ae=32;ae<u;ae++)if(Q.dyn_ltree[2*ae]!==0)return o;return s})(S)),ct(S,S.l_desc),ct(S,S.d_desc),re=(function(Q){var ae;for(k(Q,Q.dyn_ltree,Q.l_desc.max_code),k(Q,Q.dyn_dtree,Q.d_desc.max_code),ct(Q,Q.bl_desc),ae=g-1;3<=ae&&Q.bl_tree[2*W[ae]+1]===0;ae--);return Q.opt_len+=3*(ae+1)+5+5+4,ae})(S),U=S.opt_len+3+7>>>3,(Z=S.static_len+3+7>>>3)<=U&&(U=Z)):U=Z=V+5,V+4<=U&&R!==-1?F(S,R,V,H):S.strategy===4||Z===U?(ce(S,2+(H?1:0),3),st(S,G,C)):(ce(S,4+(H?1:0),3),(function(Q,ae,we,ye){var Pe;for(ce(Q,ae-257,5),ce(Q,we-1,5),ce(Q,ye-4,4),Pe=0;Pe<ye;Pe++)ce(Q,Q.bl_tree[2*W[Pe]+1],3);J(Q,Q.dyn_ltree,ae-1),J(Q,Q.dyn_dtree,we-1)})(S,S.l_desc.max_code+1,S.d_desc.max_code+1,re+1),st(S,S.dyn_ltree,S.dyn_dtree)),ge(S),H&&xe(S)},a._tr_tally=function(S,R,V){return S.pending_buf[S.d_buf+2*S.last_lit]=R>>>8&255,S.pending_buf[S.d_buf+2*S.last_lit+1]=255&R,S.pending_buf[S.l_buf+S.last_lit]=255&V,S.last_lit++,R===0?S.dyn_ltree[2*V]++:(S.matches++,R--,S.dyn_ltree[2*(y[V]+u+1)]++,S.dyn_dtree[2*L(R)]++),S.last_lit===S.lit_bufsize-1},a._tr_align=function(S){ce(S,2,3),j(S,w,G),(function(R){R.bi_valid===16?(be(R,R.bi_buf),R.bi_buf=0,R.bi_valid=0):8<=R.bi_valid&&(R.pending_buf[R.pending++]=255&R.bi_buf,R.bi_buf>>=8,R.bi_valid-=8)})(S)}},{"../utils/common":41}],53:[function(t,i,a){i.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(t,i,a){(function(n){(function(s,o){if(!s.setImmediate){var c,l,d,u,f=1,h={},g=!1,m=s.document,p=Object.getPrototypeOf&&Object.getPrototypeOf(s);p=p&&p.setTimeout?p:s,c={}.toString.call(s.process)==="[object process]"?function(x){process.nextTick(function(){b(x)})}:(function(){if(s.postMessage&&!s.importScripts){var x=!0,T=s.onmessage;return s.onmessage=function(){x=!1},s.postMessage("","*"),s.onmessage=T,x}})()?(u="setImmediate$"+Math.random()+"$",s.addEventListener?s.addEventListener("message",w,!1):s.attachEvent("onmessage",w),function(x){s.postMessage(u+x,"*")}):s.MessageChannel?((d=new MessageChannel).port1.onmessage=function(x){b(x.data)},function(x){d.port2.postMessage(x)}):m&&"onreadystatechange"in m.createElement("script")?(l=m.documentElement,function(x){var T=m.createElement("script");T.onreadystatechange=function(){b(x),T.onreadystatechange=null,l.removeChild(T),T=null},l.appendChild(T)}):function(x){setTimeout(b,0,x)},p.setImmediate=function(x){typeof x!="function"&&(x=new Function(""+x));for(var T=new Array(arguments.length-1),A=0;A<T.length;A++)T[A]=arguments[A+1];var B={callback:x,args:T};return h[f]=B,c(f),f++},p.clearImmediate=v}function v(x){delete h[x]}function b(x){if(g)setTimeout(b,0,x);else{var T=h[x];if(T){g=!0;try{(function(A){var B=A.callback,z=A.args;switch(z.length){case 0:B();break;case 1:B(z[0]);break;case 2:B(z[0],z[1]);break;case 3:B(z[0],z[1],z[2]);break;default:B.apply(o,z)}})(T)}finally{v(x),g=!1}}}}function w(x){x.source===s&&typeof x.data=="string"&&x.data.indexOf(u)===0&&b(+x.data.slice(u.length))}})(typeof self>"u"?n===void 0?this:n:self)}).call(this,typeof Fa<"u"?Fa:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(ps)),ps.exports}var Eu=Pu();const Iu=Cu(Eu);function E(r){if(!r)throw new Error("Assertion failed.")}const as=r=>{const e=(r%360+360)%360;if(e===0||e===90||e===180||e===270)return e;throw new Error(`Invalid rotation ${r}.`)},wt=r=>r&&r[r.length-1],$i=r=>r>=0&&r<2**32;class ft{constructor(e){this.bytes=e,this.pos=0}seekToByte(e){this.pos=8*e}readBit(){const e=Math.floor(this.pos/8),t=this.bytes[e]??0,i=7-(this.pos&7),a=(t&1<<i)>>i;return this.pos++,a}readBits(e){if(e===1)return this.readBit();let t=0;for(let i=0;i<e;i++)t<<=1,t|=this.readBit();return t}writeBits(e,t){const i=this.pos+e;for(let a=this.pos;a<i;a++){const n=Math.floor(a/8);let s=this.bytes[n];const o=7-(a&7);s&=~(1<<o),s|=(t&1<<i-a-1)>>i-a-1<<o,this.bytes[n]=s}this.pos=i}readAlignedByte(){if(this.pos%8!==0)throw new Error("Bitstream is not byte-aligned.");const e=this.pos/8,t=this.bytes[e]??0;return this.pos+=8,t}skipBits(e){this.pos+=e}getBitsLeft(){return this.bytes.length*8-this.pos}clone(){const e=new ft(this.bytes);return e.pos=this.pos,e}}const ue=r=>{let e=0;for(;r.readBits(1)===0&&e<32;)e++;if(e>=32)throw new Error("Invalid exponential-Golomb code.");return(1<<e)-1+r.readBits(e)},Or=r=>{const e=ue(r);return(e&1)===0?-(e>>1):e+1>>1},Au=(r,e,t,i)=>{for(let a=e;a<t;a++){const n=Math.floor(a/8);let s=r[n];const o=7-(a&7);s&=~(1<<o),s|=(i&1<<t-a-1)>>t-a-1<<o,r[n]=s}},Lt=r=>r.constructor===Uint8Array?r:ArrayBuffer.isView(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):new Uint8Array(r),kt=r=>r.constructor===DataView?r:ArrayBuffer.isView(r)?new DataView(r.buffer,r.byteOffset,r.byteLength):new DataView(r),lr=new TextDecoder,Kt=new TextEncoder,xn=r=>Object.fromEntries(Object.entries(r).map(([e,t])=>[t,e])),Ki={bt709:1,bt470bg:5,smpte170m:6,bt2020:9,smpte432:12},qa=xn(Ki),Gi={bt709:1,smpte170m:6,linear:8,"iec61966-2-1":13,pq:16,hlg:18},Ka=xn(Gi),Qi={rgb:0,bt709:1,bt470bg:5,smpte170m:6,"bt2020-ncl":9},Ga=xn(Qi),Cc=r=>!!r&&!!r.primaries&&!!r.transfer&&!!r.matrix&&r.fullRange!==void 0,ss=r=>r instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&r instanceof SharedArrayBuffer||ArrayBuffer.isView(r);class fi{constructor(){this.currentPromise=Promise.resolve(),this.pending=0}async acquire(){let e;const t=new Promise(a=>{let n=!1;e=()=>{n||(a(),this.pending--,n=!0)}}),i=this.currentPromise;return this.currentPromise=t,this.pending++,await i,e}}const ko=r=>[...r].map(e=>e.toString(16).padStart(2,"0")).join(""),yo=r=>(r=r>>1&1431655765|(r&1431655765)<<1,r=r>>2&858993459|(r&858993459)<<2,r=r>>4&252645135|(r&252645135)<<4,r=r>>8&16711935|(r&16711935)<<8,r=r>>16&65535|(r&65535)<<16,r>>>0),_a=(r,e,t)=>{let i=0,a=r.length-1,n=-1;for(;i<=a;){const s=i+a>>1,o=t(r[s]);o===e?(n=s,a=s-1):o<e?i=s+1:a=s-1}return n},rt=(r,e,t)=>{let i=0,a=r.length-1,n=-1;for(;i<=a;){const s=i+(a-i+1)/2|0;t(r[s])<=e?(n=s,i=s+1):a=s-1}return n},xo=(r,e,t)=>{const i=rt(r,t(e),t);r.splice(i+1,0,e)},Rt=()=>{let r,e;return{promise:new Promise((i,a)=>{r=i,e=a}),resolve:r,reject:e}},Pc=(r,e)=>{for(let t=r.length-1;t>=0;t--)if(e(r[t]))return r[t]},_n=(r,e)=>{for(let t=r.length-1;t>=0;t--)if(e(r[t]))return t;return-1},Fu=async function*(r){Symbol.iterator in r?yield*r[Symbol.iterator]():yield*r[Symbol.asyncIterator]()},Bu=r=>{if(!(Symbol.iterator in r)&&!(Symbol.asyncIterator in r))throw new TypeError("Argument must be an iterable or async iterable.")},Tr=r=>{throw new Error(`Unexpected value: ${r}`)},ns=(r,e,t)=>{const i=r.getUint8(e),a=r.getUint8(e+1),n=r.getUint8(e+2);return t?i|a<<8|n<<16:i<<16|a<<8|n},zu=(r,e,t)=>ns(r,e,t)<<8>>8,Tn=(r,e,t,i)=>{t=t>>>0,t=t&16777215,i?(r.setUint8(e,t&255),r.setUint8(e+1,t>>>8&255),r.setUint8(e+2,t>>>16&255)):(r.setUint8(e,t>>>16&255),r.setUint8(e+1,t>>>8&255),r.setUint8(e+2,t&255))},Mu=(r,e,t,i)=>{t=Mt(t,-8388608,8388607),t<0&&(t=t+16777216&16777215),Tn(r,e,t,i)},_o=(r,e)=>({async next(){const t=await r.next();return t.done?{value:void 0,done:!0}:{value:e(t.value),done:!1}},return(){return r.return()},throw(t){return r.throw(t)},[Symbol.asyncIterator](){return this}}),Mt=(r,e,t)=>Math.max(e,Math.min(t,r)),Gt="und",pa=r=>{const e=Math.round(r);return Math.abs(r/e-1)<10*Number.EPSILON?e:r},Qa=(r,e)=>Math.round(r/e)*e,Ru=r=>{let e=0;for(;r;)e++,r>>=1;return e},Du=/^[a-z]{3}$/,ga=r=>Du.test(r),Kr=1e6*(1+Number.EPSILON),Ou=(r,e)=>{const t=r<0?-1:1;r=Math.abs(r);let i=0,a=1,n=1,s=0,o=r;for(;;){const c=Math.floor(o),l=c*n+i,d=c*s+a;if(d>e)return{numerator:t*n,denominator:s};if(i=n,a=s,n=l,s=d,o=1/(o-c),!isFinite(o))break}return{numerator:t*n,denominator:s}};class os{constructor(){this.currentPromise=Promise.resolve()}call(e){return this.currentPromise=this.currentPromise.then(e)}}let gs=null;const da=()=>gs!==null?gs:gs=!!(typeof navigator<"u"&&(navigator.vendor?.match(/apple/i)||/AppleWebKit/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)||/\b(iPad|iPhone|iPod)\b/.test(navigator.userAgent)));let vs=null;const Wi=()=>vs!==null?vs:vs=typeof navigator<"u"&&navigator.userAgent?.includes("Firefox");let bs=null;const Ks=()=>bs!==null?bs:bs=!!(typeof navigator<"u"&&(navigator.vendor?.includes("Google Inc")||/Chrome/.test(navigator.userAgent)));let ws=null;const Nu=()=>{if(ws!==null)return ws;if(typeof navigator>"u")return null;const r=/\bChrome\/(\d+)/.exec(navigator.userAgent);return r?ws=Number(r[1]):null},bi=(r,e)=>r!==-1?r:e,To=(r,e,t,i)=>r<=i&&t<=e,Sn=function*(r){for(const e in r){const t=r[e];t!==void 0&&(yield{key:e,value:t})}},Uu=r=>{switch(r.toLowerCase()){case"image/jpeg":case"image/jpg":return".jpg";case"image/png":return".png";case"image/gif":return".gif";case"image/webp":return".webp";case"image/bmp":return".bmp";case"image/svg+xml":return".svg";case"image/tiff":return".tiff";case"image/avif":return".avif";case"image/x-icon":case"image/vnd.microsoft.icon":return".ico";default:return null}},Vu=r=>{const e=atob(r),t=new Uint8Array(e.length);for(let i=0;i<e.length;i++)t[i]=e.charCodeAt(i);return t},Lu=(r,e)=>{if(r.length!==e.length)return!1;for(let t=0;t<r.length;t++)if(r[t]!==e[t])return!1;return!0},Ec=()=>{Symbol.dispose??=Symbol("Symbol.dispose")},Ic=r=>typeof r=="number"&&!Number.isNaN(r);class Di{constructor(e,t){if(this.data=e,this.mimeType=t,!(e instanceof Uint8Array))throw new TypeError("data must be a Uint8Array.");if(typeof t!="string")throw new TypeError("mimeType must be a string.")}}class Cn{constructor(e,t,i,a){if(this.data=e,this.mimeType=t,this.name=i,this.description=a,!(e instanceof Uint8Array))throw new TypeError("data must be a Uint8Array.");if(t!==void 0&&typeof t!="string")throw new TypeError("mimeType, when provided, must be a string.");if(i!==void 0&&typeof i!="string")throw new TypeError("name, when provided, must be a string.");if(a!==void 0&&typeof a!="string")throw new TypeError("description, when provided, must be a string.")}}const Gs=r=>{if(!r||typeof r!="object")throw new TypeError("tags must be an object.");if(r.title!==void 0&&typeof r.title!="string")throw new TypeError("tags.title, when provided, must be a string.");if(r.description!==void 0&&typeof r.description!="string")throw new TypeError("tags.description, when provided, must be a string.");if(r.artist!==void 0&&typeof r.artist!="string")throw new TypeError("tags.artist, when provided, must be a string.");if(r.album!==void 0&&typeof r.album!="string")throw new TypeError("tags.album, when provided, must be a string.");if(r.albumArtist!==void 0&&typeof r.albumArtist!="string")throw new TypeError("tags.albumArtist, when provided, must be a string.");if(r.trackNumber!==void 0&&(!Number.isInteger(r.trackNumber)||r.trackNumber<=0))throw new TypeError("tags.trackNumber, when provided, must be a positive integer.");if(r.tracksTotal!==void 0&&(!Number.isInteger(r.tracksTotal)||r.tracksTotal<=0))throw new TypeError("tags.tracksTotal, when provided, must be a positive integer.");if(r.discNumber!==void 0&&(!Number.isInteger(r.discNumber)||r.discNumber<=0))throw new TypeError("tags.discNumber, when provided, must be a positive integer.");if(r.discsTotal!==void 0&&(!Number.isInteger(r.discsTotal)||r.discsTotal<=0))throw new TypeError("tags.discsTotal, when provided, must be a positive integer.");if(r.genre!==void 0&&typeof r.genre!="string")throw new TypeError("tags.genre, when provided, must be a string.");if(r.date!==void 0&&(!(r.date instanceof Date)||Number.isNaN(r.date.getTime())))throw new TypeError("tags.date, when provided, must be a valid Date.");if(r.lyrics!==void 0&&typeof r.lyrics!="string")throw new TypeError("tags.lyrics, when provided, must be a string.");if(r.images!==void 0){if(!Array.isArray(r.images))throw new TypeError("tags.images, when provided, must be an array.");for(const e of r.images){if(!e||typeof e!="object")throw new TypeError("Each image in tags.images must be an object.");if(!(e.data instanceof Uint8Array))throw new TypeError("Each image.data must be a Uint8Array.");if(typeof e.mimeType!="string")throw new TypeError("Each image.mimeType must be a string.");if(!["coverFront","coverBack","unknown"].includes(e.kind))throw new TypeError("Each image.kind must be 'coverFront', 'coverBack', or 'unknown'.")}}if(r.comment!==void 0&&typeof r.comment!="string")throw new TypeError("tags.comment, when provided, must be a string.");if(r.raw!==void 0){if(!r.raw||typeof r.raw!="object")throw new TypeError("tags.raw, when provided, must be an object.");for(const e of Object.values(r.raw))if(e!==null&&typeof e!="string"&&!(e instanceof Uint8Array)&&!(e instanceof Di)&&!(e instanceof Cn))throw new TypeError("Each value in tags.raw must be a string, Uint8Array, RichImageData, AttachedFile, or null.")}},Jr={default:!0,forced:!1,original:!1,commentary:!1,hearingImpaired:!1,visuallyImpaired:!1},$u=r=>{if(!r||typeof r!="object")throw new TypeError("disposition must be an object.");if(r.default!==void 0&&typeof r.default!="boolean")throw new TypeError("disposition.default must be a boolean.");if(r.forced!==void 0&&typeof r.forced!="boolean")throw new TypeError("disposition.forced must be a boolean.");if(r.original!==void 0&&typeof r.original!="boolean")throw new TypeError("disposition.original must be a boolean.");if(r.commentary!==void 0&&typeof r.commentary!="boolean")throw new TypeError("disposition.commentary must be a boolean.");if(r.hearingImpaired!==void 0&&typeof r.hearingImpaired!="boolean")throw new TypeError("disposition.hearingImpaired must be a boolean.");if(r.visuallyImpaired!==void 0&&typeof r.visuallyImpaired!="boolean")throw new TypeError("disposition.visuallyImpaired must be a boolean.")};const dr=["avc","hevc","vp9","av1","vp8"],Ot=["pcm-s16","pcm-s16be","pcm-s24","pcm-s24be","pcm-s32","pcm-s32be","pcm-f32","pcm-f32be","pcm-f64","pcm-f64be","pcm-u8","pcm-s8","ulaw","alaw"],Oi=["aac","opus","mp3","vorbis","flac"],pr=[...Oi,...Ot],Hi=["webvtt"],Xa=[{maxMacroblocks:99,maxBitrate:64e3,maxDpbMbs:396,level:10},{maxMacroblocks:396,maxBitrate:192e3,maxDpbMbs:900,level:11},{maxMacroblocks:396,maxBitrate:384e3,maxDpbMbs:2376,level:12},{maxMacroblocks:396,maxBitrate:768e3,maxDpbMbs:2376,level:13},{maxMacroblocks:396,maxBitrate:2e6,maxDpbMbs:2376,level:20},{maxMacroblocks:792,maxBitrate:4e6,maxDpbMbs:4752,level:21},{maxMacroblocks:1620,maxBitrate:4e6,maxDpbMbs:8100,level:22},{maxMacroblocks:1620,maxBitrate:1e7,maxDpbMbs:8100,level:30},{maxMacroblocks:3600,maxBitrate:14e6,maxDpbMbs:18e3,level:31},{maxMacroblocks:5120,maxBitrate:2e7,maxDpbMbs:20480,level:32},{maxMacroblocks:8192,maxBitrate:2e7,maxDpbMbs:32768,level:40},{maxMacroblocks:8192,maxBitrate:5e7,maxDpbMbs:32768,level:41},{maxMacroblocks:8704,maxBitrate:5e7,maxDpbMbs:34816,level:42},{maxMacroblocks:22080,maxBitrate:135e6,maxDpbMbs:110400,level:50},{maxMacroblocks:36864,maxBitrate:24e7,maxDpbMbs:184320,level:51},{maxMacroblocks:36864,maxBitrate:24e7,maxDpbMbs:184320,level:52},{maxMacroblocks:139264,maxBitrate:24e7,maxDpbMbs:696320,level:60},{maxMacroblocks:139264,maxBitrate:48e7,maxDpbMbs:696320,level:61},{maxMacroblocks:139264,maxBitrate:8e8,maxDpbMbs:696320,level:62}],So=[{maxPictureSize:36864,maxBitrate:128e3,tier:"L",level:30},{maxPictureSize:122880,maxBitrate:15e5,tier:"L",level:60},{maxPictureSize:245760,maxBitrate:3e6,tier:"L",level:63},{maxPictureSize:552960,maxBitrate:6e6,tier:"L",level:90},{maxPictureSize:983040,maxBitrate:1e7,tier:"L",level:93},{maxPictureSize:2228224,maxBitrate:12e6,tier:"L",level:120},{maxPictureSize:2228224,maxBitrate:3e7,tier:"H",level:120},{maxPictureSize:2228224,maxBitrate:2e7,tier:"L",level:123},{maxPictureSize:2228224,maxBitrate:5e7,tier:"H",level:123},{maxPictureSize:8912896,maxBitrate:25e6,tier:"L",level:150},{maxPictureSize:8912896,maxBitrate:1e8,tier:"H",level:150},{maxPictureSize:8912896,maxBitrate:4e7,tier:"L",level:153},{maxPictureSize:8912896,maxBitrate:16e7,tier:"H",level:153},{maxPictureSize:8912896,maxBitrate:6e7,tier:"L",level:156},{maxPictureSize:8912896,maxBitrate:24e7,tier:"H",level:156},{maxPictureSize:35651584,maxBitrate:6e7,tier:"L",level:180},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:180},{maxPictureSize:35651584,maxBitrate:12e7,tier:"L",level:183},{maxPictureSize:35651584,maxBitrate:48e7,tier:"H",level:183},{maxPictureSize:35651584,maxBitrate:24e7,tier:"L",level:186},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:186}],Gr=[{maxPictureSize:36864,maxBitrate:2e5,level:10},{maxPictureSize:73728,maxBitrate:8e5,level:11},{maxPictureSize:122880,maxBitrate:18e5,level:20},{maxPictureSize:245760,maxBitrate:36e5,level:21},{maxPictureSize:552960,maxBitrate:72e5,level:30},{maxPictureSize:983040,maxBitrate:12e6,level:31},{maxPictureSize:2228224,maxBitrate:18e6,level:40},{maxPictureSize:2228224,maxBitrate:3e7,level:41},{maxPictureSize:8912896,maxBitrate:6e7,level:50},{maxPictureSize:8912896,maxBitrate:12e7,level:51},{maxPictureSize:8912896,maxBitrate:18e7,level:52},{maxPictureSize:35651584,maxBitrate:18e7,level:60},{maxPictureSize:35651584,maxBitrate:24e7,level:61},{maxPictureSize:35651584,maxBitrate:48e7,level:62}],Co=[{maxPictureSize:147456,maxBitrate:15e5,tier:"M",level:0},{maxPictureSize:278784,maxBitrate:3e6,tier:"M",level:1},{maxPictureSize:665856,maxBitrate:6e6,tier:"M",level:4},{maxPictureSize:1065024,maxBitrate:1e7,tier:"M",level:5},{maxPictureSize:2359296,maxBitrate:12e6,tier:"M",level:8},{maxPictureSize:2359296,maxBitrate:3e7,tier:"H",level:8},{maxPictureSize:2359296,maxBitrate:2e7,tier:"M",level:9},{maxPictureSize:2359296,maxBitrate:5e7,tier:"H",level:9},{maxPictureSize:8912896,maxBitrate:3e7,tier:"M",level:12},{maxPictureSize:8912896,maxBitrate:1e8,tier:"H",level:12},{maxPictureSize:8912896,maxBitrate:4e7,tier:"M",level:13},{maxPictureSize:8912896,maxBitrate:16e7,tier:"H",level:13},{maxPictureSize:8912896,maxBitrate:6e7,tier:"M",level:14},{maxPictureSize:8912896,maxBitrate:24e7,tier:"H",level:14},{maxPictureSize:35651584,maxBitrate:6e7,tier:"M",level:15},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:15},{maxPictureSize:35651584,maxBitrate:6e7,tier:"M",level:16},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:16},{maxPictureSize:35651584,maxBitrate:1e8,tier:"M",level:17},{maxPictureSize:35651584,maxBitrate:48e7,tier:"H",level:17},{maxPictureSize:35651584,maxBitrate:16e7,tier:"M",level:18},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:18},{maxPictureSize:35651584,maxBitrate:16e7,tier:"M",level:19},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:19}],Po=".01.01.01.01.00",Eo=".0.110.01.01.01.0",Wu=(r,e,t,i)=>{if(r==="avc"){const n=Math.ceil(e/16)*Math.ceil(t/16),s=Xa.find(u=>n<=u.maxMacroblocks&&i<=u.maxBitrate)??wt(Xa),o=s?s.level:0,c="64".padStart(2,"0"),l="00",d=o.toString(16).padStart(2,"0");return`avc1.${c}${l}${d}`}else if(r==="hevc"){const o=e*t,c=So.find(d=>o<=d.maxPictureSize&&i<=d.maxBitrate)??wt(So);return`hev1.1.6.${c.tier}${c.level}.B0`}else{if(r==="vp8")return"vp8";if(r==="vp9"){const n=e*t;return`vp09.00.${(Gr.find(c=>n<=c.maxPictureSize&&i<=c.maxBitrate)??wt(Gr)).level.toString().padStart(2,"0")}.08`}else if(r==="av1"){const n=e*t,s=Co.find(l=>n<=l.maxPictureSize&&i<=l.maxBitrate)??wt(Co);return`av01.0.${s.level.toString().padStart(2,"0")}${s.tier}.08`}}throw new TypeError(`Unhandled codec '${r}'.`)},Hu=r=>{const e=r.split("."),t=Number(e[1]),i=Number(e[2]),a=Number(e[3]),n=e[4]?Number(e[4]):1;return[1,1,t,2,1,i,3,1,a,4,1,n]},Ac=r=>{const e=r.split("."),a=(1<<7)+1,n=Number(e[1]),s=e[2],o=Number(s.slice(0,-1)),c=(n<<5)+o,l=s.slice(-1)==="H"?1:0,u=Number(e[3])===8?0:1,f=0,h=e[4]?Number(e[4]):0,g=e[5]?Number(e[5][0]):1,m=e[5]?Number(e[5][1]):1,p=e[5]?Number(e[5][2]):0,v=(l<<7)+(u<<6)+(f<<5)+(h<<4)+(g<<3)+(m<<2)+p;return[a,c,v,0]},Pn=r=>{const{codec:e,codecDescription:t,colorSpace:i,avcCodecInfo:a,hevcCodecInfo:n,vp9CodecInfo:s,av1CodecInfo:o}=r;if(e==="avc"){if(E(r.avcType!==null),a){const c=new Uint8Array([a.avcProfileIndication,a.profileCompatibility,a.avcLevelIndication]);return`avc${r.avcType}.${ko(c)}`}if(!t||t.byteLength<4)throw new TypeError("AVC decoder description is not provided or is not at least 4 bytes long.");return`avc${r.avcType}.${ko(t.subarray(1,4))}`}else if(e==="hevc"){let c,l,d,u,f,h;if(n)c=n.generalProfileSpace,l=n.generalProfileIdc,d=yo(n.generalProfileCompatibilityFlags),u=n.generalTierFlag,f=n.generalLevelIdc,h=[...n.generalConstraintIndicatorFlags];else{if(!t||t.byteLength<23)throw new TypeError("HEVC decoder description is not provided or is not at least 23 bytes long.");const m=kt(t),p=m.getUint8(1);c=p>>6&3,l=p&31,d=yo(m.getUint32(2)),u=p>>5&1,f=m.getUint8(12),h=[];for(let v=0;v<6;v++)h.push(m.getUint8(6+v))}let g="hev1.";for(g+=["","A","B","C"][c]+l,g+=".",g+=d.toString(16).toUpperCase(),g+=".",g+=u===0?"L":"H",g+=f;h.length>0&&h[h.length-1]===0;)h.pop();return h.length>0&&(g+=".",g+=h.map(m=>m.toString(16).toUpperCase()).join(".")),g}else{if(e==="vp8")return"vp8";if(e==="vp9"){if(!s){const v=r.width*r.height;let b=wt(Gr).level;for(const w of Gr)if(v<=w.maxPictureSize){b=w.level;break}return`vp09.00.${b.toString().padStart(2,"0")}.08`}const c=s.profile.toString().padStart(2,"0"),l=s.level.toString().padStart(2,"0"),d=s.bitDepth.toString().padStart(2,"0"),u=s.chromaSubsampling.toString().padStart(2,"0"),f=s.colourPrimaries.toString().padStart(2,"0"),h=s.transferCharacteristics.toString().padStart(2,"0"),g=s.matrixCoefficients.toString().padStart(2,"0"),m=s.videoFullRangeFlag.toString().padStart(2,"0");let p=`vp09.${c}.${l}.${d}.${u}`;return p+=`.${f}.${h}.${g}.${m}`,p.endsWith(Po)&&(p=p.slice(0,-Po.length)),p}else if(e==="av1"){if(!o){const w=r.width*r.height;let x=wt(Gr).level;for(const T of Gr)if(w<=T.maxPictureSize){x=T.level;break}return`av01.0.${x.toString().padStart(2,"0")}M.08`}const c=o.profile,l=o.level.toString().padStart(2,"0"),d=o.tier?"H":"M",u=o.bitDepth.toString().padStart(2,"0"),f=o.monochrome?"1":"0",h=100*o.chromaSubsamplingX+10*o.chromaSubsamplingY+1*(o.chromaSubsamplingX&&o.chromaSubsamplingY?o.chromaSamplePosition:0),g=i?.primaries?Ki[i.primaries]:1,m=i?.transfer?Gi[i.transfer]:1,p=i?.matrix?Qi[i.matrix]:1,v=i?.fullRange?1:0;let b=`av01.${c}.${l}${d}.${u}`;return b+=`.${f}.${h.toString().padStart(3,"0")}`,b+=`.${g.toString().padStart(2,"0")}`,b+=`.${m.toString().padStart(2,"0")}`,b+=`.${p.toString().padStart(2,"0")}`,b+=`.${v}`,b.endsWith(Eo)&&(b=b.slice(0,-Eo.length)),b}}throw new TypeError(`Unhandled codec '${e}'.`)},ju=(r,e,t)=>{if(r==="aac")return e>=2&&t<=24e3?"mp4a.40.29":t<=24e3?"mp4a.40.5":"mp4a.40.2";if(r==="mp3")return"mp3";if(r==="opus")return"opus";if(r==="vorbis")return"vorbis";if(r==="flac")return"flac";if(Ot.includes(r))return r;throw new TypeError(`Unhandled codec '${r}'.`)},En=r=>{const{codec:e,codecDescription:t,aacCodecInfo:i}=r;if(e==="aac"){if(!i)throw new TypeError("AAC codec info must be provided.");if(i.isMpeg2)return"mp4a.67";{let a;return i.objectType!==null?a=i.objectType:a=In(t).objectType,`mp4a.40.${a}`}}else{if(e==="mp3")return"mp3";if(e==="opus")return"opus";if(e==="vorbis")return"vorbis";if(e==="flac")return"flac";if(e&&Ot.includes(e))return e}throw new TypeError(`Unhandled codec '${e}'.`)},Yr=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],Xi=[-1,1,2,3,4,5,6,8],In=r=>{if(!r||r.byteLength<2)throw new TypeError("AAC description must be at least 2 bytes long.");const e=new ft(r);let t=e.readBits(5);t===31&&(t=32+e.readBits(6));const i=e.readBits(4);let a=null;i===15?a=e.readBits(24):i<Yr.length&&(a=Yr[i]);const n=e.readBits(4);let s=null;return n>=1&&n<=7&&(s=Xi[n]),{objectType:t,frequencyIndex:i,sampleRate:a,channelConfiguration:n,numberOfChannels:s}},An=r=>{let e=Yr.indexOf(r.sampleRate),t=null;e===-1&&(e=15,t=r.sampleRate);const i=Xi.indexOf(r.numberOfChannels);if(i===-1)throw new TypeError(`Unsupported number of channels: ${r.numberOfChannels}`);let a=13;r.objectType>=32&&(a+=6),e===15&&(a+=24);const n=Math.ceil(a/8),s=new Uint8Array(n),o=new ft(s);return r.objectType<32?o.writeBits(5,r.objectType):(o.writeBits(5,31),o.writeBits(6,r.objectType-32)),o.writeBits(4,e),e===15&&o.writeBits(24,t),o.writeBits(4,i),s},Ta=48e3,Fc=/^pcm-([usf])(\d+)+(be)?$/,Ur=r=>{if(E(Ot.includes(r)),r==="ulaw")return{dataType:"ulaw",sampleSize:1,littleEndian:!0,silentValue:255};if(r==="alaw")return{dataType:"alaw",sampleSize:1,littleEndian:!0,silentValue:213};const e=Fc.exec(r);E(e);let t;e[1]==="u"?t="unsigned":e[1]==="s"?t="signed":t="float";const i=Number(e[2])/8,a=e[3]!=="be",n=r==="pcm-u8"?2**7:0;return{dataType:t,sampleSize:i,littleEndian:a,silentValue:n}},Bc=r=>r.startsWith("avc1")||r.startsWith("avc3")?"avc":r.startsWith("hev1")||r.startsWith("hvc1")?"hevc":r==="vp8"?"vp8":r.startsWith("vp09")?"vp9":r.startsWith("av01")?"av1":r.startsWith("mp4a.40")||r==="mp4a.67"?"aac":r==="mp3"||r==="mp4a.69"||r==="mp4a.6B"||r==="mp4a.6b"?"mp3":r==="opus"?"opus":r==="vorbis"?"vorbis":r==="flac"?"flac":r==="ulaw"?"ulaw":r==="alaw"?"alaw":Fc.test(r)?r:r==="webvtt"?"webvtt":null,qu=r=>r==="avc"?{avc:{format:"avc"}}:r==="hevc"?{hevc:{format:"hevc"}}:{},Ku=r=>r==="aac"?{aac:{format:"aac"}}:r==="opus"?{opus:{format:"opus"}}:{},Gu=["avc1","avc3","hev1","hvc1","vp8","vp09","av01"],Qu=/^(avc1|avc3)\.[0-9a-fA-F]{6}$/,Xu=/^(hev1|hvc1)\.(?:[ABC]?\d+)\.[0-9a-fA-F]{1,8}\.[LH]\d+(?:\.[0-9a-fA-F]{1,2}){0,6}$/,Zu=/^vp09(?:\.\d{2}){3}(?:(?:\.\d{2}){5})?$/,Yu=/^av01\.\d\.\d{2}[MH]\.\d{2}(?:\.\d\.\d{3}\.\d{2}\.\d{2}\.\d{2}\.\d)?$/,zc=r=>{if(!r)throw new TypeError("Video chunk metadata must be provided.");if(typeof r!="object")throw new TypeError("Video chunk metadata must be an object.");if(!r.decoderConfig)throw new TypeError("Video chunk metadata must include a decoder configuration.");if(typeof r.decoderConfig!="object")throw new TypeError("Video chunk metadata decoder configuration must be an object.");if(typeof r.decoderConfig.codec!="string")throw new TypeError("Video chunk metadata decoder configuration must specify a codec string.");if(!Gu.some(e=>r.decoderConfig.codec.startsWith(e)))throw new TypeError("Video chunk metadata decoder configuration codec string must be a valid video codec string as specified in the WebCodecs Codec Registry.");if(!Number.isInteger(r.decoderConfig.codedWidth)||r.decoderConfig.codedWidth<=0)throw new TypeError("Video chunk metadata decoder configuration must specify a valid codedWidth (positive integer).");if(!Number.isInteger(r.decoderConfig.codedHeight)||r.decoderConfig.codedHeight<=0)throw new TypeError("Video chunk metadata decoder configuration must specify a valid codedHeight (positive integer).");if(r.decoderConfig.description!==void 0&&!ss(r.decoderConfig.description))throw new TypeError("Video chunk metadata decoder configuration description, when defined, must be an ArrayBuffer or an ArrayBuffer view.");if(r.decoderConfig.colorSpace!==void 0){const{colorSpace:e}=r.decoderConfig;if(typeof e!="object")throw new TypeError("Video chunk metadata decoder configuration colorSpace, when provided, must be an object.");const t=Object.keys(Ki);if(e.primaries!=null&&!t.includes(e.primaries))throw new TypeError(`Video chunk metadata decoder configuration colorSpace primaries, when defined, must be one of ${t.join(", ")}.`);const i=Object.keys(Gi);if(e.transfer!=null&&!i.includes(e.transfer))throw new TypeError(`Video chunk metadata decoder configuration colorSpace transfer, when defined, must be one of ${i.join(", ")}.`);const a=Object.keys(Qi);if(e.matrix!=null&&!a.includes(e.matrix))throw new TypeError(`Video chunk metadata decoder configuration colorSpace matrix, when defined, must be one of ${a.join(", ")}.`);if(e.fullRange!=null&&typeof e.fullRange!="boolean")throw new TypeError("Video chunk metadata decoder configuration colorSpace fullRange, when defined, must be a boolean.")}if(r.decoderConfig.codec.startsWith("avc1")||r.decoderConfig.codec.startsWith("avc3")){if(!Qu.test(r.decoderConfig.codec))throw new TypeError("Video chunk metadata decoder configuration codec string for AVC must be a valid AVC codec string as specified in Section 3.4 of RFC 6381.")}else if(r.decoderConfig.codec.startsWith("hev1")||r.decoderConfig.codec.startsWith("hvc1")){if(!Xu.test(r.decoderConfig.codec))throw new TypeError("Video chunk metadata decoder configuration codec string for HEVC must be a valid HEVC codec string as specified in Section E.3 of ISO 14496-15.")}else if(r.decoderConfig.codec.startsWith("vp8")){if(r.decoderConfig.codec!=="vp8")throw new TypeError('Video chunk metadata decoder configuration codec string for VP8 must be "vp8".')}else if(r.decoderConfig.codec.startsWith("vp09")){if(!Zu.test(r.decoderConfig.codec))throw new TypeError('Video chunk metadata decoder configuration codec string for VP9 must be a valid VP9 codec string as specified in Section "Codecs Parameter String" of https://www.webmproject.org/vp9/mp4/.')}else if(r.decoderConfig.codec.startsWith("av01")&&!Yu.test(r.decoderConfig.codec))throw new TypeError('Video chunk metadata decoder configuration codec string for AV1 must be a valid AV1 codec string as specified in Section "Codecs Parameter String" of https://aomediacodec.github.io/av1-isobmff/.')},Ju=["mp4a","mp3","opus","vorbis","flac","ulaw","alaw","pcm"],Mc=r=>{if(!r)throw new TypeError("Audio chunk metadata must be provided.");if(typeof r!="object")throw new TypeError("Audio chunk metadata must be an object.");if(!r.decoderConfig)throw new TypeError("Audio chunk metadata must include a decoder configuration.");if(typeof r.decoderConfig!="object")throw new TypeError("Audio chunk metadata decoder configuration must be an object.");if(typeof r.decoderConfig.codec!="string")throw new TypeError("Audio chunk metadata decoder configuration must specify a codec string.");if(!Ju.some(e=>r.decoderConfig.codec.startsWith(e)))throw new TypeError("Audio chunk metadata decoder configuration codec string must be a valid audio codec string as specified in the WebCodecs Codec Registry.");if(!Number.isInteger(r.decoderConfig.sampleRate)||r.decoderConfig.sampleRate<=0)throw new TypeError("Audio chunk metadata decoder configuration must specify a valid sampleRate (positive integer).");if(!Number.isInteger(r.decoderConfig.numberOfChannels)||r.decoderConfig.numberOfChannels<=0)throw new TypeError("Audio chunk metadata decoder configuration must specify a valid numberOfChannels (positive integer).");if(r.decoderConfig.description!==void 0&&!ss(r.decoderConfig.description))throw new TypeError("Audio chunk metadata decoder configuration description, when defined, must be an ArrayBuffer or an ArrayBuffer view.");if(r.decoderConfig.codec.startsWith("mp4a")&&r.decoderConfig.codec!=="mp4a.69"&&r.decoderConfig.codec!=="mp4a.6B"&&r.decoderConfig.codec!=="mp4a.6b"){if(!["mp4a.40.2","mp4a.40.02","mp4a.40.5","mp4a.40.05","mp4a.40.29","mp4a.67"].includes(r.decoderConfig.codec))throw new TypeError("Audio chunk metadata decoder configuration codec string for AAC must be a valid AAC codec string as specified in https://www.w3.org/TR/webcodecs-aac-codec-registration/.")}else if(r.decoderConfig.codec.startsWith("mp3")||r.decoderConfig.codec.startsWith("mp4a")){if(r.decoderConfig.codec!=="mp3"&&r.decoderConfig.codec!=="mp4a.69"&&r.decoderConfig.codec!=="mp4a.6B"&&r.decoderConfig.codec!=="mp4a.6b")throw new TypeError('Audio chunk metadata decoder configuration codec string for MP3 must be "mp3", "mp4a.69" or "mp4a.6B".')}else if(r.decoderConfig.codec.startsWith("opus")){if(r.decoderConfig.codec!=="opus")throw new TypeError('Audio chunk metadata decoder configuration codec string for Opus must be "opus".');if(r.decoderConfig.description&&r.decoderConfig.description.byteLength<18)throw new TypeError("Audio chunk metadata decoder configuration description, when specified, is expected to be an Identification Header as specified in Section 5.1 of RFC 7845.")}else if(r.decoderConfig.codec.startsWith("vorbis")){if(r.decoderConfig.codec!=="vorbis")throw new TypeError('Audio chunk metadata decoder configuration codec string for Vorbis must be "vorbis".');if(!r.decoderConfig.description)throw new TypeError("Audio chunk metadata decoder configuration for Vorbis must include a description, which is expected to adhere to the format described in https://www.w3.org/TR/webcodecs-vorbis-codec-registration/.")}else if(r.decoderConfig.codec.startsWith("flac")){if(r.decoderConfig.codec!=="flac")throw new TypeError('Audio chunk metadata decoder configuration codec string for FLAC must be "flac".');if(!r.decoderConfig.description||r.decoderConfig.description.byteLength<42)throw new TypeError("Audio chunk metadata decoder configuration for FLAC must include a description, which is expected to adhere to the format described in https://www.w3.org/TR/webcodecs-flac-codec-registration/.")}else if((r.decoderConfig.codec.startsWith("pcm")||r.decoderConfig.codec.startsWith("ulaw")||r.decoderConfig.codec.startsWith("alaw"))&&!Ot.includes(r.decoderConfig.codec))throw new TypeError(`Audio chunk metadata decoder configuration codec string for PCM must be one of the supported PCM codecs (${Ot.join(", ")}).`)},Rc=r=>{if(!r)throw new TypeError("Subtitle metadata must be provided.");if(typeof r!="object")throw new TypeError("Subtitle metadata must be an object.");if(!r.config)throw new TypeError("Subtitle metadata must include a config object.");if(typeof r.config!="object")throw new TypeError("Subtitle metadata config must be an object.");if(typeof r.config.description!="string")throw new TypeError("Subtitle metadata config description must be a string.")};class Dc{constructor(e){this.mutex=new fi,this.firstMediaStreamTimestamp=null,this.trackTimestampInfo=new WeakMap,this.output=e}onTrackClose(e){}validateAndNormalizeTimestamp(e,t,i){t+=e.source._timestampOffset;let a=this.trackTimestampInfo.get(e);if(!a){if(!i)throw new Error("First packet must be a key packet.");a={maxTimestamp:t,maxTimestampBeforeLastKeyPacket:t},this.trackTimestampInfo.set(e,a)}if(t<0)throw new Error(`Timestamps must be non-negative (got ${t}s).`);if(i&&(a.maxTimestampBeforeLastKeyPacket=a.maxTimestamp),t<a.maxTimestampBeforeLastKeyPacket)throw new Error(`Timestamps cannot be smaller than the largest timestamp of the previous GOP (a GOP begins with a key packet and ends right before the next key packet). Got ${t}s, but largest timestamp is ${a.maxTimestampBeforeLastKeyPacket}s.`);return a.maxTimestamp=Math.max(a.maxTimestamp,t),t}}var xr;(function(r){r[r.NON_IDR_SLICE=1]="NON_IDR_SLICE",r[r.SLICE_DPA=2]="SLICE_DPA",r[r.SLICE_DPB=3]="SLICE_DPB",r[r.SLICE_DPC=4]="SLICE_DPC",r[r.IDR=5]="IDR",r[r.SEI=6]="SEI",r[r.SPS=7]="SPS",r[r.PPS=8]="PPS",r[r.AUD=9]="AUD",r[r.SPS_EXT=13]="SPS_EXT"})(xr||(xr={}));var Vt;(function(r){r[r.RASL_N=8]="RASL_N",r[r.RASL_R=9]="RASL_R",r[r.BLA_W_LP=16]="BLA_W_LP",r[r.RSV_IRAP_VCL23=23]="RSV_IRAP_VCL23",r[r.VPS_NUT=32]="VPS_NUT",r[r.SPS_NUT=33]="SPS_NUT",r[r.PPS_NUT=34]="PPS_NUT",r[r.AUD_NUT=35]="AUD_NUT",r[r.PREFIX_SEI_NUT=39]="PREFIX_SEI_NUT",r[r.SUFFIX_SEI_NUT=40]="SUFFIX_SEI_NUT"})(Vt||(Vt={}));const Sa=function*(r){let e=0,t=-1;for(;e<r.length-2;){const i=r.indexOf(0,e);if(i===-1||i>=r.length-2)break;e=i;let a=0;if(e+3<r.length&&r[e+1]===0&&r[e+2]===0&&r[e+3]===1?a=4:r[e+1]===0&&r[e+2]===1&&(a=3),a===0){e++;continue}t!==-1&&e>t&&(yield{offset:t,length:e-t}),t=e+a,e=t}t!==-1&&t<r.length&&(yield{offset:t,length:r.length-t})},Oc=function*(r,e){let t=0;const i=new DataView(r.buffer,r.byteOffset,r.byteLength);for(;t+e<=r.length;){let a;e===1?a=i.getUint8(t):e===2?a=i.getUint16(t,!1):e===3?a=ns(i,t,!1):(E(e===4),a=i.getUint32(t,!1)),t+=e,yield{offset:t,length:a},t+=a}},Nc=(r,e)=>{if(e.description){const a=(Lt(e.description)[4]&3)+1;return Oc(r,a)}else return Sa(r)},ef=function*(r){yield*Sa(r)},cs=r=>r&31,ls=r=>{const e=[],t=r.length;for(let i=0;i<t;i++)i+2<t&&r[i]===0&&r[i+1]===0&&r[i+2]===3?(e.push(0,0),i+=2):e.push(r[i]);return new Uint8Array(e)},ks=new Uint8Array([0,0,0,1]),tf=r=>{const e=r.reduce((a,n)=>a+ks.byteLength+n.byteLength,0),t=new Uint8Array(e);let i=0;for(const a of r)t.set(ks,i),i+=ks.byteLength,t.set(a,i),i+=a.byteLength;return t},Uc=(r,e)=>{const t=r.reduce((n,s)=>n+e+s.byteLength,0),i=new Uint8Array(t);let a=0;for(const n of r){const s=new DataView(i.buffer,i.byteOffset,i.byteLength);switch(e){case 1:s.setUint8(a,n.byteLength);break;case 2:s.setUint16(a,n.byteLength,!1);break;case 3:Tn(s,a,n.byteLength,!1);break;case 4:s.setUint32(a,n.byteLength,!1);break}a+=e,i.set(n,a),a+=n.byteLength}return i},rf=(r,e)=>{if(e.description){const a=(Lt(e.description)[4]&3)+1;return Uc(r,a)}else return tf(r)},Fn=r=>{try{const e=[],t=[],i=[];for(const o of ef(r)){const c=r.subarray(o.offset,o.offset+o.length),l=cs(c[0]);l===xr.SPS?e.push(c):l===xr.PPS?t.push(c):l===xr.SPS_EXT&&i.push(c)}if(e.length===0||t.length===0)return null;const a=e[0],n=Bn(a);E(n!==null);const s=n.profileIdc===100||n.profileIdc===110||n.profileIdc===122||n.profileIdc===144;return{configurationVersion:1,avcProfileIndication:n.profileIdc,profileCompatibility:n.constraintFlags,avcLevelIndication:n.levelIdc,lengthSizeMinusOne:3,sequenceParameterSets:e,pictureParameterSets:t,chromaFormat:s?n.chromaFormatIdc:null,bitDepthLumaMinus8:s?n.bitDepthLumaMinus8:null,bitDepthChromaMinus8:s?n.bitDepthChromaMinus8:null,sequenceParameterSetExt:s?i:null}}catch(e){return console.error("Error building AVC Decoder Configuration Record:",e),null}},af=r=>{const e=[];e.push(r.configurationVersion),e.push(r.avcProfileIndication),e.push(r.profileCompatibility),e.push(r.avcLevelIndication),e.push(252|r.lengthSizeMinusOne&3),e.push(224|r.sequenceParameterSets.length&31);for(const t of r.sequenceParameterSets){const i=t.byteLength;e.push(i>>8),e.push(i&255);for(let a=0;a<i;a++)e.push(t[a])}e.push(r.pictureParameterSets.length);for(const t of r.pictureParameterSets){const i=t.byteLength;e.push(i>>8),e.push(i&255);for(let a=0;a<i;a++)e.push(t[a])}if(r.avcProfileIndication===100||r.avcProfileIndication===110||r.avcProfileIndication===122||r.avcProfileIndication===144){E(r.chromaFormat!==null),E(r.bitDepthLumaMinus8!==null),E(r.bitDepthChromaMinus8!==null),E(r.sequenceParameterSetExt!==null),e.push(252|r.chromaFormat&3),e.push(248|r.bitDepthLumaMinus8&7),e.push(248|r.bitDepthChromaMinus8&7),e.push(r.sequenceParameterSetExt.length);for(const t of r.sequenceParameterSetExt){const i=t.byteLength;e.push(i>>8),e.push(i&255);for(let a=0;a<i;a++)e.push(t[a])}}return new Uint8Array(e)},sf=r=>{try{const e=kt(r);let t=0;const i=e.getUint8(t++),a=e.getUint8(t++),n=e.getUint8(t++),s=e.getUint8(t++),o=e.getUint8(t++)&3,c=e.getUint8(t++)&31,l=[];for(let h=0;h<c;h++){const g=e.getUint16(t,!1);t+=2,l.push(r.subarray(t,t+g)),t+=g}const d=e.getUint8(t++),u=[];for(let h=0;h<d;h++){const g=e.getUint16(t,!1);t+=2,u.push(r.subarray(t,t+g)),t+=g}const f={configurationVersion:i,avcProfileIndication:a,profileCompatibility:n,avcLevelIndication:s,lengthSizeMinusOne:o,sequenceParameterSets:l,pictureParameterSets:u,chromaFormat:null,bitDepthLumaMinus8:null,bitDepthChromaMinus8:null,sequenceParameterSetExt:null};if((a===100||a===110||a===122||a===144)&&t+4<=r.length){const h=e.getUint8(t++)&3,g=e.getUint8(t++)&7,m=e.getUint8(t++)&7,p=e.getUint8(t++);f.chromaFormat=h,f.bitDepthLumaMinus8=g,f.bitDepthChromaMinus8=m;const v=[];for(let b=0;b<p;b++){const w=e.getUint16(t,!1);t+=2,v.push(r.subarray(t,t+w)),t+=w}f.sequenceParameterSetExt=v}return f}catch(e){return console.error("Error deserializing AVC Decoder Configuration Record:",e),null}},Bn=r=>{try{const e=new ft(ls(r));if(e.skipBits(1),e.skipBits(2),e.readBits(5)!==7)return null;const i=e.readAlignedByte(),a=e.readAlignedByte(),n=e.readAlignedByte();ue(e);let s=1,o=0,c=0,l=0;if((i===100||i===110||i===122||i===244||i===44||i===83||i===86||i===118||i===128)&&(s=ue(e),s===3&&(l=e.readBits(1)),o=ue(e),c=ue(e),e.skipBits(1),e.readBits(1))){for(let G=0;G<(s!==3?8:12);G++)if(e.readBits(1)){const N=G<6?16:64;let y=8,q=8;for(let ne=0;ne<N;ne++){if(q!==0){const Y=Or(e);q=(y+Y+256)%256}y=q===0?y:q}}}ue(e);const d=ue(e);if(d===0)ue(e);else if(d===1){e.skipBits(1),Or(e),Or(e);const W=ue(e);for(let G=0;G<W;G++)Or(e)}ue(e),e.skipBits(1);const u=ue(e),f=ue(e),h=16*(u+1),g=16*(f+1);let m=h,p=g;const v=e.readBits(1);if(v||e.skipBits(1),e.skipBits(1),e.readBits(1)){const W=ue(e),G=ue(e),C=ue(e),N=ue(e);let y,q;if((l===0?s:0)===0)y=1,q=2-v;else{const Y=s===3?1:2,fe=s===1?2:1;y=Y,q=fe*(2-v)}m-=y*(W+G),p-=q*(C+N)}let w=2,x=2,T=2,A=0,B=null,z=null;if(e.readBits(1)){e.readBits(1)&&e.readBits(8)===255&&(e.skipBits(16),e.skipBits(16)),e.readBits(1)&&e.skipBits(1),e.readBits(1)&&(e.skipBits(3),A=e.readBits(1),e.readBits(1)&&(w=e.readBits(8),x=e.readBits(8),T=e.readBits(8))),e.readBits(1)&&(ue(e),ue(e)),e.readBits(1)&&(e.skipBits(32),e.skipBits(32),e.skipBits(1));const q=e.readBits(1);q&&Io(e);const ne=e.readBits(1);ne&&Io(e),(q||ne)&&e.skipBits(1),e.skipBits(1),e.readBits(1)&&(e.skipBits(1),ue(e),ue(e),ue(e),ue(e),B=ue(e),z=ue(e))}if(B===null){E(z===null);const W=a&16;if((i===44||i===86||i===100||i===110||i===122||i===244)&&W)B=0,z=0;else{const G=u+1,C=f+1,N=(2-v)*C,y=Xa.find(ne=>ne.level>=n)??wt(Xa),q=Math.min(Math.floor(y.maxDpbMbs/(G*N)),16);B=q,z=q}}return E(z!==null),{profileIdc:i,constraintFlags:a,levelIdc:n,frameMbsOnlyFlag:v,chromaFormatIdc:s,bitDepthLumaMinus8:o,bitDepthChromaMinus8:c,codedWidth:h,codedHeight:g,displayWidth:m,displayHeight:p,colourPrimaries:w,matrixCoefficients:T,transferCharacteristics:x,fullRangeFlag:A,numReorderFrames:B,maxDecFrameBuffering:z}}catch(e){return console.error("Error parsing AVC SPS:",e),null}},Io=r=>{const e=ue(r);r.skipBits(4),r.skipBits(4);for(let t=0;t<=e;t++)ue(r),ue(r),r.skipBits(1);r.skipBits(5),r.skipBits(5),r.skipBits(5),r.skipBits(5)},Vc=(r,e)=>{if(e.description){const a=(Lt(e.description)[21]&3)+1;return Oc(r,a)}else return Sa(r)},nf=function*(r){yield*Sa(r)},va=r=>r>>1&63,Lc=r=>{try{const e=new ft(ls(r));e.skipBits(16),e.readBits(4);const t=e.readBits(3),i=e.readBits(1),{general_profile_space:a,general_tier_flag:n,general_profile_idc:s,general_profile_compatibility_flags:o,general_constraint_indicator_flags:c,general_level_idc:l}=of(e,t);ue(e);const d=ue(e);let u=0;d===3&&(u=e.readBits(1));const f=ue(e),h=ue(e);let g=f,m=h;if(e.readBits(1)){const G=ue(e),C=ue(e),N=ue(e),y=ue(e);let q=1,ne=1;const Y=u===0?d:0;Y===1?(q=2,ne=2):Y===2&&(q=2,ne=1),g-=(G+C)*q,m-=(N+y)*ne}const p=ue(e),v=ue(e);ue(e);const w=e.readBits(1)?0:t;let x=0;for(let G=w;G<=t;G++)ue(e),x=ue(e),ue(e);ue(e),ue(e),ue(e),ue(e),ue(e),ue(e),e.readBits(1)&&e.readBits(1)&&cf(e),e.skipBits(1),e.skipBits(1),e.readBits(1)&&(e.skipBits(4),e.skipBits(4),ue(e),ue(e),e.skipBits(1));const T=ue(e);if(lf(e,T),e.readBits(1)){const G=ue(e);for(let C=0;C<G;C++)ue(e),e.skipBits(1)}e.skipBits(1),e.skipBits(1);let A=2,B=2,z=2,M=0,W=0;if(e.readBits(1)){const G=uf(e,t);A=G.colourPrimaries,B=G.transferCharacteristics,z=G.matrixCoefficients,M=G.fullRangeFlag,W=G.minSpatialSegmentationIdc}return{displayWidth:g,displayHeight:m,colourPrimaries:A,transferCharacteristics:B,matrixCoefficients:z,fullRangeFlag:M,maxDecFrameBuffering:x+1,spsMaxSubLayersMinus1:t,spsTemporalIdNestingFlag:i,generalProfileSpace:a,generalTierFlag:n,generalProfileIdc:s,generalProfileCompatibilityFlags:o,generalConstraintIndicatorFlags:c,generalLevelIdc:l,chromaFormatIdc:d,bitDepthLumaMinus8:p,bitDepthChromaMinus8:v,minSpatialSegmentationIdc:W}}catch(e){return console.error("Error parsing HEVC SPS:",e),null}},zn=r=>{try{const e=[],t=[],i=[],a=[];for(const l of nf(r)){const d=r.subarray(l.offset,l.offset+l.length),u=va(d[0]);u===Vt.VPS_NUT?e.push(d):u===Vt.SPS_NUT?t.push(d):u===Vt.PPS_NUT?i.push(d):(u===Vt.PREFIX_SEI_NUT||u===Vt.SUFFIX_SEI_NUT)&&a.push(d)}if(t.length===0||i.length===0)return null;const n=Lc(t[0]);if(!n)return null;let s=0;if(i.length>0){const l=i[0],d=new ft(ls(l));d.skipBits(16),ue(d),ue(d),d.skipBits(1),d.skipBits(1),d.skipBits(3),d.skipBits(1),d.skipBits(1),ue(d),ue(d),Or(d),d.skipBits(1),d.skipBits(1),d.readBits(1)&&ue(d),Or(d),Or(d),d.skipBits(1),d.skipBits(1),d.skipBits(1),d.skipBits(1);const u=d.readBits(1),f=d.readBits(1);!u&&!f?s=0:u&&!f?s=2:!u&&f?s=3:s=0}const o=[...e.length?[{arrayCompleteness:1,nalUnitType:Vt.VPS_NUT,nalUnits:e}]:[],...t.length?[{arrayCompleteness:1,nalUnitType:Vt.SPS_NUT,nalUnits:t}]:[],...i.length?[{arrayCompleteness:1,nalUnitType:Vt.PPS_NUT,nalUnits:i}]:[],...a.length?[{arrayCompleteness:1,nalUnitType:va(a[0][0]),nalUnits:a}]:[]];return{configurationVersion:1,generalProfileSpace:n.generalProfileSpace,generalTierFlag:n.generalTierFlag,generalProfileIdc:n.generalProfileIdc,generalProfileCompatibilityFlags:n.generalProfileCompatibilityFlags,generalConstraintIndicatorFlags:n.generalConstraintIndicatorFlags,generalLevelIdc:n.generalLevelIdc,minSpatialSegmentationIdc:n.minSpatialSegmentationIdc,parallelismType:s,chromaFormatIdc:n.chromaFormatIdc,bitDepthLumaMinus8:n.bitDepthLumaMinus8,bitDepthChromaMinus8:n.bitDepthChromaMinus8,avgFrameRate:0,constantFrameRate:0,numTemporalLayers:n.spsMaxSubLayersMinus1+1,temporalIdNested:n.spsTemporalIdNestingFlag,lengthSizeMinusOne:3,arrays:o}}catch(e){return console.error("Error building HEVC Decoder Configuration Record:",e),null}},of=(r,e)=>{const t=r.readBits(2),i=r.readBits(1),a=r.readBits(5);let n=0;for(let d=0;d<32;d++)n=n<<1|r.readBits(1);const s=new Uint8Array(6);for(let d=0;d<6;d++)s[d]=r.readBits(8);const o=r.readBits(8),c=[],l=[];for(let d=0;d<e;d++)c.push(r.readBits(1)),l.push(r.readBits(1));if(e>0)for(let d=e;d<8;d++)r.skipBits(2);for(let d=0;d<e;d++)c[d]&&r.skipBits(88),l[d]&&r.skipBits(8);return{general_profile_space:t,general_tier_flag:i,general_profile_idc:a,general_profile_compatibility_flags:n,general_constraint_indicator_flags:s,general_level_idc:o}},cf=r=>{for(let e=0;e<4;e++)for(let t=0;t<(e===3?2:6);t++)if(!r.readBits(1))ue(r);else{const a=Math.min(64,1<<4+(e<<1));e>1&&Or(r);for(let n=0;n<a;n++)Or(r)}},lf=(r,e)=>{const t=[];for(let i=0;i<e;i++)t[i]=df(r,i,e,t)},df=(r,e,t,i)=>{let a=0,n=0,s=0;if(e!==0&&(n=r.readBits(1)),n){if(e===t){const c=ue(r);s=e-(c+1)}else s=e-1;r.readBits(1),ue(r);const o=i[s]??0;for(let c=0;c<=o;c++)r.readBits(1)||r.readBits(1);a=i[s]}else{const o=ue(r),c=ue(r);for(let l=0;l<o;l++)ue(r),r.readBits(1);for(let l=0;l<c;l++)ue(r),r.readBits(1);a=o+c}return a},uf=(r,e)=>{let t=2,i=2,a=2,n=0,s=0;return r.readBits(1)&&r.readBits(8)===255&&(r.readBits(16),r.readBits(16)),r.readBits(1)&&r.readBits(1),r.readBits(1)&&(r.readBits(3),n=r.readBits(1),r.readBits(1)&&(t=r.readBits(8),i=r.readBits(8),a=r.readBits(8))),r.readBits(1)&&(ue(r),ue(r)),r.readBits(1),r.readBits(1),r.readBits(1),r.readBits(1)&&(ue(r),ue(r),ue(r),ue(r)),r.readBits(1)&&(r.readBits(32),r.readBits(32),r.readBits(1)&&ue(r),r.readBits(1)&&ff(r,!0,e)),r.readBits(1)&&(r.readBits(1),r.readBits(1),r.readBits(1),s=ue(r),ue(r),ue(r),ue(r),ue(r)),{colourPrimaries:t,transferCharacteristics:i,matrixCoefficients:a,fullRangeFlag:n,minSpatialSegmentationIdc:s}},ff=(r,e,t)=>{let i=!1,a=!1,n=!1;i=r.readBits(1)===1,a=r.readBits(1)===1,(i||a)&&(n=r.readBits(1)===1,n&&(r.readBits(8),r.readBits(5),r.readBits(1),r.readBits(5)),r.readBits(4),r.readBits(4),n&&r.readBits(4),r.readBits(5),r.readBits(5),r.readBits(5));for(let s=0;s<=t;s++){const o=r.readBits(1)===1;let c=!0;o||(c=r.readBits(1)===1);let l=!1;c?ue(r):l=r.readBits(1)===1;let d=1;l||(d=ue(r)+1),i&&Ao(r,d,n),a&&Ao(r,d,n)}},Ao=(r,e,t)=>{for(let i=0;i<e;i++)ue(r),ue(r),t&&(ue(r),ue(r)),r.readBits(1)},hf=r=>{const e=[];e.push(r.configurationVersion),e.push((r.generalProfileSpace&3)<<6|(r.generalTierFlag&1)<<5|r.generalProfileIdc&31),e.push(r.generalProfileCompatibilityFlags>>>24&255),e.push(r.generalProfileCompatibilityFlags>>>16&255),e.push(r.generalProfileCompatibilityFlags>>>8&255),e.push(r.generalProfileCompatibilityFlags&255),e.push(...r.generalConstraintIndicatorFlags),e.push(r.generalLevelIdc&255),e.push(240|r.minSpatialSegmentationIdc>>8&15),e.push(r.minSpatialSegmentationIdc&255),e.push(252|r.parallelismType&3),e.push(252|r.chromaFormatIdc&3),e.push(248|r.bitDepthLumaMinus8&7),e.push(248|r.bitDepthChromaMinus8&7),e.push(r.avgFrameRate>>8&255),e.push(r.avgFrameRate&255),e.push((r.constantFrameRate&3)<<6|(r.numTemporalLayers&7)<<3|(r.temporalIdNested&1)<<2|r.lengthSizeMinusOne&3),e.push(r.arrays.length&255);for(const t of r.arrays){e.push((t.arrayCompleteness&1)<<7|0|t.nalUnitType&63),e.push(t.nalUnits.length>>8&255),e.push(t.nalUnits.length&255);for(const i of t.nalUnits){e.push(i.length>>8&255),e.push(i.length&255);for(let a=0;a<i.length;a++)e.push(i[a])}}return new Uint8Array(e)},$c=r=>{const e=new ft(r);if(e.readBits(2)!==2)return null;const i=e.readBits(1),n=(e.readBits(1)<<1)+i;if(n===3&&e.skipBits(1),e.readBits(1)===1||e.readBits(1)!==0||(e.skipBits(2),e.readBits(24)!==4817730))return null;let l=8;n>=2&&(l=e.readBits(1)?12:10);const d=e.readBits(3);let u=0,f=0;if(d!==7)if(f=e.readBits(1),n===1||n===3){const B=e.readBits(1),z=e.readBits(1);u=!B&&!z?3:B&&!z?2:1,e.skipBits(1)}else u=1;else u=3,f=1;const h=e.readBits(16),g=e.readBits(16),m=h+1,p=g+1,v=m*p;let b=wt(Gr).level;for(const A of Gr)if(v<=A.maxPictureSize){b=A.level;break}return{profile:n,level:b,bitDepth:l,chromaSubsampling:u,videoFullRangeFlag:f,colourPrimaries:d===2?1:d===1?6:2,transferCharacteristics:d===2?1:d===1?6:2,matrixCoefficients:d===7?0:d===2?1:d===1?6:2}},Wc=function*(r){const e=new ft(r),t=()=>{let i=0;for(let a=0;a<8;a++){const n=e.readAlignedByte();if(i|=(n&127)<<a*7,!(n&128))break;if(a===7&&n&128)return null}return i>=2**32-1?null:i};for(;e.getBitsLeft()>=8;){e.skipBits(1);const i=e.readBits(4),a=e.readBits(1),n=e.readBits(1);e.skipBits(1),a&&e.skipBits(8);let s;if(n){const o=t();if(o===null)return;s=o}else s=Math.floor(e.getBitsLeft()/8);E(e.pos%8===0),yield{type:i,data:r.subarray(e.pos/8,e.pos/8+s)},e.skipBits(s*8)}},Hc=r=>{for(const{type:e,data:t}of Wc(r)){if(e!==1)continue;const i=new ft(t),a=i.readBits(3);i.readBits(1);const n=i.readBits(1);let s=0,o=0,c=0;if(n)s=i.readBits(5);else{if(i.readBits(1)&&(i.skipBits(32),i.skipBits(32),i.readBits(1)))return null;const T=i.readBits(1);T&&(c=i.readBits(5),i.skipBits(32),i.skipBits(5),i.skipBits(5));const A=i.readBits(5);for(let B=0;B<=A;B++){i.skipBits(12);const z=i.readBits(5);if(B===0&&(s=z),z>7){const W=i.readBits(1);B===0&&(o=W)}if(T&&i.readBits(1)){const G=c+1;i.skipBits(G),i.skipBits(G),i.skipBits(1)}i.readBits(1)&&i.skipBits(4)}}const l=i.readBits(4),d=i.readBits(4),u=l+1;i.skipBits(u);const f=d+1;i.skipBits(f);let h=0;if(n?h=0:h=i.readBits(1),h&&(i.skipBits(4),i.skipBits(3)),i.skipBits(1),i.skipBits(1),i.skipBits(1),!n){i.skipBits(1),i.skipBits(1),i.skipBits(1),i.skipBits(1);const x=i.readBits(1);x&&(i.skipBits(1),i.skipBits(1));const T=i.readBits(1);let A=0;T?A=2:A=i.readBits(1),A>0&&(i.readBits(1)||i.skipBits(1)),x&&i.skipBits(3)}i.skipBits(1),i.skipBits(1),i.skipBits(1);const g=i.readBits(1);let m=8;a===2&&g?m=i.readBits(1)?12:10:a<=2&&(m=g?10:8);let p=0;a!==1&&(p=i.readBits(1));let v=1,b=1,w=0;return p||(a===0?(v=1,b=1):a===1?(v=0,b=0):m===12&&(v=i.readBits(1),v&&(b=i.readBits(1))),v&&b&&(w=i.readBits(2))),{profile:a,level:s,tier:o,bitDepth:m,monochrome:p,chromaSubsamplingX:v,chromaSubsamplingY:b,chromaSamplePosition:w}}return null},Mn=r=>{const e=kt(r),t=e.getUint8(9),i=e.getUint16(10,!0),a=e.getUint32(12,!0),n=e.getInt16(16,!0),s=e.getUint8(18);let o=null;return s&&(o=r.subarray(19,21+t)),{outputChannelCount:t,preSkip:i,inputSampleRate:a,outputGain:n,channelMappingFamily:s,channelMappingTable:o}},mf=[480,960,1920,2880,480,960,1920,2880,480,960,1920,2880,480,960,480,960,120,240,480,960,120,240,480,960,120,240,480,960,120,240,480,960],pf=r=>{const e=r[0]>>3;return{durationInSamples:mf[e]}},gf=r=>{if(r.length<7)throw new Error("Setup header is too short.");if(r[0]!==5)throw new Error("Wrong packet type in Setup header.");if(String.fromCharCode(...r.slice(1,7))!=="vorbis")throw new Error("Invalid packet signature in Setup header.");const t=r.length,i=new Uint8Array(t);for(let u=0;u<t;u++)i[u]=r[t-1-u];const a=new ft(i);let n=0;for(;a.getBitsLeft()>97;)if(a.readBits(1)===1){n=a.pos;break}if(n===0)throw new Error("Invalid Setup header: framing bit not found.");let s=0,o=!1,c=0;for(;a.getBitsLeft()>=97;){const u=a.pos,f=a.readBits(8),h=a.readBits(16),g=a.readBits(16);if(f>63||h!==0||g!==0){a.pos=u;break}if(a.skipBits(1),s++,s>64)break;a.clone().readBits(6)+1===s&&(o=!0,c=s)}if(!o)throw new Error("Invalid Setup header: mode header not found.");if(c>63)throw new Error(`Unsupported mode count: ${c}.`);const l=c;a.pos=0,a.skipBits(n);const d=Array(l).fill(0);for(let u=l-1;u>=0;u--)a.skipBits(40),d[u]=a.readBits(1);return{modeBlockflags:d}},Rn=(r,e,t)=>{switch(r){case"avc":{for(const i of Nc(t,e)){const a=t[i.offset],n=cs(a);if(n>=xr.NON_IDR_SLICE&&n<=xr.SLICE_DPC)return"delta";if(n===xr.IDR)return"key";if(n===xr.SEI&&(!Ks()||Nu()>=144)){const s=t.subarray(i.offset,i.offset+i.length),o=ls(s);let c=1;do{let l=0;for(;;){const f=o[c++];if(f===void 0||(l+=f,f<255))break}let d=0;for(;;){const f=o[c++];if(f===void 0||(d+=f,f<255))break}if(l===6){const f=new ft(o);f.pos=8*c;const h=ue(f),g=f.readBits(1);if(h===0&&g===1)return"key"}c+=d}while(c<o.length-1)}}return"delta"}case"hevc":{for(const i of Vc(t,e)){const a=va(t[i.offset]);if(a<Vt.BLA_W_LP)return"delta";if(a<=Vt.RSV_IRAP_VCL23)return"key"}return"delta"}case"vp8":return(t[0]&1)===0?"key":"delta";case"vp9":{const i=new ft(t);if(i.readBits(2)!==2)return null;const a=i.readBits(1);return(i.readBits(1)<<1)+a===3&&i.skipBits(1),i.readBits(1)?null:i.readBits(1)===0?"key":"delta"}case"av1":{let i=!1;for(const{type:a,data:n}of Wc(t))if(a===1){const s=new ft(n);s.skipBits(4),i=!!s.readBits(1)}else if(a===3||a===6||a===7){if(i)return"key";const s=new ft(n);return s.readBits(1)?null:s.readBits(2)===0?"key":"delta"}return null}default:Tr(r),E(!1)}};var Ni;(function(r){r[r.STREAMINFO=0]="STREAMINFO",r[r.VORBIS_COMMENT=4]="VORBIS_COMMENT",r[r.PICTURE=6]="PICTURE"})(Ni||(Ni={}));const Qs=(r,e)=>{const t=kt(r);let i=0;const a=t.getUint32(i,!0);i+=4;const n=lr.decode(r.subarray(i,i+a));i+=a,a>0&&(e.raw??={},e.raw.vendor??=n);const s=t.getUint32(i,!0);i+=4;for(let o=0;o<s;o++){const c=t.getUint32(i,!0);i+=4;const l=lr.decode(r.subarray(i,i+c));i+=c;const d=l.indexOf("=");if(d===-1)continue;const u=l.slice(0,d).toUpperCase(),f=l.slice(d+1);switch(e.raw??={},e.raw[u]??=f,u){case"TITLE":e.title??=f;break;case"DESCRIPTION":e.description??=f;break;case"ARTIST":e.artist??=f;break;case"ALBUM":e.album??=f;break;case"ALBUMARTIST":e.albumArtist??=f;break;case"COMMENT":e.comment??=f;break;case"LYRICS":e.lyrics??=f;break;case"TRACKNUMBER":{const h=f.split("/"),g=Number.parseInt(h[0],10),m=h[1]&&Number.parseInt(h[1],10);Number.isInteger(g)&&g>0&&(e.trackNumber??=g),m&&Number.isInteger(m)&&m>0&&(e.tracksTotal??=m)}break;case"TRACKTOTAL":{const h=Number.parseInt(f,10);Number.isInteger(h)&&h>0&&(e.tracksTotal??=h)}break;case"DISCNUMBER":{const h=f.split("/"),g=Number.parseInt(h[0],10),m=h[1]&&Number.parseInt(h[1],10);Number.isInteger(g)&&g>0&&(e.discNumber??=g),m&&Number.isInteger(m)&&m>0&&(e.discsTotal??=m)}break;case"DISCTOTAL":{const h=Number.parseInt(f,10);Number.isInteger(h)&&h>0&&(e.discsTotal??=h)}break;case"DATE":{const h=new Date(f);Number.isNaN(h.getTime())||(e.date??=h)}break;case"GENRE":e.genre??=f;break;case"METADATA_BLOCK_PICTURE":{const h=Vu(f),g=kt(h),m=g.getUint32(0,!1),p=g.getUint32(4,!1),v=String.fromCharCode(...h.subarray(8,8+p)),b=g.getUint32(8+p,!1),w=lr.decode(h.subarray(12+p,12+p+b)),x=g.getUint32(p+b+28),T=h.subarray(p+b+32,p+b+32+x);e.images??=[],e.images.push({data:T,mimeType:v,kind:m===3?"coverFront":m===4?"coverBack":"unknown",name:void 0,description:w||void 0})}break}}};class ei{constructor(e){this.input=e}}const jc=[],qc=[],Xs=[],Zs=[];const rr=new Uint8Array(0);class ht{constructor(e,t,i,a,n=-1,s,o){if(this.data=e,this.type=t,this.timestamp=i,this.duration=a,this.sequenceNumber=n,e===rr&&s===void 0)throw new Error("Internal error: byteLength must be explicitly provided when constructing metadata-only packets.");if(s===void 0&&(s=e.byteLength),!(e instanceof Uint8Array))throw new TypeError("data must be a Uint8Array.");if(t!=="key"&&t!=="delta")throw new TypeError('type must be either "key" or "delta".');if(!Number.isFinite(i))throw new TypeError("timestamp must be a number.");if(!Number.isFinite(a)||a<0)throw new TypeError("duration must be a non-negative number.");if(!Number.isFinite(n))throw new TypeError("sequenceNumber must be a number.");if(!Number.isInteger(s)||s<0)throw new TypeError("byteLength must be a non-negative integer.");if(o!==void 0&&(typeof o!="object"||!o))throw new TypeError("sideData, when provided, must be an object.");if(o?.alpha!==void 0&&!(o.alpha instanceof Uint8Array))throw new TypeError("sideData.alpha, when provided, must be a Uint8Array.");if(o?.alphaByteLength!==void 0&&(!Number.isInteger(o.alphaByteLength)||o.alphaByteLength<0))throw new TypeError("sideData.alphaByteLength, when provided, must be a non-negative integer.");this.byteLength=s,this.sideData=o??{},this.sideData.alpha&&this.sideData.alphaByteLength===void 0&&(this.sideData.alphaByteLength=this.sideData.alpha.byteLength)}get isMetadataOnly(){return this.data===rr}get microsecondTimestamp(){return Math.trunc(Kr*this.timestamp)}get microsecondDuration(){return Math.trunc(Kr*this.duration)}toEncodedVideoChunk(){if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to a video chunk.");if(typeof EncodedVideoChunk>"u")throw new Error("Your browser does not support EncodedVideoChunk.");return new EncodedVideoChunk({data:this.data,type:this.type,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}alphaToEncodedVideoChunk(e=this.type){if(!this.sideData.alpha)throw new TypeError("This packet does not contain alpha side data.");if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to a video chunk.");if(typeof EncodedVideoChunk>"u")throw new Error("Your browser does not support EncodedVideoChunk.");return new EncodedVideoChunk({data:this.sideData.alpha,type:e,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}toEncodedAudioChunk(){if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to an audio chunk.");if(typeof EncodedAudioChunk>"u")throw new Error("Your browser does not support EncodedAudioChunk.");return new EncodedAudioChunk({data:this.data,type:this.type,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}static fromEncodedChunk(e,t){if(!(e instanceof EncodedVideoChunk||e instanceof EncodedAudioChunk))throw new TypeError("chunk must be an EncodedVideoChunk or EncodedAudioChunk.");const i=new Uint8Array(e.byteLength);return e.copyTo(i),new ht(i,e.type,e.timestamp/1e6,(e.duration??0)/1e6,void 0,void 0,t)}clone(e){if(e!==void 0&&(typeof e!="object"||e===null))throw new TypeError("options, when provided, must be an object.");if(e?.data!==void 0&&!(e.data instanceof Uint8Array))throw new TypeError("options.data, when provided, must be a Uint8Array.");if(e?.type!==void 0&&e.type!=="key"&&e.type!=="delta")throw new TypeError('options.type, when provided, must be either "key" or "delta".');if(e?.timestamp!==void 0&&!Number.isFinite(e.timestamp))throw new TypeError("options.timestamp, when provided, must be a number.");if(e?.duration!==void 0&&!Number.isFinite(e.duration))throw new TypeError("options.duration, when provided, must be a number.");if(e?.sequenceNumber!==void 0&&!Number.isFinite(e.sequenceNumber))throw new TypeError("options.sequenceNumber, when provided, must be a number.");if(e?.sideData!==void 0&&(typeof e.sideData!="object"||e.sideData===null))throw new TypeError("options.sideData, when provided, must be an object.");return new ht(e?.data??this.data,e?.type??this.type,e?.timestamp??this.timestamp,e?.duration??this.duration,e?.sequenceNumber??this.sequenceNumber,this.byteLength,e?.sideData??this.sideData)}}const vf=r=>{let i=r,a=4096,n=0,s=12,o=0;for(i<0&&(i=-i,n=128),i+=33,i>8191&&(i=8191);(i&a)!==a&&s>=5;)a>>=1,s--;return o=i>>s-4&15,~(n|s-5<<4|o)&255},bf=r=>{let t=0,i=0,a=~r;a&128&&(a&=-129,t=-1),i=((a&240)>>4)+5;const n=(1<<i|(a&15)<<i-4|1<<i-5)-33;return t===0?n:-n},wf=r=>{let t=2048,i=0,a=11,n=0,s=r;for(s<0&&(s=-s,i=128),s>4095&&(s=4095);(s&t)!==t&&a>=5;)t>>=1,a--;return n=s>>(a===4?1:a-4)&15,(i|a-4<<4|n)^85},kf=r=>{let e=0,t=0,i=r^85;i&128&&(i&=-129,e=-1),t=((i&240)>>4)+4;let a=0;return t!==4?a=1<<t|(i&15)<<t-4|1<<t-5:a=i<<1|1,e===0?a:-a};Ec();let Fo=-1/0,Bo=-1/0,ba=null;typeof FinalizationRegistry<"u"&&(ba=new FinalizationRegistry(r=>{const e=Date.now();r.type==="video"?(e-Fo>=1e3&&(console.error("A VideoSample was garbage collected without first being closed. For proper resource management, make sure to call close() on all your VideoSamples as soon as you're done using them."),Fo=e),typeof VideoFrame<"u"&&r.data instanceof VideoFrame&&r.data.close()):(e-Bo>=1e3&&(console.error("An AudioSample was garbage collected without first being closed. For proper resource management, make sure to call close() on all your AudioSamples as soon as you're done using them."),Bo=e),typeof AudioData<"u"&&r.data instanceof AudioData&&r.data.close())}));const Kc=["I420","I420P10","I420P12","I420A","I420AP10","I420AP12","I422","I422P10","I422P12","I422A","I422AP10","I422AP12","I444","I444P10","I444P12","I444A","I444AP10","I444AP12","NV12","RGBA","RGBX","BGRA","BGRX"],yf=new Set(Kc);class Wt{get displayWidth(){return this.rotation%180===0?this.codedWidth:this.codedHeight}get displayHeight(){return this.rotation%180===0?this.codedHeight:this.codedWidth}get microsecondTimestamp(){return Math.trunc(Kr*this.timestamp)}get microsecondDuration(){return Math.trunc(Kr*this.duration)}get hasAlpha(){return this.format&&this.format.includes("A")}constructor(e,t){if(this._closed=!1,e instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&e instanceof SharedArrayBuffer||ArrayBuffer.isView(e)){if(!t||typeof t!="object")throw new TypeError("init must be an object.");if(t.format===void 0||!yf.has(t.format))throw new TypeError("init.format must be one of: "+Kc.join(", "));if(!Number.isInteger(t.codedWidth)||t.codedWidth<=0)throw new TypeError("init.codedWidth must be a positive integer.");if(!Number.isInteger(t.codedHeight)||t.codedHeight<=0)throw new TypeError("init.codedHeight must be a positive integer.");if(t.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(!Number.isFinite(t.timestamp))throw new TypeError("init.timestamp must be a number.");if(t.duration!==void 0&&(!Number.isFinite(t.duration)||t.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");this._data=Lt(e).slice(),this._layout=t.layout??xf(t.format,t.codedWidth,t.codedHeight),this.format=t.format,this.codedWidth=t.codedWidth,this.codedHeight=t.codedHeight,this.rotation=t.rotation??0,this.timestamp=t.timestamp,this.duration=t.duration??0,this.colorSpace=new ys(t.colorSpace)}else if(typeof VideoFrame<"u"&&e instanceof VideoFrame){if(t?.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(t?.timestamp!==void 0&&!Number.isFinite(t?.timestamp))throw new TypeError("init.timestamp, when provided, must be a number.");if(t?.duration!==void 0&&(!Number.isFinite(t.duration)||t.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");this._data=e,this._layout=null,this.format=e.format,this.codedWidth=e.displayWidth,this.codedHeight=e.displayHeight,this.rotation=t?.rotation??0,this.timestamp=t?.timestamp??e.timestamp/1e6,this.duration=t?.duration??(e.duration??0)/1e6,this.colorSpace=new ys(e.colorSpace)}else if(typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement||typeof SVGImageElement<"u"&&e instanceof SVGImageElement||typeof ImageBitmap<"u"&&e instanceof ImageBitmap||typeof HTMLVideoElement<"u"&&e instanceof HTMLVideoElement||typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&e instanceof OffscreenCanvas){if(!t||typeof t!="object")throw new TypeError("init must be an object.");if(t.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(!Number.isFinite(t.timestamp))throw new TypeError("init.timestamp must be a number.");if(t.duration!==void 0&&(!Number.isFinite(t.duration)||t.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");if(typeof VideoFrame<"u")return new Wt(new VideoFrame(e,{timestamp:Math.trunc(t.timestamp*Kr),duration:Math.trunc((t.duration??0)*Kr)||void 0}),t);let i=0,a=0;if("naturalWidth"in e?(i=e.naturalWidth,a=e.naturalHeight):"videoWidth"in e?(i=e.videoWidth,a=e.videoHeight):"width"in e&&(i=Number(e.width),a=Number(e.height)),!i||!a)throw new TypeError("Could not determine dimensions.");const n=new OffscreenCanvas(i,a),s=n.getContext("2d",{alpha:Wi(),willReadFrequently:!0});E(s),s.drawImage(e,0,0),this._data=n,this._layout=null,this.format="RGBX",this.codedWidth=i,this.codedHeight=a,this.rotation=t.rotation??0,this.timestamp=t.timestamp,this.duration=t.duration??0,this.colorSpace=new ys({matrix:"rgb",primaries:"bt709",transfer:"iec61966-2-1",fullRange:!0})}else throw new TypeError("Invalid data type: Must be a BufferSource or CanvasImageSource.");ba?.register(this,{type:"video",data:this._data},this)}clone(){if(this._closed)throw new Error("VideoSample is closed.");return E(this._data!==null),ii(this._data)?new Wt(this._data.clone(),{timestamp:this.timestamp,duration:this.duration,rotation:this.rotation}):this._data instanceof Uint8Array?(E(this._layout),new Wt(this._data,{format:this.format,layout:this._layout,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.timestamp,duration:this.duration,colorSpace:this.colorSpace,rotation:this.rotation})):new Wt(this._data,{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.timestamp,duration:this.duration,colorSpace:this.colorSpace,rotation:this.rotation})}close(){this._closed||(ba?.unregister(this),ii(this._data)?this._data.close():this._data=null,this._closed=!0)}allocationSize(e={}){if(zo(e),this._closed)throw new Error("VideoSample is closed.");if(this.format===null)throw new Error("Cannot get allocation size when format is null. Sorry!");if(E(this._data!==null),!ii(this._data)&&(e.colorSpace||e.format&&e.format!==this.format||e.layout||e.rect)){const t=this.toVideoFrame(),i=t.allocationSize(e);return t.close(),i}return ii(this._data)?this._data.allocationSize(e):this._data instanceof Uint8Array?this._data.byteLength:this.codedWidth*this.codedHeight*4}async copyTo(e,t={}){if(!ss(e))throw new TypeError("destination must be an ArrayBuffer or an ArrayBuffer view.");if(zo(t),this._closed)throw new Error("VideoSample is closed.");if(this.format===null)throw new Error("Cannot copy video sample data when format is null. Sorry!");if(E(this._data!==null),!ii(this._data)&&(t.colorSpace||t.format&&t.format!==this.format||t.layout||t.rect)){const i=this.toVideoFrame(),a=await i.copyTo(e,t);return i.close(),a}if(ii(this._data))return this._data.copyTo(e,t);if(this._data instanceof Uint8Array)return E(this._layout),Lt(e).set(this._data),this._layout;{const a=this._data.getContext("2d");E(a);const n=a.getImageData(0,0,this.codedWidth,this.codedHeight);return Lt(e).set(n.data),[{offset:0,stride:4*this.codedWidth}]}}toVideoFrame(){if(this._closed)throw new Error("VideoSample is closed.");return E(this._data!==null),ii(this._data)?new VideoFrame(this._data,{timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0}):this._data instanceof Uint8Array?new VideoFrame(this._data,{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0,colorSpace:this.colorSpace}):new VideoFrame(this._data,{timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0})}draw(e,t,i,a,n,s,o,c,l){let d=0,u=0,f=this.displayWidth,h=this.displayHeight,g=0,m=0,p=this.displayWidth,v=this.displayHeight;if(s!==void 0?(d=t,u=i,f=a,h=n,g=s,m=o,c!==void 0?(p=c,v=l):(p=f,v=h)):(g=t,m=i,a!==void 0&&(p=a,v=n)),!(typeof CanvasRenderingContext2D<"u"&&e instanceof CanvasRenderingContext2D||typeof OffscreenCanvasRenderingContext2D<"u"&&e instanceof OffscreenCanvasRenderingContext2D))throw new TypeError("context must be a CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D.");if(!Number.isFinite(d))throw new TypeError("sx must be a number.");if(!Number.isFinite(u))throw new TypeError("sy must be a number.");if(!Number.isFinite(f)||f<0)throw new TypeError("sWidth must be a non-negative number.");if(!Number.isFinite(h)||h<0)throw new TypeError("sHeight must be a non-negative number.");if(!Number.isFinite(g))throw new TypeError("dx must be a number.");if(!Number.isFinite(m))throw new TypeError("dy must be a number.");if(!Number.isFinite(p)||p<0)throw new TypeError("dWidth must be a non-negative number.");if(!Number.isFinite(v)||v<0)throw new TypeError("dHeight must be a non-negative number.");if(this._closed)throw new Error("VideoSample is closed.");({sx:d,sy:u,sWidth:f,sHeight:h}=this._rotateSourceRegion(d,u,f,h,this.rotation));const b=this.toCanvasImageSource();e.save();const w=g+p/2,x=m+v/2;e.translate(w,x),e.rotate(this.rotation*Math.PI/180);const T=this.rotation%180===0?1:p/v;e.scale(1/T,T),e.drawImage(b,d,u,f,h,-p/2,-v/2,p,v),e.restore()}drawWithFit(e,t){if(!(typeof CanvasRenderingContext2D<"u"&&e instanceof CanvasRenderingContext2D||typeof OffscreenCanvasRenderingContext2D<"u"&&e instanceof OffscreenCanvasRenderingContext2D))throw new TypeError("context must be a CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D.");if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(!["fill","contain","cover"].includes(t.fit))throw new TypeError("options.fit must be 'fill', 'contain', or 'cover'.");if(t.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError("options.rotation, when provided, must be 0, 90, 180, or 270.");t.crop!==void 0&&On(t.crop,"options.");const i=e.canvas.width,a=e.canvas.height,n=t.rotation??this.rotation,[s,o]=n%180===0?[this.codedWidth,this.codedHeight]:[this.codedHeight,this.codedWidth];t.crop&&Dn(t.crop,s,o);let c,l,d,u;const{sx:f,sy:h,sWidth:g,sHeight:m}=this._rotateSourceRegion(t.crop?.left??0,t.crop?.top??0,t.crop?.width??s,t.crop?.height??o,n);if(t.fit==="fill")c=0,l=0,d=i,u=a;else{const[v,b]=t.crop?[t.crop.width,t.crop.height]:[s,o],w=t.fit==="contain"?Math.min(i/v,a/b):Math.max(i/v,a/b);d=v*w,u=b*w,c=(i-d)/2,l=(a-u)/2}e.save();const p=n%180===0?1:d/u;e.translate(i/2,a/2),e.rotate(n*Math.PI/180),e.scale(1/p,p),e.translate(-i/2,-a/2),e.drawImage(this.toCanvasImageSource(),f,h,g,m,c,l,d,u),e.restore()}_rotateSourceRegion(e,t,i,a,n){return n===90?[e,t,i,a]=[t,this.codedHeight-e-i,a,i]:n===180?[e,t]=[this.codedWidth-e-i,this.codedHeight-t-a]:n===270&&([e,t,i,a]=[this.codedWidth-t-a,e,a,i]),{sx:e,sy:t,sWidth:i,sHeight:a}}toCanvasImageSource(){if(this._closed)throw new Error("VideoSample is closed.");if(E(this._data!==null),this._data instanceof Uint8Array){const e=this.toVideoFrame();return queueMicrotask(()=>e.close()),e}else return this._data}setRotation(e){if(![0,90,180,270].includes(e))throw new TypeError("newRotation must be 0, 90, 180, or 270.");this.rotation=e}setTimestamp(e){if(!Number.isFinite(e))throw new TypeError("newTimestamp must be a number.");this.timestamp=e}setDuration(e){if(!Number.isFinite(e)||e<0)throw new TypeError("newDuration must be a non-negative number.");this.duration=e}[Symbol.dispose](){this.close()}}class ys{constructor(e){this.primaries=e?.primaries??null,this.transfer=e?.transfer??null,this.matrix=e?.matrix??null,this.fullRange=e?.fullRange??null}toJSON(){return{primaries:this.primaries,transfer:this.transfer,matrix:this.matrix,fullRange:this.fullRange}}}const ii=r=>typeof VideoFrame<"u"&&r instanceof VideoFrame,Dn=(r,e,t)=>{r.left=Math.min(r.left,e),r.top=Math.min(r.top,t),r.width=Math.min(r.width,e-r.left),r.height=Math.min(r.height,t-r.top),E(r.width>=0),E(r.height>=0)},On=(r,e)=>{if(!r||typeof r!="object")throw new TypeError(e+"crop, when provided, must be an object.");if(!Number.isInteger(r.left)||r.left<0)throw new TypeError(e+"crop.left must be a non-negative integer.");if(!Number.isInteger(r.top)||r.top<0)throw new TypeError(e+"crop.top must be a non-negative integer.");if(!Number.isInteger(r.width)||r.width<0)throw new TypeError(e+"crop.width must be a non-negative integer.");if(!Number.isInteger(r.height)||r.height<0)throw new TypeError(e+"crop.height must be a non-negative integer.")},zo=r=>{if(!r||typeof r!="object")throw new TypeError("options must be an object.");if(r.colorSpace!==void 0&&!["display-p3","srgb"].includes(r.colorSpace))throw new TypeError("options.colorSpace, when provided, must be 'display-p3' or 'srgb'.");if(r.format!==void 0&&typeof r.format!="string")throw new TypeError("options.format, when provided, must be a string.");if(r.layout!==void 0){if(!Array.isArray(r.layout))throw new TypeError("options.layout, when provided, must be an array.");for(const e of r.layout){if(!e||typeof e!="object")throw new TypeError("Each entry in options.layout must be an object.");if(!Number.isInteger(e.offset)||e.offset<0)throw new TypeError("plane.offset must be a non-negative integer.");if(!Number.isInteger(e.stride)||e.stride<0)throw new TypeError("plane.stride must be a non-negative integer.")}}if(r.rect!==void 0){if(!r.rect||typeof r.rect!="object")throw new TypeError("options.rect, when provided, must be an object.");if(r.rect.x!==void 0&&(!Number.isInteger(r.rect.x)||r.rect.x<0))throw new TypeError("options.rect.x, when provided, must be a non-negative integer.");if(r.rect.y!==void 0&&(!Number.isInteger(r.rect.y)||r.rect.y<0))throw new TypeError("options.rect.y, when provided, must be a non-negative integer.");if(r.rect.width!==void 0&&(!Number.isInteger(r.rect.width)||r.rect.width<0))throw new TypeError("options.rect.width, when provided, must be a non-negative integer.");if(r.rect.height!==void 0&&(!Number.isInteger(r.rect.height)||r.rect.height<0))throw new TypeError("options.rect.height, when provided, must be a non-negative integer.")}},xf=(r,e,t)=>{const i=_f(r),a=[];let n=0;for(const s of i){const o=Math.ceil(e/s.widthDivisor),c=Math.ceil(t/s.heightDivisor),l=o*s.sampleBytes,d=l*c;a.push({offset:n,stride:l}),n+=d}return a},_f=r=>{const e=(t,i,a,n,s)=>{const o=[{sampleBytes:t,widthDivisor:1,heightDivisor:1},{sampleBytes:i,widthDivisor:a,heightDivisor:n},{sampleBytes:i,widthDivisor:a,heightDivisor:n}];return s&&o.push({sampleBytes:t,widthDivisor:1,heightDivisor:1}),o};switch(r){case"I420":return e(1,1,2,2,!1);case"I420P10":case"I420P12":return e(2,2,2,2,!1);case"I420A":return e(1,1,2,2,!0);case"I420AP10":case"I420AP12":return e(2,2,2,2,!0);case"I422":return e(1,1,2,1,!1);case"I422P10":case"I422P12":return e(2,2,2,1,!1);case"I422A":return e(1,1,2,1,!0);case"I422AP10":case"I422AP12":return e(2,2,2,1,!0);case"I444":return e(1,1,1,1,!1);case"I444P10":case"I444P12":return e(2,2,1,1,!1);case"I444A":return e(1,1,1,1,!0);case"I444AP10":case"I444AP12":return e(2,2,1,1,!0);case"NV12":return[{sampleBytes:1,widthDivisor:1,heightDivisor:1},{sampleBytes:2,widthDivisor:2,heightDivisor:2}];case"RGBA":case"RGBX":case"BGRA":case"BGRX":return[{sampleBytes:4,widthDivisor:1,heightDivisor:1}];default:Tr(r),E(!1)}},xs=new Set(["f32","f32-planar","s16","s16-planar","s32","s32-planar","u8","u8-planar"]);class cr{get microsecondTimestamp(){return Math.trunc(Kr*this.timestamp)}get microsecondDuration(){return Math.trunc(Kr*this.duration)}constructor(e){if(this._closed=!1,ea(e)){if(e.format===null)throw new TypeError("AudioData with null format is not supported.");this._data=e,this.format=e.format,this.sampleRate=e.sampleRate,this.numberOfFrames=e.numberOfFrames,this.numberOfChannels=e.numberOfChannels,this.timestamp=e.timestamp/1e6,this.duration=e.numberOfFrames/e.sampleRate}else{if(!e||typeof e!="object")throw new TypeError("Invalid AudioDataInit: must be an object.");if(!xs.has(e.format))throw new TypeError("Invalid AudioDataInit: invalid format.");if(!Number.isFinite(e.sampleRate)||e.sampleRate<=0)throw new TypeError("Invalid AudioDataInit: sampleRate must be > 0.");if(!Number.isInteger(e.numberOfChannels)||e.numberOfChannels===0)throw new TypeError("Invalid AudioDataInit: numberOfChannels must be an integer > 0.");if(!Number.isFinite(e?.timestamp))throw new TypeError("init.timestamp must be a number.");const t=e.data.byteLength/(ni(e.format)*e.numberOfChannels);if(!Number.isInteger(t))throw new TypeError("Invalid AudioDataInit: data size is not a multiple of frame size.");this.format=e.format,this.sampleRate=e.sampleRate,this.numberOfFrames=t,this.numberOfChannels=e.numberOfChannels,this.timestamp=e.timestamp,this.duration=t/e.sampleRate;let i;if(e.data instanceof ArrayBuffer)i=new Uint8Array(e.data);else if(ArrayBuffer.isView(e.data))i=new Uint8Array(e.data.buffer,e.data.byteOffset,e.data.byteLength);else throw new TypeError("Invalid AudioDataInit: data is not a BufferSource.");const a=this.numberOfFrames*this.numberOfChannels*ni(this.format);if(i.byteLength<a)throw new TypeError("Invalid AudioDataInit: insufficient data size.");this._data=i}ba?.register(this,{type:"audio",data:this._data},this)}allocationSize(e){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(!Number.isInteger(e.planeIndex)||e.planeIndex<0)throw new TypeError("planeIndex must be a non-negative integer.");if(e.format!==void 0&&!xs.has(e.format))throw new TypeError("Invalid format.");if(e.frameOffset!==void 0&&(!Number.isInteger(e.frameOffset)||e.frameOffset<0))throw new TypeError("frameOffset must be a non-negative integer.");if(e.frameCount!==void 0&&(!Number.isInteger(e.frameCount)||e.frameCount<0))throw new TypeError("frameCount must be a non-negative integer.");if(this._closed)throw new Error("AudioSample is closed.");const t=e.format??this.format,i=e.frameOffset??0;if(i>=this.numberOfFrames)throw new RangeError("frameOffset out of range");const a=e.frameCount!==void 0?e.frameCount:this.numberOfFrames-i;if(a>this.numberOfFrames-i)throw new RangeError("frameCount out of range");const n=ni(t),s=Si(t);if(s&&e.planeIndex>=this.numberOfChannels)throw new RangeError("planeIndex out of range");if(!s&&e.planeIndex!==0)throw new RangeError("planeIndex out of range");return(s?a:a*this.numberOfChannels)*n}copyTo(e,t){if(!ss(e))throw new TypeError("destination must be an ArrayBuffer or an ArrayBuffer view.");if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(!Number.isInteger(t.planeIndex)||t.planeIndex<0)throw new TypeError("planeIndex must be a non-negative integer.");if(t.format!==void 0&&!xs.has(t.format))throw new TypeError("Invalid format.");if(t.frameOffset!==void 0&&(!Number.isInteger(t.frameOffset)||t.frameOffset<0))throw new TypeError("frameOffset must be a non-negative integer.");if(t.frameCount!==void 0&&(!Number.isInteger(t.frameCount)||t.frameCount<0))throw new TypeError("frameCount must be a non-negative integer.");if(this._closed)throw new Error("AudioSample is closed.");const{planeIndex:i,format:a,frameCount:n,frameOffset:s}=t,o=this.format,c=a??this.format;if(!c)throw new Error("Destination format not determined");const l=this.numberOfFrames,d=this.numberOfChannels,u=s??0;if(u>=l)throw new RangeError("frameOffset out of range");const f=n!==void 0?n:l-u;if(f>l-u)throw new RangeError("frameCount out of range");const h=ni(c),g=Si(c);if(g&&i>=d)throw new RangeError("planeIndex out of range");if(!g&&i!==0)throw new RangeError("planeIndex out of range");const p=(g?f:f*d)*h;if(e.byteLength<p)throw new RangeError("Destination buffer is too small");const v=kt(e),b=Qc(c);if(ea(this._data))da()&&d>2&&c!==o?Tf(this._data,v,o,c,d,i,u,f):this._data.copyTo(e,{planeIndex:i,frameOffset:u,frameCount:f,format:c});else{const w=this._data,x=kt(w),T=Gc(o),A=ni(o),B=Si(o);for(let z=0;z<f;z++)if(g){const M=z*h;let W;B?W=(i*l+(z+u))*A:W=((z+u)*d+i)*A;const G=T(x,W);b(v,M,G)}else for(let M=0;M<d;M++){const G=(z*d+M)*h;let C;B?C=(M*l+(z+u))*A:C=((z+u)*d+M)*A;const N=T(x,C);b(v,G,N)}}}clone(){if(this._closed)throw new Error("AudioSample is closed.");if(ea(this._data)){const e=new cr(this._data.clone());return e.setTimestamp(this.timestamp),e}else return new cr({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.timestamp,data:this._data})}close(){this._closed||(ba?.unregister(this),ea(this._data)?this._data.close():this._data=new Uint8Array(0),this._closed=!0)}toAudioData(){if(this._closed)throw new Error("AudioSample is closed.");if(ea(this._data)){if(this._data.timestamp===this.microsecondTimestamp)return this._data.clone();if(Si(this.format)){const e=this.allocationSize({planeIndex:0,format:this.format}),t=new ArrayBuffer(e*this.numberOfChannels);for(let i=0;i<this.numberOfChannels;i++)this.copyTo(new Uint8Array(t,i*e,e),{planeIndex:i,format:this.format});return new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:t})}else{const e=new ArrayBuffer(this.allocationSize({planeIndex:0,format:this.format}));return this.copyTo(e,{planeIndex:0,format:this.format}),new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:e})}}else return new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:this._data.buffer instanceof ArrayBuffer?this._data.buffer:this._data.slice()})}toAudioBuffer(){if(this._closed)throw new Error("AudioSample is closed.");const e=new AudioBuffer({numberOfChannels:this.numberOfChannels,length:this.numberOfFrames,sampleRate:this.sampleRate}),t=new Float32Array(this.allocationSize({planeIndex:0,format:"f32-planar"})/4);for(let i=0;i<this.numberOfChannels;i++)this.copyTo(t,{planeIndex:i,format:"f32-planar"}),e.copyToChannel(t,i);return e}setTimestamp(e){if(!Number.isFinite(e))throw new TypeError("newTimestamp must be a number.");this.timestamp=e}[Symbol.dispose](){this.close()}static*_fromAudioBuffer(e,t){if(!(e instanceof AudioBuffer))throw new TypeError("audioBuffer must be an AudioBuffer.");const i=48e3*5,a=e.numberOfChannels,n=e.sampleRate,s=e.length,o=Math.floor(i/a);let c=0,l=s;for(;l>0;){const d=Math.min(o,l),u=new Float32Array(a*d);for(let f=0;f<a;f++)e.copyFromChannel(u.subarray(f*d,(f+1)*d),f,c);yield new cr({format:"f32-planar",sampleRate:n,numberOfFrames:d,numberOfChannels:a,timestamp:t+c/n,data:u}),c+=d,l-=d}}static fromAudioBuffer(e,t){if(!(e instanceof AudioBuffer))throw new TypeError("audioBuffer must be an AudioBuffer.");const i=48e3*5,a=e.numberOfChannels,n=e.sampleRate,s=e.length,o=Math.floor(i/a);let c=0,l=s;const d=[];for(;l>0;){const u=Math.min(o,l),f=new Float32Array(a*u);for(let g=0;g<a;g++)e.copyFromChannel(f.subarray(g*u,(g+1)*u),g,c);const h=new cr({format:"f32-planar",sampleRate:n,numberOfFrames:u,numberOfChannels:a,timestamp:t+c/n,data:f});d.push(h),c+=u,l-=u}return d}}const ni=r=>{switch(r){case"u8":case"u8-planar":return 1;case"s16":case"s16-planar":return 2;case"s32":case"s32-planar":return 4;case"f32":case"f32-planar":return 4;default:throw new Error("Unknown AudioSampleFormat")}},Si=r=>{switch(r){case"u8-planar":case"s16-planar":case"s32-planar":case"f32-planar":return!0;default:return!1}},Gc=r=>{switch(r){case"u8":case"u8-planar":return(e,t)=>(e.getUint8(t)-128)/128;case"s16":case"s16-planar":return(e,t)=>e.getInt16(t,!0)/32768;case"s32":case"s32-planar":return(e,t)=>e.getInt32(t,!0)/2147483648;case"f32":case"f32-planar":return(e,t)=>e.getFloat32(t,!0)}},Qc=r=>{switch(r){case"u8":case"u8-planar":return(e,t,i)=>e.setUint8(t,Mt((i+1)*127.5,0,255));case"s16":case"s16-planar":return(e,t,i)=>e.setInt16(t,Mt(Math.round(i*32767),-32768,32767),!0);case"s32":case"s32-planar":return(e,t,i)=>e.setInt32(t,Mt(Math.round(i*2147483647),-2147483648,2147483647),!0);case"f32":case"f32-planar":return(e,t,i)=>e.setFloat32(t,i,!0)}},ea=r=>typeof AudioData<"u"&&r instanceof AudioData,Tf=(r,e,t,i,a,n,s,o)=>{const c=Gc(t),l=Qc(i),d=ni(t),u=ni(i),f=Si(t);if(Si(i))if(f){const g=new ArrayBuffer(o*d),m=kt(g);r.copyTo(g,{planeIndex:n,frameOffset:s,frameCount:o,format:t});for(let p=0;p<o;p++){const v=p*d,b=p*u,w=c(m,v);l(e,b,w)}}else{const g=new ArrayBuffer(o*a*d),m=kt(g);r.copyTo(g,{planeIndex:0,frameOffset:s,frameCount:o,format:t});for(let p=0;p<o;p++){const v=(p*a+n)*d,b=p*u,w=c(m,v);l(e,b,w)}}else if(f){const g=o*d,m=new ArrayBuffer(g),p=kt(m);for(let v=0;v<a;v++){r.copyTo(m,{planeIndex:v,frameOffset:s,frameCount:o,format:t});for(let b=0;b<o;b++){const w=b*d,x=(b*a+v)*u,T=c(p,w);l(e,x,T)}}}else{const g=new ArrayBuffer(o*a*d),m=kt(g);r.copyTo(g,{planeIndex:0,frameOffset:s,frameCount:o,format:t});for(let p=0;p<o;p++)for(let v=0;v<a;v++){const b=p*a+v,w=b*d,x=b*u,T=c(m,w);l(e,x,T)}}};const mi=r=>{if(!r||typeof r!="object")throw new TypeError("options must be an object.");if(r.metadataOnly!==void 0&&typeof r.metadataOnly!="boolean")throw new TypeError("options.metadataOnly, when defined, must be a boolean.");if(r.verifyKeyPackets!==void 0&&typeof r.verifyKeyPackets!="boolean")throw new TypeError("options.verifyKeyPackets, when defined, must be a boolean.");if(r.verifyKeyPackets&&r.metadataOnly)throw new TypeError("options.verifyKeyPackets and options.metadataOnly cannot be enabled together.")},Xr=r=>{if(!Ic(r))throw new TypeError("timestamp must be a number.")},_s=(r,e,t)=>t.verifyKeyPackets?e.then(async i=>{if(!i||i.type==="delta")return i;const a=await r.determinePacketType(i);return a&&(i.type=a),i}):e;class wa{constructor(e){if(!(e instanceof Un))throw new TypeError("track must be an InputTrack.");this._track=e}getFirstPacket(e={}){if(mi(e),this._track.input._disposed)throw new tr;return _s(this._track,this._track._backing.getFirstPacket(e),e)}getPacket(e,t={}){if(Xr(e),mi(t),this._track.input._disposed)throw new tr;return _s(this._track,this._track._backing.getPacket(e,t),t)}getNextPacket(e,t={}){if(!(e instanceof ht))throw new TypeError("packet must be an EncodedPacket.");if(mi(t),this._track.input._disposed)throw new tr;return _s(this._track,this._track._backing.getNextPacket(e,t),t)}async getKeyPacket(e,t={}){if(Xr(e),mi(t),this._track.input._disposed)throw new tr;if(!t.verifyKeyPackets)return this._track._backing.getKeyPacket(e,t);const i=await this._track._backing.getKeyPacket(e,t);return i&&(E(i.type==="key"),await this._track.determinePacketType(i)==="delta"?this.getKeyPacket(i.timestamp-1/this._track.timeResolution,t):i)}async getNextKeyPacket(e,t={}){if(!(e instanceof ht))throw new TypeError("packet must be an EncodedPacket.");if(mi(t),this._track.input._disposed)throw new tr;if(!t.verifyKeyPackets)return this._track._backing.getNextKeyPacket(e,t);const i=await this._track._backing.getNextKeyPacket(e,t);return i&&(E(i.type==="key"),await this._track.determinePacketType(i)==="delta"?this.getNextKeyPacket(i,t):i)}packets(e,t,i={}){if(e!==void 0&&!(e instanceof ht))throw new TypeError("startPacket must be an EncodedPacket.");if(e!==void 0&&e.isMetadataOnly&&!i?.metadataOnly)throw new TypeError("startPacket can only be metadata-only if options.metadataOnly is enabled.");if(t!==void 0&&!(t instanceof ht))throw new TypeError("endPacket must be an EncodedPacket.");if(mi(i),this._track.input._disposed)throw new tr;const a=[];let{promise:n,resolve:s}=Rt(),{promise:o,resolve:c}=Rt(),l=!1,d=!1,u=null;const f=[],h=()=>Math.max(2,f.length);(async()=>{let m=e??await this.getFirstPacket(i);for(;m&&!d&&!this._track.input._disposed&&!(t&&m.sequenceNumber>=t?.sequenceNumber);){if(a.length>h()){({promise:o,resolve:c}=Rt()),await o;continue}a.push(m),s(),{promise:n,resolve:s}=Rt(),m=await this.getNextPacket(m,i)}l=!0,s()})().catch(m=>{u||(u=m,s())});const g=this._track;return{async next(){for(;;){if(g.input._disposed)throw new tr;if(d)return{value:void 0,done:!0};if(u)throw u;if(a.length>0){const m=a.shift(),p=performance.now();for(f.push(p);f.length>0&&p-f[0]>=1e3;)f.shift();return c(),{value:m,done:!1}}else{if(l)return{value:void 0,done:!0};await n}}},async return(){return d=!0,c(),s(),{value:void 0,done:!0}},async throw(m){throw m},[Symbol.asyncIterator](){return this}}}}class Nn{constructor(e,t){this.onSample=e,this.onError=t}}class Xc{mediaSamplesInRange(e=0,t=1/0){Xr(e),Xr(t);const i=[];let a=!1,n=null,{promise:s,resolve:o}=Rt(),{promise:c,resolve:l}=Rt(),d=!1,u=!1,f=!1,h=null;(async()=>{const p=await this._createDecoder(A=>{if(l(),A.timestamp>=t&&(u=!0),u){A.close();return}n&&(A.timestamp>e?(i.push(n),a=!0):n.close()),A.timestamp>=e&&(i.push(A),a=!0),n=a?null:A,i.length>0&&(o(),{promise:s,resolve:o}=Rt())},A=>{h||(h=A,o())}),v=this._createPacketSink(),b=await v.getKeyPacket(e,{verifyKeyPackets:!0})??await v.getFirstPacket();let w=b;const T=v.packets(b??void 0,void 0);for(await T.next();w&&!u&&!this._track.input._disposed;){const A=Mo(i.length);if(i.length+p.getDecodeQueueSize()>A){({promise:c,resolve:l}=Rt()),await c;continue}p.decode(w);const B=await T.next();if(B.done)break;w=B.value}await T.return(),!f&&!this._track.input._disposed&&await p.flush(),p.close(),!a&&n&&i.push(n),d=!0,o()})().catch(p=>{h||(h=p,o())});const g=this._track,m=()=>{n?.close();for(const p of i)p.close()};return{async next(){for(;;){if(g.input._disposed)throw m(),new tr;if(f)return{value:void 0,done:!0};if(h)throw m(),h;if(i.length>0){const p=i.shift();return l(),{value:p,done:!1}}else if(!d)await s;else return{value:void 0,done:!0}}},async return(){return f=!0,u=!0,l(),o(),m(),{value:void 0,done:!0}},async throw(p){throw p},[Symbol.asyncIterator](){return this}}}mediaSamplesAtTimestamps(e){Bu(e);const t=Fu(e),i=[],a=[];let{promise:n,resolve:s}=Rt(),{promise:o,resolve:c}=Rt(),l=!1,d=!1,u=null;const f=m=>{a.push(m),s(),{promise:n,resolve:s}=Rt()};(async()=>{const m=await this._createDecoder(A=>{if(c(),d){A.close();return}let B=0;for(;i.length>0&&A.timestamp-i[0]>-1e-10;)B++,i.shift();if(B>0)for(let z=0;z<B;z++)f(z<B-1?A.clone():A);else A.close()},A=>{u||(u=A,s())}),p=this._createPacketSink();let v=null,b=null,w=-1;const x=async()=>{E(b);let A=b;for(m.decode(A);A.sequenceNumber<w;){const B=Mo(a.length);for(;a.length+m.getDecodeQueueSize()>B&&!d;)({promise:o,resolve:c}=Rt()),await o;if(d)break;const z=await p.getNextPacket(A);E(z),m.decode(z),A=z}w=-1},T=async()=>{await m.flush();for(let A=0;A<i.length;A++)f(null);i.length=0};for await(const A of t){if(Xr(A),d||this._track.input._disposed)break;const B=await p.getPacket(A),z=B&&await p.getKeyPacket(A,{verifyKeyPackets:!0});if(!z){w!==-1&&(await x(),await T()),f(null),v=null;continue}v&&(z.sequenceNumber!==b.sequenceNumber||B.timestamp<v.timestamp)&&(await x(),await T()),i.push(B.timestamp),w=Math.max(B.sequenceNumber,w),v=B,b=z}!d&&!this._track.input._disposed&&(w!==-1&&await x(),await T()),m.close(),l=!0,s()})().catch(m=>{u||(u=m,s())});const h=this._track,g=()=>{for(const m of a)m?.close()};return{async next(){for(;;){if(h.input._disposed)throw g(),new tr;if(d)return{value:void 0,done:!0};if(u)throw g(),u;if(a.length>0){const m=a.shift();return E(m!==void 0),c(),{value:m,done:!1}}else if(!l)await n;else return{value:void 0,done:!0}}},async return(){return d=!0,c(),s(),g(),{value:void 0,done:!0}},async throw(m){throw m},[Symbol.asyncIterator](){return this}}}}const Mo=r=>r===0?40:8;class Sf extends Nn{constructor(e,t,i,a,n,s){super(e,t),this.codec=i,this.decoderConfig=a,this.rotation=n,this.timeResolution=s,this.decoder=null,this.customDecoder=null,this.customDecoderCallSerializer=new os,this.customDecoderQueueSize=0,this.inputTimestamps=[],this.sampleQueue=[],this.currentPacketIndex=0,this.raslSkipped=!1,this.alphaDecoder=null,this.alphaHadKeyframe=!1,this.colorQueue=[],this.alphaQueue=[],this.merger=null,this.mergerCreationFailed=!1,this.decodedAlphaChunkCount=0,this.alphaDecoderQueueSize=0,this.nullAlphaFrameQueue=[],this.currentAlphaPacketIndex=0,this.alphaRaslSkipped=!1;const o=jc.find(c=>c.supports(i,a));if(o)this.customDecoder=new o,this.customDecoder.codec=i,this.customDecoder.config=a,this.customDecoder.onSample=c=>{if(!(c instanceof Wt))throw new TypeError("The argument passed to onSample must be a VideoSample.");this.finalizeAndEmitSample(c)},this.customDecoderCallSerializer.call(()=>this.customDecoder.init());else{const c=d=>{if(this.alphaQueue.length>0){const u=this.alphaQueue.shift();E(u!==void 0),this.mergeAlpha(d,u)}else this.colorQueue.push(d)};if(i==="avc"&&this.decoderConfig.description&&Ks()){const d=sf(Lt(this.decoderConfig.description));if(d&&d.sequenceParameterSets.length>0){const u=Bn(d.sequenceParameterSets[0]);u&&u.frameMbsOnlyFlag===0&&(this.decoderConfig={...this.decoderConfig,hardwareAcceleration:"prefer-software"})}}const l=new Error("Decoding error").stack;this.decoder=new VideoDecoder({output:d=>{try{c(d)}catch(u){this.onError(u)}},error:d=>{d.stack=l,this.onError(d)}}),this.decoder.configure(this.decoderConfig)}}getDecodeQueueSize(){return this.customDecoder?this.customDecoderQueueSize:(E(this.decoder),Math.max(this.decoder.decodeQueueSize,this.alphaDecoder?.decodeQueueSize??0))}decode(e){if(this.codec==="hevc"&&this.currentPacketIndex>0&&!this.raslSkipped){if(this.hasHevcRaslPicture(e.data))return;this.raslSkipped=!0}if(this.customDecoder)this.customDecoderQueueSize++,this.customDecoderCallSerializer.call(()=>this.customDecoder.decode(e)).then(()=>this.customDecoderQueueSize--);else{if(E(this.decoder),da()||xo(this.inputTimestamps,e.timestamp,t=>t),Ks()&&this.currentPacketIndex===0&&this.codec==="avc"){const t=[];for(const a of Nc(e.data,this.decoderConfig)){const n=cs(e.data[a.offset]);n>=20&&n<=31||t.push(e.data.subarray(a.offset,a.offset+a.length))}const i=rf(t,this.decoderConfig);e=new ht(i,e.type,e.timestamp,e.duration)}this.decoder.decode(e.toEncodedVideoChunk()),this.decodeAlphaData(e)}this.currentPacketIndex++}decodeAlphaData(e){if(!e.sideData.alpha||this.mergerCreationFailed){this.pushNullAlphaFrame();return}if(!this.merger)try{this.merger=new Cf}catch(i){console.error("Due to an error, only color data will be decoded.",i),this.mergerCreationFailed=!0,this.decodeAlphaData(e);return}if(!this.alphaDecoder){const i=n=>{if(this.alphaDecoderQueueSize--,this.colorQueue.length>0){const s=this.colorQueue.shift();E(s!==void 0),this.mergeAlpha(s,n)}else this.alphaQueue.push(n);for(this.decodedAlphaChunkCount++;this.nullAlphaFrameQueue.length>0&&this.nullAlphaFrameQueue[0]===this.decodedAlphaChunkCount;)if(this.nullAlphaFrameQueue.shift(),this.colorQueue.length>0){const s=this.colorQueue.shift();E(s!==void 0),this.mergeAlpha(s,null)}else this.alphaQueue.push(null)},a=new Error("Decoding error").stack;this.alphaDecoder=new VideoDecoder({output:n=>{try{i(n)}catch(s){this.onError(s)}},error:n=>{n.stack=a,this.onError(n)}}),this.alphaDecoder.configure(this.decoderConfig)}const t=Rn(this.codec,this.decoderConfig,e.sideData.alpha);if(this.alphaHadKeyframe||(this.alphaHadKeyframe=t==="key"),this.alphaHadKeyframe){if(this.codec==="hevc"&&this.currentAlphaPacketIndex>0&&!this.alphaRaslSkipped){if(this.hasHevcRaslPicture(e.sideData.alpha)){this.pushNullAlphaFrame();return}this.alphaRaslSkipped=!0}this.currentAlphaPacketIndex++,this.alphaDecoder.decode(e.alphaToEncodedVideoChunk(t??e.type)),this.alphaDecoderQueueSize++}else this.pushNullAlphaFrame()}pushNullAlphaFrame(){this.alphaDecoderQueueSize===0?this.alphaQueue.push(null):this.nullAlphaFrameQueue.push(this.decodedAlphaChunkCount+this.alphaDecoderQueueSize)}hasHevcRaslPicture(e){for(const t of Vc(e,this.decoderConfig)){const i=va(e[t.offset]);if(i===Vt.RASL_N||i===Vt.RASL_R)return!0}return!1}sampleHandler(e){if(da()){if(this.sampleQueue.length>0&&e.timestamp>=wt(this.sampleQueue).timestamp){for(const t of this.sampleQueue)this.finalizeAndEmitSample(t);this.sampleQueue.length=0}xo(this.sampleQueue,e,t=>t.timestamp)}else{const t=this.inputTimestamps.shift();E(t!==void 0),e.setTimestamp(t),this.finalizeAndEmitSample(e)}}finalizeAndEmitSample(e){e.setTimestamp(Math.round(e.timestamp*this.timeResolution)/this.timeResolution),e.setDuration(Math.round(e.duration*this.timeResolution)/this.timeResolution),e.setRotation(this.rotation),this.onSample(e)}mergeAlpha(e,t){if(!t){const n=new Wt(e);this.sampleHandler(n);return}E(this.merger),this.merger.update(e,t),e.close(),t.close();const i=new VideoFrame(this.merger.canvas,{timestamp:e.timestamp,duration:e.duration??void 0}),a=new Wt(i);this.sampleHandler(a)}async flush(){if(this.customDecoder?await this.customDecoderCallSerializer.call(()=>this.customDecoder.flush()):(E(this.decoder),await Promise.all([this.decoder.flush(),this.alphaDecoder?.flush()]),this.colorQueue.forEach(e=>e.close()),this.colorQueue.length=0,this.alphaQueue.forEach(e=>e?.close()),this.alphaQueue.length=0,this.alphaHadKeyframe=!1,this.decodedAlphaChunkCount=0,this.alphaDecoderQueueSize=0,this.nullAlphaFrameQueue.length=0,this.currentAlphaPacketIndex=0,this.alphaRaslSkipped=!1),da()){for(const e of this.sampleQueue)this.finalizeAndEmitSample(e);this.sampleQueue.length=0}this.currentPacketIndex=0,this.raslSkipped=!1}close(){this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.close()):(E(this.decoder),this.decoder.close(),this.alphaDecoder?.close(),this.colorQueue.forEach(e=>e.close()),this.colorQueue.length=0,this.alphaQueue.forEach(e=>e?.close()),this.alphaQueue.length=0,this.merger?.close());for(const e of this.sampleQueue)e.close();this.sampleQueue.length=0}}class Cf{constructor(){typeof OffscreenCanvas<"u"?this.canvas=new OffscreenCanvas(300,150):this.canvas=document.createElement("canvas");const e=this.canvas.getContext("webgl2",{premultipliedAlpha:!1});if(!e)throw new Error("Couldn't acquire WebGL 2 context.");this.gl=e,this.program=this.createProgram(),this.vao=this.createVAO(),this.colorTexture=this.createTexture(),this.alphaTexture=this.createTexture(),this.gl.useProgram(this.program),this.gl.uniform1i(this.gl.getUniformLocation(this.program,"u_colorTexture"),0),this.gl.uniform1i(this.gl.getUniformLocation(this.program,"u_alphaTexture"),1)}createProgram(){const e=this.createShader(this.gl.VERTEX_SHADER,`#version 300 es
			in vec2 a_position;
			in vec2 a_texCoord;
			out vec2 v_texCoord;
			
			void main() {
				gl_Position = vec4(a_position, 0.0, 1.0);
				v_texCoord = a_texCoord;
			}
		`),t=this.createShader(this.gl.FRAGMENT_SHADER,`#version 300 es
			precision highp float;
			
			uniform sampler2D u_colorTexture;
			uniform sampler2D u_alphaTexture;
			in vec2 v_texCoord;
			out vec4 fragColor;
			
			void main() {
				vec3 color = texture(u_colorTexture, v_texCoord).rgb;
				float alpha = texture(u_alphaTexture, v_texCoord).r;
				fragColor = vec4(color, alpha);
			}
		`),i=this.gl.createProgram();return this.gl.attachShader(i,e),this.gl.attachShader(i,t),this.gl.linkProgram(i),i}createShader(e,t){const i=this.gl.createShader(e);return this.gl.shaderSource(i,t),this.gl.compileShader(i),i}createVAO(){const e=this.gl.createVertexArray();this.gl.bindVertexArray(e);const t=new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,1,1,1,0]),i=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,i),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.STATIC_DRAW);const a=this.gl.getAttribLocation(this.program,"a_position"),n=this.gl.getAttribLocation(this.program,"a_texCoord");return this.gl.enableVertexAttribArray(a),this.gl.vertexAttribPointer(a,2,this.gl.FLOAT,!1,16,0),this.gl.enableVertexAttribArray(n),this.gl.vertexAttribPointer(n,2,this.gl.FLOAT,!1,16,8),e}createTexture(){const e=this.gl.createTexture();return this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),e}update(e,t){(e.displayWidth!==this.canvas.width||e.displayHeight!==this.canvas.height)&&(this.canvas.width=e.displayWidth,this.canvas.height=e.displayHeight),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.colorTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,this.alphaTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.bindVertexArray(this.vao),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}close(){this.gl.getExtension("WEBGL_lose_context")?.loseContext(),this.gl=null}}class Ys extends Xc{constructor(e){if(!(e instanceof Zi))throw new TypeError("videoTrack must be an InputVideoTrack.");super(),this._track=e}async _createDecoder(e,t){if(!await this._track.canDecode())throw new Error("This video track cannot be decoded by this browser. Make sure to check decodability before using a track.");const i=this._track.codec,a=this._track.rotation,n=await this._track.getDecoderConfig(),s=this._track.timeResolution;return E(i&&n),new Sf(e,t,i,n,a,s)}_createPacketSink(){return new wa(this._track)}async getSample(e){Xr(e);for await(const t of this.mediaSamplesAtTimestamps([e]))return t;throw new Error("Internal error: Iterator returned nothing.")}samples(e=0,t=1/0){return this.mediaSamplesInRange(e,t)}samplesAtTimestamps(e){return this.mediaSamplesAtTimestamps(e)}}class Pf{constructor(e,t={}){if(this._nextCanvasIndex=0,!(e instanceof Zi))throw new TypeError("videoTrack must be an InputVideoTrack.");if(t&&typeof t!="object")throw new TypeError("options must be an object.");if(t.alpha!==void 0&&typeof t.alpha!="boolean")throw new TypeError("options.alpha, when provided, must be a boolean.");if(t.width!==void 0&&(!Number.isInteger(t.width)||t.width<=0))throw new TypeError("options.width, when defined, must be a positive integer.");if(t.height!==void 0&&(!Number.isInteger(t.height)||t.height<=0))throw new TypeError("options.height, when defined, must be a positive integer.");if(t.fit!==void 0&&!["fill","contain","cover"].includes(t.fit))throw new TypeError('options.fit, when provided, must be one of "fill", "contain", or "cover".');if(t.width!==void 0&&t.height!==void 0&&t.fit===void 0)throw new TypeError("When both options.width and options.height are provided, options.fit must also be provided.");if(t.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError("options.rotation, when provided, must be 0, 90, 180 or 270.");if(t.crop!==void 0&&On(t.crop,"options."),t.poolSize!==void 0&&(typeof t.poolSize!="number"||!Number.isInteger(t.poolSize)||t.poolSize<0))throw new TypeError("poolSize must be a non-negative integer.");const i=t.rotation??e.rotation,[a,n]=i%180===0?[e.codedWidth,e.codedHeight]:[e.codedHeight,e.codedWidth],s=t.crop;s&&Dn(s,a,n);let[o,c]=s?[s.width,s.height]:[a,n];const l=o/c;t.width!==void 0&&t.height===void 0?(o=t.width,c=Math.round(o/l)):t.width===void 0&&t.height!==void 0?(c=t.height,o=Math.round(c*l)):t.width!==void 0&&t.height!==void 0&&(o=t.width,c=t.height),this._videoTrack=e,this._alpha=t.alpha??!1,this._width=o,this._height=c,this._rotation=i,this._crop=s,this._fit=t.fit??"fill",this._videoSampleSink=new Ys(e),this._canvasPool=Array.from({length:t.poolSize??0},()=>null)}_videoSampleToWrappedCanvas(e){let t=this._canvasPool[this._nextCanvasIndex],i=!1;t||(typeof document<"u"?(t=document.createElement("canvas"),t.width=this._width,t.height=this._height):t=new OffscreenCanvas(this._width,this._height),this._canvasPool.length>0&&(this._canvasPool[this._nextCanvasIndex]=t),i=!0),this._canvasPool.length>0&&(this._nextCanvasIndex=(this._nextCanvasIndex+1)%this._canvasPool.length);const a=t.getContext("2d",{alpha:this._alpha||Wi()});E(a),a.resetTransform(),i||(!this._alpha&&Wi()?(a.fillStyle="black",a.fillRect(0,0,this._width,this._height)):a.clearRect(0,0,this._width,this._height)),e.drawWithFit(a,{fit:this._fit,rotation:this._rotation,crop:this._crop});const n={canvas:t,timestamp:e.timestamp,duration:e.duration};return e.close(),n}async getCanvas(e){Xr(e);const t=await this._videoSampleSink.getSample(e);return t&&this._videoSampleToWrappedCanvas(t)}canvases(e=0,t=1/0){return _o(this._videoSampleSink.samples(e,t),i=>this._videoSampleToWrappedCanvas(i))}canvasesAtTimestamps(e){return _o(this._videoSampleSink.samplesAtTimestamps(e),t=>t&&this._videoSampleToWrappedCanvas(t))}}class Ef extends Nn{constructor(e,t,i,a){super(e,t),this.decoder=null,this.customDecoder=null,this.customDecoderCallSerializer=new os,this.customDecoderQueueSize=0,this.currentTimestamp=null;const n=o=>{(this.currentTimestamp===null||Math.abs(o.timestamp-this.currentTimestamp)>=o.duration)&&(this.currentTimestamp=o.timestamp);const c=this.currentTimestamp;if(this.currentTimestamp+=o.duration,o.numberOfFrames===0){o.close();return}const l=a.sampleRate;o.setTimestamp(Math.round(c*l)/l),e(o)},s=qc.find(o=>o.supports(i,a));if(s)this.customDecoder=new s,this.customDecoder.codec=i,this.customDecoder.config=a,this.customDecoder.onSample=o=>{if(!(o instanceof cr))throw new TypeError("The argument passed to onSample must be an AudioSample.");n(o)},this.customDecoderCallSerializer.call(()=>this.customDecoder.init());else{const o=new Error("Decoding error").stack;this.decoder=new AudioDecoder({output:c=>{try{n(new cr(c))}catch(l){this.onError(l)}},error:c=>{c.stack=o,this.onError(c)}}),this.decoder.configure(a)}}getDecodeQueueSize(){return this.customDecoder?this.customDecoderQueueSize:(E(this.decoder),this.decoder.decodeQueueSize)}decode(e){this.customDecoder?(this.customDecoderQueueSize++,this.customDecoderCallSerializer.call(()=>this.customDecoder.decode(e)).then(()=>this.customDecoderQueueSize--)):(E(this.decoder),this.decoder.decode(e.toEncodedAudioChunk()))}flush(){return this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.flush()):(E(this.decoder),this.decoder.flush())}close(){this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.close()):(E(this.decoder),this.decoder.close())}}class If extends Nn{constructor(e,t,i){super(e,t),this.decoderConfig=i,this.currentTimestamp=null,E(Ot.includes(i.codec)),this.codec=i.codec;const{dataType:a,sampleSize:n,littleEndian:s}=Ur(this.codec);switch(this.inputSampleSize=n,n){case 1:a==="unsigned"?this.readInputValue=(o,c)=>o.getUint8(c)-2**7:a==="signed"?this.readInputValue=(o,c)=>o.getInt8(c):a==="ulaw"?this.readInputValue=(o,c)=>bf(o.getUint8(c)):a==="alaw"?this.readInputValue=(o,c)=>kf(o.getUint8(c)):E(!1);break;case 2:a==="unsigned"?this.readInputValue=(o,c)=>o.getUint16(c,s)-2**15:a==="signed"?this.readInputValue=(o,c)=>o.getInt16(c,s):E(!1);break;case 3:a==="unsigned"?this.readInputValue=(o,c)=>ns(o,c,s)-2**23:a==="signed"?this.readInputValue=(o,c)=>zu(o,c,s):E(!1);break;case 4:a==="unsigned"?this.readInputValue=(o,c)=>o.getUint32(c,s)-2**31:a==="signed"?this.readInputValue=(o,c)=>o.getInt32(c,s):a==="float"?this.readInputValue=(o,c)=>o.getFloat32(c,s):E(!1);break;case 8:a==="float"?this.readInputValue=(o,c)=>o.getFloat64(c,s):E(!1);break;default:Tr(n),E(!1)}switch(n){case 1:a==="ulaw"||a==="alaw"?(this.outputSampleSize=2,this.outputFormat="s16",this.writeOutputValue=(o,c,l)=>o.setInt16(c,l,!0)):(this.outputSampleSize=1,this.outputFormat="u8",this.writeOutputValue=(o,c,l)=>o.setUint8(c,l+2**7));break;case 2:this.outputSampleSize=2,this.outputFormat="s16",this.writeOutputValue=(o,c,l)=>o.setInt16(c,l,!0);break;case 3:this.outputSampleSize=4,this.outputFormat="s32",this.writeOutputValue=(o,c,l)=>o.setInt32(c,l<<8,!0);break;case 4:this.outputSampleSize=4,a==="float"?(this.outputFormat="f32",this.writeOutputValue=(o,c,l)=>o.setFloat32(c,l,!0)):(this.outputFormat="s32",this.writeOutputValue=(o,c,l)=>o.setInt32(c,l,!0));break;case 8:this.outputSampleSize=4,this.outputFormat="f32",this.writeOutputValue=(o,c,l)=>o.setFloat32(c,l,!0);break;default:Tr(n),E(!1)}}getDecodeQueueSize(){return 0}decode(e){const t=kt(e.data),i=e.byteLength/this.decoderConfig.numberOfChannels/this.inputSampleSize,a=i*this.decoderConfig.numberOfChannels*this.outputSampleSize,n=new ArrayBuffer(a),s=new DataView(n);for(let d=0;d<i*this.decoderConfig.numberOfChannels;d++){const u=d*this.inputSampleSize,f=d*this.outputSampleSize,h=this.readInputValue(t,u);this.writeOutputValue(s,f,h)}const o=i/this.decoderConfig.sampleRate;(this.currentTimestamp===null||Math.abs(e.timestamp-this.currentTimestamp)>=o)&&(this.currentTimestamp=e.timestamp);const c=this.currentTimestamp;this.currentTimestamp+=o;const l=new cr({format:this.outputFormat,data:n,numberOfChannels:this.decoderConfig.numberOfChannels,sampleRate:this.decoderConfig.sampleRate,numberOfFrames:i,timestamp:c});this.onSample(l)}async flush(){}close(){}}class Ro extends Xc{constructor(e){if(!(e instanceof Cr))throw new TypeError("audioTrack must be an InputAudioTrack.");super(),this._track=e}async _createDecoder(e,t){if(!await this._track.canDecode())throw new Error("This audio track cannot be decoded by this browser. Make sure to check decodability before using a track.");const i=this._track.codec,a=await this._track.getDecoderConfig();return E(i&&a),Ot.includes(a.codec)?new If(e,t,a):new Ef(e,t,i,a)}_createPacketSink(){return new wa(this._track)}async getSample(e){Xr(e);for await(const t of this.mediaSamplesAtTimestamps([e]))return t;throw new Error("Internal error: Iterator returned nothing.")}samples(e=0,t=1/0){return this.mediaSamplesInRange(e,t)}samplesAtTimestamps(e){return this.mediaSamplesAtTimestamps(e)}}class Un{constructor(e,t){this.input=e,this._backing=t}isVideoTrack(){return this instanceof Zi}isAudioTrack(){return this instanceof Cr}get id(){return this._backing.getId()}get internalCodecId(){return this._backing.getInternalCodecId()}get languageCode(){return this._backing.getLanguageCode()}get name(){return this._backing.getName()}get timeResolution(){return this._backing.getTimeResolution()}get disposition(){return this._backing.getDisposition()}getFirstTimestamp(){return this._backing.getFirstTimestamp()}computeDuration(){return this._backing.computeDuration()}async computePacketStats(e=1/0){const t=new wa(this);let i=1/0,a=-1/0,n=0,s=0;for await(const o of t.packets(void 0,void 0,{metadataOnly:!0})){if(n>=e&&o.timestamp>=a)break;i=Math.min(i,o.timestamp),a=Math.max(a,o.timestamp+o.duration),n++,s+=o.byteLength}return{packetCount:n,averagePacketRate:n?Number((n/(a-i)).toPrecision(16)):0,averageBitrate:n?Number((8*s/(a-i)).toPrecision(16)):0}}}class Zi extends Un{constructor(e,t){super(e,t),this._backing=t}get type(){return"video"}get codec(){return this._backing.getCodec()}get codedWidth(){return this._backing.getCodedWidth()}get codedHeight(){return this._backing.getCodedHeight()}get rotation(){return this._backing.getRotation()}get displayWidth(){return this._backing.getRotation()%180===0?this._backing.getCodedWidth():this._backing.getCodedHeight()}get displayHeight(){return this._backing.getRotation()%180===0?this._backing.getCodedHeight():this._backing.getCodedWidth()}getColorSpace(){return this._backing.getColorSpace()}async hasHighDynamicRange(){const e=await this._backing.getColorSpace();return e.primaries==="bt2020"||e.primaries==="smpte432"||e.transfer==="pg"||e.transfer==="hlg"||e.matrix==="bt2020-ncl"}canBeTransparent(){return this._backing.canBeTransparent()}getDecoderConfig(){return this._backing.getDecoderConfig()}async getCodecParameterString(){return(await this._backing.getDecoderConfig())?.codec??null}async canDecode(){try{const e=await this._backing.getDecoderConfig();if(!e)return!1;const t=this._backing.getCodec();return E(t!==null),jc.some(a=>a.supports(t,e))?!0:typeof VideoDecoder>"u"?!1:(await VideoDecoder.isConfigSupported(e)).supported===!0}catch(e){return console.error("Error during decodability check:",e),!1}}async determinePacketType(e){if(!(e instanceof ht))throw new TypeError("packet must be an EncodedPacket.");if(e.isMetadataOnly)throw new TypeError("packet must not be metadata-only to determine its type.");if(this.codec===null)return null;const t=await this.getDecoderConfig();return E(t),Rn(this.codec,t,e.data)}}class Cr extends Un{constructor(e,t){super(e,t),this._backing=t}get type(){return"audio"}get codec(){return this._backing.getCodec()}get numberOfChannels(){return this._backing.getNumberOfChannels()}get sampleRate(){return this._backing.getSampleRate()}getDecoderConfig(){return this._backing.getDecoderConfig()}async getCodecParameterString(){return(await this._backing.getDecoderConfig())?.codec??null}async canDecode(){try{const e=await this._backing.getDecoderConfig();if(!e)return!1;const t=this._backing.getCodec();return E(t!==null),qc.some(i=>i.supports(t,e))||e.codec.startsWith("pcm-")?!0:typeof AudioDecoder>"u"?!1:(await AudioDecoder.isConfigSupported(e)).supported===!0}catch(e){return console.error("Error during decodability check:",e),!1}}async determinePacketType(e){if(!(e instanceof ht))throw new TypeError("packet must be an EncodedPacket.");return this.codec===null?null:"key"}}const Zc=r=>{let t=(r.hasVideo?"video/":r.hasAudio?"audio/":"application/")+(r.isQuickTime?"quicktime":"mp4");if(r.codecStrings.length>0){const i=[...new Set(r.codecStrings)];t+=`; codecs="${i.join(", ")}"`}return t};const Mr=8,ci=16,jr=r=>{let e=ve(r);const t=Dt(r,4);let i=8;e===1&&(e=mr(r),i=16);const n=e-i;return n<0?null:{name:t,totalSize:e,headerSize:i,contentSize:n}},ai=r=>di(r)/65536,Ts=r=>di(r)/1073741824,Ss=r=>{let e=0;for(let t=0;t<4;t++){e<<=7;const i=Se(r);if(e|=i&127,(i&128)===0)break}return e},gr=r=>{let e=zt(r);return r.skip(2),e=Math.min(e,r.remainingLength),lr.decode(Me(r,e))},Af=r=>{const e=jr(r);if(!e||e.name!=="data"||r.remainingLength<8)return null;const t=ve(r);r.skip(4);const i=Me(r,e.contentSize-8);switch(t){case 1:return lr.decode(i);case 2:return new TextDecoder("utf-16be").decode(i);case 13:return new Di(i,"image/jpeg");case 14:return new Di(i,"image/png");case 27:return new Di(i,"image/bmp");default:return i}};class Ff extends ei{constructor(e){super(e),this.moovSlice=null,this.currentTrack=null,this.tracks=[],this.metadataPromise=null,this.movieTimescale=-1,this.movieDurationInTimescale=-1,this.isQuickTime=!1,this.metadataTags={},this.currentMetadataKeys=null,this.isFragmented=!1,this.fragmentTrackDefaults=[],this.currentFragment=null,this.lastReadFragment=null,this.reader=e._reader}async computeDuration(){const e=await this.getTracks(),t=await Promise.all(e.map(i=>i.computeDuration()));return Math.max(0,...t)}async getTracks(){return await this.readMetadata(),this.tracks.map(e=>e.inputTrack)}async getMimeType(){await this.readMetadata();const e=await Promise.all(this.tracks.map(t=>t.inputTrack.getCodecParameterString()));return Zc({isQuickTime:this.isQuickTime,hasVideo:this.tracks.some(t=>t.info?.type==="video"),hasAudio:this.tracks.some(t=>t.info?.type==="audio"),codecStrings:e.filter(Boolean)})}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}readMetadata(){return this.metadataPromise??=(async()=>{let e=0;for(;;){let t=this.reader.requestSliceRange(e,Mr,ci);if(t instanceof Promise&&(t=await t),!t)break;const i=e,a=jr(t);if(!a)break;if(a.name==="ftyp"){const n=Dt(t,4);this.isQuickTime=n==="qt  "}else if(a.name==="moov"){let n=this.reader.requestSlice(t.filePos,a.contentSize);if(n instanceof Promise&&(n=await n),!n)break;this.moovSlice=n,this.readContiguousBoxes(this.moovSlice),this.tracks.sort((s,o)=>Number(o.disposition.default)-Number(s.disposition.default));for(const s of this.tracks){const o=s.editListPreviousSegmentDurations/this.movieTimescale;s.editListOffset-=Math.round(o*s.timescale)}break}e=i+a.totalSize}if(this.isFragmented&&this.reader.fileSize!==null){let t=this.reader.requestSlice(this.reader.fileSize-4,4);t instanceof Promise&&(t=await t),E(t);const i=ve(t),a=this.reader.fileSize-i;if(a>=0&&a<=this.reader.fileSize-ci){let n=this.reader.requestSliceRange(a,Mr,ci);if(n instanceof Promise&&(n=await n),n){const s=jr(n);if(s&&s.name==="mfra"){let o=this.reader.requestSlice(n.filePos,s.contentSize);o instanceof Promise&&(o=await o),o&&this.readContiguousBoxes(o)}}}}})()}getSampleTableForTrack(e){if(e.sampleTable)return e.sampleTable;const t={sampleTimingEntries:[],sampleCompositionTimeOffsets:[],sampleSizes:[],keySampleIndices:null,chunkOffsets:[],sampleToChunk:[],presentationTimestamps:null,presentationTimestampIndexMap:null};e.sampleTable=t,E(this.moovSlice);const i=this.moovSlice.slice(e.sampleTableByteOffset);if(this.currentTrack=e,this.traverseBox(i),this.currentTrack=null,e.info?.type==="audio"&&e.info.codec&&Ot.includes(e.info.codec)&&t.sampleCompositionTimeOffsets.length===0){E(e.info?.type==="audio");const n=Ur(e.info.codec),s=[],o=[];for(let c=0;c<t.sampleToChunk.length;c++){const l=t.sampleToChunk[c],d=t.sampleToChunk[c+1],u=(d?d.startChunkIndex:t.chunkOffsets.length)-l.startChunkIndex;for(let f=0;f<u;f++){const h=l.startSampleIndex+f*l.samplesPerChunk,g=h+l.samplesPerChunk,m=rt(t.sampleTimingEntries,h,z=>z.startIndex),p=t.sampleTimingEntries[m],v=rt(t.sampleTimingEntries,g,z=>z.startIndex),b=t.sampleTimingEntries[v],w=p.startDecodeTimestamp+(h-p.startIndex)*p.delta,T=b.startDecodeTimestamp+(g-b.startIndex)*b.delta-w,A=wt(s);A&&A.delta===T?A.count++:s.push({startIndex:l.startChunkIndex+f,startDecodeTimestamp:w,count:1,delta:T});const B=l.samplesPerChunk*n.sampleSize*e.info.numberOfChannels;o.push(B)}l.startSampleIndex=l.startChunkIndex,l.samplesPerChunk=1}t.sampleTimingEntries=s,t.sampleSizes=o}if(t.sampleCompositionTimeOffsets.length>0){t.presentationTimestamps=[];for(const n of t.sampleTimingEntries)for(let s=0;s<n.count;s++)t.presentationTimestamps.push({presentationTimestamp:n.startDecodeTimestamp+s*n.delta,sampleIndex:n.startIndex+s});for(const n of t.sampleCompositionTimeOffsets)for(let s=0;s<n.count;s++){const o=n.startIndex+s,c=t.presentationTimestamps[o];c&&(c.presentationTimestamp+=n.offset)}t.presentationTimestamps.sort((n,s)=>n.presentationTimestamp-s.presentationTimestamp),t.presentationTimestampIndexMap=Array(t.presentationTimestamps.length).fill(-1);for(let n=0;n<t.presentationTimestamps.length;n++)t.presentationTimestampIndexMap[t.presentationTimestamps[n].sampleIndex]=n}return t}async readFragment(e){if(this.lastReadFragment?.moofOffset===e)return this.lastReadFragment;let t=this.reader.requestSliceRange(e,Mr,ci);t instanceof Promise&&(t=await t),E(t);const i=jr(t);E(i?.name==="moof");let a=this.reader.requestSlice(e,i.totalSize);a instanceof Promise&&(a=await a),E(a),this.traverseBox(a);const n=this.lastReadFragment;E(n&&n.moofOffset===e);for(const[,s]of n.trackData){const o=s.track,{fragmentPositionCache:c}=o;if(!s.startTimestampIsFinal){const d=o.fragmentLookupTable.find(u=>u.moofOffset===n.moofOffset);if(d)Cs(s,d.timestamp);else{const u=rt(c,n.moofOffset-1,f=>f.moofOffset);if(u!==-1){const f=c[u];Cs(s,f.endTimestamp)}}s.startTimestampIsFinal=!0}const l=rt(c,s.startTimestamp,d=>d.startTimestamp);(l===-1||c[l].moofOffset!==n.moofOffset)&&c.splice(l+1,0,{moofOffset:n.moofOffset,startTimestamp:s.startTimestamp,endTimestamp:s.endTimestamp})}return n}readContiguousBoxes(e){const t=e.filePos;for(;e.filePos-t<=e.length-Mr&&this.traverseBox(e););}*iterateContiguousBoxes(e){const t=e.filePos;for(;e.filePos-t<=e.length-Mr;){const i=e.filePos,a=jr(e);if(!a)break;yield{boxInfo:a,slice:e},e.filePos=i+a.totalSize}}traverseBox(e){const t=e.filePos,i=jr(e);if(!i)return!1;const a=e.filePos,n=t+i.totalSize;switch(i.name){case"mdia":case"minf":case"dinf":case"mfra":case"edts":this.readContiguousBoxes(e.slice(a,i.contentSize));break;case"mvhd":{const s=Se(e);e.skip(3),s===1?(e.skip(16),this.movieTimescale=ve(e),this.movieDurationInTimescale=mr(e)):(e.skip(8),this.movieTimescale=ve(e),this.movieDurationInTimescale=ve(e))}break;case"trak":{const s={id:-1,demuxer:this,inputTrack:null,disposition:{...Jr},info:null,timescale:-1,durationInMovieTimescale:-1,durationInMediaTimescale:-1,rotation:0,internalCodecId:null,name:null,languageCode:Gt,sampleTableByteOffset:-1,sampleTable:null,fragmentLookupTable:[],currentFragmentState:null,fragmentPositionCache:[],editListPreviousSegmentDurations:0,editListOffset:0};if(this.currentTrack=s,this.readContiguousBoxes(e.slice(a,i.contentSize)),s.id!==-1&&s.timescale!==-1&&s.info!==null){if(s.info.type==="video"&&s.info.width!==-1){const o=s;s.inputTrack=new Zi(this.input,new Bf(o)),this.tracks.push(s)}else if(s.info.type==="audio"&&s.info.numberOfChannels!==-1){const o=s;s.inputTrack=new Cr(this.input,new zf(o)),this.tracks.push(s)}}this.currentTrack=null}break;case"tkhd":{const s=this.currentTrack;if(!s)break;const o=Se(e),l=!!(xi(e)&1);if(s.disposition.default=l,o===0)e.skip(8),s.id=ve(e),e.skip(4),s.durationInMovieTimescale=ve(e);else if(o===1)e.skip(16),s.id=ve(e),e.skip(4),s.durationInMovieTimescale=mr(e);else throw new Error(`Incorrect track header version ${o}.`);e.skip(16);const d=[ai(e),ai(e),Ts(e),ai(e),ai(e),Ts(e),ai(e),ai(e),Ts(e)],u=as(Qa(Of(d),90));E(u===0||u===90||u===180||u===270),s.rotation=u}break;case"elst":{const s=this.currentTrack;if(!s)break;const o=Se(e);e.skip(3);let c=!1,l=0;const d=ve(e);for(let u=0;u<d;u++){const f=o===1?mr(e):ve(e),h=o===1?Xh(e):di(e),g=ai(e);if(f!==0){if(c){console.warn("Unsupported edit list: multiple edits are not currently supported. Only using first edit.");break}if(h===-1){l+=f;continue}if(g!==1){console.warn("Unsupported edit list entry: media rate must be 1.");break}s.editListPreviousSegmentDurations=l,s.editListOffset=h,c=!0}}}break;case"mdhd":{const s=this.currentTrack;if(!s)break;const o=Se(e);e.skip(3),o===0?(e.skip(8),s.timescale=ve(e),s.durationInMediaTimescale=ve(e)):o===1&&(e.skip(16),s.timescale=ve(e),s.durationInMediaTimescale=mr(e));let c=zt(e);if(c>0){s.languageCode="";for(let l=0;l<3;l++)s.languageCode=String.fromCharCode(96+(c&31))+s.languageCode,c>>=5;ga(s.languageCode)||(s.languageCode=Gt)}}break;case"hdlr":{const s=this.currentTrack;if(!s)break;e.skip(8);const o=Dt(e,4);o==="vide"?s.info={type:"video",width:-1,height:-1,codec:null,codecDescription:null,colorSpace:null,avcType:null,avcCodecInfo:null,hevcCodecInfo:null,vp9CodecInfo:null,av1CodecInfo:null}:o==="soun"&&(s.info={type:"audio",numberOfChannels:-1,sampleRate:-1,codec:null,codecDescription:null,aacCodecInfo:null})}break;case"stbl":{const s=this.currentTrack;if(!s)break;s.sampleTableByteOffset=t,this.readContiguousBoxes(e.slice(a,i.contentSize))}break;case"stsd":{const s=this.currentTrack;if(!s||s.info===null||s.sampleTable)break;const o=Se(e);e.skip(3);const c=ve(e);for(let l=0;l<c;l++){const d=e.filePos,u=jr(e);if(!u)break;s.internalCodecId=u.name;const f=u.name.toLowerCase();if(s.info.type==="video")f==="avc1"||f==="avc3"?(s.info.codec="avc",s.info.avcType=f==="avc1"?1:3):f==="hvc1"||f==="hev1"?s.info.codec="hevc":f==="vp08"?s.info.codec="vp8":f==="vp09"?s.info.codec="vp9":f==="av01"?s.info.codec="av1":console.warn(`Unsupported video codec (sample entry type '${u.name}').`),e.skip(24),s.info.width=zt(e),s.info.height=zt(e),e.skip(50),this.readContiguousBoxes(e.slice(e.filePos,d+u.totalSize-e.filePos));else{f==="mp4a"||(f==="opus"?s.info.codec="opus":f==="flac"?s.info.codec="flac":f==="twos"||f==="sowt"||f==="raw "||f==="in24"||f==="in32"||f==="fl32"||f==="fl64"||f==="lpcm"||f==="ipcm"||f==="fpcm"||(f==="ulaw"?s.info.codec="ulaw":f==="alaw"?s.info.codec="alaw":console.warn(`Unsupported audio codec (sample entry type '${u.name}').`))),e.skip(8);const h=zt(e);e.skip(6);let g=zt(e),m=zt(e);e.skip(4);let p=ve(e)/65536;if(o===0&&h>0){if(h===1)e.skip(4),m=8*ve(e),e.skip(8);else if(h===2){e.skip(4),p=ml(e),g=ve(e),e.skip(4),m=ve(e);const v=ve(e);if(e.skip(8),f==="lpcm"){const b=m+7>>3,w=!!(v&1),x=!!(v&2),T=v&4?-1:0;m>0&&m<=64&&(w?m===32&&(s.info.codec=x?"pcm-f32be":"pcm-f32"):T&1<<b-1?b===1?s.info.codec="pcm-s8":b===2?s.info.codec=x?"pcm-s16be":"pcm-s16":b===3?s.info.codec=x?"pcm-s24be":"pcm-s24":b===4&&(s.info.codec=x?"pcm-s32be":"pcm-s32"):b===1&&(s.info.codec="pcm-u8")),s.info.codec===null&&console.warn("Unsupported PCM format.")}}}s.info.codec==="opus"&&(p=Ta),s.info.numberOfChannels=g,s.info.sampleRate=p,f==="twos"?m===8?s.info.codec="pcm-s8":m===16?s.info.codec="pcm-s16be":(console.warn(`Unsupported sample size ${m} for codec 'twos'.`),s.info.codec=null):f==="sowt"?m===8?s.info.codec="pcm-s8":m===16?s.info.codec="pcm-s16":(console.warn(`Unsupported sample size ${m} for codec 'sowt'.`),s.info.codec=null):f==="raw "?s.info.codec="pcm-u8":f==="in24"?s.info.codec="pcm-s24be":f==="in32"?s.info.codec="pcm-s32be":f==="fl32"?s.info.codec="pcm-f32be":f==="fl64"?s.info.codec="pcm-f64be":f==="ipcm"?s.info.codec="pcm-s16be":f==="fpcm"&&(s.info.codec="pcm-f32be"),this.readContiguousBoxes(e.slice(e.filePos,d+u.totalSize-e.filePos))}}}break;case"avcC":{const s=this.currentTrack;if(!s)break;E(s.info),s.info.codecDescription=Me(e,i.contentSize)}break;case"hvcC":{const s=this.currentTrack;if(!s)break;E(s.info),s.info.codecDescription=Me(e,i.contentSize)}break;case"vpcC":{const s=this.currentTrack;if(!s)break;E(s.info?.type==="video"),e.skip(4);const o=Se(e),c=Se(e),l=Se(e),d=l>>4,u=l>>1&7,f=l&1,h=Se(e),g=Se(e),m=Se(e);s.info.vp9CodecInfo={profile:o,level:c,bitDepth:d,chromaSubsampling:u,videoFullRangeFlag:f,colourPrimaries:h,transferCharacteristics:g,matrixCoefficients:m}}break;case"av1C":{const s=this.currentTrack;if(!s)break;E(s.info?.type==="video"),e.skip(1);const o=Se(e),c=o>>5,l=o&31,d=Se(e),u=d>>7,f=d>>6&1,h=d>>5&1,g=d>>4&1,m=d>>3&1,p=d>>2&1,v=d&3,b=c===2&&f?h?12:10:f?10:8;s.info.av1CodecInfo={profile:c,level:l,tier:u,bitDepth:b,monochrome:g,chromaSubsamplingX:m,chromaSubsamplingY:p,chromaSamplePosition:v}}break;case"colr":{const s=this.currentTrack;if(!s||(E(s.info?.type==="video"),Dt(e,4)!=="nclx"))break;const c=zt(e),l=zt(e),d=zt(e),u=!!(Se(e)&128);s.info.colorSpace={primaries:qa[c],transfer:Ka[l],matrix:Ga[d],fullRange:u}}break;case"wave":this.readContiguousBoxes(e.slice(a,i.contentSize));break;case"esds":{const s=this.currentTrack;if(!s)break;E(s.info?.type==="audio"),e.skip(4);const o=Se(e);E(o===3),Ss(e),e.skip(2);const c=Se(e),l=(c&128)!==0,d=(c&64)!==0,u=(c&32)!==0;if(l&&e.skip(2),d){const p=Se(e);e.skip(p)}u&&e.skip(2);const f=Se(e);E(f===4);const h=Ss(e),g=e.filePos,m=Se(e);if(m===64||m===103?(s.info.codec="aac",s.info.aacCodecInfo={isMpeg2:m===103,objectType:null}):m===105||m===107?s.info.codec="mp3":m===221?s.info.codec="vorbis":console.warn(`Unsupported audio codec (objectTypeIndication ${m}) - discarding track.`),e.skip(12),h>e.filePos-g){const p=Se(e);E(p===5);const v=Ss(e);if(s.info.codecDescription=Me(e,v),s.info.codec==="aac"){const b=In(s.info.codecDescription);b.numberOfChannels!==null&&(s.info.numberOfChannels=b.numberOfChannels),b.sampleRate!==null&&(s.info.sampleRate=b.sampleRate)}}}break;case"enda":{const s=this.currentTrack;if(!s)break;E(s.info?.type==="audio"),zt(e)&255&&(s.info.codec==="pcm-s16be"?s.info.codec="pcm-s16":s.info.codec==="pcm-s24be"?s.info.codec="pcm-s24":s.info.codec==="pcm-s32be"?s.info.codec="pcm-s32":s.info.codec==="pcm-f32be"?s.info.codec="pcm-f32":s.info.codec==="pcm-f64be"&&(s.info.codec="pcm-f64"))}break;case"pcmC":{const s=this.currentTrack;if(!s)break;E(s.info?.type==="audio"),e.skip(4);const c=!!(Se(e)&1),l=Se(e);s.info.codec==="pcm-s16be"?c?l===16?s.info.codec="pcm-s16":l===24?s.info.codec="pcm-s24":l===32?s.info.codec="pcm-s32":(console.warn(`Invalid ipcm sample size ${l}.`),s.info.codec=null):l===16?s.info.codec="pcm-s16be":l===24?s.info.codec="pcm-s24be":l===32?s.info.codec="pcm-s32be":(console.warn(`Invalid ipcm sample size ${l}.`),s.info.codec=null):s.info.codec==="pcm-f32be"&&(c?l===32?s.info.codec="pcm-f32":l===64?s.info.codec="pcm-f64":(console.warn(`Invalid fpcm sample size ${l}.`),s.info.codec=null):l===32?s.info.codec="pcm-f32be":l===64?s.info.codec="pcm-f64be":(console.warn(`Invalid fpcm sample size ${l}.`),s.info.codec=null));break}case"dOps":{const s=this.currentTrack;if(!s)break;E(s.info?.type==="audio"),e.skip(1);const o=Se(e),c=zt(e),l=ve(e),d=on(e),u=Se(e);let f;u!==0?f=Me(e,2+o):f=new Uint8Array(0);const h=new Uint8Array(19+f.byteLength),g=new DataView(h.buffer);g.setUint32(0,1332770163,!1),g.setUint32(4,1214603620,!1),g.setUint8(8,1),g.setUint8(9,o),g.setUint16(10,c,!0),g.setUint32(12,l,!0),g.setInt16(16,d,!0),g.setUint8(18,u),h.set(f,19),s.info.codecDescription=h,s.info.numberOfChannels=o}break;case"dfLa":{const s=this.currentTrack;if(!s)break;E(s.info?.type==="audio"),e.skip(4);const o=127,c=128,l=e.filePos;for(;e.filePos<n;){const g=Se(e),m=xi(e);if((g&o)===Ni.STREAMINFO){e.skip(10);const v=ve(e),b=v>>>12,w=(v>>9&7)+1;s.info.sampleRate=b,s.info.numberOfChannels=w,e.skip(20)}else e.skip(m);if(g&c)break}const d=e.filePos;e.filePos=l;const u=Me(e,d-l),f=new Uint8Array(4+u.byteLength);new DataView(f.buffer).setUint32(0,1716281667,!1),f.set(u,4),s.info.codecDescription=f}break;case"stts":{const s=this.currentTrack;if(!s||!s.sampleTable)break;e.skip(4);const o=ve(e);let c=0,l=0;for(let d=0;d<o;d++){const u=ve(e),f=ve(e);s.sampleTable.sampleTimingEntries.push({startIndex:c,startDecodeTimestamp:l,count:u,delta:f}),c+=u,l+=u*f}}break;case"ctts":{const s=this.currentTrack;if(!s||!s.sampleTable)break;e.skip(4);const o=ve(e);let c=0;for(let l=0;l<o;l++){const d=ve(e),u=di(e);s.sampleTable.sampleCompositionTimeOffsets.push({startIndex:c,count:d,offset:u}),c+=d}}break;case"stsz":{const s=this.currentTrack;if(!s||!s.sampleTable)break;e.skip(4);const o=ve(e),c=ve(e);if(o===0)for(let l=0;l<c;l++){const d=ve(e);s.sampleTable.sampleSizes.push(d)}else s.sampleTable.sampleSizes.push(o)}break;case"stz2":{const s=this.currentTrack;if(!s||!s.sampleTable)break;e.skip(4),e.skip(3);const o=Se(e),c=ve(e),l=Me(e,Math.ceil(c*o/8)),d=new ft(l);for(let u=0;u<c;u++){const f=d.readBits(o);s.sampleTable.sampleSizes.push(f)}}break;case"stss":{const s=this.currentTrack;if(!s||!s.sampleTable)break;e.skip(4),s.sampleTable.keySampleIndices=[];const o=ve(e);for(let c=0;c<o;c++){const l=ve(e)-1;s.sampleTable.keySampleIndices.push(l)}s.sampleTable.keySampleIndices[0]!==0&&s.sampleTable.keySampleIndices.unshift(0)}break;case"stsc":{const s=this.currentTrack;if(!s||!s.sampleTable)break;e.skip(4);const o=ve(e);for(let l=0;l<o;l++){const d=ve(e)-1,u=ve(e),f=ve(e);s.sampleTable.sampleToChunk.push({startSampleIndex:-1,startChunkIndex:d,samplesPerChunk:u,sampleDescriptionIndex:f})}let c=0;for(let l=0;l<s.sampleTable.sampleToChunk.length;l++)if(s.sampleTable.sampleToChunk[l].startSampleIndex=c,l<s.sampleTable.sampleToChunk.length-1){const u=s.sampleTable.sampleToChunk[l+1].startChunkIndex-s.sampleTable.sampleToChunk[l].startChunkIndex;c+=u*s.sampleTable.sampleToChunk[l].samplesPerChunk}}break;case"stco":{const s=this.currentTrack;if(!s||!s.sampleTable)break;e.skip(4);const o=ve(e);for(let c=0;c<o;c++){const l=ve(e);s.sampleTable.chunkOffsets.push(l)}}break;case"co64":{const s=this.currentTrack;if(!s||!s.sampleTable)break;e.skip(4);const o=ve(e);for(let c=0;c<o;c++){const l=mr(e);s.sampleTable.chunkOffsets.push(l)}}break;case"mvex":this.isFragmented=!0,this.readContiguousBoxes(e.slice(a,i.contentSize));break;case"mehd":{const s=Se(e);e.skip(3);const o=s===1?mr(e):ve(e);this.movieDurationInTimescale=o}break;case"trex":{e.skip(4);const s=ve(e),o=ve(e),c=ve(e),l=ve(e),d=ve(e);this.fragmentTrackDefaults.push({trackId:s,defaultSampleDescriptionIndex:o,defaultSampleDuration:c,defaultSampleSize:l,defaultSampleFlags:d})}break;case"tfra":{const s=Se(e);e.skip(3);const o=ve(e),c=this.tracks.find(b=>b.id===o);if(!c)break;const l=ve(e),d=(l&48)>>4,u=(l&12)>>2,f=l&3,h=[Se,zt,xi,ve],g=h[d],m=h[u],p=h[f],v=ve(e);for(let b=0;b<v;b++){const w=s===1?mr(e):ve(e),x=s===1?mr(e):ve(e);g(e),m(e),p(e),c.fragmentLookupTable.push({timestamp:w,moofOffset:x})}c.fragmentLookupTable.sort((b,w)=>b.timestamp-w.timestamp);for(let b=0;b<c.fragmentLookupTable.length-1;b++){const w=c.fragmentLookupTable[b],x=c.fragmentLookupTable[b+1];w.timestamp===x.timestamp&&(c.fragmentLookupTable.splice(b+1,1),b--)}}break;case"moof":this.currentFragment={moofOffset:t,moofSize:i.totalSize,implicitBaseDataOffset:t,trackData:new Map},this.readContiguousBoxes(e.slice(a,i.contentSize)),this.lastReadFragment=this.currentFragment,this.currentFragment=null;break;case"traf":if(E(this.currentFragment),this.readContiguousBoxes(e.slice(a,i.contentSize)),this.currentTrack){const s=this.currentFragment.trackData.get(this.currentTrack.id);if(s){const{currentFragmentState:o}=this.currentTrack;E(o),o.startTimestamp!==null&&(Cs(s,o.startTimestamp),s.startTimestampIsFinal=!0)}this.currentTrack.currentFragmentState=null,this.currentTrack=null}break;case"tfhd":{E(this.currentFragment),e.skip(1);const s=xi(e),o=!!(s&1),c=!!(s&2),l=!!(s&8),d=!!(s&16),u=!!(s&32),f=!!(s&65536),h=!!(s&131072),g=ve(e),m=this.tracks.find(v=>v.id===g);if(!m)break;const p=this.fragmentTrackDefaults.find(v=>v.trackId===g);this.currentTrack=m,m.currentFragmentState={baseDataOffset:this.currentFragment.implicitBaseDataOffset,sampleDescriptionIndex:p?.defaultSampleDescriptionIndex??null,defaultSampleDuration:p?.defaultSampleDuration??null,defaultSampleSize:p?.defaultSampleSize??null,defaultSampleFlags:p?.defaultSampleFlags??null,startTimestamp:null},o?m.currentFragmentState.baseDataOffset=mr(e):h&&(m.currentFragmentState.baseDataOffset=this.currentFragment.moofOffset),c&&(m.currentFragmentState.sampleDescriptionIndex=ve(e)),l&&(m.currentFragmentState.defaultSampleDuration=ve(e)),d&&(m.currentFragmentState.defaultSampleSize=ve(e)),u&&(m.currentFragmentState.defaultSampleFlags=ve(e)),f&&(m.currentFragmentState.defaultSampleDuration=0)}break;case"tfdt":{const s=this.currentTrack;if(!s)break;E(s.currentFragmentState);const o=Se(e);e.skip(3);const c=o===0?ve(e):mr(e);s.currentFragmentState.startTimestamp=c}break;case"trun":{const s=this.currentTrack;if(!s)break;if(E(this.currentFragment),E(s.currentFragmentState),this.currentFragment.trackData.has(s.id)){console.warn("Can't have two trun boxes for the same track in one fragment. Ignoring...");break}const o=Se(e),c=xi(e),l=!!(c&1),d=!!(c&4),u=!!(c&256),f=!!(c&512),h=!!(c&1024),g=!!(c&2048),m=ve(e);let p=s.currentFragmentState.baseDataOffset;l&&(p+=di(e));let v=null;d&&(v=ve(e));let b=p;if(m===0){this.currentFragment.implicitBaseDataOffset=b;break}let w=0;const x={track:s,startTimestamp:0,endTimestamp:0,firstKeyFrameTimestamp:null,samples:[],presentationTimestamps:[],startTimestampIsFinal:!1};this.currentFragment.trackData.set(s.id,x);for(let B=0;B<m;B++){let z;u?z=ve(e):(E(s.currentFragmentState.defaultSampleDuration!==null),z=s.currentFragmentState.defaultSampleDuration);let M;f?M=ve(e):(E(s.currentFragmentState.defaultSampleSize!==null),M=s.currentFragmentState.defaultSampleSize);let W;h?W=ve(e):(E(s.currentFragmentState.defaultSampleFlags!==null),W=s.currentFragmentState.defaultSampleFlags),B===0&&v!==null&&(W=v);let G=0;g&&(o===0?G=ve(e):G=di(e));const C=!(W&65536);x.samples.push({presentationTimestamp:w+G,duration:z,byteOffset:b,byteSize:M,isKeyFrame:C}),b+=M,w+=z}x.presentationTimestamps=x.samples.map((B,z)=>({presentationTimestamp:B.presentationTimestamp,sampleIndex:z})).sort((B,z)=>B.presentationTimestamp-z.presentationTimestamp);for(let B=0;B<x.presentationTimestamps.length;B++){const z=x.presentationTimestamps[B],M=x.samples[z.sampleIndex];if(x.firstKeyFrameTimestamp===null&&M.isKeyFrame&&(x.firstKeyFrameTimestamp=M.presentationTimestamp),B<x.presentationTimestamps.length-1){const W=x.presentationTimestamps[B+1];M.duration=W.presentationTimestamp-z.presentationTimestamp}}const T=x.samples[x.presentationTimestamps[0].sampleIndex],A=x.samples[wt(x.presentationTimestamps).sampleIndex];x.startTimestamp=T.presentationTimestamp,x.endTimestamp=A.presentationTimestamp+A.duration,this.currentFragment.implicitBaseDataOffset=b}break;case"udta":{const s=this.iterateContiguousBoxes(e.slice(a,i.contentSize));for(const{boxInfo:o,slice:c}of s){if(o.name!=="meta"&&!this.currentTrack){const l=c.filePos;this.metadataTags.raw??={},o.name[0]==="Â©"?this.metadataTags.raw[o.name]??=gr(c):this.metadataTags.raw[o.name]??=Me(c,o.contentSize),c.filePos=l}switch(o.name){case"meta":c.skip(-o.headerSize),this.traverseBox(c);break;case"Â©nam":case"name":this.currentTrack?this.currentTrack.name=lr.decode(Me(c,o.contentSize)):this.metadataTags.title??=gr(c);break;case"Â©des":this.currentTrack||(this.metadataTags.description??=gr(c));break;case"Â©ART":this.currentTrack||(this.metadataTags.artist??=gr(c));break;case"Â©alb":this.currentTrack||(this.metadataTags.album??=gr(c));break;case"albr":this.currentTrack||(this.metadataTags.albumArtist??=gr(c));break;case"Â©gen":this.currentTrack||(this.metadataTags.genre??=gr(c));break;case"Â©day":if(!this.currentTrack){const l=new Date(gr(c));Number.isNaN(l.getTime())||(this.metadataTags.date??=l)}break;case"Â©cmt":this.currentTrack||(this.metadataTags.comment??=gr(c));break;case"Â©lyr":this.currentTrack||(this.metadataTags.lyrics??=gr(c));break}}}break;case"meta":{if(this.currentTrack)break;const o=ve(e)!==0;this.currentMetadataKeys=new Map,o?this.readContiguousBoxes(e.slice(a,i.contentSize)):this.readContiguousBoxes(e.slice(a+4,i.contentSize-4)),this.currentMetadataKeys=null}break;case"keys":{if(!this.currentMetadataKeys)break;e.skip(4);const s=ve(e);for(let o=0;o<s;o++){const c=ve(e);e.skip(4);const l=lr.decode(Me(e,c-8));this.currentMetadataKeys.set(o+1,l)}}break;case"ilst":{if(!this.currentMetadataKeys)break;const s=this.iterateContiguousBoxes(e.slice(a,i.contentSize));for(const{boxInfo:o,slice:c}of s){let l=o.name;const d=(l.charCodeAt(0)<<24)+(l.charCodeAt(1)<<16)+(l.charCodeAt(2)<<8)+l.charCodeAt(3);this.currentMetadataKeys.has(d)&&(l=this.currentMetadataKeys.get(d));const u=Af(c);switch(this.metadataTags.raw??={},this.metadataTags.raw[l]??=u,l){case"Â©nam":case"titl":case"com.apple.quicktime.title":case"title":typeof u=="string"&&(this.metadataTags.title??=u);break;case"Â©des":case"desc":case"dscp":case"com.apple.quicktime.description":case"description":typeof u=="string"&&(this.metadataTags.description??=u);break;case"Â©ART":case"com.apple.quicktime.artist":case"artist":typeof u=="string"&&(this.metadataTags.artist??=u);break;case"Â©alb":case"albm":case"com.apple.quicktime.album":case"album":typeof u=="string"&&(this.metadataTags.album??=u);break;case"aART":case"album_artist":typeof u=="string"&&(this.metadataTags.albumArtist??=u);break;case"Â©cmt":case"com.apple.quicktime.comment":case"comment":typeof u=="string"&&(this.metadataTags.comment??=u);break;case"Â©gen":case"gnre":case"com.apple.quicktime.genre":case"genre":typeof u=="string"&&(this.metadataTags.genre??=u);break;case"Â©lyr":case"lyrics":typeof u=="string"&&(this.metadataTags.lyrics??=u);break;case"Â©day":case"rldt":case"com.apple.quicktime.creationdate":case"date":if(typeof u=="string"){const f=new Date(u);Number.isNaN(f.getTime())||(this.metadataTags.date??=f)}break;case"covr":case"com.apple.quicktime.artwork":u instanceof Di?(this.metadataTags.images??=[],this.metadataTags.images.push({data:u.data,kind:"coverFront",mimeType:u.mimeType})):u instanceof Uint8Array&&(this.metadataTags.images??=[],this.metadataTags.images.push({data:u,kind:"coverFront",mimeType:"image/*"}));break;case"track":if(typeof u=="string"){const f=u.split("/"),h=Number.parseInt(f[0],10),g=f[1]&&Number.parseInt(f[1],10);Number.isInteger(h)&&h>0&&(this.metadataTags.trackNumber??=h),g&&Number.isInteger(g)&&g>0&&(this.metadataTags.tracksTotal??=g)}break;case"trkn":if(u instanceof Uint8Array&&u.length>=6){const f=kt(u),h=f.getUint16(2,!1),g=f.getUint16(4,!1);h>0&&(this.metadataTags.trackNumber??=h),g>0&&(this.metadataTags.tracksTotal??=g)}break;case"disc":case"disk":if(u instanceof Uint8Array&&u.length>=6){const f=kt(u),h=f.getUint16(2,!1),g=f.getUint16(4,!1);h>0&&(this.metadataTags.discNumber??=h),g>0&&(this.metadataTags.discsTotal??=g)}break}}}break}return e.filePos=n,!0}}class Yc{constructor(e){this.internalTrack=e,this.packetToSampleIndex=new WeakMap,this.packetToFragmentLocation=new WeakMap}getId(){return this.internalTrack.id}getCodec(){throw new Error("Not implemented on base class.")}getInternalCodecId(){return this.internalTrack.internalCodecId}getName(){return this.internalTrack.name}getLanguageCode(){return this.internalTrack.languageCode}getTimeResolution(){return this.internalTrack.timescale}getDisposition(){return this.internalTrack.disposition}async computeDuration(){const e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}async getFirstTimestamp(){return(await this.getFirstPacket({metadataOnly:!0}))?.timestamp??0}async getFirstPacket(e){const t=await this.fetchPacketForSampleIndex(0,e);return t||!this.internalTrack.demuxer.isFragmented?t:this.performFragmentedLookup(null,i=>i.trackData.get(this.internalTrack.id)?{sampleIndex:0,correctSampleFound:!0}:{sampleIndex:-1,correctSampleFound:!1},-1/0,1/0,e)}mapTimestampIntoTimescale(e){return pa(e*this.internalTrack.timescale)+this.internalTrack.editListOffset}async getPacket(e,t){const i=this.mapTimestampIntoTimescale(e),a=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),n=Js(a,i),s=await this.fetchPacketForSampleIndex(n,t);return!Do(a)||!this.internalTrack.demuxer.isFragmented?s:this.performFragmentedLookup(null,o=>{const c=o.trackData.get(this.internalTrack.id);if(!c)return{sampleIndex:-1,correctSampleFound:!1};const l=rt(c.presentationTimestamps,i,f=>f.presentationTimestamp),d=l!==-1?c.presentationTimestamps[l].sampleIndex:-1,u=l!==-1&&i<c.endTimestamp;return{sampleIndex:d,correctSampleFound:u}},i,i,t)}async getNextPacket(e,t){const i=this.packetToSampleIndex.get(e);if(i!==void 0)return this.fetchPacketForSampleIndex(i+1,t);const a=this.packetToFragmentLocation.get(e);if(a===void 0)throw new Error("Packet was not created from this track.");return this.performFragmentedLookup(a.fragment,n=>{if(n===a.fragment){const s=n.trackData.get(this.internalTrack.id);if(a.sampleIndex+1<s.samples.length)return{sampleIndex:a.sampleIndex+1,correctSampleFound:!0}}else if(n.trackData.get(this.internalTrack.id))return{sampleIndex:0,correctSampleFound:!0};return{sampleIndex:-1,correctSampleFound:!1}},-1/0,1/0,t)}async getKeyPacket(e,t){const i=this.mapTimestampIntoTimescale(e),a=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),n=Mf(a,i),s=await this.fetchPacketForSampleIndex(n,t);return!Do(a)||!this.internalTrack.demuxer.isFragmented?s:this.performFragmentedLookup(null,o=>{const c=o.trackData.get(this.internalTrack.id);if(!c)return{sampleIndex:-1,correctSampleFound:!1};const l=_n(c.presentationTimestamps,f=>c.samples[f.sampleIndex].isKeyFrame&&f.presentationTimestamp<=i),d=l!==-1?c.presentationTimestamps[l].sampleIndex:-1,u=l!==-1&&i<c.endTimestamp;return{sampleIndex:d,correctSampleFound:u}},i,i,t)}async getNextKeyPacket(e,t){const i=this.packetToSampleIndex.get(e);if(i!==void 0){const n=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),s=Df(n,i);return this.fetchPacketForSampleIndex(s,t)}const a=this.packetToFragmentLocation.get(e);if(a===void 0)throw new Error("Packet was not created from this track.");return this.performFragmentedLookup(a.fragment,n=>{if(n===a.fragment){const o=n.trackData.get(this.internalTrack.id).samples.findIndex((c,l)=>c.isKeyFrame&&l>a.sampleIndex);if(o!==-1)return{sampleIndex:o,correctSampleFound:!0}}else{const s=n.trackData.get(this.internalTrack.id);if(s&&s.firstKeyFrameTimestamp!==null){const o=s.samples.findIndex(c=>c.isKeyFrame);return E(o!==-1),{sampleIndex:o,correctSampleFound:!0}}}return{sampleIndex:-1,correctSampleFound:!1}},-1/0,1/0,t)}async fetchPacketForSampleIndex(e,t){if(e===-1)return null;const i=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),a=Rf(i,e);if(!a)return null;let n;if(t.metadataOnly)n=rr;else{let l=this.internalTrack.demuxer.reader.requestSlice(a.sampleOffset,a.sampleSize);l instanceof Promise&&(l=await l),E(l),n=Me(l,a.sampleSize)}const s=(a.presentationTimestamp-this.internalTrack.editListOffset)/this.internalTrack.timescale,o=a.duration/this.internalTrack.timescale,c=new ht(n,a.isKeyFrame?"key":"delta",s,o,e,a.sampleSize);return this.packetToSampleIndex.set(c,e),c}async fetchPacketInFragment(e,t,i){if(t===-1)return null;const n=e.trackData.get(this.internalTrack.id).samples[t];E(n);let s;if(i.metadataOnly)s=rr;else{let d=this.internalTrack.demuxer.reader.requestSlice(n.byteOffset,n.byteSize);d instanceof Promise&&(d=await d),E(d),s=Me(d,n.byteSize)}const o=(n.presentationTimestamp-this.internalTrack.editListOffset)/this.internalTrack.timescale,c=n.duration/this.internalTrack.timescale,l=new ht(s,n.isKeyFrame?"key":"delta",o,c,e.moofOffset+t,n.byteSize);return this.packetToFragmentLocation.set(l,{fragment:e,sampleIndex:t}),l}async performFragmentedLookup(e,t,i,a,n){const s=this.internalTrack.demuxer;let o=null,c=null,l=-1;if(e){const{sampleIndex:p,correctSampleFound:v}=t(e);if(v)return this.fetchPacketInFragment(e,p,n);p!==-1&&(c=e,l=p)}const d=rt(this.internalTrack.fragmentLookupTable,i,p=>p.timestamp),u=d!==-1?this.internalTrack.fragmentLookupTable[d]:null,f=rt(this.internalTrack.fragmentPositionCache,i,p=>p.startTimestamp),h=f!==-1?this.internalTrack.fragmentPositionCache[f]:null,g=Math.max(u?.moofOffset??0,h?.moofOffset??0)||null;let m;for(e?g===null||e.moofOffset>=g?(m=e.moofOffset+e.moofSize,o=e):m=g:m=g??0;;){if(o){const w=o.trackData.get(this.internalTrack.id);if(w&&w.startTimestamp>a)break}let p=s.reader.requestSliceRange(m,Mr,ci);if(p instanceof Promise&&(p=await p),!p)break;const v=m,b=jr(p);if(!b)break;if(b.name==="moof"){o=await s.readFragment(v);const{sampleIndex:w,correctSampleFound:x}=t(o);if(x)return this.fetchPacketInFragment(o,w,n);w!==-1&&(c=o,l=w)}m=v+b.totalSize}if(u&&(!c||c.moofOffset<u.moofOffset)){const p=this.internalTrack.fragmentLookupTable[d-1];E(!p||p.timestamp<u.timestamp);const v=p?.timestamp??-1/0;return this.performFragmentedLookup(null,t,v,a,n)}return c?this.fetchPacketInFragment(c,l,n):null}}class Bf extends Yc{constructor(e){super(e),this.decoderConfigPromise=null,this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getCodedWidth(){return this.internalTrack.info.width}getCodedHeight(){return this.internalTrack.info.height}getRotation(){return this.internalTrack.rotation}async getColorSpace(){return{primaries:this.internalTrack.info.colorSpace?.primaries,transfer:this.internalTrack.info.colorSpace?.transfer,matrix:this.internalTrack.info.colorSpace?.matrix,fullRange:this.internalTrack.info.colorSpace?.fullRange}}async canBeTransparent(){return!1}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfigPromise??=(async()=>{if(this.internalTrack.info.codec==="vp9"&&!this.internalTrack.info.vp9CodecInfo){const e=await this.getFirstPacket({});this.internalTrack.info.vp9CodecInfo=e&&$c(e.data)}else if(this.internalTrack.info.codec==="av1"&&!this.internalTrack.info.av1CodecInfo){const e=await this.getFirstPacket({});this.internalTrack.info.av1CodecInfo=e&&Hc(e.data)}return{codec:Pn(this.internalTrack.info),codedWidth:this.internalTrack.info.width,codedHeight:this.internalTrack.info.height,description:this.internalTrack.info.codecDescription??void 0,colorSpace:this.internalTrack.info.colorSpace??void 0}})():null}}class zf extends Yc{constructor(e){super(e),this.decoderConfig=null,this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getNumberOfChannels(){return this.internalTrack.info.numberOfChannels}getSampleRate(){return this.internalTrack.info.sampleRate}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfig??={codec:En(this.internalTrack.info),numberOfChannels:this.internalTrack.info.numberOfChannels,sampleRate:this.internalTrack.info.sampleRate,description:this.internalTrack.info.codecDescription??void 0}:null}}const Js=(r,e)=>{if(r.presentationTimestamps){const t=rt(r.presentationTimestamps,e,i=>i.presentationTimestamp);return t===-1?-1:r.presentationTimestamps[t].sampleIndex}else{const t=rt(r.sampleTimingEntries,e,a=>a.startDecodeTimestamp);if(t===-1)return-1;const i=r.sampleTimingEntries[t];return i.startIndex+Math.min(Math.floor((e-i.startDecodeTimestamp)/i.delta),i.count-1)}},Mf=(r,e)=>{if(!r.keySampleIndices)return Js(r,e);if(r.presentationTimestamps){const t=rt(r.presentationTimestamps,e,i=>i.presentationTimestamp);if(t===-1)return-1;for(let i=t;i>=0;i--){const a=r.presentationTimestamps[i].sampleIndex;if(_a(r.keySampleIndices,a,s=>s)!==-1)return a}return-1}else{const t=Js(r,e),i=rt(r.keySampleIndices,t,a=>a);return r.keySampleIndices[i]??-1}},Rf=(r,e)=>{const t=rt(r.sampleTimingEntries,e,v=>v.startIndex),i=r.sampleTimingEntries[t];if(!i||i.startIndex+i.count<=e)return null;let n=i.startDecodeTimestamp+(e-i.startIndex)*i.delta;const s=rt(r.sampleCompositionTimeOffsets,e,v=>v.startIndex),o=r.sampleCompositionTimeOffsets[s];o&&e-o.startIndex<o.count&&(n+=o.offset);const c=r.sampleSizes[Math.min(e,r.sampleSizes.length-1)],l=rt(r.sampleToChunk,e,v=>v.startSampleIndex),d=r.sampleToChunk[l];E(d);const u=d.startChunkIndex+Math.floor((e-d.startSampleIndex)/d.samplesPerChunk),f=r.chunkOffsets[u],h=d.startSampleIndex+(u-d.startChunkIndex)*d.samplesPerChunk;let g=0,m=f;if(r.sampleSizes.length===1)m+=c*(e-h),g+=c*d.samplesPerChunk;else for(let v=h;v<h+d.samplesPerChunk;v++){const b=r.sampleSizes[v];v<e&&(m+=b),g+=b}let p=i.delta;if(r.presentationTimestamps){const v=r.presentationTimestampIndexMap[e];E(v!==void 0),v<r.presentationTimestamps.length-1&&(p=r.presentationTimestamps[v+1].presentationTimestamp-n)}return{presentationTimestamp:n,duration:p,sampleOffset:m,sampleSize:c,chunkOffset:f,chunkSize:g,isKeyFrame:r.keySampleIndices?_a(r.keySampleIndices,e,v=>v)!==-1:!0}},Df=(r,e)=>{if(!r.keySampleIndices)return e+1;const t=rt(r.keySampleIndices,e,i=>i);return r.keySampleIndices[t+1]??-1},Cs=(r,e)=>{r.startTimestamp+=e,r.endTimestamp+=e;for(const t of r.samples)t.presentationTimestamp+=e;for(const t of r.presentationTimestamps)t.presentationTimestamp+=e},Of=r=>{const[e,,,t]=r,i=Math.hypot(e,t),a=e/i,n=t/i,s=-Math.atan2(n,a)*(180/Math.PI);return Number.isFinite(s)?s:0},Do=r=>r.sampleSizes.length===0;class en{constructor(e){this.value=e}}class tn{constructor(e){this.value=e}}class Jc{constructor(e){this.value=e}}class Wr{constructor(e){this.value=e}}var D;(function(r){r[r.EBML=440786851]="EBML",r[r.EBMLVersion=17030]="EBMLVersion",r[r.EBMLReadVersion=17143]="EBMLReadVersion",r[r.EBMLMaxIDLength=17138]="EBMLMaxIDLength",r[r.EBMLMaxSizeLength=17139]="EBMLMaxSizeLength",r[r.DocType=17026]="DocType",r[r.DocTypeVersion=17031]="DocTypeVersion",r[r.DocTypeReadVersion=17029]="DocTypeReadVersion",r[r.Void=236]="Void",r[r.Segment=408125543]="Segment",r[r.SeekHead=290298740]="SeekHead",r[r.Seek=19899]="Seek",r[r.SeekID=21419]="SeekID",r[r.SeekPosition=21420]="SeekPosition",r[r.Duration=17545]="Duration",r[r.Info=357149030]="Info",r[r.TimestampScale=2807729]="TimestampScale",r[r.MuxingApp=19840]="MuxingApp",r[r.WritingApp=22337]="WritingApp",r[r.Tracks=374648427]="Tracks",r[r.TrackEntry=174]="TrackEntry",r[r.TrackNumber=215]="TrackNumber",r[r.TrackUID=29637]="TrackUID",r[r.TrackType=131]="TrackType",r[r.FlagEnabled=185]="FlagEnabled",r[r.FlagDefault=136]="FlagDefault",r[r.FlagForced=21930]="FlagForced",r[r.FlagOriginal=21934]="FlagOriginal",r[r.FlagHearingImpaired=21931]="FlagHearingImpaired",r[r.FlagVisualImpaired=21932]="FlagVisualImpaired",r[r.FlagCommentary=21935]="FlagCommentary",r[r.FlagLacing=156]="FlagLacing",r[r.Name=21358]="Name",r[r.Language=2274716]="Language",r[r.LanguageBCP47=2274717]="LanguageBCP47",r[r.CodecID=134]="CodecID",r[r.CodecPrivate=25506]="CodecPrivate",r[r.CodecDelay=22186]="CodecDelay",r[r.SeekPreRoll=22203]="SeekPreRoll",r[r.DefaultDuration=2352003]="DefaultDuration",r[r.Video=224]="Video",r[r.PixelWidth=176]="PixelWidth",r[r.PixelHeight=186]="PixelHeight",r[r.AlphaMode=21440]="AlphaMode",r[r.Audio=225]="Audio",r[r.SamplingFrequency=181]="SamplingFrequency",r[r.Channels=159]="Channels",r[r.BitDepth=25188]="BitDepth",r[r.SimpleBlock=163]="SimpleBlock",r[r.BlockGroup=160]="BlockGroup",r[r.Block=161]="Block",r[r.BlockAdditions=30113]="BlockAdditions",r[r.BlockMore=166]="BlockMore",r[r.BlockAdditional=165]="BlockAdditional",r[r.BlockAddID=238]="BlockAddID",r[r.BlockDuration=155]="BlockDuration",r[r.ReferenceBlock=251]="ReferenceBlock",r[r.Cluster=524531317]="Cluster",r[r.Timestamp=231]="Timestamp",r[r.Cues=475249515]="Cues",r[r.CuePoint=187]="CuePoint",r[r.CueTime=179]="CueTime",r[r.CueTrackPositions=183]="CueTrackPositions",r[r.CueTrack=247]="CueTrack",r[r.CueClusterPosition=241]="CueClusterPosition",r[r.Colour=21936]="Colour",r[r.MatrixCoefficients=21937]="MatrixCoefficients",r[r.TransferCharacteristics=21946]="TransferCharacteristics",r[r.Primaries=21947]="Primaries",r[r.Range=21945]="Range",r[r.Projection=30320]="Projection",r[r.ProjectionType=30321]="ProjectionType",r[r.ProjectionPoseRoll=30325]="ProjectionPoseRoll",r[r.Attachments=423732329]="Attachments",r[r.AttachedFile=24999]="AttachedFile",r[r.FileDescription=18046]="FileDescription",r[r.FileName=18030]="FileName",r[r.FileMediaType=18016]="FileMediaType",r[r.FileData=18012]="FileData",r[r.FileUID=18094]="FileUID",r[r.Chapters=272869232]="Chapters",r[r.Tags=307544935]="Tags",r[r.Tag=29555]="Tag",r[r.Targets=25536]="Targets",r[r.TargetTypeValue=26826]="TargetTypeValue",r[r.TargetType=25546]="TargetType",r[r.TagTrackUID=25541]="TagTrackUID",r[r.TagEditionUID=25545]="TagEditionUID",r[r.TagChapterUID=25540]="TagChapterUID",r[r.TagAttachmentUID=25542]="TagAttachmentUID",r[r.SimpleTag=26568]="SimpleTag",r[r.TagName=17827]="TagName",r[r.TagLanguage=17530]="TagLanguage",r[r.TagString=17543]="TagString",r[r.TagBinary=17541]="TagBinary",r[r.ContentEncodings=28032]="ContentEncodings",r[r.ContentEncoding=25152]="ContentEncoding",r[r.ContentEncodingOrder=20529]="ContentEncodingOrder",r[r.ContentEncodingScope=20530]="ContentEncodingScope",r[r.ContentCompression=20532]="ContentCompression",r[r.ContentCompAlgo=16980]="ContentCompAlgo",r[r.ContentCompSettings=16981]="ContentCompSettings",r[r.ContentEncryption=20533]="ContentEncryption"})(D||(D={}));const Nf=[D.EBML,D.Segment],ka=[D.SeekHead,D.Info,D.Cluster,D.Tracks,D.Cues,D.Attachments,D.Chapters,D.Tags],Oa=[...Nf,...ka],Oo=r=>r<256?1:r<65536?2:r<1<<24?3:r<2**32?4:r<2**40?5:6,No=r=>r<1n<<8n?1:r<1n<<16n?2:r<1n<<24n?3:r<1n<<32n?4:r<1n<<40n?5:r<1n<<48n?6:r<1n<<56n?7:8,Uo=r=>r>=-64&&r<64?1:r>=-8192&&r<8192?2:r>=-1048576&&r<1<<20?3:r>=-134217728&&r<1<<27?4:r>=-17179869184&&r<2**34?5:6,Uf=r=>{if(r<127)return 1;if(r<16383)return 2;if(r<(1<<21)-1)return 3;if(r<(1<<28)-1)return 4;if(r<2**35-1)return 5;if(r<2**42-1)return 6;throw new Error("EBML varint size not supported "+r)};class Vf{constructor(e){this.writer=e,this.helper=new Uint8Array(8),this.helperView=new DataView(this.helper.buffer),this.offsets=new WeakMap,this.dataOffsets=new WeakMap}writeByte(e){this.helperView.setUint8(0,e),this.writer.write(this.helper.subarray(0,1))}writeFloat32(e){this.helperView.setFloat32(0,e,!1),this.writer.write(this.helper.subarray(0,4))}writeFloat64(e){this.helperView.setFloat64(0,e,!1),this.writer.write(this.helper)}writeUnsignedInt(e,t=Oo(e)){let i=0;switch(t){case 6:this.helperView.setUint8(i++,e/2**40|0);case 5:this.helperView.setUint8(i++,e/2**32|0);case 4:this.helperView.setUint8(i++,e>>24);case 3:this.helperView.setUint8(i++,e>>16);case 2:this.helperView.setUint8(i++,e>>8);case 1:this.helperView.setUint8(i++,e);break;default:throw new Error("Bad unsigned int size "+t)}this.writer.write(this.helper.subarray(0,i))}writeUnsignedBigInt(e,t=No(e)){let i=0;for(let a=t-1;a>=0;a--)this.helperView.setUint8(i++,Number(e>>BigInt(a*8)&0xffn));this.writer.write(this.helper.subarray(0,i))}writeSignedInt(e,t=Uo(e)){e<0&&(e+=2**(t*8)),this.writeUnsignedInt(e,t)}writeVarInt(e,t=Uf(e)){let i=0;switch(t){case 1:this.helperView.setUint8(i++,128|e);break;case 2:this.helperView.setUint8(i++,64|e>>8),this.helperView.setUint8(i++,e);break;case 3:this.helperView.setUint8(i++,32|e>>16),this.helperView.setUint8(i++,e>>8),this.helperView.setUint8(i++,e);break;case 4:this.helperView.setUint8(i++,16|e>>24),this.helperView.setUint8(i++,e>>16),this.helperView.setUint8(i++,e>>8),this.helperView.setUint8(i++,e);break;case 5:this.helperView.setUint8(i++,8|e/2**32&7),this.helperView.setUint8(i++,e>>24),this.helperView.setUint8(i++,e>>16),this.helperView.setUint8(i++,e>>8),this.helperView.setUint8(i++,e);break;case 6:this.helperView.setUint8(i++,4|e/2**40&3),this.helperView.setUint8(i++,e/2**32|0),this.helperView.setUint8(i++,e>>24),this.helperView.setUint8(i++,e>>16),this.helperView.setUint8(i++,e>>8),this.helperView.setUint8(i++,e);break;default:throw new Error("Bad EBML varint size "+t)}this.writer.write(this.helper.subarray(0,i))}writeAsciiString(e){this.writer.write(new Uint8Array(e.split("").map(t=>t.charCodeAt(0))))}writeEBML(e){if(e!==null)if(e instanceof Uint8Array)this.writer.write(e);else if(Array.isArray(e))for(const t of e)this.writeEBML(t);else if(this.offsets.set(e,this.writer.getPos()),this.writeUnsignedInt(e.id),Array.isArray(e.data)){const t=this.writer.getPos(),i=e.size===-1?1:e.size??4;e.size===-1?this.writeByte(255):this.writer.seek(this.writer.getPos()+i);const a=this.writer.getPos();if(this.dataOffsets.set(e,a),this.writeEBML(e.data),e.size!==-1){const n=this.writer.getPos()-a,s=this.writer.getPos();this.writer.seek(t),this.writeVarInt(n,i),this.writer.seek(s)}}else if(typeof e.data=="number"){const t=e.size??Oo(e.data);this.writeVarInt(t),this.writeUnsignedInt(e.data,t)}else if(typeof e.data=="bigint"){const t=e.size??No(e.data);this.writeVarInt(t),this.writeUnsignedBigInt(e.data,t)}else if(typeof e.data=="string")this.writeVarInt(e.data.length),this.writeAsciiString(e.data);else if(e.data instanceof Uint8Array)this.writeVarInt(e.data.byteLength,e.size),this.writer.write(e.data);else if(e.data instanceof en)this.writeVarInt(4),this.writeFloat32(e.data.value);else if(e.data instanceof tn)this.writeVarInt(8),this.writeFloat64(e.data.value);else if(e.data instanceof Jc){const t=e.size??Uo(e.data.value);this.writeVarInt(t),this.writeSignedInt(e.data.value,t)}else if(e.data instanceof Wr){const t=Kt.encode(e.data.value);this.writeVarInt(t.length),this.writer.write(t)}else Tr(e.data)}}const rn=8,or=2,Rr=2*rn,el=r=>{if(r.remainingLength<1)return null;const e=Se(r);if(r.skip(-1),e===0)return null;let t=1,i=128;for(;(e&i)===0;)t++,i>>=1;return r.remainingLength<t?null:t},sa=r=>{if(r.remainingLength<1)return null;const e=Se(r);if(e===0)return null;let t=1,i=128;for(;(e&i)===0;)t++,i>>=1;if(r.remainingLength<t-1)return null;let a=e&i-1;for(let n=1;n<t;n++)a*=256,a+=Se(r);return a},qe=(r,e)=>{if(e<1||e>8)throw new Error("Bad unsigned int size "+e);let t=0;for(let i=0;i<e;i++)t*=256,t+=Se(r);return t},Lf=(r,e)=>{if(e<1)throw new Error("Bad unsigned int size "+e);let t=0n;for(let i=0;i<e;i++)t<<=8n,t+=BigInt(Se(r));return t},Vn=r=>{const e=el(r);return e===null||r.remainingLength<e?null:qe(r,e)},tl=r=>{if(r.remainingLength<1)return null;if(Se(r)===255)return;r.skip(-1);const t=sa(r);if(t===null)return null;if(t!==72057594037927940)return t},Fr=r=>{E(r.remainingLength>=or);const e=Vn(r);if(e===null)return null;const t=tl(r);return t===null?null:{id:e,size:t}},wi=(r,e)=>{const t=Me(r,e);let i=0;for(;i<e&&t[i]!==0;)i+=1;return String.fromCharCode(...t.subarray(0,i))},ta=(r,e)=>{const t=Me(r,e);let i=0;for(;i<e&&t[i]!==0;)i+=1;return lr.decode(t.subarray(0,i))},Ps=(r,e)=>{if(e===0)return 0;if(e!==4&&e!==8)throw new Error("Bad float size "+e);return e===4?Yh(r):ml(r)},an=async(r,e,t,i)=>{const a=new Set(t);let n=e;for(;i===null||n<i;){let s=r.requestSliceRange(n,or,Rr);if(s instanceof Promise&&(s=await s),!s)break;const o=Fr(s);if(!o)break;if(a.has(o.id))return{pos:n,found:!0};Hr(o.size),n=s.filePos+o.size}return{pos:i!==null&&i>n?i:n,found:!1}},rl=async(r,e,t,i)=>{const n=new Set(t);let s=e;for(;s<i;){let o=r.requestSliceRange(s,0,Math.min(65536,i-s));if(o instanceof Promise&&(o=await o),!o||o.length<rn)break;for(let c=0;c<o.length-rn;c++){o.filePos=s;const l=Vn(o);if(l!==null&&n.has(l))return s;s++}}return null},hr={avc:"V_MPEG4/ISO/AVC",hevc:"V_MPEGH/ISO/HEVC",vp8:"V_VP8",vp9:"V_VP9",av1:"V_AV1",aac:"A_AAC",mp3:"A_MPEG/L3",opus:"A_OPUS",vorbis:"A_VORBIS",flac:"A_FLAC","pcm-u8":"A_PCM/INT/LIT","pcm-s16":"A_PCM/INT/LIT","pcm-s16be":"A_PCM/INT/BIG","pcm-s24":"A_PCM/INT/LIT","pcm-s24be":"A_PCM/INT/BIG","pcm-s32":"A_PCM/INT/LIT","pcm-s32be":"A_PCM/INT/BIG","pcm-f32":"A_PCM/FLOAT/IEEE","pcm-f64":"A_PCM/FLOAT/IEEE",webvtt:"S_TEXT/WEBVTT"};function Hr(r){if(r===void 0)throw new Error("Undefined element size is used in a place where it is not supported.")}const il=r=>{let t=(r.hasVideo?"video/":r.hasAudio?"audio/":"application/")+(r.isWebM?"webm":"x-matroska");if(r.codecStrings.length>0){const i=[...new Set(r.codecStrings.filter(Boolean))];t+=`; codecs="${i.join(", ")}"`}return t};var Er;(function(r){r[r.None=0]="None",r[r.Xiph=1]="Xiph",r[r.FixedSize=2]="FixedSize",r[r.Ebml=3]="Ebml"})(Er||(Er={}));var Za;(function(r){r[r.Block=1]="Block",r[r.Private=2]="Private",r[r.Next=4]="Next"})(Za||(Za={}));var ua;(function(r){r[r.Zlib=0]="Zlib",r[r.Bzlib=1]="Bzlib",r[r.lzo1x=2]="lzo1x",r[r.HeaderStripping=3]="HeaderStripping"})(ua||(ua={}));const Es=[{id:D.SeekHead,flag:"seekHeadSeen"},{id:D.Info,flag:"infoSeen"},{id:D.Tracks,flag:"tracksSeen"},{id:D.Cues,flag:"cuesSeen"}],al=10*2**20;class $f extends ei{constructor(e){super(e),this.readMetadataPromise=null,this.segments=[],this.currentSegment=null,this.currentTrack=null,this.currentCluster=null,this.currentBlock=null,this.currentBlockAdditional=null,this.currentCueTime=null,this.currentDecodingInstruction=null,this.currentTagTargetIsMovie=!0,this.currentSimpleTagName=null,this.currentAttachedFile=null,this.isWebM=!1,this.reader=e._reader}async computeDuration(){const e=await this.getTracks(),t=await Promise.all(e.map(i=>i.computeDuration()));return Math.max(0,...t)}async getTracks(){return await this.readMetadata(),this.segments.flatMap(e=>e.tracks.map(t=>t.inputTrack))}async getMimeType(){await this.readMetadata();const e=await this.getTracks(),t=await Promise.all(e.map(i=>i.getCodecParameterString()));return il({isWebM:this.isWebM,hasVideo:this.segments.some(i=>i.tracks.some(a=>a.info?.type==="video")),hasAudio:this.segments.some(i=>i.tracks.some(a=>a.info?.type==="audio")),codecStrings:t.filter(Boolean)})}async getMetadataTags(){await this.readMetadata();for(const t of this.segments)t.metadataTagsCollected||(this.reader.fileSize!==null&&await this.loadSegmentMetadata(t),t.metadataTagsCollected=!0);let e={};for(const t of this.segments)e={...e,...t.metadataTags};return e}readMetadata(){return this.readMetadataPromise??=(async()=>{let e=0;for(;;){let t=this.reader.requestSliceRange(e,or,Rr);if(t instanceof Promise&&(t=await t),!t)break;const i=Fr(t);if(!i)break;const a=i.id;let n=i.size;const s=t.filePos;if(a===D.EBML){Hr(n);let o=this.reader.requestSlice(s,n);if(o instanceof Promise&&(o=await o),!o)break;this.readContiguousElements(o)}else if(a===D.Segment){if(await this.readSegment(s,n),n===void 0||this.reader.fileSize===null)break}else if(a===D.Cluster){if(this.reader.fileSize===null)break;n===void 0&&(n=(await an(this.reader,s,Oa,this.reader.fileSize)).pos-s);const o=wt(this.segments);o&&(o.elementEndPos=s+n)}Hr(n),e=s+n}})()}async readSegment(e,t){this.currentSegment={seekHeadSeen:!1,infoSeen:!1,tracksSeen:!1,cuesSeen:!1,tagsSeen:!1,attachmentsSeen:!1,timestampScale:-1,timestampFactor:-1,duration:-1,seekEntries:[],tracks:[],cuePoints:[],dataStartPos:e,elementEndPos:t===void 0?null:e+t,clusterSeekStartPos:e,lastReadCluster:null,metadataTags:{},metadataTagsCollected:!1},this.segments.push(this.currentSegment);let i=e;for(;this.currentSegment.elementEndPos===null||i<this.currentSegment.elementEndPos;){let o=this.reader.requestSliceRange(i,or,Rr);if(o instanceof Promise&&(o=await o),!o)break;const c=i,l=Fr(o);if(!l||!ka.includes(l.id)&&l.id!==D.Void){const g=await rl(this.reader,c,ka,Math.min(this.currentSegment.elementEndPos??1/0,c+al));if(g){i=g;continue}else break}const{id:d,size:u}=l,f=o.filePos,h=Es.findIndex(g=>g.id===d);if(h!==-1){const g=Es[h].flag;this.currentSegment[g]=!0,Hr(u);let m=this.reader.requestSlice(f,u);m instanceof Promise&&(m=await m),m&&this.readContiguousElements(m)}else if(d===D.Tags||d===D.Attachments){d===D.Tags?this.currentSegment.tagsSeen=!0:this.currentSegment.attachmentsSeen=!0,Hr(u);let g=this.reader.requestSlice(f,u);g instanceof Promise&&(g=await g),g&&this.readContiguousElements(g)}else if(d===D.Cluster){this.currentSegment.clusterSeekStartPos=c;break}if(u===void 0)break;i=f+u}if(this.currentSegment.seekEntries.sort((o,c)=>o.segmentPosition-c.segmentPosition),this.reader.fileSize!==null)for(const o of this.currentSegment.seekEntries){const c=Es.find(g=>g.id===o.id);if(!c||this.currentSegment[c.flag])continue;let l=this.reader.requestSliceRange(e+o.segmentPosition,or,Rr);if(l instanceof Promise&&(l=await l),!l)continue;const d=Fr(l);if(!d)continue;const{id:u,size:f}=d;if(u!==c.id)continue;Hr(f),this.currentSegment[c.flag]=!0;let h=this.reader.requestSlice(l.filePos,f);h instanceof Promise&&(h=await h),h&&this.readContiguousElements(h)}this.currentSegment.timestampScale===-1&&(this.currentSegment.timestampScale=1e6,this.currentSegment.timestampFactor=1e9/1e6);for(const o of this.currentSegment.tracks)o.defaultDurationNs!==null&&(o.defaultDuration=this.currentSegment.timestampFactor*o.defaultDurationNs/1e9);this.currentSegment.tracks.sort((o,c)=>Number(c.disposition.default)-Number(o.disposition.default));const a=new Map(this.currentSegment.tracks.map(o=>[o.id,o]));for(const o of this.currentSegment.cuePoints){const c=a.get(o.trackId);c&&c.cuePoints.push(o)}for(const o of this.currentSegment.tracks){o.cuePoints.sort((c,l)=>c.time-l.time);for(let c=0;c<o.cuePoints.length-1;c++){const l=o.cuePoints[c],d=o.cuePoints[c+1];l.time===d.time&&(o.cuePoints.splice(c+1,1),c--)}}let n=null,s=-1/0;for(const o of this.currentSegment.tracks)o.cuePoints.length>s&&(s=o.cuePoints.length,n=o);for(const o of this.currentSegment.tracks)o.cuePoints.length===0&&(o.cuePoints=n.cuePoints);this.currentSegment=null}async readCluster(e,t){if(t.lastReadCluster?.elementStartPos===e)return t.lastReadCluster;let i=this.reader.requestSliceRange(e,or,Rr);i instanceof Promise&&(i=await i),E(i);const a=e,n=Fr(i);E(n);const s=n.id;E(s===D.Cluster);let o=n.size;const c=i.filePos;o===void 0&&(o=(await an(this.reader,c,Oa,t.elementEndPos)).pos-c);let l=this.reader.requestSlice(c,o);l instanceof Promise&&(l=await l);const d={segment:t,elementStartPos:a,elementEndPos:c+o,dataStartPos:c,timestamp:-1,trackData:new Map};if(this.currentCluster=d,l){const u=this.readContiguousElements(l,Oa);d.elementEndPos=u}for(const[,u]of d.trackData){const f=u.track;E(u.blocks.length>0);let h=!1;for(let v=0;v<u.blocks.length;v++){const b=u.blocks[v];b.timestamp+=d.timestamp,h||=b.lacing!==Er.None}u.presentationTimestamps=u.blocks.map((v,b)=>({timestamp:v.timestamp,blockIndex:b})).sort((v,b)=>v.timestamp-b.timestamp);for(let v=0;v<u.presentationTimestamps.length;v++){const b=u.presentationTimestamps[v],w=u.blocks[b.blockIndex];if(u.firstKeyFrameTimestamp===null&&w.isKeyFrame&&(u.firstKeyFrameTimestamp=w.timestamp),v<u.presentationTimestamps.length-1){const x=u.presentationTimestamps[v+1];w.duration=x.timestamp-w.timestamp}else w.duration===0&&f.defaultDuration!=null&&w.lacing===Er.None&&(w.duration=f.defaultDuration)}h&&(this.expandLacedBlocks(u.blocks,f),u.presentationTimestamps=u.blocks.map((v,b)=>({timestamp:v.timestamp,blockIndex:b})).sort((v,b)=>v.timestamp-b.timestamp));const g=u.blocks[u.presentationTimestamps[0].blockIndex],m=u.blocks[wt(u.presentationTimestamps).blockIndex];u.startTimestamp=g.timestamp,u.endTimestamp=m.timestamp+m.duration;const p=rt(f.clusterPositionCache,u.startTimestamp,v=>v.startTimestamp);(p===-1||f.clusterPositionCache[p].elementStartPos!==a)&&f.clusterPositionCache.splice(p+1,0,{elementStartPos:d.elementStartPos,startTimestamp:u.startTimestamp})}return t.lastReadCluster=d,d}getTrackDataInCluster(e,t){let i=e.trackData.get(t);if(!i){const a=e.segment.tracks.find(n=>n.id===t);if(!a)return null;i={track:a,startTimestamp:0,endTimestamp:0,firstKeyFrameTimestamp:null,blocks:[],presentationTimestamps:[]},e.trackData.set(t,i)}return i}expandLacedBlocks(e,t){for(let i=0;i<e.length;i++){const a=e[i];if(a.lacing===Er.None)continue;a.decoded||(a.data=this.decodeBlockData(t,a.data),a.decoded=!0);const n=ir.tempFromBytes(a.data),s=[],o=Se(n)+1;switch(a.lacing){case Er.Xiph:{let l=0;for(let d=0;d<o-1;d++){let u=0;for(;n.bufferPos<n.length;){const f=Se(n);if(u+=f,f<255){s.push(u),l+=u;break}}}s.push(n.length-(n.bufferPos+l))}break;case Er.FixedSize:{const l=n.length-1,d=Math.floor(l/o);for(let u=0;u<o;u++)s.push(d)}break;case Er.Ebml:{const l=sa(n);E(l!==null);let d=l;s.push(d);let u=d;for(let f=1;f<o-1;f++){const h=n.bufferPos,g=sa(n);E(g!==null);const m=g,v=(1<<(n.bufferPos-h)*7-1)-1,b=m-v;d+=b,s.push(d),u+=d}s.push(n.length-(n.bufferPos+u))}break;default:E(!1)}E(s.length===o),e.splice(i,1);const c=a.duration||o*(t.defaultDuration??0);for(let l=0;l<o;l++){const d=s[l],u=Me(n,d),f=a.timestamp+c*l/o,h=c/o;e.splice(i+l,0,{timestamp:f,duration:h,isKeyFrame:a.isKeyFrame,data:u,lacing:Er.None,decoded:!0,mainAdditional:a.mainAdditional})}i+=o,i--}}async loadSegmentMetadata(e){for(const t of e.seekEntries){if(!(t.id===D.Tags&&!e.tagsSeen)){if(!(t.id===D.Attachments&&!e.attachmentsSeen))continue}let i=this.reader.requestSliceRange(e.dataStartPos+t.segmentPosition,or,Rr);if(i instanceof Promise&&(i=await i),!i)continue;const a=Fr(i);if(!a||a.id!==t.id)continue;const{size:n}=a;Hr(n),E(!this.currentSegment),this.currentSegment=e;let s=this.reader.requestSlice(i.filePos,n);s instanceof Promise&&(s=await s),s&&this.readContiguousElements(s),this.currentSegment=null,t.id===D.Tags?e.tagsSeen=!0:t.id===D.Attachments&&(e.attachmentsSeen=!0)}}readContiguousElements(e,t){for(;e.remainingLength>=or;){const i=e.filePos;if(!this.traverseElement(e,t))return i}return e.filePos}traverseElement(e,t){const i=Fr(e);if(!i||t&&t.includes(i.id))return!1;const{id:a,size:n}=i,s=e.filePos;switch(Hr(n),a){case D.DocType:this.isWebM=wi(e,n)==="webm";break;case D.Seek:{if(!this.currentSegment)break;const o={id:-1,segmentPosition:-1};this.currentSegment.seekEntries.push(o),this.readContiguousElements(e.slice(s,n)),(o.id===-1||o.segmentPosition===-1)&&this.currentSegment.seekEntries.pop()}break;case D.SeekID:{const o=this.currentSegment?.seekEntries[this.currentSegment.seekEntries.length-1];if(!o)break;o.id=qe(e,n)}break;case D.SeekPosition:{const o=this.currentSegment?.seekEntries[this.currentSegment.seekEntries.length-1];if(!o)break;o.segmentPosition=qe(e,n)}break;case D.TimestampScale:{if(!this.currentSegment)break;this.currentSegment.timestampScale=qe(e,n),this.currentSegment.timestampFactor=1e9/this.currentSegment.timestampScale}break;case D.Duration:{if(!this.currentSegment)break;this.currentSegment.duration=Ps(e,n)}break;case D.TrackEntry:{if(!this.currentSegment||(this.currentTrack={id:-1,segment:this.currentSegment,demuxer:this,clusterPositionCache:[],cuePoints:[],disposition:{...Jr},inputTrack:null,codecId:null,codecPrivate:null,defaultDuration:null,defaultDurationNs:null,name:null,languageCode:Gt,decodingInstructions:[],info:null},this.readContiguousElements(e.slice(s,n)),!this.currentTrack))break;if(this.currentTrack.decodingInstructions.some(o=>o.data?.type!=="decompress"||o.scope!==Za.Block||o.data.algorithm!==ua.HeaderStripping)&&(console.warn(`Track #${this.currentTrack.id} has an unsupported content encoding; dropping.`),this.currentTrack=null),this.currentTrack&&this.currentTrack.id!==-1&&this.currentTrack.codecId&&this.currentTrack.info){const o=this.currentTrack.codecId.indexOf("/"),c=o===-1?this.currentTrack.codecId:this.currentTrack.codecId.slice(0,o);if(this.currentTrack.info.type==="video"&&this.currentTrack.info.width!==-1&&this.currentTrack.info.height!==-1){this.currentTrack.codecId===hr.avc?(this.currentTrack.info.codec="avc",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId===hr.hevc?(this.currentTrack.info.codec="hevc",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):c===hr.vp8?this.currentTrack.info.codec="vp8":c===hr.vp9?this.currentTrack.info.codec="vp9":c===hr.av1&&(this.currentTrack.info.codec="av1");const l=this.currentTrack,d=new Zi(this.input,new Wf(l));this.currentTrack.inputTrack=d,this.currentSegment.tracks.push(this.currentTrack)}else if(this.currentTrack.info.type==="audio"&&this.currentTrack.info.numberOfChannels!==-1&&this.currentTrack.info.sampleRate!==-1){c===hr.aac?(this.currentTrack.info.codec="aac",this.currentTrack.info.aacCodecInfo={isMpeg2:this.currentTrack.codecId.includes("MPEG2"),objectType:null},this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId===hr.mp3?this.currentTrack.info.codec="mp3":c===hr.opus?(this.currentTrack.info.codec="opus",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate,this.currentTrack.info.sampleRate=Ta):c===hr.vorbis?(this.currentTrack.info.codec="vorbis",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):c===hr.flac?(this.currentTrack.info.codec="flac",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId==="A_PCM/INT/LIT"?this.currentTrack.info.bitDepth===8?this.currentTrack.info.codec="pcm-u8":this.currentTrack.info.bitDepth===16?this.currentTrack.info.codec="pcm-s16":this.currentTrack.info.bitDepth===24?this.currentTrack.info.codec="pcm-s24":this.currentTrack.info.bitDepth===32&&(this.currentTrack.info.codec="pcm-s32"):this.currentTrack.codecId==="A_PCM/INT/BIG"?this.currentTrack.info.bitDepth===8?this.currentTrack.info.codec="pcm-u8":this.currentTrack.info.bitDepth===16?this.currentTrack.info.codec="pcm-s16be":this.currentTrack.info.bitDepth===24?this.currentTrack.info.codec="pcm-s24be":this.currentTrack.info.bitDepth===32&&(this.currentTrack.info.codec="pcm-s32be"):this.currentTrack.codecId==="A_PCM/FLOAT/IEEE"&&(this.currentTrack.info.bitDepth===32?this.currentTrack.info.codec="pcm-f32":this.currentTrack.info.bitDepth===64&&(this.currentTrack.info.codec="pcm-f64"));const l=this.currentTrack,d=new Cr(this.input,new Hf(l));this.currentTrack.inputTrack=d,this.currentSegment.tracks.push(this.currentTrack)}}this.currentTrack=null}break;case D.TrackNumber:{if(!this.currentTrack)break;this.currentTrack.id=qe(e,n)}break;case D.TrackType:{if(!this.currentTrack)break;const o=qe(e,n);o===1?this.currentTrack.info={type:"video",width:-1,height:-1,rotation:0,codec:null,codecDescription:null,colorSpace:null,alphaMode:!1}:o===2&&(this.currentTrack.info={type:"audio",numberOfChannels:-1,sampleRate:-1,bitDepth:-1,codec:null,codecDescription:null,aacCodecInfo:null})}break;case D.FlagEnabled:{if(!this.currentTrack)break;qe(e,n)||(this.currentTrack=null)}break;case D.FlagDefault:{if(!this.currentTrack)break;this.currentTrack.disposition.default=!!qe(e,n)}break;case D.FlagForced:{if(!this.currentTrack)break;this.currentTrack.disposition.forced=!!qe(e,n)}break;case D.FlagOriginal:{if(!this.currentTrack)break;this.currentTrack.disposition.original=!!qe(e,n)}break;case D.FlagHearingImpaired:{if(!this.currentTrack)break;this.currentTrack.disposition.hearingImpaired=!!qe(e,n)}break;case D.FlagVisualImpaired:{if(!this.currentTrack)break;this.currentTrack.disposition.visuallyImpaired=!!qe(e,n)}break;case D.FlagCommentary:{if(!this.currentTrack)break;this.currentTrack.disposition.commentary=!!qe(e,n)}break;case D.CodecID:{if(!this.currentTrack)break;this.currentTrack.codecId=wi(e,n)}break;case D.CodecPrivate:{if(!this.currentTrack)break;this.currentTrack.codecPrivate=Me(e,n)}break;case D.DefaultDuration:{if(!this.currentTrack)break;this.currentTrack.defaultDurationNs=qe(e,n)}break;case D.Name:{if(!this.currentTrack)break;this.currentTrack.name=ta(e,n)}break;case D.Language:{if(!this.currentTrack||this.currentTrack.languageCode!==Gt)break;this.currentTrack.languageCode=wi(e,n),ga(this.currentTrack.languageCode)||(this.currentTrack.languageCode=Gt)}break;case D.LanguageBCP47:{if(!this.currentTrack)break;const c=wi(e,n).split("-")[0];c?this.currentTrack.languageCode=c:this.currentTrack.languageCode=Gt}break;case D.Video:{if(this.currentTrack?.info?.type!=="video")break;this.readContiguousElements(e.slice(s,n))}break;case D.PixelWidth:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.width=qe(e,n)}break;case D.PixelHeight:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.height=qe(e,n)}break;case D.AlphaMode:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.alphaMode=qe(e,n)===1}break;case D.Colour:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.colorSpace={},this.readContiguousElements(e.slice(s,n))}break;case D.MatrixCoefficients:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;const o=qe(e,n),c=Ga[o]??null;this.currentTrack.info.colorSpace.matrix=c}break;case D.Range:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;this.currentTrack.info.colorSpace.fullRange=qe(e,n)===2}break;case D.TransferCharacteristics:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;const o=qe(e,n),c=Ka[o]??null;this.currentTrack.info.colorSpace.transfer=c}break;case D.Primaries:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;const o=qe(e,n),c=qa[o]??null;this.currentTrack.info.colorSpace.primaries=c}break;case D.Projection:{if(this.currentTrack?.info?.type!=="video")break;this.readContiguousElements(e.slice(s,n))}break;case D.ProjectionPoseRoll:{if(this.currentTrack?.info?.type!=="video")break;const c=-Ps(e,n);try{this.currentTrack.info.rotation=as(c)}catch{}}break;case D.Audio:{if(this.currentTrack?.info?.type!=="audio")break;this.readContiguousElements(e.slice(s,n))}break;case D.SamplingFrequency:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.sampleRate=Ps(e,n)}break;case D.Channels:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.numberOfChannels=qe(e,n)}break;case D.BitDepth:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.bitDepth=qe(e,n)}break;case D.CuePoint:{if(!this.currentSegment)break;this.readContiguousElements(e.slice(s,n)),this.currentCueTime=null}break;case D.CueTime:this.currentCueTime=qe(e,n);break;case D.CueTrackPositions:{if(this.currentCueTime===null)break;E(this.currentSegment);const o={time:this.currentCueTime,trackId:-1,clusterPosition:-1};this.currentSegment.cuePoints.push(o),this.readContiguousElements(e.slice(s,n)),(o.trackId===-1||o.clusterPosition===-1)&&this.currentSegment.cuePoints.pop()}break;case D.CueTrack:{const o=this.currentSegment?.cuePoints[this.currentSegment.cuePoints.length-1];if(!o)break;o.trackId=qe(e,n)}break;case D.CueClusterPosition:{const o=this.currentSegment?.cuePoints[this.currentSegment.cuePoints.length-1];if(!o)break;E(this.currentSegment),o.clusterPosition=this.currentSegment.dataStartPos+qe(e,n)}break;case D.Timestamp:{if(!this.currentCluster)break;this.currentCluster.timestamp=qe(e,n)}break;case D.SimpleBlock:{if(!this.currentCluster)break;const o=sa(e);if(o===null)break;const c=this.getTrackDataInCluster(this.currentCluster,o);if(!c)break;const l=on(e),d=Se(e),u=d>>1&3;let f=!!(d&128);c.track.info?.type==="audio"&&c.track.info.codec&&(f=!0);const h=Me(e,n-(e.filePos-s)),g=c.track.decodingInstructions.length>0;c.blocks.push({timestamp:l,duration:0,isKeyFrame:f,data:h,lacing:u,decoded:!g,mainAdditional:null})}break;case D.BlockGroup:{if(!this.currentCluster)break;this.readContiguousElements(e.slice(s,n)),this.currentBlock=null}break;case D.Block:{if(!this.currentCluster)break;const o=sa(e);if(o===null)break;const c=this.getTrackDataInCluster(this.currentCluster,o);if(!c)break;const l=on(e),u=Se(e)>>1&3,f=Me(e,n-(e.filePos-s)),h=c.track.decodingInstructions.length>0;this.currentBlock={timestamp:l,duration:0,isKeyFrame:!0,data:f,lacing:u,decoded:!h,mainAdditional:null},c.blocks.push(this.currentBlock)}break;case D.BlockAdditions:this.readContiguousElements(e.slice(s,n));break;case D.BlockMore:{if(!this.currentBlock)break;this.currentBlockAdditional={addId:1,data:null},this.readContiguousElements(e.slice(s,n)),this.currentBlockAdditional.data&&this.currentBlockAdditional.addId===1&&(this.currentBlock.mainAdditional=this.currentBlockAdditional.data),this.currentBlockAdditional=null}break;case D.BlockAdditional:{if(!this.currentBlockAdditional)break;this.currentBlockAdditional.data=Me(e,n)}break;case D.BlockAddID:{if(!this.currentBlockAdditional)break;this.currentBlockAdditional.addId=qe(e,n)}break;case D.BlockDuration:{if(!this.currentBlock)break;this.currentBlock.duration=qe(e,n)}break;case D.ReferenceBlock:{if(!this.currentBlock)break;this.currentBlock.isKeyFrame=!1}break;case D.Tag:this.currentTagTargetIsMovie=!0,this.readContiguousElements(e.slice(s,n));break;case D.Targets:this.readContiguousElements(e.slice(s,n));break;case D.TargetTypeValue:qe(e,n)!==50&&(this.currentTagTargetIsMovie=!1);break;case D.TagTrackUID:case D.TagEditionUID:case D.TagChapterUID:case D.TagAttachmentUID:this.currentTagTargetIsMovie=!1;break;case D.SimpleTag:{if(!this.currentTagTargetIsMovie)break;this.currentSimpleTagName=null,this.readContiguousElements(e.slice(s,n))}break;case D.TagName:this.currentSimpleTagName=ta(e,n);break;case D.TagString:{if(!this.currentSimpleTagName)break;const o=ta(e,n);this.processTagValue(this.currentSimpleTagName,o)}break;case D.TagBinary:{if(!this.currentSimpleTagName)break;const o=Me(e,n);this.processTagValue(this.currentSimpleTagName,o)}break;case D.AttachedFile:{if(!this.currentSegment)break;this.currentAttachedFile={fileUid:null,fileName:null,fileMediaType:null,fileData:null,fileDescription:null},this.readContiguousElements(e.slice(s,n));const o=this.currentSegment.metadataTags;if(this.currentAttachedFile.fileUid&&this.currentAttachedFile.fileData&&(o.raw??={},o.raw[this.currentAttachedFile.fileUid.toString()]=new Cn(this.currentAttachedFile.fileData,this.currentAttachedFile.fileMediaType??void 0,this.currentAttachedFile.fileName??void 0,this.currentAttachedFile.fileDescription??void 0)),this.currentAttachedFile.fileMediaType?.startsWith("image/")&&this.currentAttachedFile.fileData){const c=this.currentAttachedFile.fileName;let l="unknown";if(c){const d=c.toLowerCase();d.startsWith("cover.")?l="coverFront":d.startsWith("back.")&&(l="coverBack")}o.images??=[],o.images.push({data:this.currentAttachedFile.fileData,mimeType:this.currentAttachedFile.fileMediaType,kind:l,name:this.currentAttachedFile.fileName??void 0,description:this.currentAttachedFile.fileDescription??void 0})}this.currentAttachedFile=null}break;case D.FileUID:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileUid=Lf(e,n)}break;case D.FileName:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileName=ta(e,n)}break;case D.FileMediaType:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileMediaType=wi(e,n)}break;case D.FileData:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileData=Me(e,n)}break;case D.FileDescription:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileDescription=ta(e,n)}break;case D.ContentEncodings:{if(!this.currentTrack)break;this.readContiguousElements(e.slice(s,n)),this.currentTrack.decodingInstructions.sort((o,c)=>c.order-o.order)}break;case D.ContentEncoding:this.currentDecodingInstruction={order:0,scope:Za.Block,data:null},this.readContiguousElements(e.slice(s,n)),this.currentDecodingInstruction.data&&this.currentTrack.decodingInstructions.push(this.currentDecodingInstruction),this.currentDecodingInstruction=null;break;case D.ContentEncodingOrder:{if(!this.currentDecodingInstruction)break;this.currentDecodingInstruction.order=qe(e,n)}break;case D.ContentEncodingScope:{if(!this.currentDecodingInstruction)break;this.currentDecodingInstruction.scope=qe(e,n)}break;case D.ContentCompression:{if(!this.currentDecodingInstruction)break;this.currentDecodingInstruction.data={type:"decompress",algorithm:ua.Zlib,settings:null},this.readContiguousElements(e.slice(s,n))}break;case D.ContentCompAlgo:{if(this.currentDecodingInstruction?.data?.type!=="decompress")break;this.currentDecodingInstruction.data.algorithm=qe(e,n)}break;case D.ContentCompSettings:{if(this.currentDecodingInstruction?.data?.type!=="decompress")break;this.currentDecodingInstruction.data.settings=Me(e,n)}break;case D.ContentEncryption:{if(!this.currentDecodingInstruction)break;this.currentDecodingInstruction.data={type:"decrypt"}}break}return e.filePos=s+n,!0}decodeBlockData(e,t){E(e.decodingInstructions.length>0);let i=t;for(const a of e.decodingInstructions)switch(E(a.data),a.data.type){case"decompress":switch(a.data.algorithm){case ua.HeaderStripping:if(a.data.settings&&a.data.settings.length>0){const n=a.data.settings,s=new Uint8Array(n.length+i.length);s.set(n,0),s.set(i,n.length),i=s}break}break}return i}processTagValue(e,t){if(!this.currentSegment?.metadataTags)return;const i=this.currentSegment.metadataTags;if(i.raw??={},i.raw[e]??=t,typeof t=="string")switch(e.toLowerCase()){case"title":i.title??=t;break;case"description":i.description??=t;break;case"artist":i.artist??=t;break;case"album":i.album??=t;break;case"album_artist":i.albumArtist??=t;break;case"genre":i.genre??=t;break;case"comment":i.comment??=t;break;case"lyrics":i.lyrics??=t;break;case"date":{const a=new Date(t);Number.isNaN(a.getTime())||(i.date??=a)}break;case"track_number":case"part_number":{const a=t.split("/"),n=Number.parseInt(a[0],10),s=a[1]&&Number.parseInt(a[1],10);Number.isInteger(n)&&n>0&&(i.trackNumber??=n),s&&Number.isInteger(s)&&s>0&&(i.tracksTotal??=s)}break;case"disc_number":case"disc":{const a=t.split("/"),n=Number.parseInt(a[0],10),s=a[1]&&Number.parseInt(a[1],10);Number.isInteger(n)&&n>0&&(i.discNumber??=n),s&&Number.isInteger(s)&&s>0&&(i.discsTotal??=s)}break}}}class sl{constructor(e){this.internalTrack=e,this.packetToClusterLocation=new WeakMap}getId(){return this.internalTrack.id}getCodec(){throw new Error("Not implemented on base class.")}getInternalCodecId(){return this.internalTrack.codecId}async computeDuration(){const e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getName(){return this.internalTrack.name}getLanguageCode(){return this.internalTrack.languageCode}async getFirstTimestamp(){return(await this.getFirstPacket({metadataOnly:!0}))?.timestamp??0}getTimeResolution(){return this.internalTrack.segment.timestampFactor}getDisposition(){return this.internalTrack.disposition}async getFirstPacket(e){return this.performClusterLookup(null,t=>t.trackData.get(this.internalTrack.id)?{blockIndex:0,correctBlockFound:!0}:{blockIndex:-1,correctBlockFound:!1},-1/0,1/0,e)}intoTimescale(e){return pa(e*this.internalTrack.segment.timestampFactor)}async getPacket(e,t){const i=this.intoTimescale(e);return this.performClusterLookup(null,a=>{const n=a.trackData.get(this.internalTrack.id);if(!n)return{blockIndex:-1,correctBlockFound:!1};const s=rt(n.presentationTimestamps,i,l=>l.timestamp),o=s!==-1?n.presentationTimestamps[s].blockIndex:-1,c=s!==-1&&i<n.endTimestamp;return{blockIndex:o,correctBlockFound:c}},i,i,t)}async getNextPacket(e,t){const i=this.packetToClusterLocation.get(e);if(i===void 0)throw new Error("Packet was not created from this track.");return this.performClusterLookup(i.cluster,a=>{if(a===i.cluster){const n=a.trackData.get(this.internalTrack.id);if(i.blockIndex+1<n.blocks.length)return{blockIndex:i.blockIndex+1,correctBlockFound:!0}}else if(a.trackData.get(this.internalTrack.id))return{blockIndex:0,correctBlockFound:!0};return{blockIndex:-1,correctBlockFound:!1}},-1/0,1/0,t)}async getKeyPacket(e,t){const i=this.intoTimescale(e);return this.performClusterLookup(null,a=>{const n=a.trackData.get(this.internalTrack.id);if(!n)return{blockIndex:-1,correctBlockFound:!1};const s=_n(n.presentationTimestamps,l=>n.blocks[l.blockIndex].isKeyFrame&&l.timestamp<=i),o=s!==-1?n.presentationTimestamps[s].blockIndex:-1,c=s!==-1&&i<n.endTimestamp;return{blockIndex:o,correctBlockFound:c}},i,i,t)}async getNextKeyPacket(e,t){const i=this.packetToClusterLocation.get(e);if(i===void 0)throw new Error("Packet was not created from this track.");return this.performClusterLookup(i.cluster,a=>{if(a===i.cluster){const s=a.trackData.get(this.internalTrack.id).blocks.findIndex((o,c)=>o.isKeyFrame&&c>i.blockIndex);if(s!==-1)return{blockIndex:s,correctBlockFound:!0}}else{const n=a.trackData.get(this.internalTrack.id);if(n&&n.firstKeyFrameTimestamp!==null){const s=n.blocks.findIndex(o=>o.isKeyFrame);return E(s!==-1),{blockIndex:s,correctBlockFound:!0}}}return{blockIndex:-1,correctBlockFound:!1}},-1/0,1/0,t)}async fetchPacketInCluster(e,t,i){if(t===-1)return null;const n=e.trackData.get(this.internalTrack.id).blocks[t];E(n),n.decoded||(n.data=this.internalTrack.demuxer.decodeBlockData(this.internalTrack,n.data),n.decoded=!0);const s=i.metadataOnly?rr:n.data,o=n.timestamp/this.internalTrack.segment.timestampFactor,c=n.duration/this.internalTrack.segment.timestampFactor,l={};n.mainAdditional&&this.internalTrack.info?.type==="video"&&this.internalTrack.info.alphaMode&&(l.alpha=i.metadataOnly?rr:n.mainAdditional,l.alphaByteLength=n.mainAdditional.byteLength);const d=new ht(s,n.isKeyFrame?"key":"delta",o,c,e.dataStartPos+t,n.data.byteLength,l);return this.packetToClusterLocation.set(d,{cluster:e,blockIndex:t}),d}async performClusterLookup(e,t,i,a,n){const{demuxer:s,segment:o}=this.internalTrack;let c=null,l=null,d=-1;if(e){const{blockIndex:v,correctBlockFound:b}=t(e);if(b)return this.fetchPacketInCluster(e,v,n);v!==-1&&(l=e,d=v)}const u=rt(this.internalTrack.cuePoints,i,v=>v.time),f=u!==-1?this.internalTrack.cuePoints[u]:null,h=rt(this.internalTrack.clusterPositionCache,i,v=>v.startTimestamp),g=h!==-1?this.internalTrack.clusterPositionCache[h]:null,m=Math.max(f?.clusterPosition??0,g?.elementStartPos??0)||null;let p;for(e?m===null||e.elementStartPos>=m?(p=e.elementEndPos,c=e):p=m:p=m??o.clusterSeekStartPos;o.elementEndPos===null||p<=o.elementEndPos-or;){if(c){const z=c.trackData.get(this.internalTrack.id);if(z&&z.startTimestamp>a)break}let v=s.reader.requestSliceRange(p,or,Rr);if(v instanceof Promise&&(v=await v),!v)break;const b=p,w=Fr(v);if(!w||!ka.includes(w.id)&&w.id!==D.Void){const z=await rl(s.reader,b,ka,Math.min(o.elementEndPos??1/0,b+al));if(z){p=z;continue}else break}const x=w.id;let T=w.size;const A=v.filePos;if(x===D.Cluster){c=await s.readCluster(b,o),T=c.elementEndPos-A;const{blockIndex:z,correctBlockFound:M}=t(c);if(M)return this.fetchPacketInCluster(c,z,n);z!==-1&&(l=c,d=z)}T===void 0&&(E(x!==D.Cluster),T=(await an(s.reader,A,Oa,o.elementEndPos)).pos-A);const B=A+T;if(o.elementEndPos===null){let z=s.reader.requestSliceRange(B,or,Rr);if(z instanceof Promise&&(z=await z),!z)break;if(Vn(z)===D.Segment){o.elementEndPos=B;break}}p=B}if(f&&(!l||l.elementStartPos<f.clusterPosition)){const v=this.internalTrack.cuePoints[u-1];E(!v||v.time<f.time);const b=v?.time??-1/0;return this.performClusterLookup(null,t,b,a,n)}return l?this.fetchPacketInCluster(l,d,n):null}}class Wf extends sl{constructor(e){super(e),this.decoderConfigPromise=null,this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getCodedWidth(){return this.internalTrack.info.width}getCodedHeight(){return this.internalTrack.info.height}getRotation(){return this.internalTrack.info.rotation}async getColorSpace(){return{primaries:this.internalTrack.info.colorSpace?.primaries,transfer:this.internalTrack.info.colorSpace?.transfer,matrix:this.internalTrack.info.colorSpace?.matrix,fullRange:this.internalTrack.info.colorSpace?.fullRange}}async canBeTransparent(){return this.internalTrack.info.alphaMode}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfigPromise??=(async()=>{let e=null;return(this.internalTrack.info.codec==="vp9"||this.internalTrack.info.codec==="av1"||this.internalTrack.info.codec==="avc"&&!this.internalTrack.info.codecDescription||this.internalTrack.info.codec==="hevc"&&!this.internalTrack.info.codecDescription)&&(e=await this.getFirstPacket({})),{codec:Pn({width:this.internalTrack.info.width,height:this.internalTrack.info.height,codec:this.internalTrack.info.codec,codecDescription:this.internalTrack.info.codecDescription,colorSpace:this.internalTrack.info.colorSpace,avcType:1,avcCodecInfo:this.internalTrack.info.codec==="avc"&&e?Fn(e.data):null,hevcCodecInfo:this.internalTrack.info.codec==="hevc"&&e?zn(e.data):null,vp9CodecInfo:this.internalTrack.info.codec==="vp9"&&e?$c(e.data):null,av1CodecInfo:this.internalTrack.info.codec==="av1"&&e?Hc(e.data):null}),codedWidth:this.internalTrack.info.width,codedHeight:this.internalTrack.info.height,description:this.internalTrack.info.codecDescription??void 0,colorSpace:this.internalTrack.info.colorSpace??void 0}})():null}}class Hf extends sl{constructor(e){super(e),this.decoderConfig=null,this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getNumberOfChannels(){return this.internalTrack.info.numberOfChannels}getSampleRate(){return this.internalTrack.info.sampleRate}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfig??={codec:En({codec:this.internalTrack.info.codec,codecDescription:this.internalTrack.info.codecDescription,aacCodecInfo:this.internalTrack.info.aacCodecInfo}),numberOfChannels:this.internalTrack.info.numberOfChannels,sampleRate:this.internalTrack.info.sampleRate,description:this.internalTrack.info.codecDescription??void 0}:null}}const fa=4,jf=[44100,48e3,32e3],qf=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,32,40,48,56,64,80,96,112,128,160,192,224,256,320,-1,-1,32,48,56,64,80,96,112,128,160,192,224,256,320,384,-1,-1,32,64,96,128,160,192,224,256,288,320,352,384,416,448,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1,-1,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1,-1,32,48,56,64,80,96,112,128,144,160,176,192,224,256,-1],Kf=1483304551,Gf=1231971951,Qf=(r,e,t,i,a)=>e===0?0:e===1?Math.floor(144*t/(i<<r))+a:e===2?Math.floor(144*t/i)+a:(Math.floor(12*t/i)+a)*4,Xf=(r,e)=>r===3?e===3?21:36:e===3?13:21,Ln=(r,e)=>{const t=r>>>24,i=r>>>16&255,a=r>>>8&255,n=r&255;if(t!==255&&i!==255&&a!==255&&n!==255)return{header:null,bytesAdvanced:4};if(t!==255)return{header:null,bytesAdvanced:1};if((i&224)!==224)return{header:null,bytesAdvanced:1};let s=0,o=0;i&16?s=i&8?0:1:(s=1,o=1);const c=i>>3&3,l=i>>1&3,d=a>>4&15,u=(a>>2&3)%3,f=a>>1&1,h=n>>6&3,g=n>>4&3,m=n>>3&1,p=n>>2&1,v=n&3,b=qf[s*16*4+l*16+d];if(b===-1)return{header:null,bytesAdvanced:1};const w=b*1e3,x=jf[u]>>s+o,T=Qf(s,l,w,x,f);if(e!==null&&e<T)return{header:null,bytesAdvanced:1};let A;return c===3?A=l===3?384:1152:l===3?A=384:l===2?A=1152:A=576,{header:{totalSize:T,mpegVersionId:c,layer:l,bitrate:w,frequencyIndex:u,sampleRate:x,channel:h,modeExtension:g,copyright:m,original:p,emphasis:v,audioSamplesInFrame:A},bytesAdvanced:1}},sn=r=>{let e=2130706432,t=0;for(;e!==0;)t>>=1,t|=r&e,e>>=8;return t};var Ci;(function(r){r[r.Unsynchronisation=128]="Unsynchronisation",r[r.ExtendedHeader=64]="ExtendedHeader",r[r.ExperimentalIndicator=32]="ExperimentalIndicator",r[r.Footer=16]="Footer"})(Ci||(Ci={}));var Pi;(function(r){r[r.ISO_8859_1=0]="ISO_8859_1",r[r.UTF_16_WITH_BOM=1]="UTF_16_WITH_BOM",r[r.UTF_16_BE_NO_BOM=2]="UTF_16_BE_NO_BOM",r[r.UTF_8=3]="UTF_8"})(Pi||(Pi={}));const Na=128,Ya=10,Ei=["Blues","Classic rock","Country","Dance","Disco","Funk","Grunge","Hip-hop","Jazz","Metal","New age","Oldies","Other","Pop","Rhythm and blues","Rap","Reggae","Rock","Techno","Industrial","Alternative","Ska","Death metal","Pranks","Soundtrack","Euro-techno","Ambient","Trip-hop","Vocal","Jazz & funk","Fusion","Trance","Classical","Instrumental","Acid","House","Game","Sound clip","Gospel","Noise","Alternative rock","Bass","Soul","Punk","Space","Meditative","Instrumental pop","Instrumental rock","Ethnic","Gothic","Darkwave","Techno-industrial","Electronic","Pop-folk","Eurodance","Dream","Southern rock","Comedy","Cult","Gangsta","Top 40","Christian rap","Pop/funk","Jungle music","Native US","Cabaret","New wave","Psychedelic","Rave","Showtunes","Trailer","Lo-fi","Tribal","Acid punk","Acid jazz","Polka","Retro","Musical","Rock 'n' roll","Hard rock","Folk","Folk rock","National folk","Swing","Fast fusion","Bebop","Latin","Revival","Celtic","Bluegrass","Avantgarde","Gothic rock","Progressive rock","Psychedelic rock","Symphonic rock","Slow rock","Big band","Chorus","Easy listening","Acoustic","Humour","Speech","Chanson","Opera","Chamber music","Sonata","Symphony","Booty bass","Primus","Porn groove","Satire","Slow jam","Club","Tango","Samba","Folklore","Ballad","Power ballad","Rhythmic Soul","Freestyle","Duet","Punk rock","Drum solo","A cappella","Euro-house","Dance hall","Goa music","Drum & bass","Club-house","Hardcore techno","Terror","Indie","Britpop","Negerpunk","Polsk punk","Beat","Christian gangsta rap","Heavy metal","Black metal","Crossover","Contemporary Christian","Christian rock","Merengue","Salsa","Thrash metal","Anime","Jpop","Synthpop","Christmas","Art rock","Baroque","Bhangra","Big beat","Breakbeat","Chillout","Downtempo","Dub","EBM","Eclectic","Electro","Electroclash","Emo","Experimental","Garage","Global","IDM","Illbient","Industro-Goth","Jam Band","Krautrock","Leftfield","Lounge","Math rock","New romantic","Nu-breakz","Post-punk","Post-rock","Psytrance","Shoegaze","Space rock","Trop rock","World music","Neoclassical","Audiobook","Audio theatre","Neue Deutsche Welle","Podcast","Indie rock","G-Funk","Dubstep","Garage rock","Psybient"],Zf=(r,e)=>{const t=r.filePos;e.raw??={},e.raw.TAG??=Me(r,Na-3),r.filePos=t;const i=pi(r,30);i&&(e.title??=i);const a=pi(r,30);a&&(e.artist??=a);const n=pi(r,30);n&&(e.album??=n);const s=pi(r,4),o=Number.parseInt(s,10);Number.isInteger(o)&&o>0&&(e.date??=new Date(o,0,1));const c=Me(r,30);let l;if(c[28]===0&&c[29]!==0){const u=c[29];u>0&&(e.trackNumber??=u),r.skip(-30),l=pi(r,28),r.skip(2)}else r.skip(-30),l=pi(r,30);l&&(e.comment??=l);const d=Se(r);d<Ei.length&&(e.genre??=Ei[d])},pi=(r,e)=>{const t=Me(r,e),i=bi(t.indexOf(0),t.length),a=t.subarray(0,i);let n="";for(let s=0;s<a.length;s++)n+=String.fromCharCode(a[s]);return n.trimEnd()},Ja=r=>{const e=r.filePos,t=Dt(r,3),i=Se(r),a=Se(r),n=Se(r),s=ve(r);if(t!=="ID3"||i===255||a===255||(s&2155905152)!==0)return r.filePos=e,null;const o=sn(s);return{majorVersion:i,revision:a,flags:n,size:o}},nl=(r,e,t)=>{if(![2,3,4].includes(e.majorVersion)){console.warn(`Unsupported ID3v2 major version: ${e.majorVersion}`);return}const i=Me(r,e.size),a=new Yf(e,i);if(e.flags&Ci.Footer&&a.removeFooter(),e.flags&Ci.Unsynchronisation&&e.majorVersion===3&&a.ununsynchronizeAll(),e.flags&Ci.ExtendedHeader){const n=a.readU32();e.majorVersion===3?a.pos+=n:a.pos+=n-4}for(;a.pos<=a.bytes.length-a.frameHeaderSize();){const n=a.readId3V2Frame();if(!n)break;const s=a.pos,o=a.pos+n.size;let c=!1,l=!1,d=!1;if(e.majorVersion===3?(c=!!(n.flags&64),l=!!(n.flags&128)):e.majorVersion===4&&(c=!!(n.flags&4),l=!!(n.flags&8),d=!!(n.flags&2)||!!(e.flags&Ci.Unsynchronisation)),c){console.warn(`Skipping encrypted ID3v2 frame ${n.id}`),a.pos=o;continue}if(l){console.warn(`Skipping compressed ID3v2 frame ${n.id}`),a.pos=o;continue}switch(d&&a.ununsynchronizeRegion(a.pos,o),t.raw??={},n.id[0]==="T"?t.raw[n.id]??=a.readId3V2EncodingAndText(o):t.raw[n.id]??=a.readBytes(n.size),a.pos=s,n.id){case"TIT2":case"TT2":t.title??=a.readId3V2EncodingAndText(o);break;case"TIT3":case"TT3":t.description??=a.readId3V2EncodingAndText(o);break;case"TPE1":case"TP1":t.artist??=a.readId3V2EncodingAndText(o);break;case"TALB":case"TAL":t.album??=a.readId3V2EncodingAndText(o);break;case"TPE2":case"TP2":t.albumArtist??=a.readId3V2EncodingAndText(o);break;case"TRCK":case"TRK":{const f=a.readId3V2EncodingAndText(o).split("/"),h=Number.parseInt(f[0],10),g=f[1]&&Number.parseInt(f[1],10);Number.isInteger(h)&&h>0&&(t.trackNumber??=h),g&&Number.isInteger(g)&&g>0&&(t.tracksTotal??=g)}break;case"TPOS":case"TPA":{const f=a.readId3V2EncodingAndText(o).split("/"),h=Number.parseInt(f[0],10),g=f[1]&&Number.parseInt(f[1],10);Number.isInteger(h)&&h>0&&(t.discNumber??=h),g&&Number.isInteger(g)&&g>0&&(t.discsTotal??=g)}break;case"TCON":case"TCO":{const u=a.readId3V2EncodingAndText(o);let f=/^\((\d+)\)/.exec(u);if(f){const h=Number.parseInt(f[1]);if(Ei[h]!==void 0){t.genre??=Ei[h];break}}if(f=/^\d+$/.exec(u),f){const h=Number.parseInt(f[0]);if(Ei[h]!==void 0){t.genre??=Ei[h];break}}t.genre??=u}break;case"TDRC":case"TDAT":{const u=a.readId3V2EncodingAndText(o),f=new Date(u);Number.isNaN(f.getTime())||(t.date??=f)}break;case"TYER":case"TYE":{const u=a.readId3V2EncodingAndText(o),f=Number.parseInt(u,10);Number.isInteger(f)&&(t.date??=new Date(f,0,1))}break;case"USLT":case"ULT":{const u=a.readU8();a.pos+=3,a.readId3V2Text(u,o),t.lyrics??=a.readId3V2Text(u,o)}break;case"COMM":case"COM":{const u=a.readU8();a.pos+=3,a.readId3V2Text(u,o),t.comment??=a.readId3V2Text(u,o)}break;case"APIC":case"PIC":{const u=a.readId3V2TextEncoding();let f;if(e.majorVersion===2){const p=a.readAscii(3);f=p==="PNG"?"image/png":p==="JPG"?"image/jpeg":"image/*"}else f=a.readId3V2Text(u,o);const h=a.readU8(),g=a.readId3V2Text(u,o).trimEnd(),m=o-a.pos;if(m>=0){const p=a.readBytes(m);t.images||(t.images=[]),t.images.push({data:p,mimeType:f,kind:h===3?"coverFront":h===4?"coverBack":"unknown",description:g})}}break;default:a.pos+=n.size;break}a.pos=o}};class Yf{constructor(e,t){this.header=e,this.bytes=t,this.pos=0,this.view=new DataView(t.buffer,t.byteOffset,t.byteLength)}frameHeaderSize(){return this.header.majorVersion===2?6:10}ununsynchronizeAll(){const e=[];for(let t=0;t<this.bytes.length;t++){const i=this.bytes[t];e.push(i),i===255&&t!==this.bytes.length-1&&this.bytes[t]===0&&t++}this.bytes=new Uint8Array(e),this.view=new DataView(this.bytes.buffer)}ununsynchronizeRegion(e,t){const i=[];for(let s=e;s<t;s++){const o=this.bytes[s];i.push(o),o===255&&s!==t-1&&this.bytes[s+1]===0&&s++}const a=this.bytes.subarray(0,e),n=this.bytes.subarray(t);this.bytes=new Uint8Array(a.length+i.length+n.length),this.bytes.set(a,0),this.bytes.set(i,a.length),this.bytes.set(n,a.length+i.length),this.view=new DataView(this.bytes.buffer)}removeFooter(){this.bytes=this.bytes.subarray(0,this.bytes.length-Ya),this.view=new DataView(this.bytes.buffer)}readBytes(e){const t=this.bytes.subarray(this.pos,this.pos+e);return this.pos+=e,t}readU8(){const e=this.view.getUint8(this.pos);return this.pos+=1,e}readU16(){const e=this.view.getUint16(this.pos,!1);return this.pos+=2,e}readU24(){const e=this.view.getUint16(this.pos,!1),t=this.view.getUint8(this.pos+1);return this.pos+=3,e*256+t}readU32(){const e=this.view.getUint32(this.pos,!1);return this.pos+=4,e}readAscii(e){let t="";for(let i=0;i<e;i++)t+=String.fromCharCode(this.view.getUint8(this.pos+i));return this.pos+=e,t}readId3V2Frame(){if(this.header.majorVersion===2){const e=this.readAscii(3);if(e==="\0\0\0")return null;const t=this.readU24();return{id:e,size:t,flags:0}}else{const e=this.readAscii(4);if(e==="\0\0\0\0")return null;const t=this.readU32();let i=this.header.majorVersion===4?sn(t):t;const a=this.readU16(),n=this.pos,s=o=>{const c=this.pos+o;if(c>this.bytes.length)return!1;if(c<=this.bytes.length-this.frameHeaderSize()){this.pos+=o;const l=this.readAscii(4);if(l!=="\0\0\0\0"&&!/[0-9A-Z]{4}/.test(l))return!1}return!0};if(!s(i)){const o=this.header.majorVersion===4?t:sn(t);s(o)&&(i=o)}return this.pos=n,{id:e,size:i,flags:a}}}readId3V2TextEncoding(){const e=this.readU8();if(e>3)throw new Error(`Unsupported text encoding: ${e}`);return e}readId3V2Text(e,t){const i=this.pos,a=this.readBytes(t-this.pos);switch(e){case Pi.ISO_8859_1:{let n="";for(let s=0;s<a.length;s++){const o=a[s];if(o===0){this.pos=i+s+1;break}n+=String.fromCharCode(o)}return n}case Pi.UTF_16_WITH_BOM:if(a[0]===255&&a[1]===254){const n=new TextDecoder("utf-16le"),s=bi(a.findIndex((o,c)=>o===0&&a[c+1]===0&&c%2===0),a.length);return this.pos=i+Math.min(s+2,a.length),n.decode(a.subarray(2,s))}else if(a[0]===254&&a[1]===255){const n=new TextDecoder("utf-16be"),s=bi(a.findIndex((o,c)=>o===0&&a[c+1]===0&&c%2===0),a.length);return this.pos=i+Math.min(s+2,a.length),n.decode(a.subarray(2,s))}else{const n=bi(a.findIndex(s=>s===0),a.length);return this.pos=i+Math.min(n+1,a.length),lr.decode(a.subarray(0,n))}case Pi.UTF_16_BE_NO_BOM:{const n=new TextDecoder("utf-16be"),s=bi(a.findIndex((o,c)=>o===0&&a[c+1]===0&&c%2===0),a.length);return this.pos=i+Math.min(s+2,a.length),n.decode(a.subarray(0,s))}case Pi.UTF_8:{const n=bi(a.findIndex(s=>s===0),a.length);return this.pos=i+Math.min(n+1,a.length),lr.decode(a.subarray(0,n))}}}readId3V2EncodingAndText(e){if(this.pos>=e)return"";const t=this.readId3V2TextEncoding();return this.readId3V2Text(t,e)}}const nn=async(r,e,t)=>{let i=e;for(;t===null||i<t;){let a=r.requestSlice(i,fa);if(a instanceof Promise&&(a=await a),!a)break;const n=ve(a),s=Ln(n,r.fileSize!==null?r.fileSize-i:null);if(s.header)return{header:s.header,startPos:i};i+=s.bytesAdvanced}return null};class Jf extends ei{constructor(e){super(e),this.metadataPromise=null,this.firstFrameHeader=null,this.loadedSamples=[],this.metadataTags=null,this.tracks=[],this.readingMutex=new fi,this.lastSampleLoaded=!1,this.lastLoadedPos=0,this.nextTimestampInSamples=0,this.reader=e._reader}async readMetadata(){return this.metadataPromise??=(async()=>{for(;!this.firstFrameHeader&&!this.lastSampleLoaded;)await this.advanceReader();if(!this.firstFrameHeader)throw new Error("No valid MP3 frame found.");this.tracks=[new Cr(this.input,new eh(this))]})()}async advanceReader(){if(this.lastLoadedPos===0)for(;;){let o=this.reader.requestSlice(this.lastLoadedPos,Ya);if(o instanceof Promise&&(o=await o),!o){this.lastSampleLoaded=!0;return}const c=Ja(o);if(!c)break;this.lastLoadedPos=o.filePos+c.size}const e=await nn(this.reader,this.lastLoadedPos,this.reader.fileSize);if(!e){this.lastSampleLoaded=!0;return}const t=e.header;this.lastLoadedPos=e.startPos+t.totalSize-1;const i=Xf(t.mpegVersionId,t.channel);let a=this.reader.requestSlice(e.startPos+i,4);if(a instanceof Promise&&(a=await a),a){const o=ve(a);if(o===Kf||o===Gf)return}this.firstFrameHeader||(this.firstFrameHeader=t),t.sampleRate!==this.firstFrameHeader.sampleRate&&console.warn(`MP3 changed sample rate mid-file: ${this.firstFrameHeader.sampleRate} Hz to ${t.sampleRate} Hz. Might be a bug, so please report this file.`);const n=t.audioSamplesInFrame/this.firstFrameHeader.sampleRate,s={timestamp:this.nextTimestampInSamples/this.firstFrameHeader.sampleRate,duration:n,dataStart:e.startPos,dataSize:t.totalSize};this.loadedSamples.push(s),this.nextTimestampInSamples+=t.audioSamplesInFrame}async getMimeType(){return"audio/mpeg"}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){await this.readMetadata();const e=this.tracks[0];return E(e),e.computeDuration()}async getMetadataTags(){const e=await this.readingMutex.acquire();try{if(await this.readMetadata(),this.metadataTags)return this.metadataTags;this.metadataTags={};let t=0,i=!1;for(;;){let a=this.reader.requestSlice(t,Ya);if(a instanceof Promise&&(a=await a),!a)break;const n=Ja(a);if(!n)break;i=!0;let s=this.reader.requestSlice(a.filePos,n.size);if(s instanceof Promise&&(s=await s),!s)break;nl(s,n,this.metadataTags),t=a.filePos+n.size}if(!i&&this.reader.fileSize!==null&&this.reader.fileSize>=Na){let a=this.reader.requestSlice(this.reader.fileSize-Na,Na);a instanceof Promise&&(a=await a),E(a),Dt(a,3)==="TAG"&&Zf(a,this.metadataTags)}return this.metadataTags}finally{e()}}}class eh{constructor(e){this.demuxer=e}getId(){return 1}async getFirstTimestamp(){return 0}getTimeResolution(){return E(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.sampleRate/this.demuxer.firstFrameHeader.audioSamplesInFrame}async computeDuration(){const e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getName(){return null}getLanguageCode(){return Gt}getCodec(){return"mp3"}getInternalCodecId(){return null}getNumberOfChannels(){return E(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.channel===3?1:2}getSampleRate(){return E(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.sampleRate}getDisposition(){return{...Jr}}async getDecoderConfig(){return E(this.demuxer.firstFrameHeader),{codec:"mp3",numberOfChannels:this.demuxer.firstFrameHeader.channel===3?1:2,sampleRate:this.demuxer.firstFrameHeader.sampleRate}}async getPacketAtIndex(e,t){if(e===-1)return null;const i=this.demuxer.loadedSamples[e];if(!i)return null;let a;if(t.metadataOnly)a=rr;else{let n=this.demuxer.reader.requestSlice(i.dataStart,i.dataSize);if(n instanceof Promise&&(n=await n),!n)return null;a=Me(n,i.dataSize)}return new ht(a,"key",i.timestamp,i.duration,e,i.dataSize)}getFirstPacket(e){return this.getPacketAtIndex(0,e)}async getNextPacket(e,t){const i=await this.demuxer.readingMutex.acquire();try{const a=_a(this.demuxer.loadedSamples,e.timestamp,s=>s.timestamp);if(a===-1)throw new Error("Packet was not created from this track.");const n=a+1;for(;n>=this.demuxer.loadedSamples.length&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(n,t)}finally{i()}}async getPacket(e,t){const i=await this.demuxer.readingMutex.acquire();try{for(;;){const a=rt(this.demuxer.loadedSamples,e,n=>n.timestamp);if(a===-1&&this.demuxer.loadedSamples.length>0)return null;if(this.demuxer.lastSampleLoaded)return this.getPacketAtIndex(a,t);if(a>=0&&a+1<this.demuxer.loadedSamples.length)return this.getPacketAtIndex(a,t);await this.demuxer.advanceReader()}}finally{i()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}}const ol=1399285583,th=79764919,cl=new Uint32Array(256);for(let r=0;r<256;r++){let e=r<<24;for(let t=0;t<8;t++)e=e&2147483648?e<<1^th:e<<1;cl[r]=e>>>0&4294967295}const rh=r=>{const e=kt(r),t=e.getUint32(22,!0);e.setUint32(22,0,!0);let i=0;for(let a=0;a<r.length;a++){const n=r[a];i=(i<<8^cl[i>>>24^n])>>>0}return e.setUint32(22,t,!0),i},ih=(r,e,t)=>{let i=0,a=null;if(r.length>0)if(e.codec==="vorbis"){E(e.vorbisInfo);const n=e.vorbisInfo.modeBlockflags.length,o=(1<<Ru(n-1))-1<<1,c=(r[0]&o)>>1;if(c>=e.vorbisInfo.modeBlockflags.length)throw new Error("Invalid mode number.");let l=t;const d=e.vorbisInfo.modeBlockflags[c];if(a=e.vorbisInfo.blocksizes[d],d===1){const u=(o|1)+1,f=r[0]&u?1:0;l=e.vorbisInfo.blocksizes[f]}i=l!==null?l+a>>2:0}else e.codec==="opus"&&(i=pf(r).durationInSamples);return{durationInSamples:i,vorbisBlockSize:a}},ah=r=>{let e="audio/ogg";if(r.codecStrings){const t=[...new Set(r.codecStrings)];e+=`; codecs="${t.join(", ")}"`}return e};const li=27,Ui=282,sh=Ui+65025,ha=r=>{const e=r.filePos;if(Fi(r)!==ol)return null;r.skip(1);const i=Se(r),a=Zh(r),n=Fi(r),s=Fi(r),o=Fi(r),c=Se(r),l=new Uint8Array(c);for(let h=0;h<c;h++)l[h]=Se(r);const d=27+c,u=l.reduce((h,g)=>h+g,0),f=d+u;return{headerStartPos:e,totalSize:f,dataStartPos:e+d,dataSize:u,headerType:i,granulePosition:a,serialNumber:n,sequenceNumber:s,checksum:o,lacingValues:l}},nh=(r,e)=>{for(;r.filePos<e-3;){const t=Fi(r),i=t&255,a=t>>>8&255,n=t>>>16&255,s=t>>>24&255,o=79;if(!(i!==o&&a!==o&&n!==o&&s!==o)){if(r.skip(-4),t===ol)return!0;r.skip(1)}}return!1};class oh extends ei{constructor(e){super(e),this.metadataPromise=null,this.bitstreams=[],this.tracks=[],this.metadataTags={},this.reader=e._reader}async readMetadata(){return this.metadataPromise??=(async()=>{let e=0;for(;;){let t=this.reader.requestSliceRange(e,li,Ui);if(t instanceof Promise&&(t=await t),!t)break;const i=ha(t);if(!i||!!!(i.headerType&2))break;this.bitstreams.push({serialNumber:i.serialNumber,bosPage:i,description:null,numberOfChannels:-1,sampleRate:-1,codecInfo:{codec:null,vorbisInfo:null,opusInfo:null},lastMetadataPacket:null}),e=i.headerStartPos+i.totalSize}for(const t of this.bitstreams){const i=await this.readPacket(t.bosPage,0);i&&(i.data.byteLength>=7&&i.data[0]===1&&i.data[1]===118&&i.data[2]===111&&i.data[3]===114&&i.data[4]===98&&i.data[5]===105&&i.data[6]===115?await this.readVorbisMetadata(i,t):i.data.byteLength>=8&&i.data[0]===79&&i.data[1]===112&&i.data[2]===117&&i.data[3]===115&&i.data[4]===72&&i.data[5]===101&&i.data[6]===97&&i.data[7]===100&&await this.readOpusMetadata(i,t),t.codecInfo.codec!==null&&this.tracks.push(new Cr(this.input,new ch(t,this))))}})()}async readVorbisMetadata(e,t){let i=await this.findNextPacketStart(e);if(!i)return;const a=await this.readPacket(i.startPage,i.startSegmentIndex);if(!a||(i=await this.findNextPacketStart(a),!i))return;const n=await this.readPacket(i.startPage,i.startSegmentIndex);if(!n||a.data[0]!==3||n.data[0]!==5)return;const s=[],o=u=>{for(;s.push(Math.min(255,u)),!(u<255);)u-=255};o(e.data.length),o(a.data.length);const c=new Uint8Array(1+s.length+e.data.length+a.data.length+n.data.length);c[0]=2,c.set(s,1),c.set(e.data,1+s.length),c.set(a.data,1+s.length+e.data.length),c.set(n.data,1+s.length+e.data.length+a.data.length),t.codecInfo.codec="vorbis",t.description=c,t.lastMetadataPacket=n;const l=kt(e.data);t.numberOfChannels=l.getUint8(11),t.sampleRate=l.getUint32(12,!0);const d=l.getUint8(28);t.codecInfo.vorbisInfo={blocksizes:[1<<(d&15),1<<(d>>4)],modeBlockflags:gf(n.data).modeBlockflags},Qs(a.data.subarray(7),this.metadataTags)}async readOpusMetadata(e,t){const i=await this.findNextPacketStart(e);if(!i)return;const a=await this.readPacket(i.startPage,i.startSegmentIndex);if(!a)return;t.codecInfo.codec="opus",t.description=e.data,t.lastMetadataPacket=a;const n=Mn(e.data);t.numberOfChannels=n.outputChannelCount,t.sampleRate=Ta,t.codecInfo.opusInfo={preSkip:n.preSkip},Qs(a.data.subarray(8),this.metadataTags)}async readPacket(e,t){E(t<e.lacingValues.length);let i=0;for(let u=0;u<t;u++)i+=e.lacingValues[u];let a=e,n=i,s=t;const o=[];e:for(;;){let u=this.reader.requestSlice(a.dataStartPos,a.dataSize);u instanceof Promise&&(u=await u),E(u);const f=Me(u,a.dataSize);for(;;){if(s===a.lacingValues.length){o.push(f.subarray(i,n));break}const g=a.lacingValues[s];if(n+=g,g<255){o.push(f.subarray(i,n));break e}s++}let h=a.headerStartPos+a.totalSize;for(;;){let g=this.reader.requestSliceRange(h,li,Ui);if(g instanceof Promise&&(g=await g),!g)return null;const m=ha(g);if(!m)return null;if(a=m,a.serialNumber===e.serialNumber)break;h=a.headerStartPos+a.totalSize}i=0,n=0,s=0}const c=o.reduce((u,f)=>u+f.length,0);if(c===0)return null;const l=new Uint8Array(c);let d=0;for(let u=0;u<o.length;u++){const f=o[u];l.set(f,d),d+=f.length}return{data:l,endPage:a,endSegmentIndex:s}}async findNextPacketStart(e){if(e.endSegmentIndex<e.endPage.lacingValues.length-1)return{startPage:e.endPage,startSegmentIndex:e.endSegmentIndex+1};if(!!(e.endPage.headerType&4))return null;let i=e.endPage.headerStartPos+e.endPage.totalSize;for(;;){let a=this.reader.requestSliceRange(i,li,Ui);if(a instanceof Promise&&(a=await a),!a)return null;const n=ha(a);if(!n)return null;if(n.serialNumber===e.endPage.serialNumber)return{startPage:n,startSegmentIndex:0};i=n.headerStartPos+n.totalSize}}async getMimeType(){await this.readMetadata();const e=await Promise.all(this.tracks.map(t=>t.getCodecParameterString()));return ah({codecStrings:e.filter(Boolean)})}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){const e=await this.getTracks(),t=await Promise.all(e.map(i=>i.computeDuration()));return Math.max(0,...t)}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}}class ch{constructor(e,t){this.bitstream=e,this.demuxer=t,this.encodedPacketToMetadata=new WeakMap,this.sequentialScanCache=[],this.sequentialScanMutex=new fi,this.internalSampleRate=e.codecInfo.codec==="opus"?Ta:e.sampleRate}getId(){return this.bitstream.serialNumber}getNumberOfChannels(){return this.bitstream.numberOfChannels}getSampleRate(){return this.bitstream.sampleRate}getTimeResolution(){return this.bitstream.sampleRate}getCodec(){return this.bitstream.codecInfo.codec}getInternalCodecId(){return null}async getDecoderConfig(){return E(this.bitstream.codecInfo.codec),{codec:this.bitstream.codecInfo.codec,numberOfChannels:this.bitstream.numberOfChannels,sampleRate:this.bitstream.sampleRate,description:this.bitstream.description??void 0}}getName(){return null}getLanguageCode(){return Gt}getDisposition(){return{...Jr}}async getFirstTimestamp(){return 0}async computeDuration(){const e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}granulePositionToTimestampInSamples(e){return this.bitstream.codecInfo.codec==="opus"?(E(this.bitstream.codecInfo.opusInfo),e-this.bitstream.codecInfo.opusInfo.preSkip):e}createEncodedPacketFromOggPacket(e,t,i){if(!e)return null;const{durationInSamples:a,vorbisBlockSize:n}=ih(e.data,this.bitstream.codecInfo,t.vorbisLastBlocksize),s=new ht(i.metadataOnly?rr:e.data,"key",Math.max(0,t.timestampInSamples)/this.internalSampleRate,a/this.internalSampleRate,e.endPage.headerStartPos+e.endSegmentIndex,e.data.byteLength);return this.encodedPacketToMetadata.set(s,{packet:e,timestampInSamples:t.timestampInSamples,durationInSamples:a,vorbisLastBlockSize:t.vorbisLastBlocksize,vorbisBlockSize:n}),s}async getFirstPacket(e){E(this.bitstream.lastMetadataPacket);const t=await this.demuxer.findNextPacketStart(this.bitstream.lastMetadataPacket);if(!t)return null;let i=0;this.bitstream.codecInfo.codec==="opus"&&(E(this.bitstream.codecInfo.opusInfo),i-=this.bitstream.codecInfo.opusInfo.preSkip);const a=await this.demuxer.readPacket(t.startPage,t.startSegmentIndex);return this.createEncodedPacketFromOggPacket(a,{timestampInSamples:i,vorbisLastBlocksize:null},e)}async getNextPacket(e,t){const i=this.encodedPacketToMetadata.get(e);if(!i)throw new Error("Packet was not created from this track.");const a=await this.demuxer.findNextPacketStart(i.packet);if(!a)return null;const n=i.timestampInSamples+i.durationInSamples,s=await this.demuxer.readPacket(a.startPage,a.startSegmentIndex);return this.createEncodedPacketFromOggPacket(s,{timestampInSamples:n,vorbisLastBlocksize:i.vorbisBlockSize},t)}async getPacket(e,t){if(this.demuxer.reader.fileSize===null)return this.getPacketSequential(e,t);const i=pa(e*this.internalSampleRate);if(i===0)return this.getFirstPacket(t);if(i<0)return null;E(this.bitstream.lastMetadataPacket);const a=await this.demuxer.findNextPacketStart(this.bitstream.lastMetadataPacket);if(!a)return null;let n=a.startPage,s=this.demuxer.reader.fileSize;const o=[n];e:for(;n.headerStartPos+n.totalSize<s;){const b=n.headerStartPos,w=Math.floor((b+s)/2);let x=w;for(;;){const T=Math.min(x+sh,s-li);let A=this.demuxer.reader.requestSlice(x,T-x);if(A instanceof Promise&&(A=await A),E(A),!nh(A,T)){s=w+li;continue e}let z=this.demuxer.reader.requestSliceRange(A.filePos,li,Ui);z instanceof Promise&&(z=await z),E(z);const M=ha(z);E(M);let W=!1;if(M.serialNumber===this.bitstream.serialNumber)W=!0;else{let C=this.demuxer.reader.requestSlice(M.headerStartPos,M.totalSize);C instanceof Promise&&(C=await C),E(C);const N=Me(C,M.totalSize);W=rh(N)===M.checksum}if(!W){x=M.headerStartPos+4;continue}if(W&&M.serialNumber!==this.bitstream.serialNumber){x=M.headerStartPos+M.totalSize;continue}if(M.granulePosition===-1){x=M.headerStartPos+M.totalSize;continue}this.granulePositionToTimestampInSamples(M.granulePosition)>i?s=M.headerStartPos:(n=M,o.push(M));continue e}}let c=a.startPage;for(const b of o){if(b.granulePosition===n.granulePosition)break;(!c||b.headerStartPos>c.headerStartPos)&&(c=b)}let l=c;const d=[l];for(;!(l.serialNumber===this.bitstream.serialNumber&&l.granulePosition===n.granulePosition);){const b=l.headerStartPos+l.totalSize;let w=this.demuxer.reader.requestSliceRange(b,li,Ui);w instanceof Promise&&(w=await w),E(w);const x=ha(w);E(x),l=x,l.serialNumber===this.bitstream.serialNumber&&d.push(l)}E(l.granulePosition!==-1);let u=null,f,h,g=l,m=0;if(l.headerStartPos===a.startPage.headerStartPos)f=this.granulePositionToTimestampInSamples(0),h=!0,u=0;else{f=0,h=!1;for(let x=l.lacingValues.length-1;x>=0;x--)if(l.lacingValues[x]<255){u=x+1;break}if(u===null)throw new Error("Invalid page with granule position: no packets end on this page.");m=u-1;const b={data:rr,endPage:g,endSegmentIndex:m};if(await this.demuxer.findNextPacketStart(b)){const x=Lo(d,l,u);E(x);const T=Vo(d,x.page,x.segmentIndex);T&&(l=T.page,u=T.segmentIndex)}else for(;;){const x=Lo(d,l,u);if(!x)break;const T=Vo(d,x.page,x.segmentIndex);if(!T)break;if(l=T.page,u=T.segmentIndex,x.page.headerStartPos!==g.headerStartPos){g=x.page,m=x.segmentIndex;break}}}let p=null,v=null;for(;l!==null;){E(u!==null);const b=await this.demuxer.readPacket(l,u);if(!b)break;if(!(l.headerStartPos===a.startPage.headerStartPos&&u<a.startSegmentIndex)){let T=this.createEncodedPacketFromOggPacket(b,{timestampInSamples:f,vorbisLastBlocksize:v?.vorbisBlockSize??null},t);E(T);let A=this.encodedPacketToMetadata.get(T);if(E(A),!h&&b.endPage.headerStartPos===g.headerStartPos&&b.endSegmentIndex===m?(f=this.granulePositionToTimestampInSamples(l.granulePosition),h=!0,T=this.createEncodedPacketFromOggPacket(b,{timestampInSamples:f-A.durationInSamples,vorbisLastBlocksize:v?.vorbisBlockSize??null},t),E(T),A=this.encodedPacketToMetadata.get(T),E(A)):f+=A.durationInSamples,p=T,v=A,h&&(Math.max(f,0)>i||Math.max(A.timestampInSamples,0)===i))break}const x=await this.demuxer.findNextPacketStart(b);if(!x)break;l=x.startPage,u=x.startSegmentIndex}return p}async getPacketSequential(e,t){const i=await this.sequentialScanMutex.acquire();try{const a=pa(e*this.internalSampleRate);e=a/this.internalSampleRate;const n=rt(this.sequentialScanCache,a,c=>c.timestampInSamples);let s;if(n!==-1){const c=this.sequentialScanCache[n];s=this.createEncodedPacketFromOggPacket(c.packet,{timestampInSamples:c.timestampInSamples,vorbisLastBlocksize:c.vorbisLastBlockSize},t)}else s=await this.getFirstPacket(t);let o=0;for(;s&&s.timestamp<e;){const c=await this.getNextPacket(s,t);if(!c||c.timestamp>e)break;if(s=c,o++,o===100){o=0;const l=this.encodedPacketToMetadata.get(s);E(l),this.sequentialScanCache.length>0&&E(wt(this.sequentialScanCache).timestampInSamples<=l.timestampInSamples),this.sequentialScanCache.push(l)}}return s}finally{i()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}}const Vo=(r,e,t)=>{let i=e,a=t;e:for(;;){for(a--,a;a>=0;a--)if(i.lacingValues[a]<255){a++;break e}if(E(a===-1),!(i.headerType&1)){a=0;break}const s=Pc(r,o=>o.headerStartPos<i.headerStartPos);if(!s)return null;i=s,a=i.lacingValues.length}if(E(a!==-1),a===i.lacingValues.length){const n=r[r.indexOf(i)+1];E(n),i=n,a=0}return{page:i,segmentIndex:a}},Lo=(r,e,t)=>{if(t>0)return{page:e,segmentIndex:t-1};const i=Pc(r,a=>a.headerStartPos<e.headerStartPos);return i?{page:i,segmentIndex:i.lacingValues.length-1}:null};var Ir;(function(r){r[r.PCM=1]="PCM",r[r.IEEE_FLOAT=3]="IEEE_FLOAT",r[r.ALAW=6]="ALAW",r[r.MULAW=7]="MULAW",r[r.EXTENSIBLE=65534]="EXTENSIBLE"})(Ir||(Ir={}));class lh extends ei{constructor(e){super(e),this.metadataPromise=null,this.dataStart=-1,this.dataSize=-1,this.audioInfo=null,this.tracks=[],this.lastKnownPacketIndex=0,this.metadataTags={},this.reader=e._reader}async readMetadata(){return this.metadataPromise??=(async()=>{let e=this.reader.requestSlice(0,12);e instanceof Promise&&(e=await e),E(e);const t=Dt(e,4),i=t!=="RIFX",a=t==="RF64",n=Qr(e,i);let s=a?this.reader.fileSize:Math.min(n+8,this.reader.fileSize??1/0);if(Dt(e,4)!=="WAVE")throw new Error("Invalid WAVE file - wrong format");let c=0,l=null,d=e.filePos;for(;s===null||d<s;){let f=this.reader.requestSlice(d,8);if(f instanceof Promise&&(f=await f),!f)break;const h=Dt(f,4),g=Qr(f,i),m=f.filePos;if(a&&c===0&&h!=="ds64")throw new Error('Invalid RF64 file: First chunk must be "ds64".');if(h==="fmt ")await this.parseFmtChunk(m,g,i);else if(h==="data"){if(l??=g,this.dataStart=f.filePos,this.dataSize=Math.min(l,(s??1/0)-this.dataStart),this.reader.fileSize===null)break}else if(h==="ds64"){let p=this.reader.requestSlice(m,g);if(p instanceof Promise&&(p=await p),!p)break;const v=$o(p,i);l=$o(p,i),s=Math.min(v+8,this.reader.fileSize??1/0)}else h==="LIST"?await this.parseListChunk(m,g,i):(h==="ID3 "||h==="id3 ")&&await this.parseId3Chunk(m,g);d=m+g+(g&1),c++}if(!this.audioInfo)throw new Error('Invalid WAVE file - missing "fmt " chunk');if(this.dataStart===-1)throw new Error('Invalid WAVE file - missing "data" chunk');const u=this.audioInfo.blockSizeInBytes;this.dataSize=Math.floor(this.dataSize/u)*u,this.tracks.push(new Cr(this.input,new dh(this)))})()}async parseFmtChunk(e,t,i){let a=this.reader.requestSlice(e,t);if(a instanceof Promise&&(a=await a),!a)return;let n=ra(a,i);const s=ra(a,i),o=Qr(a,i);a.skip(4);const c=ra(a,i);let l;if(t===14?l=8:l=ra(a,i),t>=18&&n!==357){const d=ra(a,i),u=t-18;if(Math.min(u,d)>=22&&n===Ir.EXTENSIBLE){a.skip(6);const h=Me(a,16);n=h[0]|h[1]<<8}}(n===Ir.MULAW||n===Ir.ALAW)&&(l=8),this.audioInfo={format:n,numberOfChannels:s,sampleRate:o,sampleSizeInBytes:Math.ceil(l/8),blockSizeInBytes:c}}async parseListChunk(e,t,i){let a=this.reader.requestSlice(e,t);if(a instanceof Promise&&(a=await a),!a)return;const n=Dt(a,4);if(n!=="INFO"&&n!=="INF0")return;let s=a.filePos;for(;s<=e+t-8;){a.filePos=s;const o=Dt(a,4),c=Qr(a,i),l=Me(a,c);let d=0;for(let f=0;f<l.length&&l[f]!==0;f++)d++;const u=String.fromCharCode(...l.subarray(0,d));switch(this.metadataTags.raw??={},this.metadataTags.raw[o]=u,o){case"INAM":case"TITL":this.metadataTags.title??=u;break;case"TIT3":this.metadataTags.description??=u;break;case"IART":this.metadataTags.artist??=u;break;case"IPRD":this.metadataTags.album??=u;break;case"IPRT":case"ITRK":case"TRCK":{const f=u.split("/"),h=Number.parseInt(f[0],10),g=f[1]&&Number.parseInt(f[1],10);Number.isInteger(h)&&h>0&&(this.metadataTags.trackNumber??=h),g&&Number.isInteger(g)&&g>0&&(this.metadataTags.tracksTotal??=g)}break;case"ICRD":case"IDIT":{const f=new Date(u);Number.isNaN(f.getTime())||(this.metadataTags.date??=f)}break;case"YEAR":{const f=Number.parseInt(u,10);Number.isInteger(f)&&f>0&&(this.metadataTags.date??=new Date(f,0,1))}break;case"IGNR":case"GENR":this.metadataTags.genre??=u;break;case"ICMT":case"CMNT":case"COMM":this.metadataTags.comment??=u;break}s+=8+c+(c&1)}}async parseId3Chunk(e,t){let i=this.reader.requestSlice(e,t);if(i instanceof Promise&&(i=await i),!i)return;const a=Ja(i);if(a){const n=i.slice(e+10,a.size);nl(n,a,this.metadataTags)}}getCodec(){if(E(this.audioInfo),this.audioInfo.format===Ir.MULAW)return"ulaw";if(this.audioInfo.format===Ir.ALAW)return"alaw";if(this.audioInfo.format===Ir.PCM){if(this.audioInfo.sampleSizeInBytes===1)return"pcm-u8";if(this.audioInfo.sampleSizeInBytes===2)return"pcm-s16";if(this.audioInfo.sampleSizeInBytes===3)return"pcm-s24";if(this.audioInfo.sampleSizeInBytes===4)return"pcm-s32"}return this.audioInfo.format===Ir.IEEE_FLOAT&&this.audioInfo.sampleSizeInBytes===4?"pcm-f32":null}async getMimeType(){return"audio/wav"}async computeDuration(){await this.readMetadata();const e=this.tracks[0];return E(e),e.computeDuration()}async getTracks(){return await this.readMetadata(),this.tracks}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}}const gi=2048;class dh{constructor(e){this.demuxer=e}getId(){return 1}getCodec(){return this.demuxer.getCodec()}getInternalCodecId(){return E(this.demuxer.audioInfo),this.demuxer.audioInfo.format}async getDecoderConfig(){const e=this.demuxer.getCodec();return e?(E(this.demuxer.audioInfo),{codec:e,numberOfChannels:this.demuxer.audioInfo.numberOfChannels,sampleRate:this.demuxer.audioInfo.sampleRate}):null}async computeDuration(){const e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getNumberOfChannels(){return E(this.demuxer.audioInfo),this.demuxer.audioInfo.numberOfChannels}getSampleRate(){return E(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getTimeResolution(){return E(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getName(){return null}getLanguageCode(){return Gt}getDisposition(){return{...Jr}}async getFirstTimestamp(){return 0}async getPacketAtIndex(e,t){E(this.demuxer.audioInfo);const i=e*gi*this.demuxer.audioInfo.blockSizeInBytes;if(i>=this.demuxer.dataSize)return null;const a=Math.min(gi*this.demuxer.audioInfo.blockSizeInBytes,this.demuxer.dataSize-i);if(this.demuxer.reader.fileSize===null){let c=this.demuxer.reader.requestSlice(this.demuxer.dataStart+i,a);if(c instanceof Promise&&(c=await c),!c)return null}let n;if(t.metadataOnly)n=rr;else{let c=this.demuxer.reader.requestSlice(this.demuxer.dataStart+i,a);c instanceof Promise&&(c=await c),E(c),n=Me(c,a)}const s=e*gi/this.demuxer.audioInfo.sampleRate,o=a/this.demuxer.audioInfo.blockSizeInBytes/this.demuxer.audioInfo.sampleRate;return this.demuxer.lastKnownPacketIndex=Math.max(e,s),new ht(n,"key",s,o,e,a)}getFirstPacket(e){return this.getPacketAtIndex(0,e)}async getPacket(e,t){E(this.demuxer.audioInfo);const i=Math.floor(Math.min(e*this.demuxer.audioInfo.sampleRate/gi,(this.demuxer.dataSize-1)/(gi*this.demuxer.audioInfo.blockSizeInBytes))),a=await this.getPacketAtIndex(i,t);if(a)return a;if(i===0)return null;E(this.demuxer.reader.fileSize===null);let n=await this.getPacketAtIndex(this.demuxer.lastKnownPacketIndex,t);for(;n;){const s=await this.getNextPacket(n,t);if(!s)break;n=s}return n}getNextPacket(e,t){E(this.demuxer.audioInfo);const i=Math.round(e.timestamp*this.demuxer.audioInfo.sampleRate/gi);return this.getPacketAtIndex(i+1,t)}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}}const ya=7,Zr=9,Nr=r=>{const e=r.filePos,t=Me(r,9),i=new ft(t);if(i.readBits(12)!==4095||(i.skipBits(1),i.readBits(2)!==0))return null;const s=i.readBits(1),o=i.readBits(2)+1,c=i.readBits(4);if(c===15)return null;i.skipBits(1);const l=i.readBits(3);if(l===0)throw new Error("ADTS frames with channel configuration 0 are not supported.");i.skipBits(1),i.skipBits(1),i.skipBits(1),i.skipBits(1);const d=i.readBits(13);i.skipBits(11);const u=i.readBits(2)+1;if(u!==1)throw new Error("ADTS frames with more than one AAC frame are not supported.");let f=null;return s===1?r.filePos-=2:f=i.readBits(16),{objectType:o,samplingFrequencyIndex:c,channelConfiguration:l,frameLength:d,numberOfAacFrames:u,crcCheck:f,startPos:e}};const es=1024;class uh extends ei{constructor(e){super(e),this.metadataPromise=null,this.firstFrameHeader=null,this.loadedSamples=[],this.tracks=[],this.readingMutex=new fi,this.lastSampleLoaded=!1,this.lastLoadedPos=0,this.nextTimestampInSamples=0,this.reader=e._reader}async readMetadata(){return this.metadataPromise??=(async()=>{for(;!this.firstFrameHeader&&!this.lastSampleLoaded;)await this.advanceReader();E(this.firstFrameHeader),this.tracks=[new Cr(this.input,new fh(this))]})()}async advanceReader(){let e=this.reader.requestSliceRange(this.lastLoadedPos,ya,Zr);if(e instanceof Promise&&(e=await e),!e){this.lastSampleLoaded=!0;return}const t=Nr(e);if(!t){this.lastSampleLoaded=!0;return}if(this.reader.fileSize!==null&&t.startPos+t.frameLength>this.reader.fileSize){this.lastSampleLoaded=!0;return}this.firstFrameHeader||(this.firstFrameHeader=t);const i=Yr[t.samplingFrequencyIndex];E(i!==void 0);const a=es/i,n={timestamp:this.nextTimestampInSamples/i,duration:a,dataStart:t.startPos,dataSize:t.frameLength};this.loadedSamples.push(n),this.nextTimestampInSamples+=es,this.lastLoadedPos=t.startPos+t.frameLength}async getMimeType(){return"audio/aac"}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){await this.readMetadata();const e=this.tracks[0];return E(e),e.computeDuration()}async getMetadataTags(){return{}}}class fh{constructor(e){this.demuxer=e}getId(){return 1}async getFirstTimestamp(){return 0}getTimeResolution(){return this.getSampleRate()/es}async computeDuration(){const e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getName(){return null}getLanguageCode(){return Gt}getCodec(){return"aac"}getInternalCodecId(){return E(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.objectType}getNumberOfChannels(){E(this.demuxer.firstFrameHeader);const e=Xi[this.demuxer.firstFrameHeader.channelConfiguration];return E(e!==void 0),e}getSampleRate(){E(this.demuxer.firstFrameHeader);const e=Yr[this.demuxer.firstFrameHeader.samplingFrequencyIndex];return E(e!==void 0),e}getDisposition(){return{...Jr}}async getDecoderConfig(){return E(this.demuxer.firstFrameHeader),{codec:`mp4a.40.${this.demuxer.firstFrameHeader.objectType}`,numberOfChannels:this.getNumberOfChannels(),sampleRate:this.getSampleRate()}}async getPacketAtIndex(e,t){if(e===-1)return null;const i=this.demuxer.loadedSamples[e];if(!i)return null;let a;if(t.metadataOnly)a=rr;else{let n=this.demuxer.reader.requestSlice(i.dataStart,i.dataSize);if(n instanceof Promise&&(n=await n),!n)return null;a=Me(n,i.dataSize)}return new ht(a,"key",i.timestamp,i.duration,e,i.dataSize)}getFirstPacket(e){return this.getPacketAtIndex(0,e)}async getNextPacket(e,t){const i=await this.demuxer.readingMutex.acquire();try{const a=_a(this.demuxer.loadedSamples,e.timestamp,s=>s.timestamp);if(a===-1)throw new Error("Packet was not created from this track.");const n=a+1;for(;n>=this.demuxer.loadedSamples.length&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(n,t)}finally{i()}}async getPacket(e,t){const i=await this.demuxer.readingMutex.acquire();try{for(;;){const a=rt(this.demuxer.loadedSamples,e,n=>n.timestamp);if(a===-1&&this.demuxer.loadedSamples.length>0)return null;if(this.demuxer.lastSampleLoaded)return this.getPacketAtIndex(a,t);if(a>=0&&a+1<this.demuxer.loadedSamples.length)return this.getPacketAtIndex(a,t);await this.demuxer.advanceReader()}}finally{i()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}}const hh=r=>r===0?null:r===1?192:r>=2&&r<=5?144*2**r:r===6?"uncommon-u8":r===7?"uncommon-u16":r>=8&&r<=15?2**r:null,mh=(r,e)=>{switch(r){case 0:return e;case 1:return 88200;case 2:return 176400;case 3:return 192e3;case 4:return 8e3;case 5:return 16e3;case 6:return 22050;case 7:return 24e3;case 8:return 32e3;case 9:return 44100;case 10:return 48e3;case 11:return 96e3;case 12:return"uncommon-u8";case 13:return"uncommon-u16";case 14:return"uncommon-u16-10";default:return null}},ph=r=>{let e=0;const t=new ft(Me(r,1));for(;t.readBits(1)===1;)e++;if(e===0)return t.readBits(7);const i=[],a=e-1,n=new ft(Me(r,a)),s=8-e-1;for(let c=0;c<s;c++)i.unshift(t.readBits(1));for(let c=0;c<a;c++)for(let l=0;l<8;l++){const d=n.readBits(1);l<2||i.unshift(d)}return i.reduce((c,l,d)=>c|l<<d,0)},gh=(r,e)=>{if(e==="uncommon-u16")return zt(r)+1;if(e==="uncommon-u8")return Se(r)+1;if(typeof e=="number")return e;Tr(e),E(!1)},vh=(r,e)=>e==="uncommon-u16"?zt(r):e==="uncommon-u16-10"?zt(r)*10:e==="uncommon-u8"?Se(r):typeof e=="number"?e:null,bh=r=>{let t=0;for(const i of r){t^=i;for(let a=0;a<8;a++)(t&128)!==0?t=t<<1^7:t<<=1,t&=255}return t};class wh extends ei{constructor(e){super(e),this.loadedSamples=[],this.metadataPromise=null,this.track=null,this.metadataTags={},this.audioInfo=null,this.lastLoadedPos=null,this.blockingBit=null,this.readingMutex=new fi,this.lastSampleLoaded=!1,this.reader=e._reader}async computeDuration(){return await this.readMetadata(),E(this.track),this.track.computeDuration()}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}async getTracks(){return await this.readMetadata(),E(this.track),[this.track]}async getMimeType(){return"audio/flac"}async readMetadata(){let e=4;return this.metadataPromise??=(async()=>{for(;this.reader.fileSize===null||e<this.reader.fileSize;){let t=this.reader.requestSlice(e,4);if(t instanceof Promise&&(t=await t),e+=4,t===null)throw new Error(`Metadata block at position ${e} is too small! Corrupted file.`);E(t);const i=Se(t),a=xi(t),n=(i&128)!==0;switch(i&127){case Ni.STREAMINFO:{let o=this.reader.requestSlice(e,a);if(o instanceof Promise&&(o=await o),E(o),o===null)throw new Error(`StreamInfo block at position ${e} is too small! Corrupted file.`);const c=Me(o,34),l=new ft(c),d=l.readBits(16),u=l.readBits(16),f=l.readBits(24),h=l.readBits(24),g=l.readBits(20),m=l.readBits(3)+1;l.readBits(5);const p=l.readBits(36);l.skipBits(128);const v=new Uint8Array(42);v.set(new Uint8Array([102,76,97,67]),0),v.set(new Uint8Array([128,0,0,34]),4),v.set(c,8),this.audioInfo={numberOfChannels:m,sampleRate:g,totalSamples:p,minimumBlockSize:d,maximumBlockSize:u,minimumFrameSize:f,maximumFrameSize:h,description:v},this.track=new Cr(this.input,new kh(this));break}case Ni.VORBIS_COMMENT:{let o=this.reader.requestSlice(e,a);o instanceof Promise&&(o=await o),E(o),Qs(Me(o,a),this.metadataTags);break}case Ni.PICTURE:{let o=this.reader.requestSlice(e,a);o instanceof Promise&&(o=await o),E(o);const c=ve(o),l=ve(o),d=lr.decode(Me(o,l)),u=ve(o),f=lr.decode(Me(o,u));o.skip(16);const h=ve(o),g=Me(o,h);this.metadataTags.images??=[],this.metadataTags.images.push({data:g,mimeType:d,kind:c===3?"coverFront":c===4?"coverBack":"unknown",description:f});break}}if(e+=a,n){this.lastLoadedPos=e;break}}})()}async readNextFlacFrame({startPos:e,isFirstPacket:t}){E(this.audioInfo);const i=6,n=this.audioInfo.maximumFrameSize+16,s=await this.reader.requestSliceRange(e,this.audioInfo.minimumFrameSize,n);if(!s)return null;const o=this.readFlacFrameHeader({slice:s,isFirstPacket:t});if(!o)return null;for(s.filePos=e+this.audioInfo.minimumFrameSize;;){if(s.filePos>s.end-i)return{num:o.num,blockSize:o.blockSize,sampleRate:o.sampleRate,size:s.end-e,isLastFrame:!0};if(Se(s)===255){const l=s.filePos,d=Se(s),u=this.blockingBit===1?249:248;if(d!==u){s.filePos=l;continue}s.skip(-2);const f=s.filePos-e,h=this.readFlacFrameHeader({slice:s,isFirstPacket:!1});if(!h){s.filePos=l;continue}if(this.blockingBit===0){if(h.num-o.num!==1){s.filePos=l;continue}}else if(h.num-o.num!==o.blockSize){s.filePos=l;continue}return{num:o.num,blockSize:o.blockSize,sampleRate:o.sampleRate,size:f,isLastFrame:!1}}}}readFlacFrameHeader({slice:e,isFirstPacket:t}){const i=e.filePos,a=Me(e,4),n=new ft(a);if(n.readBits(15)!==32764)return null;if(this.blockingBit===null){E(t);const p=n.readBits(1);this.blockingBit=p}else if(this.blockingBit===1){if(E(!t),n.readBits(1)!==1)return null}else if(this.blockingBit===0){if(E(!t),n.readBits(1)!==0)return null}else throw new Error("Invalid blocking bit");const o=hh(n.readBits(4));if(!o)return null;E(this.audioInfo);const c=mh(n.readBits(4),this.audioInfo.sampleRate);if(!c||(n.readBits(4),n.readBits(3),n.readBits(1)!==0))return null;const d=ph(e),u=gh(e,o),f=vh(e,c);if(f===null||f!==this.audioInfo.sampleRate)return null;const h=e.filePos-i,g=Se(e);e.skip(-h),e.skip(-1);const m=bh(Me(e,h));return g!==m?null:{num:d,blockSize:u,sampleRate:f}}async advanceReader(){await this.readMetadata(),E(this.lastLoadedPos!==null),E(this.audioInfo);const e=this.lastLoadedPos,t=await this.readNextFlacFrame({startPos:e,isFirstPacket:this.loadedSamples.length===0});if(!t){this.lastSampleLoaded=!0;return}const i=this.loadedSamples[this.loadedSamples.length-1],n={blockOffset:i?i.blockOffset+i.blockSize:0,blockSize:t.blockSize,byteOffset:e,byteSize:t.size};if(this.lastLoadedPos=this.lastLoadedPos+t.size,this.loadedSamples.push(n),t.isLastFrame){this.lastSampleLoaded=!0;return}}}class kh{constructor(e){this.demuxer=e}getId(){return 1}getCodec(){return"flac"}getInternalCodecId(){return null}getNumberOfChannels(){return E(this.demuxer.audioInfo),this.demuxer.audioInfo.numberOfChannels}async computeDuration(){const e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getSampleRate(){return E(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getName(){return null}getLanguageCode(){return Gt}getTimeResolution(){return E(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getDisposition(){return{...Jr}}async getFirstTimestamp(){return 0}async getDecoderConfig(){return E(this.demuxer.audioInfo),{codec:"flac",numberOfChannels:this.demuxer.audioInfo.numberOfChannels,sampleRate:this.demuxer.audioInfo.sampleRate,description:this.demuxer.audioInfo.description}}async getPacket(e,t){if(E(this.demuxer.audioInfo),e<0)throw new Error("Timestamp cannot be negative");const i=await this.demuxer.readingMutex.acquire();try{for(;;){const a=rt(this.demuxer.loadedSamples,e,c=>c.blockOffset/this.demuxer.audioInfo.sampleRate);if(a===-1){await this.demuxer.advanceReader();continue}const n=this.demuxer.loadedSamples[a],s=n.blockOffset/this.demuxer.audioInfo.sampleRate,o=n.blockSize/this.demuxer.audioInfo.sampleRate;if(s+o<=e){if(this.demuxer.lastSampleLoaded)return this.getPacketAtIndex(this.demuxer.loadedSamples.length-1,t);await this.demuxer.advanceReader();continue}return this.getPacketAtIndex(a,t)}}finally{i()}}async getNextPacket(e,t){const i=await this.demuxer.readingMutex.acquire();try{const a=e.sequenceNumber+1;if(this.demuxer.lastSampleLoaded&&a>=this.demuxer.loadedSamples.length)return null;for(;a>=this.demuxer.loadedSamples.length&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(a,t)}finally{i()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}async getPacketAtIndex(e,t){const i=this.demuxer.loadedSamples[e];if(!i)return null;let a;if(t.metadataOnly)a=rr;else{let o=this.demuxer.reader.requestSlice(i.byteOffset,i.byteSize);if(o instanceof Promise&&(o=await o),!o)return null;a=Me(o,i.byteSize)}E(this.demuxer.audioInfo);const n=i.blockOffset/this.demuxer.audioInfo.sampleRate,s=i.blockSize/this.demuxer.audioInfo.sampleRate;return new ht(a,"key",n,s,e,i.byteSize)}async getFirstPacket(e){for(;this.demuxer.loadedSamples.length===0&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(0,e)}}const Ar=9e4,er=188,yh=r=>{let e="video/MP2T";const t=[...new Set(r.filter(Boolean))];return t.length>0&&(e+=`; codecs="${t.join(", ")}"`),e};const ki="No PES packet found where one was expected.";class xh extends ei{constructor(e){super(e),this.metadataPromise=null,this.elementaryStreams=[],this.tracks=[],this.packetOffset=0,this.packetStride=-1,this.sectionEndPositions=[],this.reader=e._reader}async readMetadata(){return this.metadataPromise??=(async()=>{const e=er+16+1;let t=this.reader.requestSlice(0,e);t instanceof Promise&&(t=await t),E(t);const i=Me(t,e);if(i[0]===71&&i[er]===71)this.packetOffset=0,this.packetStride=er;else if(i[0]===71&&i[er+16]===71)this.packetOffset=0,this.packetStride=er+16;else if(i[4]===71&&i[4+er]===71)this.packetOffset=4,this.packetStride=er;else throw new Error("Unreachable.");let a=this.packetOffset,n=null,s=!1,o=!1;for(;;){const c=await this.readSection(a,!0,!o);if(!c)break;const l=3,d=32;if(c.pid===0&&!s){const f=new ft(c.payload),h=f.readAlignedByte();f.skipBits(8*h),f.skipBits(14);const g=f.readBits(10);for(f.skipBits(40);8*(g+l)-f.pos>d;){const m=f.readBits(16);if(f.skipBits(3),m!==0){if(n!==null)throw new Error("Only files with a single program are supported.");n=f.readBits(13)}}if(n===null)throw new Error("Program Association Table must link to a Program Map Table.");s=!0}else if(c.pid===n&&!o){const f=new ft(c.payload),h=f.readAlignedByte();f.skipBits(8*h),f.skipBits(12);const g=f.readBits(12);f.skipBits(43),f.readBits(13),f.skipBits(6);const m=f.readBits(10);for(f.skipBits(8*m);8*(g+l)-f.pos>d;){const p=f.readBits(8);f.skipBits(3);const v=f.readBits(13);f.skipBits(6);const b=f.readBits(10);f.skipBits(8*b);let w=null;switch(p){case 3:case 4:case 15:w={type:"audio",codec:p===15?"aac":"mp3",aacCodecInfo:null,numberOfChannels:-1,sampleRate:-1};break;case 27:case 36:w={type:"video",codec:p===27?"avc":"hevc",avcCodecInfo:null,hevcCodecInfo:null,colorSpace:{primaries:null,transfer:null,matrix:null,fullRange:null},width:-1,height:-1,reorderSize:-1};break}w&&this.elementaryStreams.push({demuxer:this,pid:v,streamType:p,initialized:!1,firstSection:null,info:w})}o=!0}else{const f=this.elementaryStreams.find(h=>h.pid===c.pid);if(f&&!f.initialized){const h=Ii(c);if(!h)throw new Error(`Couldn't read first PES packet for Elementary Stream with PID ${f.pid}`);if(f.firstSection=c,f.info.type==="video")if(f.info.codec==="avc"){if(f.info.avcCodecInfo=Fn(h.data),!f.info.avcCodecInfo)throw new Error("Invalid AVC video stream; could not extract AVCDecoderConfigurationRecord from first packet.");const g=f.info.avcCodecInfo.sequenceParameterSets[0];E(g);const m=Bn(g);f.info.width=m.displayWidth,f.info.height=m.displayHeight,f.info.colorSpace={primaries:qa[m.colourPrimaries],transfer:Ka[m.transferCharacteristics],matrix:Ga[m.matrixCoefficients],fullRange:!!m.fullRangeFlag},f.info.reorderSize=m.maxDecFrameBuffering,f.initialized=!0}else if(f.info.codec==="hevc"){if(f.info.hevcCodecInfo=zn(h.data),!f.info.hevcCodecInfo)throw new Error("Invalid HEVC video stream; could not extract HVCDecoderConfigurationRecord from first packet.");const m=f.info.hevcCodecInfo.arrays.find(v=>v.nalUnitType===Vt.SPS_NUT).nalUnits[0];E(m);const p=Lc(m);f.info.width=p.displayWidth,f.info.height=p.displayHeight,f.info.colorSpace={primaries:qa[p.colourPrimaries],transfer:Ka[p.transferCharacteristics],matrix:Ga[p.matrixCoefficients],fullRange:!!p.fullRangeFlag},f.info.reorderSize=p.maxDecFrameBuffering,f.initialized=!0}else throw new Error("Unhandled.");else if(f.info.codec==="aac"){const g=ir.tempFromBytes(h.data),m=Nr(g);if(!m)throw new Error("Invalid AAC audio stream; could not read ADTS frame header from first packet.");f.info.aacCodecInfo={isMpeg2:!1,objectType:m.objectType},f.info.numberOfChannels=Xi[m.channelConfiguration],f.info.sampleRate=Yr[m.samplingFrequencyIndex],f.initialized=!0}else if(f.info.codec==="mp3"){const g=ve(ir.tempFromBytes(h.data)),m=Ln(g,h.data.byteLength);if(!m.header)throw new Error("Invalid MP3 audio stream; could not read frame header from first packet.");f.info.numberOfChannels=m.header.channel===3?1:2,f.info.sampleRate=m.header.sampleRate,f.initialized=!0}else throw new Error("Unhandled.")}}if(o&&this.elementaryStreams.every(f=>f.initialized))break;E(c.endPos!==null),a=c.endPos}for(const c of this.elementaryStreams)c.info.type==="video"?this.tracks.push(new Zi(this.input,new _h(c))):this.tracks.push(new Cr(this.input,new Th(c)))})()}async getTracks(){return await this.readMetadata(),this.tracks}async getMetadataTags(){return{}}async computeDuration(){const e=await this.getTracks(),t=await Promise.all(e.map(i=>i.computeDuration()));return Math.max(0,...t)}async getMimeType(){await this.readMetadata();const e=await this.getTracks(),t=await Promise.all(e.map(i=>i.getCodecParameterString()));return yh(t)}async readSection(e,t,i=!1){let a=e,n=e;const s=[];let o=0,c=null,l=!0;for(;;){const u=await this.readPacket(n);if(n+=this.packetStride,!u)break;if(c){if(u.pid!==c.pid){if(i)break;continue}if(u.payloadUnitStartIndicator===1)break}else{if(u.payloadUnitStartIndicator===0)break;c=u}const f=!!(u.adaptationFieldControl&2),h=!!(u.adaptationFieldControl&1);let g=0;if(f&&(g=1+u.body[0]),h&&(g===0?(s.push(u.body),o+=u.body.byteLength):(s.push(u.body.subarray(g)),o+=u.body.byteLength-g)),a=n,!t&&o>=64){l=!1;break}if(_a(this.sectionEndPositions,a,p=>p)!==-1){l=!1;break}}if(l){const u=rt(this.sectionEndPositions,a,f=>f);this.sectionEndPositions.splice(u+1,0,a)}if(!c)return null;let d;if(s.length===1)d=s[0];else{const u=s.reduce((h,g)=>h+g.length,0);d=new Uint8Array(u);let f=0;for(const h of s)d.set(h,f),f+=h.length}return{startPos:e,endPos:t?a:null,pid:c.pid,payload:d}}async readPacketHeader(e){let t=this.reader.requestSlice(e,4);if(t instanceof Promise&&(t=await t),!t)return null;if(Se(t)!==71)throw new Error("Invalid TS packet sync byte. Likely an internal bug, please report this file.");const a=zt(t),n=a>>14&1,s=a&8191,c=Se(t)>>4&3;return{payloadUnitStartIndicator:n,pid:s,adaptationFieldControl:c}}async readPacket(e){let t=this.reader.requestSlice(e,er);if(t instanceof Promise&&(t=await t),!t)return null;const i=Me(t,er);if(i[0]!==71)throw new Error("Invalid TS packet sync byte. Likely an internal bug, please report this file.");const n=(i[1]<<8)+i[2],s=n>>14&1,o=n&8191,l=i[3]>>4&3;return{payloadUnitStartIndicator:s,pid:o,adaptationFieldControl:l,body:i.subarray(4)}}}const yi=r=>{const e=new ft(r.payload);if(e.readBits(24)!==1)return null;const i=e.readBits(8);if(e.skipBits(16),i===188||i===190||i===191||i===240||i===241||i===255||i===242||i===248)return null;e.skipBits(8);const a=e.readBits(2);e.skipBits(14);let n=0;if(a===2||a===3)e.skipBits(4),n+=e.readBits(3)*(1<<30),e.skipBits(1),n+=e.readBits(15)*32768,e.skipBits(1),n+=e.readBits(15);else throw new Error("PES packets without PTS are not currently supported. If you think this file should be supported, please report it.");return{sectionStartPos:r.startPos,sectionEndPos:r.endPos,pts:n}},Ii=r=>{E(r.endPos!==null);const e=yi(r);if(!e)return null;const t=new ft(r.payload);t.skipBits(32);const i=t.readBits(16),a=6;t.skipBits(16);const n=t.readBits(8),s=t.pos+8*n;t.pos=s;const o=s/8;E(Number.isInteger(o));const c=r.payload.subarray(o,i>0?a+i:r.payload.byteLength);return{...e,data:c}};class ll{constructor(e){this.elementaryStream=e,this.referencePesPackets=[],this.endReferencePesPacketAdded=!1,this.packetBuffers=new WeakMap,this.packetSectionStarts=new WeakMap,this.mutex=new fi}getId(){return this.elementaryStream.pid}getCodec(){throw new Error("Not implemented on base class.")}getInternalCodecId(){return this.elementaryStream.streamType}getName(){return null}getLanguageCode(){return Gt}getDisposition(){return Jr}getTimeResolution(){return Ar}async computeDuration(){const e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}async getFirstTimestamp(){return(await this.getFirstPacket({metadataOnly:!0}))?.timestamp??0}createEncodedPacket(e,t,i){return new ht(i.metadataOnly?rr:e.data,this.getPacketType(e.data),e.pts/Ar,Math.max(t/Ar,0),e.sequenceNumber,e.data.byteLength)}maybeInsertReferencePacket(e,t,i){if(i&&this.mutex.pending>0)return;const a=rt(this.referencePesPackets,e.pts,n=>n.pts);if(a>=0){const n=this.referencePesPackets[a];if(e.sectionStartPos<=n.sectionStartPos||!t&&e.pts-n.pts<Ar/2)return!1;if(a<this.referencePesPackets.length-1){const s=this.referencePesPackets[a+1];if(s.sectionStartPos<e.sectionStartPos||!t&&s.pts-e.pts<Ar/2)return!1}}return this.referencePesPackets.splice(a+1,0,e),!0}async getFirstPacket(e){const t=this.elementaryStream.firstSection;E(t);const i=Ii(t);E(i);const a=new Ai(this,i,!0),n=new za(this,a),s=await n.readNext();if(!s)return null;const o=this.createEncodedPacket(s.packet,s.duration,e);return this.packetBuffers.set(o,n),this.packetSectionStarts.set(o,s.packet.sectionStartPos),o}async getNextPacket(e,t){let i=this.packetBuffers.get(e);if(i){const d=await i.readNext();if(!d)return null;this.packetBuffers.delete(e);const u=this.createEncodedPacket(d.packet,d.duration,t);return this.packetBuffers.set(u,i),this.packetSectionStarts.set(u,d.packet.sectionStartPos),u}const a=this.packetSectionStarts.get(e);if(a===void 0)throw new Error("Packet was not created from this track.");const s=await this.elementaryStream.demuxer.readSection(a,!0);E(s);const o=Ii(s);E(o);const c=new Ai(this,o,!0);i=new za(this,c);const l=e.sequenceNumber;for(;;){const d=await i.readNext();if(!d)return null;if(d.packet.sequenceNumber>l){const u=this.createEncodedPacket(d.packet,d.duration,t);return this.packetBuffers.set(u,i),this.packetSectionStarts.set(u,d.packet.sectionStartPos),u}}}async getNextKeyPacket(e,t){let i=e;for(;;){if(i=await this.getNextPacket(i,t),!i)return null;if(i.type==="key")return i}}getPacket(e,t){return this.doPacketLookup(e,!1,t)}getKeyPacket(e,t){return this.doPacketLookup(e,!0,t)}async doPacketLookup(e,t,i){const a=pa(e*Ar),n=this.elementaryStream.demuxer,s=n.reader,o=await this.mutex.acquire();let c;try{if(this.referencePesPackets.length===0){const b=this.elementaryStream.firstSection;E(b);const w=yi(b);E(w),this.maybeInsertReferencePacket(w,!1,!1),E(this.referencePesPackets.length===1)}let p=rt(this.referencePesPackets,a,b=>b.pts);if(p===-1)return null;if(s.fileSize!==null&&p===this.referencePesPackets.length-1&&!this.endReferencePesPacketAdded){let b=s.fileSize-n.packetStride+n.packetOffset,w=await n.readPacketHeader(b);if(!w)return null;for(;w.pid!==this.elementaryStream.pid||w.payloadUnitStartIndicator===0;){b-=n.packetStride;const A=await n.readPacketHeader(b);if(!A)return null;w=A}const x=await n.readSection(b,!1);E(x);const T=yi(x);if(!T)throw new Error(ki);this.maybeInsertReferencePacket(T,!0,!1),this.endReferencePesPacketAdded=!0}for(p=rt(this.referencePesPackets,a,b=>b.pts),E(p!==-1);s.fileSize!==null;){const b=this.referencePesPackets[p],w=this.referencePesPackets[p+1];if(a-b.pts<Ar||!w)break;let T=Qa((b.sectionStartPos+w.sectionStartPos)/2,n.packetStride)+n.packetOffset,A=await n.readPacketHeader(T);for(E(A);T<w.sectionStartPos&&(A.pid!==this.elementaryStream.pid||A.payloadUnitStartIndicator===0);){T+=n.packetStride;const W=await n.readPacketHeader(T);if(!W)return null;A=W}if(T>=w.sectionStartPos)break;const B=await n.readSection(T,!1);E(B);const z=yi(B);if(!z)throw new Error(ki);if(!this.maybeInsertReferencePacket(z,!1,!1))break;z.pts<=a&&p++}c=this.referencePesPackets[p],E(c.pts<=a)}finally{o()}o();e:for(;;){let p=c.sectionStartPos+n.packetStride;for(;;){const w=await n.readPacketHeader(p);if(!w)break e;if(w.pid===this.elementaryStream.pid&&w.payloadUnitStartIndicator===1)break;p+=n.packetStride}const v=await n.readSection(p,!1);if(!v)break;const b=yi(v);if(!b)throw new Error(ki);if(b.pts>a)break;c=b,s.fileSize===null&&this.maybeInsertReferencePacket(b,!1,!0)}const l=this.getReorderSize();for(let p=0;p<l;p++){let v=c.sectionStartPos-n.packetStride;for(;;){const b=await n.readPacketHeader(v);if(!b)break;if(b.pid===this.elementaryStream.pid&&b.payloadUnitStartIndicator===1){const w=await n.readSection(v,!1);E(w);const x=yi(w);if(!x)throw new Error(ki);c=x;break}v-=n.packetStride}}const d=await n.readSection(c.sectionStartPos,!0);E(d);const u=Ii(d);E(u);const f=new Ai(this,u,!0),h=new za(this,f);for(;!((wt(h.presentationOrderPackets)?.pts??-1/0)>=a||!await h.readNextDecodeOrderPacket()););const g=_n(h.presentationOrderPackets,p=>p.pts<=a&&(!t||this.getPacketType(p.data)==="key"));if(g!==-1){const p=h.presentationOrderPackets[g],v=g===0?0:p.pts-h.presentationOrderPackets[g-1].pts;for(;h.decodeOrderPackets[0]!==p;)h.decodeOrderPackets.shift();h.lastDuration=v;const b=await h.readNext();E(b);const w=this.createEncodedPacket(b.packet,b.duration,i);return this.packetBuffers.set(w,h),this.packetSectionStarts.set(w,b.packet.sectionStartPos),w}if(!t)return null;let m=c.sectionStartPos;for(;;){m-=n.packetStride;const p=await n.readPacketHeader(m);if(!p)return null;if(p.pid!==this.elementaryStream.pid||p.payloadUnitStartIndicator!==1)continue;const v=await n.readSection(m,!0);E(v);const b=Ii(v);if(!b)throw new Error(ki);const w=new Ai(this,b,!1);if(await this.markNextPacket(w),!w.suppliedPacket||this.getPacketType(w.suppliedPacket.data)!=="key")continue;w.uncapped=!0;const x=new za(this,w),T=await x.readNext();E(T);const A=this.createEncodedPacket(T.packet,T.duration,i);return this.packetBuffers.set(A,x),this.packetSectionStarts.set(A,T.packet.sectionStartPos),A}}}class _h extends ll{constructor(e){super(e),this.elementaryStream=e,this.decoderConfig={codec:Pn({width:this.elementaryStream.info.width,height:this.elementaryStream.info.height,codec:this.elementaryStream.info.codec,codecDescription:null,colorSpace:this.elementaryStream.info.colorSpace,avcType:1,avcCodecInfo:this.elementaryStream.info.avcCodecInfo,hevcCodecInfo:this.elementaryStream.info.hevcCodecInfo,vp9CodecInfo:null,av1CodecInfo:null}),codedWidth:this.elementaryStream.info.width,codedHeight:this.elementaryStream.info.height,colorSpace:this.elementaryStream.info.colorSpace}}getCodec(){return this.elementaryStream.info.codec}getCodedWidth(){return this.elementaryStream.info.width}getCodedHeight(){return this.elementaryStream.info.height}getRotation(){return 0}async getColorSpace(){return this.elementaryStream.info.colorSpace}async canBeTransparent(){return!1}async getDecoderConfig(){return this.decoderConfig}getPacketType(e){return Rn(this.elementaryStream.info.codec,this.decoderConfig,e)??"key"}getReorderSize(){return this.elementaryStream.info.reorderSize}async markNextPacket(e){E(!e.suppliedPacket);const t=this.elementaryStream.info.codec,i=1024;if(t!=="avc"&&t!=="hevc")throw new Error("Unhandled.");let a=null;for(;;){let n=e.ensureBuffered(i);if(n instanceof Promise&&(n=await n),n===0)break;const s=e.currentPos,o=e.readBytes(n),c=o.byteLength;let l=0;for(;l<c;){const d=o.indexOf(0,l);if(d===-1||d>=c)break;l=d;const u=s+l;if(l+4>=c){e.seekTo(u);break}const f=o[l+1],h=o[l+2],g=o[l+3];let m=0,p=null;if(f===0&&h===0&&g===1?(m=4,p=o[l+4]):f===0&&h===1&&(m=3,p=g),m===0){l++;continue}const v=u;if(a===null){a=v,l+=m;continue}if(p!==null){const b=t==="avc"?cs(p):va(p);if(t==="avc"?b===xr.AUD:b===Vt.AUD_NUT){const x=v-a;return e.seekTo(a),e.supplyPacket(x,0)}}l+=m}if(n<i)break}if(a!==null){const n=e.endPos-a;return e.seekTo(a),e.supplyPacket(n,0)}}}class Th extends ll{constructor(e){super(e),this.elementaryStream=e}getCodec(){return this.elementaryStream.info.codec}getNumberOfChannels(){return this.elementaryStream.info.numberOfChannels}getSampleRate(){return this.elementaryStream.info.sampleRate}async getDecoderConfig(){return{codec:En({codec:this.elementaryStream.info.codec,codecDescription:null,aacCodecInfo:this.elementaryStream.info.aacCodecInfo}),numberOfChannels:this.elementaryStream.info.numberOfChannels,sampleRate:this.elementaryStream.info.sampleRate}}getPacketType(e){return"key"}getReorderSize(){return 1}async markNextPacket(e){E(!e.suppliedPacket);const t=this.elementaryStream.info.codec,i=128;for(;;){let a=e.ensureBuffered(i);a instanceof Promise&&(a=await a);const n=e.currentPos;for(;e.currentPos-n<a;){const s=e.readU8();if(t==="aac"){if(s!==255)continue;e.skip(-1);const o=e.currentPos;let c=e.ensureBuffered(Zr);if(c instanceof Promise&&(c=await c),c<Zr)return;const l=e.readBytes(Zr),d=Nr(ir.tempFromBytes(l));if(d){e.seekTo(o);let u=e.ensureBuffered(d.frameLength);return u instanceof Promise&&(u=await u),e.supplyPacket(u,Math.round(es*Ar/this.elementaryStream.info.sampleRate))}else e.seekTo(o+1)}else if(t==="mp3"){if(s!==255)continue;e.skip(-1);const o=e.currentPos;let c=e.ensureBuffered(fa);if(c instanceof Promise&&(c=await c),c<fa)return;const l=e.readBytes(fa),d=kt(l).getUint32(0),u=Ln(d,null);if(u.header){e.seekTo(o);let f=e.ensureBuffered(u.header.totalSize);f instanceof Promise&&(f=await f);const h=u.header.audioSamplesInFrame*Ar/this.elementaryStream.info.sampleRate;return e.supplyPacket(f,Math.round(h))}else e.seekTo(o+1)}else throw new Error("Unhandled.")}if(a<i)break}}}class Ai{constructor(e,t,i){this.currentPos=0,this.pesPackets=[],this.currentPesPacketIndex=0,this.currentPesPacketPos=0,this.endPos=0,this.nextPts=0,this.suppliedPacket=null,this.backing=e,this.pid=e.elementaryStream.pid,this.demuxer=e.elementaryStream.demuxer,this.startingPesPacket=t,this.uncapped=i}clone(){const e=new Ai(this.backing,this.startingPesPacket,!0);return e.currentPos=this.currentPos,e.pesPackets=[...this.pesPackets],e.currentPesPacketIndex=this.currentPesPacketIndex,e.currentPesPacketPos=this.currentPesPacketPos,e.endPos=this.endPos,e.nextPts=this.nextPts,e}ensureBuffered(e){const t=this.endPos-this.currentPos;return t>=e?e:this.bufferData(e-t).then(()=>Math.min(this.endPos-this.currentPos,e))}getCurrentPesPacket(){const e=this.pesPackets[this.currentPesPacketIndex];return E(e),e}async bufferData(e){const t=this.endPos+e;for(;this.endPos<t;){let i;if(this.pesPackets.length===0)i=this.startingPesPacket;else{let a=wt(this.pesPackets).sectionEndPos;for(E(a!==null);;){const o=await this.demuxer.readPacketHeader(a);if(!o)return;if(o.pid===this.pid)break;a+=this.demuxer.packetStride}const n=await this.demuxer.readSection(a,!0);if(!n)return;const s=Ii(n);if(!s)throw new Error(ki);i=s}this.pesPackets.push(i),this.endPos+=i.data.byteLength,this.pesPackets.length===1&&(this.nextPts=i.pts)}}readBytes(e){const t=this.getCurrentPesPacket(),i=this.currentPos-this.currentPesPacketPos,a=i+e;if(this.currentPos+=e,a<=t.data.byteLength)return t.data.subarray(i,a);const n=new Uint8Array(e);n.set(t.data.subarray(i));let s=t.data.byteLength-i;for(;;){this.advanceCurrentPacket();const o=this.getCurrentPesPacket(),c=e-s;if(c<=o.data.byteLength){n.set(o.data.subarray(0,c),s);break}n.set(o.data,s),s+=o.data.byteLength}return n}readU8(){let e=this.getCurrentPesPacket();const t=this.currentPos-this.currentPesPacketPos;return this.currentPos++,t<e.data.byteLength?e.data[t]:(this.advanceCurrentPacket(),e=this.getCurrentPesPacket(),e.data[0])}seekTo(e){if(e!==this.currentPos){if(e<this.currentPos)for(;e<this.currentPesPacketPos;){this.currentPesPacketIndex--;const t=this.getCurrentPesPacket();this.currentPesPacketPos-=t.data.byteLength,this.nextPts=t.pts}else for(;;){const t=this.getCurrentPesPacket(),i=this.currentPesPacketPos+t.data.byteLength;if(e<i)break;this.currentPesPacketPos+=t.data.byteLength,this.currentPesPacketIndex++,this.nextPts=this.getCurrentPesPacket().pts}this.currentPos=e}}skip(e){this.seekTo(this.currentPos+e)}advanceCurrentPacket(){this.currentPesPacketPos+=this.getCurrentPesPacket().data.byteLength,this.currentPesPacketIndex++,this.nextPts=this.getCurrentPesPacket().pts}supplyPacket(e,t){const i=this.getCurrentPesPacket();if(!this.uncapped&&i!==this.startingPesPacket){this.suppliedPacket=null;return}this.backing.maybeInsertReferencePacket(i,!1,!0);const a=this.nextPts;this.nextPts+=t;const n=i.sectionStartPos,s=n+(this.currentPos-this.currentPesPacketPos),o=this.readBytes(e);this.suppliedPacket={pts:a,data:o,sequenceNumber:s,sectionStartPos:n},this.pesPackets.splice(0,this.currentPesPacketIndex),this.currentPesPacketIndex=0}}class za{constructor(e,t){this.decodeOrderPackets=[],this.reorderBuffer=[],this.presentationOrderPackets=[],this.reachedEnd=!1,this.lastDuration=0,this.backing=e,this.context=t,this.reorderSize=e.getReorderSize(),E(this.reorderSize>=0)}async readNext(){if(this.decodeOrderPackets.length===0&&!await this.readNextDecodeOrderPacket())return null;await this.ensureCurrentPacketHasNext();const e=this.decodeOrderPackets[0],t=this.presentationOrderPackets.indexOf(e);E(t!==-1);let i;for(t===this.presentationOrderPackets.length-1?i=this.lastDuration:(i=this.presentationOrderPackets[t+1].pts-e.pts,this.lastDuration=i),this.decodeOrderPackets.shift();this.presentationOrderPackets.length>0;){const a=this.presentationOrderPackets[0];if(this.decodeOrderPackets.includes(a))break;this.presentationOrderPackets.shift()}return{packet:e,duration:i}}async readNextDecodeOrderPacket(){if(this.reachedEnd)return!1;let e;return this.context.suppliedPacket?e=this.context.suppliedPacket:(await this.backing.markNextPacket(this.context),e=this.context.suppliedPacket),this.context.suppliedPacket=null,e?(this.decodeOrderPackets.push(e),this.processPacketThroughReorderBuffer(e),!0):(this.reachedEnd=!0,this.flushReorderBuffer(),!1)}async ensureCurrentPacketHasNext(){const e=this.decodeOrderPackets[0];for(E(e);;){const t=this.presentationOrderPackets.indexOf(e);if(t!==-1&&t<=this.presentationOrderPackets.length-2||!await this.readNextDecodeOrderPacket())break}}processPacketThroughReorderBuffer(e){if(this.reorderBuffer.push(e),this.reorderBuffer.length>=this.reorderSize){let t=0;for(let a=1;a<this.reorderBuffer.length;a++)this.reorderBuffer[a].pts<this.reorderBuffer[t].pts&&(t=a);const i=this.reorderBuffer.splice(t,1)[0];this.presentationOrderPackets.push(i)}}flushReorderBuffer(){this.reorderBuffer.sort((e,t)=>e.pts-t.pts),this.presentationOrderPackets.push(...this.reorderBuffer),this.reorderBuffer.length=0}}class Vr{}class dl extends Vr{async _getMajorBrand(e){let t=e._reader.requestSlice(0,12);return t instanceof Promise&&(t=await t),!t||(t.skip(4),Dt(t,4)!=="ftyp")?null:Dt(t,4)}_createDemuxer(e){return new Ff(e)}}class Sh extends dl{async _canReadInput(e){const t=await this._getMajorBrand(e);return!!t&&t!=="qt  "}get name(){return"MP4"}get mimeType(){return"video/mp4"}}class Ch extends dl{async _canReadInput(e){return await this._getMajorBrand(e)==="qt  "}get name(){return"QuickTime File Format"}get mimeType(){return"video/quicktime"}}class ul extends Vr{async isSupportedEBMLOfDocType(e,t){let i=e._reader.requestSlice(0,Rr);if(i instanceof Promise&&(i=await i),!i)return!1;const a=el(i);if(a===null||a<1||a>8||qe(i,a)!==D.EBML)return!1;const s=tl(i);if(typeof s!="number")return!1;let o=e._reader.requestSlice(i.filePos,s);if(o instanceof Promise&&(o=await o),!o)return!1;const c=i.filePos;for(;o.filePos<=c+s-or;){const l=Fr(o);if(!l)break;const{id:d,size:u}=l,f=o.filePos;if(u===void 0)return!1;switch(d){case D.EBMLVersion:if(qe(o,u)!==1)return!1;break;case D.EBMLReadVersion:if(qe(o,u)!==1)return!1;break;case D.DocType:if(wi(o,u)!==t)return!1;break;case D.DocTypeVersion:if(qe(o,u)>4)return!1;break}o.filePos=f+u}return!0}_canReadInput(e){return this.isSupportedEBMLOfDocType(e,"matroska")}_createDemuxer(e){return new $f(e)}get name(){return"Matroska"}get mimeType(){return"video/x-matroska"}}class Ph extends ul{_canReadInput(e){return this.isSupportedEBMLOfDocType(e,"webm")}get name(){return"WebM"}get mimeType(){return"video/webm"}}class Eh extends Vr{async _canReadInput(e){let t=e._reader.requestSlice(0,10);if(t instanceof Promise&&(t=await t),!t)return!1;let i=0,a=!1;for(;;){let l=e._reader.requestSlice(i,Ya);if(l instanceof Promise&&(l=await l),!l)break;const d=Ja(l);if(!d)break;a=!0,i=l.filePos+d.size}const n=await nn(e._reader,i,i+4096);if(!n)return!1;if(a)return!0;i=n.startPos+n.header.totalSize;const s=await nn(e._reader,i,i+fa);if(!s)return!1;const o=n.header,c=s.header;return!(o.channel!==c.channel||o.sampleRate!==c.sampleRate)}_createDemuxer(e){return new Jf(e)}get name(){return"MP3"}get mimeType(){return"audio/mpeg"}}class Ih extends Vr{async _canReadInput(e){let t=e._reader.requestSlice(0,12);if(t instanceof Promise&&(t=await t),!t)return!1;const i=Dt(t,4);return i!=="RIFF"&&i!=="RIFX"&&i!=="RF64"?!1:(t.skip(4),Dt(t,4)==="WAVE")}_createDemuxer(e){return new lh(e)}get name(){return"WAVE"}get mimeType(){return"audio/wav"}}class Ah extends Vr{async _canReadInput(e){let t=e._reader.requestSlice(0,4);return t instanceof Promise&&(t=await t),t?Dt(t,4)==="OggS":!1}_createDemuxer(e){return new oh(e)}get name(){return"Ogg"}get mimeType(){return"application/ogg"}}class Fh extends Vr{async _canReadInput(e){let t=e._reader.requestSlice(0,4);return t instanceof Promise&&(t=await t),t?Dt(t,4)==="fLaC":!1}get name(){return"FLAC"}get mimeType(){return"audio/flac"}_createDemuxer(e){return new wh(e)}}class Bh extends Vr{async _canReadInput(e){let t=e._reader.requestSliceRange(0,ya,Zr);if(t instanceof Promise&&(t=await t),!t)return!1;const i=Nr(t);if(!i||(t=e._reader.requestSliceRange(i.frameLength,ya,Zr),t instanceof Promise&&(t=await t),!t))return!1;const a=Nr(t);return a?i.objectType===a.objectType&&i.samplingFrequencyIndex===a.samplingFrequencyIndex&&i.channelConfiguration===a.channelConfiguration:!1}_createDemuxer(e){return new uh(e)}get name(){return"ADTS"}get mimeType(){return"audio/aac"}}class zh extends Vr{async _canReadInput(e){const t=er+16+1;let i=e._reader.requestSlice(0,t);if(i instanceof Promise&&(i=await i),!i)return!1;const a=Me(i,t);return a[0]===71&&a[er]===71||a[0]===71&&a[er+16]===71?!0:a[4]===71&&a[4+er]===71}_createDemuxer(e){return new xh(e)}get name(){return"MPEG Transport Stream"}get mimeType(){return"video/MP2T"}}const Mh=new Sh,Rh=new Ch,Dh=new ul,Oh=new Ph,Nh=new Eh,Uh=new Ih,Vh=new Ah,Lh=new Bh,$h=new Fh,Wh=new zh,Hh=[Mh,Rh,Dh,Oh,Uh,Vh,$h,Nh,Lh,Wh];class fl{constructor(){this._disposed=!1,this._sizePromise=null,this.onread=null}async getSizeOrNull(){if(this._disposed)throw new tr;return this._sizePromise??=Promise.resolve(this._retrieveSize())}async getSize(){if(this._disposed)throw new tr;const e=await this.getSizeOrNull();if(e===null)throw new Error("Cannot determine the size of an unsized source.");return e}}class jh extends fl{constructor(e,t={}){if(!(e instanceof Blob))throw new TypeError("blob must be a Blob.");if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.maxCacheSize!==void 0&&(!Ic(t.maxCacheSize)||t.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative number.");super(),this._readers=new WeakMap,this._blob=e,this._orchestrator=new Kh({maxCacheSize:t.maxCacheSize??8*2**20,maxWorkerCount:4,runWorker:this._runWorker.bind(this),prefetchProfile:qh.fileSystem})}_retrieveSize(){const e=this._blob.size;return this._orchestrator.fileSize=e,e}_read(e,t){return this._orchestrator.read(e,t)}async _runWorker(e){let t=this._readers.get(e);for(t===void 0&&("stream"in this._blob&&!da()?t=this._blob.slice(e.currentPos).stream().getReader():t=null,this._readers.set(e,t));e.currentPos<e.targetPos&&!e.aborted;)if(t){const{done:i,value:a}=await t.read();if(i)throw this._orchestrator.forgetWorker(e),new Error("Blob reader stopped unexpectedly before all requested data was read.");if(e.aborted)break;this.onread?.(e.currentPos,e.currentPos+a.length),this._orchestrator.supplyWorkerData(e,a)}else{const i=await this._blob.slice(e.currentPos,e.targetPos).arrayBuffer();if(e.aborted)break;this.onread?.(e.currentPos,e.currentPos+i.byteLength),this._orchestrator.supplyWorkerData(e,new Uint8Array(i))}e.running=!1,e.aborted&&await t?.cancel()}_dispose(){this._orchestrator.dispose()}}const qh={fileSystem:(r,e)=>(r=Math.floor((r-65536)/65536)*65536,e=Math.ceil((e+65536)/65536)*65536,{start:r,end:e})};class Kh{constructor(e){this.options=e,this.fileSize=null,this.nextAge=0,this.workers=[],this.cache=[],this.currentCacheSize=0,this.disposed=!1}read(e,t){E(this.fileSize!==null);const i=this.options.prefetchProfile(e,t,this.workers),a=Math.max(i.start,0),n=Math.min(i.end,this.fileSize);E(a<=e&&t<=n);let s=null;const o=rt(this.cache,e,b=>b.start),c=o!==-1?this.cache[o]:null;c&&c.start<=e&&t<=c.end&&(c.age=this.nextAge++,s={bytes:c.bytes,view:c.view,offset:c.start});const l=rt(this.cache,a,b=>b.start),d=s?null:new Uint8Array(t-e);let u=0,f=a;const h=[];if(l!==-1){for(let b=l;b<this.cache.length;b++){const w=this.cache[b];if(w.start>=n)break;if(w.end<=a)continue;const x=Math.max(a,w.start),T=Math.min(n,w.end);if(E(x<=T),f<x&&h.push({start:f,end:x}),f=T,d){const A=Math.max(e,w.start),B=Math.min(t,w.end);if(A<B){const z=A-e;d.set(w.bytes.subarray(A-w.start,B-w.start),z),z===u&&(u=B-e)}}w.age=this.nextAge++}f<n&&h.push({start:f,end:n})}else h.push({start:a,end:n});if(d&&u>=d.length&&(s={bytes:d,view:kt(d),offset:e}),h.length===0)return E(s),s;const{promise:g,resolve:m,reject:p}=Rt(),v=[];for(const b of h){const w=Math.max(e,b.start),x=Math.min(t,b.end);w===b.start&&x===b.end?v.push(b):w<x&&v.push({start:w,end:x})}for(const b of h){const w=d&&{start:e,bytes:d,holes:v,resolve:m,reject:p};let x=!1;for(const T of this.workers)if(To(b.start-131072,b.start,T.currentPos,T.targetPos)){T.targetPos=Math.max(T.targetPos,b.end),x=!0,w&&!T.pendingSlices.includes(w)&&T.pendingSlices.push(w),T.running||this.runWorker(T);break}if(!x){const T=this.createWorker(b.start,b.end);w&&(T.pendingSlices=[w]),this.runWorker(T)}}return s||(E(d),s=g.then(b=>({bytes:b,view:kt(b),offset:e}))),s}createWorker(e,t){const i={startPos:e,currentPos:e,targetPos:t,running:!1,aborted:this.disposed,pendingSlices:[],age:this.nextAge++};for(this.workers.push(i);this.workers.length>this.options.maxWorkerCount;){let a=0,n=this.workers[0];for(let s=1;s<this.workers.length;s++){const o=this.workers[s];o.age<n.age&&(a=s,n=o)}if(n.running&&n.pendingSlices.length>0)break;n.aborted=!0,this.workers.splice(a,1)}return i}runWorker(e){E(!e.running),E(e.currentPos<e.targetPos),e.running=!0,e.age=this.nextAge++,this.options.runWorker(e).catch(t=>{if(e.running=!1,e.pendingSlices.length>0)e.pendingSlices.forEach(i=>i.reject(t)),e.pendingSlices.length=0;else throw t})}supplyWorkerData(e,t){E(!e.aborted);const i=e.currentPos,a=i+t.length;this.insertIntoCache({start:i,end:a,bytes:t,view:kt(t),age:this.nextAge++}),e.currentPos+=t.length,e.targetPos=Math.max(e.targetPos,e.currentPos);for(let n=0;n<e.pendingSlices.length;n++){const s=e.pendingSlices[n],o=Math.max(i,s.start),c=Math.min(a,s.start+s.bytes.length);o<c&&s.bytes.set(t.subarray(o-i,c-i),o-s.start);for(let l=0;l<s.holes.length;l++){const d=s.holes[l];i<=d.start&&a>d.start&&(d.start=a),d.end<=d.start&&(s.holes.splice(l,1),l--)}s.holes.length===0&&(s.resolve(s.bytes),e.pendingSlices.splice(n,1),n--)}for(let n=0;n<this.workers.length;n++){const s=this.workers[n];e===s||s.running||To(i,a,s.currentPos,s.targetPos)&&(this.workers.splice(n,1),n--)}}forgetWorker(e){const t=this.workers.indexOf(e);E(t!==-1),this.workers.splice(t,1)}insertIntoCache(e){if(this.options.maxCacheSize===0)return;let t=rt(this.cache,e.start,i=>i.start)+1;if(t>0){const i=this.cache[t-1];if(i.end>=e.end)return;if(i.end>e.start){const a=new Uint8Array(e.end-i.start);a.set(i.bytes,0),a.set(e.bytes,e.start-i.start),this.currentCacheSize+=e.end-i.end,i.bytes=a,i.view=kt(a),i.end=e.end,t--,e=i}else this.cache.splice(t,0,e),this.currentCacheSize+=e.bytes.length}else this.cache.splice(t,0,e),this.currentCacheSize+=e.bytes.length;for(let i=t+1;i<this.cache.length;i++){const a=this.cache[i];if(e.end<=a.start)break;if(e.end>=a.end){this.cache.splice(i,1),this.currentCacheSize-=a.bytes.length,i--;continue}const n=new Uint8Array(a.end-e.start);n.set(e.bytes,0),n.set(a.bytes,a.start-e.start),this.currentCacheSize-=e.end-a.start,e.bytes=n,e.view=kt(n),e.end=a.end,this.cache.splice(i,1);break}for(;this.currentCacheSize>this.options.maxCacheSize;){let i=0,a=this.cache[0];for(let n=1;n<this.cache.length;n++){const s=this.cache[n];s.age<a.age&&(i=n,a=s)}if(this.currentCacheSize-a.bytes.length<=this.options.maxCacheSize)break;this.cache.splice(i,1),this.currentCacheSize-=a.bytes.length}}dispose(){for(const e of this.workers)e.aborted=!0;this.workers.length=0,this.cache.length=0,this.disposed=!0}}Ec();class hl{get disposed(){return this._disposed}constructor(e){if(this._demuxerPromise=null,this._format=null,this._disposed=!1,!e||typeof e!="object")throw new TypeError("options must be an object.");if(!Array.isArray(e.formats)||e.formats.some(t=>!(t instanceof Vr)))throw new TypeError("options.formats must be an array of InputFormat.");if(!(e.source instanceof fl))throw new TypeError("options.source must be a Source.");if(e.source._disposed)throw new Error("options.source must not be disposed.");this._formats=e.formats,this._source=e.source,this._reader=new Gh(e.source)}_getDemuxer(){return this._demuxerPromise??=(async()=>{this._reader.fileSize=await this._source.getSizeOrNull();for(const e of this._formats)if(await e._canReadInput(this))return this._format=e,e._createDemuxer(this);throw new Error("Input has an unsupported or unrecognizable format.")})()}get source(){return this._source}async getFormat(){return await this._getDemuxer(),E(this._format),this._format}async computeDuration(){return(await this._getDemuxer()).computeDuration()}async getFirstTimestamp(){const e=await this.getTracks();if(e.length===0)return 0;const t=await Promise.all(e.map(i=>i.getFirstTimestamp()));return Math.min(...t)}async getTracks(){return(await this._getDemuxer()).getTracks()}async getVideoTracks(){return(await this.getTracks()).filter(t=>t.isVideoTrack())}async getAudioTracks(){return(await this.getTracks()).filter(t=>t.isAudioTrack())}async getPrimaryVideoTrack(){return(await this.getTracks()).find(t=>t.isVideoTrack())??null}async getPrimaryAudioTrack(){return(await this.getTracks()).find(t=>t.isAudioTrack())??null}async getMimeType(){return(await this._getDemuxer()).getMimeType()}async getMetadataTags(){return(await this._getDemuxer()).getMetadataTags()}dispose(){this._disposed||(this._disposed=!0,this._source._disposed=!0,this._source._dispose())}[Symbol.dispose](){this.dispose()}}class tr extends Error{constructor(e="Input has been disposed."){super(e),this.name="InputDisposedError"}}class Gh{constructor(e){this.source=e}requestSlice(e,t){if(this.source._disposed)throw new tr;if(e<0||this.fileSize!==null&&e+t>this.fileSize)return null;const i=e+t,a=this.source._read(e,i);return a instanceof Promise?a.then(n=>n?new ir(n.bytes,n.view,n.offset,e,i):null):a?new ir(a.bytes,a.view,a.offset,e,i):null}requestSliceRange(e,t,i){if(this.source._disposed)throw new tr;if(e<0)return null;if(this.fileSize!==null)return this.requestSlice(e,Mt(this.fileSize-e,t,i));{const a=this.requestSlice(e,i),n=s=>{if(s)return s;const o=l=>(E(l!==null),this.requestSlice(e,Mt(l-e,t,i))),c=this.source._retrieveSize();return c instanceof Promise?c.then(o):o(c)};return a instanceof Promise?a.then(n):n(a)}}}class ir{constructor(e,t,i,a,n){this.bytes=e,this.view=t,this.offset=i,this.start=a,this.end=n,this.bufferPos=a-i}static tempFromBytes(e){return new ir(e,kt(e),0,0,e.length)}get length(){return this.end-this.start}get filePos(){return this.offset+this.bufferPos}set filePos(e){this.bufferPos=e-this.offset}get remainingLength(){return Math.max(this.end-this.filePos,0)}skip(e){this.bufferPos+=e}slice(e,t=this.end-e){if(e<this.start||e+t>this.end)throw new RangeError("Slicing outside of original slice.");return new ir(this.bytes,this.view,this.offset,e,e+t)}}const Yt=(r,e)=>{if(r.filePos<r.start||r.filePos+e>r.end)throw new RangeError(`Tried reading [${r.filePos}, ${r.filePos+e}), but slice is [${r.start}, ${r.end}). This is likely an internal error, please report it alongside the file that caused it.`)},Me=(r,e)=>{Yt(r,e);const t=r.bytes.subarray(r.bufferPos,r.bufferPos+e);return r.bufferPos+=e,t},Se=r=>(Yt(r,1),r.view.getUint8(r.bufferPos++)),ra=(r,e)=>{Yt(r,2);const t=r.view.getUint16(r.bufferPos,e);return r.bufferPos+=2,t},zt=r=>{Yt(r,2);const e=r.view.getUint16(r.bufferPos,!1);return r.bufferPos+=2,e},xi=r=>{Yt(r,3);const e=ns(r.view,r.bufferPos,!1);return r.bufferPos+=3,e},on=r=>{Yt(r,2);const e=r.view.getInt16(r.bufferPos,!1);return r.bufferPos+=2,e},Qr=(r,e)=>{Yt(r,4);const t=r.view.getUint32(r.bufferPos,e);return r.bufferPos+=4,t},ve=r=>{Yt(r,4);const e=r.view.getUint32(r.bufferPos,!1);return r.bufferPos+=4,e},Fi=r=>{Yt(r,4);const e=r.view.getUint32(r.bufferPos,!0);return r.bufferPos+=4,e},di=r=>{Yt(r,4);const e=r.view.getInt32(r.bufferPos,!1);return r.bufferPos+=4,e},Qh=r=>{Yt(r,4);const e=r.view.getInt32(r.bufferPos,!0);return r.bufferPos+=4,e},$o=(r,e)=>{let t,i;return e?(t=Qr(r,!0),i=Qr(r,!0)):(i=Qr(r,!1),t=Qr(r,!1)),i*4294967296+t},mr=r=>{const e=ve(r),t=ve(r);return e*4294967296+t},Xh=r=>{const e=di(r),t=ve(r);return e*4294967296+t},Zh=r=>{const e=Fi(r);return Qh(r)*4294967296+e},Yh=r=>{Yt(r,4);const e=r.view.getFloat32(r.bufferPos,!1);return r.bufferPos+=4,e},ml=r=>{Yt(r,8);const e=r.view.getFloat64(r.bufferPos,!1);return r.bufferPos+=8,e},Dt=(r,e)=>{Yt(r,e);let t="";for(let i=0;i<e;i++)t+=String.fromCharCode(r.bytes[r.bufferPos++]);return t};const ts=/<(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})>/g,Jh=/(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})/,em=r=>{const e=Jh.exec(r);if(!e)throw new Error("Expected match.");return 3600*1e3*Number(e[1]||"0")+60*1e3*Number(e[2])+1e3*Number(e[3])+Number(e[4])},pl=r=>{const e=Math.floor(r/36e5),t=Math.floor(r%(3600*1e3)/(60*1e3)),i=Math.floor(r%(60*1e3)/1e3),a=r%1e3;return e.toString().padStart(2,"0")+":"+t.toString().padStart(2,"0")+":"+i.toString().padStart(2,"0")+"."+a.toString().padStart(3,"0")};class Wo{constructor(e){this.writer=e,this.helper=new Uint8Array(8),this.helperView=new DataView(this.helper.buffer),this.offsets=new WeakMap}writeU32(e){this.helperView.setUint32(0,e,!1),this.writer.write(this.helper.subarray(0,4))}writeU64(e){this.helperView.setUint32(0,Math.floor(e/2**32),!1),this.helperView.setUint32(4,e,!1),this.writer.write(this.helper.subarray(0,8))}writeAscii(e){for(let t=0;t<e.length;t++)this.helperView.setUint8(t%8,e.charCodeAt(t)),t%8===7&&this.writer.write(this.helper);e.length%8!==0&&this.writer.write(this.helper.subarray(0,e.length%8))}writeBox(e){if(this.offsets.set(e,this.writer.getPos()),e.contents&&!e.children)this.writeBoxHeader(e,e.size??e.contents.byteLength+8),this.writer.write(e.contents);else{const t=this.writer.getPos();if(this.writeBoxHeader(e,0),e.contents&&this.writer.write(e.contents),e.children)for(const n of e.children)n&&this.writeBox(n);const i=this.writer.getPos(),a=e.size??i-t;this.writer.seek(t),this.writeBoxHeader(e,a),this.writer.seek(i)}}writeBoxHeader(e,t){this.writeU32(e.largeSize?1:t),this.writeAscii(e.type),e.largeSize&&this.writeU64(t)}measureBoxHeader(e){return 8+(e.largeSize?8:0)}patchBox(e){const t=this.offsets.get(e);E(t!==void 0);const i=this.writer.getPos();this.writer.seek(t),this.writeBox(e),this.writer.seek(i)}measureBox(e){if(e.contents&&!e.children)return this.measureBoxHeader(e)+e.contents.byteLength;{let t=this.measureBoxHeader(e);if(e.contents&&(t+=e.contents.byteLength),e.children)for(const i of e.children)i&&(t+=this.measureBox(i));return t}}}const Xe=new Uint8Array(8),Sr=new DataView(Xe.buffer),yt=r=>[(r%256+256)%256],Ce=r=>(Sr.setUint16(0,r,!1),[Xe[0],Xe[1]]),gl=r=>(Sr.setInt16(0,r,!1),[Xe[0],Xe[1]]),vl=r=>(Sr.setUint32(0,r,!1),[Xe[1],Xe[2],Xe[3]]),de=r=>(Sr.setUint32(0,r,!1),[Xe[0],Xe[1],Xe[2],Xe[3]]),qr=r=>(Sr.setInt32(0,r,!1),[Xe[0],Xe[1],Xe[2],Xe[3]]),ui=r=>(Sr.setUint32(0,Math.floor(r/2**32),!1),Sr.setUint32(4,r,!1),[Xe[0],Xe[1],Xe[2],Xe[3],Xe[4],Xe[5],Xe[6],Xe[7]]),bl=r=>(Sr.setInt16(0,2**8*r,!1),[Xe[0],Xe[1]]),Br=r=>(Sr.setInt32(0,2**16*r,!1),[Xe[0],Xe[1],Xe[2],Xe[3]]),Is=r=>(Sr.setInt32(0,2**30*r,!1),[Xe[0],Xe[1],Xe[2],Xe[3]]),As=(r,e)=>{const t=[];let i=r;do{let a=i&127;i>>=7,t.length>0&&(a|=128),t.push(a)}while(i>0||e);return t.reverse()},Ut=(r,e=!1)=>{const t=Array(r.length).fill(null).map((i,a)=>r.charCodeAt(a));return e&&t.push(0),t},$n=r=>{let e=null;for(const t of r)(!e||t.timestamp>e.timestamp)&&(e=t);return e},wl=r=>{const e=r*(Math.PI/180),t=Math.round(Math.cos(e)),i=Math.round(Math.sin(e));return[t,i,0,-i,t,0,0,0,1]},kl=wl(0),yl=r=>[Br(r[0]),Br(r[1]),Is(r[2]),Br(r[3]),Br(r[4]),Is(r[5]),Br(r[6]),Br(r[7]),Is(r[8])],Fe=(r,e,t)=>({type:r,contents:e&&new Uint8Array(e.flat(10)),children:t}),et=(r,e,t,i,a)=>Fe(r,[yt(e),vl(t),i??[]],a),tm=r=>r.isQuickTime?Fe("ftyp",[Ut("qt  "),de(512),Ut("qt  ")]):r.fragmented?Fe("ftyp",[Ut("iso5"),de(512),Ut("iso5"),Ut("iso6"),Ut("mp41")]):Fe("ftyp",[Ut("isom"),de(512),Ut("isom"),r.holdsAvc?Ut("avc1"):[],Ut("mp41")]),Ma=r=>({type:"mdat",largeSize:r}),rm=r=>({type:"free",size:r}),ia=r=>Fe("moov",void 0,[im(r.creationTime,r.trackDatas),...r.trackDatas.map(e=>am(e,r.creationTime)),r.isFragmented?Um(r.trackDatas):null,Ym(r)]),im=(r,e)=>{const t=Ft(Math.max(0,...e.filter(s=>s.samples.length>0).map(s=>{const o=$n(s.samples);return o.timestamp+o.duration})),cn),i=Math.max(0,...e.map(s=>s.track.id))+1,a=!$i(r)||!$i(t),n=a?ui:de;return et("mvhd",+a,0,[n(r),n(r),de(cn),n(t),Br(1),bl(1),Array(10).fill(0),yl(kl),Array(24).fill(0),de(i)])},am=(r,e)=>{const t=dp(r);return Fe("trak",void 0,[sm(r,e),nm(r,e),t.name!==void 0?Fe("udta",void 0,[Fe("name",[...Kt.encode(t.name)])]):null])},sm=(r,e)=>{const t=$n(r.samples),i=Ft(t?t.timestamp+t.duration:0,cn),a=!$i(e)||!$i(i),n=a?ui:de;let s;if(r.type==="video"){const c=r.track.metadata.rotation;s=wl(c??0)}else s=kl;let o=2;return r.track.metadata.disposition?.default!==!1&&(o|=1),et("tkhd",+a,o,[n(e),n(e),de(r.track.id),de(0),n(i),Array(8).fill(0),Ce(0),Ce(r.track.id),bl(r.type==="audio"?1:0),Ce(0),yl(s),Br(r.type==="video"?r.info.width:0),Br(r.type==="video"?r.info.height:0)])},nm=(r,e)=>Fe("mdia",void 0,[om(r,e),Wn(!0,cm[r.type],lm[r.type]),dm(r)]),om=(r,e)=>{const t=$n(r.samples),i=Ft(t?t.timestamp+t.duration:0,r.timescale),a=!$i(e)||!$i(i),n=a?ui:de;return et("mdhd",+a,0,[n(e),n(e),de(r.timescale),n(i),Ce(Sl(r.track.metadata.languageCode??Gt)),Ce(0)])},cm={video:"vide",audio:"soun",subtitle:"text"},lm={video:"MediabunnyVideoHandler",audio:"MediabunnySoundHandler",subtitle:"MediabunnyTextHandler"},Wn=(r,e,t,i="\0\0\0\0")=>et("hdlr",0,0,[r?Ut("mhlr"):de(0),Ut(e),Ut(i),de(0),de(0),Ut(t,!0)]),dm=r=>Fe("minf",void 0,[mm[r.type](),pm(),bm(r)]),um=()=>et("vmhd",0,1,[Ce(0),Ce(0),Ce(0),Ce(0)]),fm=()=>et("smhd",0,0,[Ce(0),Ce(0)]),hm=()=>et("nmhd",0,0),mm={video:um,audio:fm,subtitle:hm},pm=()=>Fe("dinf",void 0,[gm()]),gm=()=>et("dref",0,0,[de(1)],[vm()]),vm=()=>et("url ",0,1),bm=r=>{const e=r.compositionTimeOffsetTable.length>1||r.compositionTimeOffsetTable.some(t=>t.sampleCompositionTimeOffset!==0);return Fe("stbl",void 0,[wm(r),Bm(r),e?Om(r):null,e?Nm(r):null,Mm(r),Rm(r),Dm(r),zm(r)])},wm=r=>{let e;if(r.type==="video")e=km(rp(r.track.source._codec,r.info.decoderConfig.codec),r);else if(r.type==="audio"){const t=Tl(r.track.source._codec,r.muxer.isQuickTime);E(t),e=Sm(t,r)}else r.type==="subtitle"&&(e=Am(sp[r.track.source._codec],r));return E(e),et("stsd",0,0,[de(1)],[e])},km=(r,e)=>Fe(r,[Array(6).fill(0),Ce(1),Ce(0),Ce(0),Array(12).fill(0),Ce(e.info.width),Ce(e.info.height),de(4718592),de(4718592),de(0),Ce(1),Array(32).fill(0),Ce(24),gl(65535)],[ip[e.track.source._codec](e),Cc(e.info.decoderConfig.colorSpace)?ym(e):null]),ym=r=>Fe("colr",[Ut("nclx"),Ce(Ki[r.info.decoderConfig.colorSpace.primaries]),Ce(Gi[r.info.decoderConfig.colorSpace.transfer]),Ce(Qi[r.info.decoderConfig.colorSpace.matrix]),yt((r.info.decoderConfig.colorSpace.fullRange?1:0)<<7)]),xm=r=>r.info.decoderConfig&&Fe("avcC",[...Lt(r.info.decoderConfig.description)]),_m=r=>r.info.decoderConfig&&Fe("hvcC",[...Lt(r.info.decoderConfig.description)]),Ho=r=>{if(!r.info.decoderConfig)return null;const e=r.info.decoderConfig,t=e.codec.split("."),i=Number(t[1]),a=Number(t[2]),n=Number(t[3]),s=t[4]?Number(t[4]):1,o=t[8]?Number(t[8]):Number(e.colorSpace?.fullRange??0),c=(n<<4)+(s<<1)+o,l=t[5]?Number(t[5]):e.colorSpace?.primaries?Ki[e.colorSpace.primaries]:2,d=t[6]?Number(t[6]):e.colorSpace?.transfer?Gi[e.colorSpace.transfer]:2,u=t[7]?Number(t[7]):e.colorSpace?.matrix?Qi[e.colorSpace.matrix]:2;return et("vpcC",1,0,[yt(i),yt(a),yt(c),yt(l),yt(d),yt(u),Ce(0)])},Tm=r=>Fe("av1C",Ac(r.info.decoderConfig.codec)),Sm=(r,e)=>{let t=0,i,a=16;if(Ot.includes(e.track.source._codec)){const n=e.track.source._codec,{sampleSize:s}=Ur(n);a=8*s,a>16&&(t=1)}return t===0?i=[Array(6).fill(0),Ce(1),Ce(t),Ce(0),de(0),Ce(e.info.numberOfChannels),Ce(a),Ce(0),Ce(0),Ce(e.info.sampleRate<2**16?e.info.sampleRate:0),Ce(0)]:i=[Array(6).fill(0),Ce(1),Ce(t),Ce(0),de(0),Ce(e.info.numberOfChannels),Ce(Math.min(a,16)),Ce(0),Ce(0),Ce(e.info.sampleRate<2**16?e.info.sampleRate:0),Ce(0),de(1),de(a/8),de(e.info.numberOfChannels*a/8),de(2)],Fe(r,i,[ap(e.track.source._codec,e.muxer.isQuickTime)?.(e)??null])},Fs=r=>{let e;switch(r.track.source._codec){case"aac":e=64;break;case"mp3":e=107;break;case"vorbis":e=221;break;default:throw new Error(`Unhandled audio codec: ${r.track.source._codec}`)}let t=[...yt(e),...yt(21),...vl(0),...de(0),...de(0)];if(r.info.decoderConfig.description){const i=Lt(r.info.decoderConfig.description);t=[...t,...yt(5),...As(i.byteLength),...i]}return t=[...Ce(1),...yt(0),...yt(4),...As(t.length),...t,...yt(6),...yt(1),...yt(2)],t=[...yt(3),...As(t.length),...t],et("esds",0,0,t)},$r=r=>Fe("wave",void 0,[Cm(r),Pm(r),Fe("\0\0\0\0")]),Cm=r=>Fe("frma",[Ut(Tl(r.track.source._codec,r.muxer.isQuickTime))]),Pm=r=>{const{littleEndian:e}=Ur(r.track.source._codec);return Fe("enda",[Ce(+e)])},Em=r=>{let e=r.info.numberOfChannels,t=3840,i=r.info.sampleRate,a=0,n=0,s=new Uint8Array(0);const o=r.info.decoderConfig?.description;if(o){E(o.byteLength>=18);const c=Lt(o),l=Mn(c);e=l.outputChannelCount,t=l.preSkip,i=l.inputSampleRate,a=l.outputGain,n=l.channelMappingFamily,l.channelMappingTable&&(s=l.channelMappingTable)}return Fe("dOps",[yt(0),yt(e),Ce(t),de(i),gl(a),yt(n),...s])},Im=r=>{const e=r.info.decoderConfig?.description;E(e);const t=Lt(e);return et("dfLa",0,0,[...t.subarray(4)])},vr=r=>{const{littleEndian:e,sampleSize:t}=Ur(r.track.source._codec),i=+e;return et("pcmC",0,0,[yt(i),yt(8*t)])},Am=(r,e)=>Fe(r,[Array(6).fill(0),Ce(1)],[np[e.track.source._codec](e)]),Fm=r=>Fe("vttC",[...Kt.encode(r.info.config.description)]),Bm=r=>et("stts",0,0,[de(r.timeToSampleTable.length),r.timeToSampleTable.map(e=>[de(e.sampleCount),de(e.sampleDelta)])]),zm=r=>{if(r.samples.every(t=>t.type==="key"))return null;const e=[...r.samples.entries()].filter(([,t])=>t.type==="key");return et("stss",0,0,[de(e.length),e.map(([t])=>de(t+1))])},Mm=r=>et("stsc",0,0,[de(r.compactlyCodedChunkTable.length),r.compactlyCodedChunkTable.map(e=>[de(e.firstChunk),de(e.samplesPerChunk),de(1)])]),Rm=r=>{if(r.type==="audio"&&r.info.requiresPcmTransformation){const{sampleSize:e}=Ur(r.track.source._codec);return et("stsz",0,0,[de(e*r.info.numberOfChannels),de(r.samples.reduce((t,i)=>t+Ft(i.duration,r.timescale),0))])}return et("stsz",0,0,[de(0),de(r.samples.length),r.samples.map(e=>de(e.size))])},Dm=r=>r.finalizedChunks.length>0&&wt(r.finalizedChunks).offset>=2**32?et("co64",0,0,[de(r.finalizedChunks.length),r.finalizedChunks.map(e=>ui(e.offset))]):et("stco",0,0,[de(r.finalizedChunks.length),r.finalizedChunks.map(e=>de(e.offset))]),Om=r=>et("ctts",1,0,[de(r.compositionTimeOffsetTable.length),r.compositionTimeOffsetTable.map(e=>[de(e.sampleCount),qr(e.sampleCompositionTimeOffset)])]),Nm=r=>{let e=1/0,t=-1/0,i=1/0,a=-1/0;E(r.compositionTimeOffsetTable.length>0),E(r.samples.length>0);for(let s=0;s<r.compositionTimeOffsetTable.length;s++){const o=r.compositionTimeOffsetTable[s];e=Math.min(e,o.sampleCompositionTimeOffset),t=Math.max(t,o.sampleCompositionTimeOffset)}for(let s=0;s<r.samples.length;s++){const o=r.samples[s];i=Math.min(i,Ft(o.timestamp,r.timescale)),a=Math.max(a,Ft(o.timestamp+o.duration,r.timescale))}const n=Math.max(-e,0);return a>=2**31?null:et("cslg",0,0,[qr(n),qr(e),qr(t),qr(i),qr(a)])},Um=r=>Fe("mvex",void 0,r.map(Vm)),Vm=r=>et("trex",0,0,[de(r.track.id),de(1),de(0),de(0),de(0)]),jo=(r,e)=>Fe("moof",void 0,[Lm(r),...e.map($m)]),Lm=r=>et("mfhd",0,0,[de(r)]),xl=r=>{let e=0,t=0;const i=0,a=0,n=r.type==="delta";return t|=+n,n?e|=1:e|=2,e<<24|t<<16|i<<8|a},$m=r=>Fe("traf",void 0,[Wm(r),Hm(r),jm(r)]),Wm=r=>{E(r.currentChunk);let e=0;e|=8,e|=16,e|=32,e|=131072;const t=r.currentChunk.samples[1]??r.currentChunk.samples[0],i={duration:t.timescaleUnitsToNextSample,size:t.size,flags:xl(t)};return et("tfhd",0,e,[de(r.track.id),de(i.duration),de(i.size),de(i.flags)])},Hm=r=>(E(r.currentChunk),et("tfdt",1,0,[ui(Ft(r.currentChunk.startTimestamp,r.timescale))])),jm=r=>{E(r.currentChunk);const e=r.currentChunk.samples.map(m=>m.timescaleUnitsToNextSample),t=r.currentChunk.samples.map(m=>m.size),i=r.currentChunk.samples.map(xl),a=r.currentChunk.samples.map(m=>Ft(m.timestamp-m.decodeTimestamp,r.timescale)),n=new Set(e),s=new Set(t),o=new Set(i),c=new Set(a),l=o.size===2&&i[0]!==i[1],d=n.size>1,u=s.size>1,f=!l&&o.size>1,h=c.size>1||[...c].some(m=>m!==0);let g=0;return g|=1,g|=4*+l,g|=256*+d,g|=512*+u,g|=1024*+f,g|=2048*+h,et("trun",1,g,[de(r.currentChunk.samples.length),de(r.currentChunk.offset-r.currentChunk.moofOffset||0),l?de(i[0]):[],r.currentChunk.samples.map((m,p)=>[d?de(e[p]):[],u?de(t[p]):[],f?de(i[p]):[],h?qr(a[p]):[]])])},qm=r=>Fe("mfra",void 0,[...r.map(Km),Gm()]),Km=(r,e)=>et("tfra",1,0,[de(r.track.id),de(63),de(r.finalizedChunks.length),r.finalizedChunks.map(i=>[ui(Ft(i.samples[0].timestamp,r.timescale)),ui(i.moofOffset),de(e+1),de(1),de(1)])]),Gm=()=>et("mfro",0,0,[de(0)]),Qm=()=>Fe("vtte"),Xm=(r,e,t,i,a)=>Fe("vttc",void 0,[a!==null?Fe("vsid",[qr(a)]):null,t!==null?Fe("iden",[...Kt.encode(t)]):null,e!==null?Fe("ctim",[...Kt.encode(pl(e))]):null,i!==null?Fe("sttg",[...Kt.encode(i)]):null,Fe("payl",[...Kt.encode(r)])]),Zm=r=>Fe("vtta",[...Kt.encode(r)]),Ym=r=>{const e=[],t=r.format._options.metadataFormat??"auto",i=r.output._metadataTags;if(t==="mdir"||t==="auto"&&!r.isQuickTime){const a=ep(i);a&&e.push(a)}else if(t==="mdta"){const a=tp(i);a&&e.push(a)}else(t==="udta"||t==="auto"&&r.isQuickTime)&&Jm(e,r.output._metadataTags);return e.length===0?null:Fe("udta",void 0,e)},Jm=(r,e)=>{for(const{key:t,value:i}of Sn(e))switch(t){case"title":r.push(br("Â©nam",i));break;case"description":r.push(br("Â©des",i));break;case"artist":r.push(br("Â©ART",i));break;case"album":r.push(br("Â©alb",i));break;case"albumArtist":r.push(br("albr",i));break;case"genre":r.push(br("Â©gen",i));break;case"date":r.push(br("Â©day",i.toISOString().slice(0,10)));break;case"comment":r.push(br("Â©cmt",i));break;case"lyrics":r.push(br("Â©lyr",i));break;case"raw":break;case"discNumber":case"discsTotal":case"trackNumber":case"tracksTotal":case"images":break;default:Tr(t)}if(e.raw)for(const t in e.raw){const i=e.raw[t];i==null||t.length!==4||r.some(a=>a.type===t)||(typeof i=="string"?r.push(br(t,i)):i instanceof Uint8Array&&r.push(Fe(t,Array.from(i))))}},br=(r,e)=>{const t=Kt.encode(e);return Fe(r,[Ce(t.length),Ce(Sl("und")),Array.from(t)])},qo={"image/jpeg":13,"image/png":14,"image/bmp":27},_l=(r,e)=>{const t=[];for(const{key:i,value:a}of Sn(r))switch(i){case"title":t.push({key:e?"title":"Â©nam",value:fr(a)});break;case"description":t.push({key:e?"description":"Â©des",value:fr(a)});break;case"artist":t.push({key:e?"artist":"Â©ART",value:fr(a)});break;case"album":t.push({key:e?"album":"Â©alb",value:fr(a)});break;case"albumArtist":t.push({key:e?"album_artist":"aART",value:fr(a)});break;case"comment":t.push({key:e?"comment":"Â©cmt",value:fr(a)});break;case"genre":t.push({key:e?"genre":"Â©gen",value:fr(a)});break;case"lyrics":t.push({key:e?"lyrics":"Â©lyr",value:fr(a)});break;case"date":t.push({key:e?"date":"Â©day",value:fr(a.toISOString().slice(0,10))});break;case"images":for(const n of a)n.kind==="coverFront"&&t.push({key:"covr",value:Fe("data",[de(qo[n.mimeType]??0),de(0),Array.from(n.data)])});break;case"trackNumber":if(e){const n=r.tracksTotal!==void 0?`${a}/${r.tracksTotal}`:a.toString();t.push({key:"track",value:fr(n)})}else t.push({key:"trkn",value:Fe("data",[de(0),de(0),Ce(0),Ce(a),Ce(r.tracksTotal??0),Ce(0)])});break;case"discNumber":e||t.push({key:"disc",value:Fe("data",[de(0),de(0),Ce(0),Ce(a),Ce(r.discsTotal??0),Ce(0)])});break;case"tracksTotal":case"discsTotal":break;case"raw":break;default:Tr(i)}if(r.raw)for(const i in r.raw){const a=r.raw[i];a==null||!e&&i.length!==4||t.some(n=>n.key===i)||(typeof a=="string"?t.push({key:i,value:fr(a)}):a instanceof Uint8Array?t.push({key:i,value:Fe("data",[de(0),de(0),Array.from(a)])}):a instanceof Di&&t.push({key:i,value:Fe("data",[de(qo[a.mimeType]??0),de(0),Array.from(a.data)])}))}return t},ep=r=>{const e=_l(r,!1);return e.length===0?null:et("meta",0,0,void 0,[Wn(!1,"mdir","","appl"),Fe("ilst",void 0,e.map(t=>Fe(t.key,void 0,[t.value])))])},tp=r=>{const e=_l(r,!0);return e.length===0?null:Fe("meta",void 0,[Wn(!1,"mdta",""),et("keys",0,0,[de(e.length)],e.map(t=>Fe("mdta",[...Kt.encode(t.key)]))),Fe("ilst",void 0,e.map((t,i)=>{const a=String.fromCharCode(...de(i+1));return Fe(a,void 0,[t.value])}))])},fr=r=>Fe("data",[de(1),de(0),...Kt.encode(r)]),rp=(r,e)=>{switch(r){case"avc":return e.startsWith("avc3")?"avc3":"avc1";case"hevc":return"hvc1";case"vp8":return"vp08";case"vp9":return"vp09";case"av1":return"av01"}},ip={avc:xm,hevc:_m,vp8:Ho,vp9:Ho,av1:Tm},Tl=(r,e)=>{switch(r){case"aac":return"mp4a";case"mp3":return"mp4a";case"opus":return"Opus";case"vorbis":return"mp4a";case"flac":return"fLaC";case"ulaw":return"ulaw";case"alaw":return"alaw";case"pcm-u8":return"raw ";case"pcm-s8":return"sowt"}if(e)switch(r){case"pcm-s16":return"sowt";case"pcm-s16be":return"twos";case"pcm-s24":return"in24";case"pcm-s24be":return"in24";case"pcm-s32":return"in32";case"pcm-s32be":return"in32";case"pcm-f32":return"fl32";case"pcm-f32be":return"fl32";case"pcm-f64":return"fl64";case"pcm-f64be":return"fl64"}else switch(r){case"pcm-s16":return"ipcm";case"pcm-s16be":return"ipcm";case"pcm-s24":return"ipcm";case"pcm-s24be":return"ipcm";case"pcm-s32":return"ipcm";case"pcm-s32be":return"ipcm";case"pcm-f32":return"fpcm";case"pcm-f32be":return"fpcm";case"pcm-f64":return"fpcm";case"pcm-f64be":return"fpcm"}},ap=(r,e)=>{switch(r){case"aac":return Fs;case"mp3":return Fs;case"opus":return Em;case"vorbis":return Fs;case"flac":return Im}if(e)switch(r){case"pcm-s24":return $r;case"pcm-s24be":return $r;case"pcm-s32":return $r;case"pcm-s32be":return $r;case"pcm-f32":return $r;case"pcm-f32be":return $r;case"pcm-f64":return $r;case"pcm-f64be":return $r}else switch(r){case"pcm-s16":return vr;case"pcm-s16be":return vr;case"pcm-s24":return vr;case"pcm-s24be":return vr;case"pcm-s32":return vr;case"pcm-s32be":return vr;case"pcm-f32":return vr;case"pcm-f32be":return vr;case"pcm-f64":return vr;case"pcm-f64be":return vr}return null},sp={webvtt:"wvtt"},np={webvtt:Fm},Sl=r=>{E(r.length===3);let e=0;for(let t=0;t<3;t++)e<<=5,e+=r.charCodeAt(t)-96;return e};class Cl{constructor(){this.ensureMonotonicity=!1,this.trackedWrites=null,this.trackedStart=-1,this.trackedEnd=-1}start(){}maybeTrackWrites(e){if(!this.trackedWrites)return;let t=this.getPos();if(t<this.trackedStart){if(t+e.byteLength<=this.trackedStart)return;e=e.subarray(this.trackedStart-t),t=0}const i=t+e.byteLength-this.trackedStart;let a=this.trackedWrites.byteLength;for(;a<i;)a*=2;if(a!==this.trackedWrites.byteLength){const n=new Uint8Array(a);n.set(this.trackedWrites,0),this.trackedWrites=n}this.trackedWrites.set(e,t-this.trackedStart),this.trackedEnd=Math.max(this.trackedEnd,t+e.byteLength)}startTrackingWrites(){this.trackedWrites=new Uint8Array(2**10),this.trackedStart=this.getPos(),this.trackedEnd=this.trackedStart}stopTrackingWrites(){if(!this.trackedWrites)throw new Error("Internal error: Can't get tracked writes since nothing was tracked.");const t={data:this.trackedWrites.subarray(0,this.trackedEnd-this.trackedStart),start:this.trackedStart,end:this.trackedEnd};return this.trackedWrites=null,t}}const Bs=2**16,zs=2**32;class Pl extends Cl{constructor(e){if(super(),this.pos=0,this.maxPos=0,this.target=e,this.supportsResize="resize"in new ArrayBuffer(0),this.supportsResize)try{this.buffer=new ArrayBuffer(Bs,{maxByteLength:zs})}catch{this.buffer=new ArrayBuffer(Bs),this.supportsResize=!1}else this.buffer=new ArrayBuffer(Bs);this.bytes=new Uint8Array(this.buffer)}ensureSize(e){let t=this.buffer.byteLength;for(;t<e;)t*=2;if(t!==this.buffer.byteLength){if(t>zs)throw new Error(`ArrayBuffer exceeded maximum size of ${zs} bytes. Please consider using another target.`);if(this.supportsResize)this.buffer.resize(t);else{const i=new ArrayBuffer(t),a=new Uint8Array(i);a.set(this.bytes,0),this.buffer=i,this.bytes=a}}}write(e){this.maybeTrackWrites(e),this.ensureSize(this.pos+e.byteLength),this.bytes.set(e,this.pos),this.target.onwrite?.(this.pos,this.pos+e.byteLength),this.pos+=e.byteLength,this.maxPos=Math.max(this.maxPos,this.pos)}seek(e){this.pos=e}getPos(){return this.pos}async flush(){}async finalize(){this.ensureSize(this.pos),this.target.buffer=this.buffer.slice(0,Math.max(this.maxPos,this.pos))}async close(){}getSlice(e,t){return this.bytes.slice(e,t)}}class op extends Cl{constructor(e){super(),this.target=e,this.pos=0}write(e){this.maybeTrackWrites(e),this.target.onwrite?.(this.pos,this.pos+e.byteLength),this.pos+=e.byteLength}getPos(){return this.pos}seek(e){this.pos=e}async flush(){}async finalize(){}async close(){}}class Hn{constructor(){this._output=null,this.onwrite=null}}class El extends Hn{constructor(){super(...arguments),this.buffer=null}_createWriter(){return new Pl(this)}}class cp extends Hn{_createWriter(){return new op(this)}}const cn=1e3,lp=2082844800,dp=r=>{const e={},t=r.track;return t.metadata.name!==void 0&&(e.name=t.metadata.name),e},Ft=(r,e,t=!0)=>{const i=r*e;return t?Math.round(i):i};class up extends Dc{constructor(e,t){super(e),this.auxTarget=new El,this.auxWriter=this.auxTarget._createWriter(),this.auxBoxWriter=new Wo(this.auxWriter),this.mdat=null,this.ftypSize=null,this.trackDatas=[],this.allTracksKnown=Rt(),this.creationTime=Math.floor(Date.now()/1e3)+lp,this.finalizedChunks=[],this.nextFragmentNumber=1,this.maxWrittenTimestamp=-1/0,this.format=t,this.writer=e._writer,this.boxWriter=new Wo(this.writer),this.isQuickTime=t instanceof Al;const i=this.writer instanceof Pl?"in-memory":!1;this.fastStart=t._options.fastStart??i,this.isFragmented=this.fastStart==="fragmented",(this.fastStart==="in-memory"||this.isFragmented)&&(this.writer.ensureMonotonicity=!0),this.minimumFragmentDuration=t._options.minimumFragmentDuration??1}async start(){const e=await this.mutex.acquire(),t=this.output._tracks.some(i=>i.type==="video"&&i.source._codec==="avc");if(this.format._options.onFtyp&&this.writer.startTrackingWrites(),this.boxWriter.writeBox(tm({isQuickTime:this.isQuickTime,holdsAvc:t,fragmented:this.isFragmented})),this.format._options.onFtyp){const{data:i,start:a}=this.writer.stopTrackingWrites();this.format._options.onFtyp(i,a)}if(this.ftypSize=this.writer.getPos(),this.fastStart!=="in-memory")if(this.fastStart==="reserve"){for(const i of this.output._tracks)if(i.metadata.maximumPacketCount===void 0)throw new Error("All tracks must specify maximumPacketCount in their metadata when using fastStart: 'reserve'.")}else this.isFragmented||(this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat=Ma(!0),this.boxWriter.writeBox(this.mdat));await this.writer.flush(),e()}allTracksAreKnown(){for(const e of this.output._tracks)if(!e.source._closed&&!this.trackDatas.some(t=>t.track===e))return!1;return!0}async getMimeType(){await this.allTracksKnown.promise;const e=this.trackDatas.map(t=>t.type==="video"||t.type==="audio"?t.info.decoderConfig.codec:{webvtt:"wvtt"}[t.track.source._codec]);return Zc({isQuickTime:this.isQuickTime,hasVideo:this.trackDatas.some(t=>t.type==="video"),hasAudio:this.trackDatas.some(t=>t.type==="audio"),codecStrings:e})}getVideoTrackData(e,t,i){const a=this.trackDatas.find(l=>l.track===e);if(a)return a;zc(i),E(i),E(i.decoderConfig);const n={...i.decoderConfig};E(n.codedWidth!==void 0),E(n.codedHeight!==void 0);let s=!1;if(e.source._codec==="avc"&&!n.description){const l=Fn(t.data);if(!l)throw new Error("Couldn't extract an AVCDecoderConfigurationRecord from the AVC packet. Make sure the packets are in Annex B format (as specified in ITU-T-REC-H.264) when not providing a description, or provide a description (must be an AVCDecoderConfigurationRecord as specified in ISO 14496-15) and ensure the packets are in AVCC format.");n.description=af(l),s=!0}else if(e.source._codec==="hevc"&&!n.description){const l=zn(t.data);if(!l)throw new Error("Couldn't extract an HEVCDecoderConfigurationRecord from the HEVC packet. Make sure the packets are in Annex B format (as specified in ITU-T-REC-H.265) when not providing a description, or provide a description (must be an HEVCDecoderConfigurationRecord as specified in ISO 14496-15) and ensure the packets are in HEVC format.");n.description=hf(l),s=!0}const o=Ou(1/(e.metadata.frameRate??57600),1e6).denominator,c={muxer:this,track:e,type:"video",info:{width:n.codedWidth,height:n.codedHeight,decoderConfig:n,requiresAnnexBTransformation:s},timescale:o,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[]};return this.trackDatas.push(c),this.trackDatas.sort((l,d)=>l.track.id-d.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),c}getAudioTrackData(e,t,i){const a=this.trackDatas.find(c=>c.track===e);if(a)return a;Mc(i),E(i),E(i.decoderConfig);const n={...i.decoderConfig};let s=!1;if(e.source._codec==="aac"&&!n.description){const c=Nr(ir.tempFromBytes(t.data));if(!c)throw new Error("Couldn't parse ADTS header from the AAC packet. Make sure the packets are in ADTS format (as specified in ISO 13818-7) when not providing a description, or provide a description (must be an AudioSpecificConfig as specified in ISO 14496-3) and ensure the packets are raw AAC data.");const l=Yr[c.samplingFrequencyIndex],d=Xi[c.channelConfiguration];if(l===void 0||d===void 0)throw new Error("Invalid ADTS frame header.");n.description=An({objectType:c.objectType,sampleRate:l,numberOfChannels:d}),s=!0}const o={muxer:this,track:e,type:"audio",info:{numberOfChannels:i.decoderConfig.numberOfChannels,sampleRate:i.decoderConfig.sampleRate,decoderConfig:n,requiresPcmTransformation:!this.isFragmented&&Ot.includes(e.source._codec),requiresAdtsStripping:s},timescale:i.decoderConfig.sampleRate,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[]};return this.trackDatas.push(o),this.trackDatas.sort((c,l)=>c.track.id-l.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),o}getSubtitleTrackData(e,t){const i=this.trackDatas.find(n=>n.track===e);if(i)return i;Rc(t),E(t),E(t.config);const a={muxer:this,track:e,type:"subtitle",info:{config:t.config},timescale:1e3,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[],lastCueEndTimestamp:0,cueQueue:[],nextSourceId:0,cueToSourceId:new WeakMap};return this.trackDatas.push(a),this.trackDatas.sort((n,s)=>n.track.id-s.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),a}async addEncodedVideoPacket(e,t,i){const a=await this.mutex.acquire();try{const n=this.getVideoTrackData(e,t,i);let s=t.data;if(n.info.requiresAnnexBTransformation){const l=[...Sa(s)].map(d=>s.subarray(d.offset,d.offset+d.length));if(l.length===0)throw new Error("Failed to transform packet data. Make sure all packets are provided in Annex B format, as specified in ITU-T-REC-H.264 and ITU-T-REC-H.265.");s=Uc(l,4)}const o=this.validateAndNormalizeTimestamp(n.track,t.timestamp,t.type==="key"),c=this.createSampleForTrack(n,s,o,t.duration,t.type);await this.registerSample(n,c)}finally{a()}}async addEncodedAudioPacket(e,t,i){const a=await this.mutex.acquire();try{const n=this.getAudioTrackData(e,t,i);let s=t.data;if(n.info.requiresAdtsStripping){const l=Nr(ir.tempFromBytes(s));if(!l)throw new Error("Expected ADTS frame, didn't get one.");const d=l.crcCheck===null?ya:Zr;s=s.subarray(d)}const o=this.validateAndNormalizeTimestamp(n.track,t.timestamp,t.type==="key"),c=this.createSampleForTrack(n,s,o,t.duration,t.type);n.info.requiresPcmTransformation&&await this.maybePadWithSilence(n,o),await this.registerSample(n,c)}finally{a()}}async maybePadWithSilence(e,t){const i=wt(e.samples),a=i?i.timestamp+i.duration:0,n=t-a,s=Ft(n,e.timescale);if(s>0){const{sampleSize:o,silentValue:c}=Ur(e.info.decoderConfig.codec),l=s*e.info.numberOfChannels,d=new Uint8Array(o*l).fill(c),u=this.createSampleForTrack(e,new Uint8Array(d.buffer),a,n,"key");await this.registerSample(e,u)}}async addSubtitleCue(e,t,i){const a=await this.mutex.acquire();try{const n=this.getSubtitleTrackData(e,i);this.validateAndNormalizeTimestamp(n.track,t.timestamp,!0),e.source._codec==="webvtt"&&(n.cueQueue.push(t),await this.processWebVTTCues(n,t.timestamp))}finally{a()}}async processWebVTTCues(e,t){for(;e.cueQueue.length>0;){const i=new Set([]);for(const l of e.cueQueue)E(l.timestamp<=t),E(e.lastCueEndTimestamp<=l.timestamp+l.duration),i.add(Math.max(l.timestamp,e.lastCueEndTimestamp)),i.add(l.timestamp+l.duration);const a=[...i].sort((l,d)=>l-d),n=a[0],s=a[1]??n;if(t<s)break;if(e.lastCueEndTimestamp<n){this.auxWriter.seek(0);const l=Qm();this.auxBoxWriter.writeBox(l);const d=this.auxWriter.getSlice(0,this.auxWriter.getPos()),u=this.createSampleForTrack(e,d,e.lastCueEndTimestamp,n-e.lastCueEndTimestamp,"key");await this.registerSample(e,u),e.lastCueEndTimestamp=n}this.auxWriter.seek(0);for(let l=0;l<e.cueQueue.length;l++){const d=e.cueQueue[l];if(d.timestamp>=s)break;ts.lastIndex=0;const u=ts.test(d.text),f=d.timestamp+d.duration;let h=e.cueToSourceId.get(d);if(h===void 0&&s<f&&(h=e.nextSourceId++,e.cueToSourceId.set(d,h)),d.notes){const m=Zm(d.notes);this.auxBoxWriter.writeBox(m)}const g=Xm(d.text,u?n:null,d.identifier??null,d.settings??null,h??null);this.auxBoxWriter.writeBox(g),f===s&&e.cueQueue.splice(l--,1)}const o=this.auxWriter.getSlice(0,this.auxWriter.getPos()),c=this.createSampleForTrack(e,o,n,s-n,"key");await this.registerSample(e,c),e.lastCueEndTimestamp=s}}createSampleForTrack(e,t,i,a,n){return{timestamp:i,decodeTimestamp:i,duration:a,data:t,size:t.byteLength,type:n,timescaleUnitsToNextSample:Ft(a,e.timescale)}}processTimestamps(e,t){if(e.timestampProcessingQueue.length===0)return;if(e.type==="audio"&&e.info.requiresPcmTransformation){let a=0;for(let n=0;n<e.timestampProcessingQueue.length;n++){const s=e.timestampProcessingQueue[n],o=Ft(s.duration,e.timescale);a+=o}if(e.timeToSampleTable.length===0)e.timeToSampleTable.push({sampleCount:a,sampleDelta:1});else{const n=wt(e.timeToSampleTable);n.sampleCount+=a}e.timestampProcessingQueue.length=0;return}const i=e.timestampProcessingQueue.map(a=>a.timestamp).sort((a,n)=>a-n);for(let a=0;a<e.timestampProcessingQueue.length;a++){const n=e.timestampProcessingQueue[a];n.decodeTimestamp=i[a],!this.isFragmented&&e.lastTimescaleUnits===null&&(n.decodeTimestamp=0);const s=Ft(n.timestamp-n.decodeTimestamp,e.timescale),o=Ft(n.duration,e.timescale);if(e.lastTimescaleUnits!==null){E(e.lastSample);const c=Ft(n.decodeTimestamp,e.timescale,!1),l=Math.round(c-e.lastTimescaleUnits);if(E(l>=0),e.lastTimescaleUnits+=l,e.lastSample.timescaleUnitsToNextSample=l,!this.isFragmented){let d=wt(e.timeToSampleTable);if(E(d),d.sampleCount===1){d.sampleDelta=l;const f=e.timeToSampleTable[e.timeToSampleTable.length-2];f&&f.sampleDelta===l&&(f.sampleCount++,e.timeToSampleTable.pop(),d=f)}else d.sampleDelta!==l&&(d.sampleCount--,e.timeToSampleTable.push(d={sampleCount:1,sampleDelta:l}));d.sampleDelta===o?d.sampleCount++:e.timeToSampleTable.push({sampleCount:1,sampleDelta:o});const u=wt(e.compositionTimeOffsetTable);E(u),u.sampleCompositionTimeOffset===s?u.sampleCount++:e.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:s})}}else e.lastTimescaleUnits=Ft(n.decodeTimestamp,e.timescale,!1),this.isFragmented||(e.timeToSampleTable.push({sampleCount:1,sampleDelta:o}),e.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:s}));e.lastSample=n}if(e.timestampProcessingQueue.length=0,E(e.lastSample),E(e.lastTimescaleUnits!==null),t!==void 0&&e.lastSample.timescaleUnitsToNextSample===0){E(t.type==="key");const a=Ft(t.timestamp,e.timescale,!1),n=Math.round(a-e.lastTimescaleUnits);e.lastSample.timescaleUnitsToNextSample=n}}async registerSample(e,t){t.type==="key"&&this.processTimestamps(e,t),e.timestampProcessingQueue.push(t),this.isFragmented?(e.sampleQueue.push(t),await this.interleaveSamples()):this.fastStart==="reserve"?await this.registerSampleFastStartReserve(e,t):await this.addSampleToTrack(e,t)}async addSampleToTrack(e,t){if(!this.isFragmented&&(e.samples.push(t),this.fastStart==="reserve")){const a=e.track.metadata.maximumPacketCount;if(E(a!==void 0),e.samples.length>a)throw new Error(`Track #${e.track.id} has already reached the maximum packet count (${a}). Either add less packets or increase the maximum packet count.`)}let i=!1;if(!e.currentChunk)i=!0;else{e.currentChunk.startTimestamp=Math.min(e.currentChunk.startTimestamp,t.timestamp);const a=t.timestamp-e.currentChunk.startTimestamp;if(this.isFragmented){const n=this.trackDatas.every(s=>{if(e===s)return t.type==="key";const o=s.sampleQueue[0];return o?o.type==="key":s.track.source._closed});a>=this.minimumFragmentDuration&&n&&t.timestamp>this.maxWrittenTimestamp&&(i=!0,await this.finalizeFragment())}else i=a>=.5}i&&(e.currentChunk&&await this.finalizeCurrentChunk(e),e.currentChunk={startTimestamp:t.timestamp,samples:[],offset:null,moofOffset:null}),E(e.currentChunk),e.currentChunk.samples.push(t),this.isFragmented&&(this.maxWrittenTimestamp=Math.max(this.maxWrittenTimestamp,t.timestamp))}async finalizeCurrentChunk(e){if(E(!this.isFragmented),!e.currentChunk)return;e.finalizedChunks.push(e.currentChunk),this.finalizedChunks.push(e.currentChunk);let t=e.currentChunk.samples.length;if(e.type==="audio"&&e.info.requiresPcmTransformation&&(t=e.currentChunk.samples.reduce((i,a)=>i+Ft(a.duration,e.timescale),0)),(e.compactlyCodedChunkTable.length===0||wt(e.compactlyCodedChunkTable).samplesPerChunk!==t)&&e.compactlyCodedChunkTable.push({firstChunk:e.finalizedChunks.length,samplesPerChunk:t}),this.fastStart==="in-memory"){e.currentChunk.offset=0;return}e.currentChunk.offset=this.writer.getPos();for(const i of e.currentChunk.samples)E(i.data),this.writer.write(i.data),i.data=null;await this.writer.flush()}async interleaveSamples(e=!1){if(E(this.isFragmented),!(!e&&!this.allTracksAreKnown()))e:for(;;){let t=null,i=1/0;for(const n of this.trackDatas){if(!e&&n.sampleQueue.length===0&&!n.track.source._closed)break e;n.sampleQueue.length>0&&n.sampleQueue[0].timestamp<i&&(t=n,i=n.sampleQueue[0].timestamp)}if(!t)break;const a=t.sampleQueue.shift();await this.addSampleToTrack(t,a)}}async finalizeFragment(e=!0){E(this.isFragmented);const t=this.nextFragmentNumber++;if(t===1){this.format._options.onMoov&&this.writer.startTrackingWrites();const h=ia(this);if(this.boxWriter.writeBox(h),this.format._options.onMoov){const{data:g,start:m}=this.writer.stopTrackingWrites();this.format._options.onMoov(g,m)}}const i=this.trackDatas.filter(h=>h.currentChunk),a=jo(t,i),n=this.writer.getPos(),s=n+this.boxWriter.measureBox(a);let o=s+Mr,c=1/0;for(const h of i){h.currentChunk.offset=o,h.currentChunk.moofOffset=n;for(const g of h.currentChunk.samples)o+=g.size;c=Math.min(c,h.currentChunk.startTimestamp)}const l=o-s,d=l>=2**32;if(d)for(const h of i)h.currentChunk.offset+=ci-Mr;this.format._options.onMoof&&this.writer.startTrackingWrites();const u=jo(t,i);if(this.boxWriter.writeBox(u),this.format._options.onMoof){const{data:h,start:g}=this.writer.stopTrackingWrites();this.format._options.onMoof(h,g,c)}E(this.writer.getPos()===s),this.format._options.onMdat&&this.writer.startTrackingWrites();const f=Ma(d);f.size=l,this.boxWriter.writeBox(f),this.writer.seek(s+(d?ci:Mr));for(const h of i)for(const g of h.currentChunk.samples)this.writer.write(g.data),g.data=null;if(this.format._options.onMdat){const{data:h,start:g}=this.writer.stopTrackingWrites();this.format._options.onMdat(h,g)}for(const h of i)h.finalizedChunks.push(h.currentChunk),this.finalizedChunks.push(h.currentChunk),h.currentChunk=null;e&&await this.writer.flush()}async registerSampleFastStartReserve(e,t){if(this.allTracksAreKnown()){if(!this.mdat){const i=ia(this),n=this.boxWriter.measureBox(i)+this.computeSampleTableSizeUpperBound()+4096;E(this.ftypSize!==null),this.writer.seek(this.ftypSize+n),this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat=Ma(!0),this.boxWriter.writeBox(this.mdat);for(const s of this.trackDatas){for(const o of s.sampleQueue)await this.addSampleToTrack(s,o);s.sampleQueue.length=0}}await this.addSampleToTrack(e,t)}else e.sampleQueue.push(t)}computeSampleTableSizeUpperBound(){E(this.fastStart==="reserve");let e=0;for(const t of this.trackDatas){const i=t.track.metadata.maximumPacketCount;E(i!==void 0),e+=8*Math.ceil(2/3*i),e+=4*i,e+=8*Math.ceil(2/3*i),e+=12*Math.ceil(2/3*i),e+=4*i,e+=8*i}return e}async onTrackClose(e){const t=await this.mutex.acquire();if(e.type==="subtitle"&&e.source._codec==="webvtt"){const i=this.trackDatas.find(a=>a.track===e);i&&await this.processWebVTTCues(i,1/0)}this.allTracksAreKnown()&&this.allTracksKnown.resolve(),this.isFragmented&&await this.interleaveSamples(),t()}async finalize(){const e=await this.mutex.acquire();this.allTracksKnown.resolve();for(const t of this.trackDatas)t.type==="subtitle"&&t.track.source._codec==="webvtt"&&await this.processWebVTTCues(t,1/0);if(this.isFragmented){await this.interleaveSamples(!0);for(const t of this.trackDatas)this.processTimestamps(t);await this.finalizeFragment(!1)}else for(const t of this.trackDatas)this.processTimestamps(t),await this.finalizeCurrentChunk(t);if(this.fastStart==="in-memory"){this.mdat=Ma(!1);let t;for(let a=0;a<2;a++){const n=ia(this),s=this.boxWriter.measureBox(n);t=this.boxWriter.measureBox(this.mdat);let o=this.writer.getPos()+s+t;for(const c of this.finalizedChunks){c.offset=o;for(const{data:l}of c.samples)E(l),o+=l.byteLength,t+=l.byteLength}if(o<2**32)break;t>=2**32&&(this.mdat.largeSize=!0)}this.format._options.onMoov&&this.writer.startTrackingWrites();const i=ia(this);if(this.boxWriter.writeBox(i),this.format._options.onMoov){const{data:a,start:n}=this.writer.stopTrackingWrites();this.format._options.onMoov(a,n)}this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat.size=t,this.boxWriter.writeBox(this.mdat);for(const a of this.finalizedChunks)for(const n of a.samples)E(n.data),this.writer.write(n.data),n.data=null;if(this.format._options.onMdat){const{data:a,start:n}=this.writer.stopTrackingWrites();this.format._options.onMdat(a,n)}}else if(this.isFragmented){const t=this.writer.getPos(),i=qm(this.trackDatas);this.boxWriter.writeBox(i);const a=this.writer.getPos()-t;this.writer.seek(this.writer.getPos()-4),this.boxWriter.writeU32(a)}else{E(this.mdat);const t=this.boxWriter.offsets.get(this.mdat);E(t!==void 0);const i=this.writer.getPos()-t;if(this.mdat.size=i,this.mdat.largeSize=i>=2**32,this.boxWriter.patchBox(this.mdat),this.format._options.onMdat){const{data:n,start:s}=this.writer.stopTrackingWrites();this.format._options.onMdat(n,s)}const a=ia(this);if(this.fastStart==="reserve"){E(this.ftypSize!==null),this.writer.seek(this.ftypSize),this.format._options.onMoov&&this.writer.startTrackingWrites(),this.boxWriter.writeBox(a);const n=this.boxWriter.offsets.get(this.mdat)-this.writer.getPos();this.boxWriter.writeBox(rm(n))}else this.format._options.onMoov&&this.writer.startTrackingWrites(),this.boxWriter.writeBox(a);if(this.format._options.onMoov){const{data:n,start:s}=this.writer.stopTrackingWrites();this.format._options.onMoov(n,s)}}e()}}const fp=-32768,hp=2**15-1,Ko="Mediabunny",Go=6,Qo=5,mp={video:1,audio:2,subtitle:17};class pp extends Dc{constructor(e,t){super(e),this.trackDatas=[],this.allTracksKnown=Rt(),this.segment=null,this.segmentInfo=null,this.seekHead=null,this.tracksElement=null,this.tagsElement=null,this.attachmentsElement=null,this.segmentDuration=null,this.cues=null,this.currentCluster=null,this.currentClusterStartMsTimestamp=null,this.currentClusterMaxMsTimestamp=null,this.trackDatasInCurrentCluster=new Map,this.duration=0,this.writer=e._writer,this.format=t,this.ebmlWriter=new Vf(this.writer),this.format._options.appendOnly&&(this.writer.ensureMonotonicity=!0)}async start(){const e=await this.mutex.acquire();this.writeEBMLHeader(),this.createSegmentInfo(),this.createCues(),await this.writer.flush(),e()}writeEBMLHeader(){this.format._options.onEbmlHeader&&this.writer.startTrackingWrites();const e={id:D.EBML,data:[{id:D.EBMLVersion,data:1},{id:D.EBMLReadVersion,data:1},{id:D.EBMLMaxIDLength,data:4},{id:D.EBMLMaxSizeLength,data:8},{id:D.DocType,data:this.format instanceof ln?"webm":"matroska"},{id:D.DocTypeVersion,data:2},{id:D.DocTypeReadVersion,data:2}]};if(this.ebmlWriter.writeEBML(e),this.format._options.onEbmlHeader){const{data:t,start:i}=this.writer.stopTrackingWrites();this.format._options.onEbmlHeader(t,i)}}maybeCreateSeekHead(e){if(this.format._options.appendOnly)return;const t=new Uint8Array([28,83,187,107]),i=new Uint8Array([21,73,169,102]),a=new Uint8Array([22,84,174,107]),n=new Uint8Array([25,65,164,105]),s=new Uint8Array([18,84,195,103]),o={id:D.SeekHead,data:[{id:D.Seek,data:[{id:D.SeekID,data:t},{id:D.SeekPosition,size:5,data:e?this.ebmlWriter.offsets.get(this.cues)-this.segmentDataOffset:0}]},{id:D.Seek,data:[{id:D.SeekID,data:i},{id:D.SeekPosition,size:5,data:e?this.ebmlWriter.offsets.get(this.segmentInfo)-this.segmentDataOffset:0}]},{id:D.Seek,data:[{id:D.SeekID,data:a},{id:D.SeekPosition,size:5,data:e?this.ebmlWriter.offsets.get(this.tracksElement)-this.segmentDataOffset:0}]},this.attachmentsElement?{id:D.Seek,data:[{id:D.SeekID,data:n},{id:D.SeekPosition,size:5,data:e?this.ebmlWriter.offsets.get(this.attachmentsElement)-this.segmentDataOffset:0}]}:null,this.tagsElement?{id:D.Seek,data:[{id:D.SeekID,data:s},{id:D.SeekPosition,size:5,data:e?this.ebmlWriter.offsets.get(this.tagsElement)-this.segmentDataOffset:0}]}:null]};this.seekHead=o}createSegmentInfo(){const e={id:D.Duration,data:new tn(0)};this.segmentDuration=e;const t={id:D.Info,data:[{id:D.TimestampScale,data:1e6},{id:D.MuxingApp,data:Ko},{id:D.WritingApp,data:Ko},this.format._options.appendOnly?null:e]};this.segmentInfo=t}createTracks(){const e={id:D.Tracks,data:[]};this.tracksElement=e;for(const t of this.trackDatas){const i=hr[t.track.source._codec];E(i);let a=0;if(t.type==="audio"&&t.track.source._codec==="opus"){a=1e6*80;const n=t.info.decoderConfig.description;if(n){const s=Lt(n),o=Mn(s);a=Math.round(1e9*(o.preSkip/Ta))}}e.data.push({id:D.TrackEntry,data:[{id:D.TrackNumber,data:t.track.id},{id:D.TrackUID,data:t.track.id},{id:D.TrackType,data:mp[t.type]},t.track.metadata.disposition?.default===!1?{id:D.FlagDefault,data:0}:null,t.track.metadata.disposition?.forced?{id:D.FlagForced,data:1}:null,t.track.metadata.disposition?.hearingImpaired?{id:D.FlagHearingImpaired,data:1}:null,t.track.metadata.disposition?.visuallyImpaired?{id:D.FlagVisualImpaired,data:1}:null,t.track.metadata.disposition?.original?{id:D.FlagOriginal,data:1}:null,t.track.metadata.disposition?.commentary?{id:D.FlagCommentary,data:1}:null,{id:D.FlagLacing,data:0},{id:D.Language,data:t.track.metadata.languageCode??Gt},{id:D.CodecID,data:i},{id:D.CodecDelay,data:0},{id:D.SeekPreRoll,data:a},t.track.metadata.name!==void 0?{id:D.Name,data:new Wr(t.track.metadata.name)}:null,t.type==="video"?this.videoSpecificTrackInfo(t):null,t.type==="audio"?this.audioSpecificTrackInfo(t):null,t.type==="subtitle"?this.subtitleSpecificTrackInfo(t):null]})}}videoSpecificTrackInfo(e){const{frameRate:t,rotation:i}=e.track.metadata,a=[e.info.decoderConfig.description?{id:D.CodecPrivate,data:Lt(e.info.decoderConfig.description)}:null,t?{id:D.DefaultDuration,data:1e9/t}:null],n=i?as(-i):0,s=e.info.decoderConfig.colorSpace,o={id:D.Video,data:[{id:D.PixelWidth,data:e.info.width},{id:D.PixelHeight,data:e.info.height},e.info.alphaMode?{id:D.AlphaMode,data:1}:null,Cc(s)?{id:D.Colour,data:[{id:D.MatrixCoefficients,data:Qi[s.matrix]},{id:D.TransferCharacteristics,data:Gi[s.transfer]},{id:D.Primaries,data:Ki[s.primaries]},{id:D.Range,data:s.fullRange?2:1}]}:null,n?{id:D.Projection,data:[{id:D.ProjectionType,data:0},{id:D.ProjectionPoseRoll,data:new en((n+180)%360-180)}]}:null]};return a.push(o),a}audioSpecificTrackInfo(e){const t=Ot.includes(e.track.source._codec)?Ur(e.track.source._codec):null;return[e.info.decoderConfig.description?{id:D.CodecPrivate,data:Lt(e.info.decoderConfig.description)}:null,{id:D.Audio,data:[{id:D.SamplingFrequency,data:new en(e.info.sampleRate)},{id:D.Channels,data:e.info.numberOfChannels},t?{id:D.BitDepth,data:8*t.sampleSize}:null]}]}subtitleSpecificTrackInfo(e){return[{id:D.CodecPrivate,data:Kt.encode(e.info.config.description)}]}maybeCreateTags(){const e=[],t=(n,s)=>{e.push({id:D.SimpleTag,data:[{id:D.TagName,data:new Wr(n)},typeof s=="string"?{id:D.TagString,data:new Wr(s)}:{id:D.TagBinary,data:s}]})},i=this.output._metadataTags,a=new Set;for(const{key:n,value:s}of Sn(i))switch(n){case"title":t("TITLE",s),a.add("TITLE");break;case"description":t("DESCRIPTION",s),a.add("DESCRIPTION");break;case"artist":t("ARTIST",s),a.add("ARTIST");break;case"album":t("ALBUM",s),a.add("ALBUM");break;case"albumArtist":t("ALBUM_ARTIST",s),a.add("ALBUM_ARTIST");break;case"genre":t("GENRE",s),a.add("GENRE");break;case"comment":t("COMMENT",s),a.add("COMMENT");break;case"lyrics":t("LYRICS",s),a.add("LYRICS");break;case"date":t("DATE",s.toISOString().slice(0,10)),a.add("DATE");break;case"trackNumber":{const o=i.tracksTotal!==void 0?`${s}/${i.tracksTotal}`:s.toString();t("PART_NUMBER",o),a.add("PART_NUMBER")}break;case"discNumber":{const o=i.discsTotal!==void 0?`${s}/${i.discsTotal}`:s.toString();t("DISC",o),a.add("DISC")}break;case"tracksTotal":case"discsTotal":break;case"images":case"raw":break;default:Tr(n)}if(i.raw)for(const n in i.raw){const s=i.raw[n];s==null||a.has(n)||(typeof s=="string"||s instanceof Uint8Array)&&t(n,s)}e.length!==0&&(this.tagsElement={id:D.Tags,data:[{id:D.Tag,data:[{id:D.Targets,data:[{id:D.TargetTypeValue,data:50},{id:D.TargetType,data:"MOVIE"}]},...e]}]})}maybeCreateAttachments(){const e=this.output._metadataTags,t=[],i=new Set,a=e.images??[];for(const n of a){let s=n.name;s===void 0&&(s=(n.kind==="coverFront"?"cover":n.kind==="coverBack"?"back":"image")+(Uu(n.mimeType)??""));let o;for(;;){o=0n;for(let c=0;c<8;c++)o<<=8n,o|=BigInt(Math.floor(Math.random()*256));if(o!==0n&&!i.has(o))break}i.add(o),t.push({id:D.AttachedFile,data:[n.description!==void 0?{id:D.FileDescription,data:new Wr(n.description)}:null,{id:D.FileName,data:new Wr(s)},{id:D.FileMediaType,data:n.mimeType},{id:D.FileData,data:n.data},{id:D.FileUID,data:o}]})}for(const[n,s]of Object.entries(e.raw??{}))!(s instanceof Cn)||!/^\d+$/.test(n)||a.find(c=>c.mimeType===s.mimeType&&Lu(c.data,s.data))||t.push({id:D.AttachedFile,data:[s.description!==void 0?{id:D.FileDescription,data:new Wr(s.description)}:null,{id:D.FileName,data:new Wr(s.name??"")},{id:D.FileMediaType,data:s.mimeType??""},{id:D.FileData,data:s.data},{id:D.FileUID,data:BigInt(n)}]});t.length!==0&&(this.attachmentsElement={id:D.Attachments,data:t})}createSegment(){this.createTracks(),this.maybeCreateTags(),this.maybeCreateAttachments(),this.maybeCreateSeekHead(!1);const e={id:D.Segment,size:this.format._options.appendOnly?-1:Go,data:[this.seekHead,this.segmentInfo,this.tracksElement,this.attachmentsElement,this.tagsElement]};if(this.segment=e,this.format._options.onSegmentHeader&&this.writer.startTrackingWrites(),this.ebmlWriter.writeEBML(e),this.format._options.onSegmentHeader){const{data:t,start:i}=this.writer.stopTrackingWrites();this.format._options.onSegmentHeader(t,i)}}createCues(){this.cues={id:D.Cues,data:[]}}get segmentDataOffset(){return E(this.segment),this.ebmlWriter.dataOffsets.get(this.segment)}allTracksAreKnown(){for(const e of this.output._tracks)if(!e.source._closed&&!this.trackDatas.some(t=>t.track===e))return!1;return!0}async getMimeType(){await this.allTracksKnown.promise;const e=this.trackDatas.map(t=>t.type==="video"||t.type==="audio"?t.info.decoderConfig.codec:{webvtt:"wvtt"}[t.track.source._codec]);return il({isWebM:this.format instanceof ln,hasVideo:this.trackDatas.some(t=>t.type==="video"),hasAudio:this.trackDatas.some(t=>t.type==="audio"),codecStrings:e})}getVideoTrackData(e,t,i){const a=this.trackDatas.find(s=>s.track===e);if(a)return a;zc(i),E(i),E(i.decoderConfig),E(i.decoderConfig.codedWidth!==void 0),E(i.decoderConfig.codedHeight!==void 0);const n={track:e,type:"video",info:{width:i.decoderConfig.codedWidth,height:i.decoderConfig.codedHeight,decoderConfig:i.decoderConfig,alphaMode:!!t.sideData.alpha},chunkQueue:[],lastWrittenMsTimestamp:null};return e.source._codec==="vp9"?n.info.decoderConfig={...n.info.decoderConfig,description:new Uint8Array(Hu(n.info.decoderConfig.codec))}:e.source._codec==="av1"&&(n.info.decoderConfig={...n.info.decoderConfig,description:new Uint8Array(Ac(n.info.decoderConfig.codec))}),this.trackDatas.push(n),this.trackDatas.sort((s,o)=>s.track.id-o.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),n}getAudioTrackData(e,t,i){const a=this.trackDatas.find(c=>c.track===e);if(a)return a;Mc(i),E(i),E(i.decoderConfig);const n={...i.decoderConfig};let s=!1;if(e.source._codec==="aac"&&!n.description){const c=Nr(ir.tempFromBytes(t.data));if(!c)throw new Error("Couldn't parse ADTS header from the AAC packet. Make sure the packets are in ADTS format (as specified in ISO 13818-7) when not providing a description, or provide a description (must be an AudioSpecificConfig as specified in ISO 14496-3) and ensure the packets are raw AAC data.");const l=Yr[c.samplingFrequencyIndex],d=Xi[c.channelConfiguration];if(l===void 0||d===void 0)throw new Error("Invalid ADTS frame header.");n.description=An({objectType:c.objectType,sampleRate:l,numberOfChannels:d}),s=!0}const o={track:e,type:"audio",info:{numberOfChannels:i.decoderConfig.numberOfChannels,sampleRate:i.decoderConfig.sampleRate,decoderConfig:n,requiresAdtsStripping:s},chunkQueue:[],lastWrittenMsTimestamp:null};return this.trackDatas.push(o),this.trackDatas.sort((c,l)=>c.track.id-l.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),o}getSubtitleTrackData(e,t){const i=this.trackDatas.find(n=>n.track===e);if(i)return i;Rc(t),E(t),E(t.config);const a={track:e,type:"subtitle",info:{config:t.config},chunkQueue:[],lastWrittenMsTimestamp:null};return this.trackDatas.push(a),this.trackDatas.sort((n,s)=>n.track.id-s.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),a}async addEncodedVideoPacket(e,t,i){const a=await this.mutex.acquire();try{const n=this.getVideoTrackData(e,t,i),s=t.type==="key";let o=this.validateAndNormalizeTimestamp(n.track,t.timestamp,s),c=t.duration;e.metadata.frameRate!==void 0&&(o=Qa(o,1/e.metadata.frameRate),c=Qa(c,1/e.metadata.frameRate));const l=n.info.alphaMode?t.sideData.alpha??null:null,d=this.createInternalChunk(t.data,o,c,t.type,l);e.source._codec==="vp9"&&this.fixVP9ColorSpace(n,d),n.chunkQueue.push(d),await this.interleaveChunks()}finally{a()}}async addEncodedAudioPacket(e,t,i){const a=await this.mutex.acquire();try{const n=this.getAudioTrackData(e,t,i);let s=t.data;if(n.info.requiresAdtsStripping){const d=Nr(ir.tempFromBytes(s));if(!d)throw new Error("Expected ADTS frame, didn't get one.");const u=d.crcCheck===null?ya:Zr;s=s.subarray(u)}const o=t.type==="key",c=this.validateAndNormalizeTimestamp(n.track,t.timestamp,o),l=this.createInternalChunk(s,c,t.duration,t.type);n.chunkQueue.push(l),await this.interleaveChunks()}finally{a()}}async addSubtitleCue(e,t,i){const a=await this.mutex.acquire();try{const n=this.getSubtitleTrackData(e,i),s=this.validateAndNormalizeTimestamp(n.track,t.timestamp,!0);let o=t.text;const c=Math.round(s*1e3);ts.lastIndex=0,o=o.replace(ts,f=>{const g=em(f.slice(1,-1))-c;return`<${pl(g)}>`});const l=Kt.encode(o),d=`${t.settings??""}
${t.identifier??""}
${t.notes??""}`,u=this.createInternalChunk(l,s,t.duration,"key",d.trim()?Kt.encode(d):null);n.chunkQueue.push(u),await this.interleaveChunks()}finally{a()}}async interleaveChunks(e=!1){if(!(!e&&!this.allTracksAreKnown())){e:for(;;){let t=null,i=1/0;for(const n of this.trackDatas){if(!e&&n.chunkQueue.length===0&&!n.track.source._closed)break e;n.chunkQueue.length>0&&n.chunkQueue[0].timestamp<i&&(t=n,i=n.chunkQueue[0].timestamp)}if(!t)break;const a=t.chunkQueue.shift();this.writeBlock(t,a)}e||await this.writer.flush()}}fixVP9ColorSpace(e,t){if(t.type!=="key"||!e.info.decoderConfig.colorSpace||!e.info.decoderConfig.colorSpace.matrix)return;const i=new ft(t.data);i.skipBits(2);const a=i.readBits(1),s=(i.readBits(1)<<1)+a;if(s===3&&i.skipBits(1),i.readBits(1)||i.readBits(1)!==0||(i.skipBits(2),i.readBits(24)!==4817730))return;s>=2&&i.skipBits(1);const d={rgb:7,bt709:2,bt470bg:1,smpte170m:3}[e.info.decoderConfig.colorSpace.matrix];Au(t.data,i.pos,i.pos+3,d)}createInternalChunk(e,t,i,a,n=null){return{data:e,type:a,timestamp:t,duration:i,additions:n}}writeBlock(e,t){this.segment||this.createSegment();const i=Math.round(1e3*t.timestamp),a=this.trackDatas.every(d=>{if(e===d)return t.type==="key";const u=d.chunkQueue[0];return u?u.type==="key":d.track.source._closed});let n=!1;if(!this.currentCluster)n=!0;else{E(this.currentClusterStartMsTimestamp!==null),E(this.currentClusterMaxMsTimestamp!==null);const d=i-this.currentClusterStartMsTimestamp;n=a&&i>this.currentClusterMaxMsTimestamp&&d>=1e3*(this.format._options.minimumClusterDuration??1)||d>hp}n&&this.createNewCluster(i);const s=i-this.currentClusterStartMsTimestamp;if(s<fp)return;const o=new Uint8Array(4),c=new DataView(o.buffer);c.setUint8(0,128|e.track.id),c.setInt16(1,s,!1);const l=Math.round(1e3*t.duration);if(t.additions){const d={id:D.BlockGroup,data:[{id:D.Block,data:[o,t.data]},t.type==="delta"?{id:D.ReferenceBlock,data:new Jc(e.lastWrittenMsTimestamp-i)}:null,t.additions?{id:D.BlockAdditions,data:[{id:D.BlockMore,data:[{id:D.BlockAddID,data:1},{id:D.BlockAdditional,data:t.additions}]}]}:null,l>0?{id:D.BlockDuration,data:l}:null]};this.ebmlWriter.writeEBML(d)}else{c.setUint8(3,+(t.type==="key")<<7);const d={id:D.SimpleBlock,data:[o,t.data]};this.ebmlWriter.writeEBML(d)}this.duration=Math.max(this.duration,i+l),e.lastWrittenMsTimestamp=i,this.trackDatasInCurrentCluster.has(e)||this.trackDatasInCurrentCluster.set(e,{firstMsTimestamp:i}),this.currentClusterMaxMsTimestamp=Math.max(this.currentClusterMaxMsTimestamp,i)}createNewCluster(e){this.currentCluster&&this.finalizeCurrentCluster(),this.format._options.onCluster&&this.writer.startTrackingWrites(),this.currentCluster={id:D.Cluster,size:this.format._options.appendOnly?-1:Qo,data:[{id:D.Timestamp,data:e}]},this.ebmlWriter.writeEBML(this.currentCluster),this.currentClusterStartMsTimestamp=e,this.currentClusterMaxMsTimestamp=e,this.trackDatasInCurrentCluster.clear()}finalizeCurrentCluster(){if(E(this.currentCluster),!this.format._options.appendOnly){const a=this.writer.getPos()-this.ebmlWriter.dataOffsets.get(this.currentCluster),n=this.writer.getPos();this.writer.seek(this.ebmlWriter.offsets.get(this.currentCluster)+4),this.ebmlWriter.writeVarInt(a,Qo),this.writer.seek(n)}if(this.format._options.onCluster){E(this.currentClusterStartMsTimestamp!==null);const{data:a,start:n}=this.writer.stopTrackingWrites();this.format._options.onCluster(a,n,this.currentClusterStartMsTimestamp/1e3)}const e=this.ebmlWriter.offsets.get(this.currentCluster)-this.segmentDataOffset,t=new Map;for(const[a,{firstMsTimestamp:n}]of this.trackDatasInCurrentCluster)t.has(n)||t.set(n,[]),t.get(n).push(a);const i=[...t.entries()].sort((a,n)=>a[0]-n[0]);for(const[a,n]of i)E(this.cues),this.cues.data.push({id:D.CuePoint,data:[{id:D.CueTime,data:a},...n.map(s=>({id:D.CueTrackPositions,data:[{id:D.CueTrack,data:s.track.id},{id:D.CueClusterPosition,data:e}]}))]})}async onTrackClose(){const e=await this.mutex.acquire();this.allTracksAreKnown()&&this.allTracksKnown.resolve(),await this.interleaveChunks(),e()}async finalize(){const e=await this.mutex.acquire();if(this.allTracksKnown.resolve(),this.segment||this.createSegment(),await this.interleaveChunks(!0),this.currentCluster&&this.finalizeCurrentCluster(),E(this.cues),this.ebmlWriter.writeEBML(this.cues),!this.format._options.appendOnly){const t=this.writer.getPos(),i=this.writer.getPos()-this.segmentDataOffset;this.writer.seek(this.ebmlWriter.offsets.get(this.segment)+4),this.ebmlWriter.writeVarInt(i,Go),this.segmentDuration.data=new tn(this.duration),this.writer.seek(this.ebmlWriter.offsets.get(this.segmentDuration)),this.ebmlWriter.writeEBML(this.segmentDuration),E(this.seekHead),this.writer.seek(this.ebmlWriter.offsets.get(this.seekHead)),this.maybeCreateSeekHead(!0),this.ebmlWriter.writeEBML(this.seekHead),this.writer.seek(t)}e()}}class jn{getSupportedVideoCodecs(){return this.getSupportedCodecs().filter(e=>dr.includes(e))}getSupportedAudioCodecs(){return this.getSupportedCodecs().filter(e=>pr.includes(e))}getSupportedSubtitleCodecs(){return this.getSupportedCodecs().filter(e=>Hi.includes(e))}_codecUnsupportedHint(e){return""}}class Il extends jn{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.fastStart!==void 0&&![!1,"in-memory","reserve","fragmented"].includes(e.fastStart))throw new TypeError("options.fastStart, when provided, must be false, 'in-memory', 'reserve', or 'fragmented'.");if(e.minimumFragmentDuration!==void 0&&(!Number.isFinite(e.minimumFragmentDuration)||e.minimumFragmentDuration<0))throw new TypeError("options.minimumFragmentDuration, when provided, must be a non-negative number.");if(e.onFtyp!==void 0&&typeof e.onFtyp!="function")throw new TypeError("options.onFtyp, when provided, must be a function.");if(e.onMoov!==void 0&&typeof e.onMoov!="function")throw new TypeError("options.onMoov, when provided, must be a function.");if(e.onMdat!==void 0&&typeof e.onMdat!="function")throw new TypeError("options.onMdat, when provided, must be a function.");if(e.onMoof!==void 0&&typeof e.onMoof!="function")throw new TypeError("options.onMoof, when provided, must be a function.");if(e.metadataFormat!==void 0&&!["mdir","mdta","udta","auto"].includes(e.metadataFormat))throw new TypeError("options.metadataFormat, when provided, must be either 'auto', 'mdir', 'mdta', or 'udta'.");super(),this._options=e}getSupportedTrackCounts(){return{video:{min:0,max:4294967295},audio:{min:0,max:4294967295},subtitle:{min:0,max:4294967295},total:{min:1,max:4294967295}}}get supportsVideoRotationMetadata(){return!0}_createMuxer(e){return new up(e,this)}}class qn extends Il{constructor(e){super(e)}get _name(){return"MP4"}get fileExtension(){return".mp4"}get mimeType(){return"video/mp4"}getSupportedCodecs(){return[...dr,...Oi,"pcm-s16","pcm-s16be","pcm-s24","pcm-s24be","pcm-s32","pcm-s32be","pcm-f32","pcm-f32be","pcm-f64","pcm-f64be",...Hi]}_codecUnsupportedHint(e){return new Al().getSupportedCodecs().includes(e)?" Switching to MOV will grant support for this codec.":""}}class Al extends Il{constructor(e){super(e)}get _name(){return"MOV"}get fileExtension(){return".mov"}get mimeType(){return"video/quicktime"}getSupportedCodecs(){return[...dr,...pr]}_codecUnsupportedHint(e){return new qn().getSupportedCodecs().includes(e)?" Switching to MP4 will grant support for this codec.":""}}class Xo extends jn{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.appendOnly!==void 0&&typeof e.appendOnly!="boolean")throw new TypeError("options.appendOnly, when provided, must be a boolean.");if(e.minimumClusterDuration!==void 0&&(!Number.isFinite(e.minimumClusterDuration)||e.minimumClusterDuration<0))throw new TypeError("options.minimumClusterDuration, when provided, must be a non-negative number.");if(e.onEbmlHeader!==void 0&&typeof e.onEbmlHeader!="function")throw new TypeError("options.onEbmlHeader, when provided, must be a function.");if(e.onSegmentHeader!==void 0&&typeof e.onSegmentHeader!="function")throw new TypeError("options.onHeader, when provided, must be a function.");if(e.onCluster!==void 0&&typeof e.onCluster!="function")throw new TypeError("options.onCluster, when provided, must be a function.");super(),this._options=e}_createMuxer(e){return new pp(e,this)}get _name(){return"Matroska"}getSupportedTrackCounts(){return{video:{min:0,max:127},audio:{min:0,max:127},subtitle:{min:0,max:127},total:{min:1,max:127}}}get fileExtension(){return".mkv"}get mimeType(){return"video/x-matroska"}getSupportedCodecs(){return[...dr,...Oi,...Ot.filter(e=>!["pcm-s8","pcm-f32be","pcm-f64be","ulaw","alaw"].includes(e)),...Hi]}get supportsVideoRotationMetadata(){return!1}}class ln extends Xo{constructor(e){super(e)}getSupportedCodecs(){return[...dr.filter(e=>["vp8","vp9","av1"].includes(e)),...pr.filter(e=>["opus","vorbis"].includes(e)),...Hi]}get _name(){return"WebM"}get fileExtension(){return".webm"}get mimeType(){return"video/webm"}_codecUnsupportedHint(e){return new Xo().getSupportedCodecs().includes(e)?" Switching to MKV will grant support for this codec.":""}}const gp=r=>{if(!r||typeof r!="object")throw new TypeError("Encoding config must be an object.");if(!dr.includes(r.codec))throw new TypeError(`Invalid video codec '${r.codec}'. Must be one of: ${dr.join(", ")}.`);if(!(r.bitrate instanceof ar)&&(!Number.isInteger(r.bitrate)||r.bitrate<=0))throw new TypeError("config.bitrate must be a positive integer or a quality.");if(r.keyFrameInterval!==void 0&&(!Number.isFinite(r.keyFrameInterval)||r.keyFrameInterval<0))throw new TypeError("config.keyFrameInterval, when provided, must be a non-negative number.");if(r.sizeChangeBehavior!==void 0&&!["deny","passThrough","fill","contain","cover"].includes(r.sizeChangeBehavior))throw new TypeError("config.sizeChangeBehavior, when provided, must be 'deny', 'passThrough', 'fill', 'contain' or 'cover'.");if(r.onEncodedPacket!==void 0&&typeof r.onEncodedPacket!="function")throw new TypeError("config.onEncodedChunk, when provided, must be a function.");if(r.onEncoderConfig!==void 0&&typeof r.onEncoderConfig!="function")throw new TypeError("config.onEncoderConfig, when provided, must be a function.");Fl(r.codec,r)},Fl=(r,e)=>{if(!e||typeof e!="object")throw new TypeError("Encoding options must be an object.");if(e.alpha!==void 0&&!["discard","keep"].includes(e.alpha))throw new TypeError("options.alpha, when provided, must be 'discard' or 'keep'.");if(e.bitrateMode!==void 0&&!["constant","variable"].includes(e.bitrateMode))throw new TypeError("bitrateMode, when provided, must be 'constant' or 'variable'.");if(e.latencyMode!==void 0&&!["quality","realtime"].includes(e.latencyMode))throw new TypeError("latencyMode, when provided, must be 'quality' or 'realtime'.");if(e.fullCodecString!==void 0&&typeof e.fullCodecString!="string")throw new TypeError("fullCodecString, when provided, must be a string.");if(e.fullCodecString!==void 0&&Bc(e.fullCodecString)!==r)throw new TypeError(`fullCodecString, when provided, must be a string that matches the specified codec (${r}).`);if(e.hardwareAcceleration!==void 0&&!["no-preference","prefer-hardware","prefer-software"].includes(e.hardwareAcceleration))throw new TypeError("hardwareAcceleration, when provided, must be 'no-preference', 'prefer-hardware' or 'prefer-software'.");if(e.scalabilityMode!==void 0&&typeof e.scalabilityMode!="string")throw new TypeError("scalabilityMode, when provided, must be a string.");if(e.contentHint!==void 0&&typeof e.contentHint!="string")throw new TypeError("contentHint, when provided, must be a string.")},dn=r=>{const e=r.bitrate instanceof ar?r.bitrate._toVideoBitrate(r.codec,r.width,r.height):r.bitrate;return{codec:r.fullCodecString??Wu(r.codec,r.width,r.height,e),width:r.width,height:r.height,bitrate:e,bitrateMode:r.bitrateMode,alpha:r.alpha??"discard",framerate:r.framerate,latencyMode:r.latencyMode,hardwareAcceleration:r.hardwareAcceleration,scalabilityMode:r.scalabilityMode,contentHint:r.contentHint,...qu(r.codec)}},vp=r=>{if(!r||typeof r!="object")throw new TypeError("Encoding config must be an object.");if(!pr.includes(r.codec))throw new TypeError(`Invalid audio codec '${r.codec}'. Must be one of: ${pr.join(", ")}.`);if(r.bitrate===void 0&&(!Ot.includes(r.codec)||r.codec==="flac"))throw new TypeError("config.bitrate must be provided for compressed audio codecs.");if(r.bitrate!==void 0&&!(r.bitrate instanceof ar)&&(!Number.isInteger(r.bitrate)||r.bitrate<=0))throw new TypeError("config.bitrate, when provided, must be a positive integer or a quality.");if(r.onEncodedPacket!==void 0&&typeof r.onEncodedPacket!="function")throw new TypeError("config.onEncodedChunk, when provided, must be a function.");if(r.onEncoderConfig!==void 0&&typeof r.onEncoderConfig!="function")throw new TypeError("config.onEncoderConfig, when provided, must be a function.");Bl(r.codec,r)},Bl=(r,e)=>{if(!e||typeof e!="object")throw new TypeError("Encoding options must be an object.");if(e.bitrateMode!==void 0&&!["constant","variable"].includes(e.bitrateMode))throw new TypeError("bitrateMode, when provided, must be 'constant' or 'variable'.");if(e.fullCodecString!==void 0&&typeof e.fullCodecString!="string")throw new TypeError("fullCodecString, when provided, must be a string.");if(e.fullCodecString!==void 0&&Bc(e.fullCodecString)!==r)throw new TypeError(`fullCodecString, when provided, must be a string that matches the specified codec (${r}).`)},un=r=>{const e=r.bitrate instanceof ar?r.bitrate._toAudioBitrate(r.codec):r.bitrate;return{codec:r.fullCodecString??ju(r.codec,r.numberOfChannels,r.sampleRate),numberOfChannels:r.numberOfChannels,sampleRate:r.sampleRate,bitrate:e,bitrateMode:r.bitrateMode,...Ku(r.codec)}};class ar{constructor(e){this._factor=e}_toVideoBitrate(e,t,i){const a=t*i,n={avc:1,hevc:.6,vp9:.6,av1:.4,vp8:1.2},s=1920*1080,o=3e6,c=Math.pow(a/s,.95),u=o*c*n[e]*this._factor;return Math.ceil(u/1e3)*1e3}_toAudioBitrate(e){if(Ot.includes(e)||e==="flac")return;const i={aac:128e3,opus:64e3,mp3:16e4,vorbis:64e3}[e];if(!i)throw new Error(`Unhandled codec: ${e}`);let a=i*this._factor;return e==="aac"?a=[96e3,128e3,16e4,192e3].reduce((s,o)=>Math.abs(o-a)<Math.abs(s-a)?o:s):e==="opus"||e==="vorbis"?a=Math.max(6e3,a):e==="mp3"&&(a=[8e3,16e3,24e3,32e3,4e4,48e3,64e3,8e4,96e3,112e3,128e3,16e4,192e3,224e3,256e3,32e4].reduce((s,o)=>Math.abs(o-a)<Math.abs(s-a)?o:s)),Math.round(a/1e3)*1e3}}const bp=new ar(.3),wp=new ar(.6),Kn=new ar(1),rs=new ar(2),kp=new ar(4),fn=async(r,e={})=>{const{width:t=1280,height:i=720,bitrate:a=1e6,...n}=e;if(!dr.includes(r))return!1;if(!Number.isInteger(t)||t<=0)throw new TypeError("width must be a positive integer.");if(!Number.isInteger(i)||i<=0)throw new TypeError("height must be a positive integer.");if(!(a instanceof ar)&&(!Number.isInteger(a)||a<=0))throw new TypeError("bitrate must be a positive integer or a quality.");Fl(r,n);let s=null;return Xs.length>0&&(s??=dn({codec:r,width:t,height:i,bitrate:a,framerate:void 0,...n}),Xs.some(l=>l.supports(r,s)))?!0:typeof VideoEncoder>"u"||(t%2===1||i%2===1)&&(r==="avc"||r==="hevc")||(s??=dn({codec:r,width:t,height:i,bitrate:a,framerate:void 0,...n,alpha:"discard"}),!(await VideoEncoder.isConfigSupported(s)).supported)?!1:Wi()?new Promise(async l=>{try{const d=new VideoEncoder({output:()=>{},error:()=>l(!1)});d.configure(s);const u=new Uint8Array(t*i*4),f=new VideoFrame(u,{format:"RGBA",codedWidth:t,codedHeight:i,timestamp:0});d.encode(f),f.close(),await d.flush(),l(!0)}catch{l(!1)}}):!0},zl=async(r,e={})=>{const{numberOfChannels:t=2,sampleRate:i=48e3,bitrate:a=128e3,...n}=e;if(!pr.includes(r))return!1;if(!Number.isInteger(t)||t<=0)throw new TypeError("numberOfChannels must be a positive integer.");if(!Number.isInteger(i)||i<=0)throw new TypeError("sampleRate must be a positive integer.");if(!(a instanceof ar)&&(!Number.isInteger(a)||a<=0))throw new TypeError("bitrate must be a positive integer.");Bl(r,n);let s=null;return Zs.length>0&&(s??=un({codec:r,numberOfChannels:t,sampleRate:i,bitrate:a,...n}),Zs.some(c=>c.supports(r,s)))||Ot.includes(r)?!0:typeof AudioEncoder>"u"?!1:(s??=un({codec:r,numberOfChannels:t,sampleRate:i,bitrate:a,...n}),(await AudioEncoder.isConfigSupported(s)).supported===!0)},Zo=async(r=pr,e)=>{const t=await Promise.all(r.map(i=>zl(i,e)));return r.filter((i,a)=>t[a])},yp=async(r,e)=>{for(const t of r)if(await fn(t,e))return t;return null};class Gn{constructor(){this._connectedTrack=null,this._closingPromise=null,this._closed=!1,this._timestampOffset=0}_ensureValidAdd(){if(!this._connectedTrack)throw new Error("Source is not connected to an output track.");if(this._connectedTrack.output.state==="canceled")throw new Error("Output has been canceled.");if(this._connectedTrack.output.state==="finalizing"||this._connectedTrack.output.state==="finalized")throw new Error("Output has been finalized.");if(this._connectedTrack.output.state==="pending")throw new Error("Output has not started.");if(this._closed)throw new Error("Source is closed.")}async _start(){}async _flushAndClose(e){}close(){if(this._closingPromise)return;const e=this._connectedTrack;if(!e)throw new Error("Cannot call close without connecting the source to an output track.");if(e.output.state==="pending")throw new Error("Cannot call close before output has been started.");this._closingPromise=(async()=>{await this._flushAndClose(!1),this._closed=!0,!(e.output.state==="finalizing"||e.output.state==="finalized")&&e.output._muxer.onTrackClose(e)})()}async _flushOrWaitForOngoingClose(e){return this._closingPromise??=(async()=>{await this._flushAndClose(e),this._closed=!0})()}}class Qn extends Gn{constructor(e){if(super(),this._connectedTrack=null,!dr.includes(e))throw new TypeError(`Invalid video codec '${e}'. Must be one of: ${dr.join(", ")}.`);this._codec=e}}class xp extends Qn{constructor(e){super(e)}add(e,t){if(!(e instanceof ht))throw new TypeError("packet must be an EncodedPacket.");if(e.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be added.");if(t!==void 0&&(!t||typeof t!="object"))throw new TypeError("meta, when provided, must be an object.");return this._ensureValidAdd(),this._connectedTrack.output._muxer.addEncodedVideoPacket(this._connectedTrack,e,t)}}class _p{constructor(e,t){this.source=e,this.encodingConfig=t,this.ensureEncoderPromise=null,this.encoderInitialized=!1,this.encoder=null,this.muxer=null,this.lastMultipleOfKeyFrameInterval=-1,this.codedWidth=null,this.codedHeight=null,this.resizeCanvas=null,this.customEncoder=null,this.customEncoderCallSerializer=new os,this.customEncoderQueueSize=0,this.alphaEncoder=null,this.splitter=null,this.splitterCreationFailed=!1,this.alphaFrameQueue=[],this.error=null,this.errorNeedsNewStack=!0}async add(e,t,i){try{if(this.checkForEncoderError(),this.source._ensureValidAdd(),this.codedWidth!==null&&this.codedHeight!==null){if(e.codedWidth!==this.codedWidth||e.codedHeight!==this.codedHeight){const o=this.encodingConfig.sizeChangeBehavior??"deny";if(o!=="passThrough"){if(o==="deny")throw new Error(`Video sample size must remain constant. Expected ${this.codedWidth}x${this.codedHeight}, got ${e.codedWidth}x${e.codedHeight}. To allow the sample size to change over time, set \`sizeChangeBehavior\` to a value other than 'strict' in the encoding options.`);{let c=!1;this.resizeCanvas||(typeof document<"u"?(this.resizeCanvas=document.createElement("canvas"),this.resizeCanvas.width=this.codedWidth,this.resizeCanvas.height=this.codedHeight):this.resizeCanvas=new OffscreenCanvas(this.codedWidth,this.codedHeight),c=!0);const l=this.resizeCanvas.getContext("2d",{alpha:Wi()});E(l),c||(Wi()?(l.fillStyle="black",l.fillRect(0,0,this.codedWidth,this.codedHeight)):l.clearRect(0,0,this.codedWidth,this.codedHeight)),e.drawWithFit(l,{fit:o}),t&&e.close(),e=new Wt(this.resizeCanvas,{timestamp:e.timestamp,duration:e.duration,rotation:e.rotation}),t=!0}}}}else this.codedWidth=e.codedWidth,this.codedHeight=e.codedHeight;this.encoderInitialized||(this.ensureEncoderPromise||this.ensureEncoder(e),this.encoderInitialized||await this.ensureEncoderPromise),E(this.encoderInitialized);const a=this.encodingConfig.keyFrameInterval??5,n=Math.floor(e.timestamp/a),s={...i,keyFrame:i?.keyFrame||a===0||n!==this.lastMultipleOfKeyFrameInterval};if(this.lastMultipleOfKeyFrameInterval=n,this.customEncoder){this.customEncoderQueueSize++;const o=e.clone(),c=this.customEncoderCallSerializer.call(()=>this.customEncoder.encode(o,s)).then(()=>this.customEncoderQueueSize--).catch(l=>this.error??=l).finally(()=>{o.close()});this.customEncoderQueueSize>=4&&await c}else{E(this.encoder);const o=e.toVideoFrame();if(!this.alphaEncoder)this.encoder.encode(o,s),o.close();else if(!!o.format&&!o.format.includes("A")||this.splitterCreationFailed)this.alphaFrameQueue.push(null),this.encoder.encode(o,s),o.close();else{const l=o.displayWidth,d=o.displayHeight;if(!this.splitter)try{this.splitter=new Tp(l,d)}catch(u){console.error("Due to an error, only color data will be encoded.",u),this.splitterCreationFailed=!0,this.alphaFrameQueue.push(null),this.encoder.encode(o,s),o.close()}if(this.splitter){const u=this.splitter.extractColor(o),f=this.splitter.extractAlpha(o);this.alphaFrameQueue.push(f),this.encoder.encode(u,s),u.close(),o.close()}}t&&e.close(),this.encoder.encodeQueueSize>=4&&await new Promise(c=>this.encoder.addEventListener("dequeue",c,{once:!0}))}await this.muxer.mutex.currentPromise}finally{t&&e.close()}}ensureEncoder(e){const t=new Error;this.ensureEncoderPromise=(async()=>{const i=dn({width:e.codedWidth,height:e.codedHeight,...this.encodingConfig,framerate:this.source._connectedTrack?.metadata.frameRate});this.encodingConfig.onEncoderConfig?.(i);const a=Xs.find(n=>n.supports(this.encodingConfig.codec,i));if(a)this.customEncoder=new a,this.customEncoder.codec=this.encodingConfig.codec,this.customEncoder.config=i,this.customEncoder.onPacket=(n,s)=>{if(!(n instanceof ht))throw new TypeError("The first argument passed to onPacket must be an EncodedPacket.");if(s!==void 0&&(!s||typeof s!="object"))throw new TypeError("The second argument passed to onPacket must be an object or undefined.");this.encodingConfig.onEncodedPacket?.(n,s),this.muxer.addEncodedVideoPacket(this.source._connectedTrack,n,s).catch(o=>{this.error??=o,this.errorNeedsNewStack=!1})},await this.customEncoder.init();else{if(typeof VideoEncoder>"u")throw new Error("VideoEncoder is not supported by this browser.");if(i.alpha="discard",this.encodingConfig.alpha==="keep"&&(i.latencyMode="quality"),(i.width%2===1||i.height%2===1)&&(this.encodingConfig.codec==="avc"||this.encodingConfig.codec==="hevc"))throw new Error(`The dimensions ${i.width}x${i.height} are not supported for codec '${this.encodingConfig.codec}'; both width and height must be even numbers. Make sure to round your dimensions to the nearest even number.`);if(!(await VideoEncoder.isConfigSupported(i)).supported)throw new Error(`This specific encoder configuration (${i.codec}, ${i.bitrate} bps, ${i.width}x${i.height}, hardware acceleration: ${i.hardwareAcceleration??"no-preference"}) is not supported by this browser. Consider using another codec or changing your video parameters.`);const o=[],c=[];let l=0,d=0;const u=(f,h,g)=>{const m={};if(h){const v=new Uint8Array(h.byteLength);h.copyTo(v),m.alpha=v}const p=ht.fromEncodedChunk(f,m);this.encodingConfig.onEncodedPacket?.(p,g),this.muxer.addEncodedVideoPacket(this.source._connectedTrack,p,g).catch(v=>{this.error??=v,this.errorNeedsNewStack=!1})};this.encoder=new VideoEncoder({output:(f,h)=>{if(!this.alphaEncoder){u(f,null,h);return}const g=this.alphaFrameQueue.shift();E(g!==void 0),g?(this.alphaEncoder.encode(g,{keyFrame:f.type==="key"}),d++,g.close(),o.push({chunk:f,meta:h})):d===0?u(f,null,h):(c.push(l+d),o.push({chunk:f,meta:h}))},error:f=>{f.stack=t.stack,this.error??=f}}),this.encoder.configure(i),this.encodingConfig.alpha==="keep"&&(this.alphaEncoder=new VideoEncoder({output:(f,h)=>{d--;const g=o.shift();for(E(g!==void 0),u(g.chunk,f,g.meta),l++;c.length>0&&c[0]===l;){c.shift();const m=o.shift();E(m!==void 0),u(m.chunk,null,m.meta)}},error:f=>{f.stack=t.stack,this.error??=f}}),this.alphaEncoder.configure(i))}E(this.source._connectedTrack),this.muxer=this.source._connectedTrack.output._muxer,this.encoderInitialized=!0})()}async flushAndClose(e){e||this.checkForEncoderError(),this.customEncoder?(e||this.customEncoderCallSerializer.call(()=>this.customEncoder.flush()),await this.customEncoderCallSerializer.call(()=>this.customEncoder.close())):this.encoder&&(e||(await this.encoder.flush(),await this.alphaEncoder?.flush()),this.encoder.state!=="closed"&&this.encoder.close(),this.alphaEncoder&&this.alphaEncoder.state!=="closed"&&this.alphaEncoder.close(),this.alphaFrameQueue.forEach(t=>t?.close()),this.splitter?.close()),e||this.checkForEncoderError()}getQueueSize(){return this.customEncoder?this.customEncoderQueueSize:this.encoder?.encodeQueueSize??0}checkForEncoderError(){if(this.error)throw this.errorNeedsNewStack&&(this.error.stack=new Error().stack),this.error}}class Tp{constructor(e,t){this.lastFrame=null,typeof OffscreenCanvas<"u"?this.canvas=new OffscreenCanvas(e,t):(this.canvas=document.createElement("canvas"),this.canvas.width=e,this.canvas.height=t);const i=this.canvas.getContext("webgl2",{alpha:!0});if(!i)throw new Error("Couldn't acquire WebGL 2 context.");this.gl=i,this.colorProgram=this.createColorProgram(),this.alphaProgram=this.createAlphaProgram(),this.vao=this.createVAO(),this.sourceTexture=this.createTexture(),this.alphaResolutionLocation=this.gl.getUniformLocation(this.alphaProgram,"u_resolution"),this.gl.useProgram(this.colorProgram),this.gl.uniform1i(this.gl.getUniformLocation(this.colorProgram,"u_sourceTexture"),0),this.gl.useProgram(this.alphaProgram),this.gl.uniform1i(this.gl.getUniformLocation(this.alphaProgram,"u_sourceTexture"),0)}createVertexShader(){return this.createShader(this.gl.VERTEX_SHADER,`#version 300 es
			in vec2 a_position;
			in vec2 a_texCoord;
			out vec2 v_texCoord;
			
			void main() {
				gl_Position = vec4(a_position, 0.0, 1.0);
				v_texCoord = a_texCoord;
			}
		`)}createColorProgram(){const e=this.createVertexShader(),t=this.createShader(this.gl.FRAGMENT_SHADER,`#version 300 es
			precision highp float;
			
			uniform sampler2D u_sourceTexture;
			in vec2 v_texCoord;
			out vec4 fragColor;
			
			void main() {
				vec4 source = texture(u_sourceTexture, v_texCoord);
				fragColor = vec4(source.rgb, 1.0);
			}
		`),i=this.gl.createProgram();return this.gl.attachShader(i,e),this.gl.attachShader(i,t),this.gl.linkProgram(i),i}createAlphaProgram(){const e=this.createVertexShader(),t=this.createShader(this.gl.FRAGMENT_SHADER,`#version 300 es
			precision highp float;
			
			uniform sampler2D u_sourceTexture;
			uniform vec2 u_resolution; // The width and height of the canvas
			in vec2 v_texCoord;
			out vec4 fragColor;

			// This function determines the value for a single byte in the YUV stream
			float getByteValue(float byteOffset) {
				float width = u_resolution.x;
				float height = u_resolution.y;

				float yPlaneSize = width * height;

				if (byteOffset < yPlaneSize) {
					// This byte is in the luma plane. Find the corresponding pixel coordinates to sample from
					float y = floor(byteOffset / width);
					float x = mod(byteOffset, width);
					
					// Add 0.5 to sample the center of the texel
					vec2 sampleCoord = (vec2(x, y) + 0.5) / u_resolution;
					
					// The luma value is the alpha from the source texture
					return texture(u_sourceTexture, sampleCoord).a;
				} else {
					// Write a fixed value for chroma and beyond
					return 128.0 / 255.0;
				}
			}
			
			void main() {
				// Each fragment writes 4 bytes (R, G, B, A)
				float pixelIndex = floor(gl_FragCoord.y) * u_resolution.x + floor(gl_FragCoord.x);
				float baseByteOffset = pixelIndex * 4.0;

				vec4 result;
				for (int i = 0; i < 4; i++) {
					float currentByteOffset = baseByteOffset + float(i);
					result[i] = getByteValue(currentByteOffset);
				}
				
				fragColor = result;
			}
		`),i=this.gl.createProgram();return this.gl.attachShader(i,e),this.gl.attachShader(i,t),this.gl.linkProgram(i),i}createShader(e,t){const i=this.gl.createShader(e);return this.gl.shaderSource(i,t),this.gl.compileShader(i),this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS)||console.error("Shader compile error:",this.gl.getShaderInfoLog(i)),i}createVAO(){const e=this.gl.createVertexArray();this.gl.bindVertexArray(e);const t=new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,1,1,1,0]),i=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,i),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.STATIC_DRAW);const a=this.gl.getAttribLocation(this.colorProgram,"a_position"),n=this.gl.getAttribLocation(this.colorProgram,"a_texCoord");return this.gl.enableVertexAttribArray(a),this.gl.vertexAttribPointer(a,2,this.gl.FLOAT,!1,16,0),this.gl.enableVertexAttribArray(n),this.gl.vertexAttribPointer(n,2,this.gl.FLOAT,!1,16,8),e}createTexture(){const e=this.gl.createTexture();return this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),e}updateTexture(e){this.lastFrame!==e&&((e.displayWidth!==this.canvas.width||e.displayHeight!==this.canvas.height)&&(this.canvas.width=e.displayWidth,this.canvas.height=e.displayHeight),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.sourceTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),this.lastFrame=e)}extractColor(e){return this.updateTexture(e),this.gl.useProgram(this.colorProgram),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.bindVertexArray(this.vao),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4),new VideoFrame(this.canvas,{timestamp:e.timestamp,duration:e.duration??void 0,alpha:"discard"})}extractAlpha(e){this.updateTexture(e),this.gl.useProgram(this.alphaProgram),this.gl.uniform2f(this.alphaResolutionLocation,this.canvas.width,this.canvas.height),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.bindVertexArray(this.vao),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4);const{width:t,height:i}=this.canvas,a=Math.ceil(t/2)*Math.ceil(i/2),n=t*i+a*2,s=Math.ceil(n/(t*4));let o=new Uint8Array(4*t*s);this.gl.readPixels(0,0,t,s,this.gl.RGBA,this.gl.UNSIGNED_BYTE,o),o=o.subarray(0,n),E(o[t*i]===128),E(o[o.length-1]===128);const c={format:"I420",codedWidth:t,codedHeight:i,timestamp:e.timestamp,duration:e.duration??void 0,transfer:[o.buffer]};return new VideoFrame(o,c)}close(){this.gl.getExtension("WEBGL_lose_context")?.loseContext(),this.gl=null}}class Yo extends Qn{constructor(e){gp(e),super(e.codec),this._encoder=new _p(this,e)}add(e,t){if(!(e instanceof Wt))throw new TypeError("videoSample must be a VideoSample.");return this._encoder.add(e,!1,t)}_flushAndClose(e){return this._encoder.flushAndClose(e)}}class Xn extends Gn{constructor(e){if(super(),this._connectedTrack=null,!pr.includes(e))throw new TypeError(`Invalid audio codec '${e}'. Must be one of: ${pr.join(", ")}.`);this._codec=e}}class Sp extends Xn{constructor(e){super(e)}add(e,t){if(!(e instanceof ht))throw new TypeError("packet must be an EncodedPacket.");if(e.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be added.");if(t!==void 0&&(!t||typeof t!="object"))throw new TypeError("meta, when provided, must be an object.");return this._ensureValidAdd(),this._connectedTrack.output._muxer.addEncodedAudioPacket(this._connectedTrack,e,t)}}class Cp{constructor(e,t){this.source=e,this.encodingConfig=t,this.ensureEncoderPromise=null,this.encoderInitialized=!1,this.encoder=null,this.muxer=null,this.lastNumberOfChannels=null,this.lastSampleRate=null,this.isPcmEncoder=!1,this.outputSampleSize=null,this.writeOutputValue=null,this.customEncoder=null,this.customEncoderCallSerializer=new os,this.customEncoderQueueSize=0,this.lastEndSampleIndex=null,this.error=null,this.errorNeedsNewStack=!0}async add(e,t){try{if(this.checkForEncoderError(),this.source._ensureValidAdd(),this.lastNumberOfChannels!==null&&this.lastSampleRate!==null){if(e.numberOfChannels!==this.lastNumberOfChannels||e.sampleRate!==this.lastSampleRate)throw new Error(`Audio parameters must remain constant. Expected ${this.lastNumberOfChannels} channels at ${this.lastSampleRate} Hz, got ${e.numberOfChannels} channels at ${e.sampleRate} Hz.`)}else this.lastNumberOfChannels=e.numberOfChannels,this.lastSampleRate=e.sampleRate;this.encoderInitialized||(this.ensureEncoderPromise||this.ensureEncoder(e),this.encoderInitialized||await this.ensureEncoderPromise),E(this.encoderInitialized);{const i=Math.round(e.timestamp*e.sampleRate),a=Math.round((e.timestamp+e.duration)*e.sampleRate);if(this.lastEndSampleIndex===null)this.lastEndSampleIndex=a;else{const n=i-this.lastEndSampleIndex;if(n>=64){const s=new cr({data:new Float32Array(n*e.numberOfChannels),format:"f32-planar",sampleRate:e.sampleRate,numberOfChannels:e.numberOfChannels,numberOfFrames:n,timestamp:this.lastEndSampleIndex/e.sampleRate});await this.add(s,!0)}this.lastEndSampleIndex+=e.numberOfFrames}}if(this.customEncoder){this.customEncoderQueueSize++;const i=e.clone(),a=this.customEncoderCallSerializer.call(()=>this.customEncoder.encode(i)).then(()=>this.customEncoderQueueSize--).catch(n=>this.error??=n).finally(()=>{i.close()});this.customEncoderQueueSize>=4&&await a,await this.muxer.mutex.currentPromise}else if(this.isPcmEncoder)await this.doPcmEncoding(e,t);else{E(this.encoder);const i=e.toAudioData();this.encoder.encode(i),i.close(),t&&e.close(),this.encoder.encodeQueueSize>=4&&await new Promise(a=>this.encoder.addEventListener("dequeue",a,{once:!0})),await this.muxer.mutex.currentPromise}}finally{t&&e.close()}}async doPcmEncoding(e,t){E(this.outputSampleSize),E(this.writeOutputValue);const{numberOfChannels:i,numberOfFrames:a,sampleRate:n,timestamp:s}=e,o=2048,c=[];for(let f=0;f<a;f+=o){const h=Math.min(o,e.numberOfFrames-f),g=h*i*this.outputSampleSize,m=new ArrayBuffer(g),p=new DataView(m);c.push({frameCount:h,view:p})}const l=e.allocationSize({planeIndex:0,format:"f32-planar"}),d=new Float32Array(l/Float32Array.BYTES_PER_ELEMENT);for(let f=0;f<i;f++){e.copyTo(d,{planeIndex:f,format:"f32-planar"});for(let h=0;h<c.length;h++){const{frameCount:g,view:m}=c[h];for(let p=0;p<g;p++)this.writeOutputValue(m,(p*i+f)*this.outputSampleSize,d[h*o+p])}}t&&e.close();const u={decoderConfig:{codec:this.encodingConfig.codec,numberOfChannels:i,sampleRate:n}};for(let f=0;f<c.length;f++){const{frameCount:h,view:g}=c[f],m=g.buffer,p=f*o,v=new ht(new Uint8Array(m),"key",s+p/n,h/n);this.encodingConfig.onEncodedPacket?.(v,u),await this.muxer.addEncodedAudioPacket(this.source._connectedTrack,v,u)}}ensureEncoder(e){const t=new Error;this.ensureEncoderPromise=(async()=>{const{numberOfChannels:i,sampleRate:a}=e,n=un({numberOfChannels:i,sampleRate:a,...this.encodingConfig});this.encodingConfig.onEncoderConfig?.(n);const s=Zs.find(o=>o.supports(this.encodingConfig.codec,n));if(s)this.customEncoder=new s,this.customEncoder.codec=this.encodingConfig.codec,this.customEncoder.config=n,this.customEncoder.onPacket=(o,c)=>{if(!(o instanceof ht))throw new TypeError("The first argument passed to onPacket must be an EncodedPacket.");if(c!==void 0&&(!c||typeof c!="object"))throw new TypeError("The second argument passed to onPacket must be an object or undefined.");this.encodingConfig.onEncodedPacket?.(o,c),this.muxer.addEncodedAudioPacket(this.source._connectedTrack,o,c).catch(l=>{this.error??=l,this.errorNeedsNewStack=!1})},await this.customEncoder.init();else if(Ot.includes(this.encodingConfig.codec))this.initPcmEncoder();else{if(typeof AudioEncoder>"u")throw new Error("AudioEncoder is not supported by this browser.");if(!(await AudioEncoder.isConfigSupported(n)).supported)throw new Error(`This specific encoder configuration (${n.codec}, ${n.bitrate} bps, ${n.numberOfChannels} channels, ${n.sampleRate} Hz) is not supported by this browser. Consider using another codec or changing your audio parameters.`);this.encoder=new AudioEncoder({output:(c,l)=>{if(this.encodingConfig.codec==="aac"&&l?.decoderConfig){let u=!1;if(!l.decoderConfig.description||l.decoderConfig.description.byteLength<2?u=!0:u=In(Lt(l.decoderConfig.description)).objectType===0,u){const f=Number(wt(n.codec.split(".")));l.decoderConfig.description=An({objectType:f,numberOfChannels:l.decoderConfig.numberOfChannels,sampleRate:l.decoderConfig.sampleRate})}}const d=ht.fromEncodedChunk(c);this.encodingConfig.onEncodedPacket?.(d,l),this.muxer.addEncodedAudioPacket(this.source._connectedTrack,d,l).catch(u=>{this.error??=u,this.errorNeedsNewStack=!1})},error:c=>{c.stack=t.stack,this.error??=c}}),this.encoder.configure(n)}E(this.source._connectedTrack),this.muxer=this.source._connectedTrack.output._muxer,this.encoderInitialized=!0})()}initPcmEncoder(){this.isPcmEncoder=!0;const e=this.encodingConfig.codec,{dataType:t,sampleSize:i,littleEndian:a}=Ur(e);switch(this.outputSampleSize=i,i){case 1:t==="unsigned"?this.writeOutputValue=(n,s,o)=>n.setUint8(s,Mt((o+1)*127.5,0,255)):t==="signed"?this.writeOutputValue=(n,s,o)=>{n.setInt8(s,Mt(Math.round(o*128),-128,127))}:t==="ulaw"?this.writeOutputValue=(n,s,o)=>{const c=Mt(Math.floor(o*32767),-32768,32767);n.setUint8(s,vf(c))}:t==="alaw"?this.writeOutputValue=(n,s,o)=>{const c=Mt(Math.floor(o*32767),-32768,32767);n.setUint8(s,wf(c))}:E(!1);break;case 2:t==="unsigned"?this.writeOutputValue=(n,s,o)=>n.setUint16(s,Mt((o+1)*32767.5,0,65535),a):t==="signed"?this.writeOutputValue=(n,s,o)=>n.setInt16(s,Mt(Math.round(o*32767),-32768,32767),a):E(!1);break;case 3:t==="unsigned"?this.writeOutputValue=(n,s,o)=>Tn(n,s,Mt((o+1)*83886075e-1,0,16777215),a):t==="signed"?this.writeOutputValue=(n,s,o)=>Mu(n,s,Mt(Math.round(o*8388607),-8388608,8388607),a):E(!1);break;case 4:t==="unsigned"?this.writeOutputValue=(n,s,o)=>n.setUint32(s,Mt((o+1)*21474836475e-1,0,4294967295),a):t==="signed"?this.writeOutputValue=(n,s,o)=>n.setInt32(s,Mt(Math.round(o*2147483647),-2147483648,2147483647),a):t==="float"?this.writeOutputValue=(n,s,o)=>n.setFloat32(s,o,a):E(!1);break;case 8:t==="float"?this.writeOutputValue=(n,s,o)=>n.setFloat64(s,o,a):E(!1);break;default:Tr(i),E(!1)}}async flushAndClose(e){e||this.checkForEncoderError(),this.customEncoder?(e||this.customEncoderCallSerializer.call(()=>this.customEncoder.flush()),await this.customEncoderCallSerializer.call(()=>this.customEncoder.close())):this.encoder&&(e||await this.encoder.flush(),this.encoder.state!=="closed"&&this.encoder.close()),e||this.checkForEncoderError()}getQueueSize(){return this.customEncoder?this.customEncoderQueueSize:this.isPcmEncoder?0:this.encoder?.encodeQueueSize??0}checkForEncoderError(){if(this.error)throw this.errorNeedsNewStack&&(this.error.stack=new Error().stack),this.error}}class Jo extends Xn{constructor(e){vp(e),super(e.codec),this._encoder=new Cp(this,e)}add(e){if(!(e instanceof cr))throw new TypeError("audioSample must be an AudioSample.");return this._encoder.add(e,!1)}_flushAndClose(e){return this._encoder.flushAndClose(e)}}class Pp extends Gn{constructor(e){if(super(),this._connectedTrack=null,!Hi.includes(e))throw new TypeError(`Invalid subtitle codec '${e}'. Must be one of: ${Hi.join(", ")}.`);this._codec=e}}const Ep=["video","audio","subtitle"],Ms=r=>{if(!r||typeof r!="object")throw new TypeError("metadata must be an object.");if(r.languageCode!==void 0&&!ga(r.languageCode))throw new TypeError("metadata.languageCode, when provided, must be a three-letter, ISO 639-2/T language code.");if(r.name!==void 0&&typeof r.name!="string")throw new TypeError("metadata.name, when provided, must be a string.");if(r.disposition!==void 0&&$u(r.disposition),r.maximumPacketCount!==void 0&&(!Number.isInteger(r.maximumPacketCount)||r.maximumPacketCount<0))throw new TypeError("metadata.maximumPacketCount, when provided, must be a non-negative integer.")};class hn{constructor(e){if(this.state="pending",this._tracks=[],this._startPromise=null,this._cancelPromise=null,this._finalizePromise=null,this._mutex=new fi,this._metadataTags={},!e||typeof e!="object")throw new TypeError("options must be an object.");if(!(e.format instanceof jn))throw new TypeError("options.format must be an OutputFormat.");if(!(e.target instanceof Hn))throw new TypeError("options.target must be a Target.");if(e.target._output)throw new Error("Target is already used for another output.");e.target._output=this,this.format=e.format,this.target=e.target,this._writer=e.target._createWriter(),this._muxer=e.format._createMuxer(this)}addVideoTrack(e,t={}){if(!(e instanceof Qn))throw new TypeError("source must be a VideoSource.");if(Ms(t),t.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError(`Invalid video rotation: ${t.rotation}. Has to be 0, 90, 180 or 270.`);if(!this.format.supportsVideoRotationMetadata&&t.rotation)throw new Error(`${this.format._name} does not support video rotation metadata.`);if(t.frameRate!==void 0&&(!Number.isFinite(t.frameRate)||t.frameRate<=0))throw new TypeError(`Invalid video frame rate: ${t.frameRate}. Must be a positive number.`);this._addTrack("video",e,t)}addAudioTrack(e,t={}){if(!(e instanceof Xn))throw new TypeError("source must be an AudioSource.");Ms(t),this._addTrack("audio",e,t)}addSubtitleTrack(e,t={}){if(!(e instanceof Pp))throw new TypeError("source must be a SubtitleSource.");Ms(t),this._addTrack("subtitle",e,t)}setMetadataTags(e){if(Gs(e),this.state!=="pending")throw new Error("Cannot set metadata tags after output has been started or canceled.");this._metadataTags=e}_addTrack(e,t,i){if(this.state!=="pending")throw new Error("Cannot add track after output has been started or canceled.");if(t._connectedTrack)throw new Error("Source is already used for a track.");const a=this.format.getSupportedTrackCounts(),n=this._tracks.reduce((l,d)=>l+(d.type===e?1:0),0),s=a[e].max;if(n===s)throw new Error(s===0?`${this.format._name} does not support ${e} tracks.`:`${this.format._name} does not support more than ${s} ${e} track${s===1?"":"s"}.`);const o=a.total.max;if(this._tracks.length===o)throw new Error(`${this.format._name} does not support more than ${o} tracks${o===1?"":"s"} in total.`);const c={id:this._tracks.length+1,output:this,type:e,source:t,metadata:i};if(c.type==="video"){const l=this.format.getSupportedVideoCodecs();if(l.length===0)throw new Error(`${this.format._name} does not support video tracks.`+this.format._codecUnsupportedHint(c.source._codec));if(!l.includes(c.source._codec))throw new Error(`Codec '${c.source._codec}' cannot be contained within ${this.format._name}. Supported video codecs are: ${l.map(d=>`'${d}'`).join(", ")}.`+this.format._codecUnsupportedHint(c.source._codec))}else if(c.type==="audio"){const l=this.format.getSupportedAudioCodecs();if(l.length===0)throw new Error(`${this.format._name} does not support audio tracks.`+this.format._codecUnsupportedHint(c.source._codec));if(!l.includes(c.source._codec))throw new Error(`Codec '${c.source._codec}' cannot be contained within ${this.format._name}. Supported audio codecs are: ${l.map(d=>`'${d}'`).join(", ")}.`+this.format._codecUnsupportedHint(c.source._codec))}else if(c.type==="subtitle"){const l=this.format.getSupportedSubtitleCodecs();if(l.length===0)throw new Error(`${this.format._name} does not support subtitle tracks.`+this.format._codecUnsupportedHint(c.source._codec));if(!l.includes(c.source._codec))throw new Error(`Codec '${c.source._codec}' cannot be contained within ${this.format._name}. Supported subtitle codecs are: ${l.map(d=>`'${d}'`).join(", ")}.`+this.format._codecUnsupportedHint(c.source._codec))}this._tracks.push(c),t._connectedTrack=c}async start(){const e=this.format.getSupportedTrackCounts();for(const i of Ep){const a=this._tracks.reduce((s,o)=>s+(o.type===i?1:0),0),n=e[i].min;if(a<n)throw new Error(n===e[i].max?`${this.format._name} requires exactly ${n} ${i} track${n===1?"":"s"}.`:`${this.format._name} requires at least ${n} ${i} track${n===1?"":"s"}.`)}const t=e.total.min;if(this._tracks.length<t)throw new Error(t===e.total.max?`${this.format._name} requires exactly ${t} track${t===1?"":"s"}.`:`${this.format._name} requires at least ${t} track${t===1?"":"s"}.`);if(this.state==="canceled")throw new Error("Output has been canceled.");return this._startPromise?(console.warn("Output has already been started."),this._startPromise):this._startPromise=(async()=>{this.state="started",this._writer.start();const i=await this._mutex.acquire();await this._muxer.start();const a=this._tracks.map(n=>n.source._start());await Promise.all(a),i()})()}getMimeType(){return this._muxer.getMimeType()}async cancel(){if(this._cancelPromise)return console.warn("Output has already been canceled."),this._cancelPromise;if(this.state==="finalizing"||this.state==="finalized"){console.warn("Output has already been finalized.");return}return this._cancelPromise=(async()=>{this.state="canceled";const e=await this._mutex.acquire(),t=this._tracks.map(i=>i.source._flushOrWaitForOngoingClose(!0));await Promise.all(t),await this._writer.close(),e()})()}async finalize(){if(this.state==="pending")throw new Error("Cannot finalize before starting.");if(this.state==="canceled")throw new Error("Cannot finalize after canceling.");return this._finalizePromise?(console.warn("Output has already been finalized."),this._finalizePromise):this._finalizePromise=(async()=>{this.state="finalizing";const e=await this._mutex.acquire(),t=this._tracks.map(i=>i.source._flushOrWaitForOngoingClose(!1));await Promise.all(t),await this._muxer.finalize(),await this._writer.flush(),await this._writer.finalize(),this.state="finalized",e()})()}}const ec=r=>{if(r!==void 0&&(!r||typeof r!="object"))throw new TypeError("options.video, when provided, must be an object.");if(r?.discard!==void 0&&typeof r.discard!="boolean")throw new TypeError("options.video.discard, when provided, must be a boolean.");if(r?.forceTranscode!==void 0&&typeof r.forceTranscode!="boolean")throw new TypeError("options.video.forceTranscode, when provided, must be a boolean.");if(r?.codec!==void 0&&!dr.includes(r.codec))throw new TypeError(`options.video.codec, when provided, must be one of: ${dr.join(", ")}.`);if(r?.bitrate!==void 0&&!(r.bitrate instanceof ar)&&(!Number.isInteger(r.bitrate)||r.bitrate<=0))throw new TypeError("options.video.bitrate, when provided, must be a positive integer or a quality.");if(r?.width!==void 0&&(!Number.isInteger(r.width)||r.width<=0))throw new TypeError("options.video.width, when provided, must be a positive integer.");if(r?.height!==void 0&&(!Number.isInteger(r.height)||r.height<=0))throw new TypeError("options.video.height, when provided, must be a positive integer.");if(r?.fit!==void 0&&!["fill","contain","cover"].includes(r.fit))throw new TypeError("options.video.fit, when provided, must be one of 'fill', 'contain', or 'cover'.");if(r?.width!==void 0&&r.height!==void 0&&r.fit===void 0)throw new TypeError("When both options.video.width and options.video.height are provided, options.video.fit must also be provided.");if(r?.rotate!==void 0&&![0,90,180,270].includes(r.rotate))throw new TypeError("options.video.rotate, when provided, must be 0, 90, 180 or 270.");if(r?.allowRotationMetadata!==void 0&&typeof r.allowRotationMetadata!="boolean")throw new TypeError("options.video.allowRotationMetadata, when provided, must be a boolean.");if(r?.crop!==void 0&&On(r.crop,"options.video."),r?.frameRate!==void 0&&(!Number.isFinite(r.frameRate)||r.frameRate<=0))throw new TypeError("options.video.frameRate, when provided, must be a finite positive number.");if(r?.alpha!==void 0&&!["discard","keep"].includes(r.alpha))throw new TypeError("options.video.alpha, when provided, must be either 'discard' or 'keep'.");if(r?.keyFrameInterval!==void 0&&(!Number.isFinite(r.keyFrameInterval)||r.keyFrameInterval<0))throw new TypeError("options.video.keyFrameInterval, when provided, must be a non-negative number.");if(r?.process!==void 0&&typeof r.process!="function")throw new TypeError("options.video.process, when provided, must be a function.");if(r?.processedWidth!==void 0&&(!Number.isInteger(r.processedWidth)||r.processedWidth<=0))throw new TypeError("options.video.processedWidth, when provided, must be a positive integer.");if(r?.processedHeight!==void 0&&(!Number.isInteger(r.processedHeight)||r.processedHeight<=0))throw new TypeError("options.video.processedHeight, when provided, must be a positive integer.");if(r?.hardwareAcceleration!==void 0&&!["no-preference","prefer-hardware","prefer-software"].includes(r.hardwareAcceleration))throw new TypeError("options.video.hardwareAcceleration, when provided, must be 'no-preference', 'prefer-hardware' or 'prefer-software'.")},tc=r=>{if(r!==void 0&&(!r||typeof r!="object"))throw new TypeError("options.audio, when provided, must be an object.");if(r?.discard!==void 0&&typeof r.discard!="boolean")throw new TypeError("options.audio.discard, when provided, must be a boolean.");if(r?.forceTranscode!==void 0&&typeof r.forceTranscode!="boolean")throw new TypeError("options.audio.forceTranscode, when provided, must be a boolean.");if(r?.codec!==void 0&&!pr.includes(r.codec))throw new TypeError(`options.audio.codec, when provided, must be one of: ${pr.join(", ")}.`);if(r?.bitrate!==void 0&&!(r.bitrate instanceof ar)&&(!Number.isInteger(r.bitrate)||r.bitrate<=0))throw new TypeError("options.audio.bitrate, when provided, must be a positive integer or a quality.");if(r?.numberOfChannels!==void 0&&(!Number.isInteger(r.numberOfChannels)||r.numberOfChannels<=0))throw new TypeError("options.audio.numberOfChannels, when provided, must be a positive integer.");if(r?.sampleRate!==void 0&&(!Number.isInteger(r.sampleRate)||r.sampleRate<=0))throw new TypeError("options.audio.sampleRate, when provided, must be a positive integer.");if(r?.process!==void 0&&typeof r.process!="function")throw new TypeError("options.audio.process, when provided, must be a function.");if(r?.processedNumberOfChannels!==void 0&&(!Number.isInteger(r.processedNumberOfChannels)||r.processedNumberOfChannels<=0))throw new TypeError("options.audio.processedNumberOfChannels, when provided, must be a positive integer.");if(r?.processedSampleRate!==void 0&&(!Number.isInteger(r.processedSampleRate)||r.processedSampleRate<=0))throw new TypeError("options.audio.processedSampleRate, when provided, must be a positive integer.")},Rs=2,Ds=48e3;class Zn{static async init(e){const t=new Zn(e);return await t._init(),t}constructor(e){if(this._addedCounts={video:0,audio:0,subtitle:0},this._totalTrackCount=0,this._trackPromises=[],this._executed=!1,this._synchronizer=new Ap,this._totalDuration=null,this._maxTimestamps=new Map,this._canceled=!1,this.onProgress=void 0,this._computeProgress=!1,this._lastProgress=0,this.isValid=!1,this.utilizedTracks=[],this.discardedTracks=[],!e||typeof e!="object")throw new TypeError("options must be an object.");if(!(e.input instanceof hl))throw new TypeError("options.input must be an Input.");if(!(e.output instanceof hn))throw new TypeError("options.output must be an Output.");if(e.output._tracks.length>0||Object.keys(e.output._metadataTags).length>0||e.output.state!=="pending")throw new TypeError("options.output must be fresh: no tracks or metadata tags added and not started.");if(typeof e.video!="function"&&ec(e.video),typeof e.audio!="function"&&tc(e.audio),e.trim!==void 0&&(!e.trim||typeof e.trim!="object"))throw new TypeError("options.trim, when provided, must be an object.");if(e.trim?.start!==void 0&&(!Number.isFinite(e.trim.start)||e.trim.start<0))throw new TypeError("options.trim.start, when provided, must be a non-negative number.");if(e.trim?.end!==void 0&&(!Number.isFinite(e.trim.end)||e.trim.end<0))throw new TypeError("options.trim.end, when provided, must be a non-negative number.");if(e.trim?.start!==void 0&&e.trim.end!==void 0&&e.trim.start>=e.trim.end)throw new TypeError("options.trim.start must be less than options.trim.end.");if(e.tags!==void 0&&(typeof e.tags!="object"||!e.tags)&&typeof e.tags!="function")throw new TypeError("options.tags, when provided, must be an object or a function.");if(typeof e.tags=="object"&&Gs(e.tags),e.showWarnings!==void 0&&typeof e.showWarnings!="boolean")throw new TypeError("options.showWarnings, when provided, must be a boolean.");this._options=e,this.input=e.input,this.output=e.output;const{promise:t,resolve:i}=Rt();this._started=t,this._start=i}async _init(){this._startTimestamp=this._options.trim?.start??Math.max(await this.input.getFirstTimestamp(),0),this._endTimestamp=this._options.trim?.end??1/0;const e=await this.input.getTracks(),t=this.output.format.getSupportedTrackCounts();let i=1,a=1;for(const l of e){let d;if(l.isVideoTrack()?this._options.video&&(typeof this._options.video=="function"?(d=await this._options.video(l,i),ec(d),i++):d=this._options.video):l.isAudioTrack()?this._options.audio&&(typeof this._options.audio=="function"?(d=await this._options.audio(l,a),tc(d),a++):d=this._options.audio):E(!1),d?.discard){this.discardedTracks.push({track:l,reason:"discarded_by_user"});continue}if(this._totalTrackCount===t.total.max){this.discardedTracks.push({track:l,reason:"max_track_count_reached"});continue}if(this._addedCounts[l.type]===t[l.type].max){this.discardedTracks.push({track:l,reason:"max_track_count_of_type_reached"});continue}l.isVideoTrack()?await this._processVideoTrack(l,d??{}):l.isAudioTrack()&&await this._processAudioTrack(l,d??{})}const n=await this.input.getMetadataTags();let s;if(this._options.tags){const l=typeof this._options.tags=="function"?await this._options.tags(n):this._options.tags;Gs(l),s=l}else s=n;const o=(await this.input.getFormat()).mimeType===this.output.format.mimeType,c=n.raw===s.raw;if(n.raw&&c&&!o&&delete s.raw,this.output.setMetadataTags(s),this.isValid=this._totalTrackCount>=t.total.min&&this._addedCounts.video>=t.video.min&&this._addedCounts.audio>=t.audio.min&&this._addedCounts.subtitle>=t.subtitle.min,this._options.showWarnings??!0){const l=[],d=this.discardedTracks.filter(u=>u.reason!=="discarded_by_user");d.length>0&&l.push("Some tracks had to be discarded from the conversion:",d),this.isValid||l.push(`

`+this._getInvalidityExplanation().join("")),l.length>0&&console.warn(...l)}}_getInvalidityExplanation(){const e=[];if(this.discardedTracks.length===0)e.push("Due to missing tracks, this conversion cannot be executed.");else{const t=this.discardedTracks.every(i=>i.reason==="discarded_by_user"||i.reason==="no_encodable_target_codec");if(e.push("Due to discarded tracks, this conversion cannot be executed."),t){const i=this.discardedTracks.flatMap(a=>a.reason==="discarded_by_user"?[]:a.track.type==="video"?this.output.format.getSupportedVideoCodecs():a.track.type==="audio"?this.output.format.getSupportedAudioCodecs():this.output.format.getSupportedSubtitleCodecs());i.length===1?e.push(`
Tracks were discarded because your environment is not able to encode '${i[0]}'.`):e.push(`
Tracks were discarded because your environment is not able to encode any of the following codecs: ${i.map(a=>`'${a}'`).join(", ")}.`),i.includes("mp3")&&e.push(`
The @mediabunny/mp3-encoder extension package provides support for encoding MP3.`)}else e.push(`
Check the discardedTracks field for more info.`)}return e}async execute(){if(!this.isValid)throw new Error(`Cannot execute this conversion because its output configuration is invalid. Make sure to always check the isValid field before executing a conversion.
`+this._getInvalidityExplanation().join(""));if(this._executed)throw new Error("Conversion cannot be executed twice.");if(this._executed=!0,this.onProgress){this._computeProgress=!0,this._totalDuration=Math.min(await this.input.computeDuration()-this._startTimestamp,this._endTimestamp-this._startTimestamp);for(const e of this.utilizedTracks)this._maxTimestamps.set(e.id,0);this.onProgress?.(0)}await this.output.start(),this._start();try{await Promise.all(this._trackPromises)}catch(e){throw this._canceled||this.cancel(),e}if(this._canceled)throw new Ip;await this.output.finalize(),this._computeProgress&&this.onProgress?.(1)}async cancel(){if(!(this.output.state==="finalizing"||this.output.state==="finalized")){if(this._canceled){console.warn("Conversion already canceled.");return}this._canceled=!0,await this.output.cancel()}}async _processVideoTrack(e,t){const i=e.codec;if(!i){this.discardedTracks.push({track:e,reason:"unknown_source_codec"});return}let a;const n=as(e.rotation+(t.rotate??0)),s=this.output.format.supportsVideoRotationMetadata&&(t.allowRotationMetadata??!0),[o,c]=n%180===0?[e.codedWidth,e.codedHeight]:[e.codedHeight,e.codedWidth],l=t.crop;l&&Dn(l,o,c);const[d,u]=l?[l.width,l.height]:[o,c];let f=d,h=u;const g=f/h,m=T=>Math.ceil(T/2)*2;t.width!==void 0&&t.height===void 0?(f=m(t.width),h=m(Math.round(f/g))):t.width===void 0&&t.height!==void 0?(h=m(t.height),f=m(Math.round(h*g))):t.width!==void 0&&t.height!==void 0&&(f=m(t.width),h=m(t.height));const p=await e.getFirstTimestamp(),v=!!t.forceTranscode||p<this._startTimestamp||!!t.frameRate||t.keyFrameInterval!==void 0||t.process!==void 0;let b=f!==d||h!==u||n!==0&&(!s||t.process!==void 0)||!!l;const w=t.alpha??"discard";let x=this.output.format.getSupportedVideoCodecs();if(!v&&!t.bitrate&&!b&&x.includes(i)&&(!t.codec||t.codec===i)){const T=new xp(i);a=T,this._trackPromises.push((async()=>{await this._started;const A=new wa(e),z={decoderConfig:await e.getDecoderConfig()??void 0},M=Number.isFinite(this._endTimestamp)?await A.getPacket(this._endTimestamp,{metadataOnly:!0})??void 0:void 0;for await(const W of A.packets(void 0,M,{verifyKeyPackets:!0})){if(this._canceled)return;const G=W.clone({timestamp:W.timestamp-this._startTimestamp,sideData:w==="discard"?{}:W.sideData});E(G.timestamp>=0),this._reportProgress(e.id,G.timestamp),await T.add(G,z),this._synchronizer.shouldWait(e.id,G.timestamp)&&await this._synchronizer.wait(G.timestamp)}T.close(),this._synchronizer.closeTrack(e.id)})())}else{if(!await e.canDecode()){this.discardedTracks.push({track:e,reason:"undecodable_source_codec"});return}t.codec&&(x=x.filter(W=>W===t.codec));const A=t.bitrate??rs,B=await yp(x,{width:t.process&&t.processedWidth?t.processedWidth:f,height:t.process&&t.processedHeight?t.processedHeight:h,bitrate:A});if(!B){this.discardedTracks.push({track:e,reason:"no_encodable_target_codec"});return}const z={codec:B,bitrate:A,keyFrameInterval:t.keyFrameInterval,sizeChangeBehavior:t.fit??"passThrough",alpha:w,hardwareAcceleration:t.hardwareAcceleration},M=new Yo(z);if(a=M,!b){const W=new hn({format:new qn,target:new cp}),G=new Yo(z);W.addVideoTrack(G),await W.start();const N=await new Ys(e).getSample(p);if(N)try{await G.add(N),N.close(),await W.finalize()}catch(y){console.info("Error when probing encoder support. Falling back to rerender path.",y),b=!0,W.cancel()}else await W.cancel()}b?this._trackPromises.push((async()=>{await this._started;const G=new Pf(e,{width:f,height:h,fit:t.fit??"fill",rotation:n,crop:t.crop,poolSize:1,alpha:w==="keep"}).canvases(this._startTimestamp,this._endTimestamp),C=t.frameRate;let N=null,y=null,q=null;const ne=async Y=>{E(N),E(C!==void 0);const fe=Math.round((Y-y)*C);for(let ee=1;ee<fe;ee++){const he=new Wt(N,{timestamp:y+ee/C,duration:1/C});await this._registerVideoSample(e,t,M,he),he.close()}};for await(const{canvas:Y,timestamp:fe,duration:ee}of G){if(this._canceled)return;let he=Math.max(fe-this._startTimestamp,0);if(q=he+ee,C!==void 0){const L=Math.floor(he*C)/C;if(N!==null)if(L<=y){N=Y,y=L;continue}else await ne(L);he=L}const K=new Wt(Y,{timestamp:he,duration:C!==void 0?1/C:ee});await this._registerVideoSample(e,t,M,K),K.close(),C!==void 0&&(N=Y,y=he)}N&&(E(q!==null),E(C!==void 0),await ne(Math.floor(q*C)/C)),M.close(),this._synchronizer.closeTrack(e.id)})()):this._trackPromises.push((async()=>{await this._started;const W=new Ys(e),G=t.frameRate;let C=null,N=null,y=null;const q=async ne=>{E(C),E(G!==void 0);const Y=Math.round((ne-N)*G);for(let fe=1;fe<Y;fe++)C.setTimestamp(N+fe/G),C.setDuration(1/G),await this._registerVideoSample(e,t,M,C);C.close()};for await(const ne of W.samples(this._startTimestamp,this._endTimestamp)){if(this._canceled){ne.close(),C?.close();return}let Y=Math.max(ne.timestamp-this._startTimestamp,0);if(y=Y+ne.duration,G!==void 0){const fe=Math.floor(Y*G)/G;if(C!==null)if(fe<=N){C.close(),C=ne,N=fe;continue}else await q(fe);Y=fe,ne.setDuration(1/G)}ne.setTimestamp(Y),await this._registerVideoSample(e,t,M,ne),G!==void 0?(C=ne,N=Y):ne.close()}C&&(E(y!==null),E(G!==void 0),await q(Math.floor(y*G)/G)),M.close(),this._synchronizer.closeTrack(e.id)})())}this.output.addVideoTrack(a,{frameRate:t.frameRate,languageCode:ga(e.languageCode)?e.languageCode:void 0,name:e.name??void 0,disposition:e.disposition,rotation:b?0:n}),this._addedCounts.video++,this._totalTrackCount++,this.utilizedTracks.push(e)}async _registerVideoSample(e,t,i,a){if(this._canceled)return;this._reportProgress(e.id,a.timestamp);let n;if(!t.process)n=[a];else{let s=t.process(a);s instanceof Promise&&(s=await s),Array.isArray(s)||(s=s===null?[]:[s]),n=s.map(o=>o instanceof Wt?o:typeof VideoFrame<"u"&&o instanceof VideoFrame?new Wt(o):new Wt(o,{timestamp:a.timestamp,duration:a.duration}))}for(const s of n){if(this._canceled)break;await i.add(s),this._synchronizer.shouldWait(e.id,s.timestamp)&&await this._synchronizer.wait(s.timestamp)}for(const s of n)s!==a&&s.close()}async _processAudioTrack(e,t){const i=e.codec;if(!i){this.discardedTracks.push({track:e,reason:"unknown_source_codec"});return}let a;const n=e.numberOfChannels,s=e.sampleRate,o=await e.getFirstTimestamp();let c=t.numberOfChannels??n,l=t.sampleRate??s,d=c!==n||l!==s||o<this._startTimestamp,u=this.output.format.getSupportedAudioCodecs();if(!t.forceTranscode&&!t.bitrate&&!d&&u.includes(i)&&(!t.codec||t.codec===i)&&!t.process){const f=new Sp(i);a=f,this._trackPromises.push((async()=>{await this._started;const h=new wa(e),m={decoderConfig:await e.getDecoderConfig()??void 0},p=Number.isFinite(this._endTimestamp)?await h.getPacket(this._endTimestamp,{metadataOnly:!0})??void 0:void 0;for await(const v of h.packets(void 0,p)){if(this._canceled)return;const b=v.clone({timestamp:v.timestamp-this._startTimestamp});E(b.timestamp>=0),this._reportProgress(e.id,b.timestamp),await f.add(b,m),this._synchronizer.shouldWait(e.id,b.timestamp)&&await this._synchronizer.wait(b.timestamp)}f.close(),this._synchronizer.closeTrack(e.id)})())}else{if(!await e.canDecode()){this.discardedTracks.push({track:e,reason:"undecodable_source_codec"});return}let h=null;t.codec&&(u=u.filter(p=>p===t.codec));const g=t.bitrate??rs,m=await Zo(u,{numberOfChannels:t.process&&t.processedNumberOfChannels?t.processedNumberOfChannels:c,sampleRate:t.process&&t.processedSampleRate?t.processedSampleRate:l,bitrate:g});if(!m.some(p=>Oi.includes(p))&&u.some(p=>Oi.includes(p))&&(c!==Rs||l!==Ds)){const v=(await Zo(u,{numberOfChannels:Rs,sampleRate:Ds,bitrate:g})).find(b=>Oi.includes(b));v&&(d=!0,h=v,c=Rs,l=Ds)}else h=m[0]??null;if(h===null){this.discardedTracks.push({track:e,reason:"no_encodable_target_codec"});return}if(d)a=this._resampleAudio(e,t,h,c,l,g);else{const p=new Jo({codec:h,bitrate:g});a=p,this._trackPromises.push((async()=>{await this._started;const v=new Ro(e);for await(const b of v.samples(void 0,this._endTimestamp)){if(this._canceled){b.close();return}b.setTimestamp(b.timestamp-this._startTimestamp),await this._registerAudioSample(e,t,p,b),b.close()}p.close(),this._synchronizer.closeTrack(e.id)})())}}this.output.addAudioTrack(a,{languageCode:ga(e.languageCode)?e.languageCode:void 0,name:e.name??void 0,disposition:e.disposition}),this._addedCounts.audio++,this._totalTrackCount++,this.utilizedTracks.push(e)}async _registerAudioSample(e,t,i,a){if(this._canceled)return;this._reportProgress(e.id,a.timestamp);let n;if(!t.process)n=[a];else{let s=t.process(a);if(s instanceof Promise&&(s=await s),Array.isArray(s)||(s=s===null?[]:[s]),!s.every(o=>o instanceof cr))throw new TypeError("The audio process function must return an AudioSample, null, or an array of AudioSamples.");n=s}for(const s of n){if(this._canceled)break;await i.add(s),this._synchronizer.shouldWait(e.id,s.timestamp)&&await this._synchronizer.wait(s.timestamp)}for(const s of n)s!==a&&s.close()}_resampleAudio(e,t,i,a,n,s){const o=new Jo({codec:i,bitrate:s});return this._trackPromises.push((async()=>{await this._started;const c=new Fp({targetNumberOfChannels:a,targetSampleRate:n,startTime:this._startTimestamp,endTime:this._endTimestamp,onSample:async u=>{await this._registerAudioSample(e,t,o,u),u.close()}}),d=new Ro(e).samples(this._startTimestamp,this._endTimestamp);for await(const u of d){if(this._canceled){u.close();return}await c.add(u),u.close()}await c.finalize(),o.close(),this._synchronizer.closeTrack(e.id)})()),o}_reportProgress(e,t){if(!this._computeProgress)return;E(this._totalDuration!==null),this._maxTimestamps.set(e,Math.max(t,this._maxTimestamps.get(e)));const i=Math.min(...this._maxTimestamps.values()),a=Mt(i/this._totalDuration,0,1);a!==this._lastProgress&&(this._lastProgress=a,this.onProgress?.(a))}}class Ip extends Error{constructor(e="Conversion has been canceled."){super(e),this.name="ConversionCanceledError"}}const rc=5;class Ap{constructor(){this.maxTimestamps=new Map,this.resolvers=[]}computeMinAndMaybeResolve(){let e=1/0;for(const[,t]of this.maxTimestamps)e=Math.min(e,t);for(let t=0;t<this.resolvers.length;t++){const i=this.resolvers[t];i.timestamp-e<rc&&(i.resolve(),this.resolvers.splice(t,1),t--)}return e}shouldWait(e,t){this.maxTimestamps.set(e,Math.max(t,this.maxTimestamps.get(e)??-1/0));const i=this.computeMinAndMaybeResolve();return t-i>=rc}wait(e){const{promise:t,resolve:i}=Rt();return this.resolvers.push({timestamp:e,resolve:i}),t}closeTrack(e){this.maxTimestamps.delete(e),this.computeMinAndMaybeResolve()}}class Fp{constructor(e){this.sourceSampleRate=null,this.sourceNumberOfChannels=null,this.targetSampleRate=e.targetSampleRate,this.targetNumberOfChannels=e.targetNumberOfChannels,this.startTime=e.startTime,this.endTime=e.endTime,this.onSample=e.onSample,this.bufferSizeInFrames=Math.floor(this.targetSampleRate*5),this.bufferSizeInSamples=this.bufferSizeInFrames*this.targetNumberOfChannels,this.outputBuffer=new Float32Array(this.bufferSizeInSamples),this.bufferStartFrame=0,this.maxWrittenFrame=-1}doChannelMixerSetup(){E(this.sourceNumberOfChannels!==null);const e=this.sourceNumberOfChannels,t=this.targetNumberOfChannels;e===1&&t===2?this.channelMixer=(i,a)=>i[a*e]:e===1&&t===4?this.channelMixer=(i,a,n)=>i[a*e]*+(n<2):e===1&&t===6?this.channelMixer=(i,a,n)=>i[a*e]*+(n===2):e===2&&t===1?this.channelMixer=(i,a)=>{const n=a*e;return .5*(i[n]+i[n+1])}:e===2&&t===4?this.channelMixer=(i,a,n)=>i[a*e+n]*+(n<2):e===2&&t===6?this.channelMixer=(i,a,n)=>i[a*e+n]*+(n<2):e===4&&t===1?this.channelMixer=(i,a)=>{const n=a*e;return .25*(i[n]+i[n+1]+i[n+2]+i[n+3])}:e===4&&t===2?this.channelMixer=(i,a,n)=>{const s=a*e;return .5*(i[s+n]+i[s+n+2])}:e===4&&t===6?this.channelMixer=(i,a,n)=>{const s=a*e;return n<2?i[s+n]:n===2||n===3?0:i[s+n-2]}:e===6&&t===1?this.channelMixer=(i,a)=>{const n=a*e;return Math.SQRT1_2*(i[n]+i[n+1])+i[n+2]+.5*(i[n+4]+i[n+5])}:e===6&&t===2?this.channelMixer=(i,a,n)=>{const s=a*e;return i[s+n]+Math.SQRT1_2*(i[s+2]+i[s+n+4])}:e===6&&t===4?this.channelMixer=(i,a,n)=>{const s=a*e;return n<2?i[s+n]+Math.SQRT1_2*i[s+2]:i[s+n+2]}:this.channelMixer=(i,a,n)=>n<e?i[a*e+n]:0}ensureTempBufferSize(e){let t=this.tempSourceBuffer.length;for(;t<e;)t*=2;if(t!==this.tempSourceBuffer.length){const i=new Float32Array(t);i.set(this.tempSourceBuffer),this.tempSourceBuffer=i}}async add(e){this.sourceSampleRate===null&&(this.sourceSampleRate=e.sampleRate,this.sourceNumberOfChannels=e.numberOfChannels,this.tempSourceBuffer=new Float32Array(this.sourceSampleRate*this.sourceNumberOfChannels),this.doChannelMixerSetup());const t=e.numberOfFrames*e.numberOfChannels;this.ensureTempBufferSize(t);const i=e.allocationSize({planeIndex:0,format:"f32"}),a=new Float32Array(this.tempSourceBuffer.buffer,0,i/4);e.copyTo(a,{planeIndex:0,format:"f32"});const n=e.timestamp-this.startTime,s=e.numberOfFrames/this.sourceSampleRate,o=Math.min(n+s,this.endTime-this.startTime),c=Math.floor(n*this.targetSampleRate),l=Math.ceil(o*this.targetSampleRate);for(let d=c;d<l;d++){if(d<this.bufferStartFrame)continue;for(;d>=this.bufferStartFrame+this.bufferSizeInFrames;)await this.finalizeCurrentBuffer(),this.bufferStartFrame+=this.bufferSizeInFrames;const u=d-this.bufferStartFrame;E(u<this.bufferSizeInFrames);const g=(d/this.targetSampleRate-n)*this.sourceSampleRate,m=Math.floor(g),p=Math.ceil(g),v=g-m;for(let b=0;b<this.targetNumberOfChannels;b++){let w=0,x=0;m>=0&&m<e.numberOfFrames&&(w=this.channelMixer(a,m,b)),p>=0&&p<e.numberOfFrames&&(x=this.channelMixer(a,p,b));const T=w+v*(x-w),A=u*this.targetNumberOfChannels+b;this.outputBuffer[A]+=T}this.maxWrittenFrame=Math.max(this.maxWrittenFrame,u)}}async finalizeCurrentBuffer(){if(this.maxWrittenFrame<0)return;const e=(this.maxWrittenFrame+1)*this.targetNumberOfChannels,t=new Float32Array(e);t.set(this.outputBuffer.subarray(0,e));const i=this.bufferStartFrame/this.targetSampleRate,a=new cr({format:"f32",sampleRate:this.targetSampleRate,numberOfChannels:this.targetNumberOfChannels,timestamp:i,data:t});await this.onSample(a),this.outputBuffer.fill(0),this.maxWrittenFrame=-1}finalize(){return this.finalizeCurrentBuffer()}}const Bp={tiny:bp,web:wp,social:Kn,high:rs,lossless:kp};function Ml(){return typeof VideoEncoder<"u"&&typeof VideoDecoder<"u"&&typeof AudioEncoder<"u"&&typeof AudioDecoder<"u"}async function zp(){if(!Ml())return{supported:!1,hardwareAcceleration:!1,supportedVideoCodecs:[],supportedAudioCodecs:[],maxResolution:{width:0,height:0}};const r=[],e=[];let t=!1;const i=[{codec:"avc",mediabunnyCodec:"avc"},{codec:"vp9",mediabunnyCodec:"vp9"},{codec:"av1",mediabunnyCodec:"av1"},{codec:"hevc",mediabunnyCodec:"hevc"}];for(const c of i)try{if(c.codec==="av1"||c.codec==="hevc")try{if((await VideoEncoder.isConfigSupported({codec:Os(c.codec),width:1920,height:1080,bitrate:5e6,framerate:30,hardwareAcceleration:"prefer-hardware"})).supported)try{const u=new VideoEncoder({output:()=>{},error:()=>{}});await u.configure({codec:Os(c.codec),width:640,height:480,bitrate:1e6,framerate:30,hardwareAcceleration:"prefer-hardware"});const f=u.encodeQueueSize!==void 0;u.close(),f&&(r.push(c.codec),t=!0)}catch{console.log(`${c.codec.toUpperCase()} hardware encoder not available`)}}catch{}else if(await fn(c.mediabunnyCodec,{width:1920,height:1080,bitrate:Kn})){r.push(c.codec);try{const u=await VideoEncoder.isConfigSupported({codec:Os(c.codec),width:1920,height:1080,bitrate:5e6,framerate:30,hardwareAcceleration:"prefer-hardware"});u.supported&&u.config?.hardwareAcceleration==="prefer-hardware"&&(t=!0)}catch{}}}catch{}const a=[{codec:"aac",mediabunnyCodec:"aac"},{codec:"opus",mediabunnyCodec:"opus"}];for(const c of a)try{await zl(c.mediabunnyCodec,{sampleRate:48e3,numberOfChannels:2,bitrate:128e3})&&e.push(c.codec)}catch{}let n=1920,s=1080;const o=[{width:3840,height:2160},{width:2560,height:1440},{width:1920,height:1080}];for(const c of o)try{if(await fn("avc",{width:c.width,height:c.height,bitrate:rs})){n=c.width,s=c.height;break}}catch{}return{supported:r.length>0,hardwareAcceleration:t,supportedVideoCodecs:r,supportedAudioCodecs:e,maxResolution:{width:n,height:s}}}function Os(r){switch(r){case"avc":return"avc1.640028";case"vp9":return"vp09.00.40.08";case"av1":return"av01.0.08M.08";case"hevc":return"hev1.1.6.L93.B0";default:return"avc1.640028"}}async function Mp(r,e,t,i="web",a=!1,n){const s=performance.now();let o=0,c=0;try{n?.({stage:"decoding",progress:0,framesProcessed:0,totalFrames:0,fps:0});const l=new hl({source:new jh(r),formats:Hh}),u=(await l.getVideoTracks())[0],f=await l.computeDuration();let h=30;if(u){try{const C=await u.computePacketStats(100);C.averagePacketRate>0&&(h=C.averagePacketRate)}catch{}c=Math.ceil(f*h)}const g=t==="mp4"?new qn({fastStart:"in-memory"}):new ln,m=new El,p=new hn({format:g,target:m}),v=Bp[i]||Kn,b=e.videoCodec,w=e.audioCodec,x=e.trimStart??0,T=e.trimEnd??f,A=T-x;A!==f&&(c=Math.ceil(A*h));const B=await Zn.init({input:l,output:p,video:{codec:b,bitrate:v,keyFrameInterval:2,fit:"contain",hardwareAcceleration:"prefer-hardware",width:e.width,height:e.height,forceTranscode:!0},audio:{codec:w,bitrate:e.audioBitrate||128e3,sampleRate:e.sampleRate||48e3,numberOfChannels:e.channels||2},trim:{start:x,end:T},tags:a?{}:void 0,showWarnings:!1});let z=performance.now(),M=0;B.onProgress=C=>{const N=performance.now(),y=Math.round(C*c)-M,q=(N-z)/1e3,ne=q>0?y/q:0;o=Math.round(C*c),M=o,z=N,n?.({stage:C<.95?"encoding":"muxing",progress:Math.round(C*100),framesProcessed:o,totalFrames:c,fps:Math.round(ne)})},await B.execute();const W=m.buffer;if(!W)throw new Error("Output buffer is null - conversion may have failed");n?.({stage:"complete",progress:100,framesProcessed:c,totalFrames:c,fps:c/((performance.now()-s)/1e3)});const G=t==="mp4"?"video/mp4":"video/webm";return new Blob([W],{type:G})}catch(l){throw console.error("WebCodecs encoding error:",l),new Error(`WebCodecs encoding failed: ${l instanceof Error?l.message:"Unknown error"}`)}}function Rl(r){return r==="webm"?{video:"vp9",audio:"opus"}:r==="av1"?{video:"av1",audio:"aac"}:r==="hevc"?{video:"hevc",audio:"aac"}:{video:"avc",audio:"aac"}}let _i=null,na=!1;const Ti=[];async function Ca(){return _i||(_i=await zp(),console.log("WebCodecs capabilities:",_i),_i)}function ic(){return _i}function Rp(){return Ml()?{supported:!0}:{supported:!1,reason:"Your browser does not support WebCodecs. Please use Chrome, Edge, or Safari 16.4+."}}async function Dp(r){Ti.push(...r),na||Op()}async function Op(){if(Ti.length===0){na=!1;return}if(na=!0,!(await Ca()).supported){for(;Ti.length>0;){const e=Ti.shift();le.updateItem(e,{status:"error",error:"WebCodecs not supported in this browser. Please use Chrome, Edge, or Safari 16.4+."})}na=!1;return}for(;Ti.length>0;){const e=Ti.shift(),t=le.getItemById(e);t&&t.status==="pending"&&await Yn(t)}na=!1}async function Yn(r){try{le.updateItem(r.id,{status:"processing",progress:0,progressStage:"Initializing hardware encoder...",eta:gu(r,le.settings)});const e=await Ca(),t=r.outputFormat,{video:i}=Rl(t);if(!e.supportedVideoCodecs.includes(i))throw new Error(`${i.toUpperCase()} codec not supported by your hardware. Try a different output format.`);const a=e.hardwareAcceleration?" (GPU)":"";le.updateItem(r.id,{progressStage:`Encoding with ${i.toUpperCase()}${a}...`});const n=await Np(r),s=URL.createObjectURL(n.blob);le.updateItem(r.id,{status:"completed",progress:100,progressStage:"Complete",compressedSize:n.blob.size,compressedUrl:s,compressedBlob:n.blob,compressionDuration:n.duration,eta:void 0})}catch(e){console.error("Compression error:",e),le.updateItem(r.id,{status:"error",error:e instanceof Error?e.message:"Compression failed",progressStage:void 0,eta:void 0})}}async function Np(r){const e=Date.now(),t=le.settings.quality,i=r.outputFormat;let n={tiny:5e5,web:15e5,social:3e6,high:6e6,lossless:2e7}[t]||2e6;le.settings.targetSizeMB&&(n=mu(r,le.settings.targetSizeMB,le.settings));const s={original:{width:r.width||1920,height:r.height||1080},"2160p":{width:3840,height:2160},"1440p":{width:2560,height:1440},"1080p":{width:1920,height:1080},"720p":{width:1280,height:720},"480p":{width:854,height:480},"360p":{width:640,height:360}},o=s[le.settings.resolution]||s.original,{video:c,audio:l}=Rl(i),d={"64k":64e3,"128k":128e3,"192k":192e3,"256k":256e3,"320k":32e4},u=i==="av1"||i==="hevc"?"mp4":i;return{blob:await Mp(r.file,{videoCodec:c,audioCodec:l,width:o.width,height:o.height,bitrate:n,framerate:30,audioBitrate:d[le.settings.audioBitrate]||128e3,sampleRate:48e3,channels:2,trimStart:r.trimStart,trimEnd:r.trimEnd},u,t,le.settings.stripMetadata,h=>{le.updateItem(r.id,{progress:h.progress,progressStage:`${h.stage} (${h.framesProcessed}/${h.totalFrames} frames)`,eta:h.fps>0?Math.round((h.totalFrames-h.framesProcessed)/h.fps):void 0})}),duration:Date.now()-e}}function Up(r){return r==="av1"||r==="hevc"?".mp4":`.${r}`}function Jn(r,e){return`${r.replace(/\.[^/.]+$/,"")}-compressed${Up(e)}`}async function ac(r){const e=le.getItemById(r);if(!e)return;e.compressedUrl&&URL.revokeObjectURL(e.compressedUrl),e.previewUrl&&URL.revokeObjectURL(e.previewUrl),le.updateItem(r,{status:"pending",progress:0,progressStage:void 0,compressedSize:void 0,compressedUrl:void 0,compressedBlob:void 0,previewUrl:void 0,eta:void 0,error:void 0});const t=le.getItemById(r);t&&await Yn(t)}async function Vp(){const r=le.items.filter(e=>e.status==="completed");if(r.length!==0){for(const e of r)e.compressedUrl&&URL.revokeObjectURL(e.compressedUrl),e.previewUrl&&URL.revokeObjectURL(e.previewUrl),le.updateItem(e.id,{outputFormat:le.settings.outputFormat,status:"pending",progress:0,progressStage:void 0,compressedSize:void 0,compressedUrl:void 0,compressedBlob:void 0,previewUrl:void 0,eta:void 0});for(const e of r){const t=le.getItemById(e.id);t&&t.status==="pending"&&await Yn(t)}}}async function Lp(){const r=await Ca();return{hardwareConcurrency:navigator.hardwareConcurrency||4,deviceMemory:navigator.deviceMemory||4,webCodecs:r}}async function $p(){try{return await Ca(),!0}catch{return!1}}function Wp(r){if(!r.compressedBlob)return;const e=Jn(r.name,r.outputFormat),t=URL.createObjectURL(r.compressedBlob),i=document.createElement("a");i.href=t,i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(t)}async function Hp(r){const e=new Iu;for(const n of r)if(n.compressedBlob){const s=Jn(n.name,n.outputFormat);e.file(s,n.compressedBlob)}const t=await e.generateAsync({type:"blob"}),i=URL.createObjectURL(t),a=document.createElement("a");a.href=i,a.download=`squash-videos-${Date.now()}.zip`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i)}function mn(r){if(r===0)return"0 B";const e=1024,t=["B","KB","MB","GB"],i=Math.floor(Math.log(r)/Math.log(e));return parseFloat((r/Math.pow(e,i)).toFixed(i>1?2:1))+" "+t[i]}const jp=["button:not([disabled])","[href]","input:not([disabled])","select:not([disabled])","textarea:not([disabled])",'[tabindex]:not([tabindex="-1"])','[contenteditable="true"]'].join(", ");let si=null;function Dl(r){return Array.from(r.querySelectorAll(jp)).filter(e=>e.offsetParent!==null)}function qp(r,e){if(r.key!=="Tab")return;const t=Dl(e);if(t.length===0)return;const i=t[0],a=t[t.length-1];r.shiftKey?document.activeElement===i&&(r.preventDefault(),a.focus()):document.activeElement===a&&(r.preventDefault(),i.focus())}function Kp(r){const e=document.activeElement,t=a=>qp(a,r);si={container:r,previouslyFocused:e,handleKeyDown:t},document.body.classList.add("modal-open"),document.addEventListener("keydown",t);const i=Dl(r);i.length>0&&requestAnimationFrame(()=>{i[0].focus()})}function Gp(){si&&(document.removeEventListener("keydown",si.handleKeyDown),document.body.classList.remove("modal-open"),si.previouslyFocused&&typeof si.previouslyFocused.focus=="function"&&si.previouslyFocused.focus(),si=null)}function eo(r){return Kp(r),Gp}function Ns(r){const e=Math.floor(r/60),t=Math.floor(r%60);return`${e}:${t.toString().padStart(2,"0")}`}function Bi(r){const e=Math.floor(r/60),t=Math.floor(r%60);return`${e}:${t.toString().padStart(2,"0")}`}var Qp=te('<div class="fixed inset-0 z-50 flex items-center justify-center bg-black/95 p-4" role="dialog" aria-modal="true" aria-label="Video comparison"><button class="absolute right-4 top-4 z-20 rounded-full bg-white/10 p-3 text-white backdrop-blur-sm transition-colors hover:bg-white/20" aria-label="Close comparison"><!></button> <div class="absolute left-4 top-4 z-20 flex items-center gap-4"><div class="bg-surface-800/90 rounded-xl px-4 py-2 backdrop-blur-sm"><div class="text-surface-400 text-xs uppercase tracking-wide">Original</div> <div class="text-lg font-bold text-white"> </div></div> <div class="from-accent-start to-accent-end rounded-xl bg-gradient-to-r px-4 py-2 shadow-lg"><div class="text-xs uppercase tracking-wide text-white/80">Compressed</div> <div class="text-lg font-bold text-white"> <span class="ml-2 text-sm font-normal"> </span></div></div></div> <div class="relative max-h-[80vh] max-w-[95vw] select-none overflow-hidden rounded-2xl shadow-2xl" role="slider" aria-label="Comparison slider" tabindex="0"><div class="relative"><video class="block max-h-[80vh] max-w-[95vw]" loop autoplay playsinline=""></video> <div class="absolute bottom-4 left-4 rounded-lg bg-black/70 px-3 py-1.5 text-sm font-medium text-white">Original</div></div> <div class="absolute inset-0 overflow-hidden"><video class="block max-h-[80vh] max-w-[95vw]" loop autoplay playsinline=""></video> <div class="from-accent-start to-accent-end absolute bottom-4 right-4 rounded-lg bg-gradient-to-r px-3 py-1.5 text-sm font-bold text-white shadow-lg">Compressed</div></div> <div class="absolute bottom-0 top-0 z-10 w-1 cursor-ew-resize transition-transform"><div class="absolute inset-0 bg-white shadow-lg"></div> <div><!> <!></div></div></div> <div class="absolute bottom-4 left-1/2 -translate-x-1/2 text-center"><p class="text-surface-400 text-sm">Drag slider to compare â€¢ Press <kbd class="bg-surface-800 rounded px-2 py-0.5">â†</kbd> <kbd class="bg-surface-800 rounded px-2 py-0.5">â†’</kbd> to adjust â€¢ <kbd class="bg-surface-800 rounded px-2 py-0.5">Esc</kbd> to close</p></div></div>',2);function Xp(r,e){Xt(e,!0);let t=We(50),i=We(!1),a,n=We(void 0);qi(()=>{if(_(n))return eo(_(n))});const s=Ge(()=>Math.round((1-e.compressedSize/e.originalSize)*100));function o(L){if(L===0)return"0 B";const be=1024,ce=["B","KB","MB","GB"],j=Math.floor(Math.log(L)/Math.log(be));return parseFloat((L/Math.pow(be,j)).toFixed(1))+" "+ce[j]}function c(L){se(i,!0),g(L)}function l(L){_(i)&&g(L)}function d(){se(i,!1)}function u(L){se(i,!0),m(L)}function f(L){_(i)&&(L.preventDefault(),m(L))}function h(){se(i,!1)}function g(L){if(!a)return;const be=a.getBoundingClientRect(),ce=L.clientX-be.left,j=Math.max(0,Math.min(100,ce/be.width*100));se(t,j,!0)}function m(L){if(!a||!L.touches[0])return;const be=a.getBoundingClientRect(),ce=L.touches[0].clientX-be.left,j=Math.max(0,Math.min(100,ce/be.width*100));se(t,j,!0)}function p(L){L.key==="Escape"?e.onclose():L.key==="ArrowLeft"?se(t,Math.max(0,_(t)-5),!0):L.key==="ArrowRight"&&se(t,Math.min(100,_(t)+5),!0)}var v=Qp();St("keydown",ca,p),St("mouseup",ca,d),St("mousemove",ca,l);var b=I(v);b.__click=function(...L){e.onclose?.apply(this,L)};var w=I(b);_r(w,{class:"h-6 w-6"}),P(b);var x=O(b,2),T=I(x),A=O(I(T),2),B=I(A,!0);P(A),P(T);var z=O(T,2),M=O(I(z),2),W=I(M),G=O(W),C=I(G);P(G),P(M),P(z),P(x);var N=O(x,2);N.__mousedown=c,N.__touchstart=u,N.__touchmove=f,N.__touchend=h,pt(N,"aria-valuemin",0),pt(N,"aria-valuemax",100);var y=I(N),q=I(y);q.muted=!0,Ie(2),P(y);var ne=O(y,2),Y=I(ne);Y.muted=!0,Ie(2),P(ne);var fe=O(ne,2),ee=O(I(fe),2),he=I(ee);zd(he,{class:"text-surface-600 -mr-1 h-5 w-5"});var K=O(he,2);Md(K,{class:"text-surface-600 -ml-1 h-5 w-5"}),P(ee),P(fe),P(N),Vi(N,L=>a=L,()=>a),Ie(2),P(v),Vi(v,L=>se(n,L),()=>_(n)),Te((L,be,ce)=>{ke(B,L),ke(W,`${be??""} `),ke(C,`(-${_(s)??""}%)`),pt(N,"aria-valuenow",ce),pt(q,"src",e.originalUrl),kr(ne,`clip-path: inset(0 0 0 ${_(t)??""}%)`),pt(Y,"src",e.compressedUrl),kr(fe,`left: ${_(t)??""}%; transform: translateX(-50%)`),at(ee,1,`absolute left-1/2 top-1/2 flex h-12 w-12 -translate-x-1/2 -translate-y-1/2 items-center justify-center rounded-full bg-white shadow-xl transition-transform ${_(i)?"scale-110":"hover:scale-105"}`)},[()=>o(e.originalSize),()=>o(e.compressedSize),()=>Math.round(_(t))]),ut(3,v,()=>Qt,()=>({duration:200})),$(r,v),Zt()}Ht(["click","mousedown","touchstart","touchmove","touchend"]);var Zp=te('<img alt="" class="h-full flex-1 object-cover opacity-40"/>'),Yp=te('<div class="absolute inset-0 flex"></div>'),Jp=te('<div class="absolute inset-0 flex items-center justify-center"><div class="border-surface-600 border-t-accent-start h-4 w-4 animate-spin rounded-full border-2"></div></div>'),eg=te('<div class="bg-surface-700 text-surface-200 absolute -top-8 z-20 -translate-x-1/2 transform whitespace-nowrap rounded px-2 py-1 text-xs"> </div>'),tg=te('<div class="select-none"><div class="bg-surface-800 relative h-14 cursor-crosshair overflow-hidden rounded-lg" role="slider" aria-label="Trim timeline" tabindex="0"><!> <div class="absolute bottom-0 left-0 top-0 bg-black/60"></div> <div class="absolute bottom-0 right-0 top-0 bg-black/60"></div> <div class="absolute bottom-0 top-0 border-y-2 border-purple-500/70"></div> <div role="slider" aria-label="Trim start" tabindex="0"><div class="h-6 w-0.5 rounded-full bg-white/80"></div></div> <div role="slider" aria-label="Trim end" tabindex="0"><div class="h-6 w-0.5 rounded-full bg-white/80"></div></div> <!></div> <div class="mt-2 flex items-center justify-between text-xs"><div class="flex items-center gap-2"><span class="text-surface-500">Start:</span> <span class="font-mono text-purple-400"> </span></div> <div class="flex items-center gap-1.5 rounded-lg bg-purple-500/20 px-2 py-1"><span class="text-surface-400">Duration:</span> <span class="font-mono font-semibold text-purple-400"> </span></div> <div class="flex items-center gap-2"><span class="text-surface-500">End:</span> <span class="font-mono text-purple-400"> </span></div></div></div>');function rg(r,e){Xt(e,!0);let t=We(void 0),i=We(Mi([])),a=We(!1),n=We(!1),s=We(null),o=We(0),c=We(!0),l=We(Mi(e.trimStart)),d=We(Mi(e.trimEnd));qi(()=>{!_(a)&&!_(n)&&(se(l,e.trimStart,!0),se(d,e.trimEnd,!0))}),xa(async()=>{try{const ie=document.createElement("video");ie.src=e.videoUrl,ie.crossOrigin="anonymous",ie.muted=!0,await new Promise((Be,st)=>{ie.onloadedmetadata=()=>Be(),ie.onerror=()=>st(new Error("Failed to load video")),setTimeout(()=>st(new Error("Video load timeout")),5e3)});const me=document.createElement("canvas"),ge=me.getContext("2d"),xe=Math.min(8,Math.max(4,Math.ceil(e.duration/5))),Re=[];me.width=160,me.height=90;for(let Be=0;Be<xe;Be++){const st=e.duration/xe*Be+e.duration/xe/2;ie.currentTime=st,await new Promise(ct=>{ie.onseeked=()=>ct(),setTimeout(ct,500)}),ge.drawImage(ie,0,0,me.width,me.height),Re.push(me.toDataURL("image/jpeg",.5))}se(i,Re,!0)}catch(ie){console.warn("Could not generate thumbnails:",ie)}finally{se(c,!1)}});function u(ie,me){ie.preventDefault(),ie.stopPropagation(),me==="start"?se(a,!0):se(n,!0),window.addEventListener("mousemove",f),window.addEventListener("mouseup",h)}function f(ie){if(!_(t))return;const me=_(t).getBoundingClientRect(),Re=Math.max(0,Math.min(me.width,ie.clientX-me.left))/me.width*e.duration;if(_(a)){const Be=_(d)-.5;se(l,Math.max(0,Math.min(Re,Be)),!0)}else if(_(n)){const Be=_(l)+.5;se(d,Math.max(Be,Math.min(Re,e.duration)),!0)}}function h(){(_(a)||_(n))&&e.onchange(_(l),_(d)),se(a,!1),se(n,!1),window.removeEventListener("mousemove",f),window.removeEventListener("mouseup",h)}function g(ie){if(!_(t)||_(a)||_(n))return;const me=_(t).getBoundingClientRect(),ge=ie.clientX-me.left,xe=Math.max(0,Math.min(1,ge/me.width));se(s,xe*e.duration),se(o,ge)}function m(){se(s,null)}function p(ie){const me=ie.shiftKey?1:.1;if(ie.key==="ArrowLeft"){if(ie.preventDefault(),ie.target===document.activeElement){const ge=Math.max(0,_(l)-me);ge<_(d)-.5&&(se(l,ge,!0),e.onchange(_(l),_(d)))}}else if(ie.key==="ArrowRight"&&(ie.preventDefault(),ie.target===document.activeElement)){const ge=Math.min(e.duration,_(d)+me);ge>_(l)+.5&&(se(d,ge,!0),e.onchange(_(l),_(d)))}}const v=Ge(()=>_(l)/e.duration*100),b=Ge(()=>_(d)/e.duration*100),w=Ge(()=>_(d)-_(l));var x=tg(),T=I(x);T.__mousemove=g,pt(T,"aria-valuemin",0),T.__keydown=p;var A=I(T);{var B=ie=>{var me=Yp();_t(me,21,()=>_(i),Ct,(ge,xe)=>{var Re=Zp();Te(()=>pt(Re,"src",_(xe))),$(ge,Re)}),P(me),$(ie,me)},z=ie=>{var me=_e(),ge=pe(me);{var xe=Re=>{var Be=Jp();$(Re,Be)};oe(ge,Re=>{_(c)&&Re(xe)},!0)}$(ie,me)};oe(A,ie=>{_(i).length>0?ie(B):ie(z,!1)})}var M=O(A,2),W=O(M,2),G=O(W,2),C=O(G,2);C.__mousedown=ie=>u(ie,"start");var N=O(C,2);N.__mousedown=ie=>u(ie,"end");var y=O(N,2);{var q=ie=>{var me=eg(),ge=I(me,!0);P(me),Te(xe=>{kr(me,`left: ${_(o)??""}px`),ke(ge,xe)},[()=>Bi(_(s))]),$(ie,me)};oe(y,ie=>{_(s)!==null&&!_(a)&&!_(n)&&ie(q)})}P(T),Vi(T,ie=>se(t,ie),()=>_(t));var ne=O(T,2),Y=I(ne),fe=O(I(Y),2),ee=I(fe,!0);P(fe),P(Y);var he=O(Y,2),K=O(I(he),2),L=I(K,!0);P(K),P(he);var be=O(he,2),ce=O(I(be),2),j=I(ce,!0);P(ce),P(be),P(ne),P(x),Te((ie,me,ge,xe,Re,Be,st)=>{pt(T,"aria-valuenow",ie),pt(T,"aria-valuemax",me),kr(M,`width: ${_(v)??""}%`),kr(W,`width: ${100-_(b)}%`),kr(G,`left: ${_(v)??""}%; right: ${100-_(b)}%`),at(C,1,`absolute bottom-0 top-0 z-10 flex w-3 cursor-ew-resize items-center justify-center bg-purple-500 transition-all ${_(a)?"ring-2 ring-purple-300":"hover:bg-purple-400"}`),kr(C,`left: ${_(v)??""}%; transform: translateX(-50%)`),pt(C,"aria-valuenow",ge),at(N,1,`absolute bottom-0 top-0 z-10 flex w-3 cursor-ew-resize items-center justify-center bg-purple-500 transition-all ${_(n)?"ring-2 ring-purple-300":"hover:bg-purple-400"}`),kr(N,`left: ${_(b)??""}%; transform: translateX(-50%)`),pt(N,"aria-valuenow",xe),ke(ee,Re),ke(L,Be),ke(j,st)},[()=>Math.round(_(w)),()=>Math.round(e.duration),()=>Math.round(_(l)*10)/10,()=>Math.round(_(d)*10)/10,()=>Bi(_(l)),()=>Bi(_(w)),()=>Bi(_(d))]),St("mouseleave",T,m),$(r,x),Zt()}Ht(["mousemove","keydown","mousedown"]);let ji=We(Mi([]));function Us(r,e="info",t={}){const i=`toast_${Date.now()}_${Math.random().toString(36).slice(2,9)}`,a=t.duration??3e3;return se(ji,[..._(ji),{id:i,message:r,type:e,duration:a,action:t.action}],!0),a>0&&setTimeout(()=>{pn(i)},a),i}function pn(r){se(ji,_(ji).filter(e=>e.id!==r),!0)}const Ua={success:(r,e)=>Us(r,"success",typeof e=="number"?{duration:e}:e),error:(r,e)=>Us(r,"error",{duration:5e3,...typeof e=="number"?{duration:e}:e}),info:(r,e)=>Us(r,"info",typeof e=="number"?{duration:e}:e)};var ig=te('<button class="text-accent-start bg-accent-start/20 hover:bg-accent-start/30 flex-shrink-0 rounded-lg px-3 py-1 text-sm font-semibold transition-colors"> </button>'),ag=te('<div role="alert"><!> <p class="text-surface-100 flex-1 text-sm font-medium"> </p> <!> <button class="text-surface-400 hover:bg-surface-700 hover:text-surface-300 flex-shrink-0 rounded-lg p-1 transition-colors" aria-label="Dismiss notification"><!></button></div>'),sg=te('<div class="fixed bottom-4 right-4 z-[100] flex max-w-sm flex-col gap-2" role="region" aria-label="Notifications" aria-live="polite"></div>');function ng(r,e){Xt(e,!0);const t={success:la,error:bc,info:bn},i={success:"bg-green-500/10 border-green-500/30 text-green-500",error:"bg-red-500/10 border-red-500/30 text-red-500",info:"bg-accent-start/10 border-accent-start/30 text-accent-start"};var a=_e(),n=pe(a);{var s=o=>{var c=sg();_t(c,21,()=>_(ji),l=>l.id,(l,d)=>{var u=ag(),f=I(u);vn(f,()=>t[_(d).type],(w,x)=>{x(w,{class:"h-5 w-5 flex-shrink-0"})});var h=O(f,2),g=I(h,!0);P(h);var m=O(h,2);{var p=w=>{var x=ig();x.__click=()=>{_(d).action?.onClick(),pn(_(d).id)};var T=I(x,!0);P(x),Te(()=>ke(T,_(d).action.label)),$(w,x)};oe(m,w=>{_(d).action&&w(p)})}var v=O(m,2);v.__click=()=>pn(_(d).id);var b=I(v);_r(b,{class:"h-4 w-4"}),P(v),P(u),Te(()=>{at(u,1,`glass flex items-center gap-3 rounded-xl border px-4 py-3 shadow-lg ${i[_(d).type]??""}`),ke(g,_(d).message)}),ut(1,u,()=>Tc,()=>({x:100,duration:200})),ut(2,u,()=>Qt,()=>({duration:150})),$(l,u)}),P(c),$(o,c)};oe(n,o=>{_(ji).length>0&&o(s)})}$(r,a),Zt()}Ht(["click"]);Ht(["keydown","click"]);Ht(["click","pointerdown","pointermove","pointerup"]);var og=te('<span class="mt-1 text-xs text-white/60"> </span>'),cg=te('<div class="absolute inset-0 flex flex-col items-center justify-center bg-black/60 backdrop-blur-sm"><!> <span class="text-sm font-medium text-white"> </span> <!></div>'),lg=te('<button class="absolute inset-0 flex items-center justify-center bg-black/0 transition-colors hover:bg-black/30"><div class="flex h-12 w-12 items-center justify-center rounded-full bg-white/90 opacity-0 shadow-lg transition-opacity group-hover:opacity-100"><!></div></button>'),dg=te('<div class="animate-confetti absolute h-1.5 w-1.5 rounded-full"></div>'),ug=te('<div class="pointer-events-none absolute inset-0 overflow-visible"></div>'),fg=te('<span class="flex items-center gap-1 rounded-full bg-green-500 px-2 py-1 text-xs font-bold text-white shadow-lg"><!> </span> <!>',1),hg=te('<span class="rounded-full bg-amber-500 px-2 py-1 text-xs font-bold text-white shadow-lg"> </span>'),mg=te('<div class="absolute right-2 top-2"><!></div>'),pg=te('<div class="absolute right-2 top-2"><span class="flex items-center gap-1 rounded-full bg-purple-500/80 px-2 py-1 text-xs font-medium text-white shadow-lg"><!> Trimmed</span></div>'),gg=te('<span class="text-purple-300"> </span>'),vg=te('<div class="absolute bottom-2 left-2 rounded bg-black/70 px-1.5 py-0.5 text-xs font-medium text-white"><!></div>'),bg=te('<div class="absolute bottom-2 right-2 rounded bg-black/70 px-1.5 py-0.5 text-xs font-medium text-white"> </div>'),wg=te('<div class="absolute left-2 top-2 flex items-center gap-1 rounded bg-black/70 px-1.5 py-0.5 text-xs font-medium text-white opacity-0 transition-opacity group-hover:opacity-100"><!> Drag to save</div>'),kg=te("<button><!> </button>"),yg=te('<button class="text-surface-500 mt-2 w-full rounded-lg py-1.5 text-xs transition-colors hover:bg-red-500/10 hover:text-red-400" aria-label="Clear trim">Reset to full duration</button>'),xg=te('<div class="mt-3"><!> <!></div>'),_g=te('<div class="flex items-center justify-between gap-2"><span class="text-surface-500 text-xs"> </span> <!></div> <!>',1),Tg=te('<div class="bg-surface-700 h-1.5 w-full overflow-hidden rounded-full"><div class="from-accent-start to-accent-end h-full rounded-full bg-gradient-to-r transition-all duration-300"></div></div>'),Sg=te('<span class="ml-auto text-[9px] text-purple-400">GPU</span>'),Cg=te('<span class="text-surface-500 ml-auto text-[9px]">N/A</span>'),Pg=te("<button><span></span> <span> </span> <!></button>"),Eg=te('<button class="fixed inset-0 z-40" aria-label="Close"></button> <div class="bg-surface-800 absolute bottom-full left-0 z-50 mb-1 min-w-[100px] overflow-hidden rounded-lg shadow-xl ring-1 ring-white/10"></div>',1),Ig=te('<div class="space-y-2"><div class="flex items-start gap-1.5 text-xs text-red-400"><!> <span class="break-words"> </span></div> <div class="flex items-center justify-between"><div class="relative"><button> <!></button> <!></div> <button class="flex items-center gap-1.5 rounded-lg bg-red-500/20 px-4 py-2.5 text-sm font-medium text-red-400 transition-colors hover:bg-red-500/30 sm:py-1.5 sm:text-xs"><!> Retry</button></div></div>'),Ag=te('<span class="ml-auto text-[9px] text-purple-400">GPU</span>'),Fg=te('<span class="text-surface-500 ml-auto text-[9px]">N/A</span>'),Bg=te("<button><span></span> <span> </span> <!></button>"),zg=te('<button class="fixed inset-0 z-40" aria-label="Close"></button> <div class="bg-surface-800 absolute bottom-full left-0 z-50 mb-1 min-w-[100px] overflow-hidden rounded-lg shadow-xl ring-1 ring-white/10"></div>',1),Mg=te('<span class="text-surface-500 text-[10px]"> </span>'),Rg=te('<button class="text-surface-400 hover:bg-surface-700 hover:text-surface-200 flex h-10 w-10 items-center justify-center rounded-lg transition-all sm:h-7 sm:w-7 sm:rounded" title="Compare"><!></button>'),Dg=te('<div class="flex items-center justify-between"><div class="flex items-center gap-1.5"><span class="text-surface-500 text-xs"> </span> <!> <div class="relative"><button title="Re-compress as different format"><span class="mr-0.5 hidden text-[9px] font-normal opacity-80 sm:inline">as</span> <!></button> <!></div> <span class="inline-flex items-center gap-0.5 rounded bg-purple-500/20 px-1.5 py-0.5 text-[10px] font-medium text-purple-400"><!> GPU</span> <!></div> <div class="flex items-center gap-1"><!> <button class="from-accent-start to-accent-end flex h-10 items-center gap-1.5 rounded-lg bg-gradient-to-r px-3 text-sm font-medium text-white transition-all hover:opacity-90 sm:h-7 sm:rounded sm:px-2.5 sm:text-xs"><!></button></div></div>'),Og=te('<div class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4" role="dialog" aria-modal="true" tabindex="-1"><button class="absolute right-4 top-4 z-10 rounded-full bg-white/10 p-3 text-white backdrop-blur-sm transition-colors hover:bg-white/20" aria-label="Close preview"><!></button> <video class="max-h-[85vh] max-w-[95vw] rounded-2xl shadow-2xl" controls autoplay></video></div>',2),Ng=te('<div class="glass group relative overflow-hidden rounded-2xl transition-all duration-300 hover:shadow-xl hover:shadow-black/20"><button class="bg-surface-700 text-surface-400 absolute -right-2 -top-2 z-10 flex h-6 w-6 items-center justify-center rounded-full opacity-0 shadow-lg transition-all hover:bg-red-500 hover:text-white group-hover:opacity-100" aria-label="Remove video"><!></button> <div class="bg-surface-800 relative aspect-video w-full overflow-hidden rounded-t-2xl"><video class="h-full w-full object-cover" preload="metadata"></video> <!> <!> <!> <!> <!></div> <div class="p-3"><div class="mb-2 flex items-center justify-between gap-2"><p class="text-surface-200 truncate text-sm font-medium"> </p> <span class="text-surface-400 flex-shrink-0 font-mono text-xs"><!></span></div> <!></div></div> <!> <!>',3);function Ug(r,e){Xt(e,!0);let t=We(!1),i=We(!1),a=We(!1),n=We(!1),s=We(""),o=We("");const c=Ge(()=>()=>ic()?.supportedVideoCodecs.includes("av1")??!1),l=Ge(()=>()=>ic()?.supportedVideoCodecs.includes("hevc")??!1),d=Ge(()=>e.item.compressedSize?Math.round((1-e.item.compressedSize/e.item.originalSize)*100):0),u=Ge(()=>_(d)>0),f=Ge(()=>e.item.status==="pending"?hu(e.item,le.settings):0),h=Ge(()=>yn(e.item)),g=Ge(()=>e.item.trimStart!==void 0||e.item.trimEnd!==void 0);qi(()=>{_(n)&&e.item.duration&&(se(s,Bi(e.item.trimStart||0),!0),se(o,Bi(e.item.trimEnd??e.item.duration),!0))});const m=[{value:"mp4",label:"MP4",color:"from-orange-500 to-red-500"},{value:"webm",label:"WebM",color:"from-green-500 to-emerald-500"},{value:"hevc",label:"HEVC",color:"from-blue-500 to-cyan-500"},{value:"av1",label:"AV1",color:"from-purple-500 to-pink-500"}];function p(){le.updateItem(e.item.id,{trimStart:void 0,trimEnd:void 0}),se(n,!1)}function v(V){if(!e.item.compressedBlob||!e.item.compressedUrl)return;const H=Jn(e.item.name,e.item.outputFormat),U=e.item.outputFormat==="webm"?"video/webm":"video/mp4";V.dataTransfer?.setData("DownloadURL",`${U}:${H}:${e.item.compressedUrl}`),V.dataTransfer?.setData("text/plain",e.item.compressedUrl),V.dataTransfer&&(V.dataTransfer.effectAllowed="copy")}function b(){le.removeItem(e.item.id)}function w(){Wp(e.item)}async function x(V){se(t,!1),V!==e.item.outputFormat&&(Ua.info(`Re-compressing as ${V.toUpperCase()}...`),le.updateItem(e.item.id,{outputFormat:V}),await ac(e.item.id))}async function T(){await ac(e.item.id)}function A(){return m.find(H=>H.value===e.item.outputFormat)?.color||"from-gray-500 to-gray-600"}var B=Ng(),z=pe(B),M=I(z);M.__click=b;var W=I(M);_r(W,{class:"h-3.5 w-3.5"}),P(M);var G=O(M,2),C=I(G);C.muted=!0;var N=O(C,2);{var y=V=>{var H=cg(),U=I(H);Kd(U,{class:"mb-2 h-8 w-8 animate-spin text-white"});var Z=O(U,2),re=I(Z);P(Z);var Q=O(Z,2);{var ae=we=>{var ye=og(),Pe=I(ye,!0);P(ye),Te(()=>ke(Pe,e.item.progressStage)),$(we,ye)};oe(Q,we=>{e.item.progressStage&&we(ae)})}P(H),Te(()=>ke(re,`${e.item.progress??""}%`)),$(V,H)},q=V=>{var H=lg();H.__click=()=>se(i,!0);var U=I(H),Z=I(U);wn(Z,{class:"text-surface-800 ml-0.5 h-5 w-5",fill:"currentColor"}),P(U),P(H),$(V,H)};oe(N,V=>{e.item.status==="processing"?V(y):V(q,!1)})}var ne=O(N,2);{var Y=V=>{var H=mg(),U=I(H);{var Z=Q=>{var ae=fg(),we=pe(ae),ye=I(we);la(ye,{class:"h-3 w-3"});var Pe=O(ye);P(we);var Ae=O(we,2);{var Ue=Ke=>{var De=ug();_t(De,20,()=>Array(12),Ct,(Je,mt,tt)=>{var gt=dg();Te(()=>kr(gt,`
										background: ${["#f97316","#eab308","#22c55e","#8b5cf6","#ec4899"][tt%5]??""};
										left: ${50+(Math.random()-.5)*60}%;
										top: 50%;
										animation-delay: ${Math.random()*.4}s;
									`)),$(Je,gt)}),P(De),$(Ke,De)};oe(Ae,Ke=>{_(d)>50&&Ke(Ue)})}Te(()=>ke(Pe,` -${_(d)??""}%`)),$(Q,ae)},re=Q=>{var ae=hg(),we=I(ae);P(ae),Te(ye=>ke(we,`+${ye??""}%`),[()=>Math.abs(_(d))]),$(Q,ae)};oe(U,Q=>{_(u)?Q(Z):Q(re,!1)})}P(H),$(V,H)},fe=V=>{var H=_e(),U=pe(H);{var Z=re=>{var Q=pg(),ae=I(Q),we=I(ae);fo(we,{class:"h-3 w-3"}),Ie(),P(ae),P(Q),$(re,Q)};oe(U,re=>{e.item.status==="pending"&&_(g)&&re(Z)},!0)}$(V,H)};oe(ne,V=>{e.item.status==="completed"?V(Y):V(fe,!1)})}var ee=O(ne,2);{var he=V=>{var H=vg(),U=I(H);{var Z=Q=>{var ae=gg(),we=I(ae,!0);P(ae),Te(ye=>ke(we,ye),[()=>Ns(_(h))]),$(Q,ae)},re=Q=>{var ae=yr();Te(we=>ke(ae,we),[()=>Ns(e.item.duration)]),$(Q,ae)};oe(U,Q=>{_(g)?Q(Z):Q(re,!1)})}P(H),$(V,H)};oe(ee,V=>{e.item.duration&&V(he)})}var K=O(ee,2);{var L=V=>{var H=bg(),U=I(H);P(H),Te(()=>ke(U,`${e.item.width??""}Ã—${e.item.height??""}`)),$(V,H)};oe(K,V=>{e.item.width&&e.item.height&&V(L)})}var be=O(K,2);{var ce=V=>{var H=wg(),U=I(H);Ld(U,{class:"h-3 w-3"}),Ie(),P(H),$(V,H)};oe(be,V=>{e.item.status==="completed"&&e.item.compressedBlob&&V(ce)})}P(G);var j=O(G,2),ie=I(j),me=I(ie),ge=I(me,!0);P(me);var xe=O(me,2),Re=I(xe);{var Be=V=>{var H=yr();Te(U=>ke(H,U),[()=>mn(e.item.compressedSize)]),$(V,H)},st=V=>{var H=_e(),U=pe(H);{var Z=re=>{var Q=yr();Te(ae=>ke(Q,`~${ae??""}`),[()=>mn(_(f))]),$(re,Q)};oe(U,re=>{_(f)>0&&re(Z)},!0)}$(V,H)};oe(Re,V=>{e.item.status==="completed"&&e.item.compressedSize?V(Be):V(st,!1)})}P(xe),P(ie);var ct=O(ie,2);{var k=V=>{var H=_g(),U=pe(H),Z=I(U),re=I(Z);P(Z);var Q=O(Z,2);{var ae=Pe=>{var Ae=kg();Ae.__click=()=>se(n,!_(n));var Ue=I(Ae);fo(Ue,{class:"h-3.5 w-3.5 sm:h-3 sm:w-3"});var Ke=O(Ue);P(Ae),Te(De=>{at(Ae,1,`flex items-center gap-1.5 rounded-lg px-3 py-2 text-sm font-medium transition-all sm:py-1 sm:text-xs ${_(n)||_(g)?"bg-purple-500/20 text-purple-400":"text-surface-500 hover:text-surface-300 hover:bg-surface-700/50"}`),ke(Ke,` ${De??""}`)},[()=>_(g)?Ns(_(h)):"Trim"]),$(Pe,Ae)};oe(Q,Pe=>{e.item.duration&&Pe(ae)})}P(U);var we=O(U,2);{var ye=Pe=>{var Ae=xg(),Ue=I(Ae);{let Je=Ge(()=>e.item.trimStart||0),mt=Ge(()=>e.item.trimEnd??e.item.duration);rg(Ue,{get videoUrl(){return e.item.originalUrl},get duration(){return e.item.duration},get trimStart(){return _(Je)},get trimEnd(){return _(mt)},onchange:(tt,gt)=>{le.updateItem(e.item.id,{trimStart:tt>0?tt:void 0,trimEnd:gt<e.item.duration?gt:void 0})}})}var Ke=O(Ue,2);{var De=Je=>{var mt=yg();mt.__click=p,$(Je,mt)};oe(Ke,Je=>{_(g)&&Je(De)})}P(Ae),ut(3,Ae,()=>ja,()=>({duration:200})),$(Pe,Ae)};oe(we,Pe=>{_(n)&&e.item.duration&&Pe(ye)})}Te((Pe,Ae)=>ke(re,`${Pe??""} â†’ ${Ae??""}`),[()=>e.item.format?.toUpperCase(),()=>e.item.outputFormat.toUpperCase()]),$(V,H)},J=V=>{var H=_e(),U=pe(H);{var Z=Q=>{var ae=Tg(),we=I(ae);P(ae),Te(()=>kr(we,`width: ${e.item.progress??""}%`)),$(Q,ae)},re=Q=>{var ae=_e(),we=pe(ae);{var ye=Ae=>{var Ue=Ig(),Ke=I(Ue),De=I(Ke);bc(De,{class:"mt-0.5 h-3.5 w-3.5 flex-shrink-0"});var Je=O(De,2),mt=I(Je,!0);P(Je),P(Ke);var tt=O(Ke,2),gt=I(tt),jt=I(gt);jt.__click=()=>se(t,!_(t));var Jt=I(jt),ze=O(Jt);Wa(ze,{class:"h-3 w-3"}),P(jt);var Ee=O(jt,2);{var He=Ze=>{var dt=Eg(),sr=pe(dt);sr.__click=()=>se(t,!1);var qt=O(sr,2);_t(qt,21,()=>m,Ct,(ur,xt)=>{const Bt=Ge(()=>_(xt).value==="av1"&&!_(c)()||_(xt).value==="hevc"&&!_(l)()),Tt=Ge(()=>_(xt).value==="av1"||_(xt).value==="hevc"),Pt=Ge(()=>_(xt).value==="av1"&&_(c)()||_(xt).value==="hevc"&&_(l)());var Et=Pg();Et.__click=()=>!_(Bt)&&x(_(xt).value);var vt=I(Et),bt=O(vt,2),nr=I(bt,!0);P(bt);var Qe=O(bt,2);{var Ye=je=>{var nt=Sg();$(je,nt)},$e=je=>{var nt=_e(),it=pe(nt);{var ot=It=>{var $t=Cg();$(It,$t)};oe(it,It=>{_(Tt)&&_(Bt)&&It(ot)},!0)}$(je,nt)};oe(Qe,je=>{_(Tt)&&_(Pt)?je(Ye):je($e,!1)})}P(Et),Te(()=>{Et.disabled=_(Bt),at(Et,1,`flex w-full items-center gap-2 px-3 py-2 text-xs transition-colors ${_(Bt)?"cursor-not-allowed opacity-40":"hover:bg-surface-700"} ${e.item.outputFormat===_(xt).value?"bg-surface-700/50":""}`),pt(Et,"title",_(Bt)?`${_(xt).label} not available on this device`:""),at(vt,1,`h-2 w-2 rounded-full bg-gradient-to-r ${_(xt).color??""} ${_(Bt)?"opacity-50":""}`),at(bt,1,`font-medium ${_(Bt)?"text-surface-500 line-through":"text-surface-300"}`),ke(nr,_(xt).label)}),$(ur,Et)}),P(qt),ut(3,qt,()=>Ri,()=>({duration:100,start:.95})),$(Ze,dt)};oe(Ee,Ze=>{_(t)&&Ze(He)})}P(gt);var lt=O(gt,2);lt.__click=T;var Nt=I(lt);Qd(Nt,{class:"h-4 w-4 sm:h-3 sm:w-3"}),Ie(),P(lt),P(tt),P(Ue),Te((Ze,dt)=>{ke(mt,e.item.error||"Compression failed"),at(jt,1,`flex items-center gap-1 rounded bg-gradient-to-r ${Ze??""} px-2 py-0.5 text-xs font-bold uppercase text-white transition-all hover:opacity-90`),ke(Jt,`${dt??""} `)},[A,()=>e.item.outputFormat.toUpperCase()]),$(Ae,Ue)},Pe=Ae=>{var Ue=_e(),Ke=pe(Ue);{var De=Je=>{var mt=Dg(),tt=I(mt),gt=I(tt),jt=I(gt,!0);P(gt);var Jt=O(gt,2);Ws(Jt,{class:"text-surface-600 h-3 w-3"});var ze=O(Jt,2),Ee=I(ze);Ee.__click=()=>se(t,!_(t));var He=O(I(Ee)),lt=O(He);Wa(lt,{class:"h-3 w-3"}),P(Ee);var Nt=O(Ee,2);{var Ze=vt=>{var bt=zg(),nr=pe(bt);nr.__click=()=>se(t,!1);var Qe=O(nr,2);_t(Qe,21,()=>m,Ct,(Ye,$e)=>{const je=Ge(()=>_($e).value==="av1"&&!_(c)()||_($e).value==="hevc"&&!_(l)()),nt=Ge(()=>_($e).value==="av1"||_($e).value==="hevc"),it=Ge(()=>_($e).value==="av1"&&_(c)()||_($e).value==="hevc"&&_(l)());var ot=Bg();ot.__click=()=>!_(je)&&x(_($e).value);var It=I(ot),$t=O(It,2),ti=I($t,!0);P($t);var Pr=O($t,2);{var ri=hi=>{var Ea=Ag();$(hi,Ea)},Pa=hi=>{var Ea=_e(),Ol=pe(Ea);{var Nl=ds=>{var Ul=Fg();$(ds,Ul)};oe(Ol,ds=>{_(nt)&&_(je)&&ds(Nl)},!0)}$(hi,Ea)};oe(Pr,hi=>{_(nt)&&_(it)?hi(ri):hi(Pa,!1)})}P(ot),Te(()=>{ot.disabled=_(je),at(ot,1,`flex w-full items-center gap-2 px-3 py-2 text-xs transition-colors ${_(je)?"cursor-not-allowed opacity-40":"hover:bg-surface-700"} ${e.item.outputFormat===_($e).value?"bg-surface-700/50":""}`),pt(ot,"title",_(je)?`${_($e).label} not available on this device`:""),at(It,1,`h-2 w-2 rounded-full bg-gradient-to-r ${_($e).color??""} ${_(je)?"opacity-50":""}`),at($t,1,`font-medium ${_(je)?"text-surface-500 line-through":"text-surface-300"}`),ke(ti,_($e).label)}),$(Ye,ot)}),P(Qe),ut(3,Qe,()=>Ri,()=>({duration:100,start:.95})),$(vt,bt)};oe(Nt,vt=>{_(t)&&vt(Ze)})}P(ze);var dt=O(ze,2),sr=I(dt);js(sr,{class:"h-2.5 w-2.5"}),Ie(),P(dt);var qt=O(dt,2);{var ur=vt=>{var bt=Mg(),nr=I(bt);P(bt),Te(Qe=>ke(nr,`${Qe??""}s`),[()=>(e.item.compressionDuration/1e3).toFixed(1)]),$(vt,bt)};oe(qt,vt=>{e.item.compressionDuration&&vt(ur)})}P(tt);var xt=O(tt,2),Bt=I(xt);{var Tt=vt=>{var bt=Rg();bt.__click=()=>se(a,!0);var nr=I(bt);Zd(nr,{class:"h-4 w-4 sm:h-3.5 sm:w-3.5"}),P(bt),$(vt,bt)};oe(Bt,vt=>{e.item.compressedUrl&&vt(Tt)})}var Pt=O(Bt,2);Pt.__click=w;var Et=I(Pt);Ha(Et,{class:"h-4 w-4 sm:h-3.5 sm:w-3.5"}),P(Pt),P(xt),P(mt),Te((vt,bt)=>{ke(jt,e.item.format),at(Ee,1,`flex items-center gap-1 rounded bg-gradient-to-r ${vt??""} px-2 py-0.5 text-xs font-bold uppercase text-white transition-all hover:opacity-90`),ke(He,` ${bt??""} `)},[A,()=>e.item.outputFormat.toUpperCase()]),$(Je,mt)};oe(Ke,Je=>{e.item.status==="completed"&&Je(De)},!0)}$(Ae,Ue)};oe(we,Ae=>{e.item.status==="error"?Ae(ye):Ae(Pe,!1)},!0)}$(Q,ae)};oe(U,Q=>{e.item.status==="processing"?Q(Z):Q(re,!1)},!0)}$(V,H)};oe(ct,V=>{e.item.status==="pending"?V(k):V(J,!1)})}P(j),P(z);var X=O(z,2);{var F=V=>{var H=Og();H.__click=()=>se(i,!1),H.__keydown=Q=>Q.key==="Escape"&&se(i,!1);var U=I(H);U.__click=()=>se(i,!1);var Z=I(U);_r(Z,{class:"h-6 w-6"}),P(U);var re=O(U,2);re.__click=Q=>Q.stopPropagation(),P(H),Te(()=>pt(re,"src",e.item.compressedUrl||e.item.originalUrl)),ut(3,H,()=>Qt,()=>({duration:150})),$(V,H)};oe(X,V=>{_(i)&&V(F)})}var S=O(X,2);{var R=V=>{Xp(V,{get originalUrl(){return e.item.originalUrl},get compressedUrl(){return e.item.compressedUrl},get originalSize(){return e.item.originalSize},get compressedSize(){return e.item.compressedSize},onclose:()=>se(a,!1)})};oe(S,V=>{_(a)&&e.item.compressedUrl&&e.item.compressedSize&&V(R)})}Te(()=>{pt(z,"draggable",e.item.status==="completed"&&!!e.item.compressedBlob),pt(z,"role",e.item.status==="completed"&&e.item.compressedBlob?"listitem":void 0),pt(C,"src",e.item.compressedUrl||e.item.originalUrl),pt(me,"title",e.item.name),ke(ge,e.item.name)}),St("dragstart",z,v),ut(1,z,()=>Ri,()=>({duration:200,start:.95})),ut(2,z,()=>Qt,()=>({duration:150})),$(r,B),Zt()}Ht(["click","keydown"]);function Vg(r){const e=r-1;return e*e*e+1}function Lg(r,{from:e,to:t},i={}){var{delay:a=0,duration:n=A=>Math.sqrt(A)*120,easing:s=Vg}=i,o=getComputedStyle(r),c=o.transform==="none"?"":o.transform,[l,d]=o.transformOrigin.split(" ").map(parseFloat);l/=r.clientWidth,d/=r.clientHeight;var u=$g(r),f=r.clientWidth/t.width/u,h=r.clientHeight/t.height/u,g=e.left+e.width*l,m=e.top+e.height*d,p=t.left+t.width*l,v=t.top+t.height*d,b=(g-p)*f,w=(m-v)*h,x=e.width/t.width,T=e.height/t.height;return{delay:a,duration:typeof n=="function"?n(Math.sqrt(b*b+w*w)):n,easing:s,css:(A,B)=>{var z=B*b,M=B*w,W=A+B*x,G=A+B*T;return`transform: ${c} translate(${z}px, ${M}px) scale(${W}, ${G});`}}}function $g(r){if("currentCSSZoom"in r)return r.currentCSSZoom;for(var e=r,t=1;e!==null;)t*=+getComputedStyle(e).zoom,e=e.parentElement;return t}var Wg=te('<div class="bg-accent-start absolute -top-2 left-0 right-0 h-1 rounded-full"></div>'),Hg=te('<div class="bg-surface-700 text-surface-300 ring-surface-900 absolute -left-1 -top-1 flex h-6 w-6 items-center justify-center rounded-full text-xs font-bold ring-2"> </div>'),jg=te('<div role="listitem" aria-label="Video item, drag to reorder"><!> <!> <!></div>'),qg=te('<div class="mt-6 sm:mt-8"><div class="mb-4 flex items-center justify-between"><h2 class="text-surface-200 text-lg font-semibold">Videos <span class="text-surface-500 font-normal"> </span></h2> <p class="text-surface-500 text-xs">Drag to reorder â€¢ Processing order: top to bottom</p></div> <div class="grid gap-4 sm:grid-cols-2 sm:gap-6 lg:grid-cols-3 xl:grid-cols-4"></div></div>');function Kg(r,e){Xt(e,!0);let t=We(null),i=We(null);function a(w,x,T){se(t,x,!0),w.dataTransfer&&(w.dataTransfer.effectAllowed="move",w.dataTransfer.setData("text/plain",x.id)),setTimeout(()=>{w.target.classList.add("opacity-50","scale-95")},0)}function n(w){se(t,null),se(i,null),w.target.classList.remove("opacity-50","scale-95")}function s(w,x){w.preventDefault(),_(t)&&(w.dataTransfer&&(w.dataTransfer.dropEffect="move"),se(i,x,!0))}function o(){se(i,null)}function c(w,x){if(w.preventDefault(),!_(t))return;const T=le.items.findIndex(A=>A.id===_(t).id);T!==-1&&T!==x&&le.reorderItems(T,x),se(t,null),se(i,null)}let l=null;function d(w,x){w.touches[0].clientY,l=x}function u(w){}function f(){l=null}var h=qg(),g=I(h),m=I(g),p=O(I(m)),v=I(p);P(p),P(m),Ie(2),P(g);var b=O(g,2);_t(b,31,()=>le.items,w=>w.id,(w,x,T)=>{var A=jg();A.__touchstart=C=>d(C,_(x)),A.__touchmove=u,A.__touchend=f;var B=I(A);{var z=C=>{var N=Wg();ut(3,N,()=>Qt,()=>({duration:150})),$(C,N)};oe(B,C=>{_(i)===_(T)&&_(t)?.id!==_(x).id&&C(z)})}var M=O(B,2);Ug(M,{get item(){return _(x)}});var W=O(M,2);{var G=C=>{var N=Hg(),y=I(N,!0);P(N),Te(()=>ke(y,_(T)+1)),$(C,N)};oe(W,C=>{_(x).status==="pending"&&C(G)})}P(A),Te(()=>{at(A,1,`relative transition-transform duration-200 ${_(i)===_(T)&&_(t)?.id!==_(x).id?"translate-y-2 opacity-70":""}`),pt(A,"draggable",_(x).status!=="processing")}),St("dragstart",A,C=>a(C,_(x),_(T))),St("dragend",A,n),St("dragover",A,C=>s(C,_(T))),St("dragleave",A,o),St("drop",A,C=>c(C,_(T))),Pd(A,()=>Lg,()=>({duration:300})),$(w,A)}),P(b),P(h),Te(()=>ke(v,`(${le.items.length??""})`)),$(r,h),Zt()}Ht(["touchstart","touchmove","touchend"]);var Gg=te('<div class="bg-surface-800 text-surface-200 absolute bottom-full left-1/2 z-50 mb-2 w-64 -translate-x-1/2 rounded-lg p-3 text-left text-sm font-normal shadow-xl ring-1 ring-white/10" role="tooltip"> <div class="border-t-surface-800 absolute left-1/2 top-full -mt-1 -translate-x-1/2 border-4 border-transparent"></div></div>'),Qg=te('<button type="button" class="text-surface-500 hover:text-surface-300 relative ml-1 transition-colors" aria-label="More information"><!> <!></button>');function Vs(r,e){let t=We(!1);var i=Qg(),a=I(i);bn(a,{class:"h-4 w-4"});var n=O(a,2);{var s=o=>{var c=Gg(),l=I(c);Ie(),P(c),Te(()=>ke(l,`${e.content??""} `)),ut(3,c,()=>Qt,()=>({duration:100})),$(o,c)};oe(n,o=>{_(t)&&o(s)})}P(i),St("mouseenter",i,()=>se(t,!0)),St("mouseleave",i,()=>se(t,!1)),St("focus",i,()=>se(t,!0)),St("blur",i,()=>se(t,!1)),$(r,i)}var Xg=te("<button> </button>"),Zg=te('<button><span class="text-base"> </span> <span class="flex-1 text-left"> </span> <span class="text-surface-500 text-xs"> </span></button>'),Yg=te('<div class="border-surface-700/50 border-t p-2"><button class="text-surface-500 hover:text-surface-300 w-full px-3 py-1.5 text-xs transition-colors">Clear target size</button></div>'),Jg=te('<button class="fixed inset-0 z-40" aria-label="Close"></button> <div class="bg-surface-800 absolute left-0 top-full z-50 mt-2 w-48 overflow-hidden rounded-xl shadow-xl ring-1 ring-white/10"><div class="border-surface-700/50 border-b p-3"><div class="flex items-center gap-2"><input type="text" class="bg-surface-700 border-surface-600 text-surface-200 placeholder-surface-500 focus:ring-accent-start focus:border-accent-start flex-1 rounded-lg border px-3 py-1.5 text-sm focus:outline-none focus:ring-1" placeholder="Custom MB"/> <button class="bg-accent-start hover:bg-accent-start/80 rounded-lg px-2 py-1.5 text-xs font-medium text-white">Set</button></div></div> <div class="p-1.5"></div> <!></div>',1),e0=te('<p class="text-accent-start hidden self-center text-xs sm:block"> </p>'),t0=te('<span class="absolute -right-1.5 -top-1.5 rounded bg-purple-500 px-1 py-0.5 text-[9px] font-bold text-white">GPU</span>'),r0=te('<span class="bg-surface-600 text-surface-400 absolute -right-1.5 -top-1.5 rounded px-1 py-0.5 text-[9px] font-bold">N/A</span>'),i0=te("<button> <!></button>"),a0=te("<!> <span>Compressing...</span>",1),s0=te("<!> <span> </span>",1),n0=te('<button class="from-accent-start to-accent-end shadow-accent-start/30 hover:shadow-accent-start/40 flex items-center gap-2 rounded-xl bg-gradient-to-r px-5 py-3 text-sm font-semibold text-white shadow-lg transition-all hover:scale-105 hover:shadow-xl disabled:opacity-50 disabled:hover:scale-100 sm:py-2"><!></button>'),o0=te('<button class="bg-surface-700 text-surface-300 hover:bg-surface-600 flex items-center gap-2 rounded-xl px-4 py-2.5 text-sm font-medium transition-all disabled:opacity-50 sm:py-2"><!> <span class="hidden sm:inline"> </span></button>'),c0=te('<div class="text-xs opacity-70"> </div>'),l0=te('<button><div class="font-medium"> </div> <!></button>'),d0=te('<button><div class="font-medium"> </div> <div class="text-xs opacity-70"> </div></button>'),u0=te("<button> </button>"),f0=te('<div class="mt-3"><span class="text-surface-500 mb-2 block text-xs">Bitrate</span> <div class="flex gap-1"></div></div>'),h0=te("<div></div>"),m0=te('<button><div class="text-left"><div class="font-medium"> </div> <div class="text-xs opacity-70"> </div></div> <div class="flex gap-0.5"></div></button>'),p0=te('<span class="text-amber-500">(N/A for WebM)</span>'),g0=te('<div class="border-surface-700/50 bg-surface-900/50 border-t p-4 sm:p-6"><div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-4"><div><div class="mb-3 flex items-center gap-2"><!> <span class="text-surface-300 text-sm font-medium">Resolution</span> <!></div> <div class="grid grid-cols-2 gap-1.5"></div></div> <div><div class="mb-3 flex items-center gap-2"><!> <span class="text-surface-300 text-sm font-medium">Audio Codec</span> <!></div> <div class="grid grid-cols-2 gap-1.5"></div> <!></div> <div><div class="mb-3 flex items-center gap-2"><!> <span class="text-surface-300 text-sm font-medium">Encoding Speed</span> <!></div> <div class="space-y-1.5"></div></div> <div><div class="mb-3 flex items-center gap-2"><!> <span class="text-surface-300 text-sm font-medium">Options</span></div> <div class="space-y-3"><label class="group flex cursor-pointer items-center gap-3"><input type="checkbox" class="bg-surface-700 border-surface-600 text-accent-start focus:ring-accent-start focus:ring-offset-surface-900 h-5 w-5 rounded"/> <div><div class="text-surface-300 group-hover:text-surface-100 text-sm font-medium transition-colors">Remove Location Data</div> <div class="text-surface-500 text-xs">Strip GPS, camera info, and metadata</div></div></label> <label class="group flex cursor-pointer items-center gap-3"><input type="checkbox" class="bg-surface-700 border-surface-600 text-accent-start focus:ring-accent-start focus:ring-offset-surface-900 h-5 w-5 rounded"/> <div><div>Two-Pass Encoding</div> <div class="text-surface-500 text-xs">Better quality, ~2x slower <!></div></div></label></div> <div class="bg-surface-800/50 border-surface-700/50 mt-4 rounded-lg border p-3"><div class="flex items-start gap-2"><!> <p class="text-surface-500 text-xs"><!></p></div></div></div></div></div>'),v0=te('<div class="glass mb-6 overflow-hidden rounded-2xl sm:mb-8"><div class="p-4 sm:p-6"><div class="flex flex-wrap items-center gap-3 sm:gap-4"><div class="flex flex-col gap-1.5"><span class="text-surface-500 hidden text-[10px] uppercase tracking-wider sm:block">Quality</span> <div class="flex gap-1"></div></div> <div class="text-surface-600 hidden items-center gap-2 self-center sm:flex"><div class="bg-surface-700 h-8 w-px"></div> <span class="text-xs font-medium">or</span> <div class="bg-surface-700 h-8 w-px"></div></div> <div class="flex flex-col gap-1.5"><span class="text-surface-500 hidden text-[10px] uppercase tracking-wider sm:block">Target Size</span> <div class="relative"><button> <!></button> <!></div></div> <!> <div class="bg-surface-700/50 hidden h-5 w-px sm:block"></div> <div class="flex gap-1"></div> <div class="flex-1"></div> <button class="text-surface-400 hover:text-surface-200 flex items-center gap-1.5 px-3 py-2.5 text-sm font-medium transition-colors sm:py-1.5"><!> <span class="hidden sm:inline">Advanced</span> <!></button> <!></div></div> <!></div>');function b0(r,e){Xt(e,!0);let t=We(!1),i=We(!1);xa(async()=>{const S=await Ca();se(t,S.supportedVideoCodecs.includes("av1"),!0),se(i,S.supportedVideoCodecs.includes("hevc"),!0)});const a=[{value:"mp4",label:"MP4",desc:"H.264 â€¢ Universal compatibility"},{value:"webm",label:"WebM",desc:"VP9 â€¢ Modern browsers"},{value:"hevc",label:"HEVC",desc:"H.265 â€¢ Better compression",requiresHardware:!0},{value:"av1",label:"AV1",desc:"Best compression â€¢ Newest",requiresHardware:!0}],n=[{value:"aac",label:"AAC",desc:"Standard"},{value:"opus",label:"Opus",desc:"Modern"},{value:"mp3",label:"MP3",desc:"Legacy"},{value:"copy",label:"Keep Original",desc:"No re-encode"},{value:"none",label:"None",desc:"Remove audio"}],s=[{value:"veryfast",label:"Fast",speed:4,desc:"Quick encoding, slightly larger files"},{value:"medium",label:"Balanced",speed:2,desc:"Good balance of speed and quality"},{value:"slow",label:"Quality",speed:0,desc:"Best quality, slower encoding"}],o=Object.entries(is).map(([S,R])=>({key:S,...R})),c=Object.entries(ou).map(([S,R])=>({key:S,...R}));let l=We(!1),d=We(!1),u=We(""),f=We(!1);const h=Ge(()=>le.items.filter(S=>S.status==="pending")),g=Ge(()=>_(h).length>0),m=Ge(()=>le.items.some(S=>S.status==="completed")),p=Ge(()=>le.items.some(S=>S.status==="processing")),v=Ge(()=>le.settings.targetSizeMB!==void 0);qi(()=>{le.settings.targetSizeMB!==void 0&&se(u,le.settings.targetSizeMB.toString(),!0)});function b(S){le.updateSettings({quality:S,targetSizeMB:void 0}),se(u,""),se(f,!1)}function w(S){le.updateSettings({outputFormat:S})}function x(){const S=parseFloat(_(u));!isNaN(S)&&S>0?le.updateSettings({targetSizeMB:S}):le.updateSettings({targetSizeMB:void 0})}function T(S){le.updateSettings({targetSizeMB:S}),se(u,S.toString(),!0),se(f,!1)}function A(){le.updateSettings({targetSizeMB:void 0}),se(u,"")}function B(S){le.updateSettings({resolution:S})}function z(S){le.updateSettings({audioCodec:S})}function M(S){le.updateSettings({audioBitrate:S})}function W(S){le.updateSettings({preset:S})}async function G(){_(g)&&(se(d,!0),await Dp(_(h).map(S=>S.id)),se(d,!1))}async function C(){se(d,!0),await Vp(),se(d,!1)}var N=v0(),y=I(N),q=I(y),ne=I(q),Y=O(I(ne),2);_t(Y,21,()=>o,Ct,(S,R)=>{var V=Xg();V.__click=()=>b(_(R).key);var H=I(V,!0);P(V),Te(()=>{at(V,1,`rounded-lg px-3 py-2.5 text-sm font-medium transition-all sm:py-1.5 ${le.settings.quality===_(R).key&&!_(v)?"bg-accent-start shadow-accent-start/30 text-white shadow-md":_(v)?"text-surface-500 hover:text-surface-400 hover:bg-surface-700/30":"text-surface-400 hover:text-surface-200 hover:bg-surface-700/50"}`),pt(V,"title",_(R).desc),ke(H,_(R).label)}),$(S,V)}),P(Y),P(ne);var fe=O(ne,4),ee=O(I(fe),2),he=I(ee);he.__click=()=>se(f,!_(f));var K=I(he),L=O(K);Wa(L,{class:"h-3.5 w-3.5"}),P(he);var be=O(he,2);{var ce=S=>{var R=Jg(),V=pe(R);V.__click=()=>se(f,!1);var H=O(V,2),U=I(H),Z=I(U),re=I(Z);Da(re),re.__keydown=Pe=>{Pe.key==="Enter"&&(x(),se(f,!1))};var Q=O(re,2);Q.__click=()=>{x(),se(f,!1)},P(Z),P(U);var ae=O(U,2);_t(ae,21,()=>c,Ct,(Pe,Ae)=>{var Ue=Zg();Ue.__click=()=>T(_(Ae).sizeMB);var Ke=I(Ue),De=I(Ke,!0);P(Ke);var Je=O(Ke,2),mt=I(Je,!0);P(Je);var tt=O(Je,2),gt=I(tt);P(tt),P(Ue),Te(()=>{at(Ue,1,`flex w-full items-center gap-3 rounded-lg px-3 py-2 text-sm transition-all ${le.settings.targetSizeMB===_(Ae).sizeMB?"bg-accent-start/20 text-accent-start":"text-surface-300 hover:bg-surface-700"}`),ke(De,_(Ae).icon),ke(mt,_(Ae).label),ke(gt,`${_(Ae).sizeMB??""} MB`)}),$(Pe,Ue)}),P(ae);var we=O(ae,2);{var ye=Pe=>{var Ae=Yg(),Ue=I(Ae);Ue.__click=A,P(Ae),$(Pe,Ae)};oe(we,Pe=>{_(v)&&Pe(ye)})}P(H),Id(re,()=>_(u),Pe=>se(u,Pe)),ut(3,H,()=>ja,()=>({duration:150})),$(S,R)};oe(be,S=>{_(f)&&S(ce)})}P(ee),P(fe);var j=O(fe,2);{var ie=S=>{var R=e0(),V=I(R);P(R),Te(()=>ke(V,`â†’ Compressing to ${le.settings.targetSizeMB??""} MB`)),$(S,R)};oe(j,S=>{_(v)&&S(ie)})}var me=O(j,4);_t(me,21,()=>a,Ct,(S,R)=>{const V=Ge(()=>_(R).value==="av1"&&!_(t)||_(R).value==="hevc"&&!_(i)),H=Ge(()=>_(R).value==="av1"||_(R).value==="hevc"),U=Ge(()=>_(R).value==="av1"&&_(t)||_(R).value==="hevc"&&_(i));var Z=i0();Z.__click=()=>!_(V)&&w(_(R).value);var re=I(Z),Q=O(re);{var ae=ye=>{var Pe=t0();$(ye,Pe)},we=ye=>{var Pe=_e(),Ae=pe(Pe);{var Ue=Ke=>{var De=r0();$(Ke,De)};oe(Ae,Ke=>{_(H)&&_(V)&&Ke(Ue)},!0)}$(ye,Pe)};oe(Q,ye=>{_(H)&&_(U)?ye(ae):ye(we,!1)})}P(Z),Te(()=>{Z.disabled=_(V),at(Z,1,`relative rounded-lg px-3 py-2.5 text-sm font-medium transition-all sm:py-1.5 ${le.settings.outputFormat===_(R).value?"bg-accent-start shadow-accent-start/30 text-white shadow-md":_(V)?"text-surface-600 cursor-not-allowed line-through opacity-40":"text-surface-400 hover:text-surface-200 hover:bg-surface-700/50"}`),pt(Z,"title",_(V)?`${_(R).label} requires hardware encoder (not available on this device)`:_(R).desc),ke(re,`${_(R).label??""} `)}),$(S,Z)}),P(me);var ge=O(me,4);ge.__click=()=>se(l,!_(l));var xe=I(ge);mo(xe,{class:"h-4 w-4"});var Re=O(xe,4);{var Be=S=>{Rd(S,{class:"h-3.5 w-3.5"})},st=S=>{Wa(S,{class:"h-3.5 w-3.5"})};oe(Re,S=>{_(l)?S(Be):S(st,!1)})}P(ge);var ct=O(ge,2);{var k=S=>{var R=n0();R.__click=G;var V=I(R);{var H=Z=>{var re=a0(),Q=pe(re);uo(Q,{class:"h-4 w-4 animate-spin"}),Ie(2),$(Z,re)},U=Z=>{var re=s0(),Q=pe(re);wn(Q,{class:"h-4 w-4"});var ae=O(Q,2),we=I(ae);P(ae),Te(()=>ke(we,`Compress (${_(h).length??""})`)),$(Z,re)};oe(V,Z=>{_(d)||_(p)?Z(H):Z(U,!1)})}P(R),Te(()=>R.disabled=_(d)||_(p)),$(S,R)},J=S=>{var R=_e(),V=pe(R);{var H=U=>{var Z=o0();Z.__click=C;var re=I(Z);{let we=Ge(()=>_(d)||_(p)?"animate-spin":"");uo(re,{get class(){return`h-4 w-4 ${_(we)??""}`}})}var Q=O(re,2),ae=I(Q,!0);P(Q),P(Z),Te(()=>{Z.disabled=_(d)||_(p),ke(ae,_(d)||_(p)?"Working...":"Re-compress")}),$(U,Z)};oe(V,U=>{_(m)&&U(H)},!0)}$(S,R)};oe(ct,S=>{_(g)?S(k):S(J,!1)})}P(q),P(y);var X=O(y,2);{var F=S=>{var R=g0(),V=I(R),H=I(V),U=I(H),Z=I(U);Gd(Z,{class:"text-surface-400 h-4 w-4"});var re=O(Z,4);Vs(re,{content:"Downscaling reduces file size significantly. 1080p is usually sufficient for most uses. Higher resolutions are best for archival or professional work."}),P(U);var Q=O(U,2);_t(Q,21,()=>cu,Ct,(Qe,Ye)=>{var $e=l0();$e.__click=()=>B(_(Ye).value);var je=I($e),nt=I(je,!0);P(je);var it=O(je,2);{var ot=It=>{var $t=c0(),ti=I($t,!0);P($t),Te(()=>ke(ti,_(Ye).pixels)),$(It,$t)};oe(it,It=>{_(Ye).pixels&&It(ot)})}P($e),Te(()=>{at($e,1,`rounded-lg px-3 py-2 text-left text-sm transition-all ${le.settings.resolution===_(Ye).value?"bg-accent-start/20 text-accent-start ring-accent-start/50 ring-1":"text-surface-400 hover:text-surface-200 hover:bg-surface-700/50"}`),ke(nt,_(Ye).label)}),$(Qe,$e)}),P(Q),P(H);var ae=O(H,2),we=I(ae),ye=I(we);Jd(ye,{class:"text-surface-400 h-4 w-4"});var Pe=O(ye,4);Vs(Pe,{content:"AAC is most compatible with all devices. Opus offers better quality at lower bitrates. Keep Original skips re-encoding for fastest processing."}),P(we);var Ae=O(we,2);_t(Ae,21,()=>n,Ct,(Qe,Ye)=>{var $e=d0();$e.__click=()=>z(_(Ye).value);var je=I($e),nt=I(je,!0);P(je);var it=O(je,2),ot=I(it,!0);P(it),P($e),Te(()=>{at($e,1,`rounded-lg px-3 py-2 text-left text-sm transition-all ${le.settings.audioCodec===_(Ye).value?"bg-accent-start/20 text-accent-start ring-accent-start/50 ring-1":"text-surface-400 hover:text-surface-200 hover:bg-surface-700/50"}`),ke(nt,_(Ye).label),ke(ot,_(Ye).desc)}),$(Qe,$e)}),P(Ae);var Ue=O(Ae,2);{var Ke=Qe=>{var Ye=f0(),$e=O(I(Ye),2);_t($e,21,()=>lu,Ct,(je,nt)=>{var it=u0();it.__click=()=>M(_(nt).value);var ot=I(it,!0);P(it),Te(()=>{at(it,1,`flex-1 rounded px-2 py-1.5 text-xs transition-all ${le.settings.audioBitrate===_(nt).value?"bg-accent-start text-white":"text-surface-400 hover:text-surface-200 hover:bg-surface-700/50"}`),pt(it,"title",_(nt).desc),ke(ot,_(nt).label)}),$(je,it)}),P($e),P(Ye),$(Qe,Ye)};oe(Ue,Qe=>{le.settings.audioCodec!=="none"&&le.settings.audioCodec!=="copy"&&Qe(Ke)})}P(ae);var De=O(ae,2),Je=I(De),mt=I(Je);_c(mt,{class:"text-surface-400 h-4 w-4"});var tt=O(mt,4);Vs(tt,{content:"Faster encoding produces larger files. Slower encoding achieves better compression at the same quality level. Use 'Quality' for final exports."}),P(Je);var gt=O(Je,2);_t(gt,21,()=>s,Ct,(Qe,Ye)=>{var $e=m0();$e.__click=()=>W(_(Ye).value);var je=I($e),nt=I(je),it=I(nt,!0);P(nt);var ot=O(nt,2),It=I(ot,!0);P(ot),P(je);var $t=O(je,2);_t($t,20,()=>Array(4),Ct,(ti,Pr,ri)=>{var Pa=h0();Te(()=>at(Pa,1,`h-3 w-1.5 rounded-sm ${ri<_(Ye).speed?"bg-green-500":"bg-surface-600"}`)),$(ti,Pa)}),P($t),P($e),Te(()=>{at($e,1,`flex w-full items-center justify-between rounded-lg px-3 py-2.5 text-sm transition-all ${le.settings.preset===_(Ye).value?"bg-accent-start/20 text-accent-start ring-accent-start/50 ring-1":"text-surface-400 hover:text-surface-200 hover:bg-surface-700/50"}`),ke(it,_(Ye).label),ke(It,_(Ye).desc)}),$(Qe,$e)}),P(gt),P(De);var jt=O(De,2),Jt=I(jt),ze=I(Jt);mo(ze,{class:"text-surface-400 h-4 w-4"}),Ie(2),P(Jt);var Ee=O(Jt,2),He=I(Ee),lt=I(He);Da(lt),lt.__change=Qe=>le.updateSettings({stripMetadata:Qe.currentTarget.checked}),Ie(2),P(He);var Nt=O(He,2),Ze=I(Nt);Da(Ze),Ze.__change=Qe=>le.updateSettings({twoPass:Qe.currentTarget.checked});var dt=O(Ze,2),sr=I(dt),qt=O(sr,2),ur=O(I(qt));{var xt=Qe=>{var Ye=p0();$(Qe,Ye)};oe(ur,Qe=>{le.settings.outputFormat==="webm"&&Qe(xt)})}P(qt),P(dt),P(Nt),P(Ee);var Bt=O(Ee,2),Tt=I(Bt),Pt=I(Tt);bn(Pt,{class:"text-surface-400 mt-0.5 h-4 w-4 flex-shrink-0"});var Et=O(Pt,2),vt=I(Et);{var bt=Qe=>{var Ye=yr(`AV1 offers 30-50% better compression than H.264. Requires modern hardware with AV1
									encoder.`);$(Qe,Ye)},nr=Qe=>{var Ye=_e(),$e=pe(Ye);{var je=it=>{var ot=yr(`HEVC/H.265 offers ~40% better compression than H.264. Wide hardware support on
									modern devices.`);$(it,ot)},nt=it=>{var ot=_e(),It=pe(ot);{var $t=Pr=>{var ri=yr("VP9 provides excellent compression for web delivery with wide browser support.");$(Pr,ri)},ti=Pr=>{var ri=yr("H.264/MP4 is the most compatible format, playable on virtually all devices.");$(Pr,ri)};oe(It,Pr=>{le.settings.outputFormat==="webm"?Pr($t):Pr(ti,!1)},!0)}$(it,ot)};oe($e,it=>{le.settings.outputFormat==="hevc"?it(je):it(nt,!1)},!0)}$(Qe,Ye)};oe(vt,Qe=>{le.settings.outputFormat==="av1"?Qe(bt):Qe(nr,!1)})}P(Et),P(Tt),P(Bt),P(jt),P(V),P(R),Te(()=>{so(lt,le.settings.stripMetadata),so(Ze,le.settings.twoPass),Ze.disabled=le.settings.outputFormat==="webm",at(sr,1,`text-surface-300 group-hover:text-surface-100 text-sm font-medium transition-colors ${le.settings.outputFormat==="webm"?"opacity-50":""}`)}),ut(3,R,()=>ja,()=>({duration:200})),$(S,R)};oe(X,S=>{_(l)&&S(F)})}P(N),Te(()=>{at(he,1,`flex items-center gap-1.5 rounded-lg px-3 py-2.5 text-sm font-medium transition-all sm:py-1.5 ${_(v)?"bg-accent-start shadow-accent-start/30 text-white shadow-md":"text-surface-400 hover:text-surface-200 hover:bg-surface-700/50"}`),ke(K,`${_(v)?`${le.settings.targetSizeMB} MB`:"Select..."} `)}),$(r,N),Zt()}Ht(["click","keydown","change"]);var w0=te('<div class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4" role="dialog" aria-modal="true" aria-labelledby="modal-title" tabindex="-1"><div class="glass w-full max-w-md rounded-2xl p-6 shadow-2xl"><div class="mb-4 flex items-start justify-between"><div class="flex items-center gap-3"><div class="flex h-10 w-10 items-center justify-center rounded-xl bg-red-500/20 text-red-500"><!></div> <h2 id="modal-title" class="text-surface-100 text-lg font-semibold"> </h2></div> <button class="text-surface-400 hover:bg-surface-700 hover:text-surface-100 rounded-lg p-2 transition-colors" aria-label="Close"><!></button></div> <p class="text-surface-400 mb-6"> </p> <div class="flex justify-end gap-3"><button class="bg-surface-700 text-surface-300 hover:bg-surface-600 rounded-xl px-5 py-2.5 text-sm font-medium transition-all">Cancel</button> <button class="rounded-xl bg-red-500 px-5 py-2.5 text-sm font-medium text-white shadow-lg shadow-red-500/30 transition-all hover:bg-red-600 hover:shadow-xl hover:shadow-red-500/40"> </button></div></div></div>');function k0(r,e){Xt(e,!0);let t=wr(e,"open",3,!1),i=wr(e,"title",3,"Confirm"),a=wr(e,"message",3,"Are you sure?"),n=wr(e,"confirmText",3,"Confirm");function s(u){u.key==="Escape"&&e.oncancel()}function o(u){u.target===u.currentTarget&&e.oncancel()}var c=_e(),l=pe(c);{var d=u=>{var f=w0();f.__click=o,f.__keydown=s;var h=I(f),g=I(h),m=I(g),p=I(m),v=I(p);xc(v,{class:"h-5 w-5"}),P(p);var b=O(p,2),w=I(b,!0);P(b),P(m);var x=O(m,2);x.__click=function(...C){e.oncancel?.apply(this,C)};var T=I(x);_r(T,{class:"h-5 w-5"}),P(x),P(g);var A=O(g,2),B=I(A,!0);P(A);var z=O(A,2),M=I(z);M.__click=function(...C){e.oncancel?.apply(this,C)};var W=O(M,2);W.__click=function(...C){e.onconfirm?.apply(this,C)};var G=I(W,!0);P(W),P(z),P(h),P(f),Te(()=>{ke(w,i()),ke(B,a()),ke(G,n())}),ut(3,h,()=>Ri,()=>({duration:200,start:.95})),ut(3,f,()=>Qt,()=>({duration:150})),$(u,f)};oe(l,u=>{t()&&u(d)})}$(r,c),Zt()}Ht(["click","keydown"]);var y0=te('<span class="text-surface-500">+</span>'),x0=te('<!> <kbd class="bg-surface-700 text-surface-200 min-w-[2rem] rounded-lg px-2.5 py-1.5 text-center text-sm font-medium shadow-sm"> </kbd>',1),_0=te('<div class="bg-surface-800/50 flex items-center justify-between rounded-lg px-4 py-3"><span class="text-surface-300"> </span> <div class="flex items-center gap-1.5"></div></div>'),T0=te('<div><h3 class="text-surface-400 mb-4 text-sm font-semibold uppercase tracking-wider"> </h3> <div class="space-y-3"></div></div>'),S0=te(`<div class="fixed inset-0 z-50 flex items-center justify-center p-4"><button class="absolute inset-0 cursor-default bg-black/80 backdrop-blur-sm" aria-label="Close shortcuts"></button> <div class="bg-surface-900 relative max-h-[85vh] w-full max-w-2xl overflow-auto rounded-2xl shadow-2xl ring-1 ring-white/10" role="dialog" aria-modal="true" aria-labelledby="shortcuts-title" tabindex="-1"><div class="border-surface-700/50 bg-surface-900/95 sticky top-0 z-10 flex items-center justify-between border-b p-6 backdrop-blur-sm"><div class="flex items-center gap-3"><div class="from-accent-start/20 to-accent-end/20 text-accent-start flex h-10 w-10 items-center justify-center rounded-xl bg-gradient-to-br"><!></div> <h2 id="shortcuts-title" class="text-surface-100 text-xl font-bold">Keyboard Shortcuts</h2></div> <button class="text-surface-400 hover:bg-surface-800 hover:text-surface-200 rounded-lg p-2 transition-colors" aria-label="Close"><!></button></div> <div class="space-y-8 p-6"></div> <div class="border-surface-700/50 bg-surface-900/95 sticky bottom-0 border-t p-4 text-center backdrop-blur-sm"><p class="text-surface-500 text-sm">Press <kbd class="bg-surface-700 text-surface-300 rounded px-2 py-0.5">?</kbd> anytime to show
					this help</p></div></div></div>`);function C0(r,e){Xt(e,!0);let t=We(void 0);qi(()=>{if(e.open&&_(t))return eo(_(t))});const i=[{category:"General",items:[{keys:["Cmd/Ctrl","Shift","D"],action:"Download all as ZIP"},{keys:["Cmd/Ctrl","V"],action:"Paste video from clipboard"},{keys:["Escape"],action:"Clear all videos / Close modal"},{keys:["?"],action:"Show keyboard shortcuts"}]},{category:"Quality Presets",items:[{keys:["1"],action:"Tiny quality preset"},{keys:["2"],action:"Web quality preset"},{keys:["3"],action:"Social quality preset"},{keys:["4"],action:"High quality preset"},{keys:["5"],action:"Lossless quality preset"}]},{category:"Output Format",items:[{keys:["M"],action:"Switch to MP4 format"},{keys:["W"],action:"Switch to WebM format"},{keys:["A"],action:"Switch to AV1 format"}]},{category:"Navigation",items:[{keys:["Tab"],action:"Navigate between elements"},{keys:["Enter"],action:"Activate focused element"},{keys:["Space"],action:"Play/pause preview"}]}];function a(c){c.key==="Escape"&&e.onclose()}var n=_e(),s=pe(n);{var o=c=>{var l=S0(),d=I(l);d.__click=function(...w){e.onclose?.apply(this,w)};var u=O(d,2);u.__keydown=a;var f=I(u),h=I(f),g=I(h),m=I(g);kc(m,{class:"h-5 w-5"}),P(g),Ie(2),P(h);var p=O(h,2);p.__click=function(...w){e.onclose?.apply(this,w)};var v=I(p);_r(v,{class:"h-5 w-5"}),P(p),P(f);var b=O(f,2);_t(b,21,()=>i,Ct,(w,x)=>{var T=T0(),A=I(T),B=I(A,!0);P(A);var z=O(A,2);_t(z,21,()=>_(x).items,Ct,(M,W)=>{var G=_0(),C=I(G),N=I(C,!0);P(C);var y=O(C,2);_t(y,21,()=>_(W).keys,Ct,(q,ne,Y)=>{var fe=x0(),ee=pe(fe);{var he=be=>{var ce=y0();$(be,ce)};oe(ee,be=>{Y>0&&be(he)})}var K=O(ee,2),L=I(K,!0);P(K),Te(()=>ke(L,_(ne))),$(q,fe)}),P(y),P(G),Te(()=>ke(N,_(W).action)),$(M,G)}),P(z),P(T),Te(()=>ke(B,_(x).category)),$(w,T)}),P(b),Ie(2),P(u),Vi(u,w=>se(t,w),()=>_(t)),P(l),ut(3,u,()=>Ri,()=>({duration:200,start:.95})),ut(3,l,()=>Qt,()=>({duration:150})),$(c,l)};oe(s,c=>{e.open&&c(o)})}$(r,n),Zt()}Ht(["click","keydown"]);var P0=te('<div class="p-6 text-center"><div class="border-accent-start mx-auto h-8 w-8 animate-spin rounded-full border-2 border-t-transparent"></div> <p class="text-surface-400 mt-2 text-sm">Detecting capabilities...</p></div>'),E0=te('<span class="flex items-center gap-1 text-xs font-medium text-green-400"><!> Available</span>'),I0=te('<span class="text-surface-500 flex items-center gap-1 text-xs"><!> Not supported</span>'),A0=te('<span class="font-medium text-green-400">GPU Enabled ðŸš€</span>'),F0=te('<span class="text-amber-400">Software only</span>'),B0=te('<div class="space-y-1.5 text-xs"><div class="flex items-center justify-between"><span class="text-surface-400">Hardware Acceleration</span> <!></div> <div class="flex items-center justify-between"><span class="text-surface-400">Video Codecs</span> <span class="text-surface-200"> </span></div> <div class="flex items-center justify-between"><span class="text-surface-400">Max Resolution</span> <span class="text-surface-200"> </span></div></div>'),z0=te('<span class="flex items-center gap-1 text-xs font-medium text-green-400"><!> Loaded</span>'),M0=te('<span class="text-xs text-amber-400">Loading...</span>'),R0=te('<span class="text-surface-500 text-xs">Not loaded</span>'),D0=te('<div class="space-y-1.5 text-xs"><div class="flex items-center justify-between"><span class="text-surface-400">Threading</span> <span class="text-surface-200"> </span></div> <div class="flex items-center justify-between"><span class="text-surface-400">Codecs</span> <span class="text-surface-200">H.264, VP9, AV1, AAC, Opus</span></div></div>'),O0=te('<span class="flex items-center gap-1 text-xs text-green-400"><!> Yes</span>'),N0=te('<span class="flex items-center gap-1 text-xs text-amber-400"><!> No</span>'),U0=te('<div class="flex items-center gap-1.5 rounded-md border border-purple-500/20 bg-purple-500/10 px-2 py-1"><!> <span class="text-xs text-purple-300"> </span></div>'),V0=te('<div class="flex items-center gap-1.5 rounded-md border border-orange-500/20 bg-orange-500/10 px-2 py-1"><!> <span class="text-xs text-orange-300"> </span></div>'),L0=te('<div class="border-surface-700/50 mt-2 border-t pt-2"><div class="text-surface-400 mb-2 text-xs uppercase tracking-wider">Encoder Usage</div> <div class="flex gap-3"><!> <!></div></div>'),$0=te('<div class="flex items-center justify-between"><span class="text-surface-300 text-sm">Total saved</span> <span class="font-mono text-sm text-green-400"> </span></div> <div class="flex items-center justify-between"><span class="text-surface-300 text-sm">Avg. savings</span> <span class="text-accent-start font-mono text-sm"> </span></div> <div class="flex items-center justify-between"><span class="text-surface-300 text-sm">Avg. time</span> <span class="text-surface-200 font-mono text-sm"> </span></div> <!>',1),W0=te('<div class="border-surface-700/50 border-b p-4"><h4 class="text-surface-400 mb-3 text-xs font-semibold uppercase tracking-wider">Encoders</h4> <div class="bg-surface-800/50 mb-2 rounded-lg p-3"><div class="mb-2 flex items-center justify-between"><div class="flex items-center gap-2"><!> <span class="text-surface-200 text-sm font-medium">WebCodecs</span></div> <!></div> <!></div> <div class="bg-surface-800/50 rounded-lg p-3"><div class="mb-2 flex items-center justify-between"><div class="flex items-center gap-2"><!> <span class="text-surface-200 text-sm font-medium">FFmpeg.wasm</span></div> <!></div> <!></div></div> <div class="border-surface-700/50 border-b p-4"><h4 class="text-surface-400 mb-3 text-xs font-semibold uppercase tracking-wider">System</h4> <div class="space-y-2"><div class="flex items-center justify-between"><div class="text-surface-300 flex items-center gap-2 text-sm"><!> CPU Threads</div> <span class="text-surface-200 font-mono text-sm"> </span></div> <div class="flex items-center justify-between"><div class="text-surface-300 flex items-center gap-2 text-sm"><!> Device Memory</div> <span class="text-surface-200 font-mono text-sm"> </span></div> <div class="flex items-center justify-between"><div class="text-surface-300 flex items-center gap-2 text-sm"><!> SharedArrayBuffer</div> <!></div></div></div> <div class="p-4"><h4 class="text-surface-400 mb-3 text-xs font-semibold uppercase tracking-wider">Session Stats</h4> <div class="space-y-2"><div class="flex items-center justify-between"><span class="text-surface-300 text-sm">Videos processed</span> <span class="text-surface-200 font-mono text-sm"> </span></div> <!></div></div> <div class="px-4 pb-4"><div class="rounded-lg border border-purple-500/20 bg-gradient-to-r from-purple-500/10 to-orange-500/10 p-3"><p class="text-surface-300 text-xs"><span class="font-medium text-purple-400">Hybrid Mode:</span> <!></p></div></div>',1),H0=te('<div class="bg-surface-900 fixed bottom-4 right-4 z-40 w-96 overflow-hidden rounded-2xl shadow-2xl ring-1 ring-white/10"><div class="border-surface-700/50 from-surface-900 to-surface-800 flex items-center justify-between border-b bg-gradient-to-r px-4 py-3"><div class="flex items-center gap-2"><!> <span class="text-surface-200 text-sm font-semibold">Performance Monitor</span></div> <button class="text-surface-400 hover:bg-surface-800 hover:text-surface-200 rounded p-1 transition-colors" aria-label="Close"><!></button></div> <!></div>');function j0(r,e){Xt(e,!0);let t=We(null),i=We(!0);xa(async()=>{try{se(t,await Lp(),!0)}catch(d){console.error("Failed to get capabilities:",d)}finally{se(i,!1)}});const a=Ge(()=>()=>{const d=le.items.filter(v=>v.status==="completed"),u=d.reduce((v,b)=>v+b.originalSize,0),f=d.reduce((v,b)=>v+(b.compressedSize||0),0),h=d.length>0?d.reduce((v,b)=>v+(b.compressionDuration||0),0)/d.length:0,g=u>0?Math.round((1-f/u)*100):0,m=d.filter(v=>v.encoderUsed==="webcodecs").length,p=d.filter(v=>v.encoderUsed==="ffmpeg").length;return{totalProcessed:d.length,totalOriginal:u,totalCompressed:f,totalSaved:u-f,avgCompressionTime:h,avgSavings:g,webCodecsCount:m,ffmpegCount:p}});function n(d){if(d===0)return"0 B";const u=1024,f=["B","KB","MB","GB"],h=Math.floor(Math.log(d)/Math.log(u));return parseFloat((d/Math.pow(u,h)).toFixed(1))+" "+f[h]}function s(d){return d<1e3?`${Math.round(d)}ms`:`${(d/1e3).toFixed(1)}s`}var o=_e(),c=pe(o);{var l=d=>{var u=H0(),f=I(u),h=I(f),g=I(h);vc(g,{class:"text-accent-start h-4 w-4"}),Ie(2),P(h);var m=O(h,2);m.__click=function(...x){e.onclose?.apply(this,x)};var p=I(m);_r(p,{class:"h-4 w-4"}),P(m),P(f);var v=O(f,2);{var b=x=>{var T=P0();$(x,T)},w=x=>{var T=_e(),A=pe(T);{var B=z=>{var M=W0(),W=pe(M),G=O(I(W),2),C=I(G),N=I(C),y=I(N);js(y,{class:"h-4 w-4 text-purple-400"}),Ie(2),P(N);var q=O(N,2);{var ne=ze=>{var Ee=E0(),He=I(Ee);la(He,{class:"h-3 w-3"}),Ie(),P(Ee),$(ze,Ee)},Y=ze=>{var Ee=I0(),He=I(Ee);_r(He,{class:"h-3 w-3"}),Ie(),P(Ee),$(ze,Ee)};oe(q,ze=>{_(t).webCodecs.supported?ze(ne):ze(Y,!1)})}P(C);var fe=O(C,2);{var ee=ze=>{var Ee=B0(),He=I(Ee),lt=O(I(He),2);{var Nt=Tt=>{var Pt=A0();$(Tt,Pt)},Ze=Tt=>{var Pt=F0();$(Tt,Pt)};oe(lt,Tt=>{_(t).webCodecs.hardwareAcceleration?Tt(Nt):Tt(Ze,!1)})}P(He);var dt=O(He,2),sr=O(I(dt),2),qt=I(sr,!0);P(sr),P(dt);var ur=O(dt,2),xt=O(I(ur),2),Bt=I(xt);P(xt),P(ur),P(Ee),Te(Tt=>{ke(qt,Tt),ke(Bt,`${_(t).webCodecs.maxResolution.width??""}Ã—${_(t).webCodecs.maxResolution.height??""}`)},[()=>_(t).webCodecs.supportedVideoCodecs.map(Tt=>Tt.toUpperCase()).join(", ")]),$(ze,Ee)};oe(fe,ze=>{_(t).webCodecs.supported&&ze(ee)})}P(G);var he=O(G,2),K=I(he),L=I(K),be=I(L);ho(be,{class:"h-4 w-4 text-orange-400"}),Ie(2),P(L);var ce=O(L,2);{var j=ze=>{var Ee=z0(),He=I(Ee);la(He,{class:"h-3 w-3"}),Ie(),P(Ee),$(ze,Ee)},ie=ze=>{var Ee=_e(),He=pe(Ee);{var lt=Ze=>{var dt=M0();$(Ze,dt)},Nt=Ze=>{var dt=R0();$(Ze,dt)};oe(He,Ze=>{le.ffmpegLoading?Ze(lt):Ze(Nt,!1)},!0)}$(ze,Ee)};oe(ce,ze=>{_(t).ffmpegLoaded?ze(j):ze(ie,!1)})}P(K);var me=O(K,2);{var ge=ze=>{var Ee=D0(),He=I(Ee),lt=O(I(He),2),Nt=I(lt,!0);P(lt),P(He),Ie(2),P(Ee),Te(()=>ke(Nt,_(t).ffmpegMultiThreaded?"Multi-threaded":"Single-threaded")),$(ze,Ee)};oe(me,ze=>{_(t).ffmpegLoaded&&ze(ge)})}P(he),P(W);var xe=O(W,2),Re=O(I(xe),2),Be=I(Re),st=I(Be),ct=I(st);Hs(ct,{class:"text-surface-500 h-4 w-4"}),Ie(),P(st);var k=O(st,2),J=I(k,!0);P(k),P(Be);var X=O(Be,2),F=I(X),S=I(F);$d(S,{class:"text-surface-500 h-4 w-4"}),Ie(),P(F);var R=O(F,2),V=I(R);P(R),P(X);var H=O(X,2),U=I(H),Z=I(U);_c(Z,{class:"text-surface-500 h-4 w-4"}),Ie(),P(U);var re=O(U,2);{var Q=ze=>{var Ee=O0(),He=I(Ee);la(He,{class:"h-3 w-3"}),Ie(),P(Ee),$(ze,Ee)},ae=ze=>{var Ee=N0(),He=I(Ee);_r(He,{class:"h-3 w-3"}),Ie(),P(Ee),$(ze,Ee)};oe(re,ze=>{_(t).sharedArrayBuffer?ze(Q):ze(ae,!1)})}P(H),P(Re),P(xe);var we=O(xe,2),ye=O(I(we),2),Pe=I(ye),Ae=O(I(Pe),2),Ue=I(Ae,!0);P(Ae),P(Pe);var Ke=O(Pe,2);{var De=ze=>{var Ee=$0(),He=pe(Ee),lt=O(I(He),2),Nt=I(lt,!0);P(lt),P(He);var Ze=O(He,2),dt=O(I(Ze),2),sr=I(dt);P(dt),P(Ze);var qt=O(Ze,2),ur=O(I(qt),2),xt=I(ur,!0);P(ur),P(qt);var Bt=O(qt,2);{var Tt=Pt=>{var Et=L0(),vt=O(I(Et),2),bt=I(vt);{var nr=$e=>{var je=U0(),nt=I(je);js(nt,{class:"h-3 w-3 text-purple-400"});var it=O(nt,2),ot=I(it);P(it),P(je),Te(It=>ke(ot,`${It??""} GPU`),[()=>_(a)().webCodecsCount]),$($e,je)};oe(bt,$e=>{_(a)().webCodecsCount>0&&$e(nr)})}var Qe=O(bt,2);{var Ye=$e=>{var je=V0(),nt=I(je);ho(nt,{class:"h-3 w-3 text-orange-400"});var it=O(nt,2),ot=I(it);P(it),P(je),Te(It=>ke(ot,`${It??""} Software`),[()=>_(a)().ffmpegCount]),$($e,je)};oe(Qe,$e=>{_(a)().ffmpegCount>0&&$e(Ye)})}P(vt),P(Et),$(Pt,Et)};oe(Bt,Pt=>{(_(a)().webCodecsCount>0||_(a)().ffmpegCount>0)&&Pt(Tt)})}Te((Pt,Et,vt)=>{ke(Nt,Pt),ke(sr,`${Et??""}%`),ke(xt,vt)},[()=>n(_(a)().totalSaved),()=>_(a)().avgSavings,()=>s(_(a)().avgCompressionTime)]),$(ze,Ee)};oe(Ke,ze=>{_(a)().totalProcessed>0&&ze(De)})}P(ye),P(we);var Je=O(we,2),mt=I(Je),tt=I(mt),gt=O(I(tt),2);{var jt=ze=>{var Ee=yr("Using GPU acceleration for MP4/WebM, FFmpeg for AV1 and complex operations.");$(ze,Ee)},Jt=ze=>{var Ee=_e(),He=pe(Ee);{var lt=Ze=>{var dt=yr("WebCodecs available (software). FFmpeg used as primary encoder.");$(Ze,dt)},Nt=Ze=>{var dt=yr("FFmpeg.wasm handles all encoding (software).");$(Ze,dt)};oe(He,Ze=>{_(t).webCodecs.supported?Ze(lt):Ze(Nt,!1)},!0)}$(ze,Ee)};oe(gt,ze=>{_(t).webCodecs.supported&&_(t).webCodecs.hardwareAcceleration?ze(jt):ze(Jt,!1)})}P(tt),P(mt),P(Je),Te(ze=>{ke(J,_(t).hardwareConcurrency),ke(V,`${_(t).deviceMemory??""} GB`),ke(Ue,ze)},[()=>_(a)().totalProcessed]),$(z,M)};oe(A,z=>{_(t)&&z(B)},!0)}$(x,T)};oe(v,x=>{_(i)?x(b):x(w,!1)})}P(u),ut(3,u,()=>ja,()=>({duration:200})),$(d,u)};oe(c,d=>{e.open&&d(l)})}$(r,o),Zt()}Ht(["click"]);var q0=te('<div class="bg-surface-800/50 flex items-start gap-4 rounded-xl p-4"><div><!></div> <div><div class="flex items-center gap-2"><span class="bg-surface-700 text-surface-300 flex h-5 w-5 items-center justify-center rounded-full text-xs font-bold"></span> <h3 class="text-surface-200 font-semibold"> </h3></div> <p class="text-surface-400 mt-1 text-sm"> </p></div></div>'),K0=te(`<div class="fixed inset-0 z-50 flex items-center justify-center p-4"><button class="absolute inset-0 cursor-default bg-black/80 backdrop-blur-sm" aria-label="Close onboarding"></button> <div class="bg-surface-900 relative w-full max-w-2xl overflow-hidden rounded-2xl shadow-2xl ring-1 ring-white/10" role="dialog" aria-modal="true" aria-labelledby="onboarding-title" tabindex="-1"><div class="relative p-6 pb-4 text-center"><button class="text-surface-400 hover:bg-surface-800 hover:text-surface-200 absolute right-4 top-4 rounded-lg p-2 transition-colors" aria-label="Close"><!></button> <h2 id="onboarding-title" class="text-surface-100 text-2xl font-bold">Welcome to <span class="gradient-text">Squash</span></h2> <p class="text-surface-400 mt-2">GPU-accelerated video compression that's 100% private</p></div> <div class="px-6 pb-4"><div class="grid gap-4 sm:grid-cols-2"></div></div> <div class="border-surface-700/50 bg-surface-900/50 flex items-center justify-between border-t px-6 py-4"><label class="flex cursor-pointer items-center gap-2"><input type="checkbox" class="bg-surface-700 border-surface-600 text-accent-start focus:ring-accent-start focus:ring-offset-surface-900 h-4 w-4 rounded"/> <span class="text-surface-400 text-sm">Don't show this again</span></label> <button class="from-accent-start to-accent-end shadow-accent-start/30 hover:shadow-accent-start/40 rounded-xl bg-gradient-to-r px-6 py-2.5 text-sm font-semibold text-white shadow-lg transition-all hover:shadow-xl">Get Started</button></div></div></div>`);function G0(r,e){Xt(e,!0);let t=We(!1),i=We(void 0);qi(()=>{if(e.open&&_(i))return eo(_(i))});const a=[{icon:qs,title:"Drop your videos",desc:"Drag files onto the drop zone, click to browse, or paste with Cmd+V. Supports MP4, WebM, MOV, and AVI.",color:"from-orange-500 to-red-500"},{icon:Xd,title:"Choose settings",desc:"Pick a quality preset or set a target file size for platforms like WhatsApp or Discord.",color:"from-blue-500 to-cyan-500"},{icon:wn,title:"Compress",desc:"Click the Compress button. GPU acceleration makes it blazing fast. Watch real-time progress.",color:"from-green-500 to-emerald-500"},{icon:Ha,title:"Download",desc:"Download individual files or get everything as a ZIP. Drag compressed videos directly to your desktop.",color:"from-purple-500 to-pink-500"}];function n(){e.onclose(_(t))}function s(d){d.key==="Escape"&&n()}var o=_e(),c=pe(o);{var l=d=>{var u=K0(),f=I(u);f.__click=n;var h=O(f,2);h.__keydown=s;var g=I(h),m=I(g);m.__click=n;var p=I(m);_r(p,{class:"h-5 w-5"}),P(m),Ie(4),P(g);var v=O(g,2),b=I(v);_t(b,21,()=>a,Ct,(B,z,M)=>{var W=q0(),G=I(W),C=I(G);vn(C,()=>_(z).icon,(he,K)=>{K(he,{class:"h-5 w-5 text-white"})}),P(G);var N=O(G,2),y=I(N),q=I(y);q.textContent=M+1;var ne=O(q,2),Y=I(ne,!0);P(ne),P(y);var fe=O(y,2),ee=I(fe,!0);P(fe),P(N),P(W),Te(()=>{at(G,1,`flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-xl bg-gradient-to-br ${_(z).color??""}`),ke(Y,_(z).title),ke(ee,_(z).desc)}),$(B,W)}),P(b),P(v);var w=O(v,2),x=I(w),T=I(x);Da(T),Ie(2),P(x);var A=O(x,2);A.__click=n,P(w),P(h),Vi(h,B=>se(i,B),()=>_(i)),P(u),Ad(T,()=>_(t),B=>se(t,B)),ut(3,h,()=>Ri,()=>({duration:200,start:.95})),ut(3,u,()=>Qt,()=>({duration:150})),$(d,u)};oe(c,d=>{e.open&&d(l)})}$(r,o),Zt()}Ht(["click","keydown"]);var Q0=te('<div class="mb-6 flex items-center gap-3 rounded-2xl border border-amber-500/30 bg-amber-500/10 p-4 sm:p-5"><!> <div><h3 class="font-semibold text-amber-400">Browser Not Supported</h3> <p class="mt-1 text-sm text-amber-300/80"> <strong>Chrome</strong>, <strong>Edge</strong>, or <strong>Safari 16.4+</strong> for the best experience.</p></div></div>'),X0=te('<div class="glass group flex flex-col items-center gap-3 rounded-2xl p-4 text-center transition-all hover:scale-[1.02] sm:p-5"><div class="from-accent-start/20 to-accent-end/20 text-accent-start flex h-11 w-11 flex-shrink-0 items-center justify-center rounded-xl bg-gradient-to-br"><!></div> <div><h3 class="text-surface-100 text-sm font-semibold"> </h3> <p class="text-surface-500 mt-1 text-xs leading-relaxed"> </p></div></div>'),Z0=te('<div class="mb-8 text-center sm:mb-12"><div class="bg-accent-start/10 text-accent-start mb-4 inline-flex items-center gap-2 rounded-full px-4 py-1.5 text-sm font-medium"><!> GPU-Accelerated â€¢ Free & Open Source</div> <h1 class="mb-4 text-4xl font-bold tracking-tight sm:text-5xl lg:text-6xl"><span class="gradient-text">Compress</span> videos <br class="hidden sm:block"/> <span class="text-surface-400">at warp speed</span></h1> <p class="text-surface-500 mx-auto mb-8 max-w-2xl text-base leading-relaxed sm:text-lg">GPU-accelerated video compression powered by <a href="https://mediabunny.dev" target="_blank" rel="noopener" class="text-accent-start hover:underline">Mediabunny</a> + WebCodecs. <span class="text-surface-300 font-medium">100% private</span> â€” everything runs locally in your browser.</p> <div class="mx-auto mb-10 max-w-3xl"><!></div> <div class="text-surface-500 mb-8 flex items-center justify-center gap-2"><!> <span class="text-sm">Or press <kbd class="bg-surface-800 text-surface-300 rounded px-2 py-0.5">Cmd+V</kbd> to paste from clipboard</span></div> <div class="mb-10 flex items-center justify-center gap-3 sm:gap-4"><div class="flex flex-col items-center"><div class="bg-surface-800/80 border-surface-700/50 rounded-xl border p-3"><!></div> <span class="text-surface-500 mt-1.5 text-[10px]">Your Video</span></div> <div class="flex items-center gap-1.5 sm:gap-2"><!> <div class="rounded-full border border-green-500/30 bg-green-500/15 px-2.5 py-1"><span class="text-xs font-medium text-green-400">Stays Local</span></div> <!></div> <div class="flex flex-col items-center"><div class="from-accent-start to-accent-end shadow-accent-start/20 rounded-xl bg-gradient-to-br p-3 shadow-lg"><!></div> <span class="text-surface-500 mt-1.5 text-[10px]">Compressed</span></div></div> <div class="mx-auto grid max-w-5xl grid-cols-2 gap-4 sm:gap-5 lg:grid-cols-4"></div></div>'),Y0=te('<div class="flex items-center gap-4"><div class="text-surface-500 text-base">Saved: <span class="text-accent-start font-mono text-lg font-semibold"> </span></div> <span class="rounded-full bg-green-500/10 px-3 py-1 text-sm font-bold text-green-500"> </span></div>'),J0=te('<button class="from-accent-start to-accent-end shadow-accent-start/30 hover:shadow-accent-start/40 flex items-center gap-2 rounded-xl bg-gradient-to-r px-5 py-2.5 text-sm font-medium text-white shadow-lg transition-all hover:scale-105 hover:shadow-xl"><!> <span class="hidden sm:inline">Download All</span> <span class="sm:hidden">ZIP</span></button>'),ev=te('<div class="glass mb-6 flex flex-wrap items-center justify-between gap-4 rounded-2xl p-4 sm:mb-8 sm:gap-6 sm:p-6"><div class="flex flex-wrap items-center gap-4 sm:gap-8"><div class="flex items-center gap-3"><!> <span class="text-surface-500 text-base"><span class="text-surface-100 text-lg font-semibold"> </span> </span></div> <!></div> <div class="flex items-center gap-3"><button title="Performance monitor (P)"><!> <span class="hidden sm:inline">Stats</span></button> <button class="bg-surface-800 text-surface-400 hover:bg-surface-700 hover:text-surface-200 flex items-center gap-2 rounded-xl px-4 py-2.5 text-sm font-medium transition-all" title="Keyboard shortcuts (?)"><!> <span class="hidden sm:inline">Shortcuts</span></button> <!> <button class="bg-surface-800 text-surface-400 flex items-center gap-2 rounded-xl px-5 py-2.5 text-sm font-medium transition-all hover:bg-red-900/20 hover:text-red-400" title="Press Escape to clear"><!> <span class="hidden sm:inline">Clear All</span></button></div></div>'),tv=te('<div class="flex min-h-screen flex-col"><!> <div class="fixed inset-0 -z-10 overflow-hidden"><div class="from-accent-start/10 to-accent-end/10 absolute -right-1/4 -top-1/2 h-[800px] w-[800px] rounded-full bg-gradient-to-br blur-3xl"></div> <div class="from-accent-end/10 to-accent-start/10 absolute -bottom-1/2 -left-1/4 h-[600px] w-[600px] rounded-full bg-gradient-to-tr blur-3xl"></div></div> <main class="flex-1 px-4 pb-8 pt-24 sm:px-6 sm:pb-12 sm:pt-28 lg:px-8"><div class="mx-auto max-w-7xl"><!> <!> <!> <!> <!> <!></div></main> <!></div> <!> <!> <!> <!> <!>',1);function uv(r,e){Xt(e,!0);let t=We(!1),i=We(!1),a=We(!1),n=We(!1),s=We(!0),o=We("");const c=Ge(()=>le.items.length>0),l=Ge(()=>le.items.filter(j=>j.status==="completed").length),d=Ge(()=>le.items.filter(j=>j.status==="completed"&&j.compressedSize).reduce((j,ie)=>j+(ie.originalSize-(ie.compressedSize||0)),0)),u=Ge(()=>le.items.length>0&&Math.round(_(d)/le.items.filter(j=>j.status==="completed").reduce((j,ie)=>j+ie.originalSize,0)*100)||0);function f(j,ie="info"){ie==="success"?Ua.success(j):ie==="error"?Ua.error(j):Ua.info(j)}async function h(){const j=le.items.filter(ie=>ie.status==="completed"&&ie.compressedBlob);j.length>0&&(await Hp(j),f(`Downloaded ${j.length} videos as ZIP`,"success"))}async function g(j){const ie=j.clipboardData?.items;if(!ie)return;const me=[];for(const ge of ie)if(ge.type.startsWith("video/")){const xe=ge.getAsFile();xe&&me.push(xe)}if(me.length>0){j.preventDefault();const ge=await le.addFiles(me);ge.length>0&&f(`Added ${ge.length} video(s) â€” click Compress when ready`,"success")}}function m(j){if(j.target instanceof HTMLInputElement||j.target instanceof HTMLTextAreaElement||j.target instanceof HTMLSelectElement)return;const ie=j.metaKey||j.ctrlKey;if(ie&&j.shiftKey&&j.key.toLowerCase()==="d"){j.preventDefault(),h();return}if(j.key==="Escape"){_(i)?se(i,!1):_(a)?se(a,!1):_(c)&&se(t,!0);return}if(j.key==="?"||j.shiftKey&&j.key==="/"){j.preventDefault(),se(i,!0);return}const me={1:"tiny",2:"web",3:"social",4:"high",5:"lossless"};if(me[j.key]){j.preventDefault(),le.updateSettings({quality:me[j.key]}),f(`Quality: ${is[me[j.key]].label}`,"info");return}if(j.key.toLowerCase()==="m"&&!ie){j.preventDefault(),le.updateSettings({outputFormat:"mp4"}),f("Format: MP4","info");return}if(j.key.toLowerCase()==="w"&&!ie){j.preventDefault(),le.updateSettings({outputFormat:"webm"}),f("Format: WebM","info");return}if(j.key.toLowerCase()==="p"&&!ie){j.preventDefault(),se(a,!_(a));return}}xa(()=>{const j=Rp();j.supported||(se(s,!1),se(o,j.reason||"WebCodecs not supported",!0)),localStorage.getItem("squash-onboarding-seen")||se(n,!0),setTimeout(()=>{$p().then(ie=>{ie&&console.log("WebCodecs encoder ready")})},500)});function p(j){j&&localStorage.setItem("squash-onboarding-seen","true"),se(n,!1)}const v=[{icon:Hs,title:"GPU Accelerated",description:"Up to 100x faster with WebCodecs hardware encoding"},{icon:yc,title:"100% Private",description:"Videos never leave your device â€” zero server uploads"},{icon:Vd,title:"Pro Codecs",description:"H.264, H.265/HEVC, VP9, AV1, AAC, Opus"},{icon:jd,title:"Pure WebCodecs",description:"Powered by Mediabunny â€” tiny bundle, instant start"}];var b=tv();St("keydown",ca,m),St("paste",ca,g);var w=pe(b),x=I(w);au(x,{});var T=O(x,4),A=I(T),B=I(A);{var z=j=>{var ie=Q0(),me=I(ie);xc(me,{class:"h-6 w-6 flex-shrink-0 text-amber-500"});var ge=O(me,2),xe=O(I(ge),2),Re=I(xe);Ie(6),P(xe),P(ge),P(ie),Te(()=>ke(Re,`${_(o)??""} Please use `)),ut(1,ie,()=>Qt,()=>({duration:200})),$(j,ie)};oe(B,j=>{_(s)||j(z)})}var M=O(B,2);{var W=j=>{var ie=Z0(),me=I(ie),ge=I(me);Hs(ge,{class:"h-4 w-4"}),Ie(),P(me);var xe=O(me,6),Re=I(xe);bo(Re,{}),P(xe);var Be=O(xe,2),st=I(Be);Dd(st,{class:"h-4 w-4"}),Ie(2),P(Be);var ct=O(Be,2),k=I(ct),J=I(k),X=I(J);Li(X,{class:"text-surface-400 h-5 w-5"}),P(J),Ie(2),P(k);var F=O(k,2),S=I(F);Ws(S,{class:"text-surface-600 h-4 w-4"});var R=O(S,4);Ws(R,{class:"text-surface-600 h-4 w-4"}),P(F);var V=O(F,2),H=I(V),U=I(H);Ha(U,{class:"h-5 w-5 text-white"}),P(H),Ie(2),P(V),P(ct);var Z=O(ct,2);_t(Z,21,()=>v,Ct,(re,Q,ae)=>{var we=X0(),ye=I(we),Pe=I(ye);vn(Pe,()=>_(Q).icon,(mt,tt)=>{tt(mt,{class:"h-5 w-5"})}),P(ye);var Ae=O(ye,2),Ue=I(Ae),Ke=I(Ue,!0);P(Ue);var De=O(Ue,2),Je=I(De,!0);P(De),P(Ae),P(we),Te(()=>{ke(Ke,_(Q).title),ke(Je,_(Q).description)}),ut(1,we,()=>Tc,()=>({y:20,delay:100*ae,duration:300})),$(re,we)}),P(Z),P(ie),ut(1,ie,()=>Qt,()=>({duration:300})),$(j,ie)};oe(M,j=>{_(c)||j(W)})}var G=O(M,2);{var C=j=>{var ie=ev(),me=I(ie),ge=I(me),xe=I(ge);Li(xe,{class:"text-accent-start h-6 w-6"});var Re=O(xe,2),Be=I(Re),st=I(Be,!0);P(Be);var ct=O(Be);P(Re),P(ge);var k=O(ge,2);{var J=Q=>{var ae=Y0(),we=I(ae),ye=O(I(we)),Pe=I(ye,!0);P(ye),P(we);var Ae=O(we,2),Ue=I(Ae);P(Ae),P(ae),Te(Ke=>{ke(Pe,Ke),ke(Ue,`-${_(u)??""}%`)},[()=>mn(_(d))]),$(Q,ae)};oe(k,Q=>{_(d)>0&&Q(J)})}P(me);var X=O(me,2),F=I(X);F.__click=()=>se(a,!_(a));var S=I(F);vc(S,{class:"h-4 w-4"}),Ie(2),P(F);var R=O(F,2);R.__click=()=>se(i,!0);var V=I(R);kc(V,{class:"h-4 w-4"}),Ie(2),P(R);var H=O(R,2);{var U=Q=>{var ae=J0();ae.__click=h;var we=I(ae);Ha(we,{class:"h-5 w-5"}),Ie(4),P(ae),$(Q,ae)};oe(H,Q=>{_(l)>0&&Q(U)})}var Z=O(H,2);Z.__click=()=>se(t,!0);var re=I(Z);Yd(re,{class:"h-5 w-5"}),Ie(2),P(Z),P(X),P(ie),Te(()=>{ke(st,_(l)),ke(ct,` of ${le.items.length??""} compressed`),at(F,1,`bg-surface-800 text-surface-400 hover:bg-surface-700 hover:text-surface-200 flex items-center gap-2 rounded-xl px-4 py-2.5 text-sm font-medium transition-all ${_(a)?"ring-accent-start/50 text-accent-start ring-1":""}`)}),ut(1,ie,()=>Qt,()=>({duration:200})),$(j,ie)};oe(G,j=>{_(c)&&j(C)})}var N=O(G,2);{var y=j=>{b0(j,{})};oe(N,j=>{_(c)&&j(y)})}var q=O(N,2);{var ne=j=>{bo(j,{})};oe(q,j=>{_(c)&&j(ne)})}var Y=O(q,2);{var fe=j=>{Kg(j,{})};oe(Y,j=>{_(c)&&j(fe)})}P(A),P(T);var ee=O(T,2);nu(ee),P(w);var he=O(w,2);k0(he,{get open(){return _(t)},title:"Clear all videos?",get message(){return`This will remove all ${le.items.length??""} videos from the list. This action cannot be undone.`},confirmText:"Clear All",onconfirm:()=>{le.clearAll(),se(t,!1),f("All videos cleared","info")},oncancel:()=>se(t,!1)});var K=O(he,2);C0(K,{get open(){return _(i)},onclose:()=>se(i,!1)});var L=O(K,2);j0(L,{get open(){return _(a)},onclose:()=>se(a,!1)});var be=O(L,2);G0(be,{get open(){return _(n)},onclose:p});var ce=O(be,2);ng(ce,{}),$(r,b),Zt()}Ht(["click"]);export{uv as component};
