import{c as Il,l as Al,m as Fl,a as W,d as Te,j as Wt,f as re,o as St,t as yr}from"../chunks/DtHnFpGQ.js";import{o as ua}from"../chunks/45ccNgTB.js";import{a as _a,I as Uo,a$ as Vo,Y as _i,h as At,a6 as Lo,J as Ea,l as x,an as zl,ah as Bl,L as Ml,_ as Ms,aa as Yi,e as Jr,K as Rl,af as Dl,X as Rs,c as ui,b0 as Fr,b as Pn,s as Nl,D as Ds,aB as Ol,ad as as,aP as Ul,b1 as Vl,b2 as Ll,b3 as $l,r as $o,p as Wo,b4 as Xa,G as Ho,a8 as Wl,b5 as Hl,ac as jl,d as ql,H as Ia,a1 as jo,b6 as Kl,aM as Gl,ai as Ql,i as aa,b7 as Xl,aI as qo,aw as Zl,b8 as Wi,b9 as Yl,ba as Jl,bb as ed,bc as td,aH as rd,bd as Ko,E as Go,aD as id,be as ad,v as Qt,y as Xt,n as Hi,z as E,B as R,A as C,w as pe,aE as Ke,bf as nd,x as _e,ap as ne,aC as We,Z as Me,ao as Ti,g as Oi,bg as Ji}from"../chunks/BGGlLt3g.js";import{a as sd,b as ba,s as ge}from"../chunks/mC8rCBfp.js";import{l as De,p as mr,s as Ve,i as ce,c as na,b as Fi}from"../chunks/Smauafc9.js";import{a as Ns,s as ct,b as Ge,c as ar,r as Ta,d as Os}from"../chunks/CED9ZUMA.js";import{b as Us}from"../chunks/Bzfrd-Lz.js";import{i as od}from"../chunks/B3lDJ0xH.js";import{B as cd}from"../chunks/D5eFOiKj.js";function Tt(r,e){return e}function ld(r,e,t){for(var i=[],a=e.length,s,n=e.length,o=0;o<a;o++){let u=e[o];Wo(u,()=>{if(s){if(s.pending.delete(u),s.done.add(u),s.pending.size===0){var f=r.outrogroups;En(as(s.done)),f.delete(s),f.size===0&&(r.outrogroups=null)}}else n-=1},!1)}if(n===0){var c=i.length===0&&t!==null;if(c){var l=t,d=l.parentNode;jl(d),d.append(l),r.items.clear()}En(e,!c)}else s={pending:new Set(e),done:new Set},(r.outrogroups??=new Set).add(s)}function En(r,e=!0){for(var t=0;t<r.length;t++)ql(r[t],e)}var Vs;function yt(r,e,t,i,a,s=null){var n=r,o=new Map,c=(e&Vo)!==0;if(c){var l=r;n=At?_i(Lo(l)):l.appendChild(_a())}At&&Ea();var d=null,u=zl(()=>{var p=t();return Ul(p)?p:p==null?[]:as(p)}),f,h=!0;function g(){v.fallback=d,dd(v,f,n,e,i),d!==null&&(f.length===0?(d.f&Fr)===0?$o(d):(d.f^=Fr,Qi(d,null,n)):Wo(d,()=>{d=null}))}var m=Uo(()=>{f=x(u);var p=f.length;let b=!1;if(At){var y=Bl(n)===Ml;y!==(p===0)&&(n=Ms(),_i(n),Yi(!1),b=!0)}for(var _=new Set,S=ui,A=Nl(),z=0;z<p;z+=1){At&&Jr.nodeType===Rl&&Jr.data===Dl&&(n=Jr,b=!0,Yi(!1));var D=f[z],M=i(D,z),$=h?null:o.get(M);$?($.v&&Rs($.v,D),$.i&&Rs($.i,z),A&&S.skipped_effects.delete($.e)):($=ud(o,h?n:Vs??=_a(),D,M,z,a,e,t),h||($.e.f|=Fr),o.set(M,$)),_.add(M)}if(p===0&&s&&!d&&(h?d=Pn(()=>s(n)):(d=Pn(()=>s(Vs??=_a())),d.f|=Fr)),At&&p>0&&_i(Ms()),!h)if(A){for(const[K,P]of o)_.has(K)||S.skipped_effects.add(P.e);S.oncommit(g),S.ondiscard(()=>{})}else g();b&&Yi(!0),x(u)}),v={effect:m,items:o,outrogroups:null,fallback:d};h=!1,At&&(n=Jr)}function dd(r,e,t,i,a){var s=(i&Hl)!==0,n=e.length,o=r.items,c=r.effect.first,l,d=null,u,f=[],h=[],g,m,v,p;if(s)for(p=0;p<n;p+=1)g=e[p],m=a(g,p),v=o.get(m).e,(v.f&Fr)===0&&(v.nodes?.a?.measure(),(u??=new Set).add(v));for(p=0;p<n;p+=1){if(g=e[p],m=a(g,p),v=o.get(m).e,r.outrogroups!==null)for(const $ of r.outrogroups)$.pending.delete(v),$.done.delete(v);if((v.f&Fr)!==0)if(v.f^=Fr,v===c)Qi(v,null,t);else{var b=d?d.next:c;v===r.effect.last&&(r.effect.last=v.prev),v.prev&&(v.prev.next=v.next),v.next&&(v.next.prev=v.prev),Rr(r,d,v),Rr(r,v,b),Qi(v,b,t),d=v,f=[],h=[],c=d.next;continue}if((v.f&Xa)!==0&&($o(v),s&&(v.nodes?.a?.unfix(),(u??=new Set).delete(v))),v!==c){if(l!==void 0&&l.has(v)){if(f.length<h.length){var y=h[0],_;d=y.prev;var S=f[0],A=f[f.length-1];for(_=0;_<f.length;_+=1)Qi(f[_],y,t);for(_=0;_<h.length;_+=1)l.delete(h[_]);Rr(r,S.prev,A.next),Rr(r,d,S),Rr(r,A,y),c=y,d=A,p-=1,f=[],h=[]}else l.delete(v),Qi(v,c,t),Rr(r,v.prev,v.next),Rr(r,v,d===null?r.effect.first:d.next),Rr(r,d,v),d=v;continue}for(f=[],h=[];c!==null&&c!==v;)(l??=new Set).add(c),h.push(c),c=c.next;if(c===null)continue}(v.f&Fr)===0&&f.push(v),d=v,c=v.next}if(r.outrogroups!==null){for(const $ of r.outrogroups)$.pending.size===0&&(En(as($.done)),r.outrogroups?.delete($));r.outrogroups.size===0&&(r.outrogroups=null)}if(c!==null||l!==void 0){var z=[];if(l!==void 0)for(v of l)(v.f&Xa)===0&&z.push(v);for(;c!==null;)(c.f&Xa)===0&&c!==r.fallback&&z.push(c),c=c.next;var D=z.length;if(D>0){var M=(i&Vo)!==0&&n===0?t:null;if(s){for(p=0;p<D;p+=1)z[p].nodes?.a?.measure();for(p=0;p<D;p+=1)z[p].nodes?.a?.fix()}ld(r,z,M)}}s&&Ho(()=>{if(u!==void 0)for(v of u)v.nodes?.a?.apply()})}function ud(r,e,t,i,a,s,n,o){var c=(n&Vl)!==0?(n&Ll)===0?Ol(t,!1,!1):Ds(t):null,l=(n&$l)!==0?Ds(a):null;return{v:c,i:l,e:Pn(()=>(s(e,c??t,l??a,o),()=>{r.delete(i)}))}}function Qi(r,e,t){if(r.nodes)for(var i=r.nodes.start,a=r.nodes.end,s=e&&(e.f&Fr)===0?e.nodes.start:t;i!==null;){var n=Wl(i);if(s.before(i),i===a)return;i=n}}function Rr(r,e,t){e===null?r.effect.first=t:e.next=t,t===null?r.effect.last=e:t.prev=e}function Ne(r,e,t,i,a){At&&Ea();var s=e.$$slots?.[t],n=!1;s===!0&&(s=e.children,n=!0),s===void 0||s(r,n?()=>i:i)}const fd=()=>performance.now(),Er={tick:r=>requestAnimationFrame(r),now:()=>fd(),tasks:new Set};function Qo(){const r=Er.now();Er.tasks.forEach(e=>{e.c(r)||(Er.tasks.delete(e),e.f())}),Er.tasks.size!==0&&Er.tick(Qo)}function hd(r){let e;return Er.tasks.size===0&&Er.tick(Qo),{promise:new Promise(t=>{Er.tasks.add(e={c:r,f:t})}),abort(){Er.tasks.delete(e)}}}function wa(r,e){qo(()=>{r.dispatchEvent(new CustomEvent(e))})}function md(r){if(r==="float")return"cssFloat";if(r==="offset")return"cssOffset";if(r.startsWith("--"))return r;const e=r.split("-");return e.length===1?e[0]:e[0]+e.slice(1).map(t=>t[0].toUpperCase()+t.slice(1)).join("")}function Ls(r){const e={},t=r.split(";");for(const i of t){const[a,s]=i.split(":");if(!a||s===void 0)break;const n=md(a.trim());e[n]=s.trim()}return e}const pd=r=>r;let Xo=null;function $s(r){Xo=r}function gd(r,e,t){var i=Xo??Ia,a=i.nodes,s,n,o,c=null;a.a??={element:r,measure(){s=this.element.getBoundingClientRect()},apply(){if(o?.abort(),n=this.element.getBoundingClientRect(),s.left!==n.left||s.right!==n.right||s.top!==n.top||s.bottom!==n.bottom){const l=e()(this.element,{from:s,to:n},t?.());o=Aa(this.element,l,void 0,1,()=>{o?.abort(),o=void 0})}},fix(){if(!r.getAnimations().length){var{position:l,width:d,height:u}=getComputedStyle(r);if(l!=="absolute"&&l!=="fixed"){var f=r.style;c={position:f.position,width:f.width,height:f.height,transform:f.transform},f.position="absolute",f.width=d,f.height=u;var h=r.getBoundingClientRect();if(s.left!==h.left||s.top!==h.top){var g=`translate(${s.left-h.left}px, ${s.top-h.top}px)`;f.transform=f.transform?`${f.transform} ${g}`:g}}}},unfix(){if(c){var l=r.style;l.position=c.position,l.width=c.width,l.height=c.height,l.transform=c.transform}}},a.a.element=r}function ft(r,e,t,i){var a=(r&Yl)!==0,s=(r&Jl)!==0,n=a&&s,o=(r&Xl)!==0,c=n?"both":a?"in":"out",l,d=e.inert,u=e.style.overflow,f,h;function g(){return qo(()=>l??=t()(e,i?.()??{},{direction:c}))}var m={is_global:o,in(){if(e.inert=d,!a){h?.abort(),h?.reset?.();return}s||f?.abort(),wa(e,"introstart"),f=Aa(e,g(),h,1,()=>{wa(e,"introend"),f?.abort(),f=l=void 0,e.style.overflow=u})},out(y){if(!s){y?.(),l=void 0;return}e.inert=!0,wa(e,"outrostart"),h=Aa(e,g(),f,0,()=>{wa(e,"outroend"),y?.()})},stop:()=>{f?.abort(),h?.abort()}},v=Ia;if((v.nodes.t??=[]).push(m),a&&sd){var p=o;if(!p){for(var b=v.parent;b&&(b.f&jo)!==0;)for(;(b=b.parent)&&(b.f&Kl)===0;);p=!b||(b.f&Gl)!==0}p&&Ql(()=>{aa(()=>m.in())})}}function Aa(r,e,t,i,a){var s=i===1;if(Zl(e)){var n,o=!1;return Ho(()=>{if(!o){var v=e({direction:s?"in":"out"});n=Aa(r,v,t,i,a)}}),{abort:()=>{o=!0,n?.abort()},deactivate:()=>n.deactivate(),reset:()=>n.reset(),t:()=>n.t()}}if(t?.deactivate(),!e?.duration)return a(),{abort:Wi,deactivate:Wi,reset:Wi,t:()=>i};const{delay:c=0,css:l,tick:d,easing:u=pd}=e;var f=[];if(s&&t===void 0&&(d&&d(0,1),l)){var h=Ls(l(0,1));f.push(h,h)}var g=()=>1-i,m=r.animate(f,{duration:c,fill:"forwards"});return m.onfinish=()=>{m.cancel();var v=t?.t()??1-i;t?.abort();var p=i-v,b=e.duration*Math.abs(p),y=[];if(b>0){var _=!1;if(l)for(var S=Math.ceil(b/16.666666666666668),A=0;A<=S;A+=1){var z=v+p*u(A/S),D=Ls(l(z,1-z));y.push(D),_||=D.overflow==="hidden"}_&&(r.style.overflow="hidden"),g=()=>{var M=m.currentTime;return v+p*u(M/b)},d&&hd(()=>{if(m.playState!=="running")return!1;var M=g();return d(M,1-M),!0})}m=r.animate(y,{duration:b,fill:"forwards"}),m.onfinish=()=>{g=()=>i,d?.(i,1-i),a()}},{abort:()=>{m&&(m.cancel(),m.effect=null,m.onfinish=Wi)},deactivate:()=>{a=Wi},reset:()=>{i===0&&d?.(1,0)},t:()=>g()}}function vd(r,e,t,i,a,s){let n=At;At&&Ea();var o=null;At&&Jr.nodeType===ed&&(o=Jr,Ea());var c=At?Jr:r,l=Ia,d=new cd(c,!1);Uo(()=>{const u=e()||null;var f=td;if(u===null){d.ensure(null,null),ba(!0);return}return d.ensure(u,h=>{if(u){if(o=At?o:document.createElementNS(f,u),Il(o,o),i){At&&Al(u)&&o.append(document.createComment(""));var g=At?Lo(o):o.appendChild(_a());At&&(g===null?Yi(!1):_i(g)),$s(l),i(o,g),$s(null)}Ia.nodes.end=o,h.before(o)}At&&_i(h)}),ba(!0),()=>{u&&ba(!1)}},jo),rd(()=>{ba(!0)}),n&&(Yi(!0),_i(c))}function bd(r,e,t=e){var i=new WeakSet;Ko(r,"input",async a=>{var s=a?r.defaultValue:r.value;if(s=Za(r)?Ya(s):s,t(s),ui!==null&&i.add(ui),await id(),s!==(s=e())){var n=r.selectionStart,o=r.selectionEnd,c=r.value.length;if(r.value=s??"",o!==null){var l=r.value.length;n===o&&o===c&&l>c?(r.selectionStart=l,r.selectionEnd=l):(r.selectionStart=n,r.selectionEnd=Math.min(o,l))}}}),(At&&r.defaultValue!==r.value||aa(e)==null&&r.value)&&(t(Za(r)?Ya(r.value):r.value),ui!==null&&i.add(ui)),Go(()=>{var a=e();if(r===document.activeElement){var s=ad??ui;if(i.has(s))return}Za(r)&&a===Ya(r.value)||r.type==="date"&&!a&&!r.value||a!==r.value&&(r.value=a??"")})}function wd(r,e,t=e){Ko(r,"change",i=>{var a=i?r.defaultChecked:r.checked;t(a)}),(At&&r.defaultChecked!==r.checked||aa(e)==null)&&t(r.checked),Go(()=>{var i=e();r.checked=!!i})}function Za(r){var e=r.type;return e==="number"||e==="range"}function Ya(r){return r===""?null:+r}const yd={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":2,"stroke-linecap":"round","stroke-linejoin":"round"};var kd=Fl("<svg><!><!></svg>");function Le(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]),i=De(t,["name","color","size","strokeWidth","absoluteStrokeWidth","iconNode"]);Qt(e,!1);let a=mr(e,"name",8,void 0),s=mr(e,"color",8,"currentColor"),n=mr(e,"size",8,24),o=mr(e,"strokeWidth",8,2),c=mr(e,"absoluteStrokeWidth",8,!1),l=mr(e,"iconNode",24,()=>[]);const d=(...g)=>g.filter((m,v,p)=>!!m&&p.indexOf(m)===v).join(" ");od();var u=kd();Ns(u,(g,m)=>({...yd,...i,width:n(),height:n(),stroke:s(),"stroke-width":g,class:m}),[()=>(Hi(c()),Hi(o()),Hi(n()),aa(()=>c()?Number(o())*24/Number(n()):o())),()=>(Hi(a()),Hi(t),aa(()=>d("lucide-icon","lucide",a()?`lucide-${a()}`:"",t.class)))]);var f=E(u);yt(f,1,l,Tt,(g,m)=>{var v=Ke(()=>nd(x(m),2));let p=()=>x(v)[0],b=()=>x(v)[1];var y=Te(),_=pe(y);vd(_,p,!0,(S,A)=>{Ns(S,()=>({...b()}))}),W(g,y)});var h=R(f);Ne(h,e,"default",{}),C(u),W(r,u),Xt()}function Zo(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2"}]];Le(r,Ve({name:"activity"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function In(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M5 12h14"}],["path",{d:"m12 5 7 7-7 7"}]];Le(r,Ve({name:"arrow-right"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function ea(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M20 6 9 17l-5-5"}]];Le(r,Ve({name:"check"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function Fa(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"m6 9 6 6 6-6"}]];Le(r,Ve({name:"chevron-down"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function xd(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"m15 18-6-6 6-6"}]];Le(r,Ve({name:"chevron-left"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function _d(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"m9 18 6-6-6-6"}]];Le(r,Ve({name:"chevron-right"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function Td(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"m18 15-6-6-6 6"}]];Le(r,Ve({name:"chevron-up"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function Yo(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["circle",{cx:"12",cy:"12",r:"10"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16"}]];Le(r,Ve({name:"circle-alert"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function Sd(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"}]];Le(r,Ve({name:"clipboard"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function Cd(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M10 2v2"}],["path",{d:"M14 2v2"}],["path",{d:"M16 8a1 1 0 0 1 1 1v8a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4V9a1 1 0 0 1 1-1h14a4 4 0 1 1 0 8h-1"}],["path",{d:"M6 2v2"}]];Le(r,Ve({name:"coffee"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function An(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M12 20v2"}],["path",{d:"M12 2v2"}],["path",{d:"M17 20v2"}],["path",{d:"M17 2v2"}],["path",{d:"M2 12h2"}],["path",{d:"M2 17h2"}],["path",{d:"M2 7h2"}],["path",{d:"M20 12h2"}],["path",{d:"M20 17h2"}],["path",{d:"M20 7h2"}],["path",{d:"M7 20v2"}],["path",{d:"M7 2v2"}],["rect",{x:"4",y:"4",width:"16",height:"16",rx:"2"}],["rect",{x:"8",y:"8",width:"8",height:"8",rx:"1"}]];Le(r,Ve({name:"cpu"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function Pd(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["circle",{cx:"12",cy:"12",r:"10"}],["path",{d:"M6 12c0-1.7.7-3.2 1.8-4.2"}],["circle",{cx:"12",cy:"12",r:"2"}],["path",{d:"M18 12c0 1.7-.7 3.2-1.8 4.2"}]];Le(r,Ve({name:"disc-3"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function za(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M12 15V3"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}],["path",{d:"m7 10 5 5 5-5"}]];Le(r,Ve({name:"download"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function Ed(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z"}],["path",{d:"M14 2v5a1 1 0 0 0 1 1h5"}],["path",{d:"M10 9H8"}],["path",{d:"M16 13H8"}],["path",{d:"M16 17H8"}]];Le(r,Ve({name:"file-text"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function zi(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2"}],["path",{d:"M7 3v18"}],["path",{d:"M3 7.5h4"}],["path",{d:"M3 12h18"}],["path",{d:"M3 16.5h4"}],["path",{d:"M17 3v18"}],["path",{d:"M17 7.5h4"}],["path",{d:"M17 16.5h4"}]];Le(r,Ve({name:"film"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function Id(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"m12 14 4-4"}],["path",{d:"M3.34 19a10 10 0 1 1 17.32 0"}]];Le(r,Ve({name:"gauge"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function Jo(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"}],["path",{d:"M9 18c-4.51 2-5-2-7-2"}]];Le(r,Ve({name:"github"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function Fn(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M2 21V3"}],["path",{d:"M2 5h18a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2.26"}],["path",{d:"M7 17v3a1 1 0 0 0 1 1h5a1 1 0 0 0 1-1v-3"}],["circle",{cx:"16",cy:"11",r:"2"}],["circle",{cx:"8",cy:"11",r:"2"}]];Le(r,Ve({name:"gpu"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function Ad(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["circle",{cx:"9",cy:"12",r:"1"}],["circle",{cx:"9",cy:"5",r:"1"}],["circle",{cx:"9",cy:"19",r:"1"}],["circle",{cx:"15",cy:"12",r:"1"}],["circle",{cx:"15",cy:"5",r:"1"}],["circle",{cx:"15",cy:"19",r:"1"}]];Le(r,Ve({name:"grip-vertical"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function Fd(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["line",{x1:"22",x2:"2",y1:"12",y2:"12"}],["path",{d:"M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"}],["line",{x1:"6",x2:"6.01",y1:"16",y2:"16"}],["line",{x1:"10",x2:"10.01",y1:"16",y2:"16"}]];Le(r,Ve({name:"hard-drive"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function Ws(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5"}]];Le(r,Ve({name:"heart"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function zd(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2"}],["circle",{cx:"9",cy:"9",r:"2"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"}]];Le(r,Ve({name:"image"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function ns(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["circle",{cx:"12",cy:"12",r:"10"}],["path",{d:"M12 16v-4"}],["path",{d:"M12 8h.01"}]];Le(r,Ve({name:"info"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function ec(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M10 8h.01"}],["path",{d:"M12 12h.01"}],["path",{d:"M14 8h.01"}],["path",{d:"M16 12h.01"}],["path",{d:"M18 8h.01"}],["path",{d:"M6 8h.01"}],["path",{d:"M7 16h10"}],["path",{d:"M8 12h.01"}],["rect",{width:"20",height:"16",x:"2",y:"4",rx:"2"}]];Le(r,Ve({name:"keyboard"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function Bd(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83z"}],["path",{d:"M2 12a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 12"}],["path",{d:"M2 17a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 17"}]];Le(r,Ve({name:"layers"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function Md(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"}],["rect",{width:"4",height:"12",x:"2",y:"9"}],["circle",{cx:"4",cy:"4",r:"2"}]];Le(r,Ve({name:"linkedin"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function Rd(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56"}]];Le(r,Ve({name:"loader-circle"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function Dd(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M8 3H5a2 2 0 0 0-2 2v3"}],["path",{d:"M21 8V5a2 2 0 0 0-2-2h-3"}],["path",{d:"M3 16v3a2 2 0 0 0 2 2h3"}],["path",{d:"M16 21h3a2 2 0 0 0 2-2v-3"}]];Le(r,Ve({name:"maximize"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function ss(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z"}]];Le(r,Ve({name:"play"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function Hs(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"}],["path",{d:"M21 3v5h-5"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"}],["path",{d:"M8 16H3v5"}]];Le(r,Ve({name:"refresh-cw"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function Nd(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"}],["path",{d:"M3 3v5h5"}]];Le(r,Ve({name:"rotate-ccw"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function js(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["circle",{cx:"6",cy:"6",r:"3"}],["path",{d:"M8.12 8.12 12 12"}],["path",{d:"M20 4 8.12 15.88"}],["circle",{cx:"6",cy:"18",r:"3"}],["path",{d:"M14.8 14.8 20 20"}]];Le(r,Ve({name:"scissors"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function qs(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["rect",{width:"20",height:"8",x:"2",y:"2",rx:"2",ry:"2"}],["rect",{width:"20",height:"8",x:"2",y:"14",rx:"2",ry:"2"}],["line",{x1:"6",x2:"6.01",y1:"6",y2:"6"}],["line",{x1:"6",x2:"6.01",y1:"18",y2:"18"}]];Le(r,Ve({name:"server"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function Ks(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M14 17H5"}],["path",{d:"M19 7h-9"}],["circle",{cx:"17",cy:"17",r:"3"}],["circle",{cx:"7",cy:"7",r:"3"}]];Le(r,Ve({name:"settings-2"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function tc(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"}]];Le(r,Ve({name:"shield"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function Od(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M10 8h4"}],["path",{d:"M12 21v-9"}],["path",{d:"M12 8V3"}],["path",{d:"M17 16h4"}],["path",{d:"M19 12V3"}],["path",{d:"M19 21v-5"}],["path",{d:"M3 14h4"}],["path",{d:"M5 10V3"}],["path",{d:"M5 21v-7"}]];Le(r,Ve({name:"sliders-vertical"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function Gs(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M11.017 2.814a1 1 0 0 1 1.966 0l1.051 5.558a2 2 0 0 0 1.594 1.594l5.558 1.051a1 1 0 0 1 0 1.966l-5.558 1.051a2 2 0 0 0-1.594 1.594l-1.051 5.558a1 1 0 0 1-1.966 0l-1.051-5.558a2 2 0 0 0-1.594-1.594l-5.558-1.051a1 1 0 0 1 0-1.966l5.558-1.051a2 2 0 0 0 1.594-1.594z"}],["path",{d:"M20 2v4"}],["path",{d:"M22 4h-4"}],["circle",{cx:"4",cy:"20",r:"2"}]];Le(r,Ve({name:"sparkles"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function Ud(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M8 19H5c-1 0-2-1-2-2V7c0-1 1-2 2-2h3"}],["path",{d:"M16 5h3c1 0 2 1 2 2v10c0 1-1 2-2 2h-3"}],["line",{x1:"12",x2:"12",y1:"4",y2:"20"}]];Le(r,Ve({name:"square-split-horizontal"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function Vd(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M10 11v6"}],["path",{d:"M14 11v6"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"}],["path",{d:"M3 6h18"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"}]];Le(r,Ve({name:"trash-2"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function rc(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"}],["path",{d:"M12 9v4"}],["path",{d:"M12 17h.01"}]];Le(r,Ve({name:"triangle-alert"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function zn(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M12 3v12"}],["path",{d:"m17 8-5-5-5 5"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}]];Le(r,Ve({name:"upload"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function Ld(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z"}],["path",{d:"M16 9a5 5 0 0 1 0 6"}],["path",{d:"M19.364 18.364a9 9 0 0 0 0-12.728"}]];Le(r,Ve({name:"volume-2"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function Qs(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M12 20h.01"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0"}],["path",{d:"M5 12.859a10 10 0 0 1 5.17-2.69"}],["path",{d:"M19 12.859a10 10 0 0 0-2.007-1.523"}],["path",{d:"M2 8.82a15 15 0 0 1 4.177-2.643"}],["path",{d:"M22 8.82a15 15 0 0 0-11.288-3.764"}],["path",{d:"m2 2 20 20"}]];Le(r,Ve({name:"wifi-off"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function kr(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M18 6 6 18"}],["path",{d:"m6 6 12 12"}]];Le(r,Ve({name:"x"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}function ic(r,e){const t=De(e,["children","$$slots","$$events","$$legacy"]);const i=[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z"}]];Le(r,Ve({name:"zap"},()=>t,{get iconNode(){return i},children:(a,s)=>{var n=Te(),o=pe(n);Ne(o,e,"default",{}),W(a,n)},$$slots:{default:!0}}))}const $d=r=>r;function os(r){const e=r-1;return e*e*e+1}function Xs(r){const e=typeof r=="string"&&r.match(/^\s*(-?[\d.]+)([^\s]*)\s*$/);return e?[parseFloat(e[1]),e[2]||"px"]:[r,"px"]}function Gt(r,{delay:e=0,duration:t=400,easing:i=$d}={}){const a=+getComputedStyle(r).opacity;return{delay:e,duration:t,easing:i,css:s=>`opacity: ${s*a}`}}function ac(r,{delay:e=0,duration:t=400,easing:i=os,x:a=0,y:s=0,opacity:n=0}={}){const o=getComputedStyle(r),c=+o.opacity,l=o.transform==="none"?"":o.transform,d=c*(1-n),[u,f]=Xs(a),[h,g]=Xs(s);return{delay:e,duration:t,easing:i,css:(m,v)=>`
			transform: ${l} translate(${(1-m)*u}${f}, ${(1-m)*h}${g});
			opacity: ${c-d*v}`}}function Ba(r,{delay:e=0,duration:t=400,easing:i=os,axis:a="y"}={}){const s=getComputedStyle(r),n=+s.opacity,o=a==="y"?"height":"width",c=parseFloat(s[o]),l=a==="y"?["top","bottom"]:["left","right"],d=l.map(p=>`${p[0].toUpperCase()}${p.slice(1)}`),u=parseFloat(s[`padding${d[0]}`]),f=parseFloat(s[`padding${d[1]}`]),h=parseFloat(s[`margin${d[0]}`]),g=parseFloat(s[`margin${d[1]}`]),m=parseFloat(s[`border${d[0]}Width`]),v=parseFloat(s[`border${d[1]}Width`]);return{delay:e,duration:t,easing:i,css:p=>`overflow: hidden;opacity: ${Math.min(p*20,1)*n};${o}: ${p*c}px;padding-${l[0]}: ${p*u}px;padding-${l[1]}: ${p*f}px;margin-${l[0]}: ${p*h}px;margin-${l[1]}: ${p*g}px;border-${l[0]}-width: ${p*m}px;border-${l[1]}-width: ${p*v}px;min-${o}: 0`}}function Si(r,{delay:e=0,duration:t=400,easing:i=os,start:a=0,opacity:s=0}={}){const n=getComputedStyle(r),o=+n.opacity,c=n.transform==="none"?"":n.transform,l=1-a,d=o*(1-s);return{delay:e,duration:t,easing:i,css:(u,f)=>`
			transform: ${c} scale(${1-l*f});
			opacity: ${o-d*f}
		`}}var Wd=re(`<div class="flex items-center gap-2 rounded-xl bg-amber-500/20 px-3 py-2 text-amber-400" title="You're offline - app still works!"><!> <span class="hidden text-sm font-medium sm:inline">Offline</span></div>`),Hd=re(`<div class="fixed left-1/2 top-20 z-50 flex -translate-x-1/2 items-center gap-3 rounded-xl bg-amber-500 px-4 py-3 text-white shadow-lg"><!> <div><p class="font-medium">You're offline</p> <p class="text-sm text-amber-100">Don't worry, Squash works offline!</p></div></div>`),jd=re('<header class="fixed left-0 right-0 top-0 z-50 px-4 py-4 sm:px-6 lg:px-8"><div class="mx-auto max-w-7xl"><nav class="glass flex items-center justify-between rounded-2xl px-4 py-3 shadow-lg shadow-black/5 sm:px-6"><a class="group flex items-center gap-3"><div class="from-accent-start to-accent-end shadow-accent-start/30 flex h-10 w-10 items-center justify-center rounded-xl bg-gradient-to-br shadow-lg transition-transform group-hover:scale-110"><!></div> <span class="text-xl font-semibold tracking-tight"><span class="gradient-text">Squash</span></span></a> <div class="flex items-center gap-2"><!> <a href="https://github.com/ishanjalan/Neutron/tree/main/apps/squash" target="_blank" rel="noopener noreferrer" class="text-surface-400 hover:bg-surface-800 hover:text-surface-100 flex h-10 w-10 items-center justify-center rounded-xl transition-all" title="View on GitHub"><!></a></div></nav></div></header> <!>',1);function qd(r,e){Qt(e,!0);let t=We(!0),i=We(!1);ua(()=>{ne(t,navigator.onLine,!0);const b=()=>{ne(t,!0),ne(i,!1)},y=()=>{ne(t,!1),ne(i,!0),setTimeout(()=>{ne(i,!1)},5e3)};return window.addEventListener("online",b),window.addEventListener("offline",y),()=>{window.removeEventListener("online",b),window.removeEventListener("offline",y)}});var a=jd(),s=pe(a),n=E(s),o=E(n),c=E(o);c.__click=b=>{b.preventDefault(),window.scrollTo({top:0,behavior:"smooth"}),window.scrollY===0&&(window.location.href=`${Us}/`)};var l=E(c),d=E(l);zi(d,{class:"h-5 w-5 text-white",strokeWidth:2.5}),C(l),Me(2),C(c);var u=R(c,2),f=E(u);{var h=b=>{var y=Wd(),_=E(y);Qs(_,{class:"h-4 w-4"}),Me(2),C(y),ft(3,y,()=>Gt,()=>({duration:150})),W(b,y)};ce(f,b=>{x(t)||b(h)})}var g=R(f,2),m=E(g);Jo(m,{class:"h-5 w-5"}),C(g),C(u),C(o),C(n),C(s);var v=R(s,2);{var p=b=>{var y=Hd(),_=E(y);Qs(_,{class:"h-5 w-5"}),Me(2),C(y),ft(3,y,()=>Gt,()=>({duration:200})),W(b,y)};ce(v,b=>{x(i)&&b(p)})}_e(()=>ct(c,"href",`${Us??""}/`)),W(r,a),Xt()}Wt(["click"]);let Bi=We(Ti([]));function Ja(r,e="info",t={}){const i=`toast_${Date.now()}_${Math.random().toString(36).slice(2,9)}`,a=t.duration??3e3;return ne(Bi,[...x(Bi),{id:i,message:r,type:e,duration:a,action:t.action}],!0),a>0&&setTimeout(()=>{Bn(i)},a),i}function Bn(r){ne(Bi,x(Bi).filter(e=>e.id!==r),!0)}const Sa={success:(r,e)=>Ja(r,"success",typeof e=="number"?{duration:e}:e),error:(r,e)=>Ja(r,"error",{duration:5e3,...typeof e=="number"?{duration:e}:e}),info:(r,e)=>Ja(r,"info",typeof e=="number"?{duration:e}:e)};var Kd=re('<button class="text-accent-start bg-accent-start/20 hover:bg-accent-start/30 flex-shrink-0 rounded-lg px-3 py-1 text-sm font-semibold transition-colors"> </button>'),Gd=re('<div role="alert"><!> <p class="text-surface-100 flex-1 text-sm font-medium"> </p> <!> <button class="text-surface-400 hover:bg-surface-700 hover:text-surface-300 flex-shrink-0 rounded-lg p-1 transition-colors" aria-label="Dismiss notification"><!></button></div>'),Qd=re('<div class="fixed bottom-4 right-4 z-[100] flex max-w-sm flex-col gap-2" role="region" aria-label="Notifications" aria-live="polite"></div>');function Xd(r,e){Qt(e,!0);const t={success:ea,error:Yo,info:ns},i={success:"bg-green-500/10 border-green-500/30 text-green-500",error:"bg-red-500/10 border-red-500/30 text-red-500",info:"bg-accent-start/10 border-accent-start/30 text-accent-start"};var a=Te(),s=pe(a);{var n=o=>{var c=Qd();yt(c,21,()=>x(Bi),l=>l.id,(l,d)=>{var u=Gd(),f=E(u);na(f,()=>t[x(d).type],(y,_)=>{_(y,{class:"h-5 w-5 flex-shrink-0"})});var h=R(f,2),g=E(h,!0);C(h);var m=R(h,2);{var v=y=>{var _=Kd();_.__click=()=>{x(d).action?.onClick(),Bn(x(d).id)};var S=E(_,!0);C(_),_e(()=>ge(S,x(d).action.label)),W(y,_)};ce(m,y=>{x(d).action&&y(v)})}var p=R(m,2);p.__click=()=>Bn(x(d).id);var b=E(p);kr(b,{class:"h-4 w-4"}),C(p),C(u),_e(()=>{Ge(u,1,`glass flex items-center gap-3 rounded-xl border px-4 py-3 shadow-lg ${i[x(d).type]??""}`),ge(g,x(d).message)}),ft(1,u,()=>ac,()=>({x:100,duration:200})),ft(2,u,()=>Gt,()=>({duration:150})),W(l,u)}),C(c),W(o,c)};ce(s,o=>{x(Bi).length>0&&o(n)})}W(r,a),Xt()}Wt(["click"]);function Mn(r){if(r===0)return"0 B";const e=1024,t=["B","KB","MB","GB"],i=Math.floor(Math.log(r)/Math.log(e));return parseFloat((r/Math.pow(e,i)).toFixed(i>1?2:1))+" "+t[i]}const Zd=["button:not([disabled])","[href]","input:not([disabled])","select:not([disabled])","textarea:not([disabled])",'[tabindex]:not([tabindex="-1"])','[contenteditable="true"]'].join(", ");let Zr=null;function nc(r){return Array.from(r.querySelectorAll(Zd)).filter(e=>e.offsetParent!==null)}function Yd(r,e){if(r.key!=="Tab")return;const t=nc(e);if(t.length===0)return;const i=t[0],a=t[t.length-1];r.shiftKey?document.activeElement===i&&(r.preventDefault(),a.focus()):document.activeElement===a&&(r.preventDefault(),i.focus())}function Jd(r){const e=document.activeElement,t=a=>Yd(a,r);Zr={container:r,previouslyFocused:e,handleKeyDown:t},document.body.classList.add("modal-open"),document.addEventListener("keydown",t);const i=nc(r);i.length>0&&requestAnimationFrame(()=>{i[0].focus()})}function eu(){Zr&&(document.removeEventListener("keydown",Zr.handleKeyDown),document.body.classList.remove("modal-open"),Zr.previouslyFocused&&typeof Zr.previouslyFocused.focus=="function"&&Zr.previouslyFocused.focus(),Zr=null)}function cs(r){return Jd(r),eu}Wt(["keydown","click"]);Wt(["click","pointerdown","pointermove","pointerup"]);var tu=re('<div><div class="bg-surface-900/90 relative flex h-full flex-col items-center justify-center gap-2 rounded-2xl px-4 py-5 backdrop-blur-xl svelte-e74pf8"><div></div> <div><!></div> <div class="relative svelte-e74pf8"><span class="block text-sm font-semibold text-white svelte-e74pf8"> </span> <span class="text-surface-400 block text-xs svelte-e74pf8"> </span></div> <span class="absolute right-2 top-2 flex h-2 w-2 svelte-e74pf8"><span class="absolute inline-flex h-full w-full animate-ping rounded-full bg-green-400 opacity-75 svelte-e74pf8"></span> <span class="relative inline-flex h-2 w-2 rounded-full bg-green-500 svelte-e74pf8"></span></span></div></div>'),ru=re('<a><div class="bg-surface-900 group-hover:bg-surface-900/90 relative flex h-full flex-col items-center justify-center gap-2 rounded-2xl px-4 py-5 transition-all duration-300 svelte-e74pf8"><div><!></div> <div class="text-center svelte-e74pf8"><span class="text-surface-300 block text-sm font-semibold transition-colors duration-300 group-hover:text-white svelte-e74pf8"> </span> <span class="text-surface-500 group-hover:text-surface-400 block text-xs transition-colors duration-300 svelte-e74pf8"> </span></div></div></a>'),iu=re('<footer class="relative mt-auto overflow-hidden svelte-e74pf8"><div class="absolute inset-x-0 top-0 h-px svelte-e74pf8"><div class="via-surface-600/50 h-full w-full bg-gradient-to-r from-transparent to-transparent svelte-e74pf8"></div> <div class="animate-shimmer absolute inset-0 h-full w-full bg-gradient-to-r from-transparent via-white/10 to-transparent svelte-e74pf8"></div></div> <div class="pointer-events-none absolute inset-0 overflow-hidden svelte-e74pf8"><div></div> <div class="absolute -bottom-32 right-1/4 h-64 w-64 rounded-full bg-gradient-to-t from-purple-500 to-pink-400 opacity-[0.02] blur-3xl svelte-e74pf8"></div></div> <div class="relative mx-auto max-w-5xl px-6 py-12 svelte-e74pf8"><div class="mb-10 text-center svelte-e74pf8"><div class="text-surface-500 mb-4 inline-flex items-center gap-2 text-xs font-medium uppercase tracking-widest svelte-e74pf8"><!> <span class="svelte-e74pf8">The Neutron Suite</span> <!></div> <div class="grid grid-cols-2 gap-3 sm:grid-cols-4 sm:gap-4 svelte-e74pf8"></div></div> <div class="via-surface-700 mx-auto mb-8 h-px w-full max-w-md bg-gradient-to-r from-transparent to-transparent svelte-e74pf8"></div> <div class="flex flex-col items-center gap-6 svelte-e74pf8"><div class="inline-flex items-center gap-2 rounded-full bg-green-500/10 px-4 py-2 ring-1 ring-green-500/20 svelte-e74pf8"><div class="relative flex h-5 w-5 items-center justify-center svelte-e74pf8"><!> <div class="absolute inset-0 animate-pulse rounded-full bg-green-400/20 svelte-e74pf8"></div></div> <span class="text-sm font-medium text-green-400 svelte-e74pf8"> </span></div> <div class="flex flex-wrap items-center justify-center gap-2 svelte-e74pf8"><a target="_blank" rel="noopener noreferrer" class="bg-surface-800/60 text-surface-400 ring-surface-700/50 hover:bg-surface-700 hover:ring-surface-600 group inline-flex items-center gap-2 rounded-full px-4 py-2 text-sm ring-1 transition-all duration-300 hover:text-white svelte-e74pf8"><!> <span class="svelte-e74pf8">View Source</span></a> <a href="https://www.linkedin.com/in/ishanjalan93/" target="_blank" rel="noopener noreferrer" class="bg-surface-800/60 text-surface-400 ring-surface-700/50 group inline-flex items-center gap-2 rounded-full px-4 py-2 text-sm ring-1 transition-all duration-300 hover:bg-sky-500/20 hover:text-sky-400 hover:ring-sky-500/30 svelte-e74pf8"><!> <span class="svelte-e74pf8">Connect</span></a> <a href="https://buymeacoffee.com/ishanjalan" target="_blank" rel="noopener noreferrer" class="group inline-flex items-center gap-2 rounded-full bg-gradient-to-r from-amber-500/20 to-orange-500/20 px-4 py-2 text-sm text-amber-400 ring-1 ring-amber-500/30 transition-all duration-300 hover:from-amber-500/30 hover:to-orange-500/30 hover:ring-amber-500/50 svelte-e74pf8"><!> <span class="svelte-e74pf8">Buy me a coffee</span></a></div> <div class="text-surface-500 flex items-center gap-2 text-sm svelte-e74pf8"><span class="svelte-e74pf8">Crafted with</span> <span class="relative inline-flex svelte-e74pf8"><!> <!></span> <span class="svelte-e74pf8">by</span> <a href="https://github.com/ishanjalan" target="_blank" rel="noopener noreferrer" class="text-surface-300 font-medium transition-colors hover:text-white svelte-e74pf8">Ishan Jalan</a></div></div></div></footer>');function au(r,e){const t=[{id:"squish",name:"Squish",tagline:"Image Compressor",url:"https://ishanjalan.github.io/ImageOptimser/",github:"https://github.com/ishanjalan/Neutron/tree/main/apps/squish",icon:zd,gradient:"from-emerald-500 to-teal-400",glow:"shadow-emerald-500/40",ring:"ring-emerald-400/50"},{id:"squash",name:"Squash",tagline:"Video Compressor",url:"https://ishanjalan.github.io/Squash/",github:"https://github.com/ishanjalan/Neutron/tree/main/apps/squash",icon:zi,gradient:"from-orange-500 to-amber-400",glow:"shadow-orange-500/40",ring:"ring-orange-400/50"},{id:"smash",name:"Smash",tagline:"PDF Toolkit",url:"https://ishanjalan.github.io/Smash/",github:"https://github.com/ishanjalan/Neutron/tree/main/apps/smash",icon:Ed,gradient:"from-sky-500 to-cyan-400",glow:"shadow-sky-500/40",ring:"ring-sky-400/50"},{id:"swirl",name:"Swirl",tagline:"GIF Toolkit",url:"https://ishanjalan.github.io/Swirl/",github:"https://github.com/ishanjalan/Neutron/tree/main/apps/swirl",icon:Pd,gradient:"from-fuchsia-500 to-pink-400",glow:"shadow-fuchsia-500/40",ring:"ring-fuchsia-400/50"}];let i=mr(e,"privacyText",3,"Your files never leave your device");const a=Ke(()=>t.find(Q=>Q.id===e.currentApp));var s=iu(),n=R(E(s),2),o=E(n);Me(2),C(n);var c=R(n,2),l=E(c),d=E(l),u=E(d);Gs(u,{class:"h-3.5 w-3.5 text-amber-400"});var f=R(u,4);Gs(f,{class:"h-3.5 w-3.5 text-amber-400"}),C(d);var h=R(d,2);yt(h,21,()=>t,Tt,(Q,se,Y)=>{const be=Ke(()=>x(se).id===e.currentApp);var ee=Te(),me=pe(ee);{var q=ue=>{var oe=tu();ar(oe,`animation-delay: ${Y*50}ms`);var j=E(oe),te=E(j),le=R(te,2),he=E(le);na(he,()=>x(se).icon,(w,J)=>{J(w,{class:"h-5 w-5 text-white"})}),C(le);var we=R(le,2),Ee=E(we),Se=E(Ee,!0);C(Ee);var Xe=R(Ee,2),at=E(Xe,!0);C(Xe),C(we),Me(2),C(j),C(oe),_e(()=>{Ge(oe,1,`group relative overflow-hidden rounded-2xl bg-gradient-to-br ${x(se).gradient??""} p-[1px] shadow-lg ${x(se).glow??""}`,"svelte-e74pf8"),Ge(te,1,`absolute inset-0 bg-gradient-to-br ${x(se).gradient??""} opacity-10`,"svelte-e74pf8"),Ge(le,1,`relative flex h-10 w-10 items-center justify-center rounded-xl bg-gradient-to-br ${x(se).gradient??""} shadow-lg ${x(se).glow??""}`,"svelte-e74pf8"),ge(Se,x(se).name),ge(at,x(se).tagline)}),W(ue,oe)},V=ue=>{var oe=ru();ar(oe,`animation-delay: ${Y*50}ms`);var j=E(oe),te=E(j),le=E(te);na(le,()=>x(se).icon,(at,w)=>{w(at,{class:"text-surface-400 h-5 w-5 transition-colors duration-300 group-hover:text-white"})}),C(te);var he=R(te,2),we=E(he),Ee=E(we,!0);C(we);var Se=R(we,2),Xe=E(Se,!0);C(Se),C(he),C(j),C(oe),_e(()=>{ct(oe,"href",x(se).url),Ge(oe,1,`bg-surface-800/50 group relative overflow-hidden rounded-2xl p-[1px] transition-all duration-300 hover:bg-gradient-to-br hover:${x(se).gradient??""} hover:shadow-lg hover:${x(se).glow??""}`,"svelte-e74pf8"),ct(oe,"title",`${x(se).name??""} â€” ${x(se).tagline??""}`),Ge(te,1,`bg-surface-800 flex h-10 w-10 items-center justify-center rounded-xl transition-all duration-300 group-hover:bg-gradient-to-br group-hover:${x(se).gradient??""} group-hover:shadow-lg group-hover:${x(se).glow??""}`,"svelte-e74pf8"),ge(Ee,x(se).name),ge(Xe,x(se).tagline)}),W(ue,oe)};ce(me,ue=>{x(be)?ue(q):ue(V,!1)})}W(Q,ee)}),C(h),C(l);var g=R(l,4),m=E(g),v=E(m),p=E(v);tc(p,{class:"h-4 w-4 text-green-400"}),Me(2),C(v);var b=R(v,2),y=E(b,!0);C(b),C(m);var _=R(m,2),S=E(_),A=E(S);Jo(A,{class:"h-4 w-4 transition-transform duration-300 group-hover:scale-110"}),Me(2),C(S);var z=R(S,2),D=E(z);Md(D,{class:"h-4 w-4 transition-transform duration-300 group-hover:scale-110"}),Me(2),C(z);var M=R(z,2),$=E(M);Cd($,{class:"h-4 w-4 transition-transform duration-300 group-hover:rotate-12 group-hover:scale-110"}),Me(2),C(M),C(_);var K=R(_,2),P=R(E(K),2),O=E(P);Ws(O,{class:"animate-heartbeat h-4 w-4 fill-red-500 text-red-500"});var k=R(O,2);Ws(k,{class:"animate-heartbeat-ping absolute inset-0 h-4 w-4 fill-red-500/50 text-red-500/50"}),C(P),Me(4),C(K),C(g),C(c),C(s),_e(()=>{Ge(o,1,`absolute -bottom-32 left-1/4 h-64 w-64 rounded-full bg-gradient-to-t ${x(a).gradient??""} opacity-[0.03] blur-3xl`,"svelte-e74pf8"),ge(y,i()),ct(S,"href",x(a).github)}),W(r,s)}function nu(r){au(r,{currentApp:"squash",privacyText:"Your videos never leave your device"})}const su={whatsapp:{label:"WhatsApp",sizeMB:16,icon:"ðŸ“±"},email:{label:"Email",sizeMB:25,icon:"ðŸ“§"},discord:{label:"Discord",sizeMB:50,icon:"ðŸ’¬"},telegram:{label:"Telegram",sizeMB:100,icon:"âœˆï¸"}},Wa={tiny:{crf:35,label:"Tiny",desc:"Max compression",targetBitrate:"500k",preset:"fast"},web:{crf:28,label:"Web",desc:"Balanced",targetBitrate:"1000k",preset:"medium"},social:{crf:23,label:"Social",desc:"Social media",targetBitrate:"2000k",preset:"medium"},high:{crf:18,label:"High",desc:"High quality",targetBitrate:"4000k",preset:"slow"},lossless:{crf:0,label:"Max Quality",desc:"Visually lossless",targetBitrate:"0",preset:"veryslow"}},ou=[{value:"original",label:"Original",pixels:""},{value:"2160p",label:"4K",pixels:"3840Ã—2160"},{value:"1440p",label:"2K",pixels:"2560Ã—1440"},{value:"1080p",label:"Full HD",pixels:"1920Ã—1080"},{value:"720p",label:"HD",pixels:"1280Ã—720"},{value:"480p",label:"SD",pixels:"854Ã—480"},{value:"360p",label:"Low",pixels:"640Ã—360"}],cu=[{value:"64k",label:"64 kbps",desc:"Low"},{value:"128k",label:"128 kbps",desc:"Standard"},{value:"192k",label:"192 kbps",desc:"Good"},{value:"256k",label:"256 kbps",desc:"High"},{value:"320k",label:"320 kbps",desc:"Best"}],sc="squash-settings-v2";function lu(){if(typeof localStorage>"u")return en();try{const r=localStorage.getItem(sc);if(r)return{...en(),...JSON.parse(r)}}catch(r){console.warn("Failed to load settings from localStorage:",r)}return en()}function du(r){if(!(typeof localStorage>"u"))try{localStorage.setItem(sc,JSON.stringify(r))}catch(e){console.warn("Failed to save settings to localStorage:",e)}}function en(){return{quality:"web",outputFormat:"mp4",resolution:"original",audioBitrate:"128k",audioCodec:"aac",stripMetadata:!1,twoPass:!1,preset:"medium",targetSizeMB:void 0}}function uu(r){const e=r.match(/^(\d+)([kmg])?$/i);if(!e)return 1e6;const t=parseInt(e[1],10);switch(e[2]?.toLowerCase()){case"k":return t*1e3;case"m":return t*1e6;case"g":return t*1e9;default:return t}}function fu(r,e){if(e.targetSizeMB)return e.targetSizeMB*1024*1024;const t=ls(r);if(!t||t<=0)return 0;const i=Wa[e.quality],a=uu(i.targetBitrate);if(e.quality==="lossless")return r.originalSize*.9;let s=0;e.audioCodec!=="none"&&(s={"64k":64e3,"128k":128e3,"192k":192e3,"256k":256e3,"320k":32e4}[e.audioBitrate]||128e3);const o=(a+s)*t/8;return Math.round(o)}function hu(r,e,t){const i=ls(r);if(!i||i<=0)return 2e6;const a=e*1024*1024;let s=0;t.audioCodec!=="none"&&(s={"64k":64e3,"128k":128e3,"192k":192e3,"256k":256e3,"320k":32e4}[t.audioBitrate]||128e3);const n=s*i/8,o=a-n;if(o<=0)return 1e5;const c=o*8/i;return Math.max(1e5,Math.min(2e7,Math.round(c)))}function ls(r){const e=r.duration||0;if(r.trimStart!==void 0||r.trimEnd!==void 0){const t=r.trimStart||0,i=r.trimEnd??e;return Math.max(0,i-t)}return e}async function mu(r){return new Promise((e,t)=>{const i=document.createElement("video");i.preload="metadata";const a=URL.createObjectURL(r);i.onloadedmetadata=()=>{URL.revokeObjectURL(a);const s=r.size*8/i.duration;e({width:i.videoWidth,height:i.videoHeight,duration:i.duration,bitrate:s})},i.onerror=()=>{URL.revokeObjectURL(a),t(new Error("Failed to load video metadata"))},i.src=a})}function pu(r,e){const{width:t=1920,height:i=1080,duration:a=60}=r,s=t*i;Wa[e.quality];let n=1;const o=s/(1920*1080);n*=Math.sqrt(o),n*={ultrafast:.3,veryfast:.5,fast:.7,medium:1,slow:1.5,veryslow:2.5}[e.preset]||1,e.outputFormat==="webm"?n*=1.5:e.outputFormat==="av1"&&(n*=.8),e.twoPass&&(n*=1.8);const l=Math.max(2,navigator.hardwareConcurrency-2);return n/=Math.sqrt(l/4),Math.round(a*n)}function gu(){let r=We(Ti([])),e=We(Ti(lu()));function t(a,s){const n={"video/mp4":"mp4","video/webm":"webm","video/quicktime":"mov","video/x-msvideo":"avi","video/avi":"avi","video/x-matroska":"mkv"};if(n[a])return n[a];const o=s.toLowerCase().split(".").pop();return{mp4:"mp4",m4v:"mp4",webm:"webm",mov:"mov",avi:"avi",mkv:"mkv"}[o||""]||"mp4"}function i(){return`vid_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}return{get items(){return x(r)},get settings(){return x(e)},async addFiles(a){const s=["video/mp4","video/webm","video/quicktime","video/x-msvideo","video/avi","video/x-matroska"],n=["mp4","m4v","webm","mov","avi","mkv"],o=[];for(const c of a){const l=c.name.toLowerCase().split(".").pop()||"",d=s.includes(c.type),u=n.includes(l);if(!d&&!u)continue;const f=t(c.type,c.name);let h,g,m,v;try{const p=await mu(c);h=p.width,g=p.height,m=p.duration,v=p.bitrate}catch{console.warn("Failed to get metadata for",c.name)}o.push({id:i(),file:c,name:c.name,originalSize:c.size,originalUrl:URL.createObjectURL(c),format:f,outputFormat:x(e).outputFormat,status:"pending",progress:0,width:h,height:g,duration:m,bitrate:v})}return ne(r,[...x(r),...o],!0),o},updateItem(a,s){ne(r,x(r).map(n=>n.id===a?{...n,...s}:n),!0)},removeItem(a){const s=x(r).find(n=>n.id===a);s&&(URL.revokeObjectURL(s.originalUrl),s.compressedUrl&&URL.revokeObjectURL(s.compressedUrl),s.previewUrl&&URL.revokeObjectURL(s.previewUrl)),ne(r,x(r).filter(n=>n.id!==a),!0)},clearAll(){x(r).forEach(a=>{URL.revokeObjectURL(a.originalUrl),a.compressedUrl&&URL.revokeObjectURL(a.compressedUrl),a.previewUrl&&URL.revokeObjectURL(a.previewUrl)}),ne(r,[],!0)},updateSettings(a){ne(e,{...x(e),...a},!0),du(x(e)),a.outputFormat!==void 0&&ne(r,x(r).map(s=>s.status==="pending"?{...s,outputFormat:a.outputFormat}:s),!0)},getItemById(a){return x(r).find(s=>s.id===a)},reorderItems(a,s){const n=[...x(r)],[o]=n.splice(a,1);n.splice(s,0,o),ne(r,n,!0)},getPendingItems(){return x(r).filter(a=>a.status==="pending")},getCompletedItems(){return x(r).filter(a=>a.status==="completed")}}}const de=gu();var vu=re('<span class="text-accent-start font-medium">Release to add more</span>'),bu=re('Drop more videos or <span class="text-accent-start font-medium">click to browse</span>',1),wu=re('<div><div class="bg-surface-800 group-hover:bg-accent-start/10 flex h-10 w-10 items-center justify-center rounded-xl transition-colors"><!></div> <p class="text-surface-500 text-base"><!></p></div>'),yu=re('<p class="text-accent-start text-xl font-semibold">Release to upload</p> <p class="text-accent-start/70 mt-2 text-base">Your videos are ready to be compressed</p>',1),ku=re('<p class="text-surface-300 text-xl font-semibold">Drop videos here</p> <p class="text-surface-500 mt-2 text-base">or <span class="text-accent-start font-medium underline-offset-2 hover:underline">click to browse</span></p>',1),xu=re("<span> </span>"),_u=re(`<div><div class="absolute inset-0 opacity-[0.05]" style="background-image: url(&quot;data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23f97316' fill-opacity='1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E&quot;);"></div> <div class="relative flex flex-col items-center justify-center px-6 text-center"><div><!></div> <!> <div class="mt-6 flex flex-wrap items-center justify-center gap-2"></div> <p class="text-surface-400 mt-5 text-sm">Max file size: Unlimited â€¢ Batch upload supported</p></div></div>`),Tu=re('<div class="relative" role="button" tabindex="0"><input type="file" multiple class="hidden"/> <!></div>');function Zs(r,e){Qt(e,!0);let t=We(!1),i;const a=".mp4,.webm,.mov,.avi,.mkv",s=Ke(()=>de.items.length>0),n=[{name:"MP4",color:"from-orange-500 to-red-500"},{name:"WebM",color:"from-green-500 to-emerald-500"},{name:"MOV",color:"from-blue-500 to-indigo-500"},{name:"AVI",color:"from-purple-500 to-pink-500"},{name:"MKV",color:"from-cyan-500 to-teal-500"}];function o(b){b.preventDefault(),ne(t,!0)}function c(b){b.preventDefault();const y=b.currentTarget.getBoundingClientRect(),_=b.clientX,S=b.clientY;(_<y.left||_>y.right||S<y.top||S>y.bottom)&&ne(t,!1)}function l(b){b.preventDefault()}async function d(b){b.preventDefault(),ne(t,!1);const y=b.dataTransfer?.files;y&&y.length>0&&await de.addFiles(y)}async function u(b){const y=b.target,_=y.files;_&&_.length>0&&await de.addFiles(_),y.value=""}function f(){i?.click()}var h=Tu();h.__click=f,h.__keydown=b=>b.key==="Enter"&&f();var g=E(h);ct(g,"accept",a),g.__change=u,Fi(g,b=>i=b,()=>i);var m=R(g,2);{var v=b=>{var y=wu(),_=E(y),S=E(_);{var A=P=>{zi(P,{class:"text-accent-start h-5 w-5 animate-pulse"})},z=P=>{zn(P,{class:"text-surface-400 group-hover:text-accent-start h-5 w-5"})};ce(S,P=>{x(t)?P(A):P(z,!1)})}C(_);var D=R(_,2),M=E(D);{var $=P=>{var O=vu();W(P,O)},K=P=>{var O=bu();Me(),W(P,O)};ce(M,P=>{x(t)?P($):P(K,!1)})}C(D),C(y),_e(()=>Ge(y,1,`group flex cursor-pointer items-center justify-center gap-4 rounded-2xl border-2 border-dashed px-6 py-4 transition-all duration-300 sm:py-5 ${x(t)?"border-accent-start bg-accent-start/5":"border-surface-700 hover:border-accent-start/50"}`)),W(b,y)},p=b=>{var y=_u(),_=R(E(y),2),S=E(_),A=E(S);{var z=O=>{zi(O,{class:"text-accent-start h-8 w-8 animate-pulse"})},D=O=>{zn(O,{class:"text-surface-400 group-hover:text-accent-start h-8 w-8 transition-all group-hover:-translate-y-1"})};ce(A,O=>{x(t)?O(z):O(D,!1)})}C(S);var M=R(S,2);{var $=O=>{var k=yu();Me(2),W(O,k)},K=O=>{var k=ku();Me(2),W(O,k)};ce(M,O=>{x(t)?O($):O(K,!1)})}var P=R(M,2);yt(P,21,()=>n,Tt,(O,k)=>{var Q=xu(),se=E(Q,!0);C(Q),_e(()=>{Ge(Q,1,`rounded-lg bg-gradient-to-r ${x(k).color??""} px-3 py-1 text-xs font-semibold text-white shadow-sm transition-transform hover:scale-105`),ge(se,x(k).name)}),W(O,Q)}),C(P),Me(2),C(_),C(y),_e(()=>{Ge(y,1,`group relative cursor-pointer overflow-hidden rounded-2xl border-2 border-dashed py-12 transition-all duration-300 sm:py-16 ${x(t)?"border-accent-start bg-accent-start/5 scale-[1.01]":"border-surface-700 hover:border-accent-start/50"}`),Ge(S,1,`mb-5 flex h-16 w-16 items-center justify-center rounded-2xl transition-all duration-300 ${x(t)?"bg-accent-start/20 rotate-3 scale-110":"bg-surface-800 group-hover:bg-accent-start/10 group-hover:scale-105"}`)}),W(b,y)};ce(m,b=>{x(s)?b(v):b(p,!1)})}C(h),St("dragenter",h,o),St("dragleave",h,c),St("dragover",h,l),St("drop",h,d),W(r,h),Xt()}Wt(["click","keydown","change"]);var ya=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Su(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}function ka(r){throw new Error('Could not dynamically require "'+r+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var tn={exports:{}};var Ys;function Cu(){return Ys||(Ys=1,(function(r,e){(function(t){r.exports=t()})(function(){return(function t(i,a,s){function n(l,d){if(!a[l]){if(!i[l]){var u=typeof ka=="function"&&ka;if(!d&&u)return u(l,!0);if(o)return o(l,!0);var f=new Error("Cannot find module '"+l+"'");throw f.code="MODULE_NOT_FOUND",f}var h=a[l]={exports:{}};i[l][0].call(h.exports,function(g){var m=i[l][1][g];return n(m||g)},h,h.exports,t,i,a,s)}return a[l].exports}for(var o=typeof ka=="function"&&ka,c=0;c<s.length;c++)n(s[c]);return n})({1:[function(t,i,a){var s=t("./utils"),n=t("./support"),o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";a.encode=function(c){for(var l,d,u,f,h,g,m,v=[],p=0,b=c.length,y=b,_=s.getTypeOf(c)!=="string";p<c.length;)y=b-p,u=_?(l=c[p++],d=p<b?c[p++]:0,p<b?c[p++]:0):(l=c.charCodeAt(p++),d=p<b?c.charCodeAt(p++):0,p<b?c.charCodeAt(p++):0),f=l>>2,h=(3&l)<<4|d>>4,g=1<y?(15&d)<<2|u>>6:64,m=2<y?63&u:64,v.push(o.charAt(f)+o.charAt(h)+o.charAt(g)+o.charAt(m));return v.join("")},a.decode=function(c){var l,d,u,f,h,g,m=0,v=0,p="data:";if(c.substr(0,p.length)===p)throw new Error("Invalid base64 input, it looks like a data url.");var b,y=3*(c=c.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(c.charAt(c.length-1)===o.charAt(64)&&y--,c.charAt(c.length-2)===o.charAt(64)&&y--,y%1!=0)throw new Error("Invalid base64 input, bad content length.");for(b=n.uint8array?new Uint8Array(0|y):new Array(0|y);m<c.length;)l=o.indexOf(c.charAt(m++))<<2|(f=o.indexOf(c.charAt(m++)))>>4,d=(15&f)<<4|(h=o.indexOf(c.charAt(m++)))>>2,u=(3&h)<<6|(g=o.indexOf(c.charAt(m++))),b[v++]=l,h!==64&&(b[v++]=d),g!==64&&(b[v++]=u);return b}},{"./support":30,"./utils":32}],2:[function(t,i,a){var s=t("./external"),n=t("./stream/DataWorker"),o=t("./stream/Crc32Probe"),c=t("./stream/DataLengthProbe");function l(d,u,f,h,g){this.compressedSize=d,this.uncompressedSize=u,this.crc32=f,this.compression=h,this.compressedContent=g}l.prototype={getContentWorker:function(){var d=new n(s.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new c("data_length")),u=this;return d.on("end",function(){if(this.streamInfo.data_length!==u.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),d},getCompressedWorker:function(){return new n(s.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},l.createWorkerFrom=function(d,u,f){return d.pipe(new o).pipe(new c("uncompressedSize")).pipe(u.compressWorker(f)).pipe(new c("compressedSize")).withStreamInfo("compression",u)},i.exports=l},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(t,i,a){var s=t("./stream/GenericWorker");a.STORE={magic:"\0\0",compressWorker:function(){return new s("STORE compression")},uncompressWorker:function(){return new s("STORE decompression")}},a.DEFLATE=t("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(t,i,a){var s=t("./utils"),n=(function(){for(var o,c=[],l=0;l<256;l++){o=l;for(var d=0;d<8;d++)o=1&o?3988292384^o>>>1:o>>>1;c[l]=o}return c})();i.exports=function(o,c){return o!==void 0&&o.length?s.getTypeOf(o)!=="string"?(function(l,d,u,f){var h=n,g=f+u;l^=-1;for(var m=f;m<g;m++)l=l>>>8^h[255&(l^d[m])];return-1^l})(0|c,o,o.length,0):(function(l,d,u,f){var h=n,g=f+u;l^=-1;for(var m=f;m<g;m++)l=l>>>8^h[255&(l^d.charCodeAt(m))];return-1^l})(0|c,o,o.length,0):0}},{"./utils":32}],5:[function(t,i,a){a.base64=!1,a.binary=!1,a.dir=!1,a.createFolders=!0,a.date=null,a.compression=null,a.compressionOptions=null,a.comment=null,a.unixPermissions=null,a.dosPermissions=null},{}],6:[function(t,i,a){var s=null;s=typeof Promise<"u"?Promise:t("lie"),i.exports={Promise:s}},{lie:37}],7:[function(t,i,a){var s=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",n=t("pako"),o=t("./utils"),c=t("./stream/GenericWorker"),l=s?"uint8array":"array";function d(u,f){c.call(this,"FlateWorker/"+u),this._pako=null,this._pakoAction=u,this._pakoOptions=f,this.meta={}}a.magic="\b\0",o.inherits(d,c),d.prototype.processChunk=function(u){this.meta=u.meta,this._pako===null&&this._createPako(),this._pako.push(o.transformTo(l,u.data),!1)},d.prototype.flush=function(){c.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},d.prototype.cleanUp=function(){c.prototype.cleanUp.call(this),this._pako=null},d.prototype._createPako=function(){this._pako=new n[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var u=this;this._pako.onData=function(f){u.push({data:f,meta:u.meta})}},a.compressWorker=function(u){return new d("Deflate",u)},a.uncompressWorker=function(){return new d("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(t,i,a){function s(h,g){var m,v="";for(m=0;m<g;m++)v+=String.fromCharCode(255&h),h>>>=8;return v}function n(h,g,m,v,p,b){var y,_,S=h.file,A=h.compression,z=b!==l.utf8encode,D=o.transformTo("string",b(S.name)),M=o.transformTo("string",l.utf8encode(S.name)),$=S.comment,K=o.transformTo("string",b($)),P=o.transformTo("string",l.utf8encode($)),O=M.length!==S.name.length,k=P.length!==$.length,Q="",se="",Y="",be=S.dir,ee=S.date,me={crc32:0,compressedSize:0,uncompressedSize:0};g&&!m||(me.crc32=h.crc32,me.compressedSize=h.compressedSize,me.uncompressedSize=h.uncompressedSize);var q=0;g&&(q|=8),z||!O&&!k||(q|=2048);var V=0,ue=0;be&&(V|=16),p==="UNIX"?(ue=798,V|=(function(j,te){var le=j;return j||(le=te?16893:33204),(65535&le)<<16})(S.unixPermissions,be)):(ue=20,V|=(function(j){return 63&(j||0)})(S.dosPermissions)),y=ee.getUTCHours(),y<<=6,y|=ee.getUTCMinutes(),y<<=5,y|=ee.getUTCSeconds()/2,_=ee.getUTCFullYear()-1980,_<<=4,_|=ee.getUTCMonth()+1,_<<=5,_|=ee.getUTCDate(),O&&(se=s(1,1)+s(d(D),4)+M,Q+="up"+s(se.length,2)+se),k&&(Y=s(1,1)+s(d(K),4)+P,Q+="uc"+s(Y.length,2)+Y);var oe="";return oe+=`
\0`,oe+=s(q,2),oe+=A.magic,oe+=s(y,2),oe+=s(_,2),oe+=s(me.crc32,4),oe+=s(me.compressedSize,4),oe+=s(me.uncompressedSize,4),oe+=s(D.length,2),oe+=s(Q.length,2),{fileRecord:u.LOCAL_FILE_HEADER+oe+D+Q,dirRecord:u.CENTRAL_FILE_HEADER+s(ue,2)+oe+s(K.length,2)+"\0\0\0\0"+s(V,4)+s(v,4)+D+Q+K}}var o=t("../utils"),c=t("../stream/GenericWorker"),l=t("../utf8"),d=t("../crc32"),u=t("../signature");function f(h,g,m,v){c.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=g,this.zipPlatform=m,this.encodeFileName=v,this.streamFiles=h,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}o.inherits(f,c),f.prototype.push=function(h){var g=h.meta.percent||0,m=this.entriesCount,v=this._sources.length;this.accumulate?this.contentBuffer.push(h):(this.bytesWritten+=h.data.length,c.prototype.push.call(this,{data:h.data,meta:{currentFile:this.currentFile,percent:m?(g+100*(m-v-1))/m:100}}))},f.prototype.openedSource=function(h){this.currentSourceOffset=this.bytesWritten,this.currentFile=h.file.name;var g=this.streamFiles&&!h.file.dir;if(g){var m=n(h,g,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:m.fileRecord,meta:{percent:0}})}else this.accumulate=!0},f.prototype.closedSource=function(h){this.accumulate=!1;var g=this.streamFiles&&!h.file.dir,m=n(h,g,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(m.dirRecord),g)this.push({data:(function(v){return u.DATA_DESCRIPTOR+s(v.crc32,4)+s(v.compressedSize,4)+s(v.uncompressedSize,4)})(h),meta:{percent:100}});else for(this.push({data:m.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},f.prototype.flush=function(){for(var h=this.bytesWritten,g=0;g<this.dirRecords.length;g++)this.push({data:this.dirRecords[g],meta:{percent:100}});var m=this.bytesWritten-h,v=(function(p,b,y,_,S){var A=o.transformTo("string",S(_));return u.CENTRAL_DIRECTORY_END+"\0\0\0\0"+s(p,2)+s(p,2)+s(b,4)+s(y,4)+s(A.length,2)+A})(this.dirRecords.length,m,h,this.zipComment,this.encodeFileName);this.push({data:v,meta:{percent:100}})},f.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},f.prototype.registerPrevious=function(h){this._sources.push(h);var g=this;return h.on("data",function(m){g.processChunk(m)}),h.on("end",function(){g.closedSource(g.previous.streamInfo),g._sources.length?g.prepareNextSource():g.end()}),h.on("error",function(m){g.error(m)}),this},f.prototype.resume=function(){return!!c.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},f.prototype.error=function(h){var g=this._sources;if(!c.prototype.error.call(this,h))return!1;for(var m=0;m<g.length;m++)try{g[m].error(h)}catch{}return!0},f.prototype.lock=function(){c.prototype.lock.call(this);for(var h=this._sources,g=0;g<h.length;g++)h[g].lock()},i.exports=f},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(t,i,a){var s=t("../compressions"),n=t("./ZipFileWorker");a.generateWorker=function(o,c,l){var d=new n(c.streamFiles,l,c.platform,c.encodeFileName),u=0;try{o.forEach(function(f,h){u++;var g=(function(b,y){var _=b||y,S=s[_];if(!S)throw new Error(_+" is not a valid compression method !");return S})(h.options.compression,c.compression),m=h.options.compressionOptions||c.compressionOptions||{},v=h.dir,p=h.date;h._compressWorker(g,m).withStreamInfo("file",{name:f,dir:v,date:p,comment:h.comment||"",unixPermissions:h.unixPermissions,dosPermissions:h.dosPermissions}).pipe(d)}),d.entriesCount=u}catch(f){d.error(f)}return d}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(t,i,a){function s(){if(!(this instanceof s))return new s;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var n=new s;for(var o in this)typeof this[o]!="function"&&(n[o]=this[o]);return n}}(s.prototype=t("./object")).loadAsync=t("./load"),s.support=t("./support"),s.defaults=t("./defaults"),s.version="3.10.1",s.loadAsync=function(n,o){return new s().loadAsync(n,o)},s.external=t("./external"),i.exports=s},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(t,i,a){var s=t("./utils"),n=t("./external"),o=t("./utf8"),c=t("./zipEntries"),l=t("./stream/Crc32Probe"),d=t("./nodejsUtils");function u(f){return new n.Promise(function(h,g){var m=f.decompressed.getContentWorker().pipe(new l);m.on("error",function(v){g(v)}).on("end",function(){m.streamInfo.crc32!==f.decompressed.crc32?g(new Error("Corrupted zip : CRC32 mismatch")):h()}).resume()})}i.exports=function(f,h){var g=this;return h=s.extend(h||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:o.utf8decode}),d.isNode&&d.isStream(f)?n.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):s.prepareContent("the loaded zip file",f,!0,h.optimizedBinaryString,h.base64).then(function(m){var v=new c(h);return v.load(m),v}).then(function(m){var v=[n.Promise.resolve(m)],p=m.files;if(h.checkCRC32)for(var b=0;b<p.length;b++)v.push(u(p[b]));return n.Promise.all(v)}).then(function(m){for(var v=m.shift(),p=v.files,b=0;b<p.length;b++){var y=p[b],_=y.fileNameStr,S=s.resolve(y.fileNameStr);g.file(S,y.decompressed,{binary:!0,optimizedBinaryString:!0,date:y.date,dir:y.dir,comment:y.fileCommentStr.length?y.fileCommentStr:null,unixPermissions:y.unixPermissions,dosPermissions:y.dosPermissions,createFolders:h.createFolders}),y.dir||(g.file(S).unsafeOriginalName=_)}return v.zipComment.length&&(g.comment=v.zipComment),g})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(t,i,a){var s=t("../utils"),n=t("../stream/GenericWorker");function o(c,l){n.call(this,"Nodejs stream input adapter for "+c),this._upstreamEnded=!1,this._bindStream(l)}s.inherits(o,n),o.prototype._bindStream=function(c){var l=this;(this._stream=c).pause(),c.on("data",function(d){l.push({data:d,meta:{percent:0}})}).on("error",function(d){l.isPaused?this.generatedError=d:l.error(d)}).on("end",function(){l.isPaused?l._upstreamEnded=!0:l.end()})},o.prototype.pause=function(){return!!n.prototype.pause.call(this)&&(this._stream.pause(),!0)},o.prototype.resume=function(){return!!n.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},i.exports=o},{"../stream/GenericWorker":28,"../utils":32}],13:[function(t,i,a){var s=t("readable-stream").Readable;function n(o,c,l){s.call(this,c),this._helper=o;var d=this;o.on("data",function(u,f){d.push(u)||d._helper.pause(),l&&l(f)}).on("error",function(u){d.emit("error",u)}).on("end",function(){d.push(null)})}t("../utils").inherits(n,s),n.prototype._read=function(){this._helper.resume()},i.exports=n},{"../utils":32,"readable-stream":16}],14:[function(t,i,a){i.exports={isNode:typeof Buffer<"u",newBufferFrom:function(s,n){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(s,n);if(typeof s=="number")throw new Error('The "data" argument must not be a number');return new Buffer(s,n)},allocBuffer:function(s){if(Buffer.alloc)return Buffer.alloc(s);var n=new Buffer(s);return n.fill(0),n},isBuffer:function(s){return Buffer.isBuffer(s)},isStream:function(s){return s&&typeof s.on=="function"&&typeof s.pause=="function"&&typeof s.resume=="function"}}},{}],15:[function(t,i,a){function s(S,A,z){var D,M=o.getTypeOf(A),$=o.extend(z||{},d);$.date=$.date||new Date,$.compression!==null&&($.compression=$.compression.toUpperCase()),typeof $.unixPermissions=="string"&&($.unixPermissions=parseInt($.unixPermissions,8)),$.unixPermissions&&16384&$.unixPermissions&&($.dir=!0),$.dosPermissions&&16&$.dosPermissions&&($.dir=!0),$.dir&&(S=p(S)),$.createFolders&&(D=v(S))&&b.call(this,D,!0);var K=M==="string"&&$.binary===!1&&$.base64===!1;z&&z.binary!==void 0||($.binary=!K),(A instanceof u&&A.uncompressedSize===0||$.dir||!A||A.length===0)&&($.base64=!1,$.binary=!0,A="",$.compression="STORE",M="string");var P=null;P=A instanceof u||A instanceof c?A:g.isNode&&g.isStream(A)?new m(S,A):o.prepareContent(S,A,$.binary,$.optimizedBinaryString,$.base64);var O=new f(S,P,$);this.files[S]=O}var n=t("./utf8"),o=t("./utils"),c=t("./stream/GenericWorker"),l=t("./stream/StreamHelper"),d=t("./defaults"),u=t("./compressedObject"),f=t("./zipObject"),h=t("./generate"),g=t("./nodejsUtils"),m=t("./nodejs/NodejsStreamInputAdapter"),v=function(S){S.slice(-1)==="/"&&(S=S.substring(0,S.length-1));var A=S.lastIndexOf("/");return 0<A?S.substring(0,A):""},p=function(S){return S.slice(-1)!=="/"&&(S+="/"),S},b=function(S,A){return A=A!==void 0?A:d.createFolders,S=p(S),this.files[S]||s.call(this,S,null,{dir:!0,createFolders:A}),this.files[S]};function y(S){return Object.prototype.toString.call(S)==="[object RegExp]"}var _={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(S){var A,z,D;for(A in this.files)D=this.files[A],(z=A.slice(this.root.length,A.length))&&A.slice(0,this.root.length)===this.root&&S(z,D)},filter:function(S){var A=[];return this.forEach(function(z,D){S(z,D)&&A.push(D)}),A},file:function(S,A,z){if(arguments.length!==1)return S=this.root+S,s.call(this,S,A,z),this;if(y(S)){var D=S;return this.filter(function($,K){return!K.dir&&D.test($)})}var M=this.files[this.root+S];return M&&!M.dir?M:null},folder:function(S){if(!S)return this;if(y(S))return this.filter(function(M,$){return $.dir&&S.test(M)});var A=this.root+S,z=b.call(this,A),D=this.clone();return D.root=z.name,D},remove:function(S){S=this.root+S;var A=this.files[S];if(A||(S.slice(-1)!=="/"&&(S+="/"),A=this.files[S]),A&&!A.dir)delete this.files[S];else for(var z=this.filter(function(M,$){return $.name.slice(0,S.length)===S}),D=0;D<z.length;D++)delete this.files[z[D].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(S){var A,z={};try{if((z=o.extend(S||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:n.utf8encode})).type=z.type.toLowerCase(),z.compression=z.compression.toUpperCase(),z.type==="binarystring"&&(z.type="string"),!z.type)throw new Error("No output type specified.");o.checkSupport(z.type),z.platform!=="darwin"&&z.platform!=="freebsd"&&z.platform!=="linux"&&z.platform!=="sunos"||(z.platform="UNIX"),z.platform==="win32"&&(z.platform="DOS");var D=z.comment||this.comment||"";A=h.generateWorker(this,z,D)}catch(M){(A=new c("error")).error(M)}return new l(A,z.type||"string",z.mimeType)},generateAsync:function(S,A){return this.generateInternalStream(S).accumulate(A)},generateNodeStream:function(S,A){return(S=S||{}).type||(S.type="nodebuffer"),this.generateInternalStream(S).toNodejsStream(A)}};i.exports=_},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(t,i,a){i.exports=t("stream")},{stream:void 0}],17:[function(t,i,a){var s=t("./DataReader");function n(o){s.call(this,o);for(var c=0;c<this.data.length;c++)o[c]=255&o[c]}t("../utils").inherits(n,s),n.prototype.byteAt=function(o){return this.data[this.zero+o]},n.prototype.lastIndexOfSignature=function(o){for(var c=o.charCodeAt(0),l=o.charCodeAt(1),d=o.charCodeAt(2),u=o.charCodeAt(3),f=this.length-4;0<=f;--f)if(this.data[f]===c&&this.data[f+1]===l&&this.data[f+2]===d&&this.data[f+3]===u)return f-this.zero;return-1},n.prototype.readAndCheckSignature=function(o){var c=o.charCodeAt(0),l=o.charCodeAt(1),d=o.charCodeAt(2),u=o.charCodeAt(3),f=this.readData(4);return c===f[0]&&l===f[1]&&d===f[2]&&u===f[3]},n.prototype.readData=function(o){if(this.checkOffset(o),o===0)return[];var c=this.data.slice(this.zero+this.index,this.zero+this.index+o);return this.index+=o,c},i.exports=n},{"../utils":32,"./DataReader":18}],18:[function(t,i,a){var s=t("../utils");function n(o){this.data=o,this.length=o.length,this.index=0,this.zero=0}n.prototype={checkOffset:function(o){this.checkIndex(this.index+o)},checkIndex:function(o){if(this.length<this.zero+o||o<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+o+"). Corrupted zip ?")},setIndex:function(o){this.checkIndex(o),this.index=o},skip:function(o){this.setIndex(this.index+o)},byteAt:function(){},readInt:function(o){var c,l=0;for(this.checkOffset(o),c=this.index+o-1;c>=this.index;c--)l=(l<<8)+this.byteAt(c);return this.index+=o,l},readString:function(o){return s.transformTo("string",this.readData(o))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var o=this.readInt(4);return new Date(Date.UTC(1980+(o>>25&127),(o>>21&15)-1,o>>16&31,o>>11&31,o>>5&63,(31&o)<<1))}},i.exports=n},{"../utils":32}],19:[function(t,i,a){var s=t("./Uint8ArrayReader");function n(o){s.call(this,o)}t("../utils").inherits(n,s),n.prototype.readData=function(o){this.checkOffset(o);var c=this.data.slice(this.zero+this.index,this.zero+this.index+o);return this.index+=o,c},i.exports=n},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(t,i,a){var s=t("./DataReader");function n(o){s.call(this,o)}t("../utils").inherits(n,s),n.prototype.byteAt=function(o){return this.data.charCodeAt(this.zero+o)},n.prototype.lastIndexOfSignature=function(o){return this.data.lastIndexOf(o)-this.zero},n.prototype.readAndCheckSignature=function(o){return o===this.readData(4)},n.prototype.readData=function(o){this.checkOffset(o);var c=this.data.slice(this.zero+this.index,this.zero+this.index+o);return this.index+=o,c},i.exports=n},{"../utils":32,"./DataReader":18}],21:[function(t,i,a){var s=t("./ArrayReader");function n(o){s.call(this,o)}t("../utils").inherits(n,s),n.prototype.readData=function(o){if(this.checkOffset(o),o===0)return new Uint8Array(0);var c=this.data.subarray(this.zero+this.index,this.zero+this.index+o);return this.index+=o,c},i.exports=n},{"../utils":32,"./ArrayReader":17}],22:[function(t,i,a){var s=t("../utils"),n=t("../support"),o=t("./ArrayReader"),c=t("./StringReader"),l=t("./NodeBufferReader"),d=t("./Uint8ArrayReader");i.exports=function(u){var f=s.getTypeOf(u);return s.checkSupport(f),f!=="string"||n.uint8array?f==="nodebuffer"?new l(u):n.uint8array?new d(s.transformTo("uint8array",u)):new o(s.transformTo("array",u)):new c(u)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(t,i,a){a.LOCAL_FILE_HEADER="PK",a.CENTRAL_FILE_HEADER="PK",a.CENTRAL_DIRECTORY_END="PK",a.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",a.ZIP64_CENTRAL_DIRECTORY_END="PK",a.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(t,i,a){var s=t("./GenericWorker"),n=t("../utils");function o(c){s.call(this,"ConvertWorker to "+c),this.destType=c}n.inherits(o,s),o.prototype.processChunk=function(c){this.push({data:n.transformTo(this.destType,c.data),meta:c.meta})},i.exports=o},{"../utils":32,"./GenericWorker":28}],25:[function(t,i,a){var s=t("./GenericWorker"),n=t("../crc32");function o(){s.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}t("../utils").inherits(o,s),o.prototype.processChunk=function(c){this.streamInfo.crc32=n(c.data,this.streamInfo.crc32||0),this.push(c)},i.exports=o},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(t,i,a){var s=t("../utils"),n=t("./GenericWorker");function o(c){n.call(this,"DataLengthProbe for "+c),this.propName=c,this.withStreamInfo(c,0)}s.inherits(o,n),o.prototype.processChunk=function(c){if(c){var l=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=l+c.data.length}n.prototype.processChunk.call(this,c)},i.exports=o},{"../utils":32,"./GenericWorker":28}],27:[function(t,i,a){var s=t("../utils"),n=t("./GenericWorker");function o(c){n.call(this,"DataWorker");var l=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,c.then(function(d){l.dataIsReady=!0,l.data=d,l.max=d&&d.length||0,l.type=s.getTypeOf(d),l.isPaused||l._tickAndRepeat()},function(d){l.error(d)})}s.inherits(o,n),o.prototype.cleanUp=function(){n.prototype.cleanUp.call(this),this.data=null},o.prototype.resume=function(){return!!n.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,s.delay(this._tickAndRepeat,[],this)),!0)},o.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(s.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},o.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var c=null,l=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":c=this.data.substring(this.index,l);break;case"uint8array":c=this.data.subarray(this.index,l);break;case"array":case"nodebuffer":c=this.data.slice(this.index,l)}return this.index=l,this.push({data:c,meta:{percent:this.max?this.index/this.max*100:0}})},i.exports=o},{"../utils":32,"./GenericWorker":28}],28:[function(t,i,a){function s(n){this.name=n||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}s.prototype={push:function(n){this.emit("data",n)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(n){this.emit("error",n)}return!0},error:function(n){return!this.isFinished&&(this.isPaused?this.generatedError=n:(this.isFinished=!0,this.emit("error",n),this.previous&&this.previous.error(n),this.cleanUp()),!0)},on:function(n,o){return this._listeners[n].push(o),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(n,o){if(this._listeners[n])for(var c=0;c<this._listeners[n].length;c++)this._listeners[n][c].call(this,o)},pipe:function(n){return n.registerPrevious(this)},registerPrevious:function(n){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=n.streamInfo,this.mergeStreamInfo(),this.previous=n;var o=this;return n.on("data",function(c){o.processChunk(c)}),n.on("end",function(){o.end()}),n.on("error",function(c){o.error(c)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var n=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),n=!0),this.previous&&this.previous.resume(),!n},flush:function(){},processChunk:function(n){this.push(n)},withStreamInfo:function(n,o){return this.extraStreamInfo[n]=o,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var n in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,n)&&(this.streamInfo[n]=this.extraStreamInfo[n])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var n="Worker "+this.name;return this.previous?this.previous+" -> "+n:n}},i.exports=s},{}],29:[function(t,i,a){var s=t("../utils"),n=t("./ConvertWorker"),o=t("./GenericWorker"),c=t("../base64"),l=t("../support"),d=t("../external"),u=null;if(l.nodestream)try{u=t("../nodejs/NodejsStreamOutputAdapter")}catch{}function f(g,m){return new d.Promise(function(v,p){var b=[],y=g._internalType,_=g._outputType,S=g._mimeType;g.on("data",function(A,z){b.push(A),m&&m(z)}).on("error",function(A){b=[],p(A)}).on("end",function(){try{var A=(function(z,D,M){switch(z){case"blob":return s.newBlob(s.transformTo("arraybuffer",D),M);case"base64":return c.encode(D);default:return s.transformTo(z,D)}})(_,(function(z,D){var M,$=0,K=null,P=0;for(M=0;M<D.length;M++)P+=D[M].length;switch(z){case"string":return D.join("");case"array":return Array.prototype.concat.apply([],D);case"uint8array":for(K=new Uint8Array(P),M=0;M<D.length;M++)K.set(D[M],$),$+=D[M].length;return K;case"nodebuffer":return Buffer.concat(D);default:throw new Error("concat : unsupported type '"+z+"'")}})(y,b),S);v(A)}catch(z){p(z)}b=[]}).resume()})}function h(g,m,v){var p=m;switch(m){case"blob":case"arraybuffer":p="uint8array";break;case"base64":p="string"}try{this._internalType=p,this._outputType=m,this._mimeType=v,s.checkSupport(p),this._worker=g.pipe(new n(p)),g.lock()}catch(b){this._worker=new o("error"),this._worker.error(b)}}h.prototype={accumulate:function(g){return f(this,g)},on:function(g,m){var v=this;return g==="data"?this._worker.on(g,function(p){m.call(v,p.data,p.meta)}):this._worker.on(g,function(){s.delay(m,arguments,v)}),this},resume:function(){return s.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(g){if(s.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new u(this,{objectMode:this._outputType!=="nodebuffer"},g)}},i.exports=h},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(t,i,a){if(a.base64=!0,a.array=!0,a.string=!0,a.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",a.nodebuffer=typeof Buffer<"u",a.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")a.blob=!1;else{var s=new ArrayBuffer(0);try{a.blob=new Blob([s],{type:"application/zip"}).size===0}catch{try{var n=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);n.append(s),a.blob=n.getBlob("application/zip").size===0}catch{a.blob=!1}}}try{a.nodestream=!!t("readable-stream").Readable}catch{a.nodestream=!1}},{"readable-stream":16}],31:[function(t,i,a){for(var s=t("./utils"),n=t("./support"),o=t("./nodejsUtils"),c=t("./stream/GenericWorker"),l=new Array(256),d=0;d<256;d++)l[d]=252<=d?6:248<=d?5:240<=d?4:224<=d?3:192<=d?2:1;l[254]=l[254]=1;function u(){c.call(this,"utf-8 decode"),this.leftOver=null}function f(){c.call(this,"utf-8 encode")}a.utf8encode=function(h){return n.nodebuffer?o.newBufferFrom(h,"utf-8"):(function(g){var m,v,p,b,y,_=g.length,S=0;for(b=0;b<_;b++)(64512&(v=g.charCodeAt(b)))==55296&&b+1<_&&(64512&(p=g.charCodeAt(b+1)))==56320&&(v=65536+(v-55296<<10)+(p-56320),b++),S+=v<128?1:v<2048?2:v<65536?3:4;for(m=n.uint8array?new Uint8Array(S):new Array(S),b=y=0;y<S;b++)(64512&(v=g.charCodeAt(b)))==55296&&b+1<_&&(64512&(p=g.charCodeAt(b+1)))==56320&&(v=65536+(v-55296<<10)+(p-56320),b++),v<128?m[y++]=v:(v<2048?m[y++]=192|v>>>6:(v<65536?m[y++]=224|v>>>12:(m[y++]=240|v>>>18,m[y++]=128|v>>>12&63),m[y++]=128|v>>>6&63),m[y++]=128|63&v);return m})(h)},a.utf8decode=function(h){return n.nodebuffer?s.transformTo("nodebuffer",h).toString("utf-8"):(function(g){var m,v,p,b,y=g.length,_=new Array(2*y);for(m=v=0;m<y;)if((p=g[m++])<128)_[v++]=p;else if(4<(b=l[p]))_[v++]=65533,m+=b-1;else{for(p&=b===2?31:b===3?15:7;1<b&&m<y;)p=p<<6|63&g[m++],b--;1<b?_[v++]=65533:p<65536?_[v++]=p:(p-=65536,_[v++]=55296|p>>10&1023,_[v++]=56320|1023&p)}return _.length!==v&&(_.subarray?_=_.subarray(0,v):_.length=v),s.applyFromCharCode(_)})(h=s.transformTo(n.uint8array?"uint8array":"array",h))},s.inherits(u,c),u.prototype.processChunk=function(h){var g=s.transformTo(n.uint8array?"uint8array":"array",h.data);if(this.leftOver&&this.leftOver.length){if(n.uint8array){var m=g;(g=new Uint8Array(m.length+this.leftOver.length)).set(this.leftOver,0),g.set(m,this.leftOver.length)}else g=this.leftOver.concat(g);this.leftOver=null}var v=(function(b,y){var _;for((y=y||b.length)>b.length&&(y=b.length),_=y-1;0<=_&&(192&b[_])==128;)_--;return _<0||_===0?y:_+l[b[_]]>y?_:y})(g),p=g;v!==g.length&&(n.uint8array?(p=g.subarray(0,v),this.leftOver=g.subarray(v,g.length)):(p=g.slice(0,v),this.leftOver=g.slice(v,g.length))),this.push({data:a.utf8decode(p),meta:h.meta})},u.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:a.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},a.Utf8DecodeWorker=u,s.inherits(f,c),f.prototype.processChunk=function(h){this.push({data:a.utf8encode(h.data),meta:h.meta})},a.Utf8EncodeWorker=f},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(t,i,a){var s=t("./support"),n=t("./base64"),o=t("./nodejsUtils"),c=t("./external");function l(m){return m}function d(m,v){for(var p=0;p<m.length;++p)v[p]=255&m.charCodeAt(p);return v}t("setimmediate"),a.newBlob=function(m,v){a.checkSupport("blob");try{return new Blob([m],{type:v})}catch{try{var p=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return p.append(m),p.getBlob(v)}catch{throw new Error("Bug : can't construct the Blob.")}}};var u={stringifyByChunk:function(m,v,p){var b=[],y=0,_=m.length;if(_<=p)return String.fromCharCode.apply(null,m);for(;y<_;)v==="array"||v==="nodebuffer"?b.push(String.fromCharCode.apply(null,m.slice(y,Math.min(y+p,_)))):b.push(String.fromCharCode.apply(null,m.subarray(y,Math.min(y+p,_)))),y+=p;return b.join("")},stringifyByChar:function(m){for(var v="",p=0;p<m.length;p++)v+=String.fromCharCode(m[p]);return v},applyCanBeUsed:{uint8array:(function(){try{return s.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}})(),nodebuffer:(function(){try{return s.nodebuffer&&String.fromCharCode.apply(null,o.allocBuffer(1)).length===1}catch{return!1}})()}};function f(m){var v=65536,p=a.getTypeOf(m),b=!0;if(p==="uint8array"?b=u.applyCanBeUsed.uint8array:p==="nodebuffer"&&(b=u.applyCanBeUsed.nodebuffer),b)for(;1<v;)try{return u.stringifyByChunk(m,p,v)}catch{v=Math.floor(v/2)}return u.stringifyByChar(m)}function h(m,v){for(var p=0;p<m.length;p++)v[p]=m[p];return v}a.applyFromCharCode=f;var g={};g.string={string:l,array:function(m){return d(m,new Array(m.length))},arraybuffer:function(m){return g.string.uint8array(m).buffer},uint8array:function(m){return d(m,new Uint8Array(m.length))},nodebuffer:function(m){return d(m,o.allocBuffer(m.length))}},g.array={string:f,array:l,arraybuffer:function(m){return new Uint8Array(m).buffer},uint8array:function(m){return new Uint8Array(m)},nodebuffer:function(m){return o.newBufferFrom(m)}},g.arraybuffer={string:function(m){return f(new Uint8Array(m))},array:function(m){return h(new Uint8Array(m),new Array(m.byteLength))},arraybuffer:l,uint8array:function(m){return new Uint8Array(m)},nodebuffer:function(m){return o.newBufferFrom(new Uint8Array(m))}},g.uint8array={string:f,array:function(m){return h(m,new Array(m.length))},arraybuffer:function(m){return m.buffer},uint8array:l,nodebuffer:function(m){return o.newBufferFrom(m)}},g.nodebuffer={string:f,array:function(m){return h(m,new Array(m.length))},arraybuffer:function(m){return g.nodebuffer.uint8array(m).buffer},uint8array:function(m){return h(m,new Uint8Array(m.length))},nodebuffer:l},a.transformTo=function(m,v){if(v=v||"",!m)return v;a.checkSupport(m);var p=a.getTypeOf(v);return g[p][m](v)},a.resolve=function(m){for(var v=m.split("/"),p=[],b=0;b<v.length;b++){var y=v[b];y==="."||y===""&&b!==0&&b!==v.length-1||(y===".."?p.pop():p.push(y))}return p.join("/")},a.getTypeOf=function(m){return typeof m=="string"?"string":Object.prototype.toString.call(m)==="[object Array]"?"array":s.nodebuffer&&o.isBuffer(m)?"nodebuffer":s.uint8array&&m instanceof Uint8Array?"uint8array":s.arraybuffer&&m instanceof ArrayBuffer?"arraybuffer":void 0},a.checkSupport=function(m){if(!s[m.toLowerCase()])throw new Error(m+" is not supported by this platform")},a.MAX_VALUE_16BITS=65535,a.MAX_VALUE_32BITS=-1,a.pretty=function(m){var v,p,b="";for(p=0;p<(m||"").length;p++)b+="\\x"+((v=m.charCodeAt(p))<16?"0":"")+v.toString(16).toUpperCase();return b},a.delay=function(m,v,p){setImmediate(function(){m.apply(p||null,v||[])})},a.inherits=function(m,v){function p(){}p.prototype=v.prototype,m.prototype=new p},a.extend=function(){var m,v,p={};for(m=0;m<arguments.length;m++)for(v in arguments[m])Object.prototype.hasOwnProperty.call(arguments[m],v)&&p[v]===void 0&&(p[v]=arguments[m][v]);return p},a.prepareContent=function(m,v,p,b,y){return c.Promise.resolve(v).then(function(_){return s.blob&&(_ instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(_))!==-1)&&typeof FileReader<"u"?new c.Promise(function(S,A){var z=new FileReader;z.onload=function(D){S(D.target.result)},z.onerror=function(D){A(D.target.error)},z.readAsArrayBuffer(_)}):_}).then(function(_){var S=a.getTypeOf(_);return S?(S==="arraybuffer"?_=a.transformTo("uint8array",_):S==="string"&&(y?_=n.decode(_):p&&b!==!0&&(_=(function(A){return d(A,s.uint8array?new Uint8Array(A.length):new Array(A.length))})(_))),_):c.Promise.reject(new Error("Can't read the data of '"+m+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(t,i,a){var s=t("./reader/readerFor"),n=t("./utils"),o=t("./signature"),c=t("./zipEntry"),l=t("./support");function d(u){this.files=[],this.loadOptions=u}d.prototype={checkSignature:function(u){if(!this.reader.readAndCheckSignature(u)){this.reader.index-=4;var f=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+n.pretty(f)+", expected "+n.pretty(u)+")")}},isSignature:function(u,f){var h=this.reader.index;this.reader.setIndex(u);var g=this.reader.readString(4)===f;return this.reader.setIndex(h),g},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var u=this.reader.readData(this.zipCommentLength),f=l.uint8array?"uint8array":"array",h=n.transformTo(f,u);this.zipComment=this.loadOptions.decodeFileName(h)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var u,f,h,g=this.zip64EndOfCentralSize-44;0<g;)u=this.reader.readInt(2),f=this.reader.readInt(4),h=this.reader.readData(f),this.zip64ExtensibleData[u]={id:u,length:f,value:h}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var u,f;for(u=0;u<this.files.length;u++)f=this.files[u],this.reader.setIndex(f.localHeaderOffset),this.checkSignature(o.LOCAL_FILE_HEADER),f.readLocalPart(this.reader),f.handleUTF8(),f.processAttributes()},readCentralDir:function(){var u;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(o.CENTRAL_FILE_HEADER);)(u=new c({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(u);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var u=this.reader.lastIndexOfSignature(o.CENTRAL_DIRECTORY_END);if(u<0)throw this.isSignature(0,o.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(u);var f=u;if(this.checkSignature(o.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===n.MAX_VALUE_16BITS||this.diskWithCentralDirStart===n.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===n.MAX_VALUE_16BITS||this.centralDirRecords===n.MAX_VALUE_16BITS||this.centralDirSize===n.MAX_VALUE_32BITS||this.centralDirOffset===n.MAX_VALUE_32BITS){if(this.zip64=!0,(u=this.reader.lastIndexOfSignature(o.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(u),this.checkSignature(o.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,o.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(o.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(o.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var h=this.centralDirOffset+this.centralDirSize;this.zip64&&(h+=20,h+=12+this.zip64EndOfCentralSize);var g=f-h;if(0<g)this.isSignature(f,o.CENTRAL_FILE_HEADER)||(this.reader.zero=g);else if(g<0)throw new Error("Corrupted zip: missing "+Math.abs(g)+" bytes.")},prepareReader:function(u){this.reader=s(u)},load:function(u){this.prepareReader(u),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},i.exports=d},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(t,i,a){var s=t("./reader/readerFor"),n=t("./utils"),o=t("./compressedObject"),c=t("./crc32"),l=t("./utf8"),d=t("./compressions"),u=t("./support");function f(h,g){this.options=h,this.loadOptions=g}f.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(h){var g,m;if(h.skip(22),this.fileNameLength=h.readInt(2),m=h.readInt(2),this.fileName=h.readData(this.fileNameLength),h.skip(m),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((g=(function(v){for(var p in d)if(Object.prototype.hasOwnProperty.call(d,p)&&d[p].magic===v)return d[p];return null})(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+n.pretty(this.compressionMethod)+" unknown (inner file : "+n.transformTo("string",this.fileName)+")");this.decompressed=new o(this.compressedSize,this.uncompressedSize,this.crc32,g,h.readData(this.compressedSize))},readCentralPart:function(h){this.versionMadeBy=h.readInt(2),h.skip(2),this.bitFlag=h.readInt(2),this.compressionMethod=h.readString(2),this.date=h.readDate(),this.crc32=h.readInt(4),this.compressedSize=h.readInt(4),this.uncompressedSize=h.readInt(4);var g=h.readInt(2);if(this.extraFieldsLength=h.readInt(2),this.fileCommentLength=h.readInt(2),this.diskNumberStart=h.readInt(2),this.internalFileAttributes=h.readInt(2),this.externalFileAttributes=h.readInt(4),this.localHeaderOffset=h.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");h.skip(g),this.readExtraFields(h),this.parseZIP64ExtraField(h),this.fileComment=h.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var h=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),h==0&&(this.dosPermissions=63&this.externalFileAttributes),h==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var h=s(this.extraFields[1].value);this.uncompressedSize===n.MAX_VALUE_32BITS&&(this.uncompressedSize=h.readInt(8)),this.compressedSize===n.MAX_VALUE_32BITS&&(this.compressedSize=h.readInt(8)),this.localHeaderOffset===n.MAX_VALUE_32BITS&&(this.localHeaderOffset=h.readInt(8)),this.diskNumberStart===n.MAX_VALUE_32BITS&&(this.diskNumberStart=h.readInt(4))}},readExtraFields:function(h){var g,m,v,p=h.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});h.index+4<p;)g=h.readInt(2),m=h.readInt(2),v=h.readData(m),this.extraFields[g]={id:g,length:m,value:v};h.setIndex(p)},handleUTF8:function(){var h=u.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=l.utf8decode(this.fileName),this.fileCommentStr=l.utf8decode(this.fileComment);else{var g=this.findExtraFieldUnicodePath();if(g!==null)this.fileNameStr=g;else{var m=n.transformTo(h,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(m)}var v=this.findExtraFieldUnicodeComment();if(v!==null)this.fileCommentStr=v;else{var p=n.transformTo(h,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(p)}}},findExtraFieldUnicodePath:function(){var h=this.extraFields[28789];if(h){var g=s(h.value);return g.readInt(1)!==1||c(this.fileName)!==g.readInt(4)?null:l.utf8decode(g.readData(h.length-5))}return null},findExtraFieldUnicodeComment:function(){var h=this.extraFields[25461];if(h){var g=s(h.value);return g.readInt(1)!==1||c(this.fileComment)!==g.readInt(4)?null:l.utf8decode(g.readData(h.length-5))}return null}},i.exports=f},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(t,i,a){function s(g,m,v){this.name=g,this.dir=v.dir,this.date=v.date,this.comment=v.comment,this.unixPermissions=v.unixPermissions,this.dosPermissions=v.dosPermissions,this._data=m,this._dataBinary=v.binary,this.options={compression:v.compression,compressionOptions:v.compressionOptions}}var n=t("./stream/StreamHelper"),o=t("./stream/DataWorker"),c=t("./utf8"),l=t("./compressedObject"),d=t("./stream/GenericWorker");s.prototype={internalStream:function(g){var m=null,v="string";try{if(!g)throw new Error("No output type specified.");var p=(v=g.toLowerCase())==="string"||v==="text";v!=="binarystring"&&v!=="text"||(v="string"),m=this._decompressWorker();var b=!this._dataBinary;b&&!p&&(m=m.pipe(new c.Utf8EncodeWorker)),!b&&p&&(m=m.pipe(new c.Utf8DecodeWorker))}catch(y){(m=new d("error")).error(y)}return new n(m,v,"")},async:function(g,m){return this.internalStream(g).accumulate(m)},nodeStream:function(g,m){return this.internalStream(g||"nodebuffer").toNodejsStream(m)},_compressWorker:function(g,m){if(this._data instanceof l&&this._data.compression.magic===g.magic)return this._data.getCompressedWorker();var v=this._decompressWorker();return this._dataBinary||(v=v.pipe(new c.Utf8EncodeWorker)),l.createWorkerFrom(v,g,m)},_decompressWorker:function(){return this._data instanceof l?this._data.getContentWorker():this._data instanceof d?this._data:new o(this._data)}};for(var u=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],f=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},h=0;h<u.length;h++)s.prototype[u[h]]=f;i.exports=s},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(t,i,a){(function(s){var n,o,c=s.MutationObserver||s.WebKitMutationObserver;if(c){var l=0,d=new c(g),u=s.document.createTextNode("");d.observe(u,{characterData:!0}),n=function(){u.data=l=++l%2}}else if(s.setImmediate||s.MessageChannel===void 0)n="document"in s&&"onreadystatechange"in s.document.createElement("script")?function(){var m=s.document.createElement("script");m.onreadystatechange=function(){g(),m.onreadystatechange=null,m.parentNode.removeChild(m),m=null},s.document.documentElement.appendChild(m)}:function(){setTimeout(g,0)};else{var f=new s.MessageChannel;f.port1.onmessage=g,n=function(){f.port2.postMessage(0)}}var h=[];function g(){var m,v;o=!0;for(var p=h.length;p;){for(v=h,h=[],m=-1;++m<p;)v[m]();p=h.length}o=!1}i.exports=function(m){h.push(m)!==1||o||n()}}).call(this,typeof ya<"u"?ya:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(t,i,a){var s=t("immediate");function n(){}var o={},c=["REJECTED"],l=["FULFILLED"],d=["PENDING"];function u(p){if(typeof p!="function")throw new TypeError("resolver must be a function");this.state=d,this.queue=[],this.outcome=void 0,p!==n&&m(this,p)}function f(p,b,y){this.promise=p,typeof b=="function"&&(this.onFulfilled=b,this.callFulfilled=this.otherCallFulfilled),typeof y=="function"&&(this.onRejected=y,this.callRejected=this.otherCallRejected)}function h(p,b,y){s(function(){var _;try{_=b(y)}catch(S){return o.reject(p,S)}_===p?o.reject(p,new TypeError("Cannot resolve promise with itself")):o.resolve(p,_)})}function g(p){var b=p&&p.then;if(p&&(typeof p=="object"||typeof p=="function")&&typeof b=="function")return function(){b.apply(p,arguments)}}function m(p,b){var y=!1;function _(z){y||(y=!0,o.reject(p,z))}function S(z){y||(y=!0,o.resolve(p,z))}var A=v(function(){b(S,_)});A.status==="error"&&_(A.value)}function v(p,b){var y={};try{y.value=p(b),y.status="success"}catch(_){y.status="error",y.value=_}return y}(i.exports=u).prototype.finally=function(p){if(typeof p!="function")return this;var b=this.constructor;return this.then(function(y){return b.resolve(p()).then(function(){return y})},function(y){return b.resolve(p()).then(function(){throw y})})},u.prototype.catch=function(p){return this.then(null,p)},u.prototype.then=function(p,b){if(typeof p!="function"&&this.state===l||typeof b!="function"&&this.state===c)return this;var y=new this.constructor(n);return this.state!==d?h(y,this.state===l?p:b,this.outcome):this.queue.push(new f(y,p,b)),y},f.prototype.callFulfilled=function(p){o.resolve(this.promise,p)},f.prototype.otherCallFulfilled=function(p){h(this.promise,this.onFulfilled,p)},f.prototype.callRejected=function(p){o.reject(this.promise,p)},f.prototype.otherCallRejected=function(p){h(this.promise,this.onRejected,p)},o.resolve=function(p,b){var y=v(g,b);if(y.status==="error")return o.reject(p,y.value);var _=y.value;if(_)m(p,_);else{p.state=l,p.outcome=b;for(var S=-1,A=p.queue.length;++S<A;)p.queue[S].callFulfilled(b)}return p},o.reject=function(p,b){p.state=c,p.outcome=b;for(var y=-1,_=p.queue.length;++y<_;)p.queue[y].callRejected(b);return p},u.resolve=function(p){return p instanceof this?p:o.resolve(new this(n),p)},u.reject=function(p){var b=new this(n);return o.reject(b,p)},u.all=function(p){var b=this;if(Object.prototype.toString.call(p)!=="[object Array]")return this.reject(new TypeError("must be an array"));var y=p.length,_=!1;if(!y)return this.resolve([]);for(var S=new Array(y),A=0,z=-1,D=new this(n);++z<y;)M(p[z],z);return D;function M($,K){b.resolve($).then(function(P){S[K]=P,++A!==y||_||(_=!0,o.resolve(D,S))},function(P){_||(_=!0,o.reject(D,P))})}},u.race=function(p){var b=this;if(Object.prototype.toString.call(p)!=="[object Array]")return this.reject(new TypeError("must be an array"));var y=p.length,_=!1;if(!y)return this.resolve([]);for(var S=-1,A=new this(n);++S<y;)z=p[S],b.resolve(z).then(function(D){_||(_=!0,o.resolve(A,D))},function(D){_||(_=!0,o.reject(A,D))});var z;return A}},{immediate:36}],38:[function(t,i,a){var s={};(0,t("./lib/utils/common").assign)(s,t("./lib/deflate"),t("./lib/inflate"),t("./lib/zlib/constants")),i.exports=s},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(t,i,a){var s=t("./zlib/deflate"),n=t("./utils/common"),o=t("./utils/strings"),c=t("./zlib/messages"),l=t("./zlib/zstream"),d=Object.prototype.toString,u=0,f=-1,h=0,g=8;function m(p){if(!(this instanceof m))return new m(p);this.options=n.assign({level:f,method:g,chunkSize:16384,windowBits:15,memLevel:8,strategy:h,to:""},p||{});var b=this.options;b.raw&&0<b.windowBits?b.windowBits=-b.windowBits:b.gzip&&0<b.windowBits&&b.windowBits<16&&(b.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new l,this.strm.avail_out=0;var y=s.deflateInit2(this.strm,b.level,b.method,b.windowBits,b.memLevel,b.strategy);if(y!==u)throw new Error(c[y]);if(b.header&&s.deflateSetHeader(this.strm,b.header),b.dictionary){var _;if(_=typeof b.dictionary=="string"?o.string2buf(b.dictionary):d.call(b.dictionary)==="[object ArrayBuffer]"?new Uint8Array(b.dictionary):b.dictionary,(y=s.deflateSetDictionary(this.strm,_))!==u)throw new Error(c[y]);this._dict_set=!0}}function v(p,b){var y=new m(b);if(y.push(p,!0),y.err)throw y.msg||c[y.err];return y.result}m.prototype.push=function(p,b){var y,_,S=this.strm,A=this.options.chunkSize;if(this.ended)return!1;_=b===~~b?b:b===!0?4:0,typeof p=="string"?S.input=o.string2buf(p):d.call(p)==="[object ArrayBuffer]"?S.input=new Uint8Array(p):S.input=p,S.next_in=0,S.avail_in=S.input.length;do{if(S.avail_out===0&&(S.output=new n.Buf8(A),S.next_out=0,S.avail_out=A),(y=s.deflate(S,_))!==1&&y!==u)return this.onEnd(y),!(this.ended=!0);S.avail_out!==0&&(S.avail_in!==0||_!==4&&_!==2)||(this.options.to==="string"?this.onData(o.buf2binstring(n.shrinkBuf(S.output,S.next_out))):this.onData(n.shrinkBuf(S.output,S.next_out)))}while((0<S.avail_in||S.avail_out===0)&&y!==1);return _===4?(y=s.deflateEnd(this.strm),this.onEnd(y),this.ended=!0,y===u):_!==2||(this.onEnd(u),!(S.avail_out=0))},m.prototype.onData=function(p){this.chunks.push(p)},m.prototype.onEnd=function(p){p===u&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=n.flattenChunks(this.chunks)),this.chunks=[],this.err=p,this.msg=this.strm.msg},a.Deflate=m,a.deflate=v,a.deflateRaw=function(p,b){return(b=b||{}).raw=!0,v(p,b)},a.gzip=function(p,b){return(b=b||{}).gzip=!0,v(p,b)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(t,i,a){var s=t("./zlib/inflate"),n=t("./utils/common"),o=t("./utils/strings"),c=t("./zlib/constants"),l=t("./zlib/messages"),d=t("./zlib/zstream"),u=t("./zlib/gzheader"),f=Object.prototype.toString;function h(m){if(!(this instanceof h))return new h(m);this.options=n.assign({chunkSize:16384,windowBits:0,to:""},m||{});var v=this.options;v.raw&&0<=v.windowBits&&v.windowBits<16&&(v.windowBits=-v.windowBits,v.windowBits===0&&(v.windowBits=-15)),!(0<=v.windowBits&&v.windowBits<16)||m&&m.windowBits||(v.windowBits+=32),15<v.windowBits&&v.windowBits<48&&(15&v.windowBits)==0&&(v.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new d,this.strm.avail_out=0;var p=s.inflateInit2(this.strm,v.windowBits);if(p!==c.Z_OK)throw new Error(l[p]);this.header=new u,s.inflateGetHeader(this.strm,this.header)}function g(m,v){var p=new h(v);if(p.push(m,!0),p.err)throw p.msg||l[p.err];return p.result}h.prototype.push=function(m,v){var p,b,y,_,S,A,z=this.strm,D=this.options.chunkSize,M=this.options.dictionary,$=!1;if(this.ended)return!1;b=v===~~v?v:v===!0?c.Z_FINISH:c.Z_NO_FLUSH,typeof m=="string"?z.input=o.binstring2buf(m):f.call(m)==="[object ArrayBuffer]"?z.input=new Uint8Array(m):z.input=m,z.next_in=0,z.avail_in=z.input.length;do{if(z.avail_out===0&&(z.output=new n.Buf8(D),z.next_out=0,z.avail_out=D),(p=s.inflate(z,c.Z_NO_FLUSH))===c.Z_NEED_DICT&&M&&(A=typeof M=="string"?o.string2buf(M):f.call(M)==="[object ArrayBuffer]"?new Uint8Array(M):M,p=s.inflateSetDictionary(this.strm,A)),p===c.Z_BUF_ERROR&&$===!0&&(p=c.Z_OK,$=!1),p!==c.Z_STREAM_END&&p!==c.Z_OK)return this.onEnd(p),!(this.ended=!0);z.next_out&&(z.avail_out!==0&&p!==c.Z_STREAM_END&&(z.avail_in!==0||b!==c.Z_FINISH&&b!==c.Z_SYNC_FLUSH)||(this.options.to==="string"?(y=o.utf8border(z.output,z.next_out),_=z.next_out-y,S=o.buf2string(z.output,y),z.next_out=_,z.avail_out=D-_,_&&n.arraySet(z.output,z.output,y,_,0),this.onData(S)):this.onData(n.shrinkBuf(z.output,z.next_out)))),z.avail_in===0&&z.avail_out===0&&($=!0)}while((0<z.avail_in||z.avail_out===0)&&p!==c.Z_STREAM_END);return p===c.Z_STREAM_END&&(b=c.Z_FINISH),b===c.Z_FINISH?(p=s.inflateEnd(this.strm),this.onEnd(p),this.ended=!0,p===c.Z_OK):b!==c.Z_SYNC_FLUSH||(this.onEnd(c.Z_OK),!(z.avail_out=0))},h.prototype.onData=function(m){this.chunks.push(m)},h.prototype.onEnd=function(m){m===c.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=n.flattenChunks(this.chunks)),this.chunks=[],this.err=m,this.msg=this.strm.msg},a.Inflate=h,a.inflate=g,a.inflateRaw=function(m,v){return(v=v||{}).raw=!0,g(m,v)},a.ungzip=g},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(t,i,a){var s=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";a.assign=function(c){for(var l=Array.prototype.slice.call(arguments,1);l.length;){var d=l.shift();if(d){if(typeof d!="object")throw new TypeError(d+"must be non-object");for(var u in d)d.hasOwnProperty(u)&&(c[u]=d[u])}}return c},a.shrinkBuf=function(c,l){return c.length===l?c:c.subarray?c.subarray(0,l):(c.length=l,c)};var n={arraySet:function(c,l,d,u,f){if(l.subarray&&c.subarray)c.set(l.subarray(d,d+u),f);else for(var h=0;h<u;h++)c[f+h]=l[d+h]},flattenChunks:function(c){var l,d,u,f,h,g;for(l=u=0,d=c.length;l<d;l++)u+=c[l].length;for(g=new Uint8Array(u),l=f=0,d=c.length;l<d;l++)h=c[l],g.set(h,f),f+=h.length;return g}},o={arraySet:function(c,l,d,u,f){for(var h=0;h<u;h++)c[f+h]=l[d+h]},flattenChunks:function(c){return[].concat.apply([],c)}};a.setTyped=function(c){c?(a.Buf8=Uint8Array,a.Buf16=Uint16Array,a.Buf32=Int32Array,a.assign(a,n)):(a.Buf8=Array,a.Buf16=Array,a.Buf32=Array,a.assign(a,o))},a.setTyped(s)},{}],42:[function(t,i,a){var s=t("./common"),n=!0,o=!0;try{String.fromCharCode.apply(null,[0])}catch{n=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{o=!1}for(var c=new s.Buf8(256),l=0;l<256;l++)c[l]=252<=l?6:248<=l?5:240<=l?4:224<=l?3:192<=l?2:1;function d(u,f){if(f<65537&&(u.subarray&&o||!u.subarray&&n))return String.fromCharCode.apply(null,s.shrinkBuf(u,f));for(var h="",g=0;g<f;g++)h+=String.fromCharCode(u[g]);return h}c[254]=c[254]=1,a.string2buf=function(u){var f,h,g,m,v,p=u.length,b=0;for(m=0;m<p;m++)(64512&(h=u.charCodeAt(m)))==55296&&m+1<p&&(64512&(g=u.charCodeAt(m+1)))==56320&&(h=65536+(h-55296<<10)+(g-56320),m++),b+=h<128?1:h<2048?2:h<65536?3:4;for(f=new s.Buf8(b),m=v=0;v<b;m++)(64512&(h=u.charCodeAt(m)))==55296&&m+1<p&&(64512&(g=u.charCodeAt(m+1)))==56320&&(h=65536+(h-55296<<10)+(g-56320),m++),h<128?f[v++]=h:(h<2048?f[v++]=192|h>>>6:(h<65536?f[v++]=224|h>>>12:(f[v++]=240|h>>>18,f[v++]=128|h>>>12&63),f[v++]=128|h>>>6&63),f[v++]=128|63&h);return f},a.buf2binstring=function(u){return d(u,u.length)},a.binstring2buf=function(u){for(var f=new s.Buf8(u.length),h=0,g=f.length;h<g;h++)f[h]=u.charCodeAt(h);return f},a.buf2string=function(u,f){var h,g,m,v,p=f||u.length,b=new Array(2*p);for(h=g=0;h<p;)if((m=u[h++])<128)b[g++]=m;else if(4<(v=c[m]))b[g++]=65533,h+=v-1;else{for(m&=v===2?31:v===3?15:7;1<v&&h<p;)m=m<<6|63&u[h++],v--;1<v?b[g++]=65533:m<65536?b[g++]=m:(m-=65536,b[g++]=55296|m>>10&1023,b[g++]=56320|1023&m)}return d(b,g)},a.utf8border=function(u,f){var h;for((f=f||u.length)>u.length&&(f=u.length),h=f-1;0<=h&&(192&u[h])==128;)h--;return h<0||h===0?f:h+c[u[h]]>f?h:f}},{"./common":41}],43:[function(t,i,a){i.exports=function(s,n,o,c){for(var l=65535&s|0,d=s>>>16&65535|0,u=0;o!==0;){for(o-=u=2e3<o?2e3:o;d=d+(l=l+n[c++]|0)|0,--u;);l%=65521,d%=65521}return l|d<<16|0}},{}],44:[function(t,i,a){i.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(t,i,a){var s=(function(){for(var n,o=[],c=0;c<256;c++){n=c;for(var l=0;l<8;l++)n=1&n?3988292384^n>>>1:n>>>1;o[c]=n}return o})();i.exports=function(n,o,c,l){var d=s,u=l+c;n^=-1;for(var f=l;f<u;f++)n=n>>>8^d[255&(n^o[f])];return-1^n}},{}],46:[function(t,i,a){var s,n=t("../utils/common"),o=t("./trees"),c=t("./adler32"),l=t("./crc32"),d=t("./messages"),u=0,f=4,h=0,g=-2,m=-1,v=4,p=2,b=8,y=9,_=286,S=30,A=19,z=2*_+1,D=15,M=3,$=258,K=$+M+1,P=42,O=113,k=1,Q=2,se=3,Y=4;function be(w,J){return w.msg=d[J],J}function ee(w){return(w<<1)-(4<w?9:0)}function me(w){for(var J=w.length;0<=--J;)w[J]=0}function q(w){var J=w.state,X=J.pending;X>w.avail_out&&(X=w.avail_out),X!==0&&(n.arraySet(w.output,J.pending_buf,J.pending_out,X,w.next_out),w.next_out+=X,J.pending_out+=X,w.total_out+=X,w.avail_out-=X,J.pending-=X,J.pending===0&&(J.pending_out=0))}function V(w,J){o._tr_flush_block(w,0<=w.block_start?w.block_start:-1,w.strstart-w.block_start,J),w.block_start=w.strstart,q(w.strm)}function ue(w,J){w.pending_buf[w.pending++]=J}function oe(w,J){w.pending_buf[w.pending++]=J>>>8&255,w.pending_buf[w.pending++]=255&J}function j(w,J){var X,F,T=w.max_chain_length,B=w.strstart,L=w.prev_length,H=w.nice_match,U=w.strstart>w.w_size-K?w.strstart-(w.w_size-K):0,Z=w.window,ie=w.w_mask,G=w.prev,ae=w.strstart+$,ye=Z[B+L-1],ke=Z[B+L];w.prev_length>=w.good_match&&(T>>=2),H>w.lookahead&&(H=w.lookahead);do if(Z[(X=J)+L]===ke&&Z[X+L-1]===ye&&Z[X]===Z[B]&&Z[++X]===Z[B+1]){B+=2,X++;do;while(Z[++B]===Z[++X]&&Z[++B]===Z[++X]&&Z[++B]===Z[++X]&&Z[++B]===Z[++X]&&Z[++B]===Z[++X]&&Z[++B]===Z[++X]&&Z[++B]===Z[++X]&&Z[++B]===Z[++X]&&B<ae);if(F=$-(ae-B),B=ae-$,L<F){if(w.match_start=J,H<=(L=F))break;ye=Z[B+L-1],ke=Z[B+L]}}while((J=G[J&ie])>U&&--T!=0);return L<=w.lookahead?L:w.lookahead}function te(w){var J,X,F,T,B,L,H,U,Z,ie,G=w.w_size;do{if(T=w.window_size-w.lookahead-w.strstart,w.strstart>=G+(G-K)){for(n.arraySet(w.window,w.window,G,G,0),w.match_start-=G,w.strstart-=G,w.block_start-=G,J=X=w.hash_size;F=w.head[--J],w.head[J]=G<=F?F-G:0,--X;);for(J=X=G;F=w.prev[--J],w.prev[J]=G<=F?F-G:0,--X;);T+=G}if(w.strm.avail_in===0)break;if(L=w.strm,H=w.window,U=w.strstart+w.lookahead,Z=T,ie=void 0,ie=L.avail_in,Z<ie&&(ie=Z),X=ie===0?0:(L.avail_in-=ie,n.arraySet(H,L.input,L.next_in,ie,U),L.state.wrap===1?L.adler=c(L.adler,H,ie,U):L.state.wrap===2&&(L.adler=l(L.adler,H,ie,U)),L.next_in+=ie,L.total_in+=ie,ie),w.lookahead+=X,w.lookahead+w.insert>=M)for(B=w.strstart-w.insert,w.ins_h=w.window[B],w.ins_h=(w.ins_h<<w.hash_shift^w.window[B+1])&w.hash_mask;w.insert&&(w.ins_h=(w.ins_h<<w.hash_shift^w.window[B+M-1])&w.hash_mask,w.prev[B&w.w_mask]=w.head[w.ins_h],w.head[w.ins_h]=B,B++,w.insert--,!(w.lookahead+w.insert<M)););}while(w.lookahead<K&&w.strm.avail_in!==0)}function le(w,J){for(var X,F;;){if(w.lookahead<K){if(te(w),w.lookahead<K&&J===u)return k;if(w.lookahead===0)break}if(X=0,w.lookahead>=M&&(w.ins_h=(w.ins_h<<w.hash_shift^w.window[w.strstart+M-1])&w.hash_mask,X=w.prev[w.strstart&w.w_mask]=w.head[w.ins_h],w.head[w.ins_h]=w.strstart),X!==0&&w.strstart-X<=w.w_size-K&&(w.match_length=j(w,X)),w.match_length>=M)if(F=o._tr_tally(w,w.strstart-w.match_start,w.match_length-M),w.lookahead-=w.match_length,w.match_length<=w.max_lazy_match&&w.lookahead>=M){for(w.match_length--;w.strstart++,w.ins_h=(w.ins_h<<w.hash_shift^w.window[w.strstart+M-1])&w.hash_mask,X=w.prev[w.strstart&w.w_mask]=w.head[w.ins_h],w.head[w.ins_h]=w.strstart,--w.match_length!=0;);w.strstart++}else w.strstart+=w.match_length,w.match_length=0,w.ins_h=w.window[w.strstart],w.ins_h=(w.ins_h<<w.hash_shift^w.window[w.strstart+1])&w.hash_mask;else F=o._tr_tally(w,0,w.window[w.strstart]),w.lookahead--,w.strstart++;if(F&&(V(w,!1),w.strm.avail_out===0))return k}return w.insert=w.strstart<M-1?w.strstart:M-1,J===f?(V(w,!0),w.strm.avail_out===0?se:Y):w.last_lit&&(V(w,!1),w.strm.avail_out===0)?k:Q}function he(w,J){for(var X,F,T;;){if(w.lookahead<K){if(te(w),w.lookahead<K&&J===u)return k;if(w.lookahead===0)break}if(X=0,w.lookahead>=M&&(w.ins_h=(w.ins_h<<w.hash_shift^w.window[w.strstart+M-1])&w.hash_mask,X=w.prev[w.strstart&w.w_mask]=w.head[w.ins_h],w.head[w.ins_h]=w.strstart),w.prev_length=w.match_length,w.prev_match=w.match_start,w.match_length=M-1,X!==0&&w.prev_length<w.max_lazy_match&&w.strstart-X<=w.w_size-K&&(w.match_length=j(w,X),w.match_length<=5&&(w.strategy===1||w.match_length===M&&4096<w.strstart-w.match_start)&&(w.match_length=M-1)),w.prev_length>=M&&w.match_length<=w.prev_length){for(T=w.strstart+w.lookahead-M,F=o._tr_tally(w,w.strstart-1-w.prev_match,w.prev_length-M),w.lookahead-=w.prev_length-1,w.prev_length-=2;++w.strstart<=T&&(w.ins_h=(w.ins_h<<w.hash_shift^w.window[w.strstart+M-1])&w.hash_mask,X=w.prev[w.strstart&w.w_mask]=w.head[w.ins_h],w.head[w.ins_h]=w.strstart),--w.prev_length!=0;);if(w.match_available=0,w.match_length=M-1,w.strstart++,F&&(V(w,!1),w.strm.avail_out===0))return k}else if(w.match_available){if((F=o._tr_tally(w,0,w.window[w.strstart-1]))&&V(w,!1),w.strstart++,w.lookahead--,w.strm.avail_out===0)return k}else w.match_available=1,w.strstart++,w.lookahead--}return w.match_available&&(F=o._tr_tally(w,0,w.window[w.strstart-1]),w.match_available=0),w.insert=w.strstart<M-1?w.strstart:M-1,J===f?(V(w,!0),w.strm.avail_out===0?se:Y):w.last_lit&&(V(w,!1),w.strm.avail_out===0)?k:Q}function we(w,J,X,F,T){this.good_length=w,this.max_lazy=J,this.nice_length=X,this.max_chain=F,this.func=T}function Ee(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=b,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new n.Buf16(2*z),this.dyn_dtree=new n.Buf16(2*(2*S+1)),this.bl_tree=new n.Buf16(2*(2*A+1)),me(this.dyn_ltree),me(this.dyn_dtree),me(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new n.Buf16(D+1),this.heap=new n.Buf16(2*_+1),me(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new n.Buf16(2*_+1),me(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function Se(w){var J;return w&&w.state?(w.total_in=w.total_out=0,w.data_type=p,(J=w.state).pending=0,J.pending_out=0,J.wrap<0&&(J.wrap=-J.wrap),J.status=J.wrap?P:O,w.adler=J.wrap===2?0:1,J.last_flush=u,o._tr_init(J),h):be(w,g)}function Xe(w){var J=Se(w);return J===h&&(function(X){X.window_size=2*X.w_size,me(X.head),X.max_lazy_match=s[X.level].max_lazy,X.good_match=s[X.level].good_length,X.nice_match=s[X.level].nice_length,X.max_chain_length=s[X.level].max_chain,X.strstart=0,X.block_start=0,X.lookahead=0,X.insert=0,X.match_length=X.prev_length=M-1,X.match_available=0,X.ins_h=0})(w.state),J}function at(w,J,X,F,T,B){if(!w)return g;var L=1;if(J===m&&(J=6),F<0?(L=0,F=-F):15<F&&(L=2,F-=16),T<1||y<T||X!==b||F<8||15<F||J<0||9<J||B<0||v<B)return be(w,g);F===8&&(F=9);var H=new Ee;return(w.state=H).strm=w,H.wrap=L,H.gzhead=null,H.w_bits=F,H.w_size=1<<H.w_bits,H.w_mask=H.w_size-1,H.hash_bits=T+7,H.hash_size=1<<H.hash_bits,H.hash_mask=H.hash_size-1,H.hash_shift=~~((H.hash_bits+M-1)/M),H.window=new n.Buf8(2*H.w_size),H.head=new n.Buf16(H.hash_size),H.prev=new n.Buf16(H.w_size),H.lit_bufsize=1<<T+6,H.pending_buf_size=4*H.lit_bufsize,H.pending_buf=new n.Buf8(H.pending_buf_size),H.d_buf=1*H.lit_bufsize,H.l_buf=3*H.lit_bufsize,H.level=J,H.strategy=B,H.method=X,Xe(w)}s=[new we(0,0,0,0,function(w,J){var X=65535;for(X>w.pending_buf_size-5&&(X=w.pending_buf_size-5);;){if(w.lookahead<=1){if(te(w),w.lookahead===0&&J===u)return k;if(w.lookahead===0)break}w.strstart+=w.lookahead,w.lookahead=0;var F=w.block_start+X;if((w.strstart===0||w.strstart>=F)&&(w.lookahead=w.strstart-F,w.strstart=F,V(w,!1),w.strm.avail_out===0)||w.strstart-w.block_start>=w.w_size-K&&(V(w,!1),w.strm.avail_out===0))return k}return w.insert=0,J===f?(V(w,!0),w.strm.avail_out===0?se:Y):(w.strstart>w.block_start&&(V(w,!1),w.strm.avail_out),k)}),new we(4,4,8,4,le),new we(4,5,16,8,le),new we(4,6,32,32,le),new we(4,4,16,16,he),new we(8,16,32,32,he),new we(8,16,128,128,he),new we(8,32,128,256,he),new we(32,128,258,1024,he),new we(32,258,258,4096,he)],a.deflateInit=function(w,J){return at(w,J,b,15,8,0)},a.deflateInit2=at,a.deflateReset=Xe,a.deflateResetKeep=Se,a.deflateSetHeader=function(w,J){return w&&w.state?w.state.wrap!==2?g:(w.state.gzhead=J,h):g},a.deflate=function(w,J){var X,F,T,B;if(!w||!w.state||5<J||J<0)return w?be(w,g):g;if(F=w.state,!w.output||!w.input&&w.avail_in!==0||F.status===666&&J!==f)return be(w,w.avail_out===0?-5:g);if(F.strm=w,X=F.last_flush,F.last_flush=J,F.status===P)if(F.wrap===2)w.adler=0,ue(F,31),ue(F,139),ue(F,8),F.gzhead?(ue(F,(F.gzhead.text?1:0)+(F.gzhead.hcrc?2:0)+(F.gzhead.extra?4:0)+(F.gzhead.name?8:0)+(F.gzhead.comment?16:0)),ue(F,255&F.gzhead.time),ue(F,F.gzhead.time>>8&255),ue(F,F.gzhead.time>>16&255),ue(F,F.gzhead.time>>24&255),ue(F,F.level===9?2:2<=F.strategy||F.level<2?4:0),ue(F,255&F.gzhead.os),F.gzhead.extra&&F.gzhead.extra.length&&(ue(F,255&F.gzhead.extra.length),ue(F,F.gzhead.extra.length>>8&255)),F.gzhead.hcrc&&(w.adler=l(w.adler,F.pending_buf,F.pending,0)),F.gzindex=0,F.status=69):(ue(F,0),ue(F,0),ue(F,0),ue(F,0),ue(F,0),ue(F,F.level===9?2:2<=F.strategy||F.level<2?4:0),ue(F,3),F.status=O);else{var L=b+(F.w_bits-8<<4)<<8;L|=(2<=F.strategy||F.level<2?0:F.level<6?1:F.level===6?2:3)<<6,F.strstart!==0&&(L|=32),L+=31-L%31,F.status=O,oe(F,L),F.strstart!==0&&(oe(F,w.adler>>>16),oe(F,65535&w.adler)),w.adler=1}if(F.status===69)if(F.gzhead.extra){for(T=F.pending;F.gzindex<(65535&F.gzhead.extra.length)&&(F.pending!==F.pending_buf_size||(F.gzhead.hcrc&&F.pending>T&&(w.adler=l(w.adler,F.pending_buf,F.pending-T,T)),q(w),T=F.pending,F.pending!==F.pending_buf_size));)ue(F,255&F.gzhead.extra[F.gzindex]),F.gzindex++;F.gzhead.hcrc&&F.pending>T&&(w.adler=l(w.adler,F.pending_buf,F.pending-T,T)),F.gzindex===F.gzhead.extra.length&&(F.gzindex=0,F.status=73)}else F.status=73;if(F.status===73)if(F.gzhead.name){T=F.pending;do{if(F.pending===F.pending_buf_size&&(F.gzhead.hcrc&&F.pending>T&&(w.adler=l(w.adler,F.pending_buf,F.pending-T,T)),q(w),T=F.pending,F.pending===F.pending_buf_size)){B=1;break}B=F.gzindex<F.gzhead.name.length?255&F.gzhead.name.charCodeAt(F.gzindex++):0,ue(F,B)}while(B!==0);F.gzhead.hcrc&&F.pending>T&&(w.adler=l(w.adler,F.pending_buf,F.pending-T,T)),B===0&&(F.gzindex=0,F.status=91)}else F.status=91;if(F.status===91)if(F.gzhead.comment){T=F.pending;do{if(F.pending===F.pending_buf_size&&(F.gzhead.hcrc&&F.pending>T&&(w.adler=l(w.adler,F.pending_buf,F.pending-T,T)),q(w),T=F.pending,F.pending===F.pending_buf_size)){B=1;break}B=F.gzindex<F.gzhead.comment.length?255&F.gzhead.comment.charCodeAt(F.gzindex++):0,ue(F,B)}while(B!==0);F.gzhead.hcrc&&F.pending>T&&(w.adler=l(w.adler,F.pending_buf,F.pending-T,T)),B===0&&(F.status=103)}else F.status=103;if(F.status===103&&(F.gzhead.hcrc?(F.pending+2>F.pending_buf_size&&q(w),F.pending+2<=F.pending_buf_size&&(ue(F,255&w.adler),ue(F,w.adler>>8&255),w.adler=0,F.status=O)):F.status=O),F.pending!==0){if(q(w),w.avail_out===0)return F.last_flush=-1,h}else if(w.avail_in===0&&ee(J)<=ee(X)&&J!==f)return be(w,-5);if(F.status===666&&w.avail_in!==0)return be(w,-5);if(w.avail_in!==0||F.lookahead!==0||J!==u&&F.status!==666){var H=F.strategy===2?(function(U,Z){for(var ie;;){if(U.lookahead===0&&(te(U),U.lookahead===0)){if(Z===u)return k;break}if(U.match_length=0,ie=o._tr_tally(U,0,U.window[U.strstart]),U.lookahead--,U.strstart++,ie&&(V(U,!1),U.strm.avail_out===0))return k}return U.insert=0,Z===f?(V(U,!0),U.strm.avail_out===0?se:Y):U.last_lit&&(V(U,!1),U.strm.avail_out===0)?k:Q})(F,J):F.strategy===3?(function(U,Z){for(var ie,G,ae,ye,ke=U.window;;){if(U.lookahead<=$){if(te(U),U.lookahead<=$&&Z===u)return k;if(U.lookahead===0)break}if(U.match_length=0,U.lookahead>=M&&0<U.strstart&&(G=ke[ae=U.strstart-1])===ke[++ae]&&G===ke[++ae]&&G===ke[++ae]){ye=U.strstart+$;do;while(G===ke[++ae]&&G===ke[++ae]&&G===ke[++ae]&&G===ke[++ae]&&G===ke[++ae]&&G===ke[++ae]&&G===ke[++ae]&&G===ke[++ae]&&ae<ye);U.match_length=$-(ye-ae),U.match_length>U.lookahead&&(U.match_length=U.lookahead)}if(U.match_length>=M?(ie=o._tr_tally(U,1,U.match_length-M),U.lookahead-=U.match_length,U.strstart+=U.match_length,U.match_length=0):(ie=o._tr_tally(U,0,U.window[U.strstart]),U.lookahead--,U.strstart++),ie&&(V(U,!1),U.strm.avail_out===0))return k}return U.insert=0,Z===f?(V(U,!0),U.strm.avail_out===0?se:Y):U.last_lit&&(V(U,!1),U.strm.avail_out===0)?k:Q})(F,J):s[F.level].func(F,J);if(H!==se&&H!==Y||(F.status=666),H===k||H===se)return w.avail_out===0&&(F.last_flush=-1),h;if(H===Q&&(J===1?o._tr_align(F):J!==5&&(o._tr_stored_block(F,0,0,!1),J===3&&(me(F.head),F.lookahead===0&&(F.strstart=0,F.block_start=0,F.insert=0))),q(w),w.avail_out===0))return F.last_flush=-1,h}return J!==f?h:F.wrap<=0?1:(F.wrap===2?(ue(F,255&w.adler),ue(F,w.adler>>8&255),ue(F,w.adler>>16&255),ue(F,w.adler>>24&255),ue(F,255&w.total_in),ue(F,w.total_in>>8&255),ue(F,w.total_in>>16&255),ue(F,w.total_in>>24&255)):(oe(F,w.adler>>>16),oe(F,65535&w.adler)),q(w),0<F.wrap&&(F.wrap=-F.wrap),F.pending!==0?h:1)},a.deflateEnd=function(w){var J;return w&&w.state?(J=w.state.status)!==P&&J!==69&&J!==73&&J!==91&&J!==103&&J!==O&&J!==666?be(w,g):(w.state=null,J===O?be(w,-3):h):g},a.deflateSetDictionary=function(w,J){var X,F,T,B,L,H,U,Z,ie=J.length;if(!w||!w.state||(B=(X=w.state).wrap)===2||B===1&&X.status!==P||X.lookahead)return g;for(B===1&&(w.adler=c(w.adler,J,ie,0)),X.wrap=0,ie>=X.w_size&&(B===0&&(me(X.head),X.strstart=0,X.block_start=0,X.insert=0),Z=new n.Buf8(X.w_size),n.arraySet(Z,J,ie-X.w_size,X.w_size,0),J=Z,ie=X.w_size),L=w.avail_in,H=w.next_in,U=w.input,w.avail_in=ie,w.next_in=0,w.input=J,te(X);X.lookahead>=M;){for(F=X.strstart,T=X.lookahead-(M-1);X.ins_h=(X.ins_h<<X.hash_shift^X.window[F+M-1])&X.hash_mask,X.prev[F&X.w_mask]=X.head[X.ins_h],X.head[X.ins_h]=F,F++,--T;);X.strstart=F,X.lookahead=M-1,te(X)}return X.strstart+=X.lookahead,X.block_start=X.strstart,X.insert=X.lookahead,X.lookahead=0,X.match_length=X.prev_length=M-1,X.match_available=0,w.next_in=H,w.input=U,w.avail_in=L,X.wrap=B,h},a.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(t,i,a){i.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(t,i,a){i.exports=function(s,n){var o,c,l,d,u,f,h,g,m,v,p,b,y,_,S,A,z,D,M,$,K,P,O,k,Q;o=s.state,c=s.next_in,k=s.input,l=c+(s.avail_in-5),d=s.next_out,Q=s.output,u=d-(n-s.avail_out),f=d+(s.avail_out-257),h=o.dmax,g=o.wsize,m=o.whave,v=o.wnext,p=o.window,b=o.hold,y=o.bits,_=o.lencode,S=o.distcode,A=(1<<o.lenbits)-1,z=(1<<o.distbits)-1;e:do{y<15&&(b+=k[c++]<<y,y+=8,b+=k[c++]<<y,y+=8),D=_[b&A];t:for(;;){if(b>>>=M=D>>>24,y-=M,(M=D>>>16&255)===0)Q[d++]=65535&D;else{if(!(16&M)){if((64&M)==0){D=_[(65535&D)+(b&(1<<M)-1)];continue t}if(32&M){o.mode=12;break e}s.msg="invalid literal/length code",o.mode=30;break e}$=65535&D,(M&=15)&&(y<M&&(b+=k[c++]<<y,y+=8),$+=b&(1<<M)-1,b>>>=M,y-=M),y<15&&(b+=k[c++]<<y,y+=8,b+=k[c++]<<y,y+=8),D=S[b&z];r:for(;;){if(b>>>=M=D>>>24,y-=M,!(16&(M=D>>>16&255))){if((64&M)==0){D=S[(65535&D)+(b&(1<<M)-1)];continue r}s.msg="invalid distance code",o.mode=30;break e}if(K=65535&D,y<(M&=15)&&(b+=k[c++]<<y,(y+=8)<M&&(b+=k[c++]<<y,y+=8)),h<(K+=b&(1<<M)-1)){s.msg="invalid distance too far back",o.mode=30;break e}if(b>>>=M,y-=M,(M=d-u)<K){if(m<(M=K-M)&&o.sane){s.msg="invalid distance too far back",o.mode=30;break e}if(O=p,(P=0)===v){if(P+=g-M,M<$){for($-=M;Q[d++]=p[P++],--M;);P=d-K,O=Q}}else if(v<M){if(P+=g+v-M,(M-=v)<$){for($-=M;Q[d++]=p[P++],--M;);if(P=0,v<$){for($-=M=v;Q[d++]=p[P++],--M;);P=d-K,O=Q}}}else if(P+=v-M,M<$){for($-=M;Q[d++]=p[P++],--M;);P=d-K,O=Q}for(;2<$;)Q[d++]=O[P++],Q[d++]=O[P++],Q[d++]=O[P++],$-=3;$&&(Q[d++]=O[P++],1<$&&(Q[d++]=O[P++]))}else{for(P=d-K;Q[d++]=Q[P++],Q[d++]=Q[P++],Q[d++]=Q[P++],2<($-=3););$&&(Q[d++]=Q[P++],1<$&&(Q[d++]=Q[P++]))}break}}break}}while(c<l&&d<f);c-=$=y>>3,b&=(1<<(y-=$<<3))-1,s.next_in=c,s.next_out=d,s.avail_in=c<l?l-c+5:5-(c-l),s.avail_out=d<f?f-d+257:257-(d-f),o.hold=b,o.bits=y}},{}],49:[function(t,i,a){var s=t("../utils/common"),n=t("./adler32"),o=t("./crc32"),c=t("./inffast"),l=t("./inftrees"),d=1,u=2,f=0,h=-2,g=1,m=852,v=592;function p(P){return(P>>>24&255)+(P>>>8&65280)+((65280&P)<<8)+((255&P)<<24)}function b(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new s.Buf16(320),this.work=new s.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function y(P){var O;return P&&P.state?(O=P.state,P.total_in=P.total_out=O.total=0,P.msg="",O.wrap&&(P.adler=1&O.wrap),O.mode=g,O.last=0,O.havedict=0,O.dmax=32768,O.head=null,O.hold=0,O.bits=0,O.lencode=O.lendyn=new s.Buf32(m),O.distcode=O.distdyn=new s.Buf32(v),O.sane=1,O.back=-1,f):h}function _(P){var O;return P&&P.state?((O=P.state).wsize=0,O.whave=0,O.wnext=0,y(P)):h}function S(P,O){var k,Q;return P&&P.state?(Q=P.state,O<0?(k=0,O=-O):(k=1+(O>>4),O<48&&(O&=15)),O&&(O<8||15<O)?h:(Q.window!==null&&Q.wbits!==O&&(Q.window=null),Q.wrap=k,Q.wbits=O,_(P))):h}function A(P,O){var k,Q;return P?(Q=new b,(P.state=Q).window=null,(k=S(P,O))!==f&&(P.state=null),k):h}var z,D,M=!0;function $(P){if(M){var O;for(z=new s.Buf32(512),D=new s.Buf32(32),O=0;O<144;)P.lens[O++]=8;for(;O<256;)P.lens[O++]=9;for(;O<280;)P.lens[O++]=7;for(;O<288;)P.lens[O++]=8;for(l(d,P.lens,0,288,z,0,P.work,{bits:9}),O=0;O<32;)P.lens[O++]=5;l(u,P.lens,0,32,D,0,P.work,{bits:5}),M=!1}P.lencode=z,P.lenbits=9,P.distcode=D,P.distbits=5}function K(P,O,k,Q){var se,Y=P.state;return Y.window===null&&(Y.wsize=1<<Y.wbits,Y.wnext=0,Y.whave=0,Y.window=new s.Buf8(Y.wsize)),Q>=Y.wsize?(s.arraySet(Y.window,O,k-Y.wsize,Y.wsize,0),Y.wnext=0,Y.whave=Y.wsize):(Q<(se=Y.wsize-Y.wnext)&&(se=Q),s.arraySet(Y.window,O,k-Q,se,Y.wnext),(Q-=se)?(s.arraySet(Y.window,O,k-Q,Q,0),Y.wnext=Q,Y.whave=Y.wsize):(Y.wnext+=se,Y.wnext===Y.wsize&&(Y.wnext=0),Y.whave<Y.wsize&&(Y.whave+=se))),0}a.inflateReset=_,a.inflateReset2=S,a.inflateResetKeep=y,a.inflateInit=function(P){return A(P,15)},a.inflateInit2=A,a.inflate=function(P,O){var k,Q,se,Y,be,ee,me,q,V,ue,oe,j,te,le,he,we,Ee,Se,Xe,at,w,J,X,F,T=0,B=new s.Buf8(4),L=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!P||!P.state||!P.output||!P.input&&P.avail_in!==0)return h;(k=P.state).mode===12&&(k.mode=13),be=P.next_out,se=P.output,me=P.avail_out,Y=P.next_in,Q=P.input,ee=P.avail_in,q=k.hold,V=k.bits,ue=ee,oe=me,J=f;e:for(;;)switch(k.mode){case g:if(k.wrap===0){k.mode=13;break}for(;V<16;){if(ee===0)break e;ee--,q+=Q[Y++]<<V,V+=8}if(2&k.wrap&&q===35615){B[k.check=0]=255&q,B[1]=q>>>8&255,k.check=o(k.check,B,2,0),V=q=0,k.mode=2;break}if(k.flags=0,k.head&&(k.head.done=!1),!(1&k.wrap)||(((255&q)<<8)+(q>>8))%31){P.msg="incorrect header check",k.mode=30;break}if((15&q)!=8){P.msg="unknown compression method",k.mode=30;break}if(V-=4,w=8+(15&(q>>>=4)),k.wbits===0)k.wbits=w;else if(w>k.wbits){P.msg="invalid window size",k.mode=30;break}k.dmax=1<<w,P.adler=k.check=1,k.mode=512&q?10:12,V=q=0;break;case 2:for(;V<16;){if(ee===0)break e;ee--,q+=Q[Y++]<<V,V+=8}if(k.flags=q,(255&k.flags)!=8){P.msg="unknown compression method",k.mode=30;break}if(57344&k.flags){P.msg="unknown header flags set",k.mode=30;break}k.head&&(k.head.text=q>>8&1),512&k.flags&&(B[0]=255&q,B[1]=q>>>8&255,k.check=o(k.check,B,2,0)),V=q=0,k.mode=3;case 3:for(;V<32;){if(ee===0)break e;ee--,q+=Q[Y++]<<V,V+=8}k.head&&(k.head.time=q),512&k.flags&&(B[0]=255&q,B[1]=q>>>8&255,B[2]=q>>>16&255,B[3]=q>>>24&255,k.check=o(k.check,B,4,0)),V=q=0,k.mode=4;case 4:for(;V<16;){if(ee===0)break e;ee--,q+=Q[Y++]<<V,V+=8}k.head&&(k.head.xflags=255&q,k.head.os=q>>8),512&k.flags&&(B[0]=255&q,B[1]=q>>>8&255,k.check=o(k.check,B,2,0)),V=q=0,k.mode=5;case 5:if(1024&k.flags){for(;V<16;){if(ee===0)break e;ee--,q+=Q[Y++]<<V,V+=8}k.length=q,k.head&&(k.head.extra_len=q),512&k.flags&&(B[0]=255&q,B[1]=q>>>8&255,k.check=o(k.check,B,2,0)),V=q=0}else k.head&&(k.head.extra=null);k.mode=6;case 6:if(1024&k.flags&&(ee<(j=k.length)&&(j=ee),j&&(k.head&&(w=k.head.extra_len-k.length,k.head.extra||(k.head.extra=new Array(k.head.extra_len)),s.arraySet(k.head.extra,Q,Y,j,w)),512&k.flags&&(k.check=o(k.check,Q,j,Y)),ee-=j,Y+=j,k.length-=j),k.length))break e;k.length=0,k.mode=7;case 7:if(2048&k.flags){if(ee===0)break e;for(j=0;w=Q[Y+j++],k.head&&w&&k.length<65536&&(k.head.name+=String.fromCharCode(w)),w&&j<ee;);if(512&k.flags&&(k.check=o(k.check,Q,j,Y)),ee-=j,Y+=j,w)break e}else k.head&&(k.head.name=null);k.length=0,k.mode=8;case 8:if(4096&k.flags){if(ee===0)break e;for(j=0;w=Q[Y+j++],k.head&&w&&k.length<65536&&(k.head.comment+=String.fromCharCode(w)),w&&j<ee;);if(512&k.flags&&(k.check=o(k.check,Q,j,Y)),ee-=j,Y+=j,w)break e}else k.head&&(k.head.comment=null);k.mode=9;case 9:if(512&k.flags){for(;V<16;){if(ee===0)break e;ee--,q+=Q[Y++]<<V,V+=8}if(q!==(65535&k.check)){P.msg="header crc mismatch",k.mode=30;break}V=q=0}k.head&&(k.head.hcrc=k.flags>>9&1,k.head.done=!0),P.adler=k.check=0,k.mode=12;break;case 10:for(;V<32;){if(ee===0)break e;ee--,q+=Q[Y++]<<V,V+=8}P.adler=k.check=p(q),V=q=0,k.mode=11;case 11:if(k.havedict===0)return P.next_out=be,P.avail_out=me,P.next_in=Y,P.avail_in=ee,k.hold=q,k.bits=V,2;P.adler=k.check=1,k.mode=12;case 12:if(O===5||O===6)break e;case 13:if(k.last){q>>>=7&V,V-=7&V,k.mode=27;break}for(;V<3;){if(ee===0)break e;ee--,q+=Q[Y++]<<V,V+=8}switch(k.last=1&q,V-=1,3&(q>>>=1)){case 0:k.mode=14;break;case 1:if($(k),k.mode=20,O!==6)break;q>>>=2,V-=2;break e;case 2:k.mode=17;break;case 3:P.msg="invalid block type",k.mode=30}q>>>=2,V-=2;break;case 14:for(q>>>=7&V,V-=7&V;V<32;){if(ee===0)break e;ee--,q+=Q[Y++]<<V,V+=8}if((65535&q)!=(q>>>16^65535)){P.msg="invalid stored block lengths",k.mode=30;break}if(k.length=65535&q,V=q=0,k.mode=15,O===6)break e;case 15:k.mode=16;case 16:if(j=k.length){if(ee<j&&(j=ee),me<j&&(j=me),j===0)break e;s.arraySet(se,Q,Y,j,be),ee-=j,Y+=j,me-=j,be+=j,k.length-=j;break}k.mode=12;break;case 17:for(;V<14;){if(ee===0)break e;ee--,q+=Q[Y++]<<V,V+=8}if(k.nlen=257+(31&q),q>>>=5,V-=5,k.ndist=1+(31&q),q>>>=5,V-=5,k.ncode=4+(15&q),q>>>=4,V-=4,286<k.nlen||30<k.ndist){P.msg="too many length or distance symbols",k.mode=30;break}k.have=0,k.mode=18;case 18:for(;k.have<k.ncode;){for(;V<3;){if(ee===0)break e;ee--,q+=Q[Y++]<<V,V+=8}k.lens[L[k.have++]]=7&q,q>>>=3,V-=3}for(;k.have<19;)k.lens[L[k.have++]]=0;if(k.lencode=k.lendyn,k.lenbits=7,X={bits:k.lenbits},J=l(0,k.lens,0,19,k.lencode,0,k.work,X),k.lenbits=X.bits,J){P.msg="invalid code lengths set",k.mode=30;break}k.have=0,k.mode=19;case 19:for(;k.have<k.nlen+k.ndist;){for(;we=(T=k.lencode[q&(1<<k.lenbits)-1])>>>16&255,Ee=65535&T,!((he=T>>>24)<=V);){if(ee===0)break e;ee--,q+=Q[Y++]<<V,V+=8}if(Ee<16)q>>>=he,V-=he,k.lens[k.have++]=Ee;else{if(Ee===16){for(F=he+2;V<F;){if(ee===0)break e;ee--,q+=Q[Y++]<<V,V+=8}if(q>>>=he,V-=he,k.have===0){P.msg="invalid bit length repeat",k.mode=30;break}w=k.lens[k.have-1],j=3+(3&q),q>>>=2,V-=2}else if(Ee===17){for(F=he+3;V<F;){if(ee===0)break e;ee--,q+=Q[Y++]<<V,V+=8}V-=he,w=0,j=3+(7&(q>>>=he)),q>>>=3,V-=3}else{for(F=he+7;V<F;){if(ee===0)break e;ee--,q+=Q[Y++]<<V,V+=8}V-=he,w=0,j=11+(127&(q>>>=he)),q>>>=7,V-=7}if(k.have+j>k.nlen+k.ndist){P.msg="invalid bit length repeat",k.mode=30;break}for(;j--;)k.lens[k.have++]=w}}if(k.mode===30)break;if(k.lens[256]===0){P.msg="invalid code -- missing end-of-block",k.mode=30;break}if(k.lenbits=9,X={bits:k.lenbits},J=l(d,k.lens,0,k.nlen,k.lencode,0,k.work,X),k.lenbits=X.bits,J){P.msg="invalid literal/lengths set",k.mode=30;break}if(k.distbits=6,k.distcode=k.distdyn,X={bits:k.distbits},J=l(u,k.lens,k.nlen,k.ndist,k.distcode,0,k.work,X),k.distbits=X.bits,J){P.msg="invalid distances set",k.mode=30;break}if(k.mode=20,O===6)break e;case 20:k.mode=21;case 21:if(6<=ee&&258<=me){P.next_out=be,P.avail_out=me,P.next_in=Y,P.avail_in=ee,k.hold=q,k.bits=V,c(P,oe),be=P.next_out,se=P.output,me=P.avail_out,Y=P.next_in,Q=P.input,ee=P.avail_in,q=k.hold,V=k.bits,k.mode===12&&(k.back=-1);break}for(k.back=0;we=(T=k.lencode[q&(1<<k.lenbits)-1])>>>16&255,Ee=65535&T,!((he=T>>>24)<=V);){if(ee===0)break e;ee--,q+=Q[Y++]<<V,V+=8}if(we&&(240&we)==0){for(Se=he,Xe=we,at=Ee;we=(T=k.lencode[at+((q&(1<<Se+Xe)-1)>>Se)])>>>16&255,Ee=65535&T,!(Se+(he=T>>>24)<=V);){if(ee===0)break e;ee--,q+=Q[Y++]<<V,V+=8}q>>>=Se,V-=Se,k.back+=Se}if(q>>>=he,V-=he,k.back+=he,k.length=Ee,we===0){k.mode=26;break}if(32&we){k.back=-1,k.mode=12;break}if(64&we){P.msg="invalid literal/length code",k.mode=30;break}k.extra=15&we,k.mode=22;case 22:if(k.extra){for(F=k.extra;V<F;){if(ee===0)break e;ee--,q+=Q[Y++]<<V,V+=8}k.length+=q&(1<<k.extra)-1,q>>>=k.extra,V-=k.extra,k.back+=k.extra}k.was=k.length,k.mode=23;case 23:for(;we=(T=k.distcode[q&(1<<k.distbits)-1])>>>16&255,Ee=65535&T,!((he=T>>>24)<=V);){if(ee===0)break e;ee--,q+=Q[Y++]<<V,V+=8}if((240&we)==0){for(Se=he,Xe=we,at=Ee;we=(T=k.distcode[at+((q&(1<<Se+Xe)-1)>>Se)])>>>16&255,Ee=65535&T,!(Se+(he=T>>>24)<=V);){if(ee===0)break e;ee--,q+=Q[Y++]<<V,V+=8}q>>>=Se,V-=Se,k.back+=Se}if(q>>>=he,V-=he,k.back+=he,64&we){P.msg="invalid distance code",k.mode=30;break}k.offset=Ee,k.extra=15&we,k.mode=24;case 24:if(k.extra){for(F=k.extra;V<F;){if(ee===0)break e;ee--,q+=Q[Y++]<<V,V+=8}k.offset+=q&(1<<k.extra)-1,q>>>=k.extra,V-=k.extra,k.back+=k.extra}if(k.offset>k.dmax){P.msg="invalid distance too far back",k.mode=30;break}k.mode=25;case 25:if(me===0)break e;if(j=oe-me,k.offset>j){if((j=k.offset-j)>k.whave&&k.sane){P.msg="invalid distance too far back",k.mode=30;break}te=j>k.wnext?(j-=k.wnext,k.wsize-j):k.wnext-j,j>k.length&&(j=k.length),le=k.window}else le=se,te=be-k.offset,j=k.length;for(me<j&&(j=me),me-=j,k.length-=j;se[be++]=le[te++],--j;);k.length===0&&(k.mode=21);break;case 26:if(me===0)break e;se[be++]=k.length,me--,k.mode=21;break;case 27:if(k.wrap){for(;V<32;){if(ee===0)break e;ee--,q|=Q[Y++]<<V,V+=8}if(oe-=me,P.total_out+=oe,k.total+=oe,oe&&(P.adler=k.check=k.flags?o(k.check,se,oe,be-oe):n(k.check,se,oe,be-oe)),oe=me,(k.flags?q:p(q))!==k.check){P.msg="incorrect data check",k.mode=30;break}V=q=0}k.mode=28;case 28:if(k.wrap&&k.flags){for(;V<32;){if(ee===0)break e;ee--,q+=Q[Y++]<<V,V+=8}if(q!==(4294967295&k.total)){P.msg="incorrect length check",k.mode=30;break}V=q=0}k.mode=29;case 29:J=1;break e;case 30:J=-3;break e;case 31:return-4;default:return h}return P.next_out=be,P.avail_out=me,P.next_in=Y,P.avail_in=ee,k.hold=q,k.bits=V,(k.wsize||oe!==P.avail_out&&k.mode<30&&(k.mode<27||O!==4))&&K(P,P.output,P.next_out,oe-P.avail_out)?(k.mode=31,-4):(ue-=P.avail_in,oe-=P.avail_out,P.total_in+=ue,P.total_out+=oe,k.total+=oe,k.wrap&&oe&&(P.adler=k.check=k.flags?o(k.check,se,oe,P.next_out-oe):n(k.check,se,oe,P.next_out-oe)),P.data_type=k.bits+(k.last?64:0)+(k.mode===12?128:0)+(k.mode===20||k.mode===15?256:0),(ue==0&&oe===0||O===4)&&J===f&&(J=-5),J)},a.inflateEnd=function(P){if(!P||!P.state)return h;var O=P.state;return O.window&&(O.window=null),P.state=null,f},a.inflateGetHeader=function(P,O){var k;return P&&P.state?(2&(k=P.state).wrap)==0?h:((k.head=O).done=!1,f):h},a.inflateSetDictionary=function(P,O){var k,Q=O.length;return P&&P.state?(k=P.state).wrap!==0&&k.mode!==11?h:k.mode===11&&n(1,O,Q,0)!==k.check?-3:K(P,O,Q,Q)?(k.mode=31,-4):(k.havedict=1,f):h},a.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(t,i,a){var s=t("../utils/common"),n=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],o=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],c=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],l=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];i.exports=function(d,u,f,h,g,m,v,p){var b,y,_,S,A,z,D,M,$,K=p.bits,P=0,O=0,k=0,Q=0,se=0,Y=0,be=0,ee=0,me=0,q=0,V=null,ue=0,oe=new s.Buf16(16),j=new s.Buf16(16),te=null,le=0;for(P=0;P<=15;P++)oe[P]=0;for(O=0;O<h;O++)oe[u[f+O]]++;for(se=K,Q=15;1<=Q&&oe[Q]===0;Q--);if(Q<se&&(se=Q),Q===0)return g[m++]=20971520,g[m++]=20971520,p.bits=1,0;for(k=1;k<Q&&oe[k]===0;k++);for(se<k&&(se=k),P=ee=1;P<=15;P++)if(ee<<=1,(ee-=oe[P])<0)return-1;if(0<ee&&(d===0||Q!==1))return-1;for(j[1]=0,P=1;P<15;P++)j[P+1]=j[P]+oe[P];for(O=0;O<h;O++)u[f+O]!==0&&(v[j[u[f+O]]++]=O);if(z=d===0?(V=te=v,19):d===1?(V=n,ue-=257,te=o,le-=257,256):(V=c,te=l,-1),P=k,A=m,be=O=q=0,_=-1,S=(me=1<<(Y=se))-1,d===1&&852<me||d===2&&592<me)return 1;for(;;){for(D=P-be,$=v[O]<z?(M=0,v[O]):v[O]>z?(M=te[le+v[O]],V[ue+v[O]]):(M=96,0),b=1<<P-be,k=y=1<<Y;g[A+(q>>be)+(y-=b)]=D<<24|M<<16|$|0,y!==0;);for(b=1<<P-1;q&b;)b>>=1;if(b!==0?(q&=b-1,q+=b):q=0,O++,--oe[P]==0){if(P===Q)break;P=u[f+v[O]]}if(se<P&&(q&S)!==_){for(be===0&&(be=se),A+=k,ee=1<<(Y=P-be);Y+be<Q&&!((ee-=oe[Y+be])<=0);)Y++,ee<<=1;if(me+=1<<Y,d===1&&852<me||d===2&&592<me)return 1;g[_=q&S]=se<<24|Y<<16|A-m|0}}return q!==0&&(g[A+q]=P-be<<24|64<<16|0),p.bits=se,0}},{"../utils/common":41}],51:[function(t,i,a){i.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(t,i,a){var s=t("../utils/common"),n=0,o=1;function c(T){for(var B=T.length;0<=--B;)T[B]=0}var l=0,d=29,u=256,f=u+1+d,h=30,g=19,m=2*f+1,v=15,p=16,b=7,y=256,_=16,S=17,A=18,z=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],D=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],M=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],$=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],K=new Array(2*(f+2));c(K);var P=new Array(2*h);c(P);var O=new Array(512);c(O);var k=new Array(256);c(k);var Q=new Array(d);c(Q);var se,Y,be,ee=new Array(h);function me(T,B,L,H,U){this.static_tree=T,this.extra_bits=B,this.extra_base=L,this.elems=H,this.max_length=U,this.has_stree=T&&T.length}function q(T,B){this.dyn_tree=T,this.max_code=0,this.stat_desc=B}function V(T){return T<256?O[T]:O[256+(T>>>7)]}function ue(T,B){T.pending_buf[T.pending++]=255&B,T.pending_buf[T.pending++]=B>>>8&255}function oe(T,B,L){T.bi_valid>p-L?(T.bi_buf|=B<<T.bi_valid&65535,ue(T,T.bi_buf),T.bi_buf=B>>p-T.bi_valid,T.bi_valid+=L-p):(T.bi_buf|=B<<T.bi_valid&65535,T.bi_valid+=L)}function j(T,B,L){oe(T,L[2*B],L[2*B+1])}function te(T,B){for(var L=0;L|=1&T,T>>>=1,L<<=1,0<--B;);return L>>>1}function le(T,B,L){var H,U,Z=new Array(v+1),ie=0;for(H=1;H<=v;H++)Z[H]=ie=ie+L[H-1]<<1;for(U=0;U<=B;U++){var G=T[2*U+1];G!==0&&(T[2*U]=te(Z[G]++,G))}}function he(T){var B;for(B=0;B<f;B++)T.dyn_ltree[2*B]=0;for(B=0;B<h;B++)T.dyn_dtree[2*B]=0;for(B=0;B<g;B++)T.bl_tree[2*B]=0;T.dyn_ltree[2*y]=1,T.opt_len=T.static_len=0,T.last_lit=T.matches=0}function we(T){8<T.bi_valid?ue(T,T.bi_buf):0<T.bi_valid&&(T.pending_buf[T.pending++]=T.bi_buf),T.bi_buf=0,T.bi_valid=0}function Ee(T,B,L,H){var U=2*B,Z=2*L;return T[U]<T[Z]||T[U]===T[Z]&&H[B]<=H[L]}function Se(T,B,L){for(var H=T.heap[L],U=L<<1;U<=T.heap_len&&(U<T.heap_len&&Ee(B,T.heap[U+1],T.heap[U],T.depth)&&U++,!Ee(B,H,T.heap[U],T.depth));)T.heap[L]=T.heap[U],L=U,U<<=1;T.heap[L]=H}function Xe(T,B,L){var H,U,Z,ie,G=0;if(T.last_lit!==0)for(;H=T.pending_buf[T.d_buf+2*G]<<8|T.pending_buf[T.d_buf+2*G+1],U=T.pending_buf[T.l_buf+G],G++,H===0?j(T,U,B):(j(T,(Z=k[U])+u+1,B),(ie=z[Z])!==0&&oe(T,U-=Q[Z],ie),j(T,Z=V(--H),L),(ie=D[Z])!==0&&oe(T,H-=ee[Z],ie)),G<T.last_lit;);j(T,y,B)}function at(T,B){var L,H,U,Z=B.dyn_tree,ie=B.stat_desc.static_tree,G=B.stat_desc.has_stree,ae=B.stat_desc.elems,ye=-1;for(T.heap_len=0,T.heap_max=m,L=0;L<ae;L++)Z[2*L]!==0?(T.heap[++T.heap_len]=ye=L,T.depth[L]=0):Z[2*L+1]=0;for(;T.heap_len<2;)Z[2*(U=T.heap[++T.heap_len]=ye<2?++ye:0)]=1,T.depth[U]=0,T.opt_len--,G&&(T.static_len-=ie[2*U+1]);for(B.max_code=ye,L=T.heap_len>>1;1<=L;L--)Se(T,Z,L);for(U=ae;L=T.heap[1],T.heap[1]=T.heap[T.heap_len--],Se(T,Z,1),H=T.heap[1],T.heap[--T.heap_max]=L,T.heap[--T.heap_max]=H,Z[2*U]=Z[2*L]+Z[2*H],T.depth[U]=(T.depth[L]>=T.depth[H]?T.depth[L]:T.depth[H])+1,Z[2*L+1]=Z[2*H+1]=U,T.heap[1]=U++,Se(T,Z,1),2<=T.heap_len;);T.heap[--T.heap_max]=T.heap[1],(function(ke,Ie){var Fe,Oe,Qe,Re,tt,ht,it=Ie.dyn_tree,pt=Ie.max_code,Ht=Ie.stat_desc.static_tree,Yt=Ie.stat_desc.has_stree,Be=Ie.stat_desc.extra_bits,Ae=Ie.stat_desc.extra_base,He=Ie.stat_desc.max_length,dt=0;for(Re=0;Re<=v;Re++)ke.bl_count[Re]=0;for(it[2*ke.heap[ke.heap_max]+1]=0,Fe=ke.heap_max+1;Fe<m;Fe++)He<(Re=it[2*it[2*(Oe=ke.heap[Fe])+1]+1]+1)&&(Re=He,dt++),it[2*Oe+1]=Re,pt<Oe||(ke.bl_count[Re]++,tt=0,Ae<=Oe&&(tt=Be[Oe-Ae]),ht=it[2*Oe],ke.opt_len+=ht*(Re+tt),Yt&&(ke.static_len+=ht*(Ht[2*Oe+1]+tt)));if(dt!==0){do{for(Re=He-1;ke.bl_count[Re]===0;)Re--;ke.bl_count[Re]--,ke.bl_count[Re+1]+=2,ke.bl_count[He]--,dt-=2}while(0<dt);for(Re=He;Re!==0;Re--)for(Oe=ke.bl_count[Re];Oe!==0;)pt<(Qe=ke.heap[--Fe])||(it[2*Qe+1]!==Re&&(ke.opt_len+=(Re-it[2*Qe+1])*it[2*Qe],it[2*Qe+1]=Re),Oe--)}})(T,B),le(Z,ye,T.bl_count)}function w(T,B,L){var H,U,Z=-1,ie=B[1],G=0,ae=7,ye=4;for(ie===0&&(ae=138,ye=3),B[2*(L+1)+1]=65535,H=0;H<=L;H++)U=ie,ie=B[2*(H+1)+1],++G<ae&&U===ie||(G<ye?T.bl_tree[2*U]+=G:U!==0?(U!==Z&&T.bl_tree[2*U]++,T.bl_tree[2*_]++):G<=10?T.bl_tree[2*S]++:T.bl_tree[2*A]++,Z=U,ye=(G=0)===ie?(ae=138,3):U===ie?(ae=6,3):(ae=7,4))}function J(T,B,L){var H,U,Z=-1,ie=B[1],G=0,ae=7,ye=4;for(ie===0&&(ae=138,ye=3),H=0;H<=L;H++)if(U=ie,ie=B[2*(H+1)+1],!(++G<ae&&U===ie)){if(G<ye)for(;j(T,U,T.bl_tree),--G!=0;);else U!==0?(U!==Z&&(j(T,U,T.bl_tree),G--),j(T,_,T.bl_tree),oe(T,G-3,2)):G<=10?(j(T,S,T.bl_tree),oe(T,G-3,3)):(j(T,A,T.bl_tree),oe(T,G-11,7));Z=U,ye=(G=0)===ie?(ae=138,3):U===ie?(ae=6,3):(ae=7,4)}}c(ee);var X=!1;function F(T,B,L,H){oe(T,(l<<1)+(H?1:0),3),(function(U,Z,ie,G){we(U),ue(U,ie),ue(U,~ie),s.arraySet(U.pending_buf,U.window,Z,ie,U.pending),U.pending+=ie})(T,B,L)}a._tr_init=function(T){X||((function(){var B,L,H,U,Z,ie=new Array(v+1);for(U=H=0;U<d-1;U++)for(Q[U]=H,B=0;B<1<<z[U];B++)k[H++]=U;for(k[H-1]=U,U=Z=0;U<16;U++)for(ee[U]=Z,B=0;B<1<<D[U];B++)O[Z++]=U;for(Z>>=7;U<h;U++)for(ee[U]=Z<<7,B=0;B<1<<D[U]-7;B++)O[256+Z++]=U;for(L=0;L<=v;L++)ie[L]=0;for(B=0;B<=143;)K[2*B+1]=8,B++,ie[8]++;for(;B<=255;)K[2*B+1]=9,B++,ie[9]++;for(;B<=279;)K[2*B+1]=7,B++,ie[7]++;for(;B<=287;)K[2*B+1]=8,B++,ie[8]++;for(le(K,f+1,ie),B=0;B<h;B++)P[2*B+1]=5,P[2*B]=te(B,5);se=new me(K,z,u+1,f,v),Y=new me(P,D,0,h,v),be=new me(new Array(0),M,0,g,b)})(),X=!0),T.l_desc=new q(T.dyn_ltree,se),T.d_desc=new q(T.dyn_dtree,Y),T.bl_desc=new q(T.bl_tree,be),T.bi_buf=0,T.bi_valid=0,he(T)},a._tr_stored_block=F,a._tr_flush_block=function(T,B,L,H){var U,Z,ie=0;0<T.level?(T.strm.data_type===2&&(T.strm.data_type=(function(G){var ae,ye=4093624447;for(ae=0;ae<=31;ae++,ye>>>=1)if(1&ye&&G.dyn_ltree[2*ae]!==0)return n;if(G.dyn_ltree[18]!==0||G.dyn_ltree[20]!==0||G.dyn_ltree[26]!==0)return o;for(ae=32;ae<u;ae++)if(G.dyn_ltree[2*ae]!==0)return o;return n})(T)),at(T,T.l_desc),at(T,T.d_desc),ie=(function(G){var ae;for(w(G,G.dyn_ltree,G.l_desc.max_code),w(G,G.dyn_dtree,G.d_desc.max_code),at(G,G.bl_desc),ae=g-1;3<=ae&&G.bl_tree[2*$[ae]+1]===0;ae--);return G.opt_len+=3*(ae+1)+5+5+4,ae})(T),U=T.opt_len+3+7>>>3,(Z=T.static_len+3+7>>>3)<=U&&(U=Z)):U=Z=L+5,L+4<=U&&B!==-1?F(T,B,L,H):T.strategy===4||Z===U?(oe(T,2+(H?1:0),3),Xe(T,K,P)):(oe(T,4+(H?1:0),3),(function(G,ae,ye,ke){var Ie;for(oe(G,ae-257,5),oe(G,ye-1,5),oe(G,ke-4,4),Ie=0;Ie<ke;Ie++)oe(G,G.bl_tree[2*$[Ie]+1],3);J(G,G.dyn_ltree,ae-1),J(G,G.dyn_dtree,ye-1)})(T,T.l_desc.max_code+1,T.d_desc.max_code+1,ie+1),Xe(T,T.dyn_ltree,T.dyn_dtree)),he(T),H&&we(T)},a._tr_tally=function(T,B,L){return T.pending_buf[T.d_buf+2*T.last_lit]=B>>>8&255,T.pending_buf[T.d_buf+2*T.last_lit+1]=255&B,T.pending_buf[T.l_buf+T.last_lit]=255&L,T.last_lit++,B===0?T.dyn_ltree[2*L]++:(T.matches++,B--,T.dyn_ltree[2*(k[L]+u+1)]++,T.dyn_dtree[2*V(B)]++),T.last_lit===T.lit_bufsize-1},a._tr_align=function(T){oe(T,2,3),j(T,y,K),(function(B){B.bi_valid===16?(ue(B,B.bi_buf),B.bi_buf=0,B.bi_valid=0):8<=B.bi_valid&&(B.pending_buf[B.pending++]=255&B.bi_buf,B.bi_buf>>=8,B.bi_valid-=8)})(T)}},{"../utils/common":41}],53:[function(t,i,a){i.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(t,i,a){(function(s){(function(n,o){if(!n.setImmediate){var c,l,d,u,f=1,h={},g=!1,m=n.document,v=Object.getPrototypeOf&&Object.getPrototypeOf(n);v=v&&v.setTimeout?v:n,c={}.toString.call(n.process)==="[object process]"?function(_){process.nextTick(function(){b(_)})}:(function(){if(n.postMessage&&!n.importScripts){var _=!0,S=n.onmessage;return n.onmessage=function(){_=!1},n.postMessage("","*"),n.onmessage=S,_}})()?(u="setImmediate$"+Math.random()+"$",n.addEventListener?n.addEventListener("message",y,!1):n.attachEvent("onmessage",y),function(_){n.postMessage(u+_,"*")}):n.MessageChannel?((d=new MessageChannel).port1.onmessage=function(_){b(_.data)},function(_){d.port2.postMessage(_)}):m&&"onreadystatechange"in m.createElement("script")?(l=m.documentElement,function(_){var S=m.createElement("script");S.onreadystatechange=function(){b(_),S.onreadystatechange=null,l.removeChild(S),S=null},l.appendChild(S)}):function(_){setTimeout(b,0,_)},v.setImmediate=function(_){typeof _!="function"&&(_=new Function(""+_));for(var S=new Array(arguments.length-1),A=0;A<S.length;A++)S[A]=arguments[A+1];var z={callback:_,args:S};return h[f]=z,c(f),f++},v.clearImmediate=p}function p(_){delete h[_]}function b(_){if(g)setTimeout(b,0,_);else{var S=h[_];if(S){g=!0;try{(function(A){var z=A.callback,D=A.args;switch(D.length){case 0:z();break;case 1:z(D[0]);break;case 2:z(D[0],D[1]);break;case 3:z(D[0],D[1],D[2]);break;default:z.apply(o,D)}})(S)}finally{p(_),g=!1}}}}function y(_){_.source===n&&typeof _.data=="string"&&_.data.indexOf(u)===0&&b(+_.data.slice(u.length))}})(typeof self>"u"?s===void 0?this:s:self)}).call(this,typeof ya<"u"?ya:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(tn)),tn.exports}var Pu=Cu();const Eu=Su(Pu);function I(r){if(!r)throw new Error("Assertion failed.")}const Ha=r=>{const e=(r%360+360)%360;if(e===0||e===90||e===180||e===270)return e;throw new Error(`Invalid rotation ${r}.`)},Ct=r=>r&&r[r.length-1],Mi=r=>r>=0&&r<2**32;class bt{constructor(e){this.bytes=e,this.pos=0}seekToByte(e){this.pos=8*e}readBit(){const e=Math.floor(this.pos/8),t=this.bytes[e]??0,i=7-(this.pos&7),a=(t&1<<i)>>i;return this.pos++,a}readBits(e){if(e===1)return this.readBit();let t=0;for(let i=0;i<e;i++)t<<=1,t|=this.readBit();return t}writeBits(e,t){const i=this.pos+e;for(let a=this.pos;a<i;a++){const s=Math.floor(a/8);let n=this.bytes[s];const o=7-(a&7);n&=~(1<<o),n|=(t&1<<i-a-1)>>i-a-1<<o,this.bytes[s]=n}this.pos=i}readAlignedByte(){if(this.pos%8!==0)throw new Error("Bitstream is not byte-aligned.");const e=this.pos/8,t=this.bytes[e]??0;return this.pos+=8,t}skipBits(e){this.pos+=e}getBitsLeft(){return this.bytes.length*8-this.pos}clone(){const e=new bt(this.bytes);return e.pos=this.pos,e}}const xe=r=>{let e=0;for(;r.readBits(1)===0&&e<32;)e++;if(e>=32)throw new Error("Invalid exponential-Golomb code.");return(1<<e)-1+r.readBits(e)},zr=r=>{const e=xe(r);return(e&1)===0?-(e>>1):e+1>>1},Iu=(r,e,t,i)=>{for(let a=e;a<t;a++){const s=Math.floor(a/8);let n=r[s];const o=7-(a&7);n&=~(1<<o),n|=(i&1<<t-a-1)>>t-a-1<<o,r[s]=n}},Vt=r=>r.constructor===Uint8Array?r:ArrayBuffer.isView(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):new Uint8Array(r),kt=r=>r.constructor===DataView?r:ArrayBuffer.isView(r)?new DataView(r.buffer,r.byteOffset,r.byteLength):new DataView(r),or=new TextDecoder,Kt=new TextEncoder,ds=r=>Object.fromEntries(Object.entries(r).map(([e,t])=>[t,e])),Ui={bt709:1,bt470bg:5,smpte170m:6,bt2020:9,smpte432:12},oc=ds(Ui),Vi={bt709:1,smpte170m:6,linear:8,"iec61966-2-1":13,pq:16,hlg:18},cc=ds(Vi),Li={rgb:0,bt709:1,bt470bg:5,smpte170m:6,"bt2020-ncl":9},lc=ds(Li),dc=r=>!!r&&!!r.primaries&&!!r.transfer&&!!r.matrix&&r.fullRange!==void 0,ja=r=>r instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&r instanceof SharedArrayBuffer||ArrayBuffer.isView(r);class $i{constructor(){this.currentPromise=Promise.resolve()}async acquire(){let e;const t=new Promise(a=>{e=a}),i=this.currentPromise;return this.currentPromise=t,await i,e}}const Js=r=>[...r].map(e=>e.toString(16).padStart(2,"0")).join(""),eo=r=>(r=r>>1&1431655765|(r&1431655765)<<1,r=r>>2&858993459|(r&858993459)<<2,r=r>>4&252645135|(r&252645135)<<4,r=r>>8&16711935|(r&16711935)<<8,r=r>>16&65535|(r&65535)<<16,r>>>0),qa=(r,e,t)=>{let i=0,a=r.length-1,s=-1;for(;i<=a;){const n=i+a>>1,o=t(r[n]);o===e?(s=n,a=n-1):o<e?i=n+1:a=n-1}return s},lt=(r,e,t)=>{let i=0,a=r.length-1,s=-1;for(;i<=a;){const n=i+(a-i+1)/2|0;t(r[n])<=e?(s=n,i=n+1):a=n-1}return s},to=(r,e,t)=>{const i=lt(r,t(e),t);r.splice(i+1,0,e)},Mt=()=>{let r,e;return{promise:new Promise((i,a)=>{r=i,e=a}),resolve:r,reject:e}},uc=(r,e)=>{for(let t=r.length-1;t>=0;t--)if(e(r[t]))return r[t]},fc=(r,e)=>{for(let t=r.length-1;t>=0;t--)if(e(r[t]))return t;return-1},Au=async function*(r){Symbol.iterator in r?yield*r[Symbol.iterator]():yield*r[Symbol.asyncIterator]()},Fu=r=>{if(!(Symbol.iterator in r)&&!(Symbol.asyncIterator in r))throw new TypeError("Argument must be an iterable or async iterable.")},pr=r=>{throw new Error(`Unexpected value: ${r}`)},Ka=(r,e,t)=>{const i=r.getUint8(e),a=r.getUint8(e+1),s=r.getUint8(e+2);return t?i|a<<8|s<<16:i<<16|a<<8|s},zu=(r,e,t)=>Ka(r,e,t)<<8>>8,us=(r,e,t,i)=>{t=t>>>0,t=t&16777215,i?(r.setUint8(e,t&255),r.setUint8(e+1,t>>>8&255),r.setUint8(e+2,t>>>16&255)):(r.setUint8(e,t>>>16&255),r.setUint8(e+1,t>>>8&255),r.setUint8(e+2,t&255))},Bu=(r,e,t,i)=>{t=Bt(t,-8388608,8388607),t<0&&(t=t+16777216&16777215),us(r,e,t,i)},ro=(r,e)=>({async next(){const t=await r.next();return t.done?{value:void 0,done:!0}:{value:e(t.value),done:!1}},return(){return r.return()},throw(t){return r.throw(t)},[Symbol.asyncIterator](){return this}}),Bt=(r,e,t)=>Math.max(e,Math.min(t,r)),er="und",Ma=r=>{const e=Math.round(r);return Math.abs(r/e-1)<10*Number.EPSILON?e:r},Rn=(r,e)=>Math.round(r/e)*e,Mu=r=>{let e=0;for(;r;)e++,r>>=1;return e},Ru=/^[a-z]{3}$/,sa=r=>Ru.test(r),$r=1e6*(1+Number.EPSILON),Du=(r,e)=>{const t=r<0?-1:1;r=Math.abs(r);let i=0,a=1,s=1,n=0,o=r;for(;;){const c=Math.floor(o),l=c*s+i,d=c*n+a;if(d>e)return{numerator:t*s,denominator:n};if(i=s,a=n,s=l,n=d,o=1/(o-c),!isFinite(o))break}return{numerator:t*s,denominator:n}};class Ga{constructor(){this.currentPromise=Promise.resolve()}call(e){return this.currentPromise=this.currentPromise.then(e)}}let rn=null;const ta=()=>rn!==null?rn:rn=!!(typeof navigator<"u"&&(navigator.vendor?.match(/apple/i)||/AppleWebKit/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)||/\b(iPad|iPhone|iPod)\b/.test(navigator.userAgent)));let an=null;const Ri=()=>an!==null?an:an=typeof navigator<"u"&&navigator.userAgent?.includes("Firefox");let nn=null;const Dn=()=>nn!==null?nn:nn=!!(typeof navigator<"u"&&(navigator.vendor?.includes("Google Inc")||/Chrome/.test(navigator.userAgent)));let sn=null;const Nu=()=>{if(sn!==null)return sn;if(typeof navigator>"u")return null;const r=/\bChrome\/(\d+)/.exec(navigator.userAgent);return r?sn=Number(r[1]):null},fi=(r,e)=>r!==-1?r:e,io=(r,e,t,i)=>r<=i&&t<=e,fs=function*(r){for(const e in r){const t=r[e];t!==void 0&&(yield{key:e,value:t})}},Ou=r=>{switch(r.toLowerCase()){case"image/jpeg":case"image/jpg":return".jpg";case"image/png":return".png";case"image/gif":return".gif";case"image/webp":return".webp";case"image/bmp":return".bmp";case"image/svg+xml":return".svg";case"image/tiff":return".tiff";case"image/avif":return".avif";case"image/x-icon":case"image/vnd.microsoft.icon":return".ico";default:return null}},Uu=r=>{const e=atob(r),t=new Uint8Array(e.length);for(let i=0;i<e.length;i++)t[i]=e.charCodeAt(i);return t},Vu=(r,e)=>{if(r.length!==e.length)return!1;for(let t=0;t<r.length;t++)if(r[t]!==e[t])return!1;return!0},hc=()=>{Symbol.dispose??=Symbol("Symbol.dispose")},mc=r=>typeof r=="number"&&!Number.isNaN(r);class Ci{constructor(e,t){if(this.data=e,this.mimeType=t,!(e instanceof Uint8Array))throw new TypeError("data must be a Uint8Array.");if(typeof t!="string")throw new TypeError("mimeType must be a string.")}}class hs{constructor(e,t,i,a){if(this.data=e,this.mimeType=t,this.name=i,this.description=a,!(e instanceof Uint8Array))throw new TypeError("data must be a Uint8Array.");if(t!==void 0&&typeof t!="string")throw new TypeError("mimeType, when provided, must be a string.");if(i!==void 0&&typeof i!="string")throw new TypeError("name, when provided, must be a string.");if(a!==void 0&&typeof a!="string")throw new TypeError("description, when provided, must be a string.")}}const Nn=r=>{if(!r||typeof r!="object")throw new TypeError("tags must be an object.");if(r.title!==void 0&&typeof r.title!="string")throw new TypeError("tags.title, when provided, must be a string.");if(r.description!==void 0&&typeof r.description!="string")throw new TypeError("tags.description, when provided, must be a string.");if(r.artist!==void 0&&typeof r.artist!="string")throw new TypeError("tags.artist, when provided, must be a string.");if(r.album!==void 0&&typeof r.album!="string")throw new TypeError("tags.album, when provided, must be a string.");if(r.albumArtist!==void 0&&typeof r.albumArtist!="string")throw new TypeError("tags.albumArtist, when provided, must be a string.");if(r.trackNumber!==void 0&&(!Number.isInteger(r.trackNumber)||r.trackNumber<=0))throw new TypeError("tags.trackNumber, when provided, must be a positive integer.");if(r.tracksTotal!==void 0&&(!Number.isInteger(r.tracksTotal)||r.tracksTotal<=0))throw new TypeError("tags.tracksTotal, when provided, must be a positive integer.");if(r.discNumber!==void 0&&(!Number.isInteger(r.discNumber)||r.discNumber<=0))throw new TypeError("tags.discNumber, when provided, must be a positive integer.");if(r.discsTotal!==void 0&&(!Number.isInteger(r.discsTotal)||r.discsTotal<=0))throw new TypeError("tags.discsTotal, when provided, must be a positive integer.");if(r.genre!==void 0&&typeof r.genre!="string")throw new TypeError("tags.genre, when provided, must be a string.");if(r.date!==void 0&&(!(r.date instanceof Date)||Number.isNaN(r.date.getTime())))throw new TypeError("tags.date, when provided, must be a valid Date.");if(r.lyrics!==void 0&&typeof r.lyrics!="string")throw new TypeError("tags.lyrics, when provided, must be a string.");if(r.images!==void 0){if(!Array.isArray(r.images))throw new TypeError("tags.images, when provided, must be an array.");for(const e of r.images){if(!e||typeof e!="object")throw new TypeError("Each image in tags.images must be an object.");if(!(e.data instanceof Uint8Array))throw new TypeError("Each image.data must be a Uint8Array.");if(typeof e.mimeType!="string")throw new TypeError("Each image.mimeType must be a string.");if(!["coverFront","coverBack","unknown"].includes(e.kind))throw new TypeError("Each image.kind must be 'coverFront', 'coverBack', or 'unknown'.")}}if(r.comment!==void 0&&typeof r.comment!="string")throw new TypeError("tags.comment, when provided, must be a string.");if(r.raw!==void 0){if(!r.raw||typeof r.raw!="object")throw new TypeError("tags.raw, when provided, must be an object.");for(const e of Object.values(r.raw))if(e!==null&&typeof e!="string"&&!(e instanceof Uint8Array)&&!(e instanceof Ci)&&!(e instanceof hs))throw new TypeError("Each value in tags.raw must be a string, Uint8Array, RichImageData, AttachedFile, or null.")}},ni={default:!0,forced:!1,original:!1,commentary:!1,hearingImpaired:!1,visuallyImpaired:!1},Lu=r=>{if(!r||typeof r!="object")throw new TypeError("disposition must be an object.");if(r.default!==void 0&&typeof r.default!="boolean")throw new TypeError("disposition.default must be a boolean.");if(r.forced!==void 0&&typeof r.forced!="boolean")throw new TypeError("disposition.forced must be a boolean.");if(r.original!==void 0&&typeof r.original!="boolean")throw new TypeError("disposition.original must be a boolean.");if(r.commentary!==void 0&&typeof r.commentary!="boolean")throw new TypeError("disposition.commentary must be a boolean.");if(r.hearingImpaired!==void 0&&typeof r.hearingImpaired!="boolean")throw new TypeError("disposition.hearingImpaired must be a boolean.");if(r.visuallyImpaired!==void 0&&typeof r.visuallyImpaired!="boolean")throw new TypeError("disposition.visuallyImpaired must be a boolean.")};const cr=["avc","hevc","vp9","av1","vp8"],Dt=["pcm-s16","pcm-s16be","pcm-s24","pcm-s24be","pcm-s32","pcm-s32be","pcm-f32","pcm-f32be","pcm-f64","pcm-f64be","pcm-u8","pcm-s8","ulaw","alaw"],Pi=["aac","opus","mp3","vorbis","flac"],gr=[...Pi,...Dt],Di=["webvtt"],ao=[{maxMacroblocks:99,maxBitrate:64e3,level:10},{maxMacroblocks:396,maxBitrate:192e3,level:11},{maxMacroblocks:396,maxBitrate:384e3,level:12},{maxMacroblocks:396,maxBitrate:768e3,level:13},{maxMacroblocks:396,maxBitrate:2e6,level:20},{maxMacroblocks:792,maxBitrate:4e6,level:21},{maxMacroblocks:1620,maxBitrate:4e6,level:22},{maxMacroblocks:1620,maxBitrate:1e7,level:30},{maxMacroblocks:3600,maxBitrate:14e6,level:31},{maxMacroblocks:5120,maxBitrate:2e7,level:32},{maxMacroblocks:8192,maxBitrate:2e7,level:40},{maxMacroblocks:8192,maxBitrate:5e7,level:41},{maxMacroblocks:8704,maxBitrate:5e7,level:42},{maxMacroblocks:22080,maxBitrate:135e6,level:50},{maxMacroblocks:36864,maxBitrate:24e7,level:51},{maxMacroblocks:36864,maxBitrate:24e7,level:52},{maxMacroblocks:139264,maxBitrate:24e7,level:60},{maxMacroblocks:139264,maxBitrate:48e7,level:61},{maxMacroblocks:139264,maxBitrate:8e8,level:62}],no=[{maxPictureSize:36864,maxBitrate:128e3,tier:"L",level:30},{maxPictureSize:122880,maxBitrate:15e5,tier:"L",level:60},{maxPictureSize:245760,maxBitrate:3e6,tier:"L",level:63},{maxPictureSize:552960,maxBitrate:6e6,tier:"L",level:90},{maxPictureSize:983040,maxBitrate:1e7,tier:"L",level:93},{maxPictureSize:2228224,maxBitrate:12e6,tier:"L",level:120},{maxPictureSize:2228224,maxBitrate:3e7,tier:"H",level:120},{maxPictureSize:2228224,maxBitrate:2e7,tier:"L",level:123},{maxPictureSize:2228224,maxBitrate:5e7,tier:"H",level:123},{maxPictureSize:8912896,maxBitrate:25e6,tier:"L",level:150},{maxPictureSize:8912896,maxBitrate:1e8,tier:"H",level:150},{maxPictureSize:8912896,maxBitrate:4e7,tier:"L",level:153},{maxPictureSize:8912896,maxBitrate:16e7,tier:"H",level:153},{maxPictureSize:8912896,maxBitrate:6e7,tier:"L",level:156},{maxPictureSize:8912896,maxBitrate:24e7,tier:"H",level:156},{maxPictureSize:35651584,maxBitrate:6e7,tier:"L",level:180},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:180},{maxPictureSize:35651584,maxBitrate:12e7,tier:"L",level:183},{maxPictureSize:35651584,maxBitrate:48e7,tier:"H",level:183},{maxPictureSize:35651584,maxBitrate:24e7,tier:"L",level:186},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:186}],Wr=[{maxPictureSize:36864,maxBitrate:2e5,level:10},{maxPictureSize:73728,maxBitrate:8e5,level:11},{maxPictureSize:122880,maxBitrate:18e5,level:20},{maxPictureSize:245760,maxBitrate:36e5,level:21},{maxPictureSize:552960,maxBitrate:72e5,level:30},{maxPictureSize:983040,maxBitrate:12e6,level:31},{maxPictureSize:2228224,maxBitrate:18e6,level:40},{maxPictureSize:2228224,maxBitrate:3e7,level:41},{maxPictureSize:8912896,maxBitrate:6e7,level:50},{maxPictureSize:8912896,maxBitrate:12e7,level:51},{maxPictureSize:8912896,maxBitrate:18e7,level:52},{maxPictureSize:35651584,maxBitrate:18e7,level:60},{maxPictureSize:35651584,maxBitrate:24e7,level:61},{maxPictureSize:35651584,maxBitrate:48e7,level:62}],so=[{maxPictureSize:147456,maxBitrate:15e5,tier:"M",level:0},{maxPictureSize:278784,maxBitrate:3e6,tier:"M",level:1},{maxPictureSize:665856,maxBitrate:6e6,tier:"M",level:4},{maxPictureSize:1065024,maxBitrate:1e7,tier:"M",level:5},{maxPictureSize:2359296,maxBitrate:12e6,tier:"M",level:8},{maxPictureSize:2359296,maxBitrate:3e7,tier:"H",level:8},{maxPictureSize:2359296,maxBitrate:2e7,tier:"M",level:9},{maxPictureSize:2359296,maxBitrate:5e7,tier:"H",level:9},{maxPictureSize:8912896,maxBitrate:3e7,tier:"M",level:12},{maxPictureSize:8912896,maxBitrate:1e8,tier:"H",level:12},{maxPictureSize:8912896,maxBitrate:4e7,tier:"M",level:13},{maxPictureSize:8912896,maxBitrate:16e7,tier:"H",level:13},{maxPictureSize:8912896,maxBitrate:6e7,tier:"M",level:14},{maxPictureSize:8912896,maxBitrate:24e7,tier:"H",level:14},{maxPictureSize:35651584,maxBitrate:6e7,tier:"M",level:15},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:15},{maxPictureSize:35651584,maxBitrate:6e7,tier:"M",level:16},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:16},{maxPictureSize:35651584,maxBitrate:1e8,tier:"M",level:17},{maxPictureSize:35651584,maxBitrate:48e7,tier:"H",level:17},{maxPictureSize:35651584,maxBitrate:16e7,tier:"M",level:18},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:18},{maxPictureSize:35651584,maxBitrate:16e7,tier:"M",level:19},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:19}],oo=".01.01.01.01.00",co=".0.110.01.01.01.0",$u=(r,e,t,i)=>{if(r==="avc"){const s=Math.ceil(e/16)*Math.ceil(t/16),n=ao.find(u=>s<=u.maxMacroblocks&&i<=u.maxBitrate)??Ct(ao),o=n?n.level:0,c="64".padStart(2,"0"),l="00",d=o.toString(16).padStart(2,"0");return`avc1.${c}${l}${d}`}else if(r==="hevc"){const o=e*t,c=no.find(d=>o<=d.maxPictureSize&&i<=d.maxBitrate)??Ct(no);return`hev1.1.6.${c.tier}${c.level}.B0`}else{if(r==="vp8")return"vp8";if(r==="vp9"){const s=e*t;return`vp09.00.${(Wr.find(c=>s<=c.maxPictureSize&&i<=c.maxBitrate)??Ct(Wr)).level.toString().padStart(2,"0")}.08`}else if(r==="av1"){const s=e*t,n=so.find(l=>s<=l.maxPictureSize&&i<=l.maxBitrate)??Ct(so);return`av01.0.${n.level.toString().padStart(2,"0")}${n.tier}.08`}}throw new TypeError(`Unhandled codec '${r}'.`)},Wu=r=>{const e=r.split("."),t=Number(e[1]),i=Number(e[2]),a=Number(e[3]),s=e[4]?Number(e[4]):1;return[1,1,t,2,1,i,3,1,a,4,1,s]},pc=r=>{const e=r.split("."),a=(1<<7)+1,s=Number(e[1]),n=e[2],o=Number(n.slice(0,-1)),c=(s<<5)+o,l=n.slice(-1)==="H"?1:0,u=Number(e[3])===8?0:1,f=0,h=e[4]?Number(e[4]):0,g=e[5]?Number(e[5][0]):1,m=e[5]?Number(e[5][1]):1,v=e[5]?Number(e[5][2]):0,p=(l<<7)+(u<<6)+(f<<5)+(h<<4)+(g<<3)+(m<<2)+v;return[a,c,p,0]},gc=r=>{const{codec:e,codecDescription:t,colorSpace:i,avcCodecInfo:a,hevcCodecInfo:s,vp9CodecInfo:n,av1CodecInfo:o}=r;if(e==="avc"){if(I(r.avcType!==null),a){const c=new Uint8Array([a.avcProfileIndication,a.profileCompatibility,a.avcLevelIndication]);return`avc${r.avcType}.${Js(c)}`}if(!t||t.byteLength<4)throw new TypeError("AVC decoder description is not provided or is not at least 4 bytes long.");return`avc${r.avcType}.${Js(t.subarray(1,4))}`}else if(e==="hevc"){let c,l,d,u,f,h;if(s)c=s.generalProfileSpace,l=s.generalProfileIdc,d=eo(s.generalProfileCompatibilityFlags),u=s.generalTierFlag,f=s.generalLevelIdc,h=[...s.generalConstraintIndicatorFlags];else{if(!t||t.byteLength<23)throw new TypeError("HEVC decoder description is not provided or is not at least 23 bytes long.");const m=kt(t),v=m.getUint8(1);c=v>>6&3,l=v&31,d=eo(m.getUint32(2)),u=v>>5&1,f=m.getUint8(12),h=[];for(let p=0;p<6;p++)h.push(m.getUint8(6+p))}let g="hev1.";for(g+=["","A","B","C"][c]+l,g+=".",g+=d.toString(16).toUpperCase(),g+=".",g+=u===0?"L":"H",g+=f;h.length>0&&h[h.length-1]===0;)h.pop();return h.length>0&&(g+=".",g+=h.map(m=>m.toString(16).toUpperCase()).join(".")),g}else{if(e==="vp8")return"vp8";if(e==="vp9"){if(!n){const p=r.width*r.height;let b=Ct(Wr).level;for(const y of Wr)if(p<=y.maxPictureSize){b=y.level;break}return`vp09.00.${b.toString().padStart(2,"0")}.08`}const c=n.profile.toString().padStart(2,"0"),l=n.level.toString().padStart(2,"0"),d=n.bitDepth.toString().padStart(2,"0"),u=n.chromaSubsampling.toString().padStart(2,"0"),f=n.colourPrimaries.toString().padStart(2,"0"),h=n.transferCharacteristics.toString().padStart(2,"0"),g=n.matrixCoefficients.toString().padStart(2,"0"),m=n.videoFullRangeFlag.toString().padStart(2,"0");let v=`vp09.${c}.${l}.${d}.${u}`;return v+=`.${f}.${h}.${g}.${m}`,v.endsWith(oo)&&(v=v.slice(0,-oo.length)),v}else if(e==="av1"){if(!o){const y=r.width*r.height;let _=Ct(Wr).level;for(const S of Wr)if(y<=S.maxPictureSize){_=S.level;break}return`av01.0.${_.toString().padStart(2,"0")}M.08`}const c=o.profile,l=o.level.toString().padStart(2,"0"),d=o.tier?"H":"M",u=o.bitDepth.toString().padStart(2,"0"),f=o.monochrome?"1":"0",h=100*o.chromaSubsamplingX+10*o.chromaSubsamplingY+1*(o.chromaSubsamplingX&&o.chromaSubsamplingY?o.chromaSamplePosition:0),g=i?.primaries?Ui[i.primaries]:1,m=i?.transfer?Vi[i.transfer]:1,v=i?.matrix?Li[i.matrix]:1,p=i?.fullRange?1:0;let b=`av01.${c}.${l}${d}.${u}`;return b+=`.${f}.${h.toString().padStart(3,"0")}`,b+=`.${g.toString().padStart(2,"0")}`,b+=`.${m.toString().padStart(2,"0")}`,b+=`.${v.toString().padStart(2,"0")}`,b+=`.${p}`,b.endsWith(co)&&(b=b.slice(0,-co.length)),b}}throw new TypeError(`Unhandled codec '${e}'.`)},Hu=(r,e,t)=>{if(r==="aac")return e>=2&&t<=24e3?"mp4a.40.29":t<=24e3?"mp4a.40.5":"mp4a.40.2";if(r==="mp3")return"mp3";if(r==="opus")return"opus";if(r==="vorbis")return"vorbis";if(r==="flac")return"flac";if(Dt.includes(r))return r;throw new TypeError(`Unhandled codec '${r}'.`)},vc=r=>{const{codec:e,codecDescription:t,aacCodecInfo:i}=r;if(e==="aac"){if(!i)throw new TypeError("AAC codec info must be provided.");return i.isMpeg2?"mp4a.67":`mp4a.40.${ps(t).objectType}`}else{if(e==="mp3")return"mp3";if(e==="opus")return"opus";if(e==="vorbis")return"vorbis";if(e==="flac")return"flac";if(e&&Dt.includes(e))return e}throw new TypeError(`Unhandled codec '${e}'.`)},oa=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],ms=[-1,1,2,3,4,5,6,8],ps=r=>{if(!r||r.byteLength<2)throw new TypeError("AAC description must be at least 2 bytes long.");const e=new bt(r);let t=e.readBits(5);t===31&&(t=32+e.readBits(6));const i=e.readBits(4);let a=null;i===15?a=e.readBits(24):i<oa.length&&(a=oa[i]);const s=e.readBits(4);let n=null;return s>=1&&s<=7&&(n=ms[s]),{objectType:t,frequencyIndex:i,sampleRate:a,channelConfiguration:s,numberOfChannels:n}},ju=r=>{let e=oa.indexOf(r.sampleRate),t=null;e===-1&&(e=15,t=r.sampleRate);const i=ms.indexOf(r.numberOfChannels);if(i===-1)throw new TypeError(`Unsupported number of channels: ${r.numberOfChannels}`);let a=13;r.objectType>=32&&(a+=6),e===15&&(a+=24);const s=Math.ceil(a/8),n=new Uint8Array(s),o=new bt(n);return r.objectType<32?o.writeBits(5,r.objectType):(o.writeBits(5,31),o.writeBits(6,r.objectType-32)),o.writeBits(4,e),e===15&&o.writeBits(24,t),o.writeBits(4,i),n},fa=48e3,bc=/^pcm-([usf])(\d+)+(be)?$/,Br=r=>{if(I(Dt.includes(r)),r==="ulaw")return{dataType:"ulaw",sampleSize:1,littleEndian:!0,silentValue:255};if(r==="alaw")return{dataType:"alaw",sampleSize:1,littleEndian:!0,silentValue:213};const e=bc.exec(r);I(e);let t;e[1]==="u"?t="unsigned":e[1]==="s"?t="signed":t="float";const i=Number(e[2])/8,a=e[3]!=="be",s=r==="pcm-u8"?2**7:0;return{dataType:t,sampleSize:i,littleEndian:a,silentValue:s}},wc=r=>r.startsWith("avc1")||r.startsWith("avc3")?"avc":r.startsWith("hev1")||r.startsWith("hvc1")?"hevc":r==="vp8"?"vp8":r.startsWith("vp09")?"vp9":r.startsWith("av01")?"av1":r.startsWith("mp4a.40")||r==="mp4a.67"?"aac":r==="mp3"||r==="mp4a.69"||r==="mp4a.6B"||r==="mp4a.6b"?"mp3":r==="opus"?"opus":r==="vorbis"?"vorbis":r==="flac"?"flac":r==="ulaw"?"ulaw":r==="alaw"?"alaw":bc.test(r)?r:r==="webvtt"?"webvtt":null,qu=r=>r==="avc"?{avc:{format:"avc"}}:r==="hevc"?{hevc:{format:"hevc"}}:{},Ku=r=>r==="aac"?{aac:{format:"aac"}}:r==="opus"?{opus:{format:"opus"}}:{},Gu=["avc1","avc3","hev1","hvc1","vp8","vp09","av01"],Qu=/^(avc1|avc3)\.[0-9a-fA-F]{6}$/,Xu=/^(hev1|hvc1)\.(?:[ABC]?\d+)\.[0-9a-fA-F]{1,8}\.[LH]\d+(?:\.[0-9a-fA-F]{1,2}){0,6}$/,Zu=/^vp09(?:\.\d{2}){3}(?:(?:\.\d{2}){5})?$/,Yu=/^av01\.\d\.\d{2}[MH]\.\d{2}(?:\.\d\.\d{3}\.\d{2}\.\d{2}\.\d{2}\.\d)?$/,yc=r=>{if(!r)throw new TypeError("Video chunk metadata must be provided.");if(typeof r!="object")throw new TypeError("Video chunk metadata must be an object.");if(!r.decoderConfig)throw new TypeError("Video chunk metadata must include a decoder configuration.");if(typeof r.decoderConfig!="object")throw new TypeError("Video chunk metadata decoder configuration must be an object.");if(typeof r.decoderConfig.codec!="string")throw new TypeError("Video chunk metadata decoder configuration must specify a codec string.");if(!Gu.some(e=>r.decoderConfig.codec.startsWith(e)))throw new TypeError("Video chunk metadata decoder configuration codec string must be a valid video codec string as specified in the WebCodecs Codec Registry.");if(!Number.isInteger(r.decoderConfig.codedWidth)||r.decoderConfig.codedWidth<=0)throw new TypeError("Video chunk metadata decoder configuration must specify a valid codedWidth (positive integer).");if(!Number.isInteger(r.decoderConfig.codedHeight)||r.decoderConfig.codedHeight<=0)throw new TypeError("Video chunk metadata decoder configuration must specify a valid codedHeight (positive integer).");if(r.decoderConfig.description!==void 0&&!ja(r.decoderConfig.description))throw new TypeError("Video chunk metadata decoder configuration description, when defined, must be an ArrayBuffer or an ArrayBuffer view.");if(r.decoderConfig.colorSpace!==void 0){const{colorSpace:e}=r.decoderConfig;if(typeof e!="object")throw new TypeError("Video chunk metadata decoder configuration colorSpace, when provided, must be an object.");const t=Object.keys(Ui);if(e.primaries!=null&&!t.includes(e.primaries))throw new TypeError(`Video chunk metadata decoder configuration colorSpace primaries, when defined, must be one of ${t.join(", ")}.`);const i=Object.keys(Vi);if(e.transfer!=null&&!i.includes(e.transfer))throw new TypeError(`Video chunk metadata decoder configuration colorSpace transfer, when defined, must be one of ${i.join(", ")}.`);const a=Object.keys(Li);if(e.matrix!=null&&!a.includes(e.matrix))throw new TypeError(`Video chunk metadata decoder configuration colorSpace matrix, when defined, must be one of ${a.join(", ")}.`);if(e.fullRange!=null&&typeof e.fullRange!="boolean")throw new TypeError("Video chunk metadata decoder configuration colorSpace fullRange, when defined, must be a boolean.")}if(r.decoderConfig.codec.startsWith("avc1")||r.decoderConfig.codec.startsWith("avc3")){if(!Qu.test(r.decoderConfig.codec))throw new TypeError("Video chunk metadata decoder configuration codec string for AVC must be a valid AVC codec string as specified in Section 3.4 of RFC 6381.")}else if(r.decoderConfig.codec.startsWith("hev1")||r.decoderConfig.codec.startsWith("hvc1")){if(!Xu.test(r.decoderConfig.codec))throw new TypeError("Video chunk metadata decoder configuration codec string for HEVC must be a valid HEVC codec string as specified in Section E.3 of ISO 14496-15.")}else if(r.decoderConfig.codec.startsWith("vp8")){if(r.decoderConfig.codec!=="vp8")throw new TypeError('Video chunk metadata decoder configuration codec string for VP8 must be "vp8".')}else if(r.decoderConfig.codec.startsWith("vp09")){if(!Zu.test(r.decoderConfig.codec))throw new TypeError('Video chunk metadata decoder configuration codec string for VP9 must be a valid VP9 codec string as specified in Section "Codecs Parameter String" of https://www.webmproject.org/vp9/mp4/.')}else if(r.decoderConfig.codec.startsWith("av01")&&!Yu.test(r.decoderConfig.codec))throw new TypeError('Video chunk metadata decoder configuration codec string for AV1 must be a valid AV1 codec string as specified in Section "Codecs Parameter String" of https://aomediacodec.github.io/av1-isobmff/.')},Ju=["mp4a","mp3","opus","vorbis","flac","ulaw","alaw","pcm"],kc=r=>{if(!r)throw new TypeError("Audio chunk metadata must be provided.");if(typeof r!="object")throw new TypeError("Audio chunk metadata must be an object.");if(!r.decoderConfig)throw new TypeError("Audio chunk metadata must include a decoder configuration.");if(typeof r.decoderConfig!="object")throw new TypeError("Audio chunk metadata decoder configuration must be an object.");if(typeof r.decoderConfig.codec!="string")throw new TypeError("Audio chunk metadata decoder configuration must specify a codec string.");if(!Ju.some(e=>r.decoderConfig.codec.startsWith(e)))throw new TypeError("Audio chunk metadata decoder configuration codec string must be a valid audio codec string as specified in the WebCodecs Codec Registry.");if(!Number.isInteger(r.decoderConfig.sampleRate)||r.decoderConfig.sampleRate<=0)throw new TypeError("Audio chunk metadata decoder configuration must specify a valid sampleRate (positive integer).");if(!Number.isInteger(r.decoderConfig.numberOfChannels)||r.decoderConfig.numberOfChannels<=0)throw new TypeError("Audio chunk metadata decoder configuration must specify a valid numberOfChannels (positive integer).");if(r.decoderConfig.description!==void 0&&!ja(r.decoderConfig.description))throw new TypeError("Audio chunk metadata decoder configuration description, when defined, must be an ArrayBuffer or an ArrayBuffer view.");if(r.decoderConfig.codec.startsWith("mp4a")&&r.decoderConfig.codec!=="mp4a.69"&&r.decoderConfig.codec!=="mp4a.6B"&&r.decoderConfig.codec!=="mp4a.6b"){if(!["mp4a.40.2","mp4a.40.02","mp4a.40.5","mp4a.40.05","mp4a.40.29","mp4a.67"].includes(r.decoderConfig.codec))throw new TypeError("Audio chunk metadata decoder configuration codec string for AAC must be a valid AAC codec string as specified in https://www.w3.org/TR/webcodecs-aac-codec-registration/.");if(!r.decoderConfig.description)throw new TypeError("Audio chunk metadata decoder configuration for AAC must include a description, which is expected to be an AudioSpecificConfig as specified in ISO 14496-3.")}else if(r.decoderConfig.codec.startsWith("mp3")||r.decoderConfig.codec.startsWith("mp4a")){if(r.decoderConfig.codec!=="mp3"&&r.decoderConfig.codec!=="mp4a.69"&&r.decoderConfig.codec!=="mp4a.6B"&&r.decoderConfig.codec!=="mp4a.6b")throw new TypeError('Audio chunk metadata decoder configuration codec string for MP3 must be "mp3", "mp4a.69" or "mp4a.6B".')}else if(r.decoderConfig.codec.startsWith("opus")){if(r.decoderConfig.codec!=="opus")throw new TypeError('Audio chunk metadata decoder configuration codec string for Opus must be "opus".');if(r.decoderConfig.description&&r.decoderConfig.description.byteLength<18)throw new TypeError("Audio chunk metadata decoder configuration description, when specified, is expected to be an Identification Header as specified in Section 5.1 of RFC 7845.")}else if(r.decoderConfig.codec.startsWith("vorbis")){if(r.decoderConfig.codec!=="vorbis")throw new TypeError('Audio chunk metadata decoder configuration codec string for Vorbis must be "vorbis".');if(!r.decoderConfig.description)throw new TypeError("Audio chunk metadata decoder configuration for Vorbis must include a description, which is expected to adhere to the format described in https://www.w3.org/TR/webcodecs-vorbis-codec-registration/.")}else if(r.decoderConfig.codec.startsWith("flac")){if(r.decoderConfig.codec!=="flac")throw new TypeError('Audio chunk metadata decoder configuration codec string for FLAC must be "flac".');if(!r.decoderConfig.description||r.decoderConfig.description.byteLength<42)throw new TypeError("Audio chunk metadata decoder configuration for FLAC must include a description, which is expected to adhere to the format described in https://www.w3.org/TR/webcodecs-flac-codec-registration/.")}else if((r.decoderConfig.codec.startsWith("pcm")||r.decoderConfig.codec.startsWith("ulaw")||r.decoderConfig.codec.startsWith("alaw"))&&!Dt.includes(r.decoderConfig.codec))throw new TypeError(`Audio chunk metadata decoder configuration codec string for PCM must be one of the supported PCM codecs (${Dt.join(", ")}).`)},xc=r=>{if(!r)throw new TypeError("Subtitle metadata must be provided.");if(typeof r!="object")throw new TypeError("Subtitle metadata must be an object.");if(!r.config)throw new TypeError("Subtitle metadata must include a config object.");if(typeof r.config!="object")throw new TypeError("Subtitle metadata config must be an object.");if(typeof r.config.description!="string")throw new TypeError("Subtitle metadata config description must be a string.")};class _c{constructor(e){this.mutex=new $i,this.firstMediaStreamTimestamp=null,this.trackTimestampInfo=new WeakMap,this.output=e}onTrackClose(e){}validateAndNormalizeTimestamp(e,t,i){t+=e.source._timestampOffset;let a=this.trackTimestampInfo.get(e);if(!a){if(!i)throw new Error("First packet must be a key packet.");a={maxTimestamp:t,maxTimestampBeforeLastKeyPacket:t},this.trackTimestampInfo.set(e,a)}if(t<0)throw new Error(`Timestamps must be non-negative (got ${t}s).`);if(i&&(a.maxTimestampBeforeLastKeyPacket=a.maxTimestamp),t<a.maxTimestampBeforeLastKeyPacket)throw new Error(`Timestamps cannot be smaller than the largest timestamp of the previous GOP (a GOP begins with a key packet and ends right before the next key packet). Got ${t}s, but largest timestamp is ${a.maxTimestampBeforeLastKeyPacket}s.`);return a.maxTimestamp=Math.max(a.maxTimestamp,t),t}}var ii;(function(r){r[r.IDR=5]="IDR",r[r.SEI=6]="SEI",r[r.SPS=7]="SPS",r[r.PPS=8]="PPS",r[r.SPS_EXT=13]="SPS_EXT"})(ii||(ii={}));var qt;(function(r){r[r.RASL_N=8]="RASL_N",r[r.RASL_R=9]="RASL_R",r[r.BLA_W_LP=16]="BLA_W_LP",r[r.RSV_IRAP_VCL23=23]="RSV_IRAP_VCL23",r[r.VPS_NUT=32]="VPS_NUT",r[r.SPS_NUT=33]="SPS_NUT",r[r.PPS_NUT=34]="PPS_NUT",r[r.PREFIX_SEI_NUT=39]="PREFIX_SEI_NUT",r[r.SUFFIX_SEI_NUT=40]="SUFFIX_SEI_NUT"})(qt||(qt={}));const ha=r=>{const e=[];let t=0;for(;t<r.length;){let i=-1,a=0;for(let s=t;s<r.length-3;s++){if(r[s]===0&&r[s+1]===0&&r[s+2]===1){i=s,a=3;break}if(s<r.length-4&&r[s]===0&&r[s+1]===0&&r[s+2]===0&&r[s+3]===1){i=s,a=4;break}}if(i===-1)break;if(t>0&&i>t){const s=r.subarray(t,i);s.length>0&&e.push(s)}t=i+a}if(t<r.length){const i=r.subarray(t);i.length>0&&e.push(i)}return e},Tc=(r,e)=>{const t=[];let i=0;const a=new DataView(r.buffer,r.byteOffset,r.byteLength);for(;i+e<=r.length;){let s;e===1?s=a.getUint8(i):e===2?s=a.getUint16(i,!1):e===3?s=Ka(a,i,!1):e===4?s=a.getUint32(i,!1):(pr(e),I(!1)),i+=e;const n=r.subarray(i,i+s);t.push(n),i+=s}return t},Ra=r=>{const e=[],t=r.length;for(let i=0;i<t;i++)i+2<t&&r[i]===0&&r[i+1]===0&&r[i+2]===3?(e.push(0,0),i+=2):e.push(r[i]);return new Uint8Array(e)},on=new Uint8Array([0,0,0,1]),ef=r=>{const e=r.reduce((a,s)=>a+on.byteLength+s.byteLength,0),t=new Uint8Array(e);let i=0;for(const a of r)t.set(on,i),i+=on.byteLength,t.set(a,i),i+=a.byteLength;return t},Sc=(r,e)=>{const t=r.reduce((s,n)=>s+e+n.byteLength,0),i=new Uint8Array(t);let a=0;for(const s of r){const n=new DataView(i.buffer,i.byteOffset,i.byteLength);switch(e){case 1:n.setUint8(a,s.byteLength);break;case 2:n.setUint16(a,s.byteLength,!1);break;case 3:us(n,a,s.byteLength,!1);break;case 4:n.setUint32(a,s.byteLength,!1);break}a+=e,i.set(s,a),a+=s.byteLength}return i},Cc=(r,e)=>{if(e.description){const a=(Vt(e.description)[4]&3)+1;return Tc(r,a)}else return ha(r)},tf=(r,e)=>{if(e.description){const a=(Vt(e.description)[4]&3)+1;return Sc(r,a)}else return ef(r)},Ei=r=>r[0]&31,Pc=r=>{try{const e=ha(r),t=e.filter(c=>Ei(c)===ii.SPS),i=e.filter(c=>Ei(c)===ii.PPS),a=e.filter(c=>Ei(c)===ii.SPS_EXT);if(t.length===0||i.length===0)return null;const s=t[0],n=Ec(s);I(n!==null);const o=n.profileIdc===100||n.profileIdc===110||n.profileIdc===122||n.profileIdc===144;return{configurationVersion:1,avcProfileIndication:n.profileIdc,profileCompatibility:n.constraintFlags,avcLevelIndication:n.levelIdc,lengthSizeMinusOne:3,sequenceParameterSets:t,pictureParameterSets:i,chromaFormat:o?n.chromaFormatIdc:null,bitDepthLumaMinus8:o?n.bitDepthLumaMinus8:null,bitDepthChromaMinus8:o?n.bitDepthChromaMinus8:null,sequenceParameterSetExt:o?a:null}}catch(e){return console.error("Error building AVC Decoder Configuration Record:",e),null}},rf=r=>{const e=[];e.push(r.configurationVersion),e.push(r.avcProfileIndication),e.push(r.profileCompatibility),e.push(r.avcLevelIndication),e.push(252|r.lengthSizeMinusOne&3),e.push(224|r.sequenceParameterSets.length&31);for(const t of r.sequenceParameterSets){const i=t.byteLength;e.push(i>>8),e.push(i&255);for(let a=0;a<i;a++)e.push(t[a])}e.push(r.pictureParameterSets.length);for(const t of r.pictureParameterSets){const i=t.byteLength;e.push(i>>8),e.push(i&255);for(let a=0;a<i;a++)e.push(t[a])}if(r.avcProfileIndication===100||r.avcProfileIndication===110||r.avcProfileIndication===122||r.avcProfileIndication===144){I(r.chromaFormat!==null),I(r.bitDepthLumaMinus8!==null),I(r.bitDepthChromaMinus8!==null),I(r.sequenceParameterSetExt!==null),e.push(252|r.chromaFormat&3),e.push(248|r.bitDepthLumaMinus8&7),e.push(248|r.bitDepthChromaMinus8&7),e.push(r.sequenceParameterSetExt.length);for(const t of r.sequenceParameterSetExt){const i=t.byteLength;e.push(i>>8),e.push(i&255);for(let a=0;a<i;a++)e.push(t[a])}}return new Uint8Array(e)},af=r=>{try{const e=kt(r);let t=0;const i=e.getUint8(t++),a=e.getUint8(t++),s=e.getUint8(t++),n=e.getUint8(t++),o=e.getUint8(t++)&3,c=e.getUint8(t++)&31,l=[];for(let h=0;h<c;h++){const g=e.getUint16(t,!1);t+=2,l.push(r.subarray(t,t+g)),t+=g}const d=e.getUint8(t++),u=[];for(let h=0;h<d;h++){const g=e.getUint16(t,!1);t+=2,u.push(r.subarray(t,t+g)),t+=g}const f={configurationVersion:i,avcProfileIndication:a,profileCompatibility:s,avcLevelIndication:n,lengthSizeMinusOne:o,sequenceParameterSets:l,pictureParameterSets:u,chromaFormat:null,bitDepthLumaMinus8:null,bitDepthChromaMinus8:null,sequenceParameterSetExt:null};if((a===100||a===110||a===122||a===144)&&t+4<=r.length){const h=e.getUint8(t++)&3,g=e.getUint8(t++)&7,m=e.getUint8(t++)&7,v=e.getUint8(t++);f.chromaFormat=h,f.bitDepthLumaMinus8=g,f.bitDepthChromaMinus8=m;const p=[];for(let b=0;b<v;b++){const y=e.getUint16(t,!1);t+=2,p.push(r.subarray(t,t+y)),t+=y}f.sequenceParameterSetExt=p}return f}catch(e){return console.error("Error deserializing AVC Decoder Configuration Record:",e),null}},Ec=r=>{try{const e=new bt(Ra(r));if(e.skipBits(1),e.skipBits(2),e.readBits(5)!==7)return null;const i=e.readAlignedByte(),a=e.readAlignedByte(),s=e.readAlignedByte();xe(e);let n=null,o=null,c=null;if((i===100||i===110||i===122||i===244||i===44||i===83||i===86||i===118||i===128)&&(n=xe(e),n===3&&e.skipBits(1),o=xe(e),c=xe(e),e.skipBits(1),e.readBits(1))){for(let f=0;f<(n!==3?8:12);f++)if(e.readBits(1)){const g=f<6?16:64;let m=8,v=8;for(let p=0;p<g;p++){if(v!==0){const b=zr(e);v=(m+b+256)%256}m=v===0?m:v}}}xe(e);const l=xe(e);if(l===0)xe(e);else if(l===1){e.skipBits(1),zr(e),zr(e);const u=xe(e);for(let f=0;f<u;f++)zr(e)}xe(e),e.skipBits(1),xe(e),xe(e);const d=e.readBits(1);return{profileIdc:i,constraintFlags:a,levelIdc:s,frameMbsOnlyFlag:d,chromaFormatIdc:n,bitDepthLumaMinus8:o,bitDepthChromaMinus8:c}}catch(e){return console.error("Error parsing AVC SPS:",e),null}},Ic=(r,e)=>{if(e.description){const a=(Vt(e.description)[21]&3)+1;return Tc(r,a)}else return ha(r)},Ur=r=>r[0]>>1&63,Ac=r=>{try{const e=ha(r),t=e.filter($=>Ur($)===qt.VPS_NUT),i=e.filter($=>Ur($)===qt.SPS_NUT),a=e.filter($=>Ur($)===qt.PPS_NUT),s=e.filter($=>Ur($)===qt.PREFIX_SEI_NUT||Ur($)===qt.SUFFIX_SEI_NUT);if(i.length===0||a.length===0)return null;const n=i[0],o=new bt(Ra(n));o.skipBits(16),o.readBits(4);const c=o.readBits(3),l=o.readBits(1),{general_profile_space:d,general_tier_flag:u,general_profile_idc:f,general_profile_compatibility_flags:h,general_constraint_indicator_flags:g,general_level_idc:m}=nf(o,c);xe(o);const v=xe(o);v===3&&o.skipBits(1),xe(o),xe(o),o.readBits(1)&&(xe(o),xe(o),xe(o),xe(o));const p=xe(o),b=xe(o);xe(o);const _=o.readBits(1)?0:c;for(let $=_;$<=c;$++)xe(o),xe(o),xe(o);xe(o),xe(o),xe(o),xe(o),xe(o),xe(o),o.readBits(1)&&o.readBits(1)&&sf(o),o.skipBits(1),o.skipBits(1),o.readBits(1)&&(o.skipBits(4),o.skipBits(4),xe(o),xe(o),o.skipBits(1));const S=xe(o);if(of(o,S),o.readBits(1)){const $=xe(o);for(let K=0;K<$;K++)xe(o),o.skipBits(1)}o.skipBits(1),o.skipBits(1);let A=0;o.readBits(1)&&(A=lf(o,c));let z=0;if(a.length>0){const $=a[0],K=new bt(Ra($));K.skipBits(16),xe(K),xe(K),K.skipBits(1),K.skipBits(1),K.skipBits(3),K.skipBits(1),K.skipBits(1),xe(K),xe(K),zr(K),K.skipBits(1),K.skipBits(1),K.readBits(1)&&xe(K),zr(K),zr(K),K.skipBits(1),K.skipBits(1),K.skipBits(1),K.skipBits(1);const P=K.readBits(1),O=K.readBits(1);!P&&!O?z=0:P&&!O?z=2:!P&&O?z=3:z=0}const D=[...t.length?[{arrayCompleteness:1,nalUnitType:qt.VPS_NUT,nalUnits:t}]:[],...i.length?[{arrayCompleteness:1,nalUnitType:qt.SPS_NUT,nalUnits:i}]:[],...a.length?[{arrayCompleteness:1,nalUnitType:qt.PPS_NUT,nalUnits:a}]:[],...s.length?[{arrayCompleteness:1,nalUnitType:Ur(s[0]),nalUnits:s}]:[]];return{configurationVersion:1,generalProfileSpace:d,generalTierFlag:u,generalProfileIdc:f,generalProfileCompatibilityFlags:h,generalConstraintIndicatorFlags:g,generalLevelIdc:m,minSpatialSegmentationIdc:A,parallelismType:z,chromaFormatIdc:v,bitDepthLumaMinus8:p,bitDepthChromaMinus8:b,avgFrameRate:0,constantFrameRate:0,numTemporalLayers:c+1,temporalIdNested:l,lengthSizeMinusOne:3,arrays:D}}catch(e){return console.error("Error building HEVC Decoder Configuration Record:",e),null}},nf=(r,e)=>{const t=r.readBits(2),i=r.readBits(1),a=r.readBits(5);let s=0;for(let d=0;d<32;d++)s=s<<1|r.readBits(1);const n=new Uint8Array(6);for(let d=0;d<6;d++)n[d]=r.readBits(8);const o=r.readBits(8),c=[],l=[];for(let d=0;d<e;d++)c.push(r.readBits(1)),l.push(r.readBits(1));if(e>0)for(let d=e;d<8;d++)r.skipBits(2);for(let d=0;d<e;d++)c[d]&&r.skipBits(88),l[d]&&r.skipBits(8);return{general_profile_space:t,general_tier_flag:i,general_profile_idc:a,general_profile_compatibility_flags:s,general_constraint_indicator_flags:n,general_level_idc:o}},sf=r=>{for(let e=0;e<4;e++)for(let t=0;t<(e===3?2:6);t++)if(!r.readBits(1))xe(r);else{const a=Math.min(64,1<<4+(e<<1));e>1&&zr(r);for(let s=0;s<a;s++)zr(r)}},of=(r,e)=>{const t=[];for(let i=0;i<e;i++)t[i]=cf(r,i,e,t)},cf=(r,e,t,i)=>{let a=0,s=0,n=0;if(e!==0&&(s=r.readBits(1)),s){if(e===t){const c=xe(r);n=e-(c+1)}else n=e-1;r.readBits(1),xe(r);const o=i[n]??0;for(let c=0;c<=o;c++)r.readBits(1)||r.readBits(1);a=i[n]}else{const o=xe(r),c=xe(r);for(let l=0;l<o;l++)xe(r),r.readBits(1);for(let l=0;l<c;l++)xe(r),r.readBits(1);a=o+c}return a},lf=(r,e)=>{if(r.readBits(1)&&r.readBits(8)===255&&(r.readBits(16),r.readBits(16)),r.readBits(1)&&r.readBits(1),r.readBits(1)&&(r.readBits(3),r.readBits(1),r.readBits(1)&&(r.readBits(8),r.readBits(8),r.readBits(8))),r.readBits(1)&&(xe(r),xe(r)),r.readBits(1),r.readBits(1),r.readBits(1),r.readBits(1)&&(xe(r),xe(r),xe(r),xe(r)),r.readBits(1)&&(r.readBits(32),r.readBits(32),r.readBits(1)&&xe(r),r.readBits(1)&&df(r,!0,e)),r.readBits(1)){r.readBits(1),r.readBits(1),r.readBits(1);const t=xe(r);return xe(r),xe(r),xe(r),xe(r),t}return 0},df=(r,e,t)=>{let i=!1,a=!1,s=!1;i=r.readBits(1)===1,a=r.readBits(1)===1,(i||a)&&(s=r.readBits(1)===1,s&&(r.readBits(8),r.readBits(5),r.readBits(1),r.readBits(5)),r.readBits(4),r.readBits(4),s&&r.readBits(4),r.readBits(5),r.readBits(5),r.readBits(5));for(let n=0;n<=t;n++){const o=r.readBits(1)===1;let c=!0;o||(c=r.readBits(1)===1);let l=!1;c?xe(r):l=r.readBits(1)===1;let d=1;l||(d=xe(r)+1),i&&lo(r,d,s),a&&lo(r,d,s)}},lo=(r,e,t)=>{for(let i=0;i<e;i++)xe(r),xe(r),t&&(xe(r),xe(r)),r.readBits(1)},uf=r=>{const e=[];e.push(r.configurationVersion),e.push((r.generalProfileSpace&3)<<6|(r.generalTierFlag&1)<<5|r.generalProfileIdc&31),e.push(r.generalProfileCompatibilityFlags>>>24&255),e.push(r.generalProfileCompatibilityFlags>>>16&255),e.push(r.generalProfileCompatibilityFlags>>>8&255),e.push(r.generalProfileCompatibilityFlags&255),e.push(...r.generalConstraintIndicatorFlags),e.push(r.generalLevelIdc&255),e.push(240|r.minSpatialSegmentationIdc>>8&15),e.push(r.minSpatialSegmentationIdc&255),e.push(252|r.parallelismType&3),e.push(252|r.chromaFormatIdc&3),e.push(248|r.bitDepthLumaMinus8&7),e.push(248|r.bitDepthChromaMinus8&7),e.push(r.avgFrameRate>>8&255),e.push(r.avgFrameRate&255),e.push((r.constantFrameRate&3)<<6|(r.numTemporalLayers&7)<<3|(r.temporalIdNested&1)<<2|r.lengthSizeMinusOne&3),e.push(r.arrays.length&255);for(const t of r.arrays){e.push((t.arrayCompleteness&1)<<7|0|t.nalUnitType&63),e.push(t.nalUnits.length>>8&255),e.push(t.nalUnits.length&255);for(const i of t.nalUnits){e.push(i.length>>8&255),e.push(i.length&255);for(let a=0;a<i.length;a++)e.push(i[a])}}return new Uint8Array(e)},Fc=r=>{const e=new bt(r);if(e.readBits(2)!==2)return null;const i=e.readBits(1),s=(e.readBits(1)<<1)+i;if(s===3&&e.skipBits(1),e.readBits(1)===1||e.readBits(1)!==0||(e.skipBits(2),e.readBits(24)!==4817730))return null;let l=8;s>=2&&(l=e.readBits(1)?12:10);const d=e.readBits(3);let u=0,f=0;if(d!==7)if(f=e.readBits(1),s===1||s===3){const z=e.readBits(1),D=e.readBits(1);u=!z&&!D?3:z&&!D?2:1,e.skipBits(1)}else u=1;else u=3,f=1;const h=e.readBits(16),g=e.readBits(16),m=h+1,v=g+1,p=m*v;let b=Ct(Wr).level;for(const A of Wr)if(p<=A.maxPictureSize){b=A.level;break}return{profile:s,level:b,bitDepth:l,chromaSubsampling:u,videoFullRangeFlag:f,colourPrimaries:d===2?1:d===1?6:2,transferCharacteristics:d===2?1:d===1?6:2,matrixCoefficients:d===7?0:d===2?1:d===1?6:2}},zc=function*(r){const e=new bt(r),t=()=>{let i=0;for(let a=0;a<8;a++){const s=e.readAlignedByte();if(i|=(s&127)<<a*7,!(s&128))break;if(a===7&&s&128)return null}return i>=2**32-1?null:i};for(;e.getBitsLeft()>=8;){e.skipBits(1);const i=e.readBits(4),a=e.readBits(1),s=e.readBits(1);e.skipBits(1),a&&e.skipBits(8);let n;if(s){const o=t();if(o===null)return;n=o}else n=Math.floor(e.getBitsLeft()/8);I(e.pos%8===0),yield{type:i,data:r.subarray(e.pos/8,e.pos/8+n)},e.skipBits(n*8)}},Bc=r=>{for(const{type:e,data:t}of zc(r)){if(e!==1)continue;const i=new bt(t),a=i.readBits(3);i.readBits(1);const s=i.readBits(1);let n=0,o=0,c=0;if(s)n=i.readBits(5);else{if(i.readBits(1)&&(i.skipBits(32),i.skipBits(32),i.readBits(1)))return null;const S=i.readBits(1);S&&(c=i.readBits(5),i.skipBits(32),i.skipBits(5),i.skipBits(5));const A=i.readBits(5);for(let z=0;z<=A;z++){i.skipBits(12);const D=i.readBits(5);if(z===0&&(n=D),D>7){const $=i.readBits(1);z===0&&(o=$)}if(S&&i.readBits(1)){const K=c+1;i.skipBits(K),i.skipBits(K),i.skipBits(1)}i.readBits(1)&&i.skipBits(4)}}const l=i.readBits(4),d=i.readBits(4),u=l+1;i.skipBits(u);const f=d+1;i.skipBits(f);let h=0;if(s?h=0:h=i.readBits(1),h&&(i.skipBits(4),i.skipBits(3)),i.skipBits(1),i.skipBits(1),i.skipBits(1),!s){i.skipBits(1),i.skipBits(1),i.skipBits(1),i.skipBits(1);const _=i.readBits(1);_&&(i.skipBits(1),i.skipBits(1));const S=i.readBits(1);let A=0;S?A=2:A=i.readBits(1),A>0&&(i.readBits(1)||i.skipBits(1)),_&&i.skipBits(3)}i.skipBits(1),i.skipBits(1),i.skipBits(1);const g=i.readBits(1);let m=8;a===2&&g?m=i.readBits(1)?12:10:a<=2&&(m=g?10:8);let v=0;a!==1&&(v=i.readBits(1));let p=1,b=1,y=0;return v||(a===0?(p=1,b=1):a===1?(p=0,b=0):m===12&&(p=i.readBits(1),p&&(b=i.readBits(1))),p&&b&&(y=i.readBits(2))),{profile:a,level:n,tier:o,bitDepth:m,monochrome:v,chromaSubsamplingX:p,chromaSubsamplingY:b,chromaSamplePosition:y}}return null},gs=r=>{const e=kt(r),t=e.getUint8(9),i=e.getUint16(10,!0),a=e.getUint32(12,!0),s=e.getInt16(16,!0),n=e.getUint8(18);let o=null;return n&&(o=r.subarray(19,21+t)),{outputChannelCount:t,preSkip:i,inputSampleRate:a,outputGain:s,channelMappingFamily:n,channelMappingTable:o}},ff=[480,960,1920,2880,480,960,1920,2880,480,960,1920,2880,480,960,480,960,120,240,480,960,120,240,480,960,120,240,480,960,120,240,480,960],hf=r=>{const e=r[0]>>3;return{durationInSamples:ff[e]}},mf=r=>{if(r.length<7)throw new Error("Setup header is too short.");if(r[0]!==5)throw new Error("Wrong packet type in Setup header.");if(String.fromCharCode(...r.slice(1,7))!=="vorbis")throw new Error("Invalid packet signature in Setup header.");const t=r.length,i=new Uint8Array(t);for(let u=0;u<t;u++)i[u]=r[t-1-u];const a=new bt(i);let s=0;for(;a.getBitsLeft()>97;)if(a.readBits(1)===1){s=a.pos;break}if(s===0)throw new Error("Invalid Setup header: framing bit not found.");let n=0,o=!1,c=0;for(;a.getBitsLeft()>=97;){const u=a.pos,f=a.readBits(8),h=a.readBits(16),g=a.readBits(16);if(f>63||h!==0||g!==0){a.pos=u;break}if(a.skipBits(1),n++,n>64)break;a.clone().readBits(6)+1===n&&(o=!0,c=n)}if(!o)throw new Error("Invalid Setup header: mode header not found.");if(c>63)throw new Error(`Unsupported mode count: ${c}.`);const l=c;a.pos=0,a.skipBits(s);const d=Array(l).fill(0);for(let u=l-1;u>=0;u--)a.skipBits(40),d[u]=a.readBits(1);return{modeBlockflags:d}},Mc=(r,e,t)=>{switch(r){case"avc":{const i=Cc(t,e);let a=i.some(s=>Ei(s)===ii.IDR);if(!a&&(!Dn()||Nu()>=144))for(const s of i){if(Ei(s)!==ii.SEI)continue;const o=Ra(s);let c=1;do{let l=0;for(;;){const f=o[c++];if(f===void 0||(l+=f,f<255))break}let d=0;for(;;){const f=o[c++];if(f===void 0||(d+=f,f<255))break}if(l===6){const f=new bt(o);f.pos=8*c;const h=xe(f),g=f.readBits(1);if(h===0&&g===1){a=!0;break}}c+=d}while(c<o.length-1)}return a?"key":"delta"}case"hevc":return Ic(t,e).some(s=>{const n=Ur(s);return qt.BLA_W_LP<=n&&n<=qt.RSV_IRAP_VCL23})?"key":"delta";case"vp8":return(t[0]&1)===0?"key":"delta";case"vp9":{const i=new bt(t);if(i.readBits(2)!==2)return null;const a=i.readBits(1);return(i.readBits(1)<<1)+a===3&&i.skipBits(1),i.readBits(1)?null:i.readBits(1)===0?"key":"delta"}case"av1":{let i=!1;for(const{type:a,data:s}of zc(t))if(a===1){const n=new bt(s);n.skipBits(4),i=!!n.readBits(1)}else if(a===3||a===6||a===7){if(i)return"key";const n=new bt(s);return n.readBits(1)?null:n.readBits(2)===0?"key":"delta"}return null}default:pr(r),I(!1)}};var Ii;(function(r){r[r.STREAMINFO=0]="STREAMINFO",r[r.VORBIS_COMMENT=4]="VORBIS_COMMENT",r[r.PICTURE=6]="PICTURE"})(Ii||(Ii={}));const On=(r,e)=>{const t=kt(r);let i=0;const a=t.getUint32(i,!0);i+=4;const s=or.decode(r.subarray(i,i+a));i+=a,a>0&&(e.raw??={},e.raw.vendor??=s);const n=t.getUint32(i,!0);i+=4;for(let o=0;o<n;o++){const c=t.getUint32(i,!0);i+=4;const l=or.decode(r.subarray(i,i+c));i+=c;const d=l.indexOf("=");if(d===-1)continue;const u=l.slice(0,d).toUpperCase(),f=l.slice(d+1);switch(e.raw??={},e.raw[u]??=f,u){case"TITLE":e.title??=f;break;case"DESCRIPTION":e.description??=f;break;case"ARTIST":e.artist??=f;break;case"ALBUM":e.album??=f;break;case"ALBUMARTIST":e.albumArtist??=f;break;case"COMMENT":e.comment??=f;break;case"LYRICS":e.lyrics??=f;break;case"TRACKNUMBER":{const h=f.split("/"),g=Number.parseInt(h[0],10),m=h[1]&&Number.parseInt(h[1],10);Number.isInteger(g)&&g>0&&(e.trackNumber??=g),m&&Number.isInteger(m)&&m>0&&(e.tracksTotal??=m)}break;case"TRACKTOTAL":{const h=Number.parseInt(f,10);Number.isInteger(h)&&h>0&&(e.tracksTotal??=h)}break;case"DISCNUMBER":{const h=f.split("/"),g=Number.parseInt(h[0],10),m=h[1]&&Number.parseInt(h[1],10);Number.isInteger(g)&&g>0&&(e.discNumber??=g),m&&Number.isInteger(m)&&m>0&&(e.discsTotal??=m)}break;case"DISCTOTAL":{const h=Number.parseInt(f,10);Number.isInteger(h)&&h>0&&(e.discsTotal??=h)}break;case"DATE":{const h=new Date(f);Number.isNaN(h.getTime())||(e.date??=h)}break;case"GENRE":e.genre??=f;break;case"METADATA_BLOCK_PICTURE":{const h=Uu(f),g=kt(h),m=g.getUint32(0,!1),v=g.getUint32(4,!1),p=String.fromCharCode(...h.subarray(8,8+v)),b=g.getUint32(8+v,!1),y=or.decode(h.subarray(12+v,12+v+b)),_=g.getUint32(v+b+28),S=h.subarray(v+b+32,v+b+32+_);e.images??=[],e.images.push({data:S,mimeType:p,kind:m===3?"coverFront":m===4?"coverBack":"unknown",name:void 0,description:y||void 0})}break}}};class si{constructor(e){this.input=e}}const Rc=[],Dc=[],Un=[],Vn=[];const lr=new Uint8Array(0);class mt{constructor(e,t,i,a,s=-1,n,o){if(this.data=e,this.type=t,this.timestamp=i,this.duration=a,this.sequenceNumber=s,e===lr&&n===void 0)throw new Error("Internal error: byteLength must be explicitly provided when constructing metadata-only packets.");if(n===void 0&&(n=e.byteLength),!(e instanceof Uint8Array))throw new TypeError("data must be a Uint8Array.");if(t!=="key"&&t!=="delta")throw new TypeError('type must be either "key" or "delta".');if(!Number.isFinite(i))throw new TypeError("timestamp must be a number.");if(!Number.isFinite(a)||a<0)throw new TypeError("duration must be a non-negative number.");if(!Number.isFinite(s))throw new TypeError("sequenceNumber must be a number.");if(!Number.isInteger(n)||n<0)throw new TypeError("byteLength must be a non-negative integer.");if(o!==void 0&&(typeof o!="object"||!o))throw new TypeError("sideData, when provided, must be an object.");if(o?.alpha!==void 0&&!(o.alpha instanceof Uint8Array))throw new TypeError("sideData.alpha, when provided, must be a Uint8Array.");if(o?.alphaByteLength!==void 0&&(!Number.isInteger(o.alphaByteLength)||o.alphaByteLength<0))throw new TypeError("sideData.alphaByteLength, when provided, must be a non-negative integer.");this.byteLength=n,this.sideData=o??{},this.sideData.alpha&&this.sideData.alphaByteLength===void 0&&(this.sideData.alphaByteLength=this.sideData.alpha.byteLength)}get isMetadataOnly(){return this.data===lr}get microsecondTimestamp(){return Math.trunc($r*this.timestamp)}get microsecondDuration(){return Math.trunc($r*this.duration)}toEncodedVideoChunk(){if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to a video chunk.");if(typeof EncodedVideoChunk>"u")throw new Error("Your browser does not support EncodedVideoChunk.");return new EncodedVideoChunk({data:this.data,type:this.type,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}alphaToEncodedVideoChunk(e=this.type){if(!this.sideData.alpha)throw new TypeError("This packet does not contain alpha side data.");if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to a video chunk.");if(typeof EncodedVideoChunk>"u")throw new Error("Your browser does not support EncodedVideoChunk.");return new EncodedVideoChunk({data:this.sideData.alpha,type:e,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}toEncodedAudioChunk(){if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to an audio chunk.");if(typeof EncodedAudioChunk>"u")throw new Error("Your browser does not support EncodedAudioChunk.");return new EncodedAudioChunk({data:this.data,type:this.type,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}static fromEncodedChunk(e,t){if(!(e instanceof EncodedVideoChunk||e instanceof EncodedAudioChunk))throw new TypeError("chunk must be an EncodedVideoChunk or EncodedAudioChunk.");const i=new Uint8Array(e.byteLength);return e.copyTo(i),new mt(i,e.type,e.timestamp/1e6,(e.duration??0)/1e6,void 0,void 0,t)}clone(e){if(e!==void 0&&(typeof e!="object"||e===null))throw new TypeError("options, when provided, must be an object.");if(e?.timestamp!==void 0&&!Number.isFinite(e.timestamp))throw new TypeError("options.timestamp, when provided, must be a number.");if(e?.duration!==void 0&&!Number.isFinite(e.duration))throw new TypeError("options.duration, when provided, must be a number.");return new mt(this.data,this.type,e?.timestamp??this.timestamp,e?.duration??this.duration,this.sequenceNumber,this.byteLength)}}const pf=r=>{let i=r,a=4096,s=0,n=12,o=0;for(i<0&&(i=-i,s=128),i+=33,i>8191&&(i=8191);(i&a)!==a&&n>=5;)a>>=1,n--;return o=i>>n-4&15,~(s|n-5<<4|o)&255},gf=r=>{let t=0,i=0,a=~r;a&128&&(a&=-129,t=-1),i=((a&240)>>4)+5;const s=(1<<i|(a&15)<<i-4|1<<i-5)-33;return t===0?s:-s},vf=r=>{let t=2048,i=0,a=11,s=0,n=r;for(n<0&&(n=-n,i=128),n>4095&&(n=4095);(n&t)!==t&&a>=5;)t>>=1,a--;return s=n>>(a===4?1:a-4)&15,(i|a-4<<4|s)^85},bf=r=>{let e=0,t=0,i=r^85;i&128&&(i&=-129,e=-1),t=((i&240)>>4)+4;let a=0;return t!==4?a=1<<t|(i&15)<<t-4|1<<t-5:a=i<<1|1,e===0?a:-a};hc();let uo=-1/0,fo=-1/0,ca=null;typeof FinalizationRegistry<"u"&&(ca=new FinalizationRegistry(r=>{const e=Date.now();r.type==="video"?(e-uo>=1e3&&(console.error("A VideoSample was garbage collected without first being closed. For proper resource management, make sure to call close() on all your VideoSamples as soon as you're done using them."),uo=e),typeof VideoFrame<"u"&&r.data instanceof VideoFrame&&r.data.close()):(e-fo>=1e3&&(console.error("An AudioSample was garbage collected without first being closed. For proper resource management, make sure to call close() on all your AudioSamples as soon as you're done using them."),fo=e),typeof AudioData<"u"&&r.data instanceof AudioData&&r.data.close())}));const Nc=["I420","I420P10","I420P12","I420A","I420AP10","I420AP12","I422","I422P10","I422P12","I422A","I422AP10","I422AP12","I444","I444P10","I444P12","I444A","I444AP10","I444AP12","NV12","RGBA","RGBX","BGRA","BGRX"],wf=new Set(Nc);class $t{get displayWidth(){return this.rotation%180===0?this.codedWidth:this.codedHeight}get displayHeight(){return this.rotation%180===0?this.codedHeight:this.codedWidth}get microsecondTimestamp(){return Math.trunc($r*this.timestamp)}get microsecondDuration(){return Math.trunc($r*this.duration)}get hasAlpha(){return this.format&&this.format.includes("A")}constructor(e,t){if(this._closed=!1,e instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&e instanceof SharedArrayBuffer||ArrayBuffer.isView(e)){if(!t||typeof t!="object")throw new TypeError("init must be an object.");if(t.format===void 0||!wf.has(t.format))throw new TypeError("init.format must be one of: "+Nc.join(", "));if(!Number.isInteger(t.codedWidth)||t.codedWidth<=0)throw new TypeError("init.codedWidth must be a positive integer.");if(!Number.isInteger(t.codedHeight)||t.codedHeight<=0)throw new TypeError("init.codedHeight must be a positive integer.");if(t.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(!Number.isFinite(t.timestamp))throw new TypeError("init.timestamp must be a number.");if(t.duration!==void 0&&(!Number.isFinite(t.duration)||t.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");this._data=Vt(e).slice(),this._layout=t.layout??yf(t.format,t.codedWidth,t.codedHeight),this.format=t.format,this.codedWidth=t.codedWidth,this.codedHeight=t.codedHeight,this.rotation=t.rotation??0,this.timestamp=t.timestamp,this.duration=t.duration??0,this.colorSpace=new cn(t.colorSpace)}else if(typeof VideoFrame<"u"&&e instanceof VideoFrame){if(t?.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(t?.timestamp!==void 0&&!Number.isFinite(t?.timestamp))throw new TypeError("init.timestamp, when provided, must be a number.");if(t?.duration!==void 0&&(!Number.isFinite(t.duration)||t.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");this._data=e,this._layout=null,this.format=e.format,this.codedWidth=e.displayWidth,this.codedHeight=e.displayHeight,this.rotation=t?.rotation??0,this.timestamp=t?.timestamp??e.timestamp/1e6,this.duration=t?.duration??(e.duration??0)/1e6,this.colorSpace=new cn(e.colorSpace)}else if(typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement||typeof SVGImageElement<"u"&&e instanceof SVGImageElement||typeof ImageBitmap<"u"&&e instanceof ImageBitmap||typeof HTMLVideoElement<"u"&&e instanceof HTMLVideoElement||typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&e instanceof OffscreenCanvas){if(!t||typeof t!="object")throw new TypeError("init must be an object.");if(t.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(!Number.isFinite(t.timestamp))throw new TypeError("init.timestamp must be a number.");if(t.duration!==void 0&&(!Number.isFinite(t.duration)||t.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");if(typeof VideoFrame<"u")return new $t(new VideoFrame(e,{timestamp:Math.trunc(t.timestamp*$r),duration:Math.trunc((t.duration??0)*$r)||void 0}),t);let i=0,a=0;if("naturalWidth"in e?(i=e.naturalWidth,a=e.naturalHeight):"videoWidth"in e?(i=e.videoWidth,a=e.videoHeight):"width"in e&&(i=Number(e.width),a=Number(e.height)),!i||!a)throw new TypeError("Could not determine dimensions.");const s=new OffscreenCanvas(i,a),n=s.getContext("2d",{alpha:Ri(),willReadFrequently:!0});I(n),n.drawImage(e,0,0),this._data=s,this._layout=null,this.format="RGBX",this.codedWidth=i,this.codedHeight=a,this.rotation=t.rotation??0,this.timestamp=t.timestamp,this.duration=t.duration??0,this.colorSpace=new cn({matrix:"rgb",primaries:"bt709",transfer:"iec61966-2-1",fullRange:!0})}else throw new TypeError("Invalid data type: Must be a BufferSource or CanvasImageSource.");ca?.register(this,{type:"video",data:this._data},this)}clone(){if(this._closed)throw new Error("VideoSample is closed.");return I(this._data!==null),Qr(this._data)?new $t(this._data.clone(),{timestamp:this.timestamp,duration:this.duration,rotation:this.rotation}):this._data instanceof Uint8Array?(I(this._layout),new $t(this._data,{format:this.format,layout:this._layout,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.timestamp,duration:this.duration,colorSpace:this.colorSpace,rotation:this.rotation})):new $t(this._data,{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.timestamp,duration:this.duration,colorSpace:this.colorSpace,rotation:this.rotation})}close(){this._closed||(ca?.unregister(this),Qr(this._data)?this._data.close():this._data=null,this._closed=!0)}allocationSize(e={}){if(ho(e),this._closed)throw new Error("VideoSample is closed.");if(this.format===null)throw new Error("Cannot get allocation size when format is null. Sorry!");if(I(this._data!==null),!Qr(this._data)&&(e.colorSpace||e.format&&e.format!==this.format||e.layout||e.rect)){const t=this.toVideoFrame(),i=t.allocationSize(e);return t.close(),i}return Qr(this._data)?this._data.allocationSize(e):this._data instanceof Uint8Array?this._data.byteLength:this.codedWidth*this.codedHeight*4}async copyTo(e,t={}){if(!ja(e))throw new TypeError("destination must be an ArrayBuffer or an ArrayBuffer view.");if(ho(t),this._closed)throw new Error("VideoSample is closed.");if(this.format===null)throw new Error("Cannot copy video sample data when format is null. Sorry!");if(I(this._data!==null),!Qr(this._data)&&(t.colorSpace||t.format&&t.format!==this.format||t.layout||t.rect)){const i=this.toVideoFrame(),a=await i.copyTo(e,t);return i.close(),a}if(Qr(this._data))return this._data.copyTo(e,t);if(this._data instanceof Uint8Array)return I(this._layout),Vt(e).set(this._data),this._layout;{const a=this._data.getContext("2d");I(a);const s=a.getImageData(0,0,this.codedWidth,this.codedHeight);return Vt(e).set(s.data),[{offset:0,stride:4*this.codedWidth}]}}toVideoFrame(){if(this._closed)throw new Error("VideoSample is closed.");return I(this._data!==null),Qr(this._data)?new VideoFrame(this._data,{timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0}):this._data instanceof Uint8Array?new VideoFrame(this._data,{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0,colorSpace:this.colorSpace}):new VideoFrame(this._data,{timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0})}draw(e,t,i,a,s,n,o,c,l){let d=0,u=0,f=this.displayWidth,h=this.displayHeight,g=0,m=0,v=this.displayWidth,p=this.displayHeight;if(n!==void 0?(d=t,u=i,f=a,h=s,g=n,m=o,c!==void 0?(v=c,p=l):(v=f,p=h)):(g=t,m=i,a!==void 0&&(v=a,p=s)),!(typeof CanvasRenderingContext2D<"u"&&e instanceof CanvasRenderingContext2D||typeof OffscreenCanvasRenderingContext2D<"u"&&e instanceof OffscreenCanvasRenderingContext2D))throw new TypeError("context must be a CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D.");if(!Number.isFinite(d))throw new TypeError("sx must be a number.");if(!Number.isFinite(u))throw new TypeError("sy must be a number.");if(!Number.isFinite(f)||f<0)throw new TypeError("sWidth must be a non-negative number.");if(!Number.isFinite(h)||h<0)throw new TypeError("sHeight must be a non-negative number.");if(!Number.isFinite(g))throw new TypeError("dx must be a number.");if(!Number.isFinite(m))throw new TypeError("dy must be a number.");if(!Number.isFinite(v)||v<0)throw new TypeError("dWidth must be a non-negative number.");if(!Number.isFinite(p)||p<0)throw new TypeError("dHeight must be a non-negative number.");if(this._closed)throw new Error("VideoSample is closed.");({sx:d,sy:u,sWidth:f,sHeight:h}=this._rotateSourceRegion(d,u,f,h,this.rotation));const b=this.toCanvasImageSource();e.save();const y=g+v/2,_=m+p/2;e.translate(y,_),e.rotate(this.rotation*Math.PI/180);const S=this.rotation%180===0?1:v/p;e.scale(1/S,S),e.drawImage(b,d,u,f,h,-v/2,-p/2,v,p),e.restore()}drawWithFit(e,t){if(!(typeof CanvasRenderingContext2D<"u"&&e instanceof CanvasRenderingContext2D||typeof OffscreenCanvasRenderingContext2D<"u"&&e instanceof OffscreenCanvasRenderingContext2D))throw new TypeError("context must be a CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D.");if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(!["fill","contain","cover"].includes(t.fit))throw new TypeError("options.fit must be 'fill', 'contain', or 'cover'.");if(t.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError("options.rotation, when provided, must be 0, 90, 180, or 270.");t.crop!==void 0&&bs(t.crop,"options.");const i=e.canvas.width,a=e.canvas.height,s=t.rotation??this.rotation,[n,o]=s%180===0?[this.codedWidth,this.codedHeight]:[this.codedHeight,this.codedWidth];t.crop&&vs(t.crop,n,o);let c,l,d,u;const{sx:f,sy:h,sWidth:g,sHeight:m}=this._rotateSourceRegion(t.crop?.left??0,t.crop?.top??0,t.crop?.width??n,t.crop?.height??o,s);if(t.fit==="fill")c=0,l=0,d=i,u=a;else{const[p,b]=t.crop?[t.crop.width,t.crop.height]:[n,o],y=t.fit==="contain"?Math.min(i/p,a/b):Math.max(i/p,a/b);d=p*y,u=b*y,c=(i-d)/2,l=(a-u)/2}e.save();const v=s%180===0?1:d/u;e.translate(i/2,a/2),e.rotate(s*Math.PI/180),e.scale(1/v,v),e.translate(-i/2,-a/2),e.drawImage(this.toCanvasImageSource(),f,h,g,m,c,l,d,u),e.restore()}_rotateSourceRegion(e,t,i,a,s){return s===90?[e,t,i,a]=[t,this.codedHeight-e-i,a,i]:s===180?[e,t]=[this.codedWidth-e-i,this.codedHeight-t-a]:s===270&&([e,t,i,a]=[this.codedWidth-t-a,e,a,i]),{sx:e,sy:t,sWidth:i,sHeight:a}}toCanvasImageSource(){if(this._closed)throw new Error("VideoSample is closed.");if(I(this._data!==null),this._data instanceof Uint8Array){const e=this.toVideoFrame();return queueMicrotask(()=>e.close()),e}else return this._data}setRotation(e){if(![0,90,180,270].includes(e))throw new TypeError("newRotation must be 0, 90, 180, or 270.");this.rotation=e}setTimestamp(e){if(!Number.isFinite(e))throw new TypeError("newTimestamp must be a number.");this.timestamp=e}setDuration(e){if(!Number.isFinite(e)||e<0)throw new TypeError("newDuration must be a non-negative number.");this.duration=e}[Symbol.dispose](){this.close()}}class cn{constructor(e){this.primaries=e?.primaries??null,this.transfer=e?.transfer??null,this.matrix=e?.matrix??null,this.fullRange=e?.fullRange??null}toJSON(){return{primaries:this.primaries,transfer:this.transfer,matrix:this.matrix,fullRange:this.fullRange}}}const Qr=r=>typeof VideoFrame<"u"&&r instanceof VideoFrame,vs=(r,e,t)=>{r.left=Math.min(r.left,e),r.top=Math.min(r.top,t),r.width=Math.min(r.width,e-r.left),r.height=Math.min(r.height,t-r.top),I(r.width>=0),I(r.height>=0)},bs=(r,e)=>{if(!r||typeof r!="object")throw new TypeError(e+"crop, when provided, must be an object.");if(!Number.isInteger(r.left)||r.left<0)throw new TypeError(e+"crop.left must be a non-negative integer.");if(!Number.isInteger(r.top)||r.top<0)throw new TypeError(e+"crop.top must be a non-negative integer.");if(!Number.isInteger(r.width)||r.width<0)throw new TypeError(e+"crop.width must be a non-negative integer.");if(!Number.isInteger(r.height)||r.height<0)throw new TypeError(e+"crop.height must be a non-negative integer.")},ho=r=>{if(!r||typeof r!="object")throw new TypeError("options must be an object.");if(r.colorSpace!==void 0&&!["display-p3","srgb"].includes(r.colorSpace))throw new TypeError("options.colorSpace, when provided, must be 'display-p3' or 'srgb'.");if(r.format!==void 0&&typeof r.format!="string")throw new TypeError("options.format, when provided, must be a string.");if(r.layout!==void 0){if(!Array.isArray(r.layout))throw new TypeError("options.layout, when provided, must be an array.");for(const e of r.layout){if(!e||typeof e!="object")throw new TypeError("Each entry in options.layout must be an object.");if(!Number.isInteger(e.offset)||e.offset<0)throw new TypeError("plane.offset must be a non-negative integer.");if(!Number.isInteger(e.stride)||e.stride<0)throw new TypeError("plane.stride must be a non-negative integer.")}}if(r.rect!==void 0){if(!r.rect||typeof r.rect!="object")throw new TypeError("options.rect, when provided, must be an object.");if(r.rect.x!==void 0&&(!Number.isInteger(r.rect.x)||r.rect.x<0))throw new TypeError("options.rect.x, when provided, must be a non-negative integer.");if(r.rect.y!==void 0&&(!Number.isInteger(r.rect.y)||r.rect.y<0))throw new TypeError("options.rect.y, when provided, must be a non-negative integer.");if(r.rect.width!==void 0&&(!Number.isInteger(r.rect.width)||r.rect.width<0))throw new TypeError("options.rect.width, when provided, must be a non-negative integer.");if(r.rect.height!==void 0&&(!Number.isInteger(r.rect.height)||r.rect.height<0))throw new TypeError("options.rect.height, when provided, must be a non-negative integer.")}},yf=(r,e,t)=>{const i=kf(r),a=[];let s=0;for(const n of i){const o=Math.ceil(e/n.widthDivisor),c=Math.ceil(t/n.heightDivisor),l=o*n.sampleBytes,d=l*c;a.push({offset:s,stride:l}),s+=d}return a},kf=r=>{const e=(t,i,a,s,n)=>{const o=[{sampleBytes:t,widthDivisor:1,heightDivisor:1},{sampleBytes:i,widthDivisor:a,heightDivisor:s},{sampleBytes:i,widthDivisor:a,heightDivisor:s}];return n&&o.push({sampleBytes:t,widthDivisor:1,heightDivisor:1}),o};switch(r){case"I420":return e(1,1,2,2,!1);case"I420P10":case"I420P12":return e(2,2,2,2,!1);case"I420A":return e(1,1,2,2,!0);case"I420AP10":case"I420AP12":return e(2,2,2,2,!0);case"I422":return e(1,1,2,1,!1);case"I422P10":case"I422P12":return e(2,2,2,1,!1);case"I422A":return e(1,1,2,1,!0);case"I422AP10":case"I422AP12":return e(2,2,2,1,!0);case"I444":return e(1,1,1,1,!1);case"I444P10":case"I444P12":return e(2,2,1,1,!1);case"I444A":return e(1,1,1,1,!0);case"I444AP10":case"I444AP12":return e(2,2,1,1,!0);case"NV12":return[{sampleBytes:1,widthDivisor:1,heightDivisor:1},{sampleBytes:2,widthDivisor:2,heightDivisor:2}];case"RGBA":case"RGBX":case"BGRA":case"BGRX":return[{sampleBytes:4,widthDivisor:1,heightDivisor:1}];default:pr(r),I(!1)}},ln=new Set(["f32","f32-planar","s16","s16-planar","s32","s32-planar","u8","u8-planar"]);class sr{get microsecondTimestamp(){return Math.trunc($r*this.timestamp)}get microsecondDuration(){return Math.trunc($r*this.duration)}constructor(e){if(this._closed=!1,ji(e)){if(e.format===null)throw new TypeError("AudioData with null format is not supported.");this._data=e,this.format=e.format,this.sampleRate=e.sampleRate,this.numberOfFrames=e.numberOfFrames,this.numberOfChannels=e.numberOfChannels,this.timestamp=e.timestamp/1e6,this.duration=e.numberOfFrames/e.sampleRate}else{if(!e||typeof e!="object")throw new TypeError("Invalid AudioDataInit: must be an object.");if(!ln.has(e.format))throw new TypeError("Invalid AudioDataInit: invalid format.");if(!Number.isFinite(e.sampleRate)||e.sampleRate<=0)throw new TypeError("Invalid AudioDataInit: sampleRate must be > 0.");if(!Number.isInteger(e.numberOfChannels)||e.numberOfChannels===0)throw new TypeError("Invalid AudioDataInit: numberOfChannels must be an integer > 0.");if(!Number.isFinite(e?.timestamp))throw new TypeError("init.timestamp must be a number.");const t=e.data.byteLength/(Yr(e.format)*e.numberOfChannels);if(!Number.isInteger(t))throw new TypeError("Invalid AudioDataInit: data size is not a multiple of frame size.");this.format=e.format,this.sampleRate=e.sampleRate,this.numberOfFrames=t,this.numberOfChannels=e.numberOfChannels,this.timestamp=e.timestamp,this.duration=t/e.sampleRate;let i;if(e.data instanceof ArrayBuffer)i=new Uint8Array(e.data);else if(ArrayBuffer.isView(e.data))i=new Uint8Array(e.data.buffer,e.data.byteOffset,e.data.byteLength);else throw new TypeError("Invalid AudioDataInit: data is not a BufferSource.");const a=this.numberOfFrames*this.numberOfChannels*Yr(this.format);if(i.byteLength<a)throw new TypeError("Invalid AudioDataInit: insufficient data size.");this._data=i}ca?.register(this,{type:"audio",data:this._data},this)}allocationSize(e){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(!Number.isInteger(e.planeIndex)||e.planeIndex<0)throw new TypeError("planeIndex must be a non-negative integer.");if(e.format!==void 0&&!ln.has(e.format))throw new TypeError("Invalid format.");if(e.frameOffset!==void 0&&(!Number.isInteger(e.frameOffset)||e.frameOffset<0))throw new TypeError("frameOffset must be a non-negative integer.");if(e.frameCount!==void 0&&(!Number.isInteger(e.frameCount)||e.frameCount<0))throw new TypeError("frameCount must be a non-negative integer.");if(this._closed)throw new Error("AudioSample is closed.");const t=e.format??this.format,i=e.frameOffset??0;if(i>=this.numberOfFrames)throw new RangeError("frameOffset out of range");const a=e.frameCount!==void 0?e.frameCount:this.numberOfFrames-i;if(a>this.numberOfFrames-i)throw new RangeError("frameCount out of range");const s=Yr(t),n=vi(t);if(n&&e.planeIndex>=this.numberOfChannels)throw new RangeError("planeIndex out of range");if(!n&&e.planeIndex!==0)throw new RangeError("planeIndex out of range");return(n?a:a*this.numberOfChannels)*s}copyTo(e,t){if(!ja(e))throw new TypeError("destination must be an ArrayBuffer or an ArrayBuffer view.");if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(!Number.isInteger(t.planeIndex)||t.planeIndex<0)throw new TypeError("planeIndex must be a non-negative integer.");if(t.format!==void 0&&!ln.has(t.format))throw new TypeError("Invalid format.");if(t.frameOffset!==void 0&&(!Number.isInteger(t.frameOffset)||t.frameOffset<0))throw new TypeError("frameOffset must be a non-negative integer.");if(t.frameCount!==void 0&&(!Number.isInteger(t.frameCount)||t.frameCount<0))throw new TypeError("frameCount must be a non-negative integer.");if(this._closed)throw new Error("AudioSample is closed.");const{planeIndex:i,format:a,frameCount:s,frameOffset:n}=t,o=this.format,c=a??this.format;if(!c)throw new Error("Destination format not determined");const l=this.numberOfFrames,d=this.numberOfChannels,u=n??0;if(u>=l)throw new RangeError("frameOffset out of range");const f=s!==void 0?s:l-u;if(f>l-u)throw new RangeError("frameCount out of range");const h=Yr(c),g=vi(c);if(g&&i>=d)throw new RangeError("planeIndex out of range");if(!g&&i!==0)throw new RangeError("planeIndex out of range");const v=(g?f:f*d)*h;if(e.byteLength<v)throw new RangeError("Destination buffer is too small");const p=kt(e),b=Uc(c);if(ji(this._data))ta()&&d>2&&c!==o?xf(this._data,p,o,c,d,i,u,f):this._data.copyTo(e,{planeIndex:i,frameOffset:u,frameCount:f,format:c});else{const y=this._data,_=kt(y),S=Oc(o),A=Yr(o),z=vi(o);for(let D=0;D<f;D++)if(g){const M=D*h;let $;z?$=(i*l+(D+u))*A:$=((D+u)*d+i)*A;const K=S(_,$);b(p,M,K)}else for(let M=0;M<d;M++){const K=(D*d+M)*h;let P;z?P=(M*l+(D+u))*A:P=((D+u)*d+M)*A;const O=S(_,P);b(p,K,O)}}}clone(){if(this._closed)throw new Error("AudioSample is closed.");if(ji(this._data)){const e=new sr(this._data.clone());return e.setTimestamp(this.timestamp),e}else return new sr({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.timestamp,data:this._data})}close(){this._closed||(ca?.unregister(this),ji(this._data)?this._data.close():this._data=new Uint8Array(0),this._closed=!0)}toAudioData(){if(this._closed)throw new Error("AudioSample is closed.");if(ji(this._data)){if(this._data.timestamp===this.microsecondTimestamp)return this._data.clone();if(vi(this.format)){const e=this.allocationSize({planeIndex:0,format:this.format}),t=new ArrayBuffer(e*this.numberOfChannels);for(let i=0;i<this.numberOfChannels;i++)this.copyTo(new Uint8Array(t,i*e,e),{planeIndex:i,format:this.format});return new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:t})}else{const e=new ArrayBuffer(this.allocationSize({planeIndex:0,format:this.format}));return this.copyTo(e,{planeIndex:0,format:this.format}),new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:e})}}else return new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:this._data.buffer instanceof ArrayBuffer?this._data.buffer:this._data.slice()})}toAudioBuffer(){if(this._closed)throw new Error("AudioSample is closed.");const e=new AudioBuffer({numberOfChannels:this.numberOfChannels,length:this.numberOfFrames,sampleRate:this.sampleRate}),t=new Float32Array(this.allocationSize({planeIndex:0,format:"f32-planar"})/4);for(let i=0;i<this.numberOfChannels;i++)this.copyTo(t,{planeIndex:i,format:"f32-planar"}),e.copyToChannel(t,i);return e}setTimestamp(e){if(!Number.isFinite(e))throw new TypeError("newTimestamp must be a number.");this.timestamp=e}[Symbol.dispose](){this.close()}static*_fromAudioBuffer(e,t){if(!(e instanceof AudioBuffer))throw new TypeError("audioBuffer must be an AudioBuffer.");const i=48e3*5,a=e.numberOfChannels,s=e.sampleRate,n=e.length,o=Math.floor(i/a);let c=0,l=n;for(;l>0;){const d=Math.min(o,l),u=new Float32Array(a*d);for(let f=0;f<a;f++)e.copyFromChannel(u.subarray(f*d,(f+1)*d),f,c);yield new sr({format:"f32-planar",sampleRate:s,numberOfFrames:d,numberOfChannels:a,timestamp:t+c/s,data:u}),c+=d,l-=d}}static fromAudioBuffer(e,t){if(!(e instanceof AudioBuffer))throw new TypeError("audioBuffer must be an AudioBuffer.");const i=48e3*5,a=e.numberOfChannels,s=e.sampleRate,n=e.length,o=Math.floor(i/a);let c=0,l=n;const d=[];for(;l>0;){const u=Math.min(o,l),f=new Float32Array(a*u);for(let g=0;g<a;g++)e.copyFromChannel(f.subarray(g*u,(g+1)*u),g,c);const h=new sr({format:"f32-planar",sampleRate:s,numberOfFrames:u,numberOfChannels:a,timestamp:t+c/s,data:f});d.push(h),c+=u,l-=u}return d}}const Yr=r=>{switch(r){case"u8":case"u8-planar":return 1;case"s16":case"s16-planar":return 2;case"s32":case"s32-planar":return 4;case"f32":case"f32-planar":return 4;default:throw new Error("Unknown AudioSampleFormat")}},vi=r=>{switch(r){case"u8-planar":case"s16-planar":case"s32-planar":case"f32-planar":return!0;default:return!1}},Oc=r=>{switch(r){case"u8":case"u8-planar":return(e,t)=>(e.getUint8(t)-128)/128;case"s16":case"s16-planar":return(e,t)=>e.getInt16(t,!0)/32768;case"s32":case"s32-planar":return(e,t)=>e.getInt32(t,!0)/2147483648;case"f32":case"f32-planar":return(e,t)=>e.getFloat32(t,!0)}},Uc=r=>{switch(r){case"u8":case"u8-planar":return(e,t,i)=>e.setUint8(t,Bt((i+1)*127.5,0,255));case"s16":case"s16-planar":return(e,t,i)=>e.setInt16(t,Bt(Math.round(i*32767),-32768,32767),!0);case"s32":case"s32-planar":return(e,t,i)=>e.setInt32(t,Bt(Math.round(i*2147483647),-2147483648,2147483647),!0);case"f32":case"f32-planar":return(e,t,i)=>e.setFloat32(t,i,!0)}},ji=r=>typeof AudioData<"u"&&r instanceof AudioData,xf=(r,e,t,i,a,s,n,o)=>{const c=Oc(t),l=Uc(i),d=Yr(t),u=Yr(i),f=vi(t);if(vi(i))if(f){const g=new ArrayBuffer(o*d),m=kt(g);r.copyTo(g,{planeIndex:s,frameOffset:n,frameCount:o,format:t});for(let v=0;v<o;v++){const p=v*d,b=v*u,y=c(m,p);l(e,b,y)}}else{const g=new ArrayBuffer(o*a*d),m=kt(g);r.copyTo(g,{planeIndex:0,frameOffset:n,frameCount:o,format:t});for(let v=0;v<o;v++){const p=(v*a+s)*d,b=v*u,y=c(m,p);l(e,b,y)}}else if(f){const g=o*d,m=new ArrayBuffer(g),v=kt(m);for(let p=0;p<a;p++){r.copyTo(m,{planeIndex:p,frameOffset:n,frameCount:o,format:t});for(let b=0;b<o;b++){const y=b*d,_=(b*a+p)*u,S=c(v,y);l(e,_,S)}}}else{const g=new ArrayBuffer(o*a*d),m=kt(g);r.copyTo(g,{planeIndex:0,frameOffset:n,frameCount:o,format:t});for(let v=0;v<o;v++)for(let p=0;p<a;p++){const b=v*a+p,y=b*d,_=b*u,S=c(m,y);l(e,_,S)}}};const ci=r=>{if(!r||typeof r!="object")throw new TypeError("options must be an object.");if(r.metadataOnly!==void 0&&typeof r.metadataOnly!="boolean")throw new TypeError("options.metadataOnly, when defined, must be a boolean.");if(r.verifyKeyPackets!==void 0&&typeof r.verifyKeyPackets!="boolean")throw new TypeError("options.verifyKeyPackets, when defined, must be a boolean.");if(r.verifyKeyPackets&&r.metadataOnly)throw new TypeError("options.verifyKeyPackets and options.metadataOnly cannot be enabled together.")},jr=r=>{if(!mc(r))throw new TypeError("timestamp must be a number.")},dn=(r,e,t)=>t.verifyKeyPackets?e.then(async i=>{if(!i||i.type==="delta")return i;const a=await r.determinePacketType(i);return a&&(i.type=a),i}):e;class la{constructor(e){if(!(e instanceof ys))throw new TypeError("track must be an InputTrack.");this._track=e}getFirstPacket(e={}){if(ci(e),this._track.input._disposed)throw new Jt;return dn(this._track,this._track._backing.getFirstPacket(e),e)}getPacket(e,t={}){if(jr(e),ci(t),this._track.input._disposed)throw new Jt;return dn(this._track,this._track._backing.getPacket(e,t),t)}getNextPacket(e,t={}){if(!(e instanceof mt))throw new TypeError("packet must be an EncodedPacket.");if(ci(t),this._track.input._disposed)throw new Jt;return dn(this._track,this._track._backing.getNextPacket(e,t),t)}async getKeyPacket(e,t={}){if(jr(e),ci(t),this._track.input._disposed)throw new Jt;if(!t.verifyKeyPackets)return this._track._backing.getKeyPacket(e,t);const i=await this._track._backing.getKeyPacket(e,t);return i&&(I(i.type==="key"),await this._track.determinePacketType(i)==="delta"?this.getKeyPacket(i.timestamp-1/this._track.timeResolution,t):i)}async getNextKeyPacket(e,t={}){if(!(e instanceof mt))throw new TypeError("packet must be an EncodedPacket.");if(ci(t),this._track.input._disposed)throw new Jt;if(!t.verifyKeyPackets)return this._track._backing.getNextKeyPacket(e,t);const i=await this._track._backing.getNextKeyPacket(e,t);return i&&(I(i.type==="key"),await this._track.determinePacketType(i)==="delta"?this.getNextKeyPacket(i,t):i)}packets(e,t,i={}){if(e!==void 0&&!(e instanceof mt))throw new TypeError("startPacket must be an EncodedPacket.");if(e!==void 0&&e.isMetadataOnly&&!i?.metadataOnly)throw new TypeError("startPacket can only be metadata-only if options.metadataOnly is enabled.");if(t!==void 0&&!(t instanceof mt))throw new TypeError("endPacket must be an EncodedPacket.");if(ci(i),this._track.input._disposed)throw new Jt;const a=[];let{promise:s,resolve:n}=Mt(),{promise:o,resolve:c}=Mt(),l=!1,d=!1,u=null;const f=[],h=()=>Math.max(2,f.length);(async()=>{let m=e??await this.getFirstPacket(i);for(;m&&!d&&!this._track.input._disposed&&!(t&&m.sequenceNumber>=t?.sequenceNumber);){if(a.length>h()){({promise:o,resolve:c}=Mt()),await o;continue}a.push(m),n(),{promise:s,resolve:n}=Mt(),m=await this.getNextPacket(m,i)}l=!0,n()})().catch(m=>{u||(u=m,n())});const g=this._track;return{async next(){for(;;){if(g.input._disposed)throw new Jt;if(d)return{value:void 0,done:!0};if(u)throw u;if(a.length>0){const m=a.shift(),v=performance.now();for(f.push(v);f.length>0&&v-f[0]>=1e3;)f.shift();return c(),{value:m,done:!1}}else{if(l)return{value:void 0,done:!0};await s}}},async return(){return d=!0,c(),n(),{value:void 0,done:!0}},async throw(m){throw m},[Symbol.asyncIterator](){return this}}}}class ws{constructor(e,t){this.onSample=e,this.onError=t}}class Vc{mediaSamplesInRange(e=0,t=1/0){jr(e),jr(t);const i=[];let a=!1,s=null,{promise:n,resolve:o}=Mt(),{promise:c,resolve:l}=Mt(),d=!1,u=!1,f=!1,h=null;(async()=>{const v=await this._createDecoder(A=>{if(l(),A.timestamp>=t&&(u=!0),u){A.close();return}s&&(A.timestamp>e?(i.push(s),a=!0):s.close()),A.timestamp>=e&&(i.push(A),a=!0),s=a?null:A,i.length>0&&(o(),{promise:n,resolve:o}=Mt())},A=>{h||(h=A,o())}),p=this._createPacketSink(),b=await p.getKeyPacket(e,{verifyKeyPackets:!0})??await p.getFirstPacket();let y=b;const S=p.packets(b??void 0,void 0);for(await S.next();y&&!u&&!this._track.input._disposed;){const A=mo(i.length);if(i.length+v.getDecodeQueueSize()>A){({promise:c,resolve:l}=Mt()),await c;continue}v.decode(y);const z=await S.next();if(z.done)break;y=z.value}await S.return(),!f&&!this._track.input._disposed&&await v.flush(),v.close(),!a&&s&&i.push(s),d=!0,o()})().catch(v=>{h||(h=v,o())});const g=this._track,m=()=>{s?.close();for(const v of i)v.close()};return{async next(){for(;;){if(g.input._disposed)throw m(),new Jt;if(f)return{value:void 0,done:!0};if(h)throw m(),h;if(i.length>0){const v=i.shift();return l(),{value:v,done:!1}}else if(!d)await n;else return{value:void 0,done:!0}}},async return(){return f=!0,u=!0,l(),o(),m(),{value:void 0,done:!0}},async throw(v){throw v},[Symbol.asyncIterator](){return this}}}mediaSamplesAtTimestamps(e){Fu(e);const t=Au(e),i=[],a=[];let{promise:s,resolve:n}=Mt(),{promise:o,resolve:c}=Mt(),l=!1,d=!1,u=null;const f=m=>{a.push(m),n(),{promise:s,resolve:n}=Mt()};(async()=>{const m=await this._createDecoder(A=>{if(c(),d){A.close();return}let z=0;for(;i.length>0&&A.timestamp-i[0]>-1e-10;)z++,i.shift();if(z>0)for(let D=0;D<z;D++)f(D<z-1?A.clone():A);else A.close()},A=>{u||(u=A,n())}),v=this._createPacketSink();let p=null,b=null,y=-1;const _=async()=>{I(b);let A=b;for(m.decode(A);A.sequenceNumber<y;){const z=mo(a.length);for(;a.length+m.getDecodeQueueSize()>z&&!d;)({promise:o,resolve:c}=Mt()),await o;if(d)break;const D=await v.getNextPacket(A);I(D),m.decode(D),A=D}y=-1},S=async()=>{await m.flush();for(let A=0;A<i.length;A++)f(null);i.length=0};for await(const A of t){if(jr(A),d||this._track.input._disposed)break;const z=await v.getPacket(A),D=z&&await v.getKeyPacket(A,{verifyKeyPackets:!0});if(!D){y!==-1&&(await _(),await S()),f(null),p=null;continue}p&&(D.sequenceNumber!==b.sequenceNumber||z.timestamp<p.timestamp)&&(await _(),await S()),i.push(z.timestamp),y=Math.max(z.sequenceNumber,y),p=z,b=D}!d&&!this._track.input._disposed&&(y!==-1&&await _(),await S()),m.close(),l=!0,n()})().catch(m=>{u||(u=m,n())});const h=this._track,g=()=>{for(const m of a)m?.close()};return{async next(){for(;;){if(h.input._disposed)throw g(),new Jt;if(d)return{value:void 0,done:!0};if(u)throw g(),u;if(a.length>0){const m=a.shift();return I(m!==void 0),c(),{value:m,done:!1}}else if(!l)await s;else return{value:void 0,done:!0}}},async return(){return d=!0,c(),n(),g(),{value:void 0,done:!0}},async throw(m){throw m},[Symbol.asyncIterator](){return this}}}}const mo=r=>r===0?40:8;class _f extends ws{constructor(e,t,i,a,s,n){super(e,t),this.codec=i,this.decoderConfig=a,this.rotation=s,this.timeResolution=n,this.decoder=null,this.customDecoder=null,this.customDecoderCallSerializer=new Ga,this.customDecoderQueueSize=0,this.inputTimestamps=[],this.sampleQueue=[],this.currentPacketIndex=0,this.raslSkipped=!1,this.alphaDecoder=null,this.alphaHadKeyframe=!1,this.colorQueue=[],this.alphaQueue=[],this.merger=null,this.mergerCreationFailed=!1,this.decodedAlphaChunkCount=0,this.alphaDecoderQueueSize=0,this.nullAlphaFrameQueue=[],this.currentAlphaPacketIndex=0,this.alphaRaslSkipped=!1;const o=Rc.find(c=>c.supports(i,a));if(o)this.customDecoder=new o,this.customDecoder.codec=i,this.customDecoder.config=a,this.customDecoder.onSample=c=>{if(!(c instanceof $t))throw new TypeError("The argument passed to onSample must be a VideoSample.");this.finalizeAndEmitSample(c)},this.customDecoderCallSerializer.call(()=>this.customDecoder.init());else{const c=d=>{if(this.alphaQueue.length>0){const u=this.alphaQueue.shift();I(u!==void 0),this.mergeAlpha(d,u)}else this.colorQueue.push(d)};if(i==="avc"&&this.decoderConfig.description&&Dn()){const d=af(Vt(this.decoderConfig.description));if(d&&d.sequenceParameterSets.length>0){const u=Ec(d.sequenceParameterSets[0]);u&&u.frameMbsOnlyFlag===0&&(this.decoderConfig={...this.decoderConfig,hardwareAcceleration:"prefer-software"})}}const l=new Error("Decoding error").stack;this.decoder=new VideoDecoder({output:d=>{try{c(d)}catch(u){this.onError(u)}},error:d=>{d.stack=l,this.onError(d)}}),this.decoder.configure(this.decoderConfig)}}getDecodeQueueSize(){return this.customDecoder?this.customDecoderQueueSize:(I(this.decoder),Math.max(this.decoder.decodeQueueSize,this.alphaDecoder?.decodeQueueSize??0))}decode(e){if(this.codec==="hevc"&&this.currentPacketIndex>0&&!this.raslSkipped){if(this.hasHevcRaslPicture(e.data))return;this.raslSkipped=!0}if(this.customDecoder)this.customDecoderQueueSize++,this.customDecoderCallSerializer.call(()=>this.customDecoder.decode(e)).then(()=>this.customDecoderQueueSize--);else{if(I(this.decoder),ta()||to(this.inputTimestamps,e.timestamp,t=>t),Dn()&&this.currentPacketIndex===0&&this.codec==="avc"){const i=Cc(e.data,this.decoderConfig).filter(s=>{const n=Ei(s);return!(n>=20&&n<=31)}),a=tf(i,this.decoderConfig);e=new mt(a,e.type,e.timestamp,e.duration)}this.decoder.decode(e.toEncodedVideoChunk()),this.decodeAlphaData(e)}this.currentPacketIndex++}decodeAlphaData(e){if(!e.sideData.alpha||this.mergerCreationFailed){this.pushNullAlphaFrame();return}if(!this.merger)try{this.merger=new Tf}catch(i){console.error("Due to an error, only color data will be decoded.",i),this.mergerCreationFailed=!0,this.decodeAlphaData(e);return}if(!this.alphaDecoder){const i=s=>{if(this.alphaDecoderQueueSize--,this.colorQueue.length>0){const n=this.colorQueue.shift();I(n!==void 0),this.mergeAlpha(n,s)}else this.alphaQueue.push(s);for(this.decodedAlphaChunkCount++;this.nullAlphaFrameQueue.length>0&&this.nullAlphaFrameQueue[0]===this.decodedAlphaChunkCount;)if(this.nullAlphaFrameQueue.shift(),this.colorQueue.length>0){const n=this.colorQueue.shift();I(n!==void 0),this.mergeAlpha(n,null)}else this.alphaQueue.push(null)},a=new Error("Decoding error").stack;this.alphaDecoder=new VideoDecoder({output:s=>{try{i(s)}catch(n){this.onError(n)}},error:s=>{s.stack=a,this.onError(s)}}),this.alphaDecoder.configure(this.decoderConfig)}const t=Mc(this.codec,this.decoderConfig,e.sideData.alpha);if(this.alphaHadKeyframe||(this.alphaHadKeyframe=t==="key"),this.alphaHadKeyframe){if(this.codec==="hevc"&&this.currentAlphaPacketIndex>0&&!this.alphaRaslSkipped){if(this.hasHevcRaslPicture(e.sideData.alpha)){this.pushNullAlphaFrame();return}this.alphaRaslSkipped=!0}this.currentAlphaPacketIndex++,this.alphaDecoder.decode(e.alphaToEncodedVideoChunk(t??e.type)),this.alphaDecoderQueueSize++}else this.pushNullAlphaFrame()}pushNullAlphaFrame(){this.alphaDecoderQueueSize===0?this.alphaQueue.push(null):this.nullAlphaFrameQueue.push(this.decodedAlphaChunkCount+this.alphaDecoderQueueSize)}hasHevcRaslPicture(e){return Ic(e,this.decoderConfig).some(i=>{const a=Ur(i);return a===qt.RASL_N||a===qt.RASL_R})}sampleHandler(e){if(ta()){if(this.sampleQueue.length>0&&e.timestamp>=Ct(this.sampleQueue).timestamp){for(const t of this.sampleQueue)this.finalizeAndEmitSample(t);this.sampleQueue.length=0}to(this.sampleQueue,e,t=>t.timestamp)}else{const t=this.inputTimestamps.shift();I(t!==void 0),e.setTimestamp(t),this.finalizeAndEmitSample(e)}}finalizeAndEmitSample(e){e.setTimestamp(Math.round(e.timestamp*this.timeResolution)/this.timeResolution),e.setDuration(Math.round(e.duration*this.timeResolution)/this.timeResolution),e.setRotation(this.rotation),this.onSample(e)}mergeAlpha(e,t){if(!t){const s=new $t(e);this.sampleHandler(s);return}I(this.merger),this.merger.update(e,t),e.close(),t.close();const i=new VideoFrame(this.merger.canvas,{timestamp:e.timestamp,duration:e.duration??void 0}),a=new $t(i);this.sampleHandler(a)}async flush(){if(this.customDecoder?await this.customDecoderCallSerializer.call(()=>this.customDecoder.flush()):(I(this.decoder),await Promise.all([this.decoder.flush(),this.alphaDecoder?.flush()]),this.colorQueue.forEach(e=>e.close()),this.colorQueue.length=0,this.alphaQueue.forEach(e=>e?.close()),this.alphaQueue.length=0,this.alphaHadKeyframe=!1,this.decodedAlphaChunkCount=0,this.alphaDecoderQueueSize=0,this.nullAlphaFrameQueue.length=0,this.currentAlphaPacketIndex=0,this.alphaRaslSkipped=!1),ta()){for(const e of this.sampleQueue)this.finalizeAndEmitSample(e);this.sampleQueue.length=0}this.currentPacketIndex=0,this.raslSkipped=!1}close(){this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.close()):(I(this.decoder),this.decoder.close(),this.alphaDecoder?.close(),this.colorQueue.forEach(e=>e.close()),this.colorQueue.length=0,this.alphaQueue.forEach(e=>e?.close()),this.alphaQueue.length=0,this.merger?.close());for(const e of this.sampleQueue)e.close();this.sampleQueue.length=0}}class Tf{constructor(){typeof OffscreenCanvas<"u"?this.canvas=new OffscreenCanvas(300,150):this.canvas=document.createElement("canvas");const e=this.canvas.getContext("webgl2",{premultipliedAlpha:!1});if(!e)throw new Error("Couldn't acquire WebGL 2 context.");this.gl=e,this.program=this.createProgram(),this.vao=this.createVAO(),this.colorTexture=this.createTexture(),this.alphaTexture=this.createTexture(),this.gl.useProgram(this.program),this.gl.uniform1i(this.gl.getUniformLocation(this.program,"u_colorTexture"),0),this.gl.uniform1i(this.gl.getUniformLocation(this.program,"u_alphaTexture"),1)}createProgram(){const e=this.createShader(this.gl.VERTEX_SHADER,`#version 300 es
			in vec2 a_position;
			in vec2 a_texCoord;
			out vec2 v_texCoord;
			
			void main() {
				gl_Position = vec4(a_position, 0.0, 1.0);
				v_texCoord = a_texCoord;
			}
		`),t=this.createShader(this.gl.FRAGMENT_SHADER,`#version 300 es
			precision highp float;
			
			uniform sampler2D u_colorTexture;
			uniform sampler2D u_alphaTexture;
			in vec2 v_texCoord;
			out vec4 fragColor;
			
			void main() {
				vec3 color = texture(u_colorTexture, v_texCoord).rgb;
				float alpha = texture(u_alphaTexture, v_texCoord).r;
				fragColor = vec4(color, alpha);
			}
		`),i=this.gl.createProgram();return this.gl.attachShader(i,e),this.gl.attachShader(i,t),this.gl.linkProgram(i),i}createShader(e,t){const i=this.gl.createShader(e);return this.gl.shaderSource(i,t),this.gl.compileShader(i),i}createVAO(){const e=this.gl.createVertexArray();this.gl.bindVertexArray(e);const t=new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,1,1,1,0]),i=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,i),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.STATIC_DRAW);const a=this.gl.getAttribLocation(this.program,"a_position"),s=this.gl.getAttribLocation(this.program,"a_texCoord");return this.gl.enableVertexAttribArray(a),this.gl.vertexAttribPointer(a,2,this.gl.FLOAT,!1,16,0),this.gl.enableVertexAttribArray(s),this.gl.vertexAttribPointer(s,2,this.gl.FLOAT,!1,16,8),e}createTexture(){const e=this.gl.createTexture();return this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),e}update(e,t){(e.displayWidth!==this.canvas.width||e.displayHeight!==this.canvas.height)&&(this.canvas.width=e.displayWidth,this.canvas.height=e.displayHeight),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.colorTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,this.alphaTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.bindVertexArray(this.vao),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}close(){this.gl.getExtension("WEBGL_lose_context")?.loseContext(),this.gl=null}}class Ln extends Vc{constructor(e){if(!(e instanceof ma))throw new TypeError("videoTrack must be an InputVideoTrack.");super(),this._track=e}async _createDecoder(e,t){if(!await this._track.canDecode())throw new Error("This video track cannot be decoded by this browser. Make sure to check decodability before using a track.");const i=this._track.codec,a=this._track.rotation,s=await this._track.getDecoderConfig(),n=this._track.timeResolution;return I(i&&s),new _f(e,t,i,s,a,n)}_createPacketSink(){return new la(this._track)}async getSample(e){jr(e);for await(const t of this.mediaSamplesAtTimestamps([e]))return t;throw new Error("Internal error: Iterator returned nothing.")}samples(e=0,t=1/0){return this.mediaSamplesInRange(e,t)}samplesAtTimestamps(e){return this.mediaSamplesAtTimestamps(e)}}class Sf{constructor(e,t={}){if(this._nextCanvasIndex=0,!(e instanceof ma))throw new TypeError("videoTrack must be an InputVideoTrack.");if(t&&typeof t!="object")throw new TypeError("options must be an object.");if(t.alpha!==void 0&&typeof t.alpha!="boolean")throw new TypeError("options.alpha, when provided, must be a boolean.");if(t.width!==void 0&&(!Number.isInteger(t.width)||t.width<=0))throw new TypeError("options.width, when defined, must be a positive integer.");if(t.height!==void 0&&(!Number.isInteger(t.height)||t.height<=0))throw new TypeError("options.height, when defined, must be a positive integer.");if(t.fit!==void 0&&!["fill","contain","cover"].includes(t.fit))throw new TypeError('options.fit, when provided, must be one of "fill", "contain", or "cover".');if(t.width!==void 0&&t.height!==void 0&&t.fit===void 0)throw new TypeError("When both options.width and options.height are provided, options.fit must also be provided.");if(t.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError("options.rotation, when provided, must be 0, 90, 180 or 270.");if(t.crop!==void 0&&bs(t.crop,"options."),t.poolSize!==void 0&&(typeof t.poolSize!="number"||!Number.isInteger(t.poolSize)||t.poolSize<0))throw new TypeError("poolSize must be a non-negative integer.");const i=t.rotation??e.rotation,[a,s]=i%180===0?[e.codedWidth,e.codedHeight]:[e.codedHeight,e.codedWidth],n=t.crop;n&&vs(n,a,s);let[o,c]=n?[n.width,n.height]:[a,s];const l=o/c;t.width!==void 0&&t.height===void 0?(o=t.width,c=Math.round(o/l)):t.width===void 0&&t.height!==void 0?(c=t.height,o=Math.round(c*l)):t.width!==void 0&&t.height!==void 0&&(o=t.width,c=t.height),this._videoTrack=e,this._alpha=t.alpha??!1,this._width=o,this._height=c,this._rotation=i,this._crop=n,this._fit=t.fit??"fill",this._videoSampleSink=new Ln(e),this._canvasPool=Array.from({length:t.poolSize??0},()=>null)}_videoSampleToWrappedCanvas(e){let t=this._canvasPool[this._nextCanvasIndex],i=!1;t||(typeof document<"u"?(t=document.createElement("canvas"),t.width=this._width,t.height=this._height):t=new OffscreenCanvas(this._width,this._height),this._canvasPool.length>0&&(this._canvasPool[this._nextCanvasIndex]=t),i=!0),this._canvasPool.length>0&&(this._nextCanvasIndex=(this._nextCanvasIndex+1)%this._canvasPool.length);const a=t.getContext("2d",{alpha:this._alpha||Ri()});I(a),a.resetTransform(),i||(!this._alpha&&Ri()?(a.fillStyle="black",a.fillRect(0,0,this._width,this._height)):a.clearRect(0,0,this._width,this._height)),e.drawWithFit(a,{fit:this._fit,rotation:this._rotation,crop:this._crop});const s={canvas:t,timestamp:e.timestamp,duration:e.duration};return e.close(),s}async getCanvas(e){jr(e);const t=await this._videoSampleSink.getSample(e);return t&&this._videoSampleToWrappedCanvas(t)}canvases(e=0,t=1/0){return ro(this._videoSampleSink.samples(e,t),i=>this._videoSampleToWrappedCanvas(i))}canvasesAtTimestamps(e){return ro(this._videoSampleSink.samplesAtTimestamps(e),t=>t&&this._videoSampleToWrappedCanvas(t))}}class Cf extends ws{constructor(e,t,i,a){super(e,t),this.decoder=null,this.customDecoder=null,this.customDecoderCallSerializer=new Ga,this.customDecoderQueueSize=0,this.currentTimestamp=null;const s=o=>{(this.currentTimestamp===null||Math.abs(o.timestamp-this.currentTimestamp)>=o.duration)&&(this.currentTimestamp=o.timestamp);const c=this.currentTimestamp;if(this.currentTimestamp+=o.duration,o.numberOfFrames===0){o.close();return}const l=a.sampleRate;o.setTimestamp(Math.round(c*l)/l),e(o)},n=Dc.find(o=>o.supports(i,a));if(n)this.customDecoder=new n,this.customDecoder.codec=i,this.customDecoder.config=a,this.customDecoder.onSample=o=>{if(!(o instanceof sr))throw new TypeError("The argument passed to onSample must be an AudioSample.");s(o)},this.customDecoderCallSerializer.call(()=>this.customDecoder.init());else{const o=new Error("Decoding error").stack;this.decoder=new AudioDecoder({output:c=>{try{s(new sr(c))}catch(l){this.onError(l)}},error:c=>{c.stack=o,this.onError(c)}}),this.decoder.configure(a)}}getDecodeQueueSize(){return this.customDecoder?this.customDecoderQueueSize:(I(this.decoder),this.decoder.decodeQueueSize)}decode(e){this.customDecoder?(this.customDecoderQueueSize++,this.customDecoderCallSerializer.call(()=>this.customDecoder.decode(e)).then(()=>this.customDecoderQueueSize--)):(I(this.decoder),this.decoder.decode(e.toEncodedAudioChunk()))}flush(){return this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.flush()):(I(this.decoder),this.decoder.flush())}close(){this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.close()):(I(this.decoder),this.decoder.close())}}class Pf extends ws{constructor(e,t,i){super(e,t),this.decoderConfig=i,this.currentTimestamp=null,I(Dt.includes(i.codec)),this.codec=i.codec;const{dataType:a,sampleSize:s,littleEndian:n}=Br(this.codec);switch(this.inputSampleSize=s,s){case 1:a==="unsigned"?this.readInputValue=(o,c)=>o.getUint8(c)-2**7:a==="signed"?this.readInputValue=(o,c)=>o.getInt8(c):a==="ulaw"?this.readInputValue=(o,c)=>gf(o.getUint8(c)):a==="alaw"?this.readInputValue=(o,c)=>bf(o.getUint8(c)):I(!1);break;case 2:a==="unsigned"?this.readInputValue=(o,c)=>o.getUint16(c,n)-2**15:a==="signed"?this.readInputValue=(o,c)=>o.getInt16(c,n):I(!1);break;case 3:a==="unsigned"?this.readInputValue=(o,c)=>Ka(o,c,n)-2**23:a==="signed"?this.readInputValue=(o,c)=>zu(o,c,n):I(!1);break;case 4:a==="unsigned"?this.readInputValue=(o,c)=>o.getUint32(c,n)-2**31:a==="signed"?this.readInputValue=(o,c)=>o.getInt32(c,n):a==="float"?this.readInputValue=(o,c)=>o.getFloat32(c,n):I(!1);break;case 8:a==="float"?this.readInputValue=(o,c)=>o.getFloat64(c,n):I(!1);break;default:pr(s),I(!1)}switch(s){case 1:a==="ulaw"||a==="alaw"?(this.outputSampleSize=2,this.outputFormat="s16",this.writeOutputValue=(o,c,l)=>o.setInt16(c,l,!0)):(this.outputSampleSize=1,this.outputFormat="u8",this.writeOutputValue=(o,c,l)=>o.setUint8(c,l+2**7));break;case 2:this.outputSampleSize=2,this.outputFormat="s16",this.writeOutputValue=(o,c,l)=>o.setInt16(c,l,!0);break;case 3:this.outputSampleSize=4,this.outputFormat="s32",this.writeOutputValue=(o,c,l)=>o.setInt32(c,l<<8,!0);break;case 4:this.outputSampleSize=4,a==="float"?(this.outputFormat="f32",this.writeOutputValue=(o,c,l)=>o.setFloat32(c,l,!0)):(this.outputFormat="s32",this.writeOutputValue=(o,c,l)=>o.setInt32(c,l,!0));break;case 8:this.outputSampleSize=4,this.outputFormat="f32",this.writeOutputValue=(o,c,l)=>o.setFloat32(c,l,!0);break;default:pr(s),I(!1)}}getDecodeQueueSize(){return 0}decode(e){const t=kt(e.data),i=e.byteLength/this.decoderConfig.numberOfChannels/this.inputSampleSize,a=i*this.decoderConfig.numberOfChannels*this.outputSampleSize,s=new ArrayBuffer(a),n=new DataView(s);for(let d=0;d<i*this.decoderConfig.numberOfChannels;d++){const u=d*this.inputSampleSize,f=d*this.outputSampleSize,h=this.readInputValue(t,u);this.writeOutputValue(n,f,h)}const o=i/this.decoderConfig.sampleRate;(this.currentTimestamp===null||Math.abs(e.timestamp-this.currentTimestamp)>=o)&&(this.currentTimestamp=e.timestamp);const c=this.currentTimestamp;this.currentTimestamp+=o;const l=new sr({format:this.outputFormat,data:s,numberOfChannels:this.decoderConfig.numberOfChannels,sampleRate:this.decoderConfig.sampleRate,numberOfFrames:i,timestamp:c});this.onSample(l)}async flush(){}close(){}}class po extends Vc{constructor(e){if(!(e instanceof Mr))throw new TypeError("audioTrack must be an InputAudioTrack.");super(),this._track=e}async _createDecoder(e,t){if(!await this._track.canDecode())throw new Error("This audio track cannot be decoded by this browser. Make sure to check decodability before using a track.");const i=this._track.codec,a=await this._track.getDecoderConfig();return I(i&&a),Dt.includes(a.codec)?new Pf(e,t,a):new Cf(e,t,i,a)}_createPacketSink(){return new la(this._track)}async getSample(e){jr(e);for await(const t of this.mediaSamplesAtTimestamps([e]))return t;throw new Error("Internal error: Iterator returned nothing.")}samples(e=0,t=1/0){return this.mediaSamplesInRange(e,t)}samplesAtTimestamps(e){return this.mediaSamplesAtTimestamps(e)}}class ys{constructor(e,t){this.input=e,this._backing=t}isVideoTrack(){return this instanceof ma}isAudioTrack(){return this instanceof Mr}get id(){return this._backing.getId()}get internalCodecId(){return this._backing.getInternalCodecId()}get languageCode(){return this._backing.getLanguageCode()}get name(){return this._backing.getName()}get timeResolution(){return this._backing.getTimeResolution()}get disposition(){return this._backing.getDisposition()}getFirstTimestamp(){return this._backing.getFirstTimestamp()}computeDuration(){return this._backing.computeDuration()}async computePacketStats(e=1/0){const t=new la(this);let i=1/0,a=-1/0,s=0,n=0;for await(const o of t.packets(void 0,void 0,{metadataOnly:!0})){if(s>=e&&o.timestamp>=a)break;i=Math.min(i,o.timestamp),a=Math.max(a,o.timestamp+o.duration),s++,n+=o.byteLength}return{packetCount:s,averagePacketRate:s?Number((s/(a-i)).toPrecision(16)):0,averageBitrate:s?Number((8*n/(a-i)).toPrecision(16)):0}}}class ma extends ys{constructor(e,t){super(e,t),this._backing=t}get type(){return"video"}get codec(){return this._backing.getCodec()}get codedWidth(){return this._backing.getCodedWidth()}get codedHeight(){return this._backing.getCodedHeight()}get rotation(){return this._backing.getRotation()}get displayWidth(){return this._backing.getRotation()%180===0?this._backing.getCodedWidth():this._backing.getCodedHeight()}get displayHeight(){return this._backing.getRotation()%180===0?this._backing.getCodedHeight():this._backing.getCodedWidth()}getColorSpace(){return this._backing.getColorSpace()}async hasHighDynamicRange(){const e=await this._backing.getColorSpace();return e.primaries==="bt2020"||e.primaries==="smpte432"||e.transfer==="pg"||e.transfer==="hlg"||e.matrix==="bt2020-ncl"}canBeTransparent(){return this._backing.canBeTransparent()}getDecoderConfig(){return this._backing.getDecoderConfig()}async getCodecParameterString(){return(await this._backing.getDecoderConfig())?.codec??null}async canDecode(){try{const e=await this._backing.getDecoderConfig();if(!e)return!1;const t=this._backing.getCodec();return I(t!==null),Rc.some(a=>a.supports(t,e))?!0:typeof VideoDecoder>"u"?!1:(await VideoDecoder.isConfigSupported(e)).supported===!0}catch(e){return console.error("Error during decodability check:",e),!1}}async determinePacketType(e){if(!(e instanceof mt))throw new TypeError("packet must be an EncodedPacket.");if(e.isMetadataOnly)throw new TypeError("packet must not be metadata-only to determine its type.");if(this.codec===null)return null;const t=await this.getDecoderConfig();return I(t),Mc(this.codec,t,e.data)}}class Mr extends ys{constructor(e,t){super(e,t),this._backing=t}get type(){return"audio"}get codec(){return this._backing.getCodec()}get numberOfChannels(){return this._backing.getNumberOfChannels()}get sampleRate(){return this._backing.getSampleRate()}getDecoderConfig(){return this._backing.getDecoderConfig()}async getCodecParameterString(){return(await this._backing.getDecoderConfig())?.codec??null}async canDecode(){try{const e=await this._backing.getDecoderConfig();if(!e)return!1;const t=this._backing.getCodec();return I(t!==null),Dc.some(i=>i.supports(t,e))||e.codec.startsWith("pcm-")?!0:typeof AudioDecoder>"u"?!1:(await AudioDecoder.isConfigSupported(e)).supported===!0}catch(e){return console.error("Error during decodability check:",e),!1}}async determinePacketType(e){if(!(e instanceof mt))throw new TypeError("packet must be an EncodedPacket.");return this.codec===null?null:"key"}}const Lc=r=>{let t=(r.hasVideo?"video/":r.hasAudio?"audio/":"application/")+(r.isQuickTime?"quicktime":"mp4");if(r.codecStrings.length>0){const i=[...new Set(r.codecStrings)];t+=`; codecs="${i.join(", ")}"`}return t};const Ir=8,ei=16,Vr=r=>{let e=ve(r);const t=Rt(r,4);let i=8;e===1&&(e=hr(r),i=16);const s=e-i;return s<0?null:{name:t,totalSize:e,headerSize:i,contentSize:s}},Xr=r=>ri(r)/65536,un=r=>ri(r)/1073741824,fn=r=>{let e=0;for(let t=0;t<4;t++){e<<=7;const i=Ce(r);if(e|=i&127,(i&128)===0)break}return e},vr=r=>{let e=Ot(r);return r.skip(2),e=Math.min(e,r.remainingLength),or.decode(Ue(r,e))},Ef=r=>{const e=Vr(r);if(!e||e.name!=="data"||r.remainingLength<8)return null;const t=ve(r);r.skip(4);const i=Ue(r,e.contentSize-8);switch(t){case 1:return or.decode(i);case 2:return new TextDecoder("utf-16be").decode(i);case 13:return new Ci(i,"image/jpeg");case 14:return new Ci(i,"image/png");case 27:return new Ci(i,"image/bmp");default:return i}};class If extends si{constructor(e){super(e),this.moovSlice=null,this.currentTrack=null,this.tracks=[],this.metadataPromise=null,this.movieTimescale=-1,this.movieDurationInTimescale=-1,this.isQuickTime=!1,this.metadataTags={},this.currentMetadataKeys=null,this.isFragmented=!1,this.fragmentTrackDefaults=[],this.currentFragment=null,this.lastReadFragment=null,this.reader=e._reader}async computeDuration(){const e=await this.getTracks(),t=await Promise.all(e.map(i=>i.computeDuration()));return Math.max(0,...t)}async getTracks(){return await this.readMetadata(),this.tracks.map(e=>e.inputTrack)}async getMimeType(){await this.readMetadata();const e=await Promise.all(this.tracks.map(t=>t.inputTrack.getCodecParameterString()));return Lc({isQuickTime:this.isQuickTime,hasVideo:this.tracks.some(t=>t.info?.type==="video"),hasAudio:this.tracks.some(t=>t.info?.type==="audio"),codecStrings:e.filter(Boolean)})}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}readMetadata(){return this.metadataPromise??=(async()=>{let e=0;for(;;){let t=this.reader.requestSliceRange(e,Ir,ei);if(t instanceof Promise&&(t=await t),!t)break;const i=e,a=Vr(t);if(!a)break;if(a.name==="ftyp"){const s=Rt(t,4);this.isQuickTime=s==="qt  "}else if(a.name==="moov"){let s=this.reader.requestSlice(t.filePos,a.contentSize);if(s instanceof Promise&&(s=await s),!s)break;this.moovSlice=s,this.readContiguousBoxes(this.moovSlice),this.tracks.sort((n,o)=>Number(o.disposition.default)-Number(n.disposition.default));for(const n of this.tracks){const o=n.editListPreviousSegmentDurations/this.movieTimescale;n.editListOffset-=Math.round(o*n.timescale)}break}e=i+a.totalSize}if(this.isFragmented&&this.reader.fileSize!==null){let t=this.reader.requestSlice(this.reader.fileSize-4,4);t instanceof Promise&&(t=await t),I(t);const i=ve(t),a=this.reader.fileSize-i;if(a>=0&&a<=this.reader.fileSize-ei){let s=this.reader.requestSliceRange(a,Ir,ei);if(s instanceof Promise&&(s=await s),s){const n=Vr(s);if(n&&n.name==="mfra"){let o=this.reader.requestSlice(s.filePos,n.contentSize);o instanceof Promise&&(o=await o),o&&this.readContiguousBoxes(o)}}}}})()}getSampleTableForTrack(e){if(e.sampleTable)return e.sampleTable;const t={sampleTimingEntries:[],sampleCompositionTimeOffsets:[],sampleSizes:[],keySampleIndices:null,chunkOffsets:[],sampleToChunk:[],presentationTimestamps:null,presentationTimestampIndexMap:null};e.sampleTable=t,I(this.moovSlice);const i=this.moovSlice.slice(e.sampleTableByteOffset);if(this.currentTrack=e,this.traverseBox(i),this.currentTrack=null,e.info?.type==="audio"&&e.info.codec&&Dt.includes(e.info.codec)&&t.sampleCompositionTimeOffsets.length===0){I(e.info?.type==="audio");const s=Br(e.info.codec),n=[],o=[];for(let c=0;c<t.sampleToChunk.length;c++){const l=t.sampleToChunk[c],d=t.sampleToChunk[c+1],u=(d?d.startChunkIndex:t.chunkOffsets.length)-l.startChunkIndex;for(let f=0;f<u;f++){const h=l.startSampleIndex+f*l.samplesPerChunk,g=h+l.samplesPerChunk,m=lt(t.sampleTimingEntries,h,D=>D.startIndex),v=t.sampleTimingEntries[m],p=lt(t.sampleTimingEntries,g,D=>D.startIndex),b=t.sampleTimingEntries[p],y=v.startDecodeTimestamp+(h-v.startIndex)*v.delta,S=b.startDecodeTimestamp+(g-b.startIndex)*b.delta-y,A=Ct(n);A&&A.delta===S?A.count++:n.push({startIndex:l.startChunkIndex+f,startDecodeTimestamp:y,count:1,delta:S});const z=l.samplesPerChunk*s.sampleSize*e.info.numberOfChannels;o.push(z)}l.startSampleIndex=l.startChunkIndex,l.samplesPerChunk=1}t.sampleTimingEntries=n,t.sampleSizes=o}if(t.sampleCompositionTimeOffsets.length>0){t.presentationTimestamps=[];for(const s of t.sampleTimingEntries)for(let n=0;n<s.count;n++)t.presentationTimestamps.push({presentationTimestamp:s.startDecodeTimestamp+n*s.delta,sampleIndex:s.startIndex+n});for(const s of t.sampleCompositionTimeOffsets)for(let n=0;n<s.count;n++){const o=s.startIndex+n,c=t.presentationTimestamps[o];c&&(c.presentationTimestamp+=s.offset)}t.presentationTimestamps.sort((s,n)=>s.presentationTimestamp-n.presentationTimestamp),t.presentationTimestampIndexMap=Array(t.presentationTimestamps.length).fill(-1);for(let s=0;s<t.presentationTimestamps.length;s++)t.presentationTimestampIndexMap[t.presentationTimestamps[s].sampleIndex]=s}return t}async readFragment(e){if(this.lastReadFragment?.moofOffset===e)return this.lastReadFragment;let t=this.reader.requestSliceRange(e,Ir,ei);t instanceof Promise&&(t=await t),I(t);const i=Vr(t);I(i?.name==="moof");let a=this.reader.requestSlice(e,i.totalSize);a instanceof Promise&&(a=await a),I(a),this.traverseBox(a);const s=this.lastReadFragment;I(s&&s.moofOffset===e);for(const[,n]of s.trackData){const o=n.track,{fragmentPositionCache:c}=o;if(!n.startTimestampIsFinal){const d=o.fragmentLookupTable.find(u=>u.moofOffset===s.moofOffset);if(d)hn(n,d.timestamp);else{const u=lt(c,s.moofOffset-1,f=>f.moofOffset);if(u!==-1){const f=c[u];hn(n,f.endTimestamp)}}n.startTimestampIsFinal=!0}const l=lt(c,n.startTimestamp,d=>d.startTimestamp);(l===-1||c[l].moofOffset!==s.moofOffset)&&c.splice(l+1,0,{moofOffset:s.moofOffset,startTimestamp:n.startTimestamp,endTimestamp:n.endTimestamp})}return s}readContiguousBoxes(e){const t=e.filePos;for(;e.filePos-t<=e.length-Ir&&this.traverseBox(e););}*iterateContiguousBoxes(e){const t=e.filePos;for(;e.filePos-t<=e.length-Ir;){const i=e.filePos,a=Vr(e);if(!a)break;yield{boxInfo:a,slice:e},e.filePos=i+a.totalSize}}traverseBox(e){const t=e.filePos,i=Vr(e);if(!i)return!1;const a=e.filePos,s=t+i.totalSize;switch(i.name){case"mdia":case"minf":case"dinf":case"mfra":case"edts":this.readContiguousBoxes(e.slice(a,i.contentSize));break;case"mvhd":{const n=Ce(e);e.skip(3),n===1?(e.skip(16),this.movieTimescale=ve(e),this.movieDurationInTimescale=hr(e)):(e.skip(8),this.movieTimescale=ve(e),this.movieDurationInTimescale=ve(e))}break;case"trak":{const n={id:-1,demuxer:this,inputTrack:null,disposition:{...ni},info:null,timescale:-1,durationInMovieTimescale:-1,durationInMediaTimescale:-1,rotation:0,internalCodecId:null,name:null,languageCode:er,sampleTableByteOffset:-1,sampleTable:null,fragmentLookupTable:[],currentFragmentState:null,fragmentPositionCache:[],editListPreviousSegmentDurations:0,editListOffset:0};if(this.currentTrack=n,this.readContiguousBoxes(e.slice(a,i.contentSize)),n.id!==-1&&n.timescale!==-1&&n.info!==null){if(n.info.type==="video"&&n.info.width!==-1){const o=n;n.inputTrack=new ma(this.input,new Af(o)),this.tracks.push(n)}else if(n.info.type==="audio"&&n.info.numberOfChannels!==-1){const o=n;n.inputTrack=new Mr(this.input,new Ff(o)),this.tracks.push(n)}}this.currentTrack=null}break;case"tkhd":{const n=this.currentTrack;if(!n)break;const o=Ce(e),l=!!(mi(e)&1);if(n.disposition.default=l,o===0)e.skip(8),n.id=ve(e),e.skip(4),n.durationInMovieTimescale=ve(e);else if(o===1)e.skip(16),n.id=ve(e),e.skip(4),n.durationInMovieTimescale=hr(e);else throw new Error(`Incorrect track header version ${o}.`);e.skip(16);const d=[Xr(e),Xr(e),un(e),Xr(e),Xr(e),un(e),Xr(e),Xr(e),un(e)],u=Ha(Rn(Rf(d),90));I(u===0||u===90||u===180||u===270),n.rotation=u}break;case"elst":{const n=this.currentTrack;if(!n)break;const o=Ce(e);e.skip(3);let c=!1,l=0;const d=ve(e);for(let u=0;u<d;u++){const f=o===1?hr(e):ve(e),h=o===1?Wh(e):ri(e),g=Xr(e);if(f!==0){if(c){console.warn("Unsupported edit list: multiple edits are not currently supported. Only using first edit.");break}if(h===-1){l+=f;continue}if(g!==1){console.warn("Unsupported edit list entry: media rate must be 1.");break}n.editListPreviousSegmentDurations=l,n.editListOffset=h,c=!0}}}break;case"mdhd":{const n=this.currentTrack;if(!n)break;const o=Ce(e);e.skip(3),o===0?(e.skip(8),n.timescale=ve(e),n.durationInMediaTimescale=ve(e)):o===1&&(e.skip(16),n.timescale=ve(e),n.durationInMediaTimescale=hr(e));let c=Ot(e);if(c>0){n.languageCode="";for(let l=0;l<3;l++)n.languageCode=String.fromCharCode(96+(c&31))+n.languageCode,c>>=5;sa(n.languageCode)||(n.languageCode=er)}}break;case"hdlr":{const n=this.currentTrack;if(!n)break;e.skip(8);const o=Rt(e,4);o==="vide"?n.info={type:"video",width:-1,height:-1,codec:null,codecDescription:null,colorSpace:null,avcType:null,avcCodecInfo:null,hevcCodecInfo:null,vp9CodecInfo:null,av1CodecInfo:null}:o==="soun"&&(n.info={type:"audio",numberOfChannels:-1,sampleRate:-1,codec:null,codecDescription:null,aacCodecInfo:null})}break;case"stbl":{const n=this.currentTrack;if(!n)break;n.sampleTableByteOffset=t,this.readContiguousBoxes(e.slice(a,i.contentSize))}break;case"stsd":{const n=this.currentTrack;if(!n||n.info===null||n.sampleTable)break;const o=Ce(e);e.skip(3);const c=ve(e);for(let l=0;l<c;l++){const d=e.filePos,u=Vr(e);if(!u)break;n.internalCodecId=u.name;const f=u.name.toLowerCase();if(n.info.type==="video")f==="avc1"||f==="avc3"?(n.info.codec="avc",n.info.avcType=f==="avc1"?1:3):f==="hvc1"||f==="hev1"?n.info.codec="hevc":f==="vp08"?n.info.codec="vp8":f==="vp09"?n.info.codec="vp9":f==="av01"?n.info.codec="av1":console.warn(`Unsupported video codec (sample entry type '${u.name}').`),e.skip(24),n.info.width=Ot(e),n.info.height=Ot(e),e.skip(50),this.readContiguousBoxes(e.slice(e.filePos,d+u.totalSize-e.filePos));else{f==="mp4a"||(f==="opus"?n.info.codec="opus":f==="flac"?n.info.codec="flac":f==="twos"||f==="sowt"||f==="raw "||f==="in24"||f==="in32"||f==="fl32"||f==="fl64"||f==="lpcm"||f==="ipcm"||f==="fpcm"||(f==="ulaw"?n.info.codec="ulaw":f==="alaw"?n.info.codec="alaw":console.warn(`Unsupported audio codec (sample entry type '${u.name}').`))),e.skip(8);const h=Ot(e);e.skip(6);let g=Ot(e),m=Ot(e);e.skip(4);let v=ve(e)/65536;if(o===0&&h>0){if(h===1)e.skip(4),m=8*ve(e),e.skip(8);else if(h===2){e.skip(4),v=al(e),g=ve(e),e.skip(4),m=ve(e);const p=ve(e);if(e.skip(8),f==="lpcm"){const b=m+7>>3,y=!!(p&1),_=!!(p&2),S=p&4?-1:0;m>0&&m<=64&&(y?m===32&&(n.info.codec=_?"pcm-f32be":"pcm-f32"):S&1<<b-1?b===1?n.info.codec="pcm-s8":b===2?n.info.codec=_?"pcm-s16be":"pcm-s16":b===3?n.info.codec=_?"pcm-s24be":"pcm-s24":b===4&&(n.info.codec=_?"pcm-s32be":"pcm-s32"):b===1&&(n.info.codec="pcm-u8")),n.info.codec===null&&console.warn("Unsupported PCM format.")}}}n.info.codec==="opus"&&(v=fa),n.info.numberOfChannels=g,n.info.sampleRate=v,f==="twos"?m===8?n.info.codec="pcm-s8":m===16?n.info.codec="pcm-s16be":(console.warn(`Unsupported sample size ${m} for codec 'twos'.`),n.info.codec=null):f==="sowt"?m===8?n.info.codec="pcm-s8":m===16?n.info.codec="pcm-s16":(console.warn(`Unsupported sample size ${m} for codec 'sowt'.`),n.info.codec=null):f==="raw "?n.info.codec="pcm-u8":f==="in24"?n.info.codec="pcm-s24be":f==="in32"?n.info.codec="pcm-s32be":f==="fl32"?n.info.codec="pcm-f32be":f==="fl64"?n.info.codec="pcm-f64be":f==="ipcm"?n.info.codec="pcm-s16be":f==="fpcm"&&(n.info.codec="pcm-f32be"),this.readContiguousBoxes(e.slice(e.filePos,d+u.totalSize-e.filePos))}}}break;case"avcC":{const n=this.currentTrack;if(!n)break;I(n.info),n.info.codecDescription=Ue(e,i.contentSize)}break;case"hvcC":{const n=this.currentTrack;if(!n)break;I(n.info),n.info.codecDescription=Ue(e,i.contentSize)}break;case"vpcC":{const n=this.currentTrack;if(!n)break;I(n.info?.type==="video"),e.skip(4);const o=Ce(e),c=Ce(e),l=Ce(e),d=l>>4,u=l>>1&7,f=l&1,h=Ce(e),g=Ce(e),m=Ce(e);n.info.vp9CodecInfo={profile:o,level:c,bitDepth:d,chromaSubsampling:u,videoFullRangeFlag:f,colourPrimaries:h,transferCharacteristics:g,matrixCoefficients:m}}break;case"av1C":{const n=this.currentTrack;if(!n)break;I(n.info?.type==="video"),e.skip(1);const o=Ce(e),c=o>>5,l=o&31,d=Ce(e),u=d>>7,f=d>>6&1,h=d>>5&1,g=d>>4&1,m=d>>3&1,v=d>>2&1,p=d&3,b=c===2&&f?h?12:10:f?10:8;n.info.av1CodecInfo={profile:c,level:l,tier:u,bitDepth:b,monochrome:g,chromaSubsamplingX:m,chromaSubsamplingY:v,chromaSamplePosition:p}}break;case"colr":{const n=this.currentTrack;if(!n||(I(n.info?.type==="video"),Rt(e,4)!=="nclx"))break;const c=Ot(e),l=Ot(e),d=Ot(e),u=!!(Ce(e)&128);n.info.colorSpace={primaries:oc[c],transfer:cc[l],matrix:lc[d],fullRange:u}}break;case"wave":this.readContiguousBoxes(e.slice(a,i.contentSize));break;case"esds":{const n=this.currentTrack;if(!n)break;I(n.info?.type==="audio"),e.skip(4);const o=Ce(e);I(o===3),fn(e),e.skip(2);const c=Ce(e),l=(c&128)!==0,d=(c&64)!==0,u=(c&32)!==0;if(l&&e.skip(2),d){const v=Ce(e);e.skip(v)}u&&e.skip(2);const f=Ce(e);I(f===4);const h=fn(e),g=e.filePos,m=Ce(e);if(m===64||m===103?(n.info.codec="aac",n.info.aacCodecInfo={isMpeg2:m===103}):m===105||m===107?n.info.codec="mp3":m===221?n.info.codec="vorbis":console.warn(`Unsupported audio codec (objectTypeIndication ${m}) - discarding track.`),e.skip(12),h>e.filePos-g){const v=Ce(e);I(v===5);const p=fn(e);if(n.info.codecDescription=Ue(e,p),n.info.codec==="aac"){const b=ps(n.info.codecDescription);b.numberOfChannels!==null&&(n.info.numberOfChannels=b.numberOfChannels),b.sampleRate!==null&&(n.info.sampleRate=b.sampleRate)}}}break;case"enda":{const n=this.currentTrack;if(!n)break;I(n.info?.type==="audio"),Ot(e)&255&&(n.info.codec==="pcm-s16be"?n.info.codec="pcm-s16":n.info.codec==="pcm-s24be"?n.info.codec="pcm-s24":n.info.codec==="pcm-s32be"?n.info.codec="pcm-s32":n.info.codec==="pcm-f32be"?n.info.codec="pcm-f32":n.info.codec==="pcm-f64be"&&(n.info.codec="pcm-f64"))}break;case"pcmC":{const n=this.currentTrack;if(!n)break;I(n.info?.type==="audio"),e.skip(4);const c=!!(Ce(e)&1),l=Ce(e);n.info.codec==="pcm-s16be"?c?l===16?n.info.codec="pcm-s16":l===24?n.info.codec="pcm-s24":l===32?n.info.codec="pcm-s32":(console.warn(`Invalid ipcm sample size ${l}.`),n.info.codec=null):l===16?n.info.codec="pcm-s16be":l===24?n.info.codec="pcm-s24be":l===32?n.info.codec="pcm-s32be":(console.warn(`Invalid ipcm sample size ${l}.`),n.info.codec=null):n.info.codec==="pcm-f32be"&&(c?l===32?n.info.codec="pcm-f32":l===64?n.info.codec="pcm-f64":(console.warn(`Invalid fpcm sample size ${l}.`),n.info.codec=null):l===32?n.info.codec="pcm-f32be":l===64?n.info.codec="pcm-f64be":(console.warn(`Invalid fpcm sample size ${l}.`),n.info.codec=null));break}case"dOps":{const n=this.currentTrack;if(!n)break;I(n.info?.type==="audio"),e.skip(1);const o=Ce(e),c=Ot(e),l=ve(e),d=Zn(e),u=Ce(e);let f;u!==0?f=Ue(e,2+o):f=new Uint8Array(0);const h=new Uint8Array(19+f.byteLength),g=new DataView(h.buffer);g.setUint32(0,1332770163,!1),g.setUint32(4,1214603620,!1),g.setUint8(8,1),g.setUint8(9,o),g.setUint16(10,c,!0),g.setUint32(12,l,!0),g.setInt16(16,d,!0),g.setUint8(18,u),h.set(f,19),n.info.codecDescription=h,n.info.numberOfChannels=o}break;case"dfLa":{const n=this.currentTrack;if(!n)break;I(n.info?.type==="audio"),e.skip(4);const o=127,c=128,l=e.filePos;for(;e.filePos<s;){const g=Ce(e),m=mi(e);if((g&o)===Ii.STREAMINFO){e.skip(10);const p=ve(e),b=p>>>12,y=(p>>9&7)+1;n.info.sampleRate=b,n.info.numberOfChannels=y,e.skip(20)}else e.skip(m);if(g&c)break}const d=e.filePos;e.filePos=l;const u=Ue(e,d-l),f=new Uint8Array(4+u.byteLength);new DataView(f.buffer).setUint32(0,1716281667,!1),f.set(u,4),n.info.codecDescription=f}break;case"stts":{const n=this.currentTrack;if(!n||!n.sampleTable)break;e.skip(4);const o=ve(e);let c=0,l=0;for(let d=0;d<o;d++){const u=ve(e),f=ve(e);n.sampleTable.sampleTimingEntries.push({startIndex:c,startDecodeTimestamp:l,count:u,delta:f}),c+=u,l+=u*f}}break;case"ctts":{const n=this.currentTrack;if(!n||!n.sampleTable)break;e.skip(4);const o=ve(e);let c=0;for(let l=0;l<o;l++){const d=ve(e),u=ri(e);n.sampleTable.sampleCompositionTimeOffsets.push({startIndex:c,count:d,offset:u}),c+=d}}break;case"stsz":{const n=this.currentTrack;if(!n||!n.sampleTable)break;e.skip(4);const o=ve(e),c=ve(e);if(o===0)for(let l=0;l<c;l++){const d=ve(e);n.sampleTable.sampleSizes.push(d)}else n.sampleTable.sampleSizes.push(o)}break;case"stz2":{const n=this.currentTrack;if(!n||!n.sampleTable)break;e.skip(4),e.skip(3);const o=Ce(e),c=ve(e),l=Ue(e,Math.ceil(c*o/8)),d=new bt(l);for(let u=0;u<c;u++){const f=d.readBits(o);n.sampleTable.sampleSizes.push(f)}}break;case"stss":{const n=this.currentTrack;if(!n||!n.sampleTable)break;e.skip(4),n.sampleTable.keySampleIndices=[];const o=ve(e);for(let c=0;c<o;c++){const l=ve(e)-1;n.sampleTable.keySampleIndices.push(l)}n.sampleTable.keySampleIndices[0]!==0&&n.sampleTable.keySampleIndices.unshift(0)}break;case"stsc":{const n=this.currentTrack;if(!n||!n.sampleTable)break;e.skip(4);const o=ve(e);for(let l=0;l<o;l++){const d=ve(e)-1,u=ve(e),f=ve(e);n.sampleTable.sampleToChunk.push({startSampleIndex:-1,startChunkIndex:d,samplesPerChunk:u,sampleDescriptionIndex:f})}let c=0;for(let l=0;l<n.sampleTable.sampleToChunk.length;l++)if(n.sampleTable.sampleToChunk[l].startSampleIndex=c,l<n.sampleTable.sampleToChunk.length-1){const u=n.sampleTable.sampleToChunk[l+1].startChunkIndex-n.sampleTable.sampleToChunk[l].startChunkIndex;c+=u*n.sampleTable.sampleToChunk[l].samplesPerChunk}}break;case"stco":{const n=this.currentTrack;if(!n||!n.sampleTable)break;e.skip(4);const o=ve(e);for(let c=0;c<o;c++){const l=ve(e);n.sampleTable.chunkOffsets.push(l)}}break;case"co64":{const n=this.currentTrack;if(!n||!n.sampleTable)break;e.skip(4);const o=ve(e);for(let c=0;c<o;c++){const l=hr(e);n.sampleTable.chunkOffsets.push(l)}}break;case"mvex":this.isFragmented=!0,this.readContiguousBoxes(e.slice(a,i.contentSize));break;case"mehd":{const n=Ce(e);e.skip(3);const o=n===1?hr(e):ve(e);this.movieDurationInTimescale=o}break;case"trex":{e.skip(4);const n=ve(e),o=ve(e),c=ve(e),l=ve(e),d=ve(e);this.fragmentTrackDefaults.push({trackId:n,defaultSampleDescriptionIndex:o,defaultSampleDuration:c,defaultSampleSize:l,defaultSampleFlags:d})}break;case"tfra":{const n=Ce(e);e.skip(3);const o=ve(e),c=this.tracks.find(b=>b.id===o);if(!c)break;const l=ve(e),d=(l&48)>>4,u=(l&12)>>2,f=l&3,h=[Ce,Ot,mi,ve],g=h[d],m=h[u],v=h[f],p=ve(e);for(let b=0;b<p;b++){const y=n===1?hr(e):ve(e),_=n===1?hr(e):ve(e);g(e),m(e),v(e),c.fragmentLookupTable.push({timestamp:y,moofOffset:_})}c.fragmentLookupTable.sort((b,y)=>b.timestamp-y.timestamp);for(let b=0;b<c.fragmentLookupTable.length-1;b++){const y=c.fragmentLookupTable[b],_=c.fragmentLookupTable[b+1];y.timestamp===_.timestamp&&(c.fragmentLookupTable.splice(b+1,1),b--)}}break;case"moof":this.currentFragment={moofOffset:t,moofSize:i.totalSize,implicitBaseDataOffset:t,trackData:new Map},this.readContiguousBoxes(e.slice(a,i.contentSize)),this.lastReadFragment=this.currentFragment,this.currentFragment=null;break;case"traf":if(I(this.currentFragment),this.readContiguousBoxes(e.slice(a,i.contentSize)),this.currentTrack){const n=this.currentFragment.trackData.get(this.currentTrack.id);if(n){const{currentFragmentState:o}=this.currentTrack;I(o),o.startTimestamp!==null&&(hn(n,o.startTimestamp),n.startTimestampIsFinal=!0)}this.currentTrack.currentFragmentState=null,this.currentTrack=null}break;case"tfhd":{I(this.currentFragment),e.skip(1);const n=mi(e),o=!!(n&1),c=!!(n&2),l=!!(n&8),d=!!(n&16),u=!!(n&32),f=!!(n&65536),h=!!(n&131072),g=ve(e),m=this.tracks.find(p=>p.id===g);if(!m)break;const v=this.fragmentTrackDefaults.find(p=>p.trackId===g);this.currentTrack=m,m.currentFragmentState={baseDataOffset:this.currentFragment.implicitBaseDataOffset,sampleDescriptionIndex:v?.defaultSampleDescriptionIndex??null,defaultSampleDuration:v?.defaultSampleDuration??null,defaultSampleSize:v?.defaultSampleSize??null,defaultSampleFlags:v?.defaultSampleFlags??null,startTimestamp:null},o?m.currentFragmentState.baseDataOffset=hr(e):h&&(m.currentFragmentState.baseDataOffset=this.currentFragment.moofOffset),c&&(m.currentFragmentState.sampleDescriptionIndex=ve(e)),l&&(m.currentFragmentState.defaultSampleDuration=ve(e)),d&&(m.currentFragmentState.defaultSampleSize=ve(e)),u&&(m.currentFragmentState.defaultSampleFlags=ve(e)),f&&(m.currentFragmentState.defaultSampleDuration=0)}break;case"tfdt":{const n=this.currentTrack;if(!n)break;I(n.currentFragmentState);const o=Ce(e);e.skip(3);const c=o===0?ve(e):hr(e);n.currentFragmentState.startTimestamp=c}break;case"trun":{const n=this.currentTrack;if(!n)break;if(I(this.currentFragment),I(n.currentFragmentState),this.currentFragment.trackData.has(n.id)){console.warn("Can't have two trun boxes for the same track in one fragment. Ignoring...");break}const o=Ce(e),c=mi(e),l=!!(c&1),d=!!(c&4),u=!!(c&256),f=!!(c&512),h=!!(c&1024),g=!!(c&2048),m=ve(e);let v=n.currentFragmentState.baseDataOffset;l&&(v+=ri(e));let p=null;d&&(p=ve(e));let b=v;if(m===0){this.currentFragment.implicitBaseDataOffset=b;break}let y=0;const _={track:n,startTimestamp:0,endTimestamp:0,firstKeyFrameTimestamp:null,samples:[],presentationTimestamps:[],startTimestampIsFinal:!1};this.currentFragment.trackData.set(n.id,_);for(let z=0;z<m;z++){let D;u?D=ve(e):(I(n.currentFragmentState.defaultSampleDuration!==null),D=n.currentFragmentState.defaultSampleDuration);let M;f?M=ve(e):(I(n.currentFragmentState.defaultSampleSize!==null),M=n.currentFragmentState.defaultSampleSize);let $;h?$=ve(e):(I(n.currentFragmentState.defaultSampleFlags!==null),$=n.currentFragmentState.defaultSampleFlags),z===0&&p!==null&&($=p);let K=0;g&&(o===0?K=ve(e):K=ri(e));const P=!($&65536);_.samples.push({presentationTimestamp:y+K,duration:D,byteOffset:b,byteSize:M,isKeyFrame:P}),b+=M,y+=D}_.presentationTimestamps=_.samples.map((z,D)=>({presentationTimestamp:z.presentationTimestamp,sampleIndex:D})).sort((z,D)=>z.presentationTimestamp-D.presentationTimestamp);for(let z=0;z<_.presentationTimestamps.length;z++){const D=_.presentationTimestamps[z],M=_.samples[D.sampleIndex];if(_.firstKeyFrameTimestamp===null&&M.isKeyFrame&&(_.firstKeyFrameTimestamp=M.presentationTimestamp),z<_.presentationTimestamps.length-1){const $=_.presentationTimestamps[z+1];M.duration=$.presentationTimestamp-D.presentationTimestamp}}const S=_.samples[_.presentationTimestamps[0].sampleIndex],A=_.samples[Ct(_.presentationTimestamps).sampleIndex];_.startTimestamp=S.presentationTimestamp,_.endTimestamp=A.presentationTimestamp+A.duration,this.currentFragment.implicitBaseDataOffset=b}break;case"udta":{const n=this.iterateContiguousBoxes(e.slice(a,i.contentSize));for(const{boxInfo:o,slice:c}of n){if(o.name!=="meta"&&!this.currentTrack){const l=c.filePos;this.metadataTags.raw??={},o.name[0]==="Â©"?this.metadataTags.raw[o.name]??=vr(c):this.metadataTags.raw[o.name]??=Ue(c,o.contentSize),c.filePos=l}switch(o.name){case"meta":c.skip(-o.headerSize),this.traverseBox(c);break;case"Â©nam":case"name":this.currentTrack?this.currentTrack.name=or.decode(Ue(c,o.contentSize)):this.metadataTags.title??=vr(c);break;case"Â©des":this.currentTrack||(this.metadataTags.description??=vr(c));break;case"Â©ART":this.currentTrack||(this.metadataTags.artist??=vr(c));break;case"Â©alb":this.currentTrack||(this.metadataTags.album??=vr(c));break;case"albr":this.currentTrack||(this.metadataTags.albumArtist??=vr(c));break;case"Â©gen":this.currentTrack||(this.metadataTags.genre??=vr(c));break;case"Â©day":if(!this.currentTrack){const l=new Date(vr(c));Number.isNaN(l.getTime())||(this.metadataTags.date??=l)}break;case"Â©cmt":this.currentTrack||(this.metadataTags.comment??=vr(c));break;case"Â©lyr":this.currentTrack||(this.metadataTags.lyrics??=vr(c));break}}}break;case"meta":{if(this.currentTrack)break;const o=ve(e)!==0;this.currentMetadataKeys=new Map,o?this.readContiguousBoxes(e.slice(a,i.contentSize)):this.readContiguousBoxes(e.slice(a+4,i.contentSize-4)),this.currentMetadataKeys=null}break;case"keys":{if(!this.currentMetadataKeys)break;e.skip(4);const n=ve(e);for(let o=0;o<n;o++){const c=ve(e);e.skip(4);const l=or.decode(Ue(e,c-8));this.currentMetadataKeys.set(o+1,l)}}break;case"ilst":{if(!this.currentMetadataKeys)break;const n=this.iterateContiguousBoxes(e.slice(a,i.contentSize));for(const{boxInfo:o,slice:c}of n){let l=o.name;const d=(l.charCodeAt(0)<<24)+(l.charCodeAt(1)<<16)+(l.charCodeAt(2)<<8)+l.charCodeAt(3);this.currentMetadataKeys.has(d)&&(l=this.currentMetadataKeys.get(d));const u=Ef(c);switch(this.metadataTags.raw??={},this.metadataTags.raw[l]??=u,l){case"Â©nam":case"titl":case"com.apple.quicktime.title":case"title":typeof u=="string"&&(this.metadataTags.title??=u);break;case"Â©des":case"desc":case"dscp":case"com.apple.quicktime.description":case"description":typeof u=="string"&&(this.metadataTags.description??=u);break;case"Â©ART":case"com.apple.quicktime.artist":case"artist":typeof u=="string"&&(this.metadataTags.artist??=u);break;case"Â©alb":case"albm":case"com.apple.quicktime.album":case"album":typeof u=="string"&&(this.metadataTags.album??=u);break;case"aART":case"album_artist":typeof u=="string"&&(this.metadataTags.albumArtist??=u);break;case"Â©cmt":case"com.apple.quicktime.comment":case"comment":typeof u=="string"&&(this.metadataTags.comment??=u);break;case"Â©gen":case"gnre":case"com.apple.quicktime.genre":case"genre":typeof u=="string"&&(this.metadataTags.genre??=u);break;case"Â©lyr":case"lyrics":typeof u=="string"&&(this.metadataTags.lyrics??=u);break;case"Â©day":case"rldt":case"com.apple.quicktime.creationdate":case"date":if(typeof u=="string"){const f=new Date(u);Number.isNaN(f.getTime())||(this.metadataTags.date??=f)}break;case"covr":case"com.apple.quicktime.artwork":u instanceof Ci?(this.metadataTags.images??=[],this.metadataTags.images.push({data:u.data,kind:"coverFront",mimeType:u.mimeType})):u instanceof Uint8Array&&(this.metadataTags.images??=[],this.metadataTags.images.push({data:u,kind:"coverFront",mimeType:"image/*"}));break;case"track":if(typeof u=="string"){const f=u.split("/"),h=Number.parseInt(f[0],10),g=f[1]&&Number.parseInt(f[1],10);Number.isInteger(h)&&h>0&&(this.metadataTags.trackNumber??=h),g&&Number.isInteger(g)&&g>0&&(this.metadataTags.tracksTotal??=g)}break;case"trkn":if(u instanceof Uint8Array&&u.length>=6){const f=kt(u),h=f.getUint16(2,!1),g=f.getUint16(4,!1);h>0&&(this.metadataTags.trackNumber??=h),g>0&&(this.metadataTags.tracksTotal??=g)}break;case"disc":case"disk":if(u instanceof Uint8Array&&u.length>=6){const f=kt(u),h=f.getUint16(2,!1),g=f.getUint16(4,!1);h>0&&(this.metadataTags.discNumber??=h),g>0&&(this.metadataTags.discsTotal??=g)}break}}}break}return e.filePos=s,!0}}class $c{constructor(e){this.internalTrack=e,this.packetToSampleIndex=new WeakMap,this.packetToFragmentLocation=new WeakMap}getId(){return this.internalTrack.id}getCodec(){throw new Error("Not implemented on base class.")}getInternalCodecId(){return this.internalTrack.internalCodecId}getName(){return this.internalTrack.name}getLanguageCode(){return this.internalTrack.languageCode}getTimeResolution(){return this.internalTrack.timescale}getDisposition(){return this.internalTrack.disposition}async computeDuration(){const e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}async getFirstTimestamp(){return(await this.getFirstPacket({metadataOnly:!0}))?.timestamp??0}async getFirstPacket(e){const t=await this.fetchPacketForSampleIndex(0,e);return t||!this.internalTrack.demuxer.isFragmented?t:this.performFragmentedLookup(null,i=>i.trackData.get(this.internalTrack.id)?{sampleIndex:0,correctSampleFound:!0}:{sampleIndex:-1,correctSampleFound:!1},-1/0,1/0,e)}mapTimestampIntoTimescale(e){return Ma(e*this.internalTrack.timescale)+this.internalTrack.editListOffset}async getPacket(e,t){const i=this.mapTimestampIntoTimescale(e),a=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),s=$n(a,i),n=await this.fetchPacketForSampleIndex(s,t);return!go(a)||!this.internalTrack.demuxer.isFragmented?n:this.performFragmentedLookup(null,o=>{const c=o.trackData.get(this.internalTrack.id);if(!c)return{sampleIndex:-1,correctSampleFound:!1};const l=lt(c.presentationTimestamps,i,f=>f.presentationTimestamp),d=l!==-1?c.presentationTimestamps[l].sampleIndex:-1,u=l!==-1&&i<c.endTimestamp;return{sampleIndex:d,correctSampleFound:u}},i,i,t)}async getNextPacket(e,t){const i=this.packetToSampleIndex.get(e);if(i!==void 0)return this.fetchPacketForSampleIndex(i+1,t);const a=this.packetToFragmentLocation.get(e);if(a===void 0)throw new Error("Packet was not created from this track.");return this.performFragmentedLookup(a.fragment,s=>{if(s===a.fragment){const n=s.trackData.get(this.internalTrack.id);if(a.sampleIndex+1<n.samples.length)return{sampleIndex:a.sampleIndex+1,correctSampleFound:!0}}else if(s.trackData.get(this.internalTrack.id))return{sampleIndex:0,correctSampleFound:!0};return{sampleIndex:-1,correctSampleFound:!1}},-1/0,1/0,t)}async getKeyPacket(e,t){const i=this.mapTimestampIntoTimescale(e),a=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),s=zf(a,i),n=await this.fetchPacketForSampleIndex(s,t);return!go(a)||!this.internalTrack.demuxer.isFragmented?n:this.performFragmentedLookup(null,o=>{const c=o.trackData.get(this.internalTrack.id);if(!c)return{sampleIndex:-1,correctSampleFound:!1};const l=fc(c.presentationTimestamps,f=>c.samples[f.sampleIndex].isKeyFrame&&f.presentationTimestamp<=i),d=l!==-1?c.presentationTimestamps[l].sampleIndex:-1,u=l!==-1&&i<c.endTimestamp;return{sampleIndex:d,correctSampleFound:u}},i,i,t)}async getNextKeyPacket(e,t){const i=this.packetToSampleIndex.get(e);if(i!==void 0){const s=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),n=Mf(s,i);return this.fetchPacketForSampleIndex(n,t)}const a=this.packetToFragmentLocation.get(e);if(a===void 0)throw new Error("Packet was not created from this track.");return this.performFragmentedLookup(a.fragment,s=>{if(s===a.fragment){const o=s.trackData.get(this.internalTrack.id).samples.findIndex((c,l)=>c.isKeyFrame&&l>a.sampleIndex);if(o!==-1)return{sampleIndex:o,correctSampleFound:!0}}else{const n=s.trackData.get(this.internalTrack.id);if(n&&n.firstKeyFrameTimestamp!==null){const o=n.samples.findIndex(c=>c.isKeyFrame);return I(o!==-1),{sampleIndex:o,correctSampleFound:!0}}}return{sampleIndex:-1,correctSampleFound:!1}},-1/0,1/0,t)}async fetchPacketForSampleIndex(e,t){if(e===-1)return null;const i=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),a=Bf(i,e);if(!a)return null;let s;if(t.metadataOnly)s=lr;else{let l=this.internalTrack.demuxer.reader.requestSlice(a.sampleOffset,a.sampleSize);l instanceof Promise&&(l=await l),I(l),s=Ue(l,a.sampleSize)}const n=(a.presentationTimestamp-this.internalTrack.editListOffset)/this.internalTrack.timescale,o=a.duration/this.internalTrack.timescale,c=new mt(s,a.isKeyFrame?"key":"delta",n,o,e,a.sampleSize);return this.packetToSampleIndex.set(c,e),c}async fetchPacketInFragment(e,t,i){if(t===-1)return null;const s=e.trackData.get(this.internalTrack.id).samples[t];I(s);let n;if(i.metadataOnly)n=lr;else{let d=this.internalTrack.demuxer.reader.requestSlice(s.byteOffset,s.byteSize);d instanceof Promise&&(d=await d),I(d),n=Ue(d,s.byteSize)}const o=(s.presentationTimestamp-this.internalTrack.editListOffset)/this.internalTrack.timescale,c=s.duration/this.internalTrack.timescale,l=new mt(n,s.isKeyFrame?"key":"delta",o,c,e.moofOffset+t,s.byteSize);return this.packetToFragmentLocation.set(l,{fragment:e,sampleIndex:t}),l}async performFragmentedLookup(e,t,i,a,s){const n=this.internalTrack.demuxer;let o=null,c=null,l=-1;if(e){const{sampleIndex:v,correctSampleFound:p}=t(e);if(p)return this.fetchPacketInFragment(e,v,s);v!==-1&&(c=e,l=v)}const d=lt(this.internalTrack.fragmentLookupTable,i,v=>v.timestamp),u=d!==-1?this.internalTrack.fragmentLookupTable[d]:null,f=lt(this.internalTrack.fragmentPositionCache,i,v=>v.startTimestamp),h=f!==-1?this.internalTrack.fragmentPositionCache[f]:null,g=Math.max(u?.moofOffset??0,h?.moofOffset??0)||null;let m;for(e?g===null||e.moofOffset>=g?(m=e.moofOffset+e.moofSize,o=e):m=g:m=g??0;;){if(o){const y=o.trackData.get(this.internalTrack.id);if(y&&y.startTimestamp>a)break}let v=n.reader.requestSliceRange(m,Ir,ei);if(v instanceof Promise&&(v=await v),!v)break;const p=m,b=Vr(v);if(!b)break;if(b.name==="moof"){o=await n.readFragment(p);const{sampleIndex:y,correctSampleFound:_}=t(o);if(_)return this.fetchPacketInFragment(o,y,s);y!==-1&&(c=o,l=y)}m=p+b.totalSize}if(u&&(!c||c.moofOffset<u.moofOffset)){const v=this.internalTrack.fragmentLookupTable[d-1];I(!v||v.timestamp<u.timestamp);const p=v?.timestamp??-1/0;return this.performFragmentedLookup(null,t,p,a,s)}return c?this.fetchPacketInFragment(c,l,s):null}}class Af extends $c{constructor(e){super(e),this.decoderConfigPromise=null,this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getCodedWidth(){return this.internalTrack.info.width}getCodedHeight(){return this.internalTrack.info.height}getRotation(){return this.internalTrack.rotation}async getColorSpace(){return{primaries:this.internalTrack.info.colorSpace?.primaries,transfer:this.internalTrack.info.colorSpace?.transfer,matrix:this.internalTrack.info.colorSpace?.matrix,fullRange:this.internalTrack.info.colorSpace?.fullRange}}async canBeTransparent(){return!1}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfigPromise??=(async()=>{if(this.internalTrack.info.codec==="vp9"&&!this.internalTrack.info.vp9CodecInfo){const e=await this.getFirstPacket({});this.internalTrack.info.vp9CodecInfo=e&&Fc(e.data)}else if(this.internalTrack.info.codec==="av1"&&!this.internalTrack.info.av1CodecInfo){const e=await this.getFirstPacket({});this.internalTrack.info.av1CodecInfo=e&&Bc(e.data)}return{codec:gc(this.internalTrack.info),codedWidth:this.internalTrack.info.width,codedHeight:this.internalTrack.info.height,description:this.internalTrack.info.codecDescription??void 0,colorSpace:this.internalTrack.info.colorSpace??void 0}})():null}}class Ff extends $c{constructor(e){super(e),this.decoderConfig=null,this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getNumberOfChannels(){return this.internalTrack.info.numberOfChannels}getSampleRate(){return this.internalTrack.info.sampleRate}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfig??={codec:vc(this.internalTrack.info),numberOfChannels:this.internalTrack.info.numberOfChannels,sampleRate:this.internalTrack.info.sampleRate,description:this.internalTrack.info.codecDescription??void 0}:null}}const $n=(r,e)=>{if(r.presentationTimestamps){const t=lt(r.presentationTimestamps,e,i=>i.presentationTimestamp);return t===-1?-1:r.presentationTimestamps[t].sampleIndex}else{const t=lt(r.sampleTimingEntries,e,a=>a.startDecodeTimestamp);if(t===-1)return-1;const i=r.sampleTimingEntries[t];return i.startIndex+Math.min(Math.floor((e-i.startDecodeTimestamp)/i.delta),i.count-1)}},zf=(r,e)=>{if(!r.keySampleIndices)return $n(r,e);if(r.presentationTimestamps){const t=lt(r.presentationTimestamps,e,i=>i.presentationTimestamp);if(t===-1)return-1;for(let i=t;i>=0;i--){const a=r.presentationTimestamps[i].sampleIndex;if(qa(r.keySampleIndices,a,n=>n)!==-1)return a}return-1}else{const t=$n(r,e),i=lt(r.keySampleIndices,t,a=>a);return r.keySampleIndices[i]??-1}},Bf=(r,e)=>{const t=lt(r.sampleTimingEntries,e,p=>p.startIndex),i=r.sampleTimingEntries[t];if(!i||i.startIndex+i.count<=e)return null;let s=i.startDecodeTimestamp+(e-i.startIndex)*i.delta;const n=lt(r.sampleCompositionTimeOffsets,e,p=>p.startIndex),o=r.sampleCompositionTimeOffsets[n];o&&e-o.startIndex<o.count&&(s+=o.offset);const c=r.sampleSizes[Math.min(e,r.sampleSizes.length-1)],l=lt(r.sampleToChunk,e,p=>p.startSampleIndex),d=r.sampleToChunk[l];I(d);const u=d.startChunkIndex+Math.floor((e-d.startSampleIndex)/d.samplesPerChunk),f=r.chunkOffsets[u],h=d.startSampleIndex+(u-d.startChunkIndex)*d.samplesPerChunk;let g=0,m=f;if(r.sampleSizes.length===1)m+=c*(e-h),g+=c*d.samplesPerChunk;else for(let p=h;p<h+d.samplesPerChunk;p++){const b=r.sampleSizes[p];p<e&&(m+=b),g+=b}let v=i.delta;if(r.presentationTimestamps){const p=r.presentationTimestampIndexMap[e];I(p!==void 0),p<r.presentationTimestamps.length-1&&(v=r.presentationTimestamps[p+1].presentationTimestamp-s)}return{presentationTimestamp:s,duration:v,sampleOffset:m,sampleSize:c,chunkOffset:f,chunkSize:g,isKeyFrame:r.keySampleIndices?qa(r.keySampleIndices,e,p=>p)!==-1:!0}},Mf=(r,e)=>{if(!r.keySampleIndices)return e+1;const t=lt(r.keySampleIndices,e,i=>i);return r.keySampleIndices[t+1]??-1},hn=(r,e)=>{r.startTimestamp+=e,r.endTimestamp+=e;for(const t of r.samples)t.presentationTimestamp+=e;for(const t of r.presentationTimestamps)t.presentationTimestamp+=e},Rf=r=>{const[e,,,t]=r,i=Math.hypot(e,t),a=e/i,s=t/i,n=-Math.atan2(s,a)*(180/Math.PI);return Number.isFinite(n)?n:0},go=r=>r.sampleSizes.length===0;class Wn{constructor(e){this.value=e}}class Hn{constructor(e){this.value=e}}class Wc{constructor(e){this.value=e}}class Nr{constructor(e){this.value=e}}var N;(function(r){r[r.EBML=440786851]="EBML",r[r.EBMLVersion=17030]="EBMLVersion",r[r.EBMLReadVersion=17143]="EBMLReadVersion",r[r.EBMLMaxIDLength=17138]="EBMLMaxIDLength",r[r.EBMLMaxSizeLength=17139]="EBMLMaxSizeLength",r[r.DocType=17026]="DocType",r[r.DocTypeVersion=17031]="DocTypeVersion",r[r.DocTypeReadVersion=17029]="DocTypeReadVersion",r[r.Void=236]="Void",r[r.Segment=408125543]="Segment",r[r.SeekHead=290298740]="SeekHead",r[r.Seek=19899]="Seek",r[r.SeekID=21419]="SeekID",r[r.SeekPosition=21420]="SeekPosition",r[r.Duration=17545]="Duration",r[r.Info=357149030]="Info",r[r.TimestampScale=2807729]="TimestampScale",r[r.MuxingApp=19840]="MuxingApp",r[r.WritingApp=22337]="WritingApp",r[r.Tracks=374648427]="Tracks",r[r.TrackEntry=174]="TrackEntry",r[r.TrackNumber=215]="TrackNumber",r[r.TrackUID=29637]="TrackUID",r[r.TrackType=131]="TrackType",r[r.FlagEnabled=185]="FlagEnabled",r[r.FlagDefault=136]="FlagDefault",r[r.FlagForced=21930]="FlagForced",r[r.FlagOriginal=21934]="FlagOriginal",r[r.FlagHearingImpaired=21931]="FlagHearingImpaired",r[r.FlagVisualImpaired=21932]="FlagVisualImpaired",r[r.FlagCommentary=21935]="FlagCommentary",r[r.FlagLacing=156]="FlagLacing",r[r.Name=21358]="Name",r[r.Language=2274716]="Language",r[r.LanguageBCP47=2274717]="LanguageBCP47",r[r.CodecID=134]="CodecID",r[r.CodecPrivate=25506]="CodecPrivate",r[r.CodecDelay=22186]="CodecDelay",r[r.SeekPreRoll=22203]="SeekPreRoll",r[r.DefaultDuration=2352003]="DefaultDuration",r[r.Video=224]="Video",r[r.PixelWidth=176]="PixelWidth",r[r.PixelHeight=186]="PixelHeight",r[r.AlphaMode=21440]="AlphaMode",r[r.Audio=225]="Audio",r[r.SamplingFrequency=181]="SamplingFrequency",r[r.Channels=159]="Channels",r[r.BitDepth=25188]="BitDepth",r[r.SimpleBlock=163]="SimpleBlock",r[r.BlockGroup=160]="BlockGroup",r[r.Block=161]="Block",r[r.BlockAdditions=30113]="BlockAdditions",r[r.BlockMore=166]="BlockMore",r[r.BlockAdditional=165]="BlockAdditional",r[r.BlockAddID=238]="BlockAddID",r[r.BlockDuration=155]="BlockDuration",r[r.ReferenceBlock=251]="ReferenceBlock",r[r.Cluster=524531317]="Cluster",r[r.Timestamp=231]="Timestamp",r[r.Cues=475249515]="Cues",r[r.CuePoint=187]="CuePoint",r[r.CueTime=179]="CueTime",r[r.CueTrackPositions=183]="CueTrackPositions",r[r.CueTrack=247]="CueTrack",r[r.CueClusterPosition=241]="CueClusterPosition",r[r.Colour=21936]="Colour",r[r.MatrixCoefficients=21937]="MatrixCoefficients",r[r.TransferCharacteristics=21946]="TransferCharacteristics",r[r.Primaries=21947]="Primaries",r[r.Range=21945]="Range",r[r.Projection=30320]="Projection",r[r.ProjectionType=30321]="ProjectionType",r[r.ProjectionPoseRoll=30325]="ProjectionPoseRoll",r[r.Attachments=423732329]="Attachments",r[r.AttachedFile=24999]="AttachedFile",r[r.FileDescription=18046]="FileDescription",r[r.FileName=18030]="FileName",r[r.FileMediaType=18016]="FileMediaType",r[r.FileData=18012]="FileData",r[r.FileUID=18094]="FileUID",r[r.Chapters=272869232]="Chapters",r[r.Tags=307544935]="Tags",r[r.Tag=29555]="Tag",r[r.Targets=25536]="Targets",r[r.TargetTypeValue=26826]="TargetTypeValue",r[r.TargetType=25546]="TargetType",r[r.TagTrackUID=25541]="TagTrackUID",r[r.TagEditionUID=25545]="TagEditionUID",r[r.TagChapterUID=25540]="TagChapterUID",r[r.TagAttachmentUID=25542]="TagAttachmentUID",r[r.SimpleTag=26568]="SimpleTag",r[r.TagName=17827]="TagName",r[r.TagLanguage=17530]="TagLanguage",r[r.TagString=17543]="TagString",r[r.TagBinary=17541]="TagBinary",r[r.ContentEncodings=28032]="ContentEncodings",r[r.ContentEncoding=25152]="ContentEncoding",r[r.ContentEncodingOrder=20529]="ContentEncodingOrder",r[r.ContentEncodingScope=20530]="ContentEncodingScope",r[r.ContentCompression=20532]="ContentCompression",r[r.ContentCompAlgo=16980]="ContentCompAlgo",r[r.ContentCompSettings=16981]="ContentCompSettings",r[r.ContentEncryption=20533]="ContentEncryption"})(N||(N={}));const Df=[N.EBML,N.Segment],da=[N.SeekHead,N.Info,N.Cluster,N.Tracks,N.Cues,N.Attachments,N.Chapters,N.Tags],Ca=[...Df,...da],vo=r=>r<256?1:r<65536?2:r<1<<24?3:r<2**32?4:r<2**40?5:6,bo=r=>r<1n<<8n?1:r<1n<<16n?2:r<1n<<24n?3:r<1n<<32n?4:r<1n<<40n?5:r<1n<<48n?6:r<1n<<56n?7:8,wo=r=>r>=-64&&r<64?1:r>=-8192&&r<8192?2:r>=-1048576&&r<1<<20?3:r>=-134217728&&r<1<<27?4:r>=-17179869184&&r<2**34?5:6,Nf=r=>{if(r<127)return 1;if(r<16383)return 2;if(r<(1<<21)-1)return 3;if(r<(1<<28)-1)return 4;if(r<2**35-1)return 5;if(r<2**42-1)return 6;throw new Error("EBML varint size not supported "+r)};class Of{constructor(e){this.writer=e,this.helper=new Uint8Array(8),this.helperView=new DataView(this.helper.buffer),this.offsets=new WeakMap,this.dataOffsets=new WeakMap}writeByte(e){this.helperView.setUint8(0,e),this.writer.write(this.helper.subarray(0,1))}writeFloat32(e){this.helperView.setFloat32(0,e,!1),this.writer.write(this.helper.subarray(0,4))}writeFloat64(e){this.helperView.setFloat64(0,e,!1),this.writer.write(this.helper)}writeUnsignedInt(e,t=vo(e)){let i=0;switch(t){case 6:this.helperView.setUint8(i++,e/2**40|0);case 5:this.helperView.setUint8(i++,e/2**32|0);case 4:this.helperView.setUint8(i++,e>>24);case 3:this.helperView.setUint8(i++,e>>16);case 2:this.helperView.setUint8(i++,e>>8);case 1:this.helperView.setUint8(i++,e);break;default:throw new Error("Bad unsigned int size "+t)}this.writer.write(this.helper.subarray(0,i))}writeUnsignedBigInt(e,t=bo(e)){let i=0;for(let a=t-1;a>=0;a--)this.helperView.setUint8(i++,Number(e>>BigInt(a*8)&0xffn));this.writer.write(this.helper.subarray(0,i))}writeSignedInt(e,t=wo(e)){e<0&&(e+=2**(t*8)),this.writeUnsignedInt(e,t)}writeVarInt(e,t=Nf(e)){let i=0;switch(t){case 1:this.helperView.setUint8(i++,128|e);break;case 2:this.helperView.setUint8(i++,64|e>>8),this.helperView.setUint8(i++,e);break;case 3:this.helperView.setUint8(i++,32|e>>16),this.helperView.setUint8(i++,e>>8),this.helperView.setUint8(i++,e);break;case 4:this.helperView.setUint8(i++,16|e>>24),this.helperView.setUint8(i++,e>>16),this.helperView.setUint8(i++,e>>8),this.helperView.setUint8(i++,e);break;case 5:this.helperView.setUint8(i++,8|e/2**32&7),this.helperView.setUint8(i++,e>>24),this.helperView.setUint8(i++,e>>16),this.helperView.setUint8(i++,e>>8),this.helperView.setUint8(i++,e);break;case 6:this.helperView.setUint8(i++,4|e/2**40&3),this.helperView.setUint8(i++,e/2**32|0),this.helperView.setUint8(i++,e>>24),this.helperView.setUint8(i++,e>>16),this.helperView.setUint8(i++,e>>8),this.helperView.setUint8(i++,e);break;default:throw new Error("Bad EBML varint size "+t)}this.writer.write(this.helper.subarray(0,i))}writeAsciiString(e){this.writer.write(new Uint8Array(e.split("").map(t=>t.charCodeAt(0))))}writeEBML(e){if(e!==null)if(e instanceof Uint8Array)this.writer.write(e);else if(Array.isArray(e))for(const t of e)this.writeEBML(t);else if(this.offsets.set(e,this.writer.getPos()),this.writeUnsignedInt(e.id),Array.isArray(e.data)){const t=this.writer.getPos(),i=e.size===-1?1:e.size??4;e.size===-1?this.writeByte(255):this.writer.seek(this.writer.getPos()+i);const a=this.writer.getPos();if(this.dataOffsets.set(e,a),this.writeEBML(e.data),e.size!==-1){const s=this.writer.getPos()-a,n=this.writer.getPos();this.writer.seek(t),this.writeVarInt(s,i),this.writer.seek(n)}}else if(typeof e.data=="number"){const t=e.size??vo(e.data);this.writeVarInt(t),this.writeUnsignedInt(e.data,t)}else if(typeof e.data=="bigint"){const t=e.size??bo(e.data);this.writeVarInt(t),this.writeUnsignedBigInt(e.data,t)}else if(typeof e.data=="string")this.writeVarInt(e.data.length),this.writeAsciiString(e.data);else if(e.data instanceof Uint8Array)this.writeVarInt(e.data.byteLength,e.size),this.writer.write(e.data);else if(e.data instanceof Wn)this.writeVarInt(4),this.writeFloat32(e.data.value);else if(e.data instanceof Hn)this.writeVarInt(8),this.writeFloat64(e.data.value);else if(e.data instanceof Wc){const t=e.size??wo(e.data.value);this.writeVarInt(t),this.writeSignedInt(e.data.value,t)}else if(e.data instanceof Nr){const t=Kt.encode(e.data.value);this.writeVarInt(t.length),this.writer.write(t)}else pr(e.data)}}const jn=8,nr=2,Ar=2*jn,Hc=r=>{if(r.remainingLength<1)return null;const e=Ce(r);if(r.skip(-1),e===0)return null;let t=1,i=128;for(;(e&i)===0;)t++,i>>=1;return r.remainingLength<t?null:t},Xi=r=>{if(r.remainingLength<1)return null;const e=Ce(r);if(e===0)return null;let t=1,i=128;for(;(e&i)===0;)t++,i>>=1;if(r.remainingLength<t-1)return null;let a=e&i-1;for(let s=1;s<t;s++)a*=256,a+=Ce(r);return a},qe=(r,e)=>{if(e<1||e>8)throw new Error("Bad unsigned int size "+e);let t=0;for(let i=0;i<e;i++)t*=256,t+=Ce(r);return t},Uf=(r,e)=>{if(e<1)throw new Error("Bad unsigned int size "+e);let t=0n;for(let i=0;i<e;i++)t<<=8n,t+=BigInt(Ce(r));return t},ks=r=>{const e=Hc(r);return e===null||r.remainingLength<e?null:qe(r,e)},jc=r=>{if(r.remainingLength<1)return null;if(Ce(r)===255)return;r.skip(-1);const t=Xi(r);if(t===null)return null;if(t!==72057594037927940)return t},Cr=r=>{I(r.remainingLength>=nr);const e=ks(r);if(e===null)return null;const t=jc(r);return t===null?null:{id:e,size:t}},hi=(r,e)=>{const t=Ue(r,e);let i=0;for(;i<e&&t[i]!==0;)i+=1;return String.fromCharCode(...t.subarray(0,i))},qi=(r,e)=>{const t=Ue(r,e);let i=0;for(;i<e&&t[i]!==0;)i+=1;return or.decode(t.subarray(0,i))},mn=(r,e)=>{if(e===0)return 0;if(e!==4&&e!==8)throw new Error("Bad float size "+e);return e===4?jh(r):al(r)},qn=async(r,e,t,i)=>{const a=new Set(t);let s=e;for(;i===null||s<i;){let n=r.requestSliceRange(s,nr,Ar);if(n instanceof Promise&&(n=await n),!n)break;const o=Cr(n);if(!o)break;if(a.has(o.id))return{pos:s,found:!0};Or(o.size),s=n.filePos+o.size}return{pos:i!==null&&i>s?i:s,found:!1}},qc=async(r,e,t,i)=>{const s=new Set(t);let n=e;for(;n<i;){let o=r.requestSliceRange(n,0,Math.min(65536,i-n));if(o instanceof Promise&&(o=await o),!o||o.length<jn)break;for(let c=0;c<o.length-jn;c++){o.filePos=n;const l=ks(o);if(l!==null&&s.has(l))return n;n++}}return null},fr={avc:"V_MPEG4/ISO/AVC",hevc:"V_MPEGH/ISO/HEVC",vp8:"V_VP8",vp9:"V_VP9",av1:"V_AV1",aac:"A_AAC",mp3:"A_MPEG/L3",opus:"A_OPUS",vorbis:"A_VORBIS",flac:"A_FLAC","pcm-u8":"A_PCM/INT/LIT","pcm-s16":"A_PCM/INT/LIT","pcm-s16be":"A_PCM/INT/BIG","pcm-s24":"A_PCM/INT/LIT","pcm-s24be":"A_PCM/INT/BIG","pcm-s32":"A_PCM/INT/LIT","pcm-s32be":"A_PCM/INT/BIG","pcm-f32":"A_PCM/FLOAT/IEEE","pcm-f64":"A_PCM/FLOAT/IEEE",webvtt:"S_TEXT/WEBVTT"};function Or(r){if(r===void 0)throw new Error("Undefined element size is used in a place where it is not supported.")}const Kc=r=>{let t=(r.hasVideo?"video/":r.hasAudio?"audio/":"application/")+(r.isWebM?"webm":"x-matroska");if(r.codecStrings.length>0){const i=[...new Set(r.codecStrings.filter(Boolean))];t+=`; codecs="${i.join(", ")}"`}return t};var Tr;(function(r){r[r.None=0]="None",r[r.Xiph=1]="Xiph",r[r.FixedSize=2]="FixedSize",r[r.Ebml=3]="Ebml"})(Tr||(Tr={}));var Da;(function(r){r[r.Block=1]="Block",r[r.Private=2]="Private",r[r.Next=4]="Next"})(Da||(Da={}));var ra;(function(r){r[r.Zlib=0]="Zlib",r[r.Bzlib=1]="Bzlib",r[r.lzo1x=2]="lzo1x",r[r.HeaderStripping=3]="HeaderStripping"})(ra||(ra={}));const pn=[{id:N.SeekHead,flag:"seekHeadSeen"},{id:N.Info,flag:"infoSeen"},{id:N.Tracks,flag:"tracksSeen"},{id:N.Cues,flag:"cuesSeen"}],Gc=10*2**20;class Vf extends si{constructor(e){super(e),this.readMetadataPromise=null,this.segments=[],this.currentSegment=null,this.currentTrack=null,this.currentCluster=null,this.currentBlock=null,this.currentBlockAdditional=null,this.currentCueTime=null,this.currentDecodingInstruction=null,this.currentTagTargetIsMovie=!0,this.currentSimpleTagName=null,this.currentAttachedFile=null,this.isWebM=!1,this.reader=e._reader}async computeDuration(){const e=await this.getTracks(),t=await Promise.all(e.map(i=>i.computeDuration()));return Math.max(0,...t)}async getTracks(){return await this.readMetadata(),this.segments.flatMap(e=>e.tracks.map(t=>t.inputTrack))}async getMimeType(){await this.readMetadata();const e=await this.getTracks(),t=await Promise.all(e.map(i=>i.getCodecParameterString()));return Kc({isWebM:this.isWebM,hasVideo:this.segments.some(i=>i.tracks.some(a=>a.info?.type==="video")),hasAudio:this.segments.some(i=>i.tracks.some(a=>a.info?.type==="audio")),codecStrings:t.filter(Boolean)})}async getMetadataTags(){await this.readMetadata();for(const t of this.segments)t.metadataTagsCollected||(this.reader.fileSize!==null&&await this.loadSegmentMetadata(t),t.metadataTagsCollected=!0);let e={};for(const t of this.segments)e={...e,...t.metadataTags};return e}readMetadata(){return this.readMetadataPromise??=(async()=>{let e=0;for(;;){let t=this.reader.requestSliceRange(e,nr,Ar);if(t instanceof Promise&&(t=await t),!t)break;const i=Cr(t);if(!i)break;const a=i.id;let s=i.size;const n=t.filePos;if(a===N.EBML){Or(s);let o=this.reader.requestSlice(n,s);if(o instanceof Promise&&(o=await o),!o)break;this.readContiguousElements(o)}else if(a===N.Segment){if(await this.readSegment(n,s),s===void 0||this.reader.fileSize===null)break}else if(a===N.Cluster){if(this.reader.fileSize===null)break;s===void 0&&(s=(await qn(this.reader,n,Ca,this.reader.fileSize)).pos-n);const o=Ct(this.segments);o&&(o.elementEndPos=n+s)}Or(s),e=n+s}})()}async readSegment(e,t){this.currentSegment={seekHeadSeen:!1,infoSeen:!1,tracksSeen:!1,cuesSeen:!1,tagsSeen:!1,attachmentsSeen:!1,timestampScale:-1,timestampFactor:-1,duration:-1,seekEntries:[],tracks:[],cuePoints:[],dataStartPos:e,elementEndPos:t===void 0?null:e+t,clusterSeekStartPos:e,lastReadCluster:null,metadataTags:{},metadataTagsCollected:!1},this.segments.push(this.currentSegment);let i=e;for(;this.currentSegment.elementEndPos===null||i<this.currentSegment.elementEndPos;){let o=this.reader.requestSliceRange(i,nr,Ar);if(o instanceof Promise&&(o=await o),!o)break;const c=i,l=Cr(o);if(!l||!da.includes(l.id)&&l.id!==N.Void){const g=await qc(this.reader,c,da,Math.min(this.currentSegment.elementEndPos??1/0,c+Gc));if(g){i=g;continue}else break}const{id:d,size:u}=l,f=o.filePos,h=pn.findIndex(g=>g.id===d);if(h!==-1){const g=pn[h].flag;this.currentSegment[g]=!0,Or(u);let m=this.reader.requestSlice(f,u);m instanceof Promise&&(m=await m),m&&this.readContiguousElements(m)}else if(d===N.Tags||d===N.Attachments){d===N.Tags?this.currentSegment.tagsSeen=!0:this.currentSegment.attachmentsSeen=!0,Or(u);let g=this.reader.requestSlice(f,u);g instanceof Promise&&(g=await g),g&&this.readContiguousElements(g)}else if(d===N.Cluster){this.currentSegment.clusterSeekStartPos=c;break}if(u===void 0)break;i=f+u}if(this.currentSegment.seekEntries.sort((o,c)=>o.segmentPosition-c.segmentPosition),this.reader.fileSize!==null)for(const o of this.currentSegment.seekEntries){const c=pn.find(g=>g.id===o.id);if(!c||this.currentSegment[c.flag])continue;let l=this.reader.requestSliceRange(e+o.segmentPosition,nr,Ar);if(l instanceof Promise&&(l=await l),!l)continue;const d=Cr(l);if(!d)continue;const{id:u,size:f}=d;if(u!==c.id)continue;Or(f),this.currentSegment[c.flag]=!0;let h=this.reader.requestSlice(l.filePos,f);h instanceof Promise&&(h=await h),h&&this.readContiguousElements(h)}this.currentSegment.timestampScale===-1&&(this.currentSegment.timestampScale=1e6,this.currentSegment.timestampFactor=1e9/1e6);for(const o of this.currentSegment.tracks)o.defaultDurationNs!==null&&(o.defaultDuration=this.currentSegment.timestampFactor*o.defaultDurationNs/1e9);this.currentSegment.tracks.sort((o,c)=>Number(c.disposition.default)-Number(o.disposition.default));const a=new Map(this.currentSegment.tracks.map(o=>[o.id,o]));for(const o of this.currentSegment.cuePoints){const c=a.get(o.trackId);c&&c.cuePoints.push(o)}for(const o of this.currentSegment.tracks){o.cuePoints.sort((c,l)=>c.time-l.time);for(let c=0;c<o.cuePoints.length-1;c++){const l=o.cuePoints[c],d=o.cuePoints[c+1];l.time===d.time&&(o.cuePoints.splice(c+1,1),c--)}}let s=null,n=-1/0;for(const o of this.currentSegment.tracks)o.cuePoints.length>n&&(n=o.cuePoints.length,s=o);for(const o of this.currentSegment.tracks)o.cuePoints.length===0&&(o.cuePoints=s.cuePoints);this.currentSegment=null}async readCluster(e,t){if(t.lastReadCluster?.elementStartPos===e)return t.lastReadCluster;let i=this.reader.requestSliceRange(e,nr,Ar);i instanceof Promise&&(i=await i),I(i);const a=e,s=Cr(i);I(s);const n=s.id;I(n===N.Cluster);let o=s.size;const c=i.filePos;o===void 0&&(o=(await qn(this.reader,c,Ca,t.elementEndPos)).pos-c);let l=this.reader.requestSlice(c,o);l instanceof Promise&&(l=await l);const d={segment:t,elementStartPos:a,elementEndPos:c+o,dataStartPos:c,timestamp:-1,trackData:new Map};if(this.currentCluster=d,l){const u=this.readContiguousElements(l,Ca);d.elementEndPos=u}for(const[,u]of d.trackData){const f=u.track;I(u.blocks.length>0);let h=!1;for(let p=0;p<u.blocks.length;p++){const b=u.blocks[p];b.timestamp+=d.timestamp,h||=b.lacing!==Tr.None}u.presentationTimestamps=u.blocks.map((p,b)=>({timestamp:p.timestamp,blockIndex:b})).sort((p,b)=>p.timestamp-b.timestamp);for(let p=0;p<u.presentationTimestamps.length;p++){const b=u.presentationTimestamps[p],y=u.blocks[b.blockIndex];if(u.firstKeyFrameTimestamp===null&&y.isKeyFrame&&(u.firstKeyFrameTimestamp=y.timestamp),p<u.presentationTimestamps.length-1){const _=u.presentationTimestamps[p+1];y.duration=_.timestamp-y.timestamp}else y.duration===0&&f.defaultDuration!=null&&y.lacing===Tr.None&&(y.duration=f.defaultDuration)}h&&(this.expandLacedBlocks(u.blocks,f),u.presentationTimestamps=u.blocks.map((p,b)=>({timestamp:p.timestamp,blockIndex:b})).sort((p,b)=>p.timestamp-b.timestamp));const g=u.blocks[u.presentationTimestamps[0].blockIndex],m=u.blocks[Ct(u.presentationTimestamps).blockIndex];u.startTimestamp=g.timestamp,u.endTimestamp=m.timestamp+m.duration;const v=lt(f.clusterPositionCache,u.startTimestamp,p=>p.startTimestamp);(v===-1||f.clusterPositionCache[v].elementStartPos!==a)&&f.clusterPositionCache.splice(v+1,0,{elementStartPos:d.elementStartPos,startTimestamp:u.startTimestamp})}return t.lastReadCluster=d,d}getTrackDataInCluster(e,t){let i=e.trackData.get(t);if(!i){const a=e.segment.tracks.find(s=>s.id===t);if(!a)return null;i={track:a,startTimestamp:0,endTimestamp:0,firstKeyFrameTimestamp:null,blocks:[],presentationTimestamps:[]},e.trackData.set(t,i)}return i}expandLacedBlocks(e,t){for(let i=0;i<e.length;i++){const a=e[i];if(a.lacing===Tr.None)continue;a.decoded||(a.data=this.decodeBlockData(t,a.data),a.decoded=!0);const s=Ni.tempFromBytes(a.data),n=[],o=Ce(s)+1;switch(a.lacing){case Tr.Xiph:{let l=0;for(let d=0;d<o-1;d++){let u=0;for(;s.bufferPos<s.length;){const f=Ce(s);if(u+=f,f<255){n.push(u),l+=u;break}}}n.push(s.length-(s.bufferPos+l))}break;case Tr.FixedSize:{const l=s.length-1,d=Math.floor(l/o);for(let u=0;u<o;u++)n.push(d)}break;case Tr.Ebml:{const l=Xi(s);I(l!==null);let d=l;n.push(d);let u=d;for(let f=1;f<o-1;f++){const h=s.bufferPos,g=Xi(s);I(g!==null);const m=g,p=(1<<(s.bufferPos-h)*7-1)-1,b=m-p;d+=b,n.push(d),u+=d}n.push(s.length-(s.bufferPos+u))}break;default:I(!1)}I(n.length===o),e.splice(i,1);const c=a.duration||o*(t.defaultDuration??0);for(let l=0;l<o;l++){const d=n[l],u=Ue(s,d),f=a.timestamp+c*l/o,h=c/o;e.splice(i+l,0,{timestamp:f,duration:h,isKeyFrame:a.isKeyFrame,data:u,lacing:Tr.None,decoded:!0,mainAdditional:a.mainAdditional})}i+=o,i--}}async loadSegmentMetadata(e){for(const t of e.seekEntries){if(!(t.id===N.Tags&&!e.tagsSeen)){if(!(t.id===N.Attachments&&!e.attachmentsSeen))continue}let i=this.reader.requestSliceRange(e.dataStartPos+t.segmentPosition,nr,Ar);if(i instanceof Promise&&(i=await i),!i)continue;const a=Cr(i);if(!a||a.id!==t.id)continue;const{size:s}=a;Or(s),I(!this.currentSegment),this.currentSegment=e;let n=this.reader.requestSlice(i.filePos,s);n instanceof Promise&&(n=await n),n&&this.readContiguousElements(n),this.currentSegment=null,t.id===N.Tags?e.tagsSeen=!0:t.id===N.Attachments&&(e.attachmentsSeen=!0)}}readContiguousElements(e,t){for(;e.remainingLength>=nr;){const i=e.filePos;if(!this.traverseElement(e,t))return i}return e.filePos}traverseElement(e,t){const i=Cr(e);if(!i||t&&t.includes(i.id))return!1;const{id:a,size:s}=i,n=e.filePos;switch(Or(s),a){case N.DocType:this.isWebM=hi(e,s)==="webm";break;case N.Seek:{if(!this.currentSegment)break;const o={id:-1,segmentPosition:-1};this.currentSegment.seekEntries.push(o),this.readContiguousElements(e.slice(n,s)),(o.id===-1||o.segmentPosition===-1)&&this.currentSegment.seekEntries.pop()}break;case N.SeekID:{const o=this.currentSegment?.seekEntries[this.currentSegment.seekEntries.length-1];if(!o)break;o.id=qe(e,s)}break;case N.SeekPosition:{const o=this.currentSegment?.seekEntries[this.currentSegment.seekEntries.length-1];if(!o)break;o.segmentPosition=qe(e,s)}break;case N.TimestampScale:{if(!this.currentSegment)break;this.currentSegment.timestampScale=qe(e,s),this.currentSegment.timestampFactor=1e9/this.currentSegment.timestampScale}break;case N.Duration:{if(!this.currentSegment)break;this.currentSegment.duration=mn(e,s)}break;case N.TrackEntry:{if(!this.currentSegment||(this.currentTrack={id:-1,segment:this.currentSegment,demuxer:this,clusterPositionCache:[],cuePoints:[],disposition:{...ni},inputTrack:null,codecId:null,codecPrivate:null,defaultDuration:null,defaultDurationNs:null,name:null,languageCode:er,decodingInstructions:[],info:null},this.readContiguousElements(e.slice(n,s)),!this.currentTrack))break;if(this.currentTrack.decodingInstructions.some(o=>o.data?.type!=="decompress"||o.scope!==Da.Block||o.data.algorithm!==ra.HeaderStripping)&&(console.warn(`Track #${this.currentTrack.id} has an unsupported content encoding; dropping.`),this.currentTrack=null),this.currentTrack&&this.currentTrack.id!==-1&&this.currentTrack.codecId&&this.currentTrack.info){const o=this.currentTrack.codecId.indexOf("/"),c=o===-1?this.currentTrack.codecId:this.currentTrack.codecId.slice(0,o);if(this.currentTrack.info.type==="video"&&this.currentTrack.info.width!==-1&&this.currentTrack.info.height!==-1){this.currentTrack.codecId===fr.avc?(this.currentTrack.info.codec="avc",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId===fr.hevc?(this.currentTrack.info.codec="hevc",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):c===fr.vp8?this.currentTrack.info.codec="vp8":c===fr.vp9?this.currentTrack.info.codec="vp9":c===fr.av1&&(this.currentTrack.info.codec="av1");const l=this.currentTrack,d=new ma(this.input,new Lf(l));this.currentTrack.inputTrack=d,this.currentSegment.tracks.push(this.currentTrack)}else if(this.currentTrack.info.type==="audio"&&this.currentTrack.info.numberOfChannels!==-1&&this.currentTrack.info.sampleRate!==-1){c===fr.aac?(this.currentTrack.info.codec="aac",this.currentTrack.info.aacCodecInfo={isMpeg2:this.currentTrack.codecId.includes("MPEG2")},this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId===fr.mp3?this.currentTrack.info.codec="mp3":c===fr.opus?(this.currentTrack.info.codec="opus",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate,this.currentTrack.info.sampleRate=fa):c===fr.vorbis?(this.currentTrack.info.codec="vorbis",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):c===fr.flac?(this.currentTrack.info.codec="flac",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId==="A_PCM/INT/LIT"?this.currentTrack.info.bitDepth===8?this.currentTrack.info.codec="pcm-u8":this.currentTrack.info.bitDepth===16?this.currentTrack.info.codec="pcm-s16":this.currentTrack.info.bitDepth===24?this.currentTrack.info.codec="pcm-s24":this.currentTrack.info.bitDepth===32&&(this.currentTrack.info.codec="pcm-s32"):this.currentTrack.codecId==="A_PCM/INT/BIG"?this.currentTrack.info.bitDepth===8?this.currentTrack.info.codec="pcm-u8":this.currentTrack.info.bitDepth===16?this.currentTrack.info.codec="pcm-s16be":this.currentTrack.info.bitDepth===24?this.currentTrack.info.codec="pcm-s24be":this.currentTrack.info.bitDepth===32&&(this.currentTrack.info.codec="pcm-s32be"):this.currentTrack.codecId==="A_PCM/FLOAT/IEEE"&&(this.currentTrack.info.bitDepth===32?this.currentTrack.info.codec="pcm-f32":this.currentTrack.info.bitDepth===64&&(this.currentTrack.info.codec="pcm-f64"));const l=this.currentTrack,d=new Mr(this.input,new $f(l));this.currentTrack.inputTrack=d,this.currentSegment.tracks.push(this.currentTrack)}}this.currentTrack=null}break;case N.TrackNumber:{if(!this.currentTrack)break;this.currentTrack.id=qe(e,s)}break;case N.TrackType:{if(!this.currentTrack)break;const o=qe(e,s);o===1?this.currentTrack.info={type:"video",width:-1,height:-1,rotation:0,codec:null,codecDescription:null,colorSpace:null,alphaMode:!1}:o===2&&(this.currentTrack.info={type:"audio",numberOfChannels:-1,sampleRate:-1,bitDepth:-1,codec:null,codecDescription:null,aacCodecInfo:null})}break;case N.FlagEnabled:{if(!this.currentTrack)break;qe(e,s)||(this.currentTrack=null)}break;case N.FlagDefault:{if(!this.currentTrack)break;this.currentTrack.disposition.default=!!qe(e,s)}break;case N.FlagForced:{if(!this.currentTrack)break;this.currentTrack.disposition.forced=!!qe(e,s)}break;case N.FlagOriginal:{if(!this.currentTrack)break;this.currentTrack.disposition.original=!!qe(e,s)}break;case N.FlagHearingImpaired:{if(!this.currentTrack)break;this.currentTrack.disposition.hearingImpaired=!!qe(e,s)}break;case N.FlagVisualImpaired:{if(!this.currentTrack)break;this.currentTrack.disposition.visuallyImpaired=!!qe(e,s)}break;case N.FlagCommentary:{if(!this.currentTrack)break;this.currentTrack.disposition.commentary=!!qe(e,s)}break;case N.CodecID:{if(!this.currentTrack)break;this.currentTrack.codecId=hi(e,s)}break;case N.CodecPrivate:{if(!this.currentTrack)break;this.currentTrack.codecPrivate=Ue(e,s)}break;case N.DefaultDuration:{if(!this.currentTrack)break;this.currentTrack.defaultDurationNs=qe(e,s)}break;case N.Name:{if(!this.currentTrack)break;this.currentTrack.name=qi(e,s)}break;case N.Language:{if(!this.currentTrack||this.currentTrack.languageCode!==er)break;this.currentTrack.languageCode=hi(e,s),sa(this.currentTrack.languageCode)||(this.currentTrack.languageCode=er)}break;case N.LanguageBCP47:{if(!this.currentTrack)break;const c=hi(e,s).split("-")[0];c?this.currentTrack.languageCode=c:this.currentTrack.languageCode=er}break;case N.Video:{if(this.currentTrack?.info?.type!=="video")break;this.readContiguousElements(e.slice(n,s))}break;case N.PixelWidth:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.width=qe(e,s)}break;case N.PixelHeight:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.height=qe(e,s)}break;case N.AlphaMode:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.alphaMode=qe(e,s)===1}break;case N.Colour:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.colorSpace={},this.readContiguousElements(e.slice(n,s))}break;case N.MatrixCoefficients:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;const o=qe(e,s),c=lc[o]??null;this.currentTrack.info.colorSpace.matrix=c}break;case N.Range:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;this.currentTrack.info.colorSpace.fullRange=qe(e,s)===2}break;case N.TransferCharacteristics:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;const o=qe(e,s),c=cc[o]??null;this.currentTrack.info.colorSpace.transfer=c}break;case N.Primaries:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;const o=qe(e,s),c=oc[o]??null;this.currentTrack.info.colorSpace.primaries=c}break;case N.Projection:{if(this.currentTrack?.info?.type!=="video")break;this.readContiguousElements(e.slice(n,s))}break;case N.ProjectionPoseRoll:{if(this.currentTrack?.info?.type!=="video")break;const c=-mn(e,s);try{this.currentTrack.info.rotation=Ha(c)}catch{}}break;case N.Audio:{if(this.currentTrack?.info?.type!=="audio")break;this.readContiguousElements(e.slice(n,s))}break;case N.SamplingFrequency:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.sampleRate=mn(e,s)}break;case N.Channels:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.numberOfChannels=qe(e,s)}break;case N.BitDepth:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.bitDepth=qe(e,s)}break;case N.CuePoint:{if(!this.currentSegment)break;this.readContiguousElements(e.slice(n,s)),this.currentCueTime=null}break;case N.CueTime:this.currentCueTime=qe(e,s);break;case N.CueTrackPositions:{if(this.currentCueTime===null)break;I(this.currentSegment);const o={time:this.currentCueTime,trackId:-1,clusterPosition:-1};this.currentSegment.cuePoints.push(o),this.readContiguousElements(e.slice(n,s)),(o.trackId===-1||o.clusterPosition===-1)&&this.currentSegment.cuePoints.pop()}break;case N.CueTrack:{const o=this.currentSegment?.cuePoints[this.currentSegment.cuePoints.length-1];if(!o)break;o.trackId=qe(e,s)}break;case N.CueClusterPosition:{const o=this.currentSegment?.cuePoints[this.currentSegment.cuePoints.length-1];if(!o)break;I(this.currentSegment),o.clusterPosition=this.currentSegment.dataStartPos+qe(e,s)}break;case N.Timestamp:{if(!this.currentCluster)break;this.currentCluster.timestamp=qe(e,s)}break;case N.SimpleBlock:{if(!this.currentCluster)break;const o=Xi(e);if(o===null)break;const c=this.getTrackDataInCluster(this.currentCluster,o);if(!c)break;const l=Zn(e),d=Ce(e),u=d>>1&3;let f=!!(d&128);c.track.info?.type==="audio"&&c.track.info.codec&&(f=!0);const h=Ue(e,s-(e.filePos-n)),g=c.track.decodingInstructions.length>0;c.blocks.push({timestamp:l,duration:0,isKeyFrame:f,data:h,lacing:u,decoded:!g,mainAdditional:null})}break;case N.BlockGroup:{if(!this.currentCluster)break;this.readContiguousElements(e.slice(n,s)),this.currentBlock=null}break;case N.Block:{if(!this.currentCluster)break;const o=Xi(e);if(o===null)break;const c=this.getTrackDataInCluster(this.currentCluster,o);if(!c)break;const l=Zn(e),u=Ce(e)>>1&3,f=Ue(e,s-(e.filePos-n)),h=c.track.decodingInstructions.length>0;this.currentBlock={timestamp:l,duration:0,isKeyFrame:!0,data:f,lacing:u,decoded:!h,mainAdditional:null},c.blocks.push(this.currentBlock)}break;case N.BlockAdditions:this.readContiguousElements(e.slice(n,s));break;case N.BlockMore:{if(!this.currentBlock)break;this.currentBlockAdditional={addId:1,data:null},this.readContiguousElements(e.slice(n,s)),this.currentBlockAdditional.data&&this.currentBlockAdditional.addId===1&&(this.currentBlock.mainAdditional=this.currentBlockAdditional.data),this.currentBlockAdditional=null}break;case N.BlockAdditional:{if(!this.currentBlockAdditional)break;this.currentBlockAdditional.data=Ue(e,s)}break;case N.BlockAddID:{if(!this.currentBlockAdditional)break;this.currentBlockAdditional.addId=qe(e,s)}break;case N.BlockDuration:{if(!this.currentBlock)break;this.currentBlock.duration=qe(e,s)}break;case N.ReferenceBlock:{if(!this.currentBlock)break;this.currentBlock.isKeyFrame=!1}break;case N.Tag:this.currentTagTargetIsMovie=!0,this.readContiguousElements(e.slice(n,s));break;case N.Targets:this.readContiguousElements(e.slice(n,s));break;case N.TargetTypeValue:qe(e,s)!==50&&(this.currentTagTargetIsMovie=!1);break;case N.TagTrackUID:case N.TagEditionUID:case N.TagChapterUID:case N.TagAttachmentUID:this.currentTagTargetIsMovie=!1;break;case N.SimpleTag:{if(!this.currentTagTargetIsMovie)break;this.currentSimpleTagName=null,this.readContiguousElements(e.slice(n,s))}break;case N.TagName:this.currentSimpleTagName=qi(e,s);break;case N.TagString:{if(!this.currentSimpleTagName)break;const o=qi(e,s);this.processTagValue(this.currentSimpleTagName,o)}break;case N.TagBinary:{if(!this.currentSimpleTagName)break;const o=Ue(e,s);this.processTagValue(this.currentSimpleTagName,o)}break;case N.AttachedFile:{if(!this.currentSegment)break;this.currentAttachedFile={fileUid:null,fileName:null,fileMediaType:null,fileData:null,fileDescription:null},this.readContiguousElements(e.slice(n,s));const o=this.currentSegment.metadataTags;if(this.currentAttachedFile.fileUid&&this.currentAttachedFile.fileData&&(o.raw??={},o.raw[this.currentAttachedFile.fileUid.toString()]=new hs(this.currentAttachedFile.fileData,this.currentAttachedFile.fileMediaType??void 0,this.currentAttachedFile.fileName??void 0,this.currentAttachedFile.fileDescription??void 0)),this.currentAttachedFile.fileMediaType?.startsWith("image/")&&this.currentAttachedFile.fileData){const c=this.currentAttachedFile.fileName;let l="unknown";if(c){const d=c.toLowerCase();d.startsWith("cover.")?l="coverFront":d.startsWith("back.")&&(l="coverBack")}o.images??=[],o.images.push({data:this.currentAttachedFile.fileData,mimeType:this.currentAttachedFile.fileMediaType,kind:l,name:this.currentAttachedFile.fileName??void 0,description:this.currentAttachedFile.fileDescription??void 0})}this.currentAttachedFile=null}break;case N.FileUID:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileUid=Uf(e,s)}break;case N.FileName:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileName=qi(e,s)}break;case N.FileMediaType:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileMediaType=hi(e,s)}break;case N.FileData:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileData=Ue(e,s)}break;case N.FileDescription:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileDescription=qi(e,s)}break;case N.ContentEncodings:{if(!this.currentTrack)break;this.readContiguousElements(e.slice(n,s)),this.currentTrack.decodingInstructions.sort((o,c)=>c.order-o.order)}break;case N.ContentEncoding:this.currentDecodingInstruction={order:0,scope:Da.Block,data:null},this.readContiguousElements(e.slice(n,s)),this.currentDecodingInstruction.data&&this.currentTrack.decodingInstructions.push(this.currentDecodingInstruction),this.currentDecodingInstruction=null;break;case N.ContentEncodingOrder:{if(!this.currentDecodingInstruction)break;this.currentDecodingInstruction.order=qe(e,s)}break;case N.ContentEncodingScope:{if(!this.currentDecodingInstruction)break;this.currentDecodingInstruction.scope=qe(e,s)}break;case N.ContentCompression:{if(!this.currentDecodingInstruction)break;this.currentDecodingInstruction.data={type:"decompress",algorithm:ra.Zlib,settings:null},this.readContiguousElements(e.slice(n,s))}break;case N.ContentCompAlgo:{if(this.currentDecodingInstruction?.data?.type!=="decompress")break;this.currentDecodingInstruction.data.algorithm=qe(e,s)}break;case N.ContentCompSettings:{if(this.currentDecodingInstruction?.data?.type!=="decompress")break;this.currentDecodingInstruction.data.settings=Ue(e,s)}break;case N.ContentEncryption:{if(!this.currentDecodingInstruction)break;this.currentDecodingInstruction.data={type:"decrypt"}}break}return e.filePos=n+s,!0}decodeBlockData(e,t){I(e.decodingInstructions.length>0);let i=t;for(const a of e.decodingInstructions)switch(I(a.data),a.data.type){case"decompress":switch(a.data.algorithm){case ra.HeaderStripping:if(a.data.settings&&a.data.settings.length>0){const s=a.data.settings,n=new Uint8Array(s.length+i.length);n.set(s,0),n.set(i,s.length),i=n}break}break}return i}processTagValue(e,t){if(!this.currentSegment?.metadataTags)return;const i=this.currentSegment.metadataTags;if(i.raw??={},i.raw[e]??=t,typeof t=="string")switch(e.toLowerCase()){case"title":i.title??=t;break;case"description":i.description??=t;break;case"artist":i.artist??=t;break;case"album":i.album??=t;break;case"album_artist":i.albumArtist??=t;break;case"genre":i.genre??=t;break;case"comment":i.comment??=t;break;case"lyrics":i.lyrics??=t;break;case"date":{const a=new Date(t);Number.isNaN(a.getTime())||(i.date??=a)}break;case"track_number":case"part_number":{const a=t.split("/"),s=Number.parseInt(a[0],10),n=a[1]&&Number.parseInt(a[1],10);Number.isInteger(s)&&s>0&&(i.trackNumber??=s),n&&Number.isInteger(n)&&n>0&&(i.tracksTotal??=n)}break;case"disc_number":case"disc":{const a=t.split("/"),s=Number.parseInt(a[0],10),n=a[1]&&Number.parseInt(a[1],10);Number.isInteger(s)&&s>0&&(i.discNumber??=s),n&&Number.isInteger(n)&&n>0&&(i.discsTotal??=n)}break}}}class Qc{constructor(e){this.internalTrack=e,this.packetToClusterLocation=new WeakMap}getId(){return this.internalTrack.id}getCodec(){throw new Error("Not implemented on base class.")}getInternalCodecId(){return this.internalTrack.codecId}async computeDuration(){const e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getName(){return this.internalTrack.name}getLanguageCode(){return this.internalTrack.languageCode}async getFirstTimestamp(){return(await this.getFirstPacket({metadataOnly:!0}))?.timestamp??0}getTimeResolution(){return this.internalTrack.segment.timestampFactor}getDisposition(){return this.internalTrack.disposition}async getFirstPacket(e){return this.performClusterLookup(null,t=>t.trackData.get(this.internalTrack.id)?{blockIndex:0,correctBlockFound:!0}:{blockIndex:-1,correctBlockFound:!1},-1/0,1/0,e)}intoTimescale(e){return Ma(e*this.internalTrack.segment.timestampFactor)}async getPacket(e,t){const i=this.intoTimescale(e);return this.performClusterLookup(null,a=>{const s=a.trackData.get(this.internalTrack.id);if(!s)return{blockIndex:-1,correctBlockFound:!1};const n=lt(s.presentationTimestamps,i,l=>l.timestamp),o=n!==-1?s.presentationTimestamps[n].blockIndex:-1,c=n!==-1&&i<s.endTimestamp;return{blockIndex:o,correctBlockFound:c}},i,i,t)}async getNextPacket(e,t){const i=this.packetToClusterLocation.get(e);if(i===void 0)throw new Error("Packet was not created from this track.");return this.performClusterLookup(i.cluster,a=>{if(a===i.cluster){const s=a.trackData.get(this.internalTrack.id);if(i.blockIndex+1<s.blocks.length)return{blockIndex:i.blockIndex+1,correctBlockFound:!0}}else if(a.trackData.get(this.internalTrack.id))return{blockIndex:0,correctBlockFound:!0};return{blockIndex:-1,correctBlockFound:!1}},-1/0,1/0,t)}async getKeyPacket(e,t){const i=this.intoTimescale(e);return this.performClusterLookup(null,a=>{const s=a.trackData.get(this.internalTrack.id);if(!s)return{blockIndex:-1,correctBlockFound:!1};const n=fc(s.presentationTimestamps,l=>s.blocks[l.blockIndex].isKeyFrame&&l.timestamp<=i),o=n!==-1?s.presentationTimestamps[n].blockIndex:-1,c=n!==-1&&i<s.endTimestamp;return{blockIndex:o,correctBlockFound:c}},i,i,t)}async getNextKeyPacket(e,t){const i=this.packetToClusterLocation.get(e);if(i===void 0)throw new Error("Packet was not created from this track.");return this.performClusterLookup(i.cluster,a=>{if(a===i.cluster){const n=a.trackData.get(this.internalTrack.id).blocks.findIndex((o,c)=>o.isKeyFrame&&c>i.blockIndex);if(n!==-1)return{blockIndex:n,correctBlockFound:!0}}else{const s=a.trackData.get(this.internalTrack.id);if(s&&s.firstKeyFrameTimestamp!==null){const n=s.blocks.findIndex(o=>o.isKeyFrame);return I(n!==-1),{blockIndex:n,correctBlockFound:!0}}}return{blockIndex:-1,correctBlockFound:!1}},-1/0,1/0,t)}async fetchPacketInCluster(e,t,i){if(t===-1)return null;const s=e.trackData.get(this.internalTrack.id).blocks[t];I(s),s.decoded||(s.data=this.internalTrack.demuxer.decodeBlockData(this.internalTrack,s.data),s.decoded=!0);const n=i.metadataOnly?lr:s.data,o=s.timestamp/this.internalTrack.segment.timestampFactor,c=s.duration/this.internalTrack.segment.timestampFactor,l={};s.mainAdditional&&this.internalTrack.info?.type==="video"&&this.internalTrack.info.alphaMode&&(l.alpha=i.metadataOnly?lr:s.mainAdditional,l.alphaByteLength=s.mainAdditional.byteLength);const d=new mt(n,s.isKeyFrame?"key":"delta",o,c,e.dataStartPos+t,s.data.byteLength,l);return this.packetToClusterLocation.set(d,{cluster:e,blockIndex:t}),d}async performClusterLookup(e,t,i,a,s){const{demuxer:n,segment:o}=this.internalTrack;let c=null,l=null,d=-1;if(e){const{blockIndex:p,correctBlockFound:b}=t(e);if(b)return this.fetchPacketInCluster(e,p,s);p!==-1&&(l=e,d=p)}const u=lt(this.internalTrack.cuePoints,i,p=>p.time),f=u!==-1?this.internalTrack.cuePoints[u]:null,h=lt(this.internalTrack.clusterPositionCache,i,p=>p.startTimestamp),g=h!==-1?this.internalTrack.clusterPositionCache[h]:null,m=Math.max(f?.clusterPosition??0,g?.elementStartPos??0)||null;let v;for(e?m===null||e.elementStartPos>=m?(v=e.elementEndPos,c=e):v=m:v=m??o.clusterSeekStartPos;o.elementEndPos===null||v<=o.elementEndPos-nr;){if(c){const D=c.trackData.get(this.internalTrack.id);if(D&&D.startTimestamp>a)break}let p=n.reader.requestSliceRange(v,nr,Ar);if(p instanceof Promise&&(p=await p),!p)break;const b=v,y=Cr(p);if(!y||!da.includes(y.id)&&y.id!==N.Void){const D=await qc(n.reader,b,da,Math.min(o.elementEndPos??1/0,b+Gc));if(D){v=D;continue}else break}const _=y.id;let S=y.size;const A=p.filePos;if(_===N.Cluster){c=await n.readCluster(b,o),S=c.elementEndPos-A;const{blockIndex:D,correctBlockFound:M}=t(c);if(M)return this.fetchPacketInCluster(c,D,s);D!==-1&&(l=c,d=D)}S===void 0&&(I(_!==N.Cluster),S=(await qn(n.reader,A,Ca,o.elementEndPos)).pos-A);const z=A+S;if(o.elementEndPos===null){let D=n.reader.requestSliceRange(z,nr,Ar);if(D instanceof Promise&&(D=await D),!D)break;if(ks(D)===N.Segment){o.elementEndPos=z;break}}v=z}if(f&&(!l||l.elementStartPos<f.clusterPosition)){const p=this.internalTrack.cuePoints[u-1];I(!p||p.time<f.time);const b=p?.time??-1/0;return this.performClusterLookup(null,t,b,a,s)}return l?this.fetchPacketInCluster(l,d,s):null}}class Lf extends Qc{constructor(e){super(e),this.decoderConfigPromise=null,this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getCodedWidth(){return this.internalTrack.info.width}getCodedHeight(){return this.internalTrack.info.height}getRotation(){return this.internalTrack.info.rotation}async getColorSpace(){return{primaries:this.internalTrack.info.colorSpace?.primaries,transfer:this.internalTrack.info.colorSpace?.transfer,matrix:this.internalTrack.info.colorSpace?.matrix,fullRange:this.internalTrack.info.colorSpace?.fullRange}}async canBeTransparent(){return this.internalTrack.info.alphaMode}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfigPromise??=(async()=>{let e=null;return(this.internalTrack.info.codec==="vp9"||this.internalTrack.info.codec==="av1"||this.internalTrack.info.codec==="avc"&&!this.internalTrack.info.codecDescription||this.internalTrack.info.codec==="hevc"&&!this.internalTrack.info.codecDescription)&&(e=await this.getFirstPacket({})),{codec:gc({width:this.internalTrack.info.width,height:this.internalTrack.info.height,codec:this.internalTrack.info.codec,codecDescription:this.internalTrack.info.codecDescription,colorSpace:this.internalTrack.info.colorSpace,avcType:1,avcCodecInfo:this.internalTrack.info.codec==="avc"&&e?Pc(e.data):null,hevcCodecInfo:this.internalTrack.info.codec==="hevc"&&e?Ac(e.data):null,vp9CodecInfo:this.internalTrack.info.codec==="vp9"&&e?Fc(e.data):null,av1CodecInfo:this.internalTrack.info.codec==="av1"&&e?Bc(e.data):null}),codedWidth:this.internalTrack.info.width,codedHeight:this.internalTrack.info.height,description:this.internalTrack.info.codecDescription??void 0,colorSpace:this.internalTrack.info.colorSpace??void 0}})():null}}class $f extends Qc{constructor(e){super(e),this.decoderConfig=null,this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getNumberOfChannels(){return this.internalTrack.info.numberOfChannels}getSampleRate(){return this.internalTrack.info.sampleRate}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfig??={codec:vc({codec:this.internalTrack.info.codec,codecDescription:this.internalTrack.info.codecDescription,aacCodecInfo:this.internalTrack.info.aacCodecInfo}),numberOfChannels:this.internalTrack.info.numberOfChannels,sampleRate:this.internalTrack.info.sampleRate,description:this.internalTrack.info.codecDescription??void 0}:null}}const Xc=4,Wf=[44100,48e3,32e3],Hf=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,32,40,48,56,64,80,96,112,128,160,192,224,256,320,-1,-1,32,48,56,64,80,96,112,128,160,192,224,256,320,384,-1,-1,32,64,96,128,160,192,224,256,288,320,352,384,416,448,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1,-1,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1,-1,32,48,56,64,80,96,112,128,144,160,176,192,224,256,-1],jf=1483304551,qf=1231971951,Kf=(r,e,t,i,a)=>e===0?0:e===1?Math.floor(144*t/(i<<r))+a:e===2?Math.floor(144*t/i)+a:(Math.floor(12*t/i)+a)*4,Gf=(r,e)=>r===3?e===3?21:36:e===3?13:21,Qf=(r,e)=>{const t=r>>>24,i=r>>>16&255,a=r>>>8&255,s=r&255;if(t!==255&&i!==255&&a!==255&&s!==255)return{header:null,bytesAdvanced:4};if(t!==255)return{header:null,bytesAdvanced:1};if((i&224)!==224)return{header:null,bytesAdvanced:1};let n=0,o=0;i&16?n=i&8?0:1:(n=1,o=1);const c=i>>3&3,l=i>>1&3,d=a>>4&15,u=(a>>2&3)%3,f=a>>1&1,h=s>>6&3,g=s>>4&3,m=s>>3&1,v=s>>2&1,p=s&3,b=Hf[n*16*4+l*16+d];if(b===-1)return{header:null,bytesAdvanced:1};const y=b*1e3,_=Wf[u]>>n+o,S=Kf(n,l,y,_,f);if(e!==null&&e<S)return{header:null,bytesAdvanced:1};let A;return c===3?A=l===3?384:1152:l===3?A=384:l===2?A=1152:A=576,{header:{totalSize:S,mpegVersionId:c,layer:l,bitrate:y,frequencyIndex:u,sampleRate:_,channel:h,modeExtension:g,copyright:m,original:v,emphasis:p,audioSamplesInFrame:A},bytesAdvanced:1}},Kn=r=>{let e=2130706432,t=0;for(;e!==0;)t>>=1,t|=r&e,e>>=8;return t};var bi;(function(r){r[r.Unsynchronisation=128]="Unsynchronisation",r[r.ExtendedHeader=64]="ExtendedHeader",r[r.ExperimentalIndicator=32]="ExperimentalIndicator",r[r.Footer=16]="Footer"})(bi||(bi={}));var wi;(function(r){r[r.ISO_8859_1=0]="ISO_8859_1",r[r.UTF_16_WITH_BOM=1]="UTF_16_WITH_BOM",r[r.UTF_16_BE_NO_BOM=2]="UTF_16_BE_NO_BOM",r[r.UTF_8=3]="UTF_8"})(wi||(wi={}));const Pa=128,Na=10,yi=["Blues","Classic rock","Country","Dance","Disco","Funk","Grunge","Hip-hop","Jazz","Metal","New age","Oldies","Other","Pop","Rhythm and blues","Rap","Reggae","Rock","Techno","Industrial","Alternative","Ska","Death metal","Pranks","Soundtrack","Euro-techno","Ambient","Trip-hop","Vocal","Jazz & funk","Fusion","Trance","Classical","Instrumental","Acid","House","Game","Sound clip","Gospel","Noise","Alternative rock","Bass","Soul","Punk","Space","Meditative","Instrumental pop","Instrumental rock","Ethnic","Gothic","Darkwave","Techno-industrial","Electronic","Pop-folk","Eurodance","Dream","Southern rock","Comedy","Cult","Gangsta","Top 40","Christian rap","Pop/funk","Jungle music","Native US","Cabaret","New wave","Psychedelic","Rave","Showtunes","Trailer","Lo-fi","Tribal","Acid punk","Acid jazz","Polka","Retro","Musical","Rock 'n' roll","Hard rock","Folk","Folk rock","National folk","Swing","Fast fusion","Bebop","Latin","Revival","Celtic","Bluegrass","Avantgarde","Gothic rock","Progressive rock","Psychedelic rock","Symphonic rock","Slow rock","Big band","Chorus","Easy listening","Acoustic","Humour","Speech","Chanson","Opera","Chamber music","Sonata","Symphony","Booty bass","Primus","Porn groove","Satire","Slow jam","Club","Tango","Samba","Folklore","Ballad","Power ballad","Rhythmic Soul","Freestyle","Duet","Punk rock","Drum solo","A cappella","Euro-house","Dance hall","Goa music","Drum & bass","Club-house","Hardcore techno","Terror","Indie","Britpop","Negerpunk","Polsk punk","Beat","Christian gangsta rap","Heavy metal","Black metal","Crossover","Contemporary Christian","Christian rock","Merengue","Salsa","Thrash metal","Anime","Jpop","Synthpop","Christmas","Art rock","Baroque","Bhangra","Big beat","Breakbeat","Chillout","Downtempo","Dub","EBM","Eclectic","Electro","Electroclash","Emo","Experimental","Garage","Global","IDM","Illbient","Industro-Goth","Jam Band","Krautrock","Leftfield","Lounge","Math rock","New romantic","Nu-breakz","Post-punk","Post-rock","Psytrance","Shoegaze","Space rock","Trop rock","World music","Neoclassical","Audiobook","Audio theatre","Neue Deutsche Welle","Podcast","Indie rock","G-Funk","Dubstep","Garage rock","Psybient"],Xf=(r,e)=>{const t=r.filePos;e.raw??={},e.raw.TAG??=Ue(r,Pa-3),r.filePos=t;const i=li(r,30);i&&(e.title??=i);const a=li(r,30);a&&(e.artist??=a);const s=li(r,30);s&&(e.album??=s);const n=li(r,4),o=Number.parseInt(n,10);Number.isInteger(o)&&o>0&&(e.date??=new Date(o,0,1));const c=Ue(r,30);let l;if(c[28]===0&&c[29]!==0){const u=c[29];u>0&&(e.trackNumber??=u),r.skip(-30),l=li(r,28),r.skip(2)}else r.skip(-30),l=li(r,30);l&&(e.comment??=l);const d=Ce(r);d<yi.length&&(e.genre??=yi[d])},li=(r,e)=>{const t=Ue(r,e),i=fi(t.indexOf(0),t.length),a=t.subarray(0,i);let s="";for(let n=0;n<a.length;n++)s+=String.fromCharCode(a[n]);return s.trimEnd()},Oa=r=>{const e=r.filePos,t=Rt(r,3),i=Ce(r),a=Ce(r),s=Ce(r),n=ve(r);if(t!=="ID3"||i===255||a===255||(n&2155905152)!==0)return r.filePos=e,null;const o=Kn(n);return{majorVersion:i,revision:a,flags:s,size:o}},Zc=(r,e,t)=>{if(![2,3,4].includes(e.majorVersion)){console.warn(`Unsupported ID3v2 major version: ${e.majorVersion}`);return}const i=Ue(r,e.size),a=new Zf(e,i);if(e.flags&bi.Footer&&a.removeFooter(),e.flags&bi.Unsynchronisation&&e.majorVersion===3&&a.ununsynchronizeAll(),e.flags&bi.ExtendedHeader){const s=a.readU32();e.majorVersion===3?a.pos+=s:a.pos+=s-4}for(;a.pos<=a.bytes.length-a.frameHeaderSize();){const s=a.readId3V2Frame();if(!s)break;const n=a.pos,o=a.pos+s.size;let c=!1,l=!1,d=!1;if(e.majorVersion===3?(c=!!(s.flags&64),l=!!(s.flags&128)):e.majorVersion===4&&(c=!!(s.flags&4),l=!!(s.flags&8),d=!!(s.flags&2)||!!(e.flags&bi.Unsynchronisation)),c){console.warn(`Skipping encrypted ID3v2 frame ${s.id}`),a.pos=o;continue}if(l){console.warn(`Skipping compressed ID3v2 frame ${s.id}`),a.pos=o;continue}switch(d&&a.ununsynchronizeRegion(a.pos,o),t.raw??={},s.id[0]==="T"?t.raw[s.id]??=a.readId3V2EncodingAndText(o):t.raw[s.id]??=a.readBytes(s.size),a.pos=n,s.id){case"TIT2":case"TT2":t.title??=a.readId3V2EncodingAndText(o);break;case"TIT3":case"TT3":t.description??=a.readId3V2EncodingAndText(o);break;case"TPE1":case"TP1":t.artist??=a.readId3V2EncodingAndText(o);break;case"TALB":case"TAL":t.album??=a.readId3V2EncodingAndText(o);break;case"TPE2":case"TP2":t.albumArtist??=a.readId3V2EncodingAndText(o);break;case"TRCK":case"TRK":{const f=a.readId3V2EncodingAndText(o).split("/"),h=Number.parseInt(f[0],10),g=f[1]&&Number.parseInt(f[1],10);Number.isInteger(h)&&h>0&&(t.trackNumber??=h),g&&Number.isInteger(g)&&g>0&&(t.tracksTotal??=g)}break;case"TPOS":case"TPA":{const f=a.readId3V2EncodingAndText(o).split("/"),h=Number.parseInt(f[0],10),g=f[1]&&Number.parseInt(f[1],10);Number.isInteger(h)&&h>0&&(t.discNumber??=h),g&&Number.isInteger(g)&&g>0&&(t.discsTotal??=g)}break;case"TCON":case"TCO":{const u=a.readId3V2EncodingAndText(o);let f=/^\((\d+)\)/.exec(u);if(f){const h=Number.parseInt(f[1]);if(yi[h]!==void 0){t.genre??=yi[h];break}}if(f=/^\d+$/.exec(u),f){const h=Number.parseInt(f[0]);if(yi[h]!==void 0){t.genre??=yi[h];break}}t.genre??=u}break;case"TDRC":case"TDAT":{const u=a.readId3V2EncodingAndText(o),f=new Date(u);Number.isNaN(f.getTime())||(t.date??=f)}break;case"TYER":case"TYE":{const u=a.readId3V2EncodingAndText(o),f=Number.parseInt(u,10);Number.isInteger(f)&&(t.date??=new Date(f,0,1))}break;case"USLT":case"ULT":{const u=a.readU8();a.pos+=3,a.readId3V2Text(u,o),t.lyrics??=a.readId3V2Text(u,o)}break;case"COMM":case"COM":{const u=a.readU8();a.pos+=3,a.readId3V2Text(u,o),t.comment??=a.readId3V2Text(u,o)}break;case"APIC":case"PIC":{const u=a.readId3V2TextEncoding();let f;if(e.majorVersion===2){const v=a.readAscii(3);f=v==="PNG"?"image/png":v==="JPG"?"image/jpeg":"image/*"}else f=a.readId3V2Text(u,o);const h=a.readU8(),g=a.readId3V2Text(u,o).trimEnd(),m=o-a.pos;if(m>=0){const v=a.readBytes(m);t.images||(t.images=[]),t.images.push({data:v,mimeType:f,kind:h===3?"coverFront":h===4?"coverBack":"unknown",description:g})}}break;default:a.pos+=s.size;break}a.pos=o}};class Zf{constructor(e,t){this.header=e,this.bytes=t,this.pos=0,this.view=new DataView(t.buffer,t.byteOffset,t.byteLength)}frameHeaderSize(){return this.header.majorVersion===2?6:10}ununsynchronizeAll(){const e=[];for(let t=0;t<this.bytes.length;t++){const i=this.bytes[t];e.push(i),i===255&&t!==this.bytes.length-1&&this.bytes[t]===0&&t++}this.bytes=new Uint8Array(e),this.view=new DataView(this.bytes.buffer)}ununsynchronizeRegion(e,t){const i=[];for(let n=e;n<t;n++){const o=this.bytes[n];i.push(o),o===255&&n!==t-1&&this.bytes[n+1]===0&&n++}const a=this.bytes.subarray(0,e),s=this.bytes.subarray(t);this.bytes=new Uint8Array(a.length+i.length+s.length),this.bytes.set(a,0),this.bytes.set(i,a.length),this.bytes.set(s,a.length+i.length),this.view=new DataView(this.bytes.buffer)}removeFooter(){this.bytes=this.bytes.subarray(0,this.bytes.length-Na),this.view=new DataView(this.bytes.buffer)}readBytes(e){const t=this.bytes.subarray(this.pos,this.pos+e);return this.pos+=e,t}readU8(){const e=this.view.getUint8(this.pos);return this.pos+=1,e}readU16(){const e=this.view.getUint16(this.pos,!1);return this.pos+=2,e}readU24(){const e=this.view.getUint16(this.pos,!1),t=this.view.getUint8(this.pos+1);return this.pos+=3,e*256+t}readU32(){const e=this.view.getUint32(this.pos,!1);return this.pos+=4,e}readAscii(e){let t="";for(let i=0;i<e;i++)t+=String.fromCharCode(this.view.getUint8(this.pos+i));return this.pos+=e,t}readId3V2Frame(){if(this.header.majorVersion===2){const e=this.readAscii(3);if(e==="\0\0\0")return null;const t=this.readU24();return{id:e,size:t,flags:0}}else{const e=this.readAscii(4);if(e==="\0\0\0\0")return null;const t=this.readU32();let i=this.header.majorVersion===4?Kn(t):t;const a=this.readU16(),s=this.pos,n=o=>{const c=this.pos+o;if(c>this.bytes.length)return!1;if(c<=this.bytes.length-this.frameHeaderSize()){this.pos+=o;const l=this.readAscii(4);if(l!=="\0\0\0\0"&&!/[0-9A-Z]{4}/.test(l))return!1}return!0};if(!n(i)){const o=this.header.majorVersion===4?t:Kn(t);n(o)&&(i=o)}return this.pos=s,{id:e,size:i,flags:a}}}readId3V2TextEncoding(){const e=this.readU8();if(e>3)throw new Error(`Unsupported text encoding: ${e}`);return e}readId3V2Text(e,t){const i=this.pos,a=this.readBytes(t-this.pos);switch(e){case wi.ISO_8859_1:{let s="";for(let n=0;n<a.length;n++){const o=a[n];if(o===0){this.pos=i+n+1;break}s+=String.fromCharCode(o)}return s}case wi.UTF_16_WITH_BOM:if(a[0]===255&&a[1]===254){const s=new TextDecoder("utf-16le"),n=fi(a.findIndex((o,c)=>o===0&&a[c+1]===0&&c%2===0),a.length);return this.pos=i+Math.min(n+2,a.length),s.decode(a.subarray(2,n))}else if(a[0]===254&&a[1]===255){const s=new TextDecoder("utf-16be"),n=fi(a.findIndex((o,c)=>o===0&&a[c+1]===0&&c%2===0),a.length);return this.pos=i+Math.min(n+2,a.length),s.decode(a.subarray(2,n))}else{const s=fi(a.findIndex(n=>n===0),a.length);return this.pos=i+Math.min(s+1,a.length),or.decode(a.subarray(0,s))}case wi.UTF_16_BE_NO_BOM:{const s=new TextDecoder("utf-16be"),n=fi(a.findIndex((o,c)=>o===0&&a[c+1]===0&&c%2===0),a.length);return this.pos=i+Math.min(n+2,a.length),s.decode(a.subarray(0,n))}case wi.UTF_8:{const s=fi(a.findIndex(n=>n===0),a.length);return this.pos=i+Math.min(s+1,a.length),or.decode(a.subarray(0,s))}}}readId3V2EncodingAndText(e){if(this.pos>=e)return"";const t=this.readId3V2TextEncoding();return this.readId3V2Text(t,e)}}const Gn=async(r,e,t)=>{let i=e;for(;t===null||i<t;){let a=r.requestSlice(i,Xc);if(a instanceof Promise&&(a=await a),!a)break;const s=ve(a),n=Qf(s,r.fileSize!==null?r.fileSize-i:null);if(n.header)return{header:n.header,startPos:i};i+=n.bytesAdvanced}return null};class Yf extends si{constructor(e){super(e),this.metadataPromise=null,this.firstFrameHeader=null,this.loadedSamples=[],this.metadataTags=null,this.tracks=[],this.readingMutex=new $i,this.lastSampleLoaded=!1,this.lastLoadedPos=0,this.nextTimestampInSamples=0,this.reader=e._reader}async readMetadata(){return this.metadataPromise??=(async()=>{for(;!this.firstFrameHeader&&!this.lastSampleLoaded;)await this.advanceReader();if(!this.firstFrameHeader)throw new Error("No valid MP3 frame found.");this.tracks=[new Mr(this.input,new Jf(this))]})()}async advanceReader(){if(this.lastLoadedPos===0)for(;;){let o=this.reader.requestSlice(this.lastLoadedPos,Na);if(o instanceof Promise&&(o=await o),!o){this.lastSampleLoaded=!0;return}const c=Oa(o);if(!c)break;this.lastLoadedPos=o.filePos+c.size}const e=await Gn(this.reader,this.lastLoadedPos,this.reader.fileSize);if(!e){this.lastSampleLoaded=!0;return}const t=e.header;this.lastLoadedPos=e.startPos+t.totalSize-1;const i=Gf(t.mpegVersionId,t.channel);let a=this.reader.requestSlice(e.startPos+i,4);if(a instanceof Promise&&(a=await a),a){const o=ve(a);if(o===jf||o===qf)return}this.firstFrameHeader||(this.firstFrameHeader=t),t.sampleRate!==this.firstFrameHeader.sampleRate&&console.warn(`MP3 changed sample rate mid-file: ${this.firstFrameHeader.sampleRate} Hz to ${t.sampleRate} Hz. Might be a bug, so please report this file.`);const s=t.audioSamplesInFrame/this.firstFrameHeader.sampleRate,n={timestamp:this.nextTimestampInSamples/this.firstFrameHeader.sampleRate,duration:s,dataStart:e.startPos,dataSize:t.totalSize};this.loadedSamples.push(n),this.nextTimestampInSamples+=t.audioSamplesInFrame}async getMimeType(){return"audio/mpeg"}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){await this.readMetadata();const e=this.tracks[0];return I(e),e.computeDuration()}async getMetadataTags(){const e=await this.readingMutex.acquire();try{if(await this.readMetadata(),this.metadataTags)return this.metadataTags;this.metadataTags={};let t=0,i=!1;for(;;){let a=this.reader.requestSlice(t,Na);if(a instanceof Promise&&(a=await a),!a)break;const s=Oa(a);if(!s)break;i=!0;let n=this.reader.requestSlice(a.filePos,s.size);if(n instanceof Promise&&(n=await n),!n)break;Zc(n,s,this.metadataTags),t=a.filePos+s.size}if(!i&&this.reader.fileSize!==null&&this.reader.fileSize>=Pa){let a=this.reader.requestSlice(this.reader.fileSize-Pa,Pa);a instanceof Promise&&(a=await a),I(a),Rt(a,3)==="TAG"&&Xf(a,this.metadataTags)}return this.metadataTags}finally{e()}}}class Jf{constructor(e){this.demuxer=e}getId(){return 1}async getFirstTimestamp(){return 0}getTimeResolution(){return I(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.sampleRate/this.demuxer.firstFrameHeader.audioSamplesInFrame}async computeDuration(){const e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getName(){return null}getLanguageCode(){return er}getCodec(){return"mp3"}getInternalCodecId(){return null}getNumberOfChannels(){return I(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.channel===3?1:2}getSampleRate(){return I(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.sampleRate}getDisposition(){return{...ni}}async getDecoderConfig(){return I(this.demuxer.firstFrameHeader),{codec:"mp3",numberOfChannels:this.demuxer.firstFrameHeader.channel===3?1:2,sampleRate:this.demuxer.firstFrameHeader.sampleRate}}async getPacketAtIndex(e,t){if(e===-1)return null;const i=this.demuxer.loadedSamples[e];if(!i)return null;let a;if(t.metadataOnly)a=lr;else{let s=this.demuxer.reader.requestSlice(i.dataStart,i.dataSize);if(s instanceof Promise&&(s=await s),!s)return null;a=Ue(s,i.dataSize)}return new mt(a,"key",i.timestamp,i.duration,e,i.dataSize)}getFirstPacket(e){return this.getPacketAtIndex(0,e)}async getNextPacket(e,t){const i=await this.demuxer.readingMutex.acquire();try{const a=qa(this.demuxer.loadedSamples,e.timestamp,n=>n.timestamp);if(a===-1)throw new Error("Packet was not created from this track.");const s=a+1;for(;s>=this.demuxer.loadedSamples.length&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(s,t)}finally{i()}}async getPacket(e,t){const i=await this.demuxer.readingMutex.acquire();try{for(;;){const a=lt(this.demuxer.loadedSamples,e,s=>s.timestamp);if(a===-1&&this.demuxer.loadedSamples.length>0)return null;if(this.demuxer.lastSampleLoaded)return this.getPacketAtIndex(a,t);if(a>=0&&a+1<this.demuxer.loadedSamples.length)return this.getPacketAtIndex(a,t);await this.demuxer.advanceReader()}}finally{i()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}}const Yc=1399285583,eh=79764919,Jc=new Uint32Array(256);for(let r=0;r<256;r++){let e=r<<24;for(let t=0;t<8;t++)e=e&2147483648?e<<1^eh:e<<1;Jc[r]=e>>>0&4294967295}const th=r=>{const e=kt(r),t=e.getUint32(22,!0);e.setUint32(22,0,!0);let i=0;for(let a=0;a<r.length;a++){const s=r[a];i=(i<<8^Jc[i>>>24^s])>>>0}return e.setUint32(22,t,!0),i},rh=(r,e,t)=>{let i=0,a=null;if(r.length>0)if(e.codec==="vorbis"){I(e.vorbisInfo);const s=e.vorbisInfo.modeBlockflags.length,o=(1<<Mu(s-1))-1<<1,c=(r[0]&o)>>1;if(c>=e.vorbisInfo.modeBlockflags.length)throw new Error("Invalid mode number.");let l=t;const d=e.vorbisInfo.modeBlockflags[c];if(a=e.vorbisInfo.blocksizes[d],d===1){const u=(o|1)+1,f=r[0]&u?1:0;l=e.vorbisInfo.blocksizes[f]}i=l!==null?l+a>>2:0}else e.codec==="opus"&&(i=hf(r).durationInSamples);return{durationInSamples:i,vorbisBlockSize:a}},ih=r=>{let e="audio/ogg";if(r.codecStrings){const t=[...new Set(r.codecStrings)];e+=`; codecs="${t.join(", ")}"`}return e};const ti=27,Ai=282,ah=Ai+65025,ia=r=>{const e=r.filePos;if(ki(r)!==Yc)return null;r.skip(1);const i=Ce(r),a=Hh(r),s=ki(r),n=ki(r),o=ki(r),c=Ce(r),l=new Uint8Array(c);for(let h=0;h<c;h++)l[h]=Ce(r);const d=27+c,u=l.reduce((h,g)=>h+g,0),f=d+u;return{headerStartPos:e,totalSize:f,dataStartPos:e+d,dataSize:u,headerType:i,granulePosition:a,serialNumber:s,sequenceNumber:n,checksum:o,lacingValues:l}},nh=(r,e)=>{for(;r.filePos<e-3;){const t=ki(r),i=t&255,a=t>>>8&255,s=t>>>16&255,n=t>>>24&255,o=79;if(!(i!==o&&a!==o&&s!==o&&n!==o)){if(r.skip(-4),t===Yc)return!0;r.skip(1)}}return!1};class sh extends si{constructor(e){super(e),this.metadataPromise=null,this.bitstreams=[],this.tracks=[],this.metadataTags={},this.reader=e._reader}async readMetadata(){return this.metadataPromise??=(async()=>{let e=0;for(;;){let t=this.reader.requestSliceRange(e,ti,Ai);if(t instanceof Promise&&(t=await t),!t)break;const i=ia(t);if(!i||!!!(i.headerType&2))break;this.bitstreams.push({serialNumber:i.serialNumber,bosPage:i,description:null,numberOfChannels:-1,sampleRate:-1,codecInfo:{codec:null,vorbisInfo:null,opusInfo:null},lastMetadataPacket:null}),e=i.headerStartPos+i.totalSize}for(const t of this.bitstreams){const i=await this.readPacket(t.bosPage,0);i&&(i.data.byteLength>=7&&i.data[0]===1&&i.data[1]===118&&i.data[2]===111&&i.data[3]===114&&i.data[4]===98&&i.data[5]===105&&i.data[6]===115?await this.readVorbisMetadata(i,t):i.data.byteLength>=8&&i.data[0]===79&&i.data[1]===112&&i.data[2]===117&&i.data[3]===115&&i.data[4]===72&&i.data[5]===101&&i.data[6]===97&&i.data[7]===100&&await this.readOpusMetadata(i,t),t.codecInfo.codec!==null&&this.tracks.push(new Mr(this.input,new oh(t,this))))}})()}async readVorbisMetadata(e,t){let i=await this.findNextPacketStart(e);if(!i)return;const a=await this.readPacket(i.startPage,i.startSegmentIndex);if(!a||(i=await this.findNextPacketStart(a),!i))return;const s=await this.readPacket(i.startPage,i.startSegmentIndex);if(!s||a.data[0]!==3||s.data[0]!==5)return;const n=[],o=u=>{for(;n.push(Math.min(255,u)),!(u<255);)u-=255};o(e.data.length),o(a.data.length);const c=new Uint8Array(1+n.length+e.data.length+a.data.length+s.data.length);c[0]=2,c.set(n,1),c.set(e.data,1+n.length),c.set(a.data,1+n.length+e.data.length),c.set(s.data,1+n.length+e.data.length+a.data.length),t.codecInfo.codec="vorbis",t.description=c,t.lastMetadataPacket=s;const l=kt(e.data);t.numberOfChannels=l.getUint8(11),t.sampleRate=l.getUint32(12,!0);const d=l.getUint8(28);t.codecInfo.vorbisInfo={blocksizes:[1<<(d&15),1<<(d>>4)],modeBlockflags:mf(s.data).modeBlockflags},On(a.data.subarray(7),this.metadataTags)}async readOpusMetadata(e,t){const i=await this.findNextPacketStart(e);if(!i)return;const a=await this.readPacket(i.startPage,i.startSegmentIndex);if(!a)return;t.codecInfo.codec="opus",t.description=e.data,t.lastMetadataPacket=a;const s=gs(e.data);t.numberOfChannels=s.outputChannelCount,t.sampleRate=fa,t.codecInfo.opusInfo={preSkip:s.preSkip},On(a.data.subarray(8),this.metadataTags)}async readPacket(e,t){I(t<e.lacingValues.length);let i=0;for(let u=0;u<t;u++)i+=e.lacingValues[u];let a=e,s=i,n=t;const o=[];e:for(;;){let u=this.reader.requestSlice(a.dataStartPos,a.dataSize);u instanceof Promise&&(u=await u),I(u);const f=Ue(u,a.dataSize);for(;;){if(n===a.lacingValues.length){o.push(f.subarray(i,s));break}const g=a.lacingValues[n];if(s+=g,g<255){o.push(f.subarray(i,s));break e}n++}let h=a.headerStartPos+a.totalSize;for(;;){let g=this.reader.requestSliceRange(h,ti,Ai);if(g instanceof Promise&&(g=await g),!g)return null;const m=ia(g);if(!m)return null;if(a=m,a.serialNumber===e.serialNumber)break;h=a.headerStartPos+a.totalSize}i=0,s=0,n=0}const c=o.reduce((u,f)=>u+f.length,0);if(c===0)return null;const l=new Uint8Array(c);let d=0;for(let u=0;u<o.length;u++){const f=o[u];l.set(f,d),d+=f.length}return{data:l,endPage:a,endSegmentIndex:n}}async findNextPacketStart(e){if(e.endSegmentIndex<e.endPage.lacingValues.length-1)return{startPage:e.endPage,startSegmentIndex:e.endSegmentIndex+1};if(!!(e.endPage.headerType&4))return null;let i=e.endPage.headerStartPos+e.endPage.totalSize;for(;;){let a=this.reader.requestSliceRange(i,ti,Ai);if(a instanceof Promise&&(a=await a),!a)return null;const s=ia(a);if(!s)return null;if(s.serialNumber===e.endPage.serialNumber)return{startPage:s,startSegmentIndex:0};i=s.headerStartPos+s.totalSize}}async getMimeType(){await this.readMetadata();const e=await Promise.all(this.tracks.map(t=>t.getCodecParameterString()));return ih({codecStrings:e.filter(Boolean)})}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){const e=await this.getTracks(),t=await Promise.all(e.map(i=>i.computeDuration()));return Math.max(0,...t)}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}}class oh{constructor(e,t){this.bitstream=e,this.demuxer=t,this.encodedPacketToMetadata=new WeakMap,this.sequentialScanCache=[],this.sequentialScanMutex=new $i,this.internalSampleRate=e.codecInfo.codec==="opus"?fa:e.sampleRate}getId(){return this.bitstream.serialNumber}getNumberOfChannels(){return this.bitstream.numberOfChannels}getSampleRate(){return this.bitstream.sampleRate}getTimeResolution(){return this.bitstream.sampleRate}getCodec(){return this.bitstream.codecInfo.codec}getInternalCodecId(){return null}async getDecoderConfig(){return I(this.bitstream.codecInfo.codec),{codec:this.bitstream.codecInfo.codec,numberOfChannels:this.bitstream.numberOfChannels,sampleRate:this.bitstream.sampleRate,description:this.bitstream.description??void 0}}getName(){return null}getLanguageCode(){return er}getDisposition(){return{...ni}}async getFirstTimestamp(){return 0}async computeDuration(){const e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}granulePositionToTimestampInSamples(e){return this.bitstream.codecInfo.codec==="opus"?(I(this.bitstream.codecInfo.opusInfo),e-this.bitstream.codecInfo.opusInfo.preSkip):e}createEncodedPacketFromOggPacket(e,t,i){if(!e)return null;const{durationInSamples:a,vorbisBlockSize:s}=rh(e.data,this.bitstream.codecInfo,t.vorbisLastBlocksize),n=new mt(i.metadataOnly?lr:e.data,"key",Math.max(0,t.timestampInSamples)/this.internalSampleRate,a/this.internalSampleRate,e.endPage.headerStartPos+e.endSegmentIndex,e.data.byteLength);return this.encodedPacketToMetadata.set(n,{packet:e,timestampInSamples:t.timestampInSamples,durationInSamples:a,vorbisLastBlockSize:t.vorbisLastBlocksize,vorbisBlockSize:s}),n}async getFirstPacket(e){I(this.bitstream.lastMetadataPacket);const t=await this.demuxer.findNextPacketStart(this.bitstream.lastMetadataPacket);if(!t)return null;let i=0;this.bitstream.codecInfo.codec==="opus"&&(I(this.bitstream.codecInfo.opusInfo),i-=this.bitstream.codecInfo.opusInfo.preSkip);const a=await this.demuxer.readPacket(t.startPage,t.startSegmentIndex);return this.createEncodedPacketFromOggPacket(a,{timestampInSamples:i,vorbisLastBlocksize:null},e)}async getNextPacket(e,t){const i=this.encodedPacketToMetadata.get(e);if(!i)throw new Error("Packet was not created from this track.");const a=await this.demuxer.findNextPacketStart(i.packet);if(!a)return null;const s=i.timestampInSamples+i.durationInSamples,n=await this.demuxer.readPacket(a.startPage,a.startSegmentIndex);return this.createEncodedPacketFromOggPacket(n,{timestampInSamples:s,vorbisLastBlocksize:i.vorbisBlockSize},t)}async getPacket(e,t){if(this.demuxer.reader.fileSize===null)return this.getPacketSequential(e,t);const i=Ma(e*this.internalSampleRate);if(i===0)return this.getFirstPacket(t);if(i<0)return null;I(this.bitstream.lastMetadataPacket);const a=await this.demuxer.findNextPacketStart(this.bitstream.lastMetadataPacket);if(!a)return null;let s=a.startPage,n=this.demuxer.reader.fileSize;const o=[s];e:for(;s.headerStartPos+s.totalSize<n;){const b=s.headerStartPos,y=Math.floor((b+n)/2);let _=y;for(;;){const S=Math.min(_+ah,n-ti);let A=this.demuxer.reader.requestSlice(_,S-_);if(A instanceof Promise&&(A=await A),I(A),!nh(A,S)){n=y+ti;continue e}let D=this.demuxer.reader.requestSliceRange(A.filePos,ti,Ai);D instanceof Promise&&(D=await D),I(D);const M=ia(D);I(M);let $=!1;if(M.serialNumber===this.bitstream.serialNumber)$=!0;else{let P=this.demuxer.reader.requestSlice(M.headerStartPos,M.totalSize);P instanceof Promise&&(P=await P),I(P);const O=Ue(P,M.totalSize);$=th(O)===M.checksum}if(!$){_=M.headerStartPos+4;continue}if($&&M.serialNumber!==this.bitstream.serialNumber){_=M.headerStartPos+M.totalSize;continue}if(M.granulePosition===-1){_=M.headerStartPos+M.totalSize;continue}this.granulePositionToTimestampInSamples(M.granulePosition)>i?n=M.headerStartPos:(s=M,o.push(M));continue e}}let c=a.startPage;for(const b of o){if(b.granulePosition===s.granulePosition)break;(!c||b.headerStartPos>c.headerStartPos)&&(c=b)}let l=c;const d=[l];for(;!(l.serialNumber===this.bitstream.serialNumber&&l.granulePosition===s.granulePosition);){const b=l.headerStartPos+l.totalSize;let y=this.demuxer.reader.requestSliceRange(b,ti,Ai);y instanceof Promise&&(y=await y),I(y);const _=ia(y);I(_),l=_,l.serialNumber===this.bitstream.serialNumber&&d.push(l)}I(l.granulePosition!==-1);let u=null,f,h,g=l,m=0;if(l.headerStartPos===a.startPage.headerStartPos)f=this.granulePositionToTimestampInSamples(0),h=!0,u=0;else{f=0,h=!1;for(let _=l.lacingValues.length-1;_>=0;_--)if(l.lacingValues[_]<255){u=_+1;break}if(u===null)throw new Error("Invalid page with granule position: no packets end on this page.");m=u-1;const b={data:lr,endPage:g,endSegmentIndex:m};if(await this.demuxer.findNextPacketStart(b)){const _=ko(d,l,u);I(_);const S=yo(d,_.page,_.segmentIndex);S&&(l=S.page,u=S.segmentIndex)}else for(;;){const _=ko(d,l,u);if(!_)break;const S=yo(d,_.page,_.segmentIndex);if(!S)break;if(l=S.page,u=S.segmentIndex,_.page.headerStartPos!==g.headerStartPos){g=_.page,m=_.segmentIndex;break}}}let v=null,p=null;for(;l!==null;){I(u!==null);const b=await this.demuxer.readPacket(l,u);if(!b)break;if(!(l.headerStartPos===a.startPage.headerStartPos&&u<a.startSegmentIndex)){let S=this.createEncodedPacketFromOggPacket(b,{timestampInSamples:f,vorbisLastBlocksize:p?.vorbisBlockSize??null},t);I(S);let A=this.encodedPacketToMetadata.get(S);if(I(A),!h&&b.endPage.headerStartPos===g.headerStartPos&&b.endSegmentIndex===m?(f=this.granulePositionToTimestampInSamples(l.granulePosition),h=!0,S=this.createEncodedPacketFromOggPacket(b,{timestampInSamples:f-A.durationInSamples,vorbisLastBlocksize:p?.vorbisBlockSize??null},t),I(S),A=this.encodedPacketToMetadata.get(S),I(A)):f+=A.durationInSamples,v=S,p=A,h&&(Math.max(f,0)>i||Math.max(A.timestampInSamples,0)===i))break}const _=await this.demuxer.findNextPacketStart(b);if(!_)break;l=_.startPage,u=_.startSegmentIndex}return v}async getPacketSequential(e,t){const i=await this.sequentialScanMutex.acquire();try{const a=Ma(e*this.internalSampleRate);e=a/this.internalSampleRate;const s=lt(this.sequentialScanCache,a,c=>c.timestampInSamples);let n;if(s!==-1){const c=this.sequentialScanCache[s];n=this.createEncodedPacketFromOggPacket(c.packet,{timestampInSamples:c.timestampInSamples,vorbisLastBlocksize:c.vorbisLastBlockSize},t)}else n=await this.getFirstPacket(t);let o=0;for(;n&&n.timestamp<e;){const c=await this.getNextPacket(n,t);if(!c||c.timestamp>e)break;if(n=c,o++,o===100){o=0;const l=this.encodedPacketToMetadata.get(n);I(l),this.sequentialScanCache.length>0&&I(Ct(this.sequentialScanCache).timestampInSamples<=l.timestampInSamples),this.sequentialScanCache.push(l)}}return n}finally{i()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}}const yo=(r,e,t)=>{let i=e,a=t;e:for(;;){for(a--,a;a>=0;a--)if(i.lacingValues[a]<255){a++;break e}if(I(a===-1),!(i.headerType&1)){a=0;break}const n=uc(r,o=>o.headerStartPos<i.headerStartPos);if(!n)return null;i=n,a=i.lacingValues.length}if(I(a!==-1),a===i.lacingValues.length){const s=r[r.indexOf(i)+1];I(s),i=s,a=0}return{page:i,segmentIndex:a}},ko=(r,e,t)=>{if(t>0)return{page:e,segmentIndex:t-1};const i=uc(r,a=>a.headerStartPos<e.headerStartPos);return i?{page:i,segmentIndex:i.lacingValues.length-1}:null};var Sr;(function(r){r[r.PCM=1]="PCM",r[r.IEEE_FLOAT=3]="IEEE_FLOAT",r[r.ALAW=6]="ALAW",r[r.MULAW=7]="MULAW",r[r.EXTENSIBLE=65534]="EXTENSIBLE"})(Sr||(Sr={}));class ch extends si{constructor(e){super(e),this.metadataPromise=null,this.dataStart=-1,this.dataSize=-1,this.audioInfo=null,this.tracks=[],this.lastKnownPacketIndex=0,this.metadataTags={},this.reader=e._reader}async readMetadata(){return this.metadataPromise??=(async()=>{let e=this.reader.requestSlice(0,12);e instanceof Promise&&(e=await e),I(e);const t=Rt(e,4),i=t!=="RIFX",a=t==="RF64",s=Hr(e,i);let n=a?this.reader.fileSize:Math.min(s+8,this.reader.fileSize??1/0);if(Rt(e,4)!=="WAVE")throw new Error("Invalid WAVE file - wrong format");let c=0,l=null,d=e.filePos;for(;n===null||d<n;){let f=this.reader.requestSlice(d,8);if(f instanceof Promise&&(f=await f),!f)break;const h=Rt(f,4),g=Hr(f,i),m=f.filePos;if(a&&c===0&&h!=="ds64")throw new Error('Invalid RF64 file: First chunk must be "ds64".');if(h==="fmt ")await this.parseFmtChunk(m,g,i);else if(h==="data"){if(l??=g,this.dataStart=f.filePos,this.dataSize=Math.min(l,(n??1/0)-this.dataStart),this.reader.fileSize===null)break}else if(h==="ds64"){let v=this.reader.requestSlice(m,g);if(v instanceof Promise&&(v=await v),!v)break;const p=xo(v,i);l=xo(v,i),n=Math.min(p+8,this.reader.fileSize??1/0)}else h==="LIST"?await this.parseListChunk(m,g,i):(h==="ID3 "||h==="id3 ")&&await this.parseId3Chunk(m,g);d=m+g+(g&1),c++}if(!this.audioInfo)throw new Error('Invalid WAVE file - missing "fmt " chunk');if(this.dataStart===-1)throw new Error('Invalid WAVE file - missing "data" chunk');const u=this.audioInfo.blockSizeInBytes;this.dataSize=Math.floor(this.dataSize/u)*u,this.tracks.push(new Mr(this.input,new lh(this)))})()}async parseFmtChunk(e,t,i){let a=this.reader.requestSlice(e,t);if(a instanceof Promise&&(a=await a),!a)return;let s=Ki(a,i);const n=Ki(a,i),o=Hr(a,i);a.skip(4);const c=Ki(a,i);let l;if(t===14?l=8:l=Ki(a,i),t>=18&&s!==357){const d=Ki(a,i),u=t-18;if(Math.min(u,d)>=22&&s===Sr.EXTENSIBLE){a.skip(6);const h=Ue(a,16);s=h[0]|h[1]<<8}}(s===Sr.MULAW||s===Sr.ALAW)&&(l=8),this.audioInfo={format:s,numberOfChannels:n,sampleRate:o,sampleSizeInBytes:Math.ceil(l/8),blockSizeInBytes:c}}async parseListChunk(e,t,i){let a=this.reader.requestSlice(e,t);if(a instanceof Promise&&(a=await a),!a)return;const s=Rt(a,4);if(s!=="INFO"&&s!=="INF0")return;let n=a.filePos;for(;n<=e+t-8;){a.filePos=n;const o=Rt(a,4),c=Hr(a,i),l=Ue(a,c);let d=0;for(let f=0;f<l.length&&l[f]!==0;f++)d++;const u=String.fromCharCode(...l.subarray(0,d));switch(this.metadataTags.raw??={},this.metadataTags.raw[o]=u,o){case"INAM":case"TITL":this.metadataTags.title??=u;break;case"TIT3":this.metadataTags.description??=u;break;case"IART":this.metadataTags.artist??=u;break;case"IPRD":this.metadataTags.album??=u;break;case"IPRT":case"ITRK":case"TRCK":{const f=u.split("/"),h=Number.parseInt(f[0],10),g=f[1]&&Number.parseInt(f[1],10);Number.isInteger(h)&&h>0&&(this.metadataTags.trackNumber??=h),g&&Number.isInteger(g)&&g>0&&(this.metadataTags.tracksTotal??=g)}break;case"ICRD":case"IDIT":{const f=new Date(u);Number.isNaN(f.getTime())||(this.metadataTags.date??=f)}break;case"YEAR":{const f=Number.parseInt(u,10);Number.isInteger(f)&&f>0&&(this.metadataTags.date??=new Date(f,0,1))}break;case"IGNR":case"GENR":this.metadataTags.genre??=u;break;case"ICMT":case"CMNT":case"COMM":this.metadataTags.comment??=u;break}n+=8+c+(c&1)}}async parseId3Chunk(e,t){let i=this.reader.requestSlice(e,t);if(i instanceof Promise&&(i=await i),!i)return;const a=Oa(i);if(a){const s=i.slice(e+10,a.size);Zc(s,a,this.metadataTags)}}getCodec(){if(I(this.audioInfo),this.audioInfo.format===Sr.MULAW)return"ulaw";if(this.audioInfo.format===Sr.ALAW)return"alaw";if(this.audioInfo.format===Sr.PCM){if(this.audioInfo.sampleSizeInBytes===1)return"pcm-u8";if(this.audioInfo.sampleSizeInBytes===2)return"pcm-s16";if(this.audioInfo.sampleSizeInBytes===3)return"pcm-s24";if(this.audioInfo.sampleSizeInBytes===4)return"pcm-s32"}return this.audioInfo.format===Sr.IEEE_FLOAT&&this.audioInfo.sampleSizeInBytes===4?"pcm-f32":null}async getMimeType(){return"audio/wav"}async computeDuration(){await this.readMetadata();const e=this.tracks[0];return I(e),e.computeDuration()}async getTracks(){return await this.readMetadata(),this.tracks}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}}const di=2048;class lh{constructor(e){this.demuxer=e}getId(){return 1}getCodec(){return this.demuxer.getCodec()}getInternalCodecId(){return I(this.demuxer.audioInfo),this.demuxer.audioInfo.format}async getDecoderConfig(){const e=this.demuxer.getCodec();return e?(I(this.demuxer.audioInfo),{codec:e,numberOfChannels:this.demuxer.audioInfo.numberOfChannels,sampleRate:this.demuxer.audioInfo.sampleRate}):null}async computeDuration(){const e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getNumberOfChannels(){return I(this.demuxer.audioInfo),this.demuxer.audioInfo.numberOfChannels}getSampleRate(){return I(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getTimeResolution(){return I(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getName(){return null}getLanguageCode(){return er}getDisposition(){return{...ni}}async getFirstTimestamp(){return 0}async getPacketAtIndex(e,t){I(this.demuxer.audioInfo);const i=e*di*this.demuxer.audioInfo.blockSizeInBytes;if(i>=this.demuxer.dataSize)return null;const a=Math.min(di*this.demuxer.audioInfo.blockSizeInBytes,this.demuxer.dataSize-i);if(this.demuxer.reader.fileSize===null){let c=this.demuxer.reader.requestSlice(this.demuxer.dataStart+i,a);if(c instanceof Promise&&(c=await c),!c)return null}let s;if(t.metadataOnly)s=lr;else{let c=this.demuxer.reader.requestSlice(this.demuxer.dataStart+i,a);c instanceof Promise&&(c=await c),I(c),s=Ue(c,a)}const n=e*di/this.demuxer.audioInfo.sampleRate,o=a/this.demuxer.audioInfo.blockSizeInBytes/this.demuxer.audioInfo.sampleRate;return this.demuxer.lastKnownPacketIndex=Math.max(e,n),new mt(s,"key",n,o,e,a)}getFirstPacket(e){return this.getPacketAtIndex(0,e)}async getPacket(e,t){I(this.demuxer.audioInfo);const i=Math.floor(Math.min(e*this.demuxer.audioInfo.sampleRate/di,(this.demuxer.dataSize-1)/(di*this.demuxer.audioInfo.blockSizeInBytes))),a=await this.getPacketAtIndex(i,t);if(a)return a;if(i===0)return null;I(this.demuxer.reader.fileSize===null);let s=await this.getPacketAtIndex(this.demuxer.lastKnownPacketIndex,t);for(;s;){const n=await this.getNextPacket(s,t);if(!n)break;s=n}return s}getNextPacket(e,t){I(this.demuxer.audioInfo);const i=Math.round(e.timestamp*this.demuxer.audioInfo.sampleRate/di);return this.getPacketAtIndex(i+1,t)}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}}const Ua=7,Va=9,Qn=r=>{const e=r.filePos,t=Ue(r,9),i=new bt(t);if(i.readBits(12)!==4095||(i.skipBits(1),i.readBits(2)!==0))return null;const n=i.readBits(1),o=i.readBits(2)+1,c=i.readBits(4);if(c===15)return null;i.skipBits(1);const l=i.readBits(3);if(l===0)throw new Error("ADTS frames with channel configuration 0 are not supported.");i.skipBits(1),i.skipBits(1),i.skipBits(1),i.skipBits(1);const d=i.readBits(13);i.skipBits(11);const u=i.readBits(2)+1;if(u!==1)throw new Error("ADTS frames with more than one AAC frame are not supported.");let f=null;return n===1?r.filePos-=2:f=i.readBits(16),{objectType:o,samplingFrequencyIndex:c,channelConfiguration:l,frameLength:d,numberOfAacFrames:u,crcCheck:f,startPos:e}};const Xn=1024;class dh extends si{constructor(e){super(e),this.metadataPromise=null,this.firstFrameHeader=null,this.loadedSamples=[],this.tracks=[],this.readingMutex=new $i,this.lastSampleLoaded=!1,this.lastLoadedPos=0,this.nextTimestampInSamples=0,this.reader=e._reader}async readMetadata(){return this.metadataPromise??=(async()=>{for(;!this.firstFrameHeader&&!this.lastSampleLoaded;)await this.advanceReader();I(this.firstFrameHeader),this.tracks=[new Mr(this.input,new uh(this))]})()}async advanceReader(){let e=this.reader.requestSliceRange(this.lastLoadedPos,Ua,Va);if(e instanceof Promise&&(e=await e),!e){this.lastSampleLoaded=!0;return}const t=Qn(e);if(!t){this.lastSampleLoaded=!0;return}if(this.reader.fileSize!==null&&t.startPos+t.frameLength>this.reader.fileSize){this.lastSampleLoaded=!0;return}this.firstFrameHeader||(this.firstFrameHeader=t);const i=oa[t.samplingFrequencyIndex];I(i!==void 0);const a=Xn/i,s=t.crcCheck?Va:Ua,n={timestamp:this.nextTimestampInSamples/i,duration:a,dataStart:t.startPos+s,dataSize:t.frameLength-s};this.loadedSamples.push(n),this.nextTimestampInSamples+=Xn,this.lastLoadedPos=t.startPos+t.frameLength}async getMimeType(){return"audio/aac"}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){await this.readMetadata();const e=this.tracks[0];return I(e),e.computeDuration()}async getMetadataTags(){return{}}}class uh{constructor(e){this.demuxer=e}getId(){return 1}async getFirstTimestamp(){return 0}getTimeResolution(){return this.getSampleRate()/Xn}async computeDuration(){const e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getName(){return null}getLanguageCode(){return er}getCodec(){return"aac"}getInternalCodecId(){return I(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.objectType}getNumberOfChannels(){I(this.demuxer.firstFrameHeader);const e=ms[this.demuxer.firstFrameHeader.channelConfiguration];return I(e!==void 0),e}getSampleRate(){I(this.demuxer.firstFrameHeader);const e=oa[this.demuxer.firstFrameHeader.samplingFrequencyIndex];return I(e!==void 0),e}getDisposition(){return{...ni}}async getDecoderConfig(){I(this.demuxer.firstFrameHeader);const e=new Uint8Array(3),t=new bt(e),{objectType:i,samplingFrequencyIndex:a,channelConfiguration:s}=this.demuxer.firstFrameHeader;return i>31?(t.writeBits(5,31),t.writeBits(6,i-32)):t.writeBits(5,i),t.writeBits(4,a),t.writeBits(4,s),{codec:`mp4a.40.${this.demuxer.firstFrameHeader.objectType}`,numberOfChannels:this.getNumberOfChannels(),sampleRate:this.getSampleRate(),description:e.subarray(0,Math.ceil((t.pos-1)/8))}}async getPacketAtIndex(e,t){if(e===-1)return null;const i=this.demuxer.loadedSamples[e];if(!i)return null;let a;if(t.metadataOnly)a=lr;else{let s=this.demuxer.reader.requestSlice(i.dataStart,i.dataSize);if(s instanceof Promise&&(s=await s),!s)return null;a=Ue(s,i.dataSize)}return new mt(a,"key",i.timestamp,i.duration,e,i.dataSize)}getFirstPacket(e){return this.getPacketAtIndex(0,e)}async getNextPacket(e,t){const i=await this.demuxer.readingMutex.acquire();try{const a=qa(this.demuxer.loadedSamples,e.timestamp,n=>n.timestamp);if(a===-1)throw new Error("Packet was not created from this track.");const s=a+1;for(;s>=this.demuxer.loadedSamples.length&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(s,t)}finally{i()}}async getPacket(e,t){const i=await this.demuxer.readingMutex.acquire();try{for(;;){const a=lt(this.demuxer.loadedSamples,e,s=>s.timestamp);if(a===-1&&this.demuxer.loadedSamples.length>0)return null;if(this.demuxer.lastSampleLoaded)return this.getPacketAtIndex(a,t);if(a>=0&&a+1<this.demuxer.loadedSamples.length)return this.getPacketAtIndex(a,t);await this.demuxer.advanceReader()}}finally{i()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}}const fh=r=>r===0?null:r===1?192:r>=2&&r<=5?144*2**r:r===6?"uncommon-u8":r===7?"uncommon-u16":r>=8&&r<=15?2**r:null,hh=(r,e)=>{switch(r){case 0:return e;case 1:return 88200;case 2:return 176400;case 3:return 192e3;case 4:return 8e3;case 5:return 16e3;case 6:return 22050;case 7:return 24e3;case 8:return 32e3;case 9:return 44100;case 10:return 48e3;case 11:return 96e3;case 12:return"uncommon-u8";case 13:return"uncommon-u16";case 14:return"uncommon-u16-10";default:return null}},mh=r=>{let e=0;const t=new bt(Ue(r,1));for(;t.readBits(1)===1;)e++;if(e===0)return t.readBits(7);const i=[],a=e-1,s=new bt(Ue(r,a)),n=8-e-1;for(let c=0;c<n;c++)i.unshift(t.readBits(1));for(let c=0;c<a;c++)for(let l=0;l<8;l++){const d=s.readBits(1);l<2||i.unshift(d)}return i.reduce((c,l,d)=>c|l<<d,0)},ph=(r,e)=>{if(e==="uncommon-u16")return Ot(r)+1;if(e==="uncommon-u8")return Ce(r)+1;if(typeof e=="number")return e;pr(e),I(!1)},gh=(r,e)=>e==="uncommon-u16"?Ot(r):e==="uncommon-u16-10"?Ot(r)*10:e==="uncommon-u8"?Ce(r):typeof e=="number"?e:null,vh=r=>{let t=0;for(const i of r){t^=i;for(let a=0;a<8;a++)(t&128)!==0?t=t<<1^7:t<<=1,t&=255}return t};class bh extends si{constructor(e){super(e),this.loadedSamples=[],this.metadataPromise=null,this.track=null,this.metadataTags={},this.audioInfo=null,this.lastLoadedPos=null,this.blockingBit=null,this.readingMutex=new $i,this.lastSampleLoaded=!1,this.reader=e._reader}async computeDuration(){return await this.readMetadata(),I(this.track),this.track.computeDuration()}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}async getTracks(){return await this.readMetadata(),I(this.track),[this.track]}async getMimeType(){return"audio/flac"}async readMetadata(){let e=4;return this.metadataPromise??=(async()=>{for(;this.reader.fileSize===null||e<this.reader.fileSize;){let t=this.reader.requestSlice(e,4);if(t instanceof Promise&&(t=await t),e+=4,t===null)throw new Error(`Metadata block at position ${e} is too small! Corrupted file.`);I(t);const i=Ce(t),a=mi(t),s=(i&128)!==0;switch(i&127){case Ii.STREAMINFO:{let o=this.reader.requestSlice(e,a);if(o instanceof Promise&&(o=await o),I(o),o===null)throw new Error(`StreamInfo block at position ${e} is too small! Corrupted file.`);const c=Ue(o,34),l=new bt(c),d=l.readBits(16),u=l.readBits(16),f=l.readBits(24),h=l.readBits(24),g=l.readBits(20),m=l.readBits(3)+1;l.readBits(5);const v=l.readBits(36);l.skipBits(128);const p=new Uint8Array(42);p.set(new Uint8Array([102,76,97,67]),0),p.set(new Uint8Array([128,0,0,34]),4),p.set(c,8),this.audioInfo={numberOfChannels:m,sampleRate:g,totalSamples:v,minimumBlockSize:d,maximumBlockSize:u,minimumFrameSize:f,maximumFrameSize:h,description:p},this.track=new Mr(this.input,new wh(this));break}case Ii.VORBIS_COMMENT:{let o=this.reader.requestSlice(e,a);o instanceof Promise&&(o=await o),I(o),On(Ue(o,a),this.metadataTags);break}case Ii.PICTURE:{let o=this.reader.requestSlice(e,a);o instanceof Promise&&(o=await o),I(o);const c=ve(o),l=ve(o),d=or.decode(Ue(o,l)),u=ve(o),f=or.decode(Ue(o,u));o.skip(16);const h=ve(o),g=Ue(o,h);this.metadataTags.images??=[],this.metadataTags.images.push({data:g,mimeType:d,kind:c===3?"coverFront":c===4?"coverBack":"unknown",description:f});break}}if(e+=a,s){this.lastLoadedPos=e;break}}})()}async readNextFlacFrame({startPos:e,isFirstPacket:t}){I(this.audioInfo);const i=6,s=this.audioInfo.maximumFrameSize+16,n=await this.reader.requestSliceRange(e,this.audioInfo.minimumFrameSize,s);if(!n)return null;const o=this.readFlacFrameHeader({slice:n,isFirstPacket:t});if(!o)return null;for(n.filePos=e+this.audioInfo.minimumFrameSize;;){if(n.filePos>n.end-i)return{num:o.num,blockSize:o.blockSize,sampleRate:o.sampleRate,size:n.end-e,isLastFrame:!0};if(Ce(n)===255){const l=n.filePos,d=Ce(n),u=this.blockingBit===1?249:248;if(d!==u){n.filePos=l;continue}n.skip(-2);const f=n.filePos-e,h=this.readFlacFrameHeader({slice:n,isFirstPacket:!1});if(!h){n.filePos=l;continue}if(this.blockingBit===0){if(h.num-o.num!==1){n.filePos=l;continue}}else if(h.num-o.num!==o.blockSize){n.filePos=l;continue}return{num:o.num,blockSize:o.blockSize,sampleRate:o.sampleRate,size:f,isLastFrame:!1}}}}readFlacFrameHeader({slice:e,isFirstPacket:t}){const i=e.filePos,a=Ue(e,4),s=new bt(a);if(s.readBits(15)!==32764)return null;if(this.blockingBit===null){I(t);const v=s.readBits(1);this.blockingBit=v}else if(this.blockingBit===1){if(I(!t),s.readBits(1)!==1)return null}else if(this.blockingBit===0){if(I(!t),s.readBits(1)!==0)return null}else throw new Error("Invalid blocking bit");const o=fh(s.readBits(4));if(!o)return null;I(this.audioInfo);const c=hh(s.readBits(4),this.audioInfo.sampleRate);if(!c||(s.readBits(4),s.readBits(3),s.readBits(1)!==0))return null;const d=mh(e),u=ph(e,o),f=gh(e,c);if(f===null||f!==this.audioInfo.sampleRate)return null;const h=e.filePos-i,g=Ce(e);e.skip(-h),e.skip(-1);const m=vh(Ue(e,h));return g!==m?null:{num:d,blockSize:u,sampleRate:f}}async advanceReader(){await this.readMetadata(),I(this.lastLoadedPos!==null),I(this.audioInfo);const e=this.lastLoadedPos,t=await this.readNextFlacFrame({startPos:e,isFirstPacket:this.loadedSamples.length===0});if(!t){this.lastSampleLoaded=!0;return}const i=this.loadedSamples[this.loadedSamples.length-1],s={blockOffset:i?i.blockOffset+i.blockSize:0,blockSize:t.blockSize,byteOffset:e,byteSize:t.size};if(this.lastLoadedPos=this.lastLoadedPos+t.size,this.loadedSamples.push(s),t.isLastFrame){this.lastSampleLoaded=!0;return}}}class wh{constructor(e){this.demuxer=e}getId(){return 1}getCodec(){return"flac"}getInternalCodecId(){return null}getNumberOfChannels(){return I(this.demuxer.audioInfo),this.demuxer.audioInfo.numberOfChannels}async computeDuration(){const e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getSampleRate(){return I(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getName(){return null}getLanguageCode(){return er}getTimeResolution(){return I(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getDisposition(){return{...ni}}async getFirstTimestamp(){return 0}async getDecoderConfig(){return I(this.demuxer.audioInfo),{codec:"flac",numberOfChannels:this.demuxer.audioInfo.numberOfChannels,sampleRate:this.demuxer.audioInfo.sampleRate,description:this.demuxer.audioInfo.description}}async getPacket(e,t){if(I(this.demuxer.audioInfo),e<0)throw new Error("Timestamp cannot be negative");const i=await this.demuxer.readingMutex.acquire();try{for(;;){const a=lt(this.demuxer.loadedSamples,e,c=>c.blockOffset/this.demuxer.audioInfo.sampleRate);if(a===-1){await this.demuxer.advanceReader();continue}const s=this.demuxer.loadedSamples[a],n=s.blockOffset/this.demuxer.audioInfo.sampleRate,o=s.blockSize/this.demuxer.audioInfo.sampleRate;if(n+o<=e){if(this.demuxer.lastSampleLoaded)return this.getPacketAtIndex(this.demuxer.loadedSamples.length-1,t);await this.demuxer.advanceReader();continue}return this.getPacketAtIndex(a,t)}}finally{i()}}async getNextPacket(e,t){const i=await this.demuxer.readingMutex.acquire();try{const a=e.sequenceNumber+1;if(this.demuxer.lastSampleLoaded&&a>=this.demuxer.loadedSamples.length)return null;for(;a>=this.demuxer.loadedSamples.length&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(a,t)}finally{i()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}async getPacketAtIndex(e,t){const i=this.demuxer.loadedSamples[e];if(!i)return null;let a;if(t.metadataOnly)a=lr;else{let o=this.demuxer.reader.requestSlice(i.byteOffset,i.byteSize);if(o instanceof Promise&&(o=await o),!o)return null;a=Ue(o,i.byteSize)}I(this.demuxer.audioInfo);const s=i.blockOffset/this.demuxer.audioInfo.sampleRate,n=i.blockSize/this.demuxer.audioInfo.sampleRate;return new mt(a,"key",s,n,e,i.byteSize)}async getFirstPacket(e){for(;this.demuxer.loadedSamples.length===0&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(0,e)}}class qr{}class el extends qr{async _getMajorBrand(e){let t=e._reader.requestSlice(0,12);return t instanceof Promise&&(t=await t),!t||(t.skip(4),Rt(t,4)!=="ftyp")?null:Rt(t,4)}_createDemuxer(e){return new If(e)}}class yh extends el{async _canReadInput(e){const t=await this._getMajorBrand(e);return!!t&&t!=="qt  "}get name(){return"MP4"}get mimeType(){return"video/mp4"}}class kh extends el{async _canReadInput(e){return await this._getMajorBrand(e)==="qt  "}get name(){return"QuickTime File Format"}get mimeType(){return"video/quicktime"}}class tl extends qr{async isSupportedEBMLOfDocType(e,t){let i=e._reader.requestSlice(0,Ar);if(i instanceof Promise&&(i=await i),!i)return!1;const a=Hc(i);if(a===null||a<1||a>8||qe(i,a)!==N.EBML)return!1;const n=jc(i);if(typeof n!="number")return!1;let o=e._reader.requestSlice(i.filePos,n);if(o instanceof Promise&&(o=await o),!o)return!1;const c=i.filePos;for(;o.filePos<=c+n-nr;){const l=Cr(o);if(!l)break;const{id:d,size:u}=l,f=o.filePos;if(u===void 0)return!1;switch(d){case N.EBMLVersion:if(qe(o,u)!==1)return!1;break;case N.EBMLReadVersion:if(qe(o,u)!==1)return!1;break;case N.DocType:if(hi(o,u)!==t)return!1;break;case N.DocTypeVersion:if(qe(o,u)>4)return!1;break}o.filePos=f+u}return!0}_canReadInput(e){return this.isSupportedEBMLOfDocType(e,"matroska")}_createDemuxer(e){return new Vf(e)}get name(){return"Matroska"}get mimeType(){return"video/x-matroska"}}class xh extends tl{_canReadInput(e){return this.isSupportedEBMLOfDocType(e,"webm")}get name(){return"WebM"}get mimeType(){return"video/webm"}}class _h extends qr{async _canReadInput(e){let t=e._reader.requestSlice(0,10);if(t instanceof Promise&&(t=await t),!t)return!1;let i=0,a=!1;for(;;){let l=e._reader.requestSlice(i,Na);if(l instanceof Promise&&(l=await l),!l)break;const d=Oa(l);if(!d)break;a=!0,i=l.filePos+d.size}const s=await Gn(e._reader,i,i+4096);if(!s)return!1;if(a)return!0;i=s.startPos+s.header.totalSize;const n=await Gn(e._reader,i,i+Xc);if(!n)return!1;const o=s.header,c=n.header;return!(o.channel!==c.channel||o.sampleRate!==c.sampleRate)}_createDemuxer(e){return new Yf(e)}get name(){return"MP3"}get mimeType(){return"audio/mpeg"}}class Th extends qr{async _canReadInput(e){let t=e._reader.requestSlice(0,12);if(t instanceof Promise&&(t=await t),!t)return!1;const i=Rt(t,4);return i!=="RIFF"&&i!=="RIFX"&&i!=="RF64"?!1:(t.skip(4),Rt(t,4)==="WAVE")}_createDemuxer(e){return new ch(e)}get name(){return"WAVE"}get mimeType(){return"audio/wav"}}class Sh extends qr{async _canReadInput(e){let t=e._reader.requestSlice(0,4);return t instanceof Promise&&(t=await t),t?Rt(t,4)==="OggS":!1}_createDemuxer(e){return new sh(e)}get name(){return"Ogg"}get mimeType(){return"application/ogg"}}class Ch extends qr{async _canReadInput(e){let t=e._reader.requestSlice(0,4);return t instanceof Promise&&(t=await t),t?Rt(t,4)==="fLaC":!1}get name(){return"FLAC"}get mimeType(){return"audio/flac"}_createDemuxer(e){return new bh(e)}}class Ph extends qr{async _canReadInput(e){let t=e._reader.requestSliceRange(0,Ua,Va);if(t instanceof Promise&&(t=await t),!t)return!1;const i=Qn(t);if(!i||(t=e._reader.requestSliceRange(i.frameLength,Ua,Va),t instanceof Promise&&(t=await t),!t))return!1;const a=Qn(t);return a?i.objectType===a.objectType&&i.samplingFrequencyIndex===a.samplingFrequencyIndex&&i.channelConfiguration===a.channelConfiguration:!1}_createDemuxer(e){return new dh(e)}get name(){return"ADTS"}get mimeType(){return"audio/aac"}}const Eh=new yh,Ih=new kh,Ah=new tl,Fh=new xh,zh=new _h,Bh=new Th,Mh=new Sh,Rh=new Ph,Dh=new Ch,Nh=[Eh,Ih,Ah,Fh,Bh,Mh,Dh,zh,Rh];class rl{constructor(){this._disposed=!1,this._sizePromise=null,this.onread=null}async getSizeOrNull(){if(this._disposed)throw new Jt;return this._sizePromise??=Promise.resolve(this._retrieveSize())}async getSize(){if(this._disposed)throw new Jt;const e=await this.getSizeOrNull();if(e===null)throw new Error("Cannot determine the size of an unsized source.");return e}}class Oh extends rl{constructor(e,t={}){if(!(e instanceof Blob))throw new TypeError("blob must be a Blob.");if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.maxCacheSize!==void 0&&(!mc(t.maxCacheSize)||t.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative number.");super(),this._readers=new WeakMap,this._blob=e,this._orchestrator=new Vh({maxCacheSize:t.maxCacheSize??8*2**20,maxWorkerCount:4,runWorker:this._runWorker.bind(this),prefetchProfile:Uh.fileSystem})}_retrieveSize(){const e=this._blob.size;return this._orchestrator.fileSize=e,e}_read(e,t){return this._orchestrator.read(e,t)}async _runWorker(e){let t=this._readers.get(e);for(t===void 0&&("stream"in this._blob&&!ta()?t=this._blob.slice(e.currentPos).stream().getReader():t=null,this._readers.set(e,t));e.currentPos<e.targetPos&&!e.aborted;)if(t){const{done:i,value:a}=await t.read();if(i)throw this._orchestrator.forgetWorker(e),new Error("Blob reader stopped unexpectedly before all requested data was read.");if(e.aborted)break;this.onread?.(e.currentPos,e.currentPos+a.length),this._orchestrator.supplyWorkerData(e,a)}else{const i=await this._blob.slice(e.currentPos,e.targetPos).arrayBuffer();if(e.aborted)break;this.onread?.(e.currentPos,e.currentPos+i.byteLength),this._orchestrator.supplyWorkerData(e,new Uint8Array(i))}e.running=!1,e.aborted&&await t?.cancel()}_dispose(){this._orchestrator.dispose()}}const Uh={fileSystem:(r,e)=>(r=Math.floor((r-65536)/65536)*65536,e=Math.ceil((e+65536)/65536)*65536,{start:r,end:e})};class Vh{constructor(e){this.options=e,this.fileSize=null,this.nextAge=0,this.workers=[],this.cache=[],this.currentCacheSize=0,this.disposed=!1}read(e,t){I(this.fileSize!==null);const i=this.options.prefetchProfile(e,t,this.workers),a=Math.max(i.start,0),s=Math.min(i.end,this.fileSize);I(a<=e&&t<=s);let n=null;const o=lt(this.cache,e,b=>b.start),c=o!==-1?this.cache[o]:null;c&&c.start<=e&&t<=c.end&&(c.age=this.nextAge++,n={bytes:c.bytes,view:c.view,offset:c.start});const l=lt(this.cache,a,b=>b.start),d=n?null:new Uint8Array(t-e);let u=0,f=a;const h=[];if(l!==-1){for(let b=l;b<this.cache.length;b++){const y=this.cache[b];if(y.start>=s)break;if(y.end<=a)continue;const _=Math.max(a,y.start),S=Math.min(s,y.end);if(I(_<=S),f<_&&h.push({start:f,end:_}),f=S,d){const A=Math.max(e,y.start),z=Math.min(t,y.end);if(A<z){const D=A-e;d.set(y.bytes.subarray(A-y.start,z-y.start),D),D===u&&(u=z-e)}}y.age=this.nextAge++}f<s&&h.push({start:f,end:s})}else h.push({start:a,end:s});if(d&&u>=d.length&&(n={bytes:d,view:kt(d),offset:e}),h.length===0)return I(n),n;const{promise:g,resolve:m,reject:v}=Mt(),p=[];for(const b of h){const y=Math.max(e,b.start),_=Math.min(t,b.end);y===b.start&&_===b.end?p.push(b):y<_&&p.push({start:y,end:_})}for(const b of h){const y=d&&{start:e,bytes:d,holes:p,resolve:m,reject:v};let _=!1;for(const S of this.workers)if(io(b.start-131072,b.start,S.currentPos,S.targetPos)){S.targetPos=Math.max(S.targetPos,b.end),_=!0,y&&!S.pendingSlices.includes(y)&&S.pendingSlices.push(y),S.running||this.runWorker(S);break}if(!_){const S=this.createWorker(b.start,b.end);y&&(S.pendingSlices=[y]),this.runWorker(S)}}return n||(I(d),n=g.then(b=>({bytes:b,view:kt(b),offset:e}))),n}createWorker(e,t){const i={startPos:e,currentPos:e,targetPos:t,running:!1,aborted:this.disposed,pendingSlices:[],age:this.nextAge++};for(this.workers.push(i);this.workers.length>this.options.maxWorkerCount;){let a=0,s=this.workers[0];for(let n=1;n<this.workers.length;n++){const o=this.workers[n];o.age<s.age&&(a=n,s=o)}if(s.running&&s.pendingSlices.length>0)break;s.aborted=!0,this.workers.splice(a,1)}return i}runWorker(e){I(!e.running),I(e.currentPos<e.targetPos),e.running=!0,e.age=this.nextAge++,this.options.runWorker(e).catch(t=>{if(e.running=!1,e.pendingSlices.length>0)e.pendingSlices.forEach(i=>i.reject(t)),e.pendingSlices.length=0;else throw t})}supplyWorkerData(e,t){I(!e.aborted);const i=e.currentPos,a=i+t.length;this.insertIntoCache({start:i,end:a,bytes:t,view:kt(t),age:this.nextAge++}),e.currentPos+=t.length,e.targetPos=Math.max(e.targetPos,e.currentPos);for(let s=0;s<e.pendingSlices.length;s++){const n=e.pendingSlices[s],o=Math.max(i,n.start),c=Math.min(a,n.start+n.bytes.length);o<c&&n.bytes.set(t.subarray(o-i,c-i),o-n.start);for(let l=0;l<n.holes.length;l++){const d=n.holes[l];i<=d.start&&a>d.start&&(d.start=a),d.end<=d.start&&(n.holes.splice(l,1),l--)}n.holes.length===0&&(n.resolve(n.bytes),e.pendingSlices.splice(s,1),s--)}for(let s=0;s<this.workers.length;s++){const n=this.workers[s];e===n||n.running||io(i,a,n.currentPos,n.targetPos)&&(this.workers.splice(s,1),s--)}}forgetWorker(e){const t=this.workers.indexOf(e);I(t!==-1),this.workers.splice(t,1)}insertIntoCache(e){if(this.options.maxCacheSize===0)return;let t=lt(this.cache,e.start,i=>i.start)+1;if(t>0){const i=this.cache[t-1];if(i.end>=e.end)return;if(i.end>e.start){const a=new Uint8Array(e.end-i.start);a.set(i.bytes,0),a.set(e.bytes,e.start-i.start),this.currentCacheSize+=e.end-i.end,i.bytes=a,i.view=kt(a),i.end=e.end,t--,e=i}else this.cache.splice(t,0,e),this.currentCacheSize+=e.bytes.length}else this.cache.splice(t,0,e),this.currentCacheSize+=e.bytes.length;for(let i=t+1;i<this.cache.length;i++){const a=this.cache[i];if(e.end<=a.start)break;if(e.end>=a.end){this.cache.splice(i,1),this.currentCacheSize-=a.bytes.length,i--;continue}const s=new Uint8Array(a.end-e.start);s.set(e.bytes,0),s.set(a.bytes,a.start-e.start),this.currentCacheSize-=e.end-a.start,e.bytes=s,e.view=kt(s),e.end=a.end,this.cache.splice(i,1);break}for(;this.currentCacheSize>this.options.maxCacheSize;){let i=0,a=this.cache[0];for(let s=1;s<this.cache.length;s++){const n=this.cache[s];n.age<a.age&&(i=s,a=n)}if(this.currentCacheSize-a.bytes.length<=this.options.maxCacheSize)break;this.cache.splice(i,1),this.currentCacheSize-=a.bytes.length}}dispose(){for(const e of this.workers)e.aborted=!0;this.workers.length=0,this.cache.length=0,this.disposed=!0}}hc();class il{get disposed(){return this._disposed}constructor(e){if(this._demuxerPromise=null,this._format=null,this._disposed=!1,!e||typeof e!="object")throw new TypeError("options must be an object.");if(!Array.isArray(e.formats)||e.formats.some(t=>!(t instanceof qr)))throw new TypeError("options.formats must be an array of InputFormat.");if(!(e.source instanceof rl))throw new TypeError("options.source must be a Source.");if(e.source._disposed)throw new Error("options.source must not be disposed.");this._formats=e.formats,this._source=e.source,this._reader=new Lh(e.source)}_getDemuxer(){return this._demuxerPromise??=(async()=>{this._reader.fileSize=await this._source.getSizeOrNull();for(const e of this._formats)if(await e._canReadInput(this))return this._format=e,e._createDemuxer(this);throw new Error("Input has an unsupported or unrecognizable format.")})()}get source(){return this._source}async getFormat(){return await this._getDemuxer(),I(this._format),this._format}async computeDuration(){return(await this._getDemuxer()).computeDuration()}async getTracks(){return(await this._getDemuxer()).getTracks()}async getVideoTracks(){return(await this.getTracks()).filter(t=>t.isVideoTrack())}async getAudioTracks(){return(await this.getTracks()).filter(t=>t.isAudioTrack())}async getPrimaryVideoTrack(){return(await this.getTracks()).find(t=>t.isVideoTrack())??null}async getPrimaryAudioTrack(){return(await this.getTracks()).find(t=>t.isAudioTrack())??null}async getMimeType(){return(await this._getDemuxer()).getMimeType()}async getMetadataTags(){return(await this._getDemuxer()).getMetadataTags()}dispose(){this._disposed||(this._disposed=!0,this._source._disposed=!0,this._source._dispose())}[Symbol.dispose](){this.dispose()}}class Jt extends Error{constructor(e="Input has been disposed."){super(e),this.name="InputDisposedError"}}class Lh{constructor(e){this.source=e}requestSlice(e,t){if(this.source._disposed)throw new Jt;if(this.fileSize!==null&&e+t>this.fileSize)return null;const i=e+t,a=this.source._read(e,i);return a instanceof Promise?a.then(s=>s?new Ni(s.bytes,s.view,s.offset,e,i):null):a?new Ni(a.bytes,a.view,a.offset,e,i):null}requestSliceRange(e,t,i){if(this.source._disposed)throw new Jt;if(this.fileSize!==null)return this.requestSlice(e,Bt(this.fileSize-e,t,i));{const a=this.requestSlice(e,i),s=n=>{if(n)return n;const o=l=>(I(l!==null),this.requestSlice(e,Bt(l-e,t,i))),c=this.source._retrieveSize();return c instanceof Promise?c.then(o):o(c)};return a instanceof Promise?a.then(s):s(a)}}}class Ni{constructor(e,t,i,a,s){this.bytes=e,this.view=t,this.offset=i,this.start=a,this.end=s,this.bufferPos=a-i}static tempFromBytes(e){return new Ni(e,kt(e),0,0,e.length)}get length(){return this.end-this.start}get filePos(){return this.offset+this.bufferPos}set filePos(e){this.bufferPos=e-this.offset}get remainingLength(){return Math.max(this.end-this.filePos,0)}skip(e){this.bufferPos+=e}slice(e,t=this.end-e){if(e<this.start||e+t>this.end)throw new RangeError("Slicing outside of original slice.");return new Ni(this.bytes,this.view,this.offset,e,e+t)}}const Zt=(r,e)=>{if(r.filePos<r.start||r.filePos+e>r.end)throw new RangeError(`Tried reading [${r.filePos}, ${r.filePos+e}), but slice is [${r.start}, ${r.end}). This is likely an internal error, please report it alongside the file that caused it.`)},Ue=(r,e)=>{Zt(r,e);const t=r.bytes.subarray(r.bufferPos,r.bufferPos+e);return r.bufferPos+=e,t},Ce=r=>(Zt(r,1),r.view.getUint8(r.bufferPos++)),Ki=(r,e)=>{Zt(r,2);const t=r.view.getUint16(r.bufferPos,e);return r.bufferPos+=2,t},Ot=r=>{Zt(r,2);const e=r.view.getUint16(r.bufferPos,!1);return r.bufferPos+=2,e},mi=r=>{Zt(r,3);const e=Ka(r.view,r.bufferPos,!1);return r.bufferPos+=3,e},Zn=r=>{Zt(r,2);const e=r.view.getInt16(r.bufferPos,!1);return r.bufferPos+=2,e},Hr=(r,e)=>{Zt(r,4);const t=r.view.getUint32(r.bufferPos,e);return r.bufferPos+=4,t},ve=r=>{Zt(r,4);const e=r.view.getUint32(r.bufferPos,!1);return r.bufferPos+=4,e},ki=r=>{Zt(r,4);const e=r.view.getUint32(r.bufferPos,!0);return r.bufferPos+=4,e},ri=r=>{Zt(r,4);const e=r.view.getInt32(r.bufferPos,!1);return r.bufferPos+=4,e},$h=r=>{Zt(r,4);const e=r.view.getInt32(r.bufferPos,!0);return r.bufferPos+=4,e},xo=(r,e)=>{let t,i;return e?(t=Hr(r,!0),i=Hr(r,!0)):(i=Hr(r,!1),t=Hr(r,!1)),i*4294967296+t},hr=r=>{const e=ve(r),t=ve(r);return e*4294967296+t},Wh=r=>{const e=ri(r),t=ve(r);return e*4294967296+t},Hh=r=>{const e=ki(r);return $h(r)*4294967296+e},jh=r=>{Zt(r,4);const e=r.view.getFloat32(r.bufferPos,!1);return r.bufferPos+=4,e},al=r=>{Zt(r,8);const e=r.view.getFloat64(r.bufferPos,!1);return r.bufferPos+=8,e},Rt=(r,e)=>{Zt(r,e);let t="";for(let i=0;i<e;i++)t+=String.fromCharCode(r.bytes[r.bufferPos++]);return t};const La=/<(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})>/g,qh=/(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})/,Kh=r=>{const e=qh.exec(r);if(!e)throw new Error("Expected match.");return 3600*1e3*Number(e[1]||"0")+60*1e3*Number(e[2])+1e3*Number(e[3])+Number(e[4])},nl=r=>{const e=Math.floor(r/36e5),t=Math.floor(r%(3600*1e3)/(60*1e3)),i=Math.floor(r%(60*1e3)/1e3),a=r%1e3;return e.toString().padStart(2,"0")+":"+t.toString().padStart(2,"0")+":"+i.toString().padStart(2,"0")+"."+a.toString().padStart(3,"0")};class _o{constructor(e){this.writer=e,this.helper=new Uint8Array(8),this.helperView=new DataView(this.helper.buffer),this.offsets=new WeakMap}writeU32(e){this.helperView.setUint32(0,e,!1),this.writer.write(this.helper.subarray(0,4))}writeU64(e){this.helperView.setUint32(0,Math.floor(e/2**32),!1),this.helperView.setUint32(4,e,!1),this.writer.write(this.helper.subarray(0,8))}writeAscii(e){for(let t=0;t<e.length;t++)this.helperView.setUint8(t%8,e.charCodeAt(t)),t%8===7&&this.writer.write(this.helper);e.length%8!==0&&this.writer.write(this.helper.subarray(0,e.length%8))}writeBox(e){if(this.offsets.set(e,this.writer.getPos()),e.contents&&!e.children)this.writeBoxHeader(e,e.size??e.contents.byteLength+8),this.writer.write(e.contents);else{const t=this.writer.getPos();if(this.writeBoxHeader(e,0),e.contents&&this.writer.write(e.contents),e.children)for(const s of e.children)s&&this.writeBox(s);const i=this.writer.getPos(),a=e.size??i-t;this.writer.seek(t),this.writeBoxHeader(e,a),this.writer.seek(i)}}writeBoxHeader(e,t){this.writeU32(e.largeSize?1:t),this.writeAscii(e.type),e.largeSize&&this.writeU64(t)}measureBoxHeader(e){return 8+(e.largeSize?8:0)}patchBox(e){const t=this.offsets.get(e);I(t!==void 0);const i=this.writer.getPos();this.writer.seek(t),this.writeBox(e),this.writer.seek(i)}measureBox(e){if(e.contents&&!e.children)return this.measureBoxHeader(e)+e.contents.byteLength;{let t=this.measureBoxHeader(e);if(e.contents&&(t+=e.contents.byteLength),e.children)for(const i of e.children)i&&(t+=this.measureBox(i));return t}}}const Ye=new Uint8Array(8),xr=new DataView(Ye.buffer),wt=r=>[(r%256+256)%256],Pe=r=>(xr.setUint16(0,r,!1),[Ye[0],Ye[1]]),sl=r=>(xr.setInt16(0,r,!1),[Ye[0],Ye[1]]),ol=r=>(xr.setUint32(0,r,!1),[Ye[1],Ye[2],Ye[3]]),fe=r=>(xr.setUint32(0,r,!1),[Ye[0],Ye[1],Ye[2],Ye[3]]),Lr=r=>(xr.setInt32(0,r,!1),[Ye[0],Ye[1],Ye[2],Ye[3]]),ai=r=>(xr.setUint32(0,Math.floor(r/2**32),!1),xr.setUint32(4,r,!1),[Ye[0],Ye[1],Ye[2],Ye[3],Ye[4],Ye[5],Ye[6],Ye[7]]),cl=r=>(xr.setInt16(0,2**8*r,!1),[Ye[0],Ye[1]]),Pr=r=>(xr.setInt32(0,2**16*r,!1),[Ye[0],Ye[1],Ye[2],Ye[3]]),gn=r=>(xr.setInt32(0,2**30*r,!1),[Ye[0],Ye[1],Ye[2],Ye[3]]),vn=(r,e)=>{const t=[];let i=r;do{let a=i&127;i>>=7,t.length>0&&(a|=128),t.push(a)}while(i>0||e);return t.reverse()},Ut=(r,e=!1)=>{const t=Array(r.length).fill(null).map((i,a)=>r.charCodeAt(a));return e&&t.push(0),t},xs=r=>{let e=null;for(const t of r)(!e||t.timestamp>e.timestamp)&&(e=t);return e},ll=r=>{const e=r*(Math.PI/180),t=Math.round(Math.cos(e)),i=Math.round(Math.sin(e));return[t,i,0,-i,t,0,0,0,1]},dl=ll(0),ul=r=>[Pr(r[0]),Pr(r[1]),gn(r[2]),Pr(r[3]),Pr(r[4]),gn(r[5]),Pr(r[6]),Pr(r[7]),gn(r[8])],ze=(r,e,t)=>({type:r,contents:e&&new Uint8Array(e.flat(10)),children:t}),rt=(r,e,t,i,a)=>ze(r,[wt(e),ol(t),i??[]],a),Gh=r=>r.isQuickTime?ze("ftyp",[Ut("qt  "),fe(512),Ut("qt  ")]):r.fragmented?ze("ftyp",[Ut("iso5"),fe(512),Ut("iso5"),Ut("iso6"),Ut("mp41")]):ze("ftyp",[Ut("isom"),fe(512),Ut("isom"),r.holdsAvc?Ut("avc1"):[],Ut("mp41")]),xa=r=>({type:"mdat",largeSize:r}),Qh=r=>({type:"free",size:r}),Gi=r=>ze("moov",void 0,[Xh(r.creationTime,r.trackDatas),...r.trackDatas.map(e=>Zh(e,r.creationTime)),r.isFragmented?zm(r.trackDatas):null,jm(r)]),Xh=(r,e)=>{const t=Ft(Math.max(0,...e.filter(n=>n.samples.length>0).map(n=>{const o=xs(n.samples);return o.timestamp+o.duration})),Yn),i=Math.max(0,...e.map(n=>n.track.id))+1,a=!Mi(r)||!Mi(t),s=a?ai:fe;return rt("mvhd",+a,0,[s(r),s(r),fe(Yn),s(t),Pr(1),cl(1),Array(10).fill(0),ul(dl),Array(24).fill(0),fe(i)])},Zh=(r,e)=>{const t=ip(r);return ze("trak",void 0,[Yh(r,e),Jh(r,e),t.name!==void 0?ze("udta",void 0,[ze("name",[...Kt.encode(t.name)])]):null])},Yh=(r,e)=>{const t=xs(r.samples),i=Ft(t?t.timestamp+t.duration:0,Yn),a=!Mi(e)||!Mi(i),s=a?ai:fe;let n;if(r.type==="video"){const c=r.track.metadata.rotation;n=ll(c??0)}else n=dl;let o=2;return r.track.metadata.disposition?.default!==!1&&(o|=1),rt("tkhd",+a,o,[s(e),s(e),fe(r.track.id),fe(0),s(i),Array(8).fill(0),Pe(0),Pe(r.track.id),cl(r.type==="audio"?1:0),Pe(0),ul(n),Pr(r.type==="video"?r.info.width:0),Pr(r.type==="video"?r.info.height:0)])},Jh=(r,e)=>ze("mdia",void 0,[em(r,e),_s(!0,tm[r.type],rm[r.type]),im(r)]),em=(r,e)=>{const t=xs(r.samples),i=Ft(t?t.timestamp+t.duration:0,r.timescale),a=!Mi(e)||!Mi(i),s=a?ai:fe;return rt("mdhd",+a,0,[s(e),s(e),fe(r.timescale),s(i),Pe(pl(r.track.metadata.languageCode??er)),Pe(0)])},tm={video:"vide",audio:"soun",subtitle:"text"},rm={video:"MediabunnyVideoHandler",audio:"MediabunnySoundHandler",subtitle:"MediabunnyTextHandler"},_s=(r,e,t,i="\0\0\0\0")=>rt("hdlr",0,0,[r?Ut("mhlr"):fe(0),Ut(e),Ut(i),fe(0),fe(0),Ut(t,!0)]),im=r=>ze("minf",void 0,[om[r.type](),cm(),um(r)]),am=()=>rt("vmhd",0,1,[Pe(0),Pe(0),Pe(0),Pe(0)]),nm=()=>rt("smhd",0,0,[Pe(0),Pe(0)]),sm=()=>rt("nmhd",0,0),om={video:am,audio:nm,subtitle:sm},cm=()=>ze("dinf",void 0,[lm()]),lm=()=>rt("dref",0,0,[fe(1)],[dm()]),dm=()=>rt("url ",0,1),um=r=>{const e=r.compositionTimeOffsetTable.length>1||r.compositionTimeOffsetTable.some(t=>t.sampleCompositionTimeOffset!==0);return ze("stbl",void 0,[fm(r),Sm(r),e?Am(r):null,e?Fm(r):null,Pm(r),Em(r),Im(r),Cm(r)])},fm=r=>{let e;if(r.type==="video")e=hm(Qm(r.track.source._codec,r.info.decoderConfig.codec),r);else if(r.type==="audio"){const t=ml(r.track.source._codec,r.muxer.isQuickTime);I(t),e=bm(t,r)}else r.type==="subtitle"&&(e=_m(Ym[r.track.source._codec],r));return I(e),rt("stsd",0,0,[fe(1)],[e])},hm=(r,e)=>ze(r,[Array(6).fill(0),Pe(1),Pe(0),Pe(0),Array(12).fill(0),Pe(e.info.width),Pe(e.info.height),fe(4718592),fe(4718592),fe(0),Pe(1),Array(32).fill(0),Pe(24),sl(65535)],[Xm[e.track.source._codec](e),dc(e.info.decoderConfig.colorSpace)?mm(e):null]),mm=r=>ze("colr",[Ut("nclx"),Pe(Ui[r.info.decoderConfig.colorSpace.primaries]),Pe(Vi[r.info.decoderConfig.colorSpace.transfer]),Pe(Li[r.info.decoderConfig.colorSpace.matrix]),wt((r.info.decoderConfig.colorSpace.fullRange?1:0)<<7)]),pm=r=>r.info.decoderConfig&&ze("avcC",[...Vt(r.info.decoderConfig.description)]),gm=r=>r.info.decoderConfig&&ze("hvcC",[...Vt(r.info.decoderConfig.description)]),To=r=>{if(!r.info.decoderConfig)return null;const e=r.info.decoderConfig,t=e.codec.split("."),i=Number(t[1]),a=Number(t[2]),s=Number(t[3]),n=t[4]?Number(t[4]):1,o=t[8]?Number(t[8]):Number(e.colorSpace?.fullRange??0),c=(s<<4)+(n<<1)+o,l=t[5]?Number(t[5]):e.colorSpace?.primaries?Ui[e.colorSpace.primaries]:2,d=t[6]?Number(t[6]):e.colorSpace?.transfer?Vi[e.colorSpace.transfer]:2,u=t[7]?Number(t[7]):e.colorSpace?.matrix?Li[e.colorSpace.matrix]:2;return rt("vpcC",1,0,[wt(i),wt(a),wt(c),wt(l),wt(d),wt(u),Pe(0)])},vm=r=>ze("av1C",pc(r.info.decoderConfig.codec)),bm=(r,e)=>{let t=0,i,a=16;if(Dt.includes(e.track.source._codec)){const s=e.track.source._codec,{sampleSize:n}=Br(s);a=8*n,a>16&&(t=1)}return t===0?i=[Array(6).fill(0),Pe(1),Pe(t),Pe(0),fe(0),Pe(e.info.numberOfChannels),Pe(a),Pe(0),Pe(0),Pe(e.info.sampleRate<2**16?e.info.sampleRate:0),Pe(0)]:i=[Array(6).fill(0),Pe(1),Pe(t),Pe(0),fe(0),Pe(e.info.numberOfChannels),Pe(Math.min(a,16)),Pe(0),Pe(0),Pe(e.info.sampleRate<2**16?e.info.sampleRate:0),Pe(0),fe(1),fe(a/8),fe(e.info.numberOfChannels*a/8),fe(2)],ze(r,i,[Zm(e.track.source._codec,e.muxer.isQuickTime)?.(e)??null])},bn=r=>{let e;switch(r.track.source._codec){case"aac":e=64;break;case"mp3":e=107;break;case"vorbis":e=221;break;default:throw new Error(`Unhandled audio codec: ${r.track.source._codec}`)}let t=[...wt(e),...wt(21),...ol(0),...fe(0),...fe(0)];if(r.info.decoderConfig.description){const i=Vt(r.info.decoderConfig.description);t=[...t,...wt(5),...vn(i.byteLength),...i]}return t=[...Pe(1),...wt(0),...wt(4),...vn(t.length),...t,...wt(6),...wt(1),...wt(2)],t=[...wt(3),...vn(t.length),...t],rt("esds",0,0,t)},Dr=r=>ze("wave",void 0,[wm(r),ym(r),ze("\0\0\0\0")]),wm=r=>ze("frma",[Ut(ml(r.track.source._codec,r.muxer.isQuickTime))]),ym=r=>{const{littleEndian:e}=Br(r.track.source._codec);return ze("enda",[Pe(+e)])},km=r=>{let e=r.info.numberOfChannels,t=3840,i=r.info.sampleRate,a=0,s=0,n=new Uint8Array(0);const o=r.info.decoderConfig?.description;if(o){I(o.byteLength>=18);const c=Vt(o),l=gs(c);e=l.outputChannelCount,t=l.preSkip,i=l.inputSampleRate,a=l.outputGain,s=l.channelMappingFamily,l.channelMappingTable&&(n=l.channelMappingTable)}return ze("dOps",[wt(0),wt(e),Pe(t),fe(i),sl(a),wt(s),...n])},xm=r=>{const e=r.info.decoderConfig?.description;I(e);const t=Vt(e);return rt("dfLa",0,0,[...t.subarray(4)])},br=r=>{const{littleEndian:e,sampleSize:t}=Br(r.track.source._codec),i=+e;return rt("pcmC",0,0,[wt(i),wt(8*t)])},_m=(r,e)=>ze(r,[Array(6).fill(0),Pe(1)],[Jm[e.track.source._codec](e)]),Tm=r=>ze("vttC",[...Kt.encode(r.info.config.description)]),Sm=r=>rt("stts",0,0,[fe(r.timeToSampleTable.length),r.timeToSampleTable.map(e=>[fe(e.sampleCount),fe(e.sampleDelta)])]),Cm=r=>{if(r.samples.every(t=>t.type==="key"))return null;const e=[...r.samples.entries()].filter(([,t])=>t.type==="key");return rt("stss",0,0,[fe(e.length),e.map(([t])=>fe(t+1))])},Pm=r=>rt("stsc",0,0,[fe(r.compactlyCodedChunkTable.length),r.compactlyCodedChunkTable.map(e=>[fe(e.firstChunk),fe(e.samplesPerChunk),fe(1)])]),Em=r=>{if(r.type==="audio"&&r.info.requiresPcmTransformation){const{sampleSize:e}=Br(r.track.source._codec);return rt("stsz",0,0,[fe(e*r.info.numberOfChannels),fe(r.samples.reduce((t,i)=>t+Ft(i.duration,r.timescale),0))])}return rt("stsz",0,0,[fe(0),fe(r.samples.length),r.samples.map(e=>fe(e.size))])},Im=r=>r.finalizedChunks.length>0&&Ct(r.finalizedChunks).offset>=2**32?rt("co64",0,0,[fe(r.finalizedChunks.length),r.finalizedChunks.map(e=>ai(e.offset))]):rt("stco",0,0,[fe(r.finalizedChunks.length),r.finalizedChunks.map(e=>fe(e.offset))]),Am=r=>rt("ctts",1,0,[fe(r.compositionTimeOffsetTable.length),r.compositionTimeOffsetTable.map(e=>[fe(e.sampleCount),Lr(e.sampleCompositionTimeOffset)])]),Fm=r=>{let e=1/0,t=-1/0,i=1/0,a=-1/0;I(r.compositionTimeOffsetTable.length>0),I(r.samples.length>0);for(let n=0;n<r.compositionTimeOffsetTable.length;n++){const o=r.compositionTimeOffsetTable[n];e=Math.min(e,o.sampleCompositionTimeOffset),t=Math.max(t,o.sampleCompositionTimeOffset)}for(let n=0;n<r.samples.length;n++){const o=r.samples[n];i=Math.min(i,Ft(o.timestamp,r.timescale)),a=Math.max(a,Ft(o.timestamp+o.duration,r.timescale))}const s=Math.max(-e,0);return a>=2**31?null:rt("cslg",0,0,[Lr(s),Lr(e),Lr(t),Lr(i),Lr(a)])},zm=r=>ze("mvex",void 0,r.map(Bm)),Bm=r=>rt("trex",0,0,[fe(r.track.id),fe(1),fe(0),fe(0),fe(0)]),So=(r,e)=>ze("moof",void 0,[Mm(r),...e.map(Rm)]),Mm=r=>rt("mfhd",0,0,[fe(r)]),fl=r=>{let e=0,t=0;const i=0,a=0,s=r.type==="delta";return t|=+s,s?e|=1:e|=2,e<<24|t<<16|i<<8|a},Rm=r=>ze("traf",void 0,[Dm(r),Nm(r),Om(r)]),Dm=r=>{I(r.currentChunk);let e=0;e|=8,e|=16,e|=32,e|=131072;const t=r.currentChunk.samples[1]??r.currentChunk.samples[0],i={duration:t.timescaleUnitsToNextSample,size:t.size,flags:fl(t)};return rt("tfhd",0,e,[fe(r.track.id),fe(i.duration),fe(i.size),fe(i.flags)])},Nm=r=>(I(r.currentChunk),rt("tfdt",1,0,[ai(Ft(r.currentChunk.startTimestamp,r.timescale))])),Om=r=>{I(r.currentChunk);const e=r.currentChunk.samples.map(m=>m.timescaleUnitsToNextSample),t=r.currentChunk.samples.map(m=>m.size),i=r.currentChunk.samples.map(fl),a=r.currentChunk.samples.map(m=>Ft(m.timestamp-m.decodeTimestamp,r.timescale)),s=new Set(e),n=new Set(t),o=new Set(i),c=new Set(a),l=o.size===2&&i[0]!==i[1],d=s.size>1,u=n.size>1,f=!l&&o.size>1,h=c.size>1||[...c].some(m=>m!==0);let g=0;return g|=1,g|=4*+l,g|=256*+d,g|=512*+u,g|=1024*+f,g|=2048*+h,rt("trun",1,g,[fe(r.currentChunk.samples.length),fe(r.currentChunk.offset-r.currentChunk.moofOffset||0),l?fe(i[0]):[],r.currentChunk.samples.map((m,v)=>[d?fe(e[v]):[],u?fe(t[v]):[],f?fe(i[v]):[],h?Lr(a[v]):[]])])},Um=r=>ze("mfra",void 0,[...r.map(Vm),Lm()]),Vm=(r,e)=>rt("tfra",1,0,[fe(r.track.id),fe(63),fe(r.finalizedChunks.length),r.finalizedChunks.map(i=>[ai(Ft(i.samples[0].timestamp,r.timescale)),ai(i.moofOffset),fe(e+1),fe(1),fe(1)])]),Lm=()=>rt("mfro",0,0,[fe(0)]),$m=()=>ze("vtte"),Wm=(r,e,t,i,a)=>ze("vttc",void 0,[a!==null?ze("vsid",[Lr(a)]):null,t!==null?ze("iden",[...Kt.encode(t)]):null,e!==null?ze("ctim",[...Kt.encode(nl(e))]):null,i!==null?ze("sttg",[...Kt.encode(i)]):null,ze("payl",[...Kt.encode(r)])]),Hm=r=>ze("vtta",[...Kt.encode(r)]),jm=r=>{const e=[],t=r.format._options.metadataFormat??"auto",i=r.output._metadataTags;if(t==="mdir"||t==="auto"&&!r.isQuickTime){const a=Km(i);a&&e.push(a)}else if(t==="mdta"){const a=Gm(i);a&&e.push(a)}else(t==="udta"||t==="auto"&&r.isQuickTime)&&qm(e,r.output._metadataTags);return e.length===0?null:ze("udta",void 0,e)},qm=(r,e)=>{for(const{key:t,value:i}of fs(e))switch(t){case"title":r.push(wr("Â©nam",i));break;case"description":r.push(wr("Â©des",i));break;case"artist":r.push(wr("Â©ART",i));break;case"album":r.push(wr("Â©alb",i));break;case"albumArtist":r.push(wr("albr",i));break;case"genre":r.push(wr("Â©gen",i));break;case"date":r.push(wr("Â©day",i.toISOString().slice(0,10)));break;case"comment":r.push(wr("Â©cmt",i));break;case"lyrics":r.push(wr("Â©lyr",i));break;case"raw":break;case"discNumber":case"discsTotal":case"trackNumber":case"tracksTotal":case"images":break;default:pr(t)}if(e.raw)for(const t in e.raw){const i=e.raw[t];i==null||t.length!==4||r.some(a=>a.type===t)||(typeof i=="string"?r.push(wr(t,i)):i instanceof Uint8Array&&r.push(ze(t,Array.from(i))))}},wr=(r,e)=>{const t=Kt.encode(e);return ze(r,[Pe(t.length),Pe(pl("und")),Array.from(t)])},Co={"image/jpeg":13,"image/png":14,"image/bmp":27},hl=(r,e)=>{const t=[];for(const{key:i,value:a}of fs(r))switch(i){case"title":t.push({key:e?"title":"Â©nam",value:ur(a)});break;case"description":t.push({key:e?"description":"Â©des",value:ur(a)});break;case"artist":t.push({key:e?"artist":"Â©ART",value:ur(a)});break;case"album":t.push({key:e?"album":"Â©alb",value:ur(a)});break;case"albumArtist":t.push({key:e?"album_artist":"aART",value:ur(a)});break;case"comment":t.push({key:e?"comment":"Â©cmt",value:ur(a)});break;case"genre":t.push({key:e?"genre":"Â©gen",value:ur(a)});break;case"lyrics":t.push({key:e?"lyrics":"Â©lyr",value:ur(a)});break;case"date":t.push({key:e?"date":"Â©day",value:ur(a.toISOString().slice(0,10))});break;case"images":for(const s of a)s.kind==="coverFront"&&t.push({key:"covr",value:ze("data",[fe(Co[s.mimeType]??0),fe(0),Array.from(s.data)])});break;case"trackNumber":if(e){const s=r.tracksTotal!==void 0?`${a}/${r.tracksTotal}`:a.toString();t.push({key:"track",value:ur(s)})}else t.push({key:"trkn",value:ze("data",[fe(0),fe(0),Pe(0),Pe(a),Pe(r.tracksTotal??0),Pe(0)])});break;case"discNumber":e||t.push({key:"disc",value:ze("data",[fe(0),fe(0),Pe(0),Pe(a),Pe(r.discsTotal??0),Pe(0)])});break;case"tracksTotal":case"discsTotal":break;case"raw":break;default:pr(i)}if(r.raw)for(const i in r.raw){const a=r.raw[i];a==null||!e&&i.length!==4||t.some(s=>s.key===i)||(typeof a=="string"?t.push({key:i,value:ur(a)}):a instanceof Uint8Array?t.push({key:i,value:ze("data",[fe(0),fe(0),Array.from(a)])}):a instanceof Ci&&t.push({key:i,value:ze("data",[fe(Co[a.mimeType]??0),fe(0),Array.from(a.data)])}))}return t},Km=r=>{const e=hl(r,!1);return e.length===0?null:rt("meta",0,0,void 0,[_s(!1,"mdir","","appl"),ze("ilst",void 0,e.map(t=>ze(t.key,void 0,[t.value])))])},Gm=r=>{const e=hl(r,!0);return e.length===0?null:ze("meta",void 0,[_s(!1,"mdta",""),rt("keys",0,0,[fe(e.length)],e.map(t=>ze("mdta",[...Kt.encode(t.key)]))),ze("ilst",void 0,e.map((t,i)=>{const a=String.fromCharCode(...fe(i+1));return ze(a,void 0,[t.value])}))])},ur=r=>ze("data",[fe(1),fe(0),...Kt.encode(r)]),Qm=(r,e)=>{switch(r){case"avc":return e.startsWith("avc3")?"avc3":"avc1";case"hevc":return"hvc1";case"vp8":return"vp08";case"vp9":return"vp09";case"av1":return"av01"}},Xm={avc:pm,hevc:gm,vp8:To,vp9:To,av1:vm},ml=(r,e)=>{switch(r){case"aac":return"mp4a";case"mp3":return"mp4a";case"opus":return"Opus";case"vorbis":return"mp4a";case"flac":return"fLaC";case"ulaw":return"ulaw";case"alaw":return"alaw";case"pcm-u8":return"raw ";case"pcm-s8":return"sowt"}if(e)switch(r){case"pcm-s16":return"sowt";case"pcm-s16be":return"twos";case"pcm-s24":return"in24";case"pcm-s24be":return"in24";case"pcm-s32":return"in32";case"pcm-s32be":return"in32";case"pcm-f32":return"fl32";case"pcm-f32be":return"fl32";case"pcm-f64":return"fl64";case"pcm-f64be":return"fl64"}else switch(r){case"pcm-s16":return"ipcm";case"pcm-s16be":return"ipcm";case"pcm-s24":return"ipcm";case"pcm-s24be":return"ipcm";case"pcm-s32":return"ipcm";case"pcm-s32be":return"ipcm";case"pcm-f32":return"fpcm";case"pcm-f32be":return"fpcm";case"pcm-f64":return"fpcm";case"pcm-f64be":return"fpcm"}},Zm=(r,e)=>{switch(r){case"aac":return bn;case"mp3":return bn;case"opus":return km;case"vorbis":return bn;case"flac":return xm}if(e)switch(r){case"pcm-s24":return Dr;case"pcm-s24be":return Dr;case"pcm-s32":return Dr;case"pcm-s32be":return Dr;case"pcm-f32":return Dr;case"pcm-f32be":return Dr;case"pcm-f64":return Dr;case"pcm-f64be":return Dr}else switch(r){case"pcm-s16":return br;case"pcm-s16be":return br;case"pcm-s24":return br;case"pcm-s24be":return br;case"pcm-s32":return br;case"pcm-s32be":return br;case"pcm-f32":return br;case"pcm-f32be":return br;case"pcm-f64":return br;case"pcm-f64be":return br}return null},Ym={webvtt:"wvtt"},Jm={webvtt:Tm},pl=r=>{I(r.length===3);let e=0;for(let t=0;t<3;t++)e<<=5,e+=r.charCodeAt(t)-96;return e};class gl{constructor(){this.ensureMonotonicity=!1,this.trackedWrites=null,this.trackedStart=-1,this.trackedEnd=-1}start(){}maybeTrackWrites(e){if(!this.trackedWrites)return;let t=this.getPos();if(t<this.trackedStart){if(t+e.byteLength<=this.trackedStart)return;e=e.subarray(this.trackedStart-t),t=0}const i=t+e.byteLength-this.trackedStart;let a=this.trackedWrites.byteLength;for(;a<i;)a*=2;if(a!==this.trackedWrites.byteLength){const s=new Uint8Array(a);s.set(this.trackedWrites,0),this.trackedWrites=s}this.trackedWrites.set(e,t-this.trackedStart),this.trackedEnd=Math.max(this.trackedEnd,t+e.byteLength)}startTrackingWrites(){this.trackedWrites=new Uint8Array(2**10),this.trackedStart=this.getPos(),this.trackedEnd=this.trackedStart}stopTrackingWrites(){if(!this.trackedWrites)throw new Error("Internal error: Can't get tracked writes since nothing was tracked.");const t={data:this.trackedWrites.subarray(0,this.trackedEnd-this.trackedStart),start:this.trackedStart,end:this.trackedEnd};return this.trackedWrites=null,t}}const wn=2**16,yn=2**32;class vl extends gl{constructor(e){if(super(),this.pos=0,this.maxPos=0,this.target=e,this.supportsResize="resize"in new ArrayBuffer(0),this.supportsResize)try{this.buffer=new ArrayBuffer(wn,{maxByteLength:yn})}catch{this.buffer=new ArrayBuffer(wn),this.supportsResize=!1}else this.buffer=new ArrayBuffer(wn);this.bytes=new Uint8Array(this.buffer)}ensureSize(e){let t=this.buffer.byteLength;for(;t<e;)t*=2;if(t!==this.buffer.byteLength){if(t>yn)throw new Error(`ArrayBuffer exceeded maximum size of ${yn} bytes. Please consider using another target.`);if(this.supportsResize)this.buffer.resize(t);else{const i=new ArrayBuffer(t),a=new Uint8Array(i);a.set(this.bytes,0),this.buffer=i,this.bytes=a}}}write(e){this.maybeTrackWrites(e),this.ensureSize(this.pos+e.byteLength),this.bytes.set(e,this.pos),this.target.onwrite?.(this.pos,this.pos+e.byteLength),this.pos+=e.byteLength,this.maxPos=Math.max(this.maxPos,this.pos)}seek(e){this.pos=e}getPos(){return this.pos}async flush(){}async finalize(){this.ensureSize(this.pos),this.target.buffer=this.buffer.slice(0,Math.max(this.maxPos,this.pos))}async close(){}getSlice(e,t){return this.bytes.slice(e,t)}}class ep extends gl{constructor(e){super(),this.target=e,this.pos=0}write(e){this.maybeTrackWrites(e),this.target.onwrite?.(this.pos,this.pos+e.byteLength),this.pos+=e.byteLength}getPos(){return this.pos}seek(e){this.pos=e}async flush(){}async finalize(){}async close(){}}class Ts{constructor(){this._output=null,this.onwrite=null}}class bl extends Ts{constructor(){super(...arguments),this.buffer=null}_createWriter(){return new vl(this)}}class tp extends Ts{_createWriter(){return new ep(this)}}const Yn=1e3,rp=2082844800,ip=r=>{const e={},t=r.track;return t.metadata.name!==void 0&&(e.name=t.metadata.name),e},Ft=(r,e,t=!0)=>{const i=r*e;return t?Math.round(i):i};class ap extends _c{constructor(e,t){super(e),this.auxTarget=new bl,this.auxWriter=this.auxTarget._createWriter(),this.auxBoxWriter=new _o(this.auxWriter),this.mdat=null,this.ftypSize=null,this.trackDatas=[],this.allTracksKnown=Mt(),this.creationTime=Math.floor(Date.now()/1e3)+rp,this.finalizedChunks=[],this.nextFragmentNumber=1,this.maxWrittenTimestamp=-1/0,this.format=t,this.writer=e._writer,this.boxWriter=new _o(this.writer),this.isQuickTime=t instanceof yl;const i=this.writer instanceof vl?"in-memory":!1;this.fastStart=t._options.fastStart??i,this.isFragmented=this.fastStart==="fragmented",(this.fastStart==="in-memory"||this.isFragmented)&&(this.writer.ensureMonotonicity=!0),this.minimumFragmentDuration=t._options.minimumFragmentDuration??1}async start(){const e=await this.mutex.acquire(),t=this.output._tracks.some(i=>i.type==="video"&&i.source._codec==="avc");if(this.format._options.onFtyp&&this.writer.startTrackingWrites(),this.boxWriter.writeBox(Gh({isQuickTime:this.isQuickTime,holdsAvc:t,fragmented:this.isFragmented})),this.format._options.onFtyp){const{data:i,start:a}=this.writer.stopTrackingWrites();this.format._options.onFtyp(i,a)}if(this.ftypSize=this.writer.getPos(),this.fastStart!=="in-memory")if(this.fastStart==="reserve"){for(const i of this.output._tracks)if(i.metadata.maximumPacketCount===void 0)throw new Error("All tracks must specify maximumPacketCount in their metadata when using fastStart: 'reserve'.")}else this.isFragmented||(this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat=xa(!0),this.boxWriter.writeBox(this.mdat));await this.writer.flush(),e()}allTracksAreKnown(){for(const e of this.output._tracks)if(!e.source._closed&&!this.trackDatas.some(t=>t.track===e))return!1;return!0}async getMimeType(){await this.allTracksKnown.promise;const e=this.trackDatas.map(t=>t.type==="video"||t.type==="audio"?t.info.decoderConfig.codec:{webvtt:"wvtt"}[t.track.source._codec]);return Lc({isQuickTime:this.isQuickTime,hasVideo:this.trackDatas.some(t=>t.type==="video"),hasAudio:this.trackDatas.some(t=>t.type==="audio"),codecStrings:e})}getVideoTrackData(e,t,i){const a=this.trackDatas.find(l=>l.track===e);if(a)return a;yc(i),I(i),I(i.decoderConfig);const s={...i.decoderConfig};I(s.codedWidth!==void 0),I(s.codedHeight!==void 0);let n=!1;if(e.source._codec==="avc"&&!s.description){const l=Pc(t.data);if(!l)throw new Error("Couldn't extract an AVCDecoderConfigurationRecord from the AVC packet. Make sure the packets are in Annex B format (as specified in ITU-T-REC-H.264) when not providing a description, or provide a description (must be an AVCDecoderConfigurationRecord as specified in ISO 14496-15) and ensure the packets are in AVCC format.");s.description=rf(l),n=!0}else if(e.source._codec==="hevc"&&!s.description){const l=Ac(t.data);if(!l)throw new Error("Couldn't extract an HEVCDecoderConfigurationRecord from the HEVC packet. Make sure the packets are in Annex B format (as specified in ITU-T-REC-H.265) when not providing a description, or provide a description (must be an HEVCDecoderConfigurationRecord as specified in ISO 14496-15) and ensure the packets are in HEVC format.");s.description=uf(l),n=!0}const o=Du(1/(e.metadata.frameRate??57600),1e6).denominator,c={muxer:this,track:e,type:"video",info:{width:s.codedWidth,height:s.codedHeight,decoderConfig:s,requiresAnnexBTransformation:n},timescale:o,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[]};return this.trackDatas.push(c),this.trackDatas.sort((l,d)=>l.track.id-d.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),c}getAudioTrackData(e,t){const i=this.trackDatas.find(s=>s.track===e);if(i)return i;kc(t),I(t),I(t.decoderConfig);const a={muxer:this,track:e,type:"audio",info:{numberOfChannels:t.decoderConfig.numberOfChannels,sampleRate:t.decoderConfig.sampleRate,decoderConfig:t.decoderConfig,requiresPcmTransformation:!this.isFragmented&&Dt.includes(e.source._codec)},timescale:t.decoderConfig.sampleRate,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[]};return this.trackDatas.push(a),this.trackDatas.sort((s,n)=>s.track.id-n.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),a}getSubtitleTrackData(e,t){const i=this.trackDatas.find(s=>s.track===e);if(i)return i;xc(t),I(t),I(t.config);const a={muxer:this,track:e,type:"subtitle",info:{config:t.config},timescale:1e3,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[],lastCueEndTimestamp:0,cueQueue:[],nextSourceId:0,cueToSourceId:new WeakMap};return this.trackDatas.push(a),this.trackDatas.sort((s,n)=>s.track.id-n.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),a}async addEncodedVideoPacket(e,t,i){const a=await this.mutex.acquire();try{const s=this.getVideoTrackData(e,t,i);let n=t.data;if(s.info.requiresAnnexBTransformation){const l=ha(n);if(l.length===0)throw new Error("Failed to transform packet data. Make sure all packets are provided in Annex B format, as specified in ITU-T-REC-H.264 and ITU-T-REC-H.265.");n=Sc(l,4)}const o=this.validateAndNormalizeTimestamp(s.track,t.timestamp,t.type==="key"),c=this.createSampleForTrack(s,n,o,t.duration,t.type);await this.registerSample(s,c)}finally{a()}}async addEncodedAudioPacket(e,t,i){const a=await this.mutex.acquire();try{const s=this.getAudioTrackData(e,i),n=this.validateAndNormalizeTimestamp(s.track,t.timestamp,t.type==="key"),o=this.createSampleForTrack(s,t.data,n,t.duration,t.type);s.info.requiresPcmTransformation&&await this.maybePadWithSilence(s,n),await this.registerSample(s,o)}finally{a()}}async maybePadWithSilence(e,t){const i=Ct(e.samples),a=i?i.timestamp+i.duration:0,s=t-a,n=Ft(s,e.timescale);if(n>0){const{sampleSize:o,silentValue:c}=Br(e.info.decoderConfig.codec),l=n*e.info.numberOfChannels,d=new Uint8Array(o*l).fill(c),u=this.createSampleForTrack(e,new Uint8Array(d.buffer),a,s,"key");await this.registerSample(e,u)}}async addSubtitleCue(e,t,i){const a=await this.mutex.acquire();try{const s=this.getSubtitleTrackData(e,i);this.validateAndNormalizeTimestamp(s.track,t.timestamp,!0),e.source._codec==="webvtt"&&(s.cueQueue.push(t),await this.processWebVTTCues(s,t.timestamp))}finally{a()}}async processWebVTTCues(e,t){for(;e.cueQueue.length>0;){const i=new Set([]);for(const l of e.cueQueue)I(l.timestamp<=t),I(e.lastCueEndTimestamp<=l.timestamp+l.duration),i.add(Math.max(l.timestamp,e.lastCueEndTimestamp)),i.add(l.timestamp+l.duration);const a=[...i].sort((l,d)=>l-d),s=a[0],n=a[1]??s;if(t<n)break;if(e.lastCueEndTimestamp<s){this.auxWriter.seek(0);const l=$m();this.auxBoxWriter.writeBox(l);const d=this.auxWriter.getSlice(0,this.auxWriter.getPos()),u=this.createSampleForTrack(e,d,e.lastCueEndTimestamp,s-e.lastCueEndTimestamp,"key");await this.registerSample(e,u),e.lastCueEndTimestamp=s}this.auxWriter.seek(0);for(let l=0;l<e.cueQueue.length;l++){const d=e.cueQueue[l];if(d.timestamp>=n)break;La.lastIndex=0;const u=La.test(d.text),f=d.timestamp+d.duration;let h=e.cueToSourceId.get(d);if(h===void 0&&n<f&&(h=e.nextSourceId++,e.cueToSourceId.set(d,h)),d.notes){const m=Hm(d.notes);this.auxBoxWriter.writeBox(m)}const g=Wm(d.text,u?s:null,d.identifier??null,d.settings??null,h??null);this.auxBoxWriter.writeBox(g),f===n&&e.cueQueue.splice(l--,1)}const o=this.auxWriter.getSlice(0,this.auxWriter.getPos()),c=this.createSampleForTrack(e,o,s,n-s,"key");await this.registerSample(e,c),e.lastCueEndTimestamp=n}}createSampleForTrack(e,t,i,a,s){return{timestamp:i,decodeTimestamp:i,duration:a,data:t,size:t.byteLength,type:s,timescaleUnitsToNextSample:Ft(a,e.timescale)}}processTimestamps(e,t){if(e.timestampProcessingQueue.length===0)return;if(e.type==="audio"&&e.info.requiresPcmTransformation){let a=0;for(let s=0;s<e.timestampProcessingQueue.length;s++){const n=e.timestampProcessingQueue[s],o=Ft(n.duration,e.timescale);a+=o}if(e.timeToSampleTable.length===0)e.timeToSampleTable.push({sampleCount:a,sampleDelta:1});else{const s=Ct(e.timeToSampleTable);s.sampleCount+=a}e.timestampProcessingQueue.length=0;return}const i=e.timestampProcessingQueue.map(a=>a.timestamp).sort((a,s)=>a-s);for(let a=0;a<e.timestampProcessingQueue.length;a++){const s=e.timestampProcessingQueue[a];s.decodeTimestamp=i[a],!this.isFragmented&&e.lastTimescaleUnits===null&&(s.decodeTimestamp=0);const n=Ft(s.timestamp-s.decodeTimestamp,e.timescale),o=Ft(s.duration,e.timescale);if(e.lastTimescaleUnits!==null){I(e.lastSample);const c=Ft(s.decodeTimestamp,e.timescale,!1),l=Math.round(c-e.lastTimescaleUnits);if(I(l>=0),e.lastTimescaleUnits+=l,e.lastSample.timescaleUnitsToNextSample=l,!this.isFragmented){let d=Ct(e.timeToSampleTable);if(I(d),d.sampleCount===1){d.sampleDelta=l;const f=e.timeToSampleTable[e.timeToSampleTable.length-2];f&&f.sampleDelta===l&&(f.sampleCount++,e.timeToSampleTable.pop(),d=f)}else d.sampleDelta!==l&&(d.sampleCount--,e.timeToSampleTable.push(d={sampleCount:1,sampleDelta:l}));d.sampleDelta===o?d.sampleCount++:e.timeToSampleTable.push({sampleCount:1,sampleDelta:o});const u=Ct(e.compositionTimeOffsetTable);I(u),u.sampleCompositionTimeOffset===n?u.sampleCount++:e.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:n})}}else e.lastTimescaleUnits=Ft(s.decodeTimestamp,e.timescale,!1),this.isFragmented||(e.timeToSampleTable.push({sampleCount:1,sampleDelta:o}),e.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:n}));e.lastSample=s}if(e.timestampProcessingQueue.length=0,I(e.lastSample),I(e.lastTimescaleUnits!==null),t!==void 0&&e.lastSample.timescaleUnitsToNextSample===0){I(t.type==="key");const a=Ft(t.timestamp,e.timescale,!1),s=Math.round(a-e.lastTimescaleUnits);e.lastSample.timescaleUnitsToNextSample=s}}async registerSample(e,t){t.type==="key"&&this.processTimestamps(e,t),e.timestampProcessingQueue.push(t),this.isFragmented?(e.sampleQueue.push(t),await this.interleaveSamples()):this.fastStart==="reserve"?await this.registerSampleFastStartReserve(e,t):await this.addSampleToTrack(e,t)}async addSampleToTrack(e,t){if(!this.isFragmented&&(e.samples.push(t),this.fastStart==="reserve")){const a=e.track.metadata.maximumPacketCount;if(I(a!==void 0),e.samples.length>a)throw new Error(`Track #${e.track.id} has already reached the maximum packet count (${a}). Either add less packets or increase the maximum packet count.`)}let i=!1;if(!e.currentChunk)i=!0;else{e.currentChunk.startTimestamp=Math.min(e.currentChunk.startTimestamp,t.timestamp);const a=t.timestamp-e.currentChunk.startTimestamp;if(this.isFragmented){const s=this.trackDatas.every(n=>{if(e===n)return t.type==="key";const o=n.sampleQueue[0];return o?o.type==="key":n.track.source._closed});a>=this.minimumFragmentDuration&&s&&t.timestamp>this.maxWrittenTimestamp&&(i=!0,await this.finalizeFragment())}else i=a>=.5}i&&(e.currentChunk&&await this.finalizeCurrentChunk(e),e.currentChunk={startTimestamp:t.timestamp,samples:[],offset:null,moofOffset:null}),I(e.currentChunk),e.currentChunk.samples.push(t),this.isFragmented&&(this.maxWrittenTimestamp=Math.max(this.maxWrittenTimestamp,t.timestamp))}async finalizeCurrentChunk(e){if(I(!this.isFragmented),!e.currentChunk)return;e.finalizedChunks.push(e.currentChunk),this.finalizedChunks.push(e.currentChunk);let t=e.currentChunk.samples.length;if(e.type==="audio"&&e.info.requiresPcmTransformation&&(t=e.currentChunk.samples.reduce((i,a)=>i+Ft(a.duration,e.timescale),0)),(e.compactlyCodedChunkTable.length===0||Ct(e.compactlyCodedChunkTable).samplesPerChunk!==t)&&e.compactlyCodedChunkTable.push({firstChunk:e.finalizedChunks.length,samplesPerChunk:t}),this.fastStart==="in-memory"){e.currentChunk.offset=0;return}e.currentChunk.offset=this.writer.getPos();for(const i of e.currentChunk.samples)I(i.data),this.writer.write(i.data),i.data=null;await this.writer.flush()}async interleaveSamples(e=!1){if(I(this.isFragmented),!(!e&&!this.allTracksAreKnown()))e:for(;;){let t=null,i=1/0;for(const s of this.trackDatas){if(!e&&s.sampleQueue.length===0&&!s.track.source._closed)break e;s.sampleQueue.length>0&&s.sampleQueue[0].timestamp<i&&(t=s,i=s.sampleQueue[0].timestamp)}if(!t)break;const a=t.sampleQueue.shift();await this.addSampleToTrack(t,a)}}async finalizeFragment(e=!0){I(this.isFragmented);const t=this.nextFragmentNumber++;if(t===1){this.format._options.onMoov&&this.writer.startTrackingWrites();const h=Gi(this);if(this.boxWriter.writeBox(h),this.format._options.onMoov){const{data:g,start:m}=this.writer.stopTrackingWrites();this.format._options.onMoov(g,m)}}const i=this.trackDatas.filter(h=>h.currentChunk),a=So(t,i),s=this.writer.getPos(),n=s+this.boxWriter.measureBox(a);let o=n+Ir,c=1/0;for(const h of i){h.currentChunk.offset=o,h.currentChunk.moofOffset=s;for(const g of h.currentChunk.samples)o+=g.size;c=Math.min(c,h.currentChunk.startTimestamp)}const l=o-n,d=l>=2**32;if(d)for(const h of i)h.currentChunk.offset+=ei-Ir;this.format._options.onMoof&&this.writer.startTrackingWrites();const u=So(t,i);if(this.boxWriter.writeBox(u),this.format._options.onMoof){const{data:h,start:g}=this.writer.stopTrackingWrites();this.format._options.onMoof(h,g,c)}I(this.writer.getPos()===n),this.format._options.onMdat&&this.writer.startTrackingWrites();const f=xa(d);f.size=l,this.boxWriter.writeBox(f),this.writer.seek(n+(d?ei:Ir));for(const h of i)for(const g of h.currentChunk.samples)this.writer.write(g.data),g.data=null;if(this.format._options.onMdat){const{data:h,start:g}=this.writer.stopTrackingWrites();this.format._options.onMdat(h,g)}for(const h of i)h.finalizedChunks.push(h.currentChunk),this.finalizedChunks.push(h.currentChunk),h.currentChunk=null;e&&await this.writer.flush()}async registerSampleFastStartReserve(e,t){if(this.allTracksAreKnown()){if(!this.mdat){const i=Gi(this),s=this.boxWriter.measureBox(i)+this.computeSampleTableSizeUpperBound()+4096;I(this.ftypSize!==null),this.writer.seek(this.ftypSize+s),this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat=xa(!0),this.boxWriter.writeBox(this.mdat);for(const n of this.trackDatas){for(const o of n.sampleQueue)await this.addSampleToTrack(n,o);n.sampleQueue.length=0}}await this.addSampleToTrack(e,t)}else e.sampleQueue.push(t)}computeSampleTableSizeUpperBound(){I(this.fastStart==="reserve");let e=0;for(const t of this.trackDatas){const i=t.track.metadata.maximumPacketCount;I(i!==void 0),e+=8*Math.ceil(2/3*i),e+=4*i,e+=8*Math.ceil(2/3*i),e+=12*Math.ceil(2/3*i),e+=4*i,e+=8*i}return e}async onTrackClose(e){const t=await this.mutex.acquire();if(e.type==="subtitle"&&e.source._codec==="webvtt"){const i=this.trackDatas.find(a=>a.track===e);i&&await this.processWebVTTCues(i,1/0)}this.allTracksAreKnown()&&this.allTracksKnown.resolve(),this.isFragmented&&await this.interleaveSamples(),t()}async finalize(){const e=await this.mutex.acquire();this.allTracksKnown.resolve();for(const t of this.trackDatas)t.type==="subtitle"&&t.track.source._codec==="webvtt"&&await this.processWebVTTCues(t,1/0);if(this.isFragmented){await this.interleaveSamples(!0);for(const t of this.trackDatas)this.processTimestamps(t);await this.finalizeFragment(!1)}else for(const t of this.trackDatas)this.processTimestamps(t),await this.finalizeCurrentChunk(t);if(this.fastStart==="in-memory"){this.mdat=xa(!1);let t;for(let a=0;a<2;a++){const s=Gi(this),n=this.boxWriter.measureBox(s);t=this.boxWriter.measureBox(this.mdat);let o=this.writer.getPos()+n+t;for(const c of this.finalizedChunks){c.offset=o;for(const{data:l}of c.samples)I(l),o+=l.byteLength,t+=l.byteLength}if(o<2**32)break;t>=2**32&&(this.mdat.largeSize=!0)}this.format._options.onMoov&&this.writer.startTrackingWrites();const i=Gi(this);if(this.boxWriter.writeBox(i),this.format._options.onMoov){const{data:a,start:s}=this.writer.stopTrackingWrites();this.format._options.onMoov(a,s)}this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat.size=t,this.boxWriter.writeBox(this.mdat);for(const a of this.finalizedChunks)for(const s of a.samples)I(s.data),this.writer.write(s.data),s.data=null;if(this.format._options.onMdat){const{data:a,start:s}=this.writer.stopTrackingWrites();this.format._options.onMdat(a,s)}}else if(this.isFragmented){const t=this.writer.getPos(),i=Um(this.trackDatas);this.boxWriter.writeBox(i);const a=this.writer.getPos()-t;this.writer.seek(this.writer.getPos()-4),this.boxWriter.writeU32(a)}else{I(this.mdat);const t=this.boxWriter.offsets.get(this.mdat);I(t!==void 0);const i=this.writer.getPos()-t;if(this.mdat.size=i,this.mdat.largeSize=i>=2**32,this.boxWriter.patchBox(this.mdat),this.format._options.onMdat){const{data:s,start:n}=this.writer.stopTrackingWrites();this.format._options.onMdat(s,n)}const a=Gi(this);if(this.fastStart==="reserve"){I(this.ftypSize!==null),this.writer.seek(this.ftypSize),this.format._options.onMoov&&this.writer.startTrackingWrites(),this.boxWriter.writeBox(a);const s=this.boxWriter.offsets.get(this.mdat)-this.writer.getPos();this.boxWriter.writeBox(Qh(s))}else this.format._options.onMoov&&this.writer.startTrackingWrites(),this.boxWriter.writeBox(a);if(this.format._options.onMoov){const{data:s,start:n}=this.writer.stopTrackingWrites();this.format._options.onMoov(s,n)}}e()}}const np=-32768,sp=2**15-1,Po="Mediabunny",Eo=6,Io=5,op={video:1,audio:2,subtitle:17};class cp extends _c{constructor(e,t){super(e),this.trackDatas=[],this.allTracksKnown=Mt(),this.segment=null,this.segmentInfo=null,this.seekHead=null,this.tracksElement=null,this.tagsElement=null,this.attachmentsElement=null,this.segmentDuration=null,this.cues=null,this.currentCluster=null,this.currentClusterStartMsTimestamp=null,this.currentClusterMaxMsTimestamp=null,this.trackDatasInCurrentCluster=new Map,this.duration=0,this.writer=e._writer,this.format=t,this.ebmlWriter=new Of(this.writer),this.format._options.appendOnly&&(this.writer.ensureMonotonicity=!0)}async start(){const e=await this.mutex.acquire();this.writeEBMLHeader(),this.createSegmentInfo(),this.createCues(),await this.writer.flush(),e()}writeEBMLHeader(){this.format._options.onEbmlHeader&&this.writer.startTrackingWrites();const e={id:N.EBML,data:[{id:N.EBMLVersion,data:1},{id:N.EBMLReadVersion,data:1},{id:N.EBMLMaxIDLength,data:4},{id:N.EBMLMaxSizeLength,data:8},{id:N.DocType,data:this.format instanceof Jn?"webm":"matroska"},{id:N.DocTypeVersion,data:2},{id:N.DocTypeReadVersion,data:2}]};if(this.ebmlWriter.writeEBML(e),this.format._options.onEbmlHeader){const{data:t,start:i}=this.writer.stopTrackingWrites();this.format._options.onEbmlHeader(t,i)}}maybeCreateSeekHead(e){if(this.format._options.appendOnly)return;const t=new Uint8Array([28,83,187,107]),i=new Uint8Array([21,73,169,102]),a=new Uint8Array([22,84,174,107]),s=new Uint8Array([25,65,164,105]),n=new Uint8Array([18,84,195,103]),o={id:N.SeekHead,data:[{id:N.Seek,data:[{id:N.SeekID,data:t},{id:N.SeekPosition,size:5,data:e?this.ebmlWriter.offsets.get(this.cues)-this.segmentDataOffset:0}]},{id:N.Seek,data:[{id:N.SeekID,data:i},{id:N.SeekPosition,size:5,data:e?this.ebmlWriter.offsets.get(this.segmentInfo)-this.segmentDataOffset:0}]},{id:N.Seek,data:[{id:N.SeekID,data:a},{id:N.SeekPosition,size:5,data:e?this.ebmlWriter.offsets.get(this.tracksElement)-this.segmentDataOffset:0}]},this.attachmentsElement?{id:N.Seek,data:[{id:N.SeekID,data:s},{id:N.SeekPosition,size:5,data:e?this.ebmlWriter.offsets.get(this.attachmentsElement)-this.segmentDataOffset:0}]}:null,this.tagsElement?{id:N.Seek,data:[{id:N.SeekID,data:n},{id:N.SeekPosition,size:5,data:e?this.ebmlWriter.offsets.get(this.tagsElement)-this.segmentDataOffset:0}]}:null]};this.seekHead=o}createSegmentInfo(){const e={id:N.Duration,data:new Hn(0)};this.segmentDuration=e;const t={id:N.Info,data:[{id:N.TimestampScale,data:1e6},{id:N.MuxingApp,data:Po},{id:N.WritingApp,data:Po},this.format._options.appendOnly?null:e]};this.segmentInfo=t}createTracks(){const e={id:N.Tracks,data:[]};this.tracksElement=e;for(const t of this.trackDatas){const i=fr[t.track.source._codec];I(i);let a=0;if(t.type==="audio"&&t.track.source._codec==="opus"){a=1e6*80;const s=t.info.decoderConfig.description;if(s){const n=Vt(s),o=gs(n);a=Math.round(1e9*(o.preSkip/fa))}}e.data.push({id:N.TrackEntry,data:[{id:N.TrackNumber,data:t.track.id},{id:N.TrackUID,data:t.track.id},{id:N.TrackType,data:op[t.type]},t.track.metadata.disposition?.default===!1?{id:N.FlagDefault,data:0}:null,t.track.metadata.disposition?.forced?{id:N.FlagForced,data:1}:null,t.track.metadata.disposition?.hearingImpaired?{id:N.FlagHearingImpaired,data:1}:null,t.track.metadata.disposition?.visuallyImpaired?{id:N.FlagVisualImpaired,data:1}:null,t.track.metadata.disposition?.original?{id:N.FlagOriginal,data:1}:null,t.track.metadata.disposition?.commentary?{id:N.FlagCommentary,data:1}:null,{id:N.FlagLacing,data:0},{id:N.Language,data:t.track.metadata.languageCode??er},{id:N.CodecID,data:i},{id:N.CodecDelay,data:0},{id:N.SeekPreRoll,data:a},t.track.metadata.name!==void 0?{id:N.Name,data:new Nr(t.track.metadata.name)}:null,t.type==="video"?this.videoSpecificTrackInfo(t):null,t.type==="audio"?this.audioSpecificTrackInfo(t):null,t.type==="subtitle"?this.subtitleSpecificTrackInfo(t):null]})}}videoSpecificTrackInfo(e){const{frameRate:t,rotation:i}=e.track.metadata,a=[e.info.decoderConfig.description?{id:N.CodecPrivate,data:Vt(e.info.decoderConfig.description)}:null,t?{id:N.DefaultDuration,data:1e9/t}:null],s=i?Ha(-i):0,n=e.info.decoderConfig.colorSpace,o={id:N.Video,data:[{id:N.PixelWidth,data:e.info.width},{id:N.PixelHeight,data:e.info.height},e.info.alphaMode?{id:N.AlphaMode,data:1}:null,dc(n)?{id:N.Colour,data:[{id:N.MatrixCoefficients,data:Li[n.matrix]},{id:N.TransferCharacteristics,data:Vi[n.transfer]},{id:N.Primaries,data:Ui[n.primaries]},{id:N.Range,data:n.fullRange?2:1}]}:null,s?{id:N.Projection,data:[{id:N.ProjectionType,data:0},{id:N.ProjectionPoseRoll,data:new Wn((s+180)%360-180)}]}:null]};return a.push(o),a}audioSpecificTrackInfo(e){const t=Dt.includes(e.track.source._codec)?Br(e.track.source._codec):null;return[e.info.decoderConfig.description?{id:N.CodecPrivate,data:Vt(e.info.decoderConfig.description)}:null,{id:N.Audio,data:[{id:N.SamplingFrequency,data:new Wn(e.info.sampleRate)},{id:N.Channels,data:e.info.numberOfChannels},t?{id:N.BitDepth,data:8*t.sampleSize}:null]}]}subtitleSpecificTrackInfo(e){return[{id:N.CodecPrivate,data:Kt.encode(e.info.config.description)}]}maybeCreateTags(){const e=[],t=(s,n)=>{e.push({id:N.SimpleTag,data:[{id:N.TagName,data:new Nr(s)},typeof n=="string"?{id:N.TagString,data:new Nr(n)}:{id:N.TagBinary,data:n}]})},i=this.output._metadataTags,a=new Set;for(const{key:s,value:n}of fs(i))switch(s){case"title":t("TITLE",n),a.add("TITLE");break;case"description":t("DESCRIPTION",n),a.add("DESCRIPTION");break;case"artist":t("ARTIST",n),a.add("ARTIST");break;case"album":t("ALBUM",n),a.add("ALBUM");break;case"albumArtist":t("ALBUM_ARTIST",n),a.add("ALBUM_ARTIST");break;case"genre":t("GENRE",n),a.add("GENRE");break;case"comment":t("COMMENT",n),a.add("COMMENT");break;case"lyrics":t("LYRICS",n),a.add("LYRICS");break;case"date":t("DATE",n.toISOString().slice(0,10)),a.add("DATE");break;case"trackNumber":{const o=i.tracksTotal!==void 0?`${n}/${i.tracksTotal}`:n.toString();t("PART_NUMBER",o),a.add("PART_NUMBER")}break;case"discNumber":{const o=i.discsTotal!==void 0?`${n}/${i.discsTotal}`:n.toString();t("DISC",o),a.add("DISC")}break;case"tracksTotal":case"discsTotal":break;case"images":case"raw":break;default:pr(s)}if(i.raw)for(const s in i.raw){const n=i.raw[s];n==null||a.has(s)||(typeof n=="string"||n instanceof Uint8Array)&&t(s,n)}e.length!==0&&(this.tagsElement={id:N.Tags,data:[{id:N.Tag,data:[{id:N.Targets,data:[{id:N.TargetTypeValue,data:50},{id:N.TargetType,data:"MOVIE"}]},...e]}]})}maybeCreateAttachments(){const e=this.output._metadataTags,t=[],i=new Set,a=e.images??[];for(const s of a){let n=s.name;n===void 0&&(n=(s.kind==="coverFront"?"cover":s.kind==="coverBack"?"back":"image")+(Ou(s.mimeType)??""));let o;for(;;){o=0n;for(let c=0;c<8;c++)o<<=8n,o|=BigInt(Math.floor(Math.random()*256));if(o!==0n&&!i.has(o))break}i.add(o),t.push({id:N.AttachedFile,data:[s.description!==void 0?{id:N.FileDescription,data:new Nr(s.description)}:null,{id:N.FileName,data:new Nr(n)},{id:N.FileMediaType,data:s.mimeType},{id:N.FileData,data:s.data},{id:N.FileUID,data:o}]})}for(const[s,n]of Object.entries(e.raw??{}))!(n instanceof hs)||!/^\d+$/.test(s)||a.find(c=>c.mimeType===n.mimeType&&Vu(c.data,n.data))||t.push({id:N.AttachedFile,data:[n.description!==void 0?{id:N.FileDescription,data:new Nr(n.description)}:null,{id:N.FileName,data:new Nr(n.name??"")},{id:N.FileMediaType,data:n.mimeType??""},{id:N.FileData,data:n.data},{id:N.FileUID,data:BigInt(s)}]});t.length!==0&&(this.attachmentsElement={id:N.Attachments,data:t})}createSegment(){this.createTracks(),this.maybeCreateTags(),this.maybeCreateAttachments(),this.maybeCreateSeekHead(!1);const e={id:N.Segment,size:this.format._options.appendOnly?-1:Eo,data:[this.seekHead,this.segmentInfo,this.tracksElement,this.attachmentsElement,this.tagsElement]};if(this.segment=e,this.format._options.onSegmentHeader&&this.writer.startTrackingWrites(),this.ebmlWriter.writeEBML(e),this.format._options.onSegmentHeader){const{data:t,start:i}=this.writer.stopTrackingWrites();this.format._options.onSegmentHeader(t,i)}}createCues(){this.cues={id:N.Cues,data:[]}}get segmentDataOffset(){return I(this.segment),this.ebmlWriter.dataOffsets.get(this.segment)}allTracksAreKnown(){for(const e of this.output._tracks)if(!e.source._closed&&!this.trackDatas.some(t=>t.track===e))return!1;return!0}async getMimeType(){await this.allTracksKnown.promise;const e=this.trackDatas.map(t=>t.type==="video"||t.type==="audio"?t.info.decoderConfig.codec:{webvtt:"wvtt"}[t.track.source._codec]);return Kc({isWebM:this.format instanceof Jn,hasVideo:this.trackDatas.some(t=>t.type==="video"),hasAudio:this.trackDatas.some(t=>t.type==="audio"),codecStrings:e})}getVideoTrackData(e,t,i){const a=this.trackDatas.find(n=>n.track===e);if(a)return a;yc(i),I(i),I(i.decoderConfig),I(i.decoderConfig.codedWidth!==void 0),I(i.decoderConfig.codedHeight!==void 0);const s={track:e,type:"video",info:{width:i.decoderConfig.codedWidth,height:i.decoderConfig.codedHeight,decoderConfig:i.decoderConfig,alphaMode:!!t.sideData.alpha},chunkQueue:[],lastWrittenMsTimestamp:null};return e.source._codec==="vp9"?s.info.decoderConfig={...s.info.decoderConfig,description:new Uint8Array(Wu(s.info.decoderConfig.codec))}:e.source._codec==="av1"&&(s.info.decoderConfig={...s.info.decoderConfig,description:new Uint8Array(pc(s.info.decoderConfig.codec))}),this.trackDatas.push(s),this.trackDatas.sort((n,o)=>n.track.id-o.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),s}getAudioTrackData(e,t){const i=this.trackDatas.find(s=>s.track===e);if(i)return i;kc(t),I(t),I(t.decoderConfig);const a={track:e,type:"audio",info:{numberOfChannels:t.decoderConfig.numberOfChannels,sampleRate:t.decoderConfig.sampleRate,decoderConfig:t.decoderConfig},chunkQueue:[],lastWrittenMsTimestamp:null};return this.trackDatas.push(a),this.trackDatas.sort((s,n)=>s.track.id-n.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),a}getSubtitleTrackData(e,t){const i=this.trackDatas.find(s=>s.track===e);if(i)return i;xc(t),I(t),I(t.config);const a={track:e,type:"subtitle",info:{config:t.config},chunkQueue:[],lastWrittenMsTimestamp:null};return this.trackDatas.push(a),this.trackDatas.sort((s,n)=>s.track.id-n.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),a}async addEncodedVideoPacket(e,t,i){const a=await this.mutex.acquire();try{const s=this.getVideoTrackData(e,t,i),n=t.type==="key";let o=this.validateAndNormalizeTimestamp(s.track,t.timestamp,n),c=t.duration;e.metadata.frameRate!==void 0&&(o=Rn(o,1/e.metadata.frameRate),c=Rn(c,1/e.metadata.frameRate));const l=s.info.alphaMode?t.sideData.alpha??null:null,d=this.createInternalChunk(t.data,o,c,t.type,l);e.source._codec==="vp9"&&this.fixVP9ColorSpace(s,d),s.chunkQueue.push(d),await this.interleaveChunks()}finally{a()}}async addEncodedAudioPacket(e,t,i){const a=await this.mutex.acquire();try{const s=this.getAudioTrackData(e,i),n=t.type==="key",o=this.validateAndNormalizeTimestamp(s.track,t.timestamp,n),c=this.createInternalChunk(t.data,o,t.duration,t.type);s.chunkQueue.push(c),await this.interleaveChunks()}finally{a()}}async addSubtitleCue(e,t,i){const a=await this.mutex.acquire();try{const s=this.getSubtitleTrackData(e,i),n=this.validateAndNormalizeTimestamp(s.track,t.timestamp,!0);let o=t.text;const c=Math.round(n*1e3);La.lastIndex=0,o=o.replace(La,f=>{const g=Kh(f.slice(1,-1))-c;return`<${nl(g)}>`});const l=Kt.encode(o),d=`${t.settings??""}
${t.identifier??""}
${t.notes??""}`,u=this.createInternalChunk(l,n,t.duration,"key",d.trim()?Kt.encode(d):null);s.chunkQueue.push(u),await this.interleaveChunks()}finally{a()}}async interleaveChunks(e=!1){if(!(!e&&!this.allTracksAreKnown())){e:for(;;){let t=null,i=1/0;for(const s of this.trackDatas){if(!e&&s.chunkQueue.length===0&&!s.track.source._closed)break e;s.chunkQueue.length>0&&s.chunkQueue[0].timestamp<i&&(t=s,i=s.chunkQueue[0].timestamp)}if(!t)break;const a=t.chunkQueue.shift();this.writeBlock(t,a)}e||await this.writer.flush()}}fixVP9ColorSpace(e,t){if(t.type!=="key"||!e.info.decoderConfig.colorSpace||!e.info.decoderConfig.colorSpace.matrix)return;const i=new bt(t.data);i.skipBits(2);const a=i.readBits(1),n=(i.readBits(1)<<1)+a;if(n===3&&i.skipBits(1),i.readBits(1)||i.readBits(1)!==0||(i.skipBits(2),i.readBits(24)!==4817730))return;n>=2&&i.skipBits(1);const d={rgb:7,bt709:2,bt470bg:1,smpte170m:3}[e.info.decoderConfig.colorSpace.matrix];Iu(t.data,i.pos,i.pos+3,d)}createInternalChunk(e,t,i,a,s=null){return{data:e,type:a,timestamp:t,duration:i,additions:s}}writeBlock(e,t){this.segment||this.createSegment();const i=Math.round(1e3*t.timestamp),a=this.trackDatas.every(d=>{if(e===d)return t.type==="key";const u=d.chunkQueue[0];return u?u.type==="key":d.track.source._closed});let s=!1;if(!this.currentCluster)s=!0;else{I(this.currentClusterStartMsTimestamp!==null),I(this.currentClusterMaxMsTimestamp!==null);const d=i-this.currentClusterStartMsTimestamp;s=a&&i>this.currentClusterMaxMsTimestamp&&d>=1e3*(this.format._options.minimumClusterDuration??1)||d>sp}s&&this.createNewCluster(i);const n=i-this.currentClusterStartMsTimestamp;if(n<np)return;const o=new Uint8Array(4),c=new DataView(o.buffer);c.setUint8(0,128|e.track.id),c.setInt16(1,n,!1);const l=Math.round(1e3*t.duration);if(t.additions){const d={id:N.BlockGroup,data:[{id:N.Block,data:[o,t.data]},t.type==="delta"?{id:N.ReferenceBlock,data:new Wc(e.lastWrittenMsTimestamp-i)}:null,t.additions?{id:N.BlockAdditions,data:[{id:N.BlockMore,data:[{id:N.BlockAddID,data:1},{id:N.BlockAdditional,data:t.additions}]}]}:null,l>0?{id:N.BlockDuration,data:l}:null]};this.ebmlWriter.writeEBML(d)}else{c.setUint8(3,+(t.type==="key")<<7);const d={id:N.SimpleBlock,data:[o,t.data]};this.ebmlWriter.writeEBML(d)}this.duration=Math.max(this.duration,i+l),e.lastWrittenMsTimestamp=i,this.trackDatasInCurrentCluster.has(e)||this.trackDatasInCurrentCluster.set(e,{firstMsTimestamp:i}),this.currentClusterMaxMsTimestamp=Math.max(this.currentClusterMaxMsTimestamp,i)}createNewCluster(e){this.currentCluster&&this.finalizeCurrentCluster(),this.format._options.onCluster&&this.writer.startTrackingWrites(),this.currentCluster={id:N.Cluster,size:this.format._options.appendOnly?-1:Io,data:[{id:N.Timestamp,data:e}]},this.ebmlWriter.writeEBML(this.currentCluster),this.currentClusterStartMsTimestamp=e,this.currentClusterMaxMsTimestamp=e,this.trackDatasInCurrentCluster.clear()}finalizeCurrentCluster(){if(I(this.currentCluster),!this.format._options.appendOnly){const a=this.writer.getPos()-this.ebmlWriter.dataOffsets.get(this.currentCluster),s=this.writer.getPos();this.writer.seek(this.ebmlWriter.offsets.get(this.currentCluster)+4),this.ebmlWriter.writeVarInt(a,Io),this.writer.seek(s)}if(this.format._options.onCluster){I(this.currentClusterStartMsTimestamp!==null);const{data:a,start:s}=this.writer.stopTrackingWrites();this.format._options.onCluster(a,s,this.currentClusterStartMsTimestamp/1e3)}const e=this.ebmlWriter.offsets.get(this.currentCluster)-this.segmentDataOffset,t=new Map;for(const[a,{firstMsTimestamp:s}]of this.trackDatasInCurrentCluster)t.has(s)||t.set(s,[]),t.get(s).push(a);const i=[...t.entries()].sort((a,s)=>a[0]-s[0]);for(const[a,s]of i)I(this.cues),this.cues.data.push({id:N.CuePoint,data:[{id:N.CueTime,data:a},...s.map(n=>({id:N.CueTrackPositions,data:[{id:N.CueTrack,data:n.track.id},{id:N.CueClusterPosition,data:e}]}))]})}async onTrackClose(){const e=await this.mutex.acquire();this.allTracksAreKnown()&&this.allTracksKnown.resolve(),await this.interleaveChunks(),e()}async finalize(){const e=await this.mutex.acquire();if(this.allTracksKnown.resolve(),this.segment||this.createSegment(),await this.interleaveChunks(!0),this.currentCluster&&this.finalizeCurrentCluster(),I(this.cues),this.ebmlWriter.writeEBML(this.cues),!this.format._options.appendOnly){const t=this.writer.getPos(),i=this.writer.getPos()-this.segmentDataOffset;this.writer.seek(this.ebmlWriter.offsets.get(this.segment)+4),this.ebmlWriter.writeVarInt(i,Eo),this.segmentDuration.data=new Hn(this.duration),this.writer.seek(this.ebmlWriter.offsets.get(this.segmentDuration)),this.ebmlWriter.writeEBML(this.segmentDuration),I(this.seekHead),this.writer.seek(this.ebmlWriter.offsets.get(this.seekHead)),this.maybeCreateSeekHead(!0),this.ebmlWriter.writeEBML(this.seekHead),this.writer.seek(t)}e()}}class Ss{getSupportedVideoCodecs(){return this.getSupportedCodecs().filter(e=>cr.includes(e))}getSupportedAudioCodecs(){return this.getSupportedCodecs().filter(e=>gr.includes(e))}getSupportedSubtitleCodecs(){return this.getSupportedCodecs().filter(e=>Di.includes(e))}_codecUnsupportedHint(e){return""}}class wl extends Ss{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.fastStart!==void 0&&![!1,"in-memory","reserve","fragmented"].includes(e.fastStart))throw new TypeError("options.fastStart, when provided, must be false, 'in-memory', 'reserve', or 'fragmented'.");if(e.minimumFragmentDuration!==void 0&&(!Number.isFinite(e.minimumFragmentDuration)||e.minimumFragmentDuration<0))throw new TypeError("options.minimumFragmentDuration, when provided, must be a non-negative number.");if(e.onFtyp!==void 0&&typeof e.onFtyp!="function")throw new TypeError("options.onFtyp, when provided, must be a function.");if(e.onMoov!==void 0&&typeof e.onMoov!="function")throw new TypeError("options.onMoov, when provided, must be a function.");if(e.onMdat!==void 0&&typeof e.onMdat!="function")throw new TypeError("options.onMdat, when provided, must be a function.");if(e.onMoof!==void 0&&typeof e.onMoof!="function")throw new TypeError("options.onMoof, when provided, must be a function.");if(e.metadataFormat!==void 0&&!["mdir","mdta","udta","auto"].includes(e.metadataFormat))throw new TypeError("options.metadataFormat, when provided, must be either 'auto', 'mdir', 'mdta', or 'udta'.");super(),this._options=e}getSupportedTrackCounts(){return{video:{min:0,max:1/0},audio:{min:0,max:1/0},subtitle:{min:0,max:1/0},total:{min:1,max:2**32-1}}}get supportsVideoRotationMetadata(){return!0}_createMuxer(e){return new ap(e,this)}}class Cs extends wl{constructor(e){super(e)}get _name(){return"MP4"}get fileExtension(){return".mp4"}get mimeType(){return"video/mp4"}getSupportedCodecs(){return[...cr,...Pi,"pcm-s16","pcm-s16be","pcm-s24","pcm-s24be","pcm-s32","pcm-s32be","pcm-f32","pcm-f32be","pcm-f64","pcm-f64be",...Di]}_codecUnsupportedHint(e){return new yl().getSupportedCodecs().includes(e)?" Switching to MOV will grant support for this codec.":""}}class yl extends wl{constructor(e){super(e)}get _name(){return"MOV"}get fileExtension(){return".mov"}get mimeType(){return"video/quicktime"}getSupportedCodecs(){return[...cr,...gr]}_codecUnsupportedHint(e){return new Cs().getSupportedCodecs().includes(e)?" Switching to MP4 will grant support for this codec.":""}}class Ao extends Ss{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.appendOnly!==void 0&&typeof e.appendOnly!="boolean")throw new TypeError("options.appendOnly, when provided, must be a boolean.");if(e.minimumClusterDuration!==void 0&&(!Number.isFinite(e.minimumClusterDuration)||e.minimumClusterDuration<0))throw new TypeError("options.minimumClusterDuration, when provided, must be a non-negative number.");if(e.onEbmlHeader!==void 0&&typeof e.onEbmlHeader!="function")throw new TypeError("options.onEbmlHeader, when provided, must be a function.");if(e.onSegmentHeader!==void 0&&typeof e.onSegmentHeader!="function")throw new TypeError("options.onHeader, when provided, must be a function.");if(e.onCluster!==void 0&&typeof e.onCluster!="function")throw new TypeError("options.onCluster, when provided, must be a function.");super(),this._options=e}_createMuxer(e){return new cp(e,this)}get _name(){return"Matroska"}getSupportedTrackCounts(){return{video:{min:0,max:1/0},audio:{min:0,max:1/0},subtitle:{min:0,max:1/0},total:{min:1,max:127}}}get fileExtension(){return".mkv"}get mimeType(){return"video/x-matroska"}getSupportedCodecs(){return[...cr,...Pi,...Dt.filter(e=>!["pcm-s8","pcm-f32be","pcm-f64be","ulaw","alaw"].includes(e)),...Di]}get supportsVideoRotationMetadata(){return!1}}class Jn extends Ao{constructor(e){super(e)}getSupportedCodecs(){return[...cr.filter(e=>["vp8","vp9","av1"].includes(e)),...gr.filter(e=>["opus","vorbis"].includes(e)),...Di]}get _name(){return"WebM"}get fileExtension(){return".webm"}get mimeType(){return"video/webm"}_codecUnsupportedHint(e){return new Ao().getSupportedCodecs().includes(e)?" Switching to MKV will grant support for this codec.":""}}const lp=r=>{if(!r||typeof r!="object")throw new TypeError("Encoding config must be an object.");if(!cr.includes(r.codec))throw new TypeError(`Invalid video codec '${r.codec}'. Must be one of: ${cr.join(", ")}.`);if(!(r.bitrate instanceof tr)&&(!Number.isInteger(r.bitrate)||r.bitrate<=0))throw new TypeError("config.bitrate must be a positive integer or a quality.");if(r.keyFrameInterval!==void 0&&(!Number.isFinite(r.keyFrameInterval)||r.keyFrameInterval<0))throw new TypeError("config.keyFrameInterval, when provided, must be a non-negative number.");if(r.sizeChangeBehavior!==void 0&&!["deny","passThrough","fill","contain","cover"].includes(r.sizeChangeBehavior))throw new TypeError("config.sizeChangeBehavior, when provided, must be 'deny', 'passThrough', 'fill', 'contain' or 'cover'.");if(r.onEncodedPacket!==void 0&&typeof r.onEncodedPacket!="function")throw new TypeError("config.onEncodedChunk, when provided, must be a function.");if(r.onEncoderConfig!==void 0&&typeof r.onEncoderConfig!="function")throw new TypeError("config.onEncoderConfig, when provided, must be a function.");kl(r.codec,r)},kl=(r,e)=>{if(!e||typeof e!="object")throw new TypeError("Encoding options must be an object.");if(e.alpha!==void 0&&!["discard","keep"].includes(e.alpha))throw new TypeError("options.alpha, when provided, must be 'discard' or 'keep'.");if(e.bitrateMode!==void 0&&!["constant","variable"].includes(e.bitrateMode))throw new TypeError("bitrateMode, when provided, must be 'constant' or 'variable'.");if(e.latencyMode!==void 0&&!["quality","realtime"].includes(e.latencyMode))throw new TypeError("latencyMode, when provided, must be 'quality' or 'realtime'.");if(e.fullCodecString!==void 0&&typeof e.fullCodecString!="string")throw new TypeError("fullCodecString, when provided, must be a string.");if(e.fullCodecString!==void 0&&wc(e.fullCodecString)!==r)throw new TypeError(`fullCodecString, when provided, must be a string that matches the specified codec (${r}).`);if(e.hardwareAcceleration!==void 0&&!["no-preference","prefer-hardware","prefer-software"].includes(e.hardwareAcceleration))throw new TypeError("hardwareAcceleration, when provided, must be 'no-preference', 'prefer-hardware' or 'prefer-software'.");if(e.scalabilityMode!==void 0&&typeof e.scalabilityMode!="string")throw new TypeError("scalabilityMode, when provided, must be a string.");if(e.contentHint!==void 0&&typeof e.contentHint!="string")throw new TypeError("contentHint, when provided, must be a string.")},es=r=>{const e=r.bitrate instanceof tr?r.bitrate._toVideoBitrate(r.codec,r.width,r.height):r.bitrate;return{codec:r.fullCodecString??$u(r.codec,r.width,r.height,e),width:r.width,height:r.height,bitrate:e,bitrateMode:r.bitrateMode,alpha:r.alpha??"discard",framerate:r.framerate,latencyMode:r.latencyMode,hardwareAcceleration:r.hardwareAcceleration,scalabilityMode:r.scalabilityMode,contentHint:r.contentHint,...qu(r.codec)}},dp=r=>{if(!r||typeof r!="object")throw new TypeError("Encoding config must be an object.");if(!gr.includes(r.codec))throw new TypeError(`Invalid audio codec '${r.codec}'. Must be one of: ${gr.join(", ")}.`);if(r.bitrate===void 0&&(!Dt.includes(r.codec)||r.codec==="flac"))throw new TypeError("config.bitrate must be provided for compressed audio codecs.");if(r.bitrate!==void 0&&!(r.bitrate instanceof tr)&&(!Number.isInteger(r.bitrate)||r.bitrate<=0))throw new TypeError("config.bitrate, when provided, must be a positive integer or a quality.");if(r.onEncodedPacket!==void 0&&typeof r.onEncodedPacket!="function")throw new TypeError("config.onEncodedChunk, when provided, must be a function.");if(r.onEncoderConfig!==void 0&&typeof r.onEncoderConfig!="function")throw new TypeError("config.onEncoderConfig, when provided, must be a function.");xl(r.codec,r)},xl=(r,e)=>{if(!e||typeof e!="object")throw new TypeError("Encoding options must be an object.");if(e.bitrateMode!==void 0&&!["constant","variable"].includes(e.bitrateMode))throw new TypeError("bitrateMode, when provided, must be 'constant' or 'variable'.");if(e.fullCodecString!==void 0&&typeof e.fullCodecString!="string")throw new TypeError("fullCodecString, when provided, must be a string.");if(e.fullCodecString!==void 0&&wc(e.fullCodecString)!==r)throw new TypeError(`fullCodecString, when provided, must be a string that matches the specified codec (${r}).`)},ts=r=>{const e=r.bitrate instanceof tr?r.bitrate._toAudioBitrate(r.codec):r.bitrate;return{codec:r.fullCodecString??Hu(r.codec,r.numberOfChannels,r.sampleRate),numberOfChannels:r.numberOfChannels,sampleRate:r.sampleRate,bitrate:e,bitrateMode:r.bitrateMode,...Ku(r.codec)}};class tr{constructor(e){this._factor=e}_toVideoBitrate(e,t,i){const a=t*i,s={avc:1,hevc:.6,vp9:.6,av1:.4,vp8:1.2},n=1920*1080,o=3e6,c=Math.pow(a/n,.95),u=o*c*s[e]*this._factor;return Math.ceil(u/1e3)*1e3}_toAudioBitrate(e){if(Dt.includes(e)||e==="flac")return;const i={aac:128e3,opus:64e3,mp3:16e4,vorbis:64e3}[e];if(!i)throw new Error(`Unhandled codec: ${e}`);let a=i*this._factor;return e==="aac"?a=[96e3,128e3,16e4,192e3].reduce((n,o)=>Math.abs(o-a)<Math.abs(n-a)?o:n):e==="opus"||e==="vorbis"?a=Math.max(6e3,a):e==="mp3"&&(a=[8e3,16e3,24e3,32e3,4e4,48e3,64e3,8e4,96e3,112e3,128e3,16e4,192e3,224e3,256e3,32e4].reduce((n,o)=>Math.abs(o-a)<Math.abs(n-a)?o:n)),Math.round(a/1e3)*1e3}}const up=new tr(.3),fp=new tr(.6),Ps=new tr(1),$a=new tr(2),hp=new tr(4),rs=async(r,e={})=>{const{width:t=1280,height:i=720,bitrate:a=1e6,...s}=e;if(!cr.includes(r))return!1;if(!Number.isInteger(t)||t<=0)throw new TypeError("width must be a positive integer.");if(!Number.isInteger(i)||i<=0)throw new TypeError("height must be a positive integer.");if(!(a instanceof tr)&&(!Number.isInteger(a)||a<=0))throw new TypeError("bitrate must be a positive integer or a quality.");kl(r,s);let n=null;return Un.length>0&&(n??=es({codec:r,width:t,height:i,bitrate:a,framerate:void 0,...s}),Un.some(l=>l.supports(r,n)))?!0:typeof VideoEncoder>"u"||(t%2===1||i%2===1)&&(r==="avc"||r==="hevc")||(n??=es({codec:r,width:t,height:i,bitrate:a,framerate:void 0,...s,alpha:"discard"}),!(await VideoEncoder.isConfigSupported(n)).supported)?!1:Ri()?new Promise(async l=>{try{const d=new VideoEncoder({output:()=>{},error:()=>l(!1)});d.configure(n);const u=new Uint8Array(t*i*4),f=new VideoFrame(u,{format:"RGBA",codedWidth:t,codedHeight:i,timestamp:0});d.encode(f),f.close(),await d.flush(),l(!0)}catch{l(!1)}}):!0},_l=async(r,e={})=>{const{numberOfChannels:t=2,sampleRate:i=48e3,bitrate:a=128e3,...s}=e;if(!gr.includes(r))return!1;if(!Number.isInteger(t)||t<=0)throw new TypeError("numberOfChannels must be a positive integer.");if(!Number.isInteger(i)||i<=0)throw new TypeError("sampleRate must be a positive integer.");if(!(a instanceof tr)&&(!Number.isInteger(a)||a<=0))throw new TypeError("bitrate must be a positive integer.");xl(r,s);let n=null;return Vn.length>0&&(n??=ts({codec:r,numberOfChannels:t,sampleRate:i,bitrate:a,...s}),Vn.some(c=>c.supports(r,n)))||Dt.includes(r)?!0:typeof AudioEncoder>"u"?!1:(n??=ts({codec:r,numberOfChannels:t,sampleRate:i,bitrate:a,...s}),(await AudioEncoder.isConfigSupported(n)).supported===!0)},Fo=async(r=gr,e)=>{const t=await Promise.all(r.map(i=>_l(i,e)));return r.filter((i,a)=>t[a])},mp=async(r,e)=>{for(const t of r)if(await rs(t,e))return t;return null};class Es{constructor(){this._connectedTrack=null,this._closingPromise=null,this._closed=!1,this._timestampOffset=0}_ensureValidAdd(){if(!this._connectedTrack)throw new Error("Source is not connected to an output track.");if(this._connectedTrack.output.state==="canceled")throw new Error("Output has been canceled.");if(this._connectedTrack.output.state==="finalizing"||this._connectedTrack.output.state==="finalized")throw new Error("Output has been finalized.");if(this._connectedTrack.output.state==="pending")throw new Error("Output has not started.");if(this._closed)throw new Error("Source is closed.")}async _start(){}async _flushAndClose(e){}close(){if(this._closingPromise)return;const e=this._connectedTrack;if(!e)throw new Error("Cannot call close without connecting the source to an output track.");if(e.output.state==="pending")throw new Error("Cannot call close before output has been started.");this._closingPromise=(async()=>{await this._flushAndClose(!1),this._closed=!0,!(e.output.state==="finalizing"||e.output.state==="finalized")&&e.output._muxer.onTrackClose(e)})()}async _flushOrWaitForOngoingClose(e){return this._closingPromise??=(async()=>{await this._flushAndClose(e),this._closed=!0})()}}class Is extends Es{constructor(e){if(super(),this._connectedTrack=null,!cr.includes(e))throw new TypeError(`Invalid video codec '${e}'. Must be one of: ${cr.join(", ")}.`);this._codec=e}}class pp extends Is{constructor(e){super(e)}add(e,t){if(!(e instanceof mt))throw new TypeError("packet must be an EncodedPacket.");if(e.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be added.");if(t!==void 0&&(!t||typeof t!="object"))throw new TypeError("meta, when provided, must be an object.");return this._ensureValidAdd(),this._connectedTrack.output._muxer.addEncodedVideoPacket(this._connectedTrack,e,t)}}class gp{constructor(e,t){this.source=e,this.encodingConfig=t,this.ensureEncoderPromise=null,this.encoderInitialized=!1,this.encoder=null,this.muxer=null,this.lastMultipleOfKeyFrameInterval=-1,this.codedWidth=null,this.codedHeight=null,this.resizeCanvas=null,this.customEncoder=null,this.customEncoderCallSerializer=new Ga,this.customEncoderQueueSize=0,this.alphaEncoder=null,this.splitter=null,this.splitterCreationFailed=!1,this.alphaFrameQueue=[],this.error=null,this.errorNeedsNewStack=!0}async add(e,t,i){try{if(this.checkForEncoderError(),this.source._ensureValidAdd(),this.codedWidth!==null&&this.codedHeight!==null){if(e.codedWidth!==this.codedWidth||e.codedHeight!==this.codedHeight){const o=this.encodingConfig.sizeChangeBehavior??"deny";if(o!=="passThrough"){if(o==="deny")throw new Error(`Video sample size must remain constant. Expected ${this.codedWidth}x${this.codedHeight}, got ${e.codedWidth}x${e.codedHeight}. To allow the sample size to change over time, set \`sizeChangeBehavior\` to a value other than 'strict' in the encoding options.`);{let c=!1;this.resizeCanvas||(typeof document<"u"?(this.resizeCanvas=document.createElement("canvas"),this.resizeCanvas.width=this.codedWidth,this.resizeCanvas.height=this.codedHeight):this.resizeCanvas=new OffscreenCanvas(this.codedWidth,this.codedHeight),c=!0);const l=this.resizeCanvas.getContext("2d",{alpha:Ri()});I(l),c||(Ri()?(l.fillStyle="black",l.fillRect(0,0,this.codedWidth,this.codedHeight)):l.clearRect(0,0,this.codedWidth,this.codedHeight)),e.drawWithFit(l,{fit:o}),t&&e.close(),e=new $t(this.resizeCanvas,{timestamp:e.timestamp,duration:e.duration,rotation:e.rotation}),t=!0}}}}else this.codedWidth=e.codedWidth,this.codedHeight=e.codedHeight;this.encoderInitialized||(this.ensureEncoderPromise||this.ensureEncoder(e),this.encoderInitialized||await this.ensureEncoderPromise),I(this.encoderInitialized);const a=this.encodingConfig.keyFrameInterval??5,s=Math.floor(e.timestamp/a),n={...i,keyFrame:i?.keyFrame||a===0||s!==this.lastMultipleOfKeyFrameInterval};if(this.lastMultipleOfKeyFrameInterval=s,this.customEncoder){this.customEncoderQueueSize++;const o=e.clone(),c=this.customEncoderCallSerializer.call(()=>this.customEncoder.encode(o,n)).then(()=>this.customEncoderQueueSize--).catch(l=>this.error??=l).finally(()=>{o.close()});this.customEncoderQueueSize>=4&&await c}else{I(this.encoder);const o=e.toVideoFrame();if(!this.alphaEncoder)this.encoder.encode(o,n),o.close();else if(!!o.format&&!o.format.includes("A")||this.splitterCreationFailed)this.alphaFrameQueue.push(null),this.encoder.encode(o,n),o.close();else{const l=o.displayWidth,d=o.displayHeight;if(!this.splitter)try{this.splitter=new vp(l,d)}catch(u){console.error("Due to an error, only color data will be encoded.",u),this.splitterCreationFailed=!0,this.alphaFrameQueue.push(null),this.encoder.encode(o,n),o.close()}if(this.splitter){const u=this.splitter.extractColor(o),f=this.splitter.extractAlpha(o);this.alphaFrameQueue.push(f),this.encoder.encode(u,n),u.close(),o.close()}}t&&e.close(),this.encoder.encodeQueueSize>=4&&await new Promise(c=>this.encoder.addEventListener("dequeue",c,{once:!0}))}await this.muxer.mutex.currentPromise}finally{t&&e.close()}}ensureEncoder(e){const t=new Error;this.ensureEncoderPromise=(async()=>{const i=es({width:e.codedWidth,height:e.codedHeight,...this.encodingConfig,framerate:this.source._connectedTrack?.metadata.frameRate});this.encodingConfig.onEncoderConfig?.(i);const a=Un.find(s=>s.supports(this.encodingConfig.codec,i));if(a)this.customEncoder=new a,this.customEncoder.codec=this.encodingConfig.codec,this.customEncoder.config=i,this.customEncoder.onPacket=(s,n)=>{if(!(s instanceof mt))throw new TypeError("The first argument passed to onPacket must be an EncodedPacket.");if(n!==void 0&&(!n||typeof n!="object"))throw new TypeError("The second argument passed to onPacket must be an object or undefined.");this.encodingConfig.onEncodedPacket?.(s,n),this.muxer.addEncodedVideoPacket(this.source._connectedTrack,s,n).catch(o=>{this.error??=o,this.errorNeedsNewStack=!1})},await this.customEncoder.init();else{if(typeof VideoEncoder>"u")throw new Error("VideoEncoder is not supported by this browser.");if(i.alpha="discard",this.encodingConfig.alpha==="keep"&&(i.latencyMode="quality"),(i.width%2===1||i.height%2===1)&&(this.encodingConfig.codec==="avc"||this.encodingConfig.codec==="hevc"))throw new Error(`The dimensions ${i.width}x${i.height} are not supported for codec '${this.encodingConfig.codec}'; both width and height must be even numbers. Make sure to round your dimensions to the nearest even number.`);if(!(await VideoEncoder.isConfigSupported(i)).supported)throw new Error(`This specific encoder configuration (${i.codec}, ${i.bitrate} bps, ${i.width}x${i.height}, hardware acceleration: ${i.hardwareAcceleration??"no-preference"}) is not supported by this browser. Consider using another codec or changing your video parameters.`);const o=[],c=[];let l=0,d=0;const u=(f,h,g)=>{const m={};if(h){const p=new Uint8Array(h.byteLength);h.copyTo(p),m.alpha=p}const v=mt.fromEncodedChunk(f,m);this.encodingConfig.onEncodedPacket?.(v,g),this.muxer.addEncodedVideoPacket(this.source._connectedTrack,v,g).catch(p=>{this.error??=p,this.errorNeedsNewStack=!1})};this.encoder=new VideoEncoder({output:(f,h)=>{if(!this.alphaEncoder){u(f,null,h);return}const g=this.alphaFrameQueue.shift();I(g!==void 0),g?(this.alphaEncoder.encode(g,{keyFrame:f.type==="key"}),d++,g.close(),o.push({chunk:f,meta:h})):d===0?u(f,null,h):(c.push(l+d),o.push({chunk:f,meta:h}))},error:f=>{f.stack=t.stack,this.error??=f}}),this.encoder.configure(i),this.encodingConfig.alpha==="keep"&&(this.alphaEncoder=new VideoEncoder({output:(f,h)=>{d--;const g=o.shift();for(I(g!==void 0),u(g.chunk,f,g.meta),l++;c.length>0&&c[0]===l;){c.shift();const m=o.shift();I(m!==void 0),u(m.chunk,null,m.meta)}},error:f=>{f.stack=t.stack,this.error??=f}}),this.alphaEncoder.configure(i))}I(this.source._connectedTrack),this.muxer=this.source._connectedTrack.output._muxer,this.encoderInitialized=!0})()}async flushAndClose(e){e||this.checkForEncoderError(),this.customEncoder?(e||this.customEncoderCallSerializer.call(()=>this.customEncoder.flush()),await this.customEncoderCallSerializer.call(()=>this.customEncoder.close())):this.encoder&&(e||(await this.encoder.flush(),await this.alphaEncoder?.flush()),this.encoder.state!=="closed"&&this.encoder.close(),this.alphaEncoder&&this.alphaEncoder.state!=="closed"&&this.alphaEncoder.close(),this.alphaFrameQueue.forEach(t=>t?.close()),this.splitter?.close()),e||this.checkForEncoderError()}getQueueSize(){return this.customEncoder?this.customEncoderQueueSize:this.encoder?.encodeQueueSize??0}checkForEncoderError(){if(this.error)throw this.errorNeedsNewStack&&(this.error.stack=new Error().stack),this.error}}class vp{constructor(e,t){this.lastFrame=null,typeof OffscreenCanvas<"u"?this.canvas=new OffscreenCanvas(e,t):(this.canvas=document.createElement("canvas"),this.canvas.width=e,this.canvas.height=t);const i=this.canvas.getContext("webgl2",{alpha:!0});if(!i)throw new Error("Couldn't acquire WebGL 2 context.");this.gl=i,this.colorProgram=this.createColorProgram(),this.alphaProgram=this.createAlphaProgram(),this.vao=this.createVAO(),this.sourceTexture=this.createTexture(),this.alphaResolutionLocation=this.gl.getUniformLocation(this.alphaProgram,"u_resolution"),this.gl.useProgram(this.colorProgram),this.gl.uniform1i(this.gl.getUniformLocation(this.colorProgram,"u_sourceTexture"),0),this.gl.useProgram(this.alphaProgram),this.gl.uniform1i(this.gl.getUniformLocation(this.alphaProgram,"u_sourceTexture"),0)}createVertexShader(){return this.createShader(this.gl.VERTEX_SHADER,`#version 300 es
			in vec2 a_position;
			in vec2 a_texCoord;
			out vec2 v_texCoord;
			
			void main() {
				gl_Position = vec4(a_position, 0.0, 1.0);
				v_texCoord = a_texCoord;
			}
		`)}createColorProgram(){const e=this.createVertexShader(),t=this.createShader(this.gl.FRAGMENT_SHADER,`#version 300 es
			precision highp float;
			
			uniform sampler2D u_sourceTexture;
			in vec2 v_texCoord;
			out vec4 fragColor;
			
			void main() {
				vec4 source = texture(u_sourceTexture, v_texCoord);
				fragColor = vec4(source.rgb, 1.0);
			}
		`),i=this.gl.createProgram();return this.gl.attachShader(i,e),this.gl.attachShader(i,t),this.gl.linkProgram(i),i}createAlphaProgram(){const e=this.createVertexShader(),t=this.createShader(this.gl.FRAGMENT_SHADER,`#version 300 es
			precision highp float;
			
			uniform sampler2D u_sourceTexture;
			uniform vec2 u_resolution; // The width and height of the canvas
			in vec2 v_texCoord;
			out vec4 fragColor;

			// This function determines the value for a single byte in the YUV stream
			float getByteValue(float byteOffset) {
				float width = u_resolution.x;
				float height = u_resolution.y;

				float yPlaneSize = width * height;

				if (byteOffset < yPlaneSize) {
					// This byte is in the luma plane. Find the corresponding pixel coordinates to sample from
					float y = floor(byteOffset / width);
					float x = mod(byteOffset, width);
					
					// Add 0.5 to sample the center of the texel
					vec2 sampleCoord = (vec2(x, y) + 0.5) / u_resolution;
					
					// The luma value is the alpha from the source texture
					return texture(u_sourceTexture, sampleCoord).a;
				} else {
					// Write a fixed value for chroma and beyond
					return 128.0 / 255.0;
				}
			}
			
			void main() {
				// Each fragment writes 4 bytes (R, G, B, A)
				float pixelIndex = floor(gl_FragCoord.y) * u_resolution.x + floor(gl_FragCoord.x);
				float baseByteOffset = pixelIndex * 4.0;

				vec4 result;
				for (int i = 0; i < 4; i++) {
					float currentByteOffset = baseByteOffset + float(i);
					result[i] = getByteValue(currentByteOffset);
				}
				
				fragColor = result;
			}
		`),i=this.gl.createProgram();return this.gl.attachShader(i,e),this.gl.attachShader(i,t),this.gl.linkProgram(i),i}createShader(e,t){const i=this.gl.createShader(e);return this.gl.shaderSource(i,t),this.gl.compileShader(i),this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS)||console.error("Shader compile error:",this.gl.getShaderInfoLog(i)),i}createVAO(){const e=this.gl.createVertexArray();this.gl.bindVertexArray(e);const t=new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,1,1,1,0]),i=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,i),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.STATIC_DRAW);const a=this.gl.getAttribLocation(this.colorProgram,"a_position"),s=this.gl.getAttribLocation(this.colorProgram,"a_texCoord");return this.gl.enableVertexAttribArray(a),this.gl.vertexAttribPointer(a,2,this.gl.FLOAT,!1,16,0),this.gl.enableVertexAttribArray(s),this.gl.vertexAttribPointer(s,2,this.gl.FLOAT,!1,16,8),e}createTexture(){const e=this.gl.createTexture();return this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),e}updateTexture(e){this.lastFrame!==e&&((e.displayWidth!==this.canvas.width||e.displayHeight!==this.canvas.height)&&(this.canvas.width=e.displayWidth,this.canvas.height=e.displayHeight),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.sourceTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),this.lastFrame=e)}extractColor(e){return this.updateTexture(e),this.gl.useProgram(this.colorProgram),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.bindVertexArray(this.vao),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4),new VideoFrame(this.canvas,{timestamp:e.timestamp,duration:e.duration??void 0,alpha:"discard"})}extractAlpha(e){this.updateTexture(e),this.gl.useProgram(this.alphaProgram),this.gl.uniform2f(this.alphaResolutionLocation,this.canvas.width,this.canvas.height),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.bindVertexArray(this.vao),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4);const{width:t,height:i}=this.canvas,a=Math.ceil(t/2)*Math.ceil(i/2),s=t*i+a*2,n=Math.ceil(s/(t*4));let o=new Uint8Array(4*t*n);this.gl.readPixels(0,0,t,n,this.gl.RGBA,this.gl.UNSIGNED_BYTE,o),o=o.subarray(0,s),I(o[t*i]===128),I(o[o.length-1]===128);const c={format:"I420",codedWidth:t,codedHeight:i,timestamp:e.timestamp,duration:e.duration??void 0,transfer:[o.buffer]};return new VideoFrame(o,c)}close(){this.gl.getExtension("WEBGL_lose_context")?.loseContext(),this.gl=null}}class zo extends Is{constructor(e){lp(e),super(e.codec),this._encoder=new gp(this,e)}add(e,t){if(!(e instanceof $t))throw new TypeError("videoSample must be a VideoSample.");return this._encoder.add(e,!1,t)}_flushAndClose(e){return this._encoder.flushAndClose(e)}}class As extends Es{constructor(e){if(super(),this._connectedTrack=null,!gr.includes(e))throw new TypeError(`Invalid audio codec '${e}'. Must be one of: ${gr.join(", ")}.`);this._codec=e}}class bp extends As{constructor(e){super(e)}add(e,t){if(!(e instanceof mt))throw new TypeError("packet must be an EncodedPacket.");if(e.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be added.");if(t!==void 0&&(!t||typeof t!="object"))throw new TypeError("meta, when provided, must be an object.");return this._ensureValidAdd(),this._connectedTrack.output._muxer.addEncodedAudioPacket(this._connectedTrack,e,t)}}class wp{constructor(e,t){this.source=e,this.encodingConfig=t,this.ensureEncoderPromise=null,this.encoderInitialized=!1,this.encoder=null,this.muxer=null,this.lastNumberOfChannels=null,this.lastSampleRate=null,this.isPcmEncoder=!1,this.outputSampleSize=null,this.writeOutputValue=null,this.customEncoder=null,this.customEncoderCallSerializer=new Ga,this.customEncoderQueueSize=0,this.lastEndSampleIndex=null,this.error=null,this.errorNeedsNewStack=!0}async add(e,t){try{if(this.checkForEncoderError(),this.source._ensureValidAdd(),this.lastNumberOfChannels!==null&&this.lastSampleRate!==null){if(e.numberOfChannels!==this.lastNumberOfChannels||e.sampleRate!==this.lastSampleRate)throw new Error(`Audio parameters must remain constant. Expected ${this.lastNumberOfChannels} channels at ${this.lastSampleRate} Hz, got ${e.numberOfChannels} channels at ${e.sampleRate} Hz.`)}else this.lastNumberOfChannels=e.numberOfChannels,this.lastSampleRate=e.sampleRate;this.encoderInitialized||(this.ensureEncoderPromise||this.ensureEncoder(e),this.encoderInitialized||await this.ensureEncoderPromise),I(this.encoderInitialized);{const i=Math.round(e.timestamp*e.sampleRate),a=Math.round((e.timestamp+e.duration)*e.sampleRate);if(this.lastEndSampleIndex===null)this.lastEndSampleIndex=a;else{const s=i-this.lastEndSampleIndex;if(s>=64){const n=new sr({data:new Float32Array(s*e.numberOfChannels),format:"f32-planar",sampleRate:e.sampleRate,numberOfChannels:e.numberOfChannels,numberOfFrames:s,timestamp:this.lastEndSampleIndex/e.sampleRate});await this.add(n,!0)}this.lastEndSampleIndex+=e.numberOfFrames}}if(this.customEncoder){this.customEncoderQueueSize++;const i=e.clone(),a=this.customEncoderCallSerializer.call(()=>this.customEncoder.encode(i)).then(()=>this.customEncoderQueueSize--).catch(s=>this.error??=s).finally(()=>{i.close()});this.customEncoderQueueSize>=4&&await a,await this.muxer.mutex.currentPromise}else if(this.isPcmEncoder)await this.doPcmEncoding(e,t);else{I(this.encoder);const i=e.toAudioData();this.encoder.encode(i),i.close(),t&&e.close(),this.encoder.encodeQueueSize>=4&&await new Promise(a=>this.encoder.addEventListener("dequeue",a,{once:!0})),await this.muxer.mutex.currentPromise}}finally{t&&e.close()}}async doPcmEncoding(e,t){I(this.outputSampleSize),I(this.writeOutputValue);const{numberOfChannels:i,numberOfFrames:a,sampleRate:s,timestamp:n}=e,o=2048,c=[];for(let f=0;f<a;f+=o){const h=Math.min(o,e.numberOfFrames-f),g=h*i*this.outputSampleSize,m=new ArrayBuffer(g),v=new DataView(m);c.push({frameCount:h,view:v})}const l=e.allocationSize({planeIndex:0,format:"f32-planar"}),d=new Float32Array(l/Float32Array.BYTES_PER_ELEMENT);for(let f=0;f<i;f++){e.copyTo(d,{planeIndex:f,format:"f32-planar"});for(let h=0;h<c.length;h++){const{frameCount:g,view:m}=c[h];for(let v=0;v<g;v++)this.writeOutputValue(m,(v*i+f)*this.outputSampleSize,d[h*o+v])}}t&&e.close();const u={decoderConfig:{codec:this.encodingConfig.codec,numberOfChannels:i,sampleRate:s}};for(let f=0;f<c.length;f++){const{frameCount:h,view:g}=c[f],m=g.buffer,v=f*o,p=new mt(new Uint8Array(m),"key",n+v/s,h/s);this.encodingConfig.onEncodedPacket?.(p,u),await this.muxer.addEncodedAudioPacket(this.source._connectedTrack,p,u)}}ensureEncoder(e){const t=new Error;this.ensureEncoderPromise=(async()=>{const{numberOfChannels:i,sampleRate:a}=e,s=ts({numberOfChannels:i,sampleRate:a,...this.encodingConfig});this.encodingConfig.onEncoderConfig?.(s);const n=Vn.find(o=>o.supports(this.encodingConfig.codec,s));if(n)this.customEncoder=new n,this.customEncoder.codec=this.encodingConfig.codec,this.customEncoder.config=s,this.customEncoder.onPacket=(o,c)=>{if(!(o instanceof mt))throw new TypeError("The first argument passed to onPacket must be an EncodedPacket.");if(c!==void 0&&(!c||typeof c!="object"))throw new TypeError("The second argument passed to onPacket must be an object or undefined.");this.encodingConfig.onEncodedPacket?.(o,c),this.muxer.addEncodedAudioPacket(this.source._connectedTrack,o,c).catch(l=>{this.error??=l,this.errorNeedsNewStack=!1})},await this.customEncoder.init();else if(Dt.includes(this.encodingConfig.codec))this.initPcmEncoder();else{if(typeof AudioEncoder>"u")throw new Error("AudioEncoder is not supported by this browser.");if(!(await AudioEncoder.isConfigSupported(s)).supported)throw new Error(`This specific encoder configuration (${s.codec}, ${s.bitrate} bps, ${s.numberOfChannels} channels, ${s.sampleRate} Hz) is not supported by this browser. Consider using another codec or changing your audio parameters.`);this.encoder=new AudioEncoder({output:(c,l)=>{if(this.encodingConfig.codec==="aac"&&l?.decoderConfig){let u=!1;if(!l.decoderConfig.description||l.decoderConfig.description.byteLength<2?u=!0:u=ps(Vt(l.decoderConfig.description)).objectType===0,u){const f=Number(Ct(s.codec.split(".")));l.decoderConfig.description=ju({objectType:f,numberOfChannels:l.decoderConfig.numberOfChannels,sampleRate:l.decoderConfig.sampleRate})}}const d=mt.fromEncodedChunk(c);this.encodingConfig.onEncodedPacket?.(d,l),this.muxer.addEncodedAudioPacket(this.source._connectedTrack,d,l).catch(u=>{this.error??=u,this.errorNeedsNewStack=!1})},error:c=>{c.stack=t.stack,this.error??=c}}),this.encoder.configure(s)}I(this.source._connectedTrack),this.muxer=this.source._connectedTrack.output._muxer,this.encoderInitialized=!0})()}initPcmEncoder(){this.isPcmEncoder=!0;const e=this.encodingConfig.codec,{dataType:t,sampleSize:i,littleEndian:a}=Br(e);switch(this.outputSampleSize=i,i){case 1:t==="unsigned"?this.writeOutputValue=(s,n,o)=>s.setUint8(n,Bt((o+1)*127.5,0,255)):t==="signed"?this.writeOutputValue=(s,n,o)=>{s.setInt8(n,Bt(Math.round(o*128),-128,127))}:t==="ulaw"?this.writeOutputValue=(s,n,o)=>{const c=Bt(Math.floor(o*32767),-32768,32767);s.setUint8(n,pf(c))}:t==="alaw"?this.writeOutputValue=(s,n,o)=>{const c=Bt(Math.floor(o*32767),-32768,32767);s.setUint8(n,vf(c))}:I(!1);break;case 2:t==="unsigned"?this.writeOutputValue=(s,n,o)=>s.setUint16(n,Bt((o+1)*32767.5,0,65535),a):t==="signed"?this.writeOutputValue=(s,n,o)=>s.setInt16(n,Bt(Math.round(o*32767),-32768,32767),a):I(!1);break;case 3:t==="unsigned"?this.writeOutputValue=(s,n,o)=>us(s,n,Bt((o+1)*83886075e-1,0,16777215),a):t==="signed"?this.writeOutputValue=(s,n,o)=>Bu(s,n,Bt(Math.round(o*8388607),-8388608,8388607),a):I(!1);break;case 4:t==="unsigned"?this.writeOutputValue=(s,n,o)=>s.setUint32(n,Bt((o+1)*21474836475e-1,0,4294967295),a):t==="signed"?this.writeOutputValue=(s,n,o)=>s.setInt32(n,Bt(Math.round(o*2147483647),-2147483648,2147483647),a):t==="float"?this.writeOutputValue=(s,n,o)=>s.setFloat32(n,o,a):I(!1);break;case 8:t==="float"?this.writeOutputValue=(s,n,o)=>s.setFloat64(n,o,a):I(!1);break;default:pr(i),I(!1)}}async flushAndClose(e){e||this.checkForEncoderError(),this.customEncoder?(e||this.customEncoderCallSerializer.call(()=>this.customEncoder.flush()),await this.customEncoderCallSerializer.call(()=>this.customEncoder.close())):this.encoder&&(e||await this.encoder.flush(),this.encoder.state!=="closed"&&this.encoder.close()),e||this.checkForEncoderError()}getQueueSize(){return this.customEncoder?this.customEncoderQueueSize:this.isPcmEncoder?0:this.encoder?.encodeQueueSize??0}checkForEncoderError(){if(this.error)throw this.errorNeedsNewStack&&(this.error.stack=new Error().stack),this.error}}class Bo extends As{constructor(e){dp(e),super(e.codec),this._encoder=new wp(this,e)}add(e){if(!(e instanceof sr))throw new TypeError("audioSample must be an AudioSample.");return this._encoder.add(e,!1)}_flushAndClose(e){return this._encoder.flushAndClose(e)}}class yp extends Es{constructor(e){if(super(),this._connectedTrack=null,!Di.includes(e))throw new TypeError(`Invalid subtitle codec '${e}'. Must be one of: ${Di.join(", ")}.`);this._codec=e}}const kp=["video","audio","subtitle"],kn=r=>{if(!r||typeof r!="object")throw new TypeError("metadata must be an object.");if(r.languageCode!==void 0&&!sa(r.languageCode))throw new TypeError("metadata.languageCode, when provided, must be a three-letter, ISO 639-2/T language code.");if(r.name!==void 0&&typeof r.name!="string")throw new TypeError("metadata.name, when provided, must be a string.");if(r.disposition!==void 0&&Lu(r.disposition),r.maximumPacketCount!==void 0&&(!Number.isInteger(r.maximumPacketCount)||r.maximumPacketCount<0))throw new TypeError("metadata.maximumPacketCount, when provided, must be a non-negative integer.")};class is{constructor(e){if(this.state="pending",this._tracks=[],this._startPromise=null,this._cancelPromise=null,this._finalizePromise=null,this._mutex=new $i,this._metadataTags={},!e||typeof e!="object")throw new TypeError("options must be an object.");if(!(e.format instanceof Ss))throw new TypeError("options.format must be an OutputFormat.");if(!(e.target instanceof Ts))throw new TypeError("options.target must be a Target.");if(e.target._output)throw new Error("Target is already used for another output.");e.target._output=this,this.format=e.format,this.target=e.target,this._writer=e.target._createWriter(),this._muxer=e.format._createMuxer(this)}addVideoTrack(e,t={}){if(!(e instanceof Is))throw new TypeError("source must be a VideoSource.");if(kn(t),t.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError(`Invalid video rotation: ${t.rotation}. Has to be 0, 90, 180 or 270.`);if(!this.format.supportsVideoRotationMetadata&&t.rotation)throw new Error(`${this.format._name} does not support video rotation metadata.`);if(t.frameRate!==void 0&&(!Number.isFinite(t.frameRate)||t.frameRate<=0))throw new TypeError(`Invalid video frame rate: ${t.frameRate}. Must be a positive number.`);this._addTrack("video",e,t)}addAudioTrack(e,t={}){if(!(e instanceof As))throw new TypeError("source must be an AudioSource.");kn(t),this._addTrack("audio",e,t)}addSubtitleTrack(e,t={}){if(!(e instanceof yp))throw new TypeError("source must be a SubtitleSource.");kn(t),this._addTrack("subtitle",e,t)}setMetadataTags(e){if(Nn(e),this.state!=="pending")throw new Error("Cannot set metadata tags after output has been started or canceled.");this._metadataTags=e}_addTrack(e,t,i){if(this.state!=="pending")throw new Error("Cannot add track after output has been started or canceled.");if(t._connectedTrack)throw new Error("Source is already used for a track.");const a=this.format.getSupportedTrackCounts(),s=this._tracks.reduce((l,d)=>l+(d.type===e?1:0),0),n=a[e].max;if(s===n)throw new Error(n===0?`${this.format._name} does not support ${e} tracks.`:`${this.format._name} does not support more than ${n} ${e} track${n===1?"":"s"}.`);const o=a.total.max;if(this._tracks.length===o)throw new Error(`${this.format._name} does not support more than ${o} tracks${o===1?"":"s"} in total.`);const c={id:this._tracks.length+1,output:this,type:e,source:t,metadata:i};if(c.type==="video"){const l=this.format.getSupportedVideoCodecs();if(l.length===0)throw new Error(`${this.format._name} does not support video tracks.`+this.format._codecUnsupportedHint(c.source._codec));if(!l.includes(c.source._codec))throw new Error(`Codec '${c.source._codec}' cannot be contained within ${this.format._name}. Supported video codecs are: ${l.map(d=>`'${d}'`).join(", ")}.`+this.format._codecUnsupportedHint(c.source._codec))}else if(c.type==="audio"){const l=this.format.getSupportedAudioCodecs();if(l.length===0)throw new Error(`${this.format._name} does not support audio tracks.`+this.format._codecUnsupportedHint(c.source._codec));if(!l.includes(c.source._codec))throw new Error(`Codec '${c.source._codec}' cannot be contained within ${this.format._name}. Supported audio codecs are: ${l.map(d=>`'${d}'`).join(", ")}.`+this.format._codecUnsupportedHint(c.source._codec))}else if(c.type==="subtitle"){const l=this.format.getSupportedSubtitleCodecs();if(l.length===0)throw new Error(`${this.format._name} does not support subtitle tracks.`+this.format._codecUnsupportedHint(c.source._codec));if(!l.includes(c.source._codec))throw new Error(`Codec '${c.source._codec}' cannot be contained within ${this.format._name}. Supported subtitle codecs are: ${l.map(d=>`'${d}'`).join(", ")}.`+this.format._codecUnsupportedHint(c.source._codec))}this._tracks.push(c),t._connectedTrack=c}async start(){const e=this.format.getSupportedTrackCounts();for(const i of kp){const a=this._tracks.reduce((n,o)=>n+(o.type===i?1:0),0),s=e[i].min;if(a<s)throw new Error(s===e[i].max?`${this.format._name} requires exactly ${s} ${i} track${s===1?"":"s"}.`:`${this.format._name} requires at least ${s} ${i} track${s===1?"":"s"}.`)}const t=e.total.min;if(this._tracks.length<t)throw new Error(t===e.total.max?`${this.format._name} requires exactly ${t} track${t===1?"":"s"}.`:`${this.format._name} requires at least ${t} track${t===1?"":"s"}.`);if(this.state==="canceled")throw new Error("Output has been canceled.");return this._startPromise?(console.warn("Output has already been started."),this._startPromise):this._startPromise=(async()=>{this.state="started",this._writer.start();const i=await this._mutex.acquire();await this._muxer.start();const a=this._tracks.map(s=>s.source._start());await Promise.all(a),i()})()}getMimeType(){return this._muxer.getMimeType()}async cancel(){if(this._cancelPromise)return console.warn("Output has already been canceled."),this._cancelPromise;if(this.state==="finalizing"||this.state==="finalized"){console.warn("Output has already been finalized.");return}return this._cancelPromise=(async()=>{this.state="canceled";const e=await this._mutex.acquire(),t=this._tracks.map(i=>i.source._flushOrWaitForOngoingClose(!0));await Promise.all(t),await this._writer.close(),e()})()}async finalize(){if(this.state==="pending")throw new Error("Cannot finalize before starting.");if(this.state==="canceled")throw new Error("Cannot finalize after canceling.");return this._finalizePromise?(console.warn("Output has already been finalized."),this._finalizePromise):this._finalizePromise=(async()=>{this.state="finalizing";const e=await this._mutex.acquire(),t=this._tracks.map(i=>i.source._flushOrWaitForOngoingClose(!1));await Promise.all(t),await this._muxer.finalize(),await this._writer.flush(),await this._writer.finalize(),this.state="finalized",e()})()}}const Mo=r=>{if(r!==void 0&&(!r||typeof r!="object"))throw new TypeError("options.video, when provided, must be an object.");if(r?.discard!==void 0&&typeof r.discard!="boolean")throw new TypeError("options.video.discard, when provided, must be a boolean.");if(r?.forceTranscode!==void 0&&typeof r.forceTranscode!="boolean")throw new TypeError("options.video.forceTranscode, when provided, must be a boolean.");if(r?.codec!==void 0&&!cr.includes(r.codec))throw new TypeError(`options.video.codec, when provided, must be one of: ${cr.join(", ")}.`);if(r?.bitrate!==void 0&&!(r.bitrate instanceof tr)&&(!Number.isInteger(r.bitrate)||r.bitrate<=0))throw new TypeError("options.video.bitrate, when provided, must be a positive integer or a quality.");if(r?.width!==void 0&&(!Number.isInteger(r.width)||r.width<=0))throw new TypeError("options.video.width, when provided, must be a positive integer.");if(r?.height!==void 0&&(!Number.isInteger(r.height)||r.height<=0))throw new TypeError("options.video.height, when provided, must be a positive integer.");if(r?.fit!==void 0&&!["fill","contain","cover"].includes(r.fit))throw new TypeError("options.video.fit, when provided, must be one of 'fill', 'contain', or 'cover'.");if(r?.width!==void 0&&r.height!==void 0&&r.fit===void 0)throw new TypeError("When both options.video.width and options.video.height are provided, options.video.fit must also be provided.");if(r?.rotate!==void 0&&![0,90,180,270].includes(r.rotate))throw new TypeError("options.video.rotate, when provided, must be 0, 90, 180 or 270.");if(r?.allowRotationMetadata!==void 0&&typeof r.allowRotationMetadata!="boolean")throw new TypeError("options.video.allowRotationMetadata, when provided, must be a boolean.");if(r?.crop!==void 0&&bs(r.crop,"options.video."),r?.frameRate!==void 0&&(!Number.isFinite(r.frameRate)||r.frameRate<=0))throw new TypeError("options.video.frameRate, when provided, must be a finite positive number.");if(r?.alpha!==void 0&&!["discard","keep"].includes(r.alpha))throw new TypeError("options.video.alpha, when provided, must be either 'discard' or 'keep'.");if(r?.keyFrameInterval!==void 0&&(!Number.isFinite(r.keyFrameInterval)||r.keyFrameInterval<0))throw new TypeError("options.video.keyFrameInterval, when provided, must be a non-negative number.");if(r?.process!==void 0&&typeof r.process!="function")throw new TypeError("options.video.process, when provided, must be a function.");if(r?.processedWidth!==void 0&&(!Number.isInteger(r.processedWidth)||r.processedWidth<=0))throw new TypeError("options.video.processedWidth, when provided, must be a positive integer.");if(r?.processedHeight!==void 0&&(!Number.isInteger(r.processedHeight)||r.processedHeight<=0))throw new TypeError("options.video.processedHeight, when provided, must be a positive integer.");if(r?.hardwareAcceleration!==void 0&&!["no-preference","prefer-hardware","prefer-software"].includes(r.hardwareAcceleration))throw new TypeError("options.video.hardwareAcceleration, when provided, must be 'no-preference', 'prefer-hardware' or 'prefer-software'.")},Ro=r=>{if(r!==void 0&&(!r||typeof r!="object"))throw new TypeError("options.audio, when provided, must be an object.");if(r?.discard!==void 0&&typeof r.discard!="boolean")throw new TypeError("options.audio.discard, when provided, must be a boolean.");if(r?.forceTranscode!==void 0&&typeof r.forceTranscode!="boolean")throw new TypeError("options.audio.forceTranscode, when provided, must be a boolean.");if(r?.codec!==void 0&&!gr.includes(r.codec))throw new TypeError(`options.audio.codec, when provided, must be one of: ${gr.join(", ")}.`);if(r?.bitrate!==void 0&&!(r.bitrate instanceof tr)&&(!Number.isInteger(r.bitrate)||r.bitrate<=0))throw new TypeError("options.audio.bitrate, when provided, must be a positive integer or a quality.");if(r?.numberOfChannels!==void 0&&(!Number.isInteger(r.numberOfChannels)||r.numberOfChannels<=0))throw new TypeError("options.audio.numberOfChannels, when provided, must be a positive integer.");if(r?.sampleRate!==void 0&&(!Number.isInteger(r.sampleRate)||r.sampleRate<=0))throw new TypeError("options.audio.sampleRate, when provided, must be a positive integer.");if(r?.process!==void 0&&typeof r.process!="function")throw new TypeError("options.audio.process, when provided, must be a function.");if(r?.processedNumberOfChannels!==void 0&&(!Number.isInteger(r.processedNumberOfChannels)||r.processedNumberOfChannels<=0))throw new TypeError("options.audio.processedNumberOfChannels, when provided, must be a positive integer.");if(r?.processedSampleRate!==void 0&&(!Number.isInteger(r.processedSampleRate)||r.processedSampleRate<=0))throw new TypeError("options.audio.processedSampleRate, when provided, must be a positive integer.")},xn=2,_n=48e3;class Fs{static async init(e){const t=new Fs(e);return await t._init(),t}constructor(e){if(this._addedCounts={video:0,audio:0,subtitle:0},this._totalTrackCount=0,this._trackPromises=[],this._executed=!1,this._synchronizer=new _p,this._totalDuration=null,this._maxTimestamps=new Map,this._canceled=!1,this.onProgress=void 0,this._computeProgress=!1,this._lastProgress=0,this.isValid=!1,this.utilizedTracks=[],this.discardedTracks=[],!e||typeof e!="object")throw new TypeError("options must be an object.");if(!(e.input instanceof il))throw new TypeError("options.input must be an Input.");if(!(e.output instanceof is))throw new TypeError("options.output must be an Output.");if(e.output._tracks.length>0||Object.keys(e.output._metadataTags).length>0||e.output.state!=="pending")throw new TypeError("options.output must be fresh: no tracks or metadata tags added and not started.");if(typeof e.video!="function"&&Mo(e.video),typeof e.audio!="function"&&Ro(e.audio),e.trim!==void 0&&(!e.trim||typeof e.trim!="object"))throw new TypeError("options.trim, when provided, must be an object.");if(e.trim?.start!==void 0&&(!Number.isFinite(e.trim.start)||e.trim.start<0))throw new TypeError("options.trim.start, when provided, must be a non-negative number.");if(e.trim?.end!==void 0&&(!Number.isFinite(e.trim.end)||e.trim.end<0))throw new TypeError("options.trim.end, when provided, must be a non-negative number.");if(e.trim?.start!==void 0&&e.trim.end!==void 0&&e.trim.start>=e.trim.end)throw new TypeError("options.trim.start must be less than options.trim.end.");if(e.tags!==void 0&&(typeof e.tags!="object"||!e.tags)&&typeof e.tags!="function")throw new TypeError("options.tags, when provided, must be an object or a function.");if(typeof e.tags=="object"&&Nn(e.tags),e.showWarnings!==void 0&&typeof e.showWarnings!="boolean")throw new TypeError("options.showWarnings, when provided, must be a boolean.");this._options=e,this.input=e.input,this.output=e.output,this._startTimestamp=e.trim?.start??0,this._endTimestamp=e.trim?.end??1/0;const{promise:t,resolve:i}=Mt();this._started=t,this._start=i}async _init(){const e=await this.input.getTracks(),t=this.output.format.getSupportedTrackCounts();let i=1,a=1;for(const l of e){let d;if(l.isVideoTrack()?this._options.video&&(typeof this._options.video=="function"?(d=await this._options.video(l,i),Mo(d),i++):d=this._options.video):l.isAudioTrack()?this._options.audio&&(typeof this._options.audio=="function"?(d=await this._options.audio(l,a),Ro(d),a++):d=this._options.audio):I(!1),d?.discard){this.discardedTracks.push({track:l,reason:"discarded_by_user"});continue}if(this._totalTrackCount===t.total.max){this.discardedTracks.push({track:l,reason:"max_track_count_reached"});continue}if(this._addedCounts[l.type]===t[l.type].max){this.discardedTracks.push({track:l,reason:"max_track_count_of_type_reached"});continue}l.isVideoTrack()?await this._processVideoTrack(l,d??{}):l.isAudioTrack()&&await this._processAudioTrack(l,d??{})}const s=await this.input.getMetadataTags();let n;if(this._options.tags){const l=typeof this._options.tags=="function"?await this._options.tags(s):this._options.tags;Nn(l),n=l}else n=s;const o=(await this.input.getFormat()).mimeType===this.output.format.mimeType,c=s.raw===n.raw;if(s.raw&&c&&!o&&delete n.raw,this.output.setMetadataTags(n),this.isValid=this._totalTrackCount>=t.total.min&&this._addedCounts.video>=t.video.min&&this._addedCounts.audio>=t.audio.min&&this._addedCounts.subtitle>=t.subtitle.min,this._options.showWarnings??!0){const l=[],d=this.discardedTracks.filter(u=>u.reason!=="discarded_by_user");d.length>0&&l.push("Some tracks had to be discarded from the conversion:",d),this.isValid||l.push(`

`+this._getInvalidityExplanation().join("")),l.length>0&&console.warn(...l)}}_getInvalidityExplanation(){const e=[];if(this.discardedTracks.length===0)e.push("Due to missing tracks, this conversion cannot be executed.");else{const t=this.discardedTracks.every(i=>i.reason==="discarded_by_user"||i.reason==="no_encodable_target_codec");if(e.push("Due to discarded tracks, this conversion cannot be executed."),t){const i=this.discardedTracks.flatMap(a=>a.reason==="discarded_by_user"?[]:a.track.type==="video"?this.output.format.getSupportedVideoCodecs():a.track.type==="audio"?this.output.format.getSupportedAudioCodecs():this.output.format.getSupportedSubtitleCodecs());i.length===1?e.push(`
Tracks were discarded because your environment is not able to encode '${i[0]}'.`):e.push(`
Tracks were discarded because your environment is not able to encode any of the following codecs: ${i.map(a=>`'${a}'`).join(", ")}.`),i.includes("mp3")&&e.push(`
The @mediabunny/mp3-encoder extension package provides support for encoding MP3.`)}else e.push(`
Check the discardedTracks field for more info.`)}return e}async execute(){if(!this.isValid)throw new Error(`Cannot execute this conversion because its output configuration is invalid. Make sure to always check the isValid field before executing a conversion.
`+this._getInvalidityExplanation().join(""));if(this._executed)throw new Error("Conversion cannot be executed twice.");if(this._executed=!0,this.onProgress){this._computeProgress=!0,this._totalDuration=Math.min(await this.input.computeDuration()-this._startTimestamp,this._endTimestamp-this._startTimestamp);for(const e of this.utilizedTracks)this._maxTimestamps.set(e.id,0);this.onProgress?.(0)}await this.output.start(),this._start();try{await Promise.all(this._trackPromises)}catch(e){throw this._canceled||this.cancel(),e}if(this._canceled)throw new xp;await this.output.finalize(),this._computeProgress&&this.onProgress?.(1)}async cancel(){if(!(this.output.state==="finalizing"||this.output.state==="finalized")){if(this._canceled){console.warn("Conversion already canceled.");return}this._canceled=!0,await this.output.cancel()}}async _processVideoTrack(e,t){const i=e.codec;if(!i){this.discardedTracks.push({track:e,reason:"unknown_source_codec"});return}let a;const s=Ha(e.rotation+(t.rotate??0)),n=this.output.format.supportsVideoRotationMetadata&&(t.allowRotationMetadata??!0),[o,c]=s%180===0?[e.codedWidth,e.codedHeight]:[e.codedHeight,e.codedWidth],l=t.crop;l&&vs(l,o,c);const[d,u]=l?[l.width,l.height]:[o,c];let f=d,h=u;const g=f/h,m=S=>Math.ceil(S/2)*2;t.width!==void 0&&t.height===void 0?(f=m(t.width),h=m(Math.round(f/g))):t.width===void 0&&t.height!==void 0?(h=m(t.height),f=m(Math.round(h*g))):t.width!==void 0&&t.height!==void 0&&(f=m(t.width),h=m(t.height));const v=await e.getFirstTimestamp(),p=!!t.forceTranscode||this._startTimestamp>0||v<0||!!t.frameRate||t.keyFrameInterval!==void 0||t.process!==void 0;let b=f!==d||h!==u||s!==0&&(!n||t.process!==void 0)||!!l;const y=t.alpha??"discard";let _=this.output.format.getSupportedVideoCodecs();if(!p&&!t.bitrate&&!b&&_.includes(i)&&(!t.codec||t.codec===i)){const S=new pp(i);a=S,this._trackPromises.push((async()=>{await this._started;const A=new la(e),D={decoderConfig:await e.getDecoderConfig()??void 0},M=Number.isFinite(this._endTimestamp)?await A.getPacket(this._endTimestamp,{metadataOnly:!0})??void 0:void 0;for await(const $ of A.packets(void 0,M,{verifyKeyPackets:!0})){if(this._canceled)return;y==="discard"&&(delete $.sideData.alpha,delete $.sideData.alphaByteLength),this._reportProgress(e.id,$.timestamp),await S.add($,D),this._synchronizer.shouldWait(e.id,$.timestamp)&&await this._synchronizer.wait($.timestamp)}S.close(),this._synchronizer.closeTrack(e.id)})())}else{if(!await e.canDecode()){this.discardedTracks.push({track:e,reason:"undecodable_source_codec"});return}t.codec&&(_=_.filter($=>$===t.codec));const A=t.bitrate??$a,z=await mp(_,{width:t.process&&t.processedWidth?t.processedWidth:f,height:t.process&&t.processedHeight?t.processedHeight:h,bitrate:A});if(!z){this.discardedTracks.push({track:e,reason:"no_encodable_target_codec"});return}const D={codec:z,bitrate:A,keyFrameInterval:t.keyFrameInterval,sizeChangeBehavior:t.fit??"passThrough",alpha:y,hardwareAcceleration:t.hardwareAcceleration},M=new zo(D);if(a=M,!b){const $=new is({format:new Cs,target:new tp}),K=new zo(D);$.addVideoTrack(K),await $.start();const O=await new Ln(e).getSample(v);if(O)try{await K.add(O),O.close(),await $.finalize()}catch(k){console.info("Error when probing encoder support. Falling back to rerender path.",k),b=!0,$.cancel()}else await $.cancel()}b?this._trackPromises.push((async()=>{await this._started;const K=new Sf(e,{width:f,height:h,fit:t.fit??"fill",rotation:s,crop:t.crop,poolSize:1,alpha:y==="keep"}).canvases(this._startTimestamp,this._endTimestamp),P=t.frameRate;let O=null,k=null,Q=null;const se=async Y=>{I(O),I(P!==void 0);const be=Math.round((Y-k)*P);for(let ee=1;ee<be;ee++){const me=new $t(O,{timestamp:k+ee/P,duration:1/P});await this._registerVideoSample(e,t,M,me),me.close()}};for await(const{canvas:Y,timestamp:be,duration:ee}of K){if(this._canceled)return;let me=Math.max(be-this._startTimestamp,0);if(Q=me+ee,P!==void 0){const V=Math.floor(me*P)/P;if(O!==null)if(V<=k){O=Y,k=V;continue}else await se(V);me=V}const q=new $t(Y,{timestamp:me,duration:P!==void 0?1/P:ee});await this._registerVideoSample(e,t,M,q),q.close(),P!==void 0&&(O=Y,k=me)}O&&(I(Q!==null),I(P!==void 0),await se(Math.floor(Q*P)/P)),M.close(),this._synchronizer.closeTrack(e.id)})()):this._trackPromises.push((async()=>{await this._started;const $=new Ln(e),K=t.frameRate;let P=null,O=null,k=null;const Q=async se=>{I(P),I(K!==void 0);const Y=Math.round((se-O)*K);for(let be=1;be<Y;be++)P.setTimestamp(O+be/K),P.setDuration(1/K),await this._registerVideoSample(e,t,M,P);P.close()};for await(const se of $.samples(this._startTimestamp,this._endTimestamp)){if(this._canceled){se.close(),P?.close();return}let Y=Math.max(se.timestamp-this._startTimestamp,0);if(k=Y+se.duration,K!==void 0){const be=Math.floor(Y*K)/K;if(P!==null)if(be<=O){P.close(),P=se,O=be;continue}else await Q(be);Y=be,se.setDuration(1/K)}se.setTimestamp(Y),await this._registerVideoSample(e,t,M,se),K!==void 0?(P=se,O=Y):se.close()}P&&(I(k!==null),I(K!==void 0),await Q(Math.floor(k*K)/K)),M.close(),this._synchronizer.closeTrack(e.id)})())}this.output.addVideoTrack(a,{frameRate:t.frameRate,languageCode:sa(e.languageCode)?e.languageCode:void 0,name:e.name??void 0,disposition:e.disposition,rotation:b?0:s}),this._addedCounts.video++,this._totalTrackCount++,this.utilizedTracks.push(e)}async _registerVideoSample(e,t,i,a){if(this._canceled)return;this._reportProgress(e.id,a.timestamp);let s;if(!t.process)s=[a];else{let n=t.process(a);n instanceof Promise&&(n=await n),Array.isArray(n)||(n=n===null?[]:[n]),s=n.map(o=>o instanceof $t?o:typeof VideoFrame<"u"&&o instanceof VideoFrame?new $t(o):new $t(o,{timestamp:a.timestamp,duration:a.duration}))}for(const n of s){if(this._canceled)break;await i.add(n),this._synchronizer.shouldWait(e.id,n.timestamp)&&await this._synchronizer.wait(n.timestamp)}for(const n of s)n!==a&&n.close()}async _processAudioTrack(e,t){const i=e.codec;if(!i){this.discardedTracks.push({track:e,reason:"unknown_source_codec"});return}let a;const s=e.numberOfChannels,n=e.sampleRate,o=await e.getFirstTimestamp();let c=t.numberOfChannels??s,l=t.sampleRate??n,d=c!==s||l!==n||this._startTimestamp>0||o<0,u=this.output.format.getSupportedAudioCodecs();if(!t.forceTranscode&&!t.bitrate&&!d&&u.includes(i)&&(!t.codec||t.codec===i)&&!t.process){const f=new bp(i);a=f,this._trackPromises.push((async()=>{await this._started;const h=new la(e),m={decoderConfig:await e.getDecoderConfig()??void 0},v=Number.isFinite(this._endTimestamp)?await h.getPacket(this._endTimestamp,{metadataOnly:!0})??void 0:void 0;for await(const p of h.packets(void 0,v)){if(this._canceled)return;this._reportProgress(e.id,p.timestamp),await f.add(p,m),this._synchronizer.shouldWait(e.id,p.timestamp)&&await this._synchronizer.wait(p.timestamp)}f.close(),this._synchronizer.closeTrack(e.id)})())}else{if(!await e.canDecode()){this.discardedTracks.push({track:e,reason:"undecodable_source_codec"});return}let h=null;t.codec&&(u=u.filter(v=>v===t.codec));const g=t.bitrate??$a,m=await Fo(u,{numberOfChannels:t.process&&t.processedNumberOfChannels?t.processedNumberOfChannels:c,sampleRate:t.process&&t.processedSampleRate?t.processedSampleRate:l,bitrate:g});if(!m.some(v=>Pi.includes(v))&&u.some(v=>Pi.includes(v))&&(c!==xn||l!==_n)){const p=(await Fo(u,{numberOfChannels:xn,sampleRate:_n,bitrate:g})).find(b=>Pi.includes(b));p&&(d=!0,h=p,c=xn,l=_n)}else h=m[0]??null;if(h===null){this.discardedTracks.push({track:e,reason:"no_encodable_target_codec"});return}if(d)a=this._resampleAudio(e,t,h,c,l,g);else{const v=new Bo({codec:h,bitrate:g});a=v,this._trackPromises.push((async()=>{await this._started;const p=new po(e);for await(const b of p.samples(void 0,this._endTimestamp)){if(this._canceled){b.close();return}await this._registerAudioSample(e,t,v,b),b.close()}v.close(),this._synchronizer.closeTrack(e.id)})())}}this.output.addAudioTrack(a,{languageCode:sa(e.languageCode)?e.languageCode:void 0,name:e.name??void 0,disposition:e.disposition}),this._addedCounts.audio++,this._totalTrackCount++,this.utilizedTracks.push(e)}async _registerAudioSample(e,t,i,a){if(this._canceled)return;this._reportProgress(e.id,a.timestamp);let s;if(!t.process)s=[a];else{let n=t.process(a);if(n instanceof Promise&&(n=await n),Array.isArray(n)||(n=n===null?[]:[n]),!n.every(o=>o instanceof sr))throw new TypeError("The audio process function must return an AudioSample, null, or an array of AudioSamples.");s=n}for(const n of s){if(this._canceled)break;await i.add(n),this._synchronizer.shouldWait(e.id,n.timestamp)&&await this._synchronizer.wait(n.timestamp)}for(const n of s)n!==a&&n.close()}_resampleAudio(e,t,i,a,s,n){const o=new Bo({codec:i,bitrate:n});return this._trackPromises.push((async()=>{await this._started;const c=new Tp({targetNumberOfChannels:a,targetSampleRate:s,startTime:this._startTimestamp,endTime:this._endTimestamp,onSample:async u=>{await this._registerAudioSample(e,t,o,u),u.close()}}),d=new po(e).samples(this._startTimestamp,this._endTimestamp);for await(const u of d){if(this._canceled){u.close();return}await c.add(u),u.close()}await c.finalize(),o.close(),this._synchronizer.closeTrack(e.id)})()),o}_reportProgress(e,t){if(!this._computeProgress)return;I(this._totalDuration!==null),this._maxTimestamps.set(e,Math.max(t,this._maxTimestamps.get(e)));const i=Math.min(...this._maxTimestamps.values()),a=Bt(i/this._totalDuration,0,1);a!==this._lastProgress&&(this._lastProgress=a,this.onProgress?.(a))}}class xp extends Error{constructor(e="Conversion has been canceled."){super(e),this.name="ConversionCanceledError"}}const Do=5;class _p{constructor(){this.maxTimestamps=new Map,this.resolvers=[]}computeMinAndMaybeResolve(){let e=1/0;for(const[,t]of this.maxTimestamps)e=Math.min(e,t);for(let t=0;t<this.resolvers.length;t++){const i=this.resolvers[t];i.timestamp-e<Do&&(i.resolve(),this.resolvers.splice(t,1),t--)}return e}shouldWait(e,t){this.maxTimestamps.set(e,Math.max(t,this.maxTimestamps.get(e)??-1/0));const i=this.computeMinAndMaybeResolve();return t-i>=Do}wait(e){const{promise:t,resolve:i}=Mt();return this.resolvers.push({timestamp:e,resolve:i}),t}closeTrack(e){this.maxTimestamps.delete(e),this.computeMinAndMaybeResolve()}}class Tp{constructor(e){this.sourceSampleRate=null,this.sourceNumberOfChannels=null,this.targetSampleRate=e.targetSampleRate,this.targetNumberOfChannels=e.targetNumberOfChannels,this.startTime=e.startTime,this.endTime=e.endTime,this.onSample=e.onSample,this.bufferSizeInFrames=Math.floor(this.targetSampleRate*5),this.bufferSizeInSamples=this.bufferSizeInFrames*this.targetNumberOfChannels,this.outputBuffer=new Float32Array(this.bufferSizeInSamples),this.bufferStartFrame=0,this.maxWrittenFrame=-1}doChannelMixerSetup(){I(this.sourceNumberOfChannels!==null);const e=this.sourceNumberOfChannels,t=this.targetNumberOfChannels;e===1&&t===2?this.channelMixer=(i,a)=>i[a*e]:e===1&&t===4?this.channelMixer=(i,a,s)=>i[a*e]*+(s<2):e===1&&t===6?this.channelMixer=(i,a,s)=>i[a*e]*+(s===2):e===2&&t===1?this.channelMixer=(i,a)=>{const s=a*e;return .5*(i[s]+i[s+1])}:e===2&&t===4?this.channelMixer=(i,a,s)=>i[a*e+s]*+(s<2):e===2&&t===6?this.channelMixer=(i,a,s)=>i[a*e+s]*+(s<2):e===4&&t===1?this.channelMixer=(i,a)=>{const s=a*e;return .25*(i[s]+i[s+1]+i[s+2]+i[s+3])}:e===4&&t===2?this.channelMixer=(i,a,s)=>{const n=a*e;return .5*(i[n+s]+i[n+s+2])}:e===4&&t===6?this.channelMixer=(i,a,s)=>{const n=a*e;return s<2?i[n+s]:s===2||s===3?0:i[n+s-2]}:e===6&&t===1?this.channelMixer=(i,a)=>{const s=a*e;return Math.SQRT1_2*(i[s]+i[s+1])+i[s+2]+.5*(i[s+4]+i[s+5])}:e===6&&t===2?this.channelMixer=(i,a,s)=>{const n=a*e;return i[n+s]+Math.SQRT1_2*(i[n+2]+i[n+s+4])}:e===6&&t===4?this.channelMixer=(i,a,s)=>{const n=a*e;return s<2?i[n+s]+Math.SQRT1_2*i[n+2]:i[n+s+2]}:this.channelMixer=(i,a,s)=>s<e?i[a*e+s]:0}ensureTempBufferSize(e){let t=this.tempSourceBuffer.length;for(;t<e;)t*=2;if(t!==this.tempSourceBuffer.length){const i=new Float32Array(t);i.set(this.tempSourceBuffer),this.tempSourceBuffer=i}}async add(e){this.sourceSampleRate===null&&(this.sourceSampleRate=e.sampleRate,this.sourceNumberOfChannels=e.numberOfChannels,this.tempSourceBuffer=new Float32Array(this.sourceSampleRate*this.sourceNumberOfChannels),this.doChannelMixerSetup());const t=e.numberOfFrames*e.numberOfChannels;this.ensureTempBufferSize(t);const i=e.allocationSize({planeIndex:0,format:"f32"}),a=new Float32Array(this.tempSourceBuffer.buffer,0,i/4);e.copyTo(a,{planeIndex:0,format:"f32"});const s=e.timestamp-this.startTime,n=e.numberOfFrames/this.sourceSampleRate,o=Math.min(s+n,this.endTime-this.startTime),c=Math.floor(s*this.targetSampleRate),l=Math.ceil(o*this.targetSampleRate);for(let d=c;d<l;d++){if(d<this.bufferStartFrame)continue;for(;d>=this.bufferStartFrame+this.bufferSizeInFrames;)await this.finalizeCurrentBuffer(),this.bufferStartFrame+=this.bufferSizeInFrames;const u=d-this.bufferStartFrame;I(u<this.bufferSizeInFrames);const g=(d/this.targetSampleRate-s)*this.sourceSampleRate,m=Math.floor(g),v=Math.ceil(g),p=g-m;for(let b=0;b<this.targetNumberOfChannels;b++){let y=0,_=0;m>=0&&m<e.numberOfFrames&&(y=this.channelMixer(a,m,b)),v>=0&&v<e.numberOfFrames&&(_=this.channelMixer(a,v,b));const S=y+p*(_-y),A=u*this.targetNumberOfChannels+b;this.outputBuffer[A]+=S}this.maxWrittenFrame=Math.max(this.maxWrittenFrame,u)}}async finalizeCurrentBuffer(){if(this.maxWrittenFrame<0)return;const e=(this.maxWrittenFrame+1)*this.targetNumberOfChannels,t=new Float32Array(e);t.set(this.outputBuffer.subarray(0,e));const i=this.bufferStartFrame/this.targetSampleRate,a=new sr({format:"f32",sampleRate:this.targetSampleRate,numberOfChannels:this.targetNumberOfChannels,timestamp:i,data:t});await this.onSample(a),this.outputBuffer.fill(0),this.maxWrittenFrame=-1}finalize(){return this.finalizeCurrentBuffer()}}const Sp={tiny:up,web:fp,social:Ps,high:$a,lossless:hp};function Tl(){return typeof VideoEncoder<"u"&&typeof VideoDecoder<"u"&&typeof AudioEncoder<"u"&&typeof AudioDecoder<"u"}async function Cp(){if(!Tl())return{supported:!1,hardwareAcceleration:!1,supportedVideoCodecs:[],supportedAudioCodecs:[],maxResolution:{width:0,height:0}};const r=[],e=[];let t=!1;const i=[{codec:"avc",mediabunnyCodec:"avc"},{codec:"vp9",mediabunnyCodec:"vp9"},{codec:"av1",mediabunnyCodec:"av1"},{codec:"hevc",mediabunnyCodec:"hevc"}];for(const c of i)try{if(c.codec==="av1"||c.codec==="hevc")try{if((await VideoEncoder.isConfigSupported({codec:Tn(c.codec),width:1920,height:1080,bitrate:5e6,framerate:30,hardwareAcceleration:"prefer-hardware"})).supported)try{const u=new VideoEncoder({output:()=>{},error:()=>{}});await u.configure({codec:Tn(c.codec),width:640,height:480,bitrate:1e6,framerate:30,hardwareAcceleration:"prefer-hardware"});const f=u.encodeQueueSize!==void 0;u.close(),f&&(r.push(c.codec),t=!0)}catch{console.log(`${c.codec.toUpperCase()} hardware encoder not available`)}}catch{}else if(await rs(c.mediabunnyCodec,{width:1920,height:1080,bitrate:Ps})){r.push(c.codec);try{const u=await VideoEncoder.isConfigSupported({codec:Tn(c.codec),width:1920,height:1080,bitrate:5e6,framerate:30,hardwareAcceleration:"prefer-hardware"});u.supported&&u.config?.hardwareAcceleration==="prefer-hardware"&&(t=!0)}catch{}}}catch{}const a=[{codec:"aac",mediabunnyCodec:"aac"},{codec:"opus",mediabunnyCodec:"opus"}];for(const c of a)try{await _l(c.mediabunnyCodec,{sampleRate:48e3,numberOfChannels:2,bitrate:128e3})&&e.push(c.codec)}catch{}let s=1920,n=1080;const o=[{width:3840,height:2160},{width:2560,height:1440},{width:1920,height:1080}];for(const c of o)try{if(await rs("avc",{width:c.width,height:c.height,bitrate:$a})){s=c.width,n=c.height;break}}catch{}return{supported:r.length>0,hardwareAcceleration:t,supportedVideoCodecs:r,supportedAudioCodecs:e,maxResolution:{width:s,height:n}}}function Tn(r){switch(r){case"avc":return"avc1.640028";case"vp9":return"vp09.00.40.08";case"av1":return"av01.0.08M.08";case"hevc":return"hev1.1.6.L93.B0";default:return"avc1.640028"}}async function Pp(r,e,t,i="web",a=!1,s){const n=performance.now();let o=0,c=0;try{s?.({stage:"decoding",progress:0,framesProcessed:0,totalFrames:0,fps:0});const l=new il({source:new Oh(r),formats:Nh}),u=(await l.getVideoTracks())[0],f=await l.computeDuration();let h=30;if(u){try{const P=await u.computePacketStats(100);P.averagePacketRate>0&&(h=P.averagePacketRate)}catch{}c=Math.ceil(f*h)}const g=t==="mp4"?new Cs({fastStart:"in-memory"}):new Jn,m=new bl,v=new is({format:g,target:m}),p=Sp[i]||Ps,b=e.videoCodec,y=e.audioCodec,_=e.trimStart??0,S=e.trimEnd??f,A=S-_;A!==f&&(c=Math.ceil(A*h));const z=await Fs.init({input:l,output:v,video:{codec:b,bitrate:p,keyFrameInterval:2,fit:"contain",hardwareAcceleration:"prefer-hardware",width:e.width,height:e.height,forceTranscode:!0},audio:{codec:y,bitrate:e.audioBitrate||128e3,sampleRate:e.sampleRate||48e3,numberOfChannels:e.channels||2},trim:{start:_,end:S},tags:a?{}:void 0,showWarnings:!1});let D=performance.now(),M=0;z.onProgress=P=>{const O=performance.now(),k=Math.round(P*c)-M,Q=(O-D)/1e3,se=Q>0?k/Q:0;o=Math.round(P*c),M=o,D=O,s?.({stage:P<.95?"encoding":"muxing",progress:Math.round(P*100),framesProcessed:o,totalFrames:c,fps:Math.round(se)})},await z.execute();const $=m.buffer;if(!$)throw new Error("Output buffer is null - conversion may have failed");s?.({stage:"complete",progress:100,framesProcessed:c,totalFrames:c,fps:c/((performance.now()-n)/1e3)});const K=t==="mp4"?"video/mp4":"video/webm";return new Blob([$],{type:K})}catch(l){throw console.error("WebCodecs encoding error:",l),new Error(`WebCodecs encoding failed: ${l instanceof Error?l.message:"Unknown error"}`)}}function Sl(r){return r==="webm"?{video:"vp9",audio:"opus"}:r==="av1"?{video:"av1",audio:"aac"}:r==="hevc"?{video:"hevc",audio:"aac"}:{video:"avc",audio:"aac"}}let pi=null,Zi=!1;const gi=[];async function pa(){return pi||(pi=await Cp(),console.log("WebCodecs capabilities:",pi),pi)}function No(){return pi}function Ep(){return Tl()?{supported:!0}:{supported:!1,reason:"Your browser does not support WebCodecs. Please use Chrome, Edge, or Safari 16.4+."}}async function Ip(r){gi.push(...r),Zi||Ap()}async function Ap(){if(gi.length===0){Zi=!1;return}if(Zi=!0,!(await pa()).supported){for(;gi.length>0;){const e=gi.shift();de.updateItem(e,{status:"error",error:"WebCodecs not supported in this browser. Please use Chrome, Edge, or Safari 16.4+."})}Zi=!1;return}for(;gi.length>0;){const e=gi.shift(),t=de.getItemById(e);t&&t.status==="pending"&&await zs(t)}Zi=!1}async function zs(r){try{de.updateItem(r.id,{status:"processing",progress:0,progressStage:"Initializing hardware encoder...",eta:pu(r,de.settings)});const e=await pa(),t=r.outputFormat,{video:i}=Sl(t);if(!e.supportedVideoCodecs.includes(i))throw new Error(`${i.toUpperCase()} codec not supported by your hardware. Try a different output format.`);const a=e.hardwareAcceleration?" (GPU)":"";de.updateItem(r.id,{progressStage:`Encoding with ${i.toUpperCase()}${a}...`});const s=await Fp(r),n=URL.createObjectURL(s.blob);de.updateItem(r.id,{status:"completed",progress:100,progressStage:"Complete",compressedSize:s.blob.size,compressedUrl:n,compressedBlob:s.blob,compressionDuration:s.duration,eta:void 0})}catch(e){console.error("Compression error:",e),de.updateItem(r.id,{status:"error",error:e instanceof Error?e.message:"Compression failed",progressStage:void 0,eta:void 0})}}async function Fp(r){const e=Date.now(),t=de.settings.quality,i=r.outputFormat;let s={tiny:5e5,web:15e5,social:3e6,high:6e6,lossless:2e7}[t]||2e6;de.settings.targetSizeMB&&(s=hu(r,de.settings.targetSizeMB,de.settings));const n={original:{width:r.width||1920,height:r.height||1080},"2160p":{width:3840,height:2160},"1440p":{width:2560,height:1440},"1080p":{width:1920,height:1080},"720p":{width:1280,height:720},"480p":{width:854,height:480},"360p":{width:640,height:360}},o=n[de.settings.resolution]||n.original,{video:c,audio:l}=Sl(i),d={"64k":64e3,"128k":128e3,"192k":192e3,"256k":256e3,"320k":32e4},u=i==="av1"||i==="hevc"?"mp4":i;return{blob:await Pp(r.file,{videoCodec:c,audioCodec:l,width:o.width,height:o.height,bitrate:s,framerate:30,audioBitrate:d[de.settings.audioBitrate]||128e3,sampleRate:48e3,channels:2,trimStart:r.trimStart,trimEnd:r.trimEnd},u,t,de.settings.stripMetadata,h=>{de.updateItem(r.id,{progress:h.progress,progressStage:`${h.stage} (${h.framesProcessed}/${h.totalFrames} frames)`,eta:h.fps>0?Math.round((h.totalFrames-h.framesProcessed)/h.fps):void 0})}),duration:Date.now()-e}}function zp(r){return r==="av1"||r==="hevc"?".mp4":`.${r}`}function Bs(r,e){return`${r.replace(/\.[^/.]+$/,"")}-compressed${zp(e)}`}async function Oo(r){const e=de.getItemById(r);if(!e)return;e.compressedUrl&&URL.revokeObjectURL(e.compressedUrl),e.previewUrl&&URL.revokeObjectURL(e.previewUrl),de.updateItem(r,{status:"pending",progress:0,progressStage:void 0,compressedSize:void 0,compressedUrl:void 0,compressedBlob:void 0,previewUrl:void 0,eta:void 0,error:void 0});const t=de.getItemById(r);t&&await zs(t)}async function Bp(){const r=de.items.filter(e=>e.status==="completed");if(r.length!==0){for(const e of r)e.compressedUrl&&URL.revokeObjectURL(e.compressedUrl),e.previewUrl&&URL.revokeObjectURL(e.previewUrl),de.updateItem(e.id,{outputFormat:de.settings.outputFormat,status:"pending",progress:0,progressStage:void 0,compressedSize:void 0,compressedUrl:void 0,compressedBlob:void 0,previewUrl:void 0,eta:void 0});for(const e of r){const t=de.getItemById(e.id);t&&t.status==="pending"&&await zs(t)}}}async function Mp(){const r=await pa();return{hardwareConcurrency:navigator.hardwareConcurrency||4,deviceMemory:navigator.deviceMemory||4,webCodecs:r}}async function Rp(){try{return await pa(),!0}catch{return!1}}function Dp(r){if(!r.compressedBlob)return;const e=Bs(r.name,r.outputFormat),t=URL.createObjectURL(r.compressedBlob),i=document.createElement("a");i.href=t,i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(t)}async function Np(r){const e=new Eu;for(const s of r)if(s.compressedBlob){const n=Bs(s.name,s.outputFormat);e.file(n,s.compressedBlob)}const t=await e.generateAsync({type:"blob"}),i=URL.createObjectURL(t),a=document.createElement("a");a.href=i,a.download=`squash-videos-${Date.now()}.zip`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i)}function Sn(r){const e=Math.floor(r/60),t=Math.floor(r%60);return`${e}:${t.toString().padStart(2,"0")}`}function xi(r){const e=Math.floor(r/60),t=Math.floor(r%60);return`${e}:${t.toString().padStart(2,"0")}`}var Op=re('<div class="fixed inset-0 z-50 flex items-center justify-center bg-black/95 p-4" role="dialog" aria-modal="true" aria-label="Video comparison"><button class="absolute right-4 top-4 z-20 rounded-full bg-white/10 p-3 text-white backdrop-blur-sm transition-colors hover:bg-white/20" aria-label="Close comparison"><!></button> <div class="absolute left-4 top-4 z-20 flex items-center gap-4"><div class="bg-surface-800/90 rounded-xl px-4 py-2 backdrop-blur-sm"><div class="text-surface-400 text-xs uppercase tracking-wide">Original</div> <div class="text-lg font-bold text-white"> </div></div> <div class="from-accent-start to-accent-end rounded-xl bg-gradient-to-r px-4 py-2 shadow-lg"><div class="text-xs uppercase tracking-wide text-white/80">Compressed</div> <div class="text-lg font-bold text-white"> <span class="ml-2 text-sm font-normal"> </span></div></div></div> <div class="relative max-h-[80vh] max-w-[95vw] select-none overflow-hidden rounded-2xl shadow-2xl" role="slider" aria-label="Comparison slider" tabindex="0"><div class="relative"><video class="block max-h-[80vh] max-w-[95vw]" loop autoplay playsinline=""></video> <div class="absolute bottom-4 left-4 rounded-lg bg-black/70 px-3 py-1.5 text-sm font-medium text-white">Original</div></div> <div class="absolute inset-0 overflow-hidden"><video class="block max-h-[80vh] max-w-[95vw]" loop autoplay playsinline=""></video> <div class="from-accent-start to-accent-end absolute bottom-4 right-4 rounded-lg bg-gradient-to-r px-3 py-1.5 text-sm font-bold text-white shadow-lg">Compressed</div></div> <div class="absolute bottom-0 top-0 z-10 w-1 cursor-ew-resize transition-transform"><div class="absolute inset-0 bg-white shadow-lg"></div> <div><!> <!></div></div></div> <div class="absolute bottom-4 left-1/2 -translate-x-1/2 text-center"><p class="text-surface-400 text-sm">Drag slider to compare â€¢ Press <kbd class="bg-surface-800 rounded px-2 py-0.5">â†</kbd> <kbd class="bg-surface-800 rounded px-2 py-0.5">â†’</kbd> to adjust â€¢ <kbd class="bg-surface-800 rounded px-2 py-0.5">Esc</kbd> to close</p></div></div>',2);function Up(r,e){Qt(e,!0);let t=We(50),i=We(!1),a,s=We(void 0);Oi(()=>{if(x(s))return cs(x(s))});const n=Ke(()=>Math.round((1-e.compressedSize/e.originalSize)*100));function o(V){if(V===0)return"0 B";const ue=1024,oe=["B","KB","MB","GB"],j=Math.floor(Math.log(V)/Math.log(ue));return parseFloat((V/Math.pow(ue,j)).toFixed(1))+" "+oe[j]}function c(V){ne(i,!0),g(V)}function l(V){x(i)&&g(V)}function d(){ne(i,!1)}function u(V){ne(i,!0),m(V)}function f(V){x(i)&&(V.preventDefault(),m(V))}function h(){ne(i,!1)}function g(V){if(!a)return;const ue=a.getBoundingClientRect(),oe=V.clientX-ue.left,j=Math.max(0,Math.min(100,oe/ue.width*100));ne(t,j,!0)}function m(V){if(!a||!V.touches[0])return;const ue=a.getBoundingClientRect(),oe=V.touches[0].clientX-ue.left,j=Math.max(0,Math.min(100,oe/ue.width*100));ne(t,j,!0)}function v(V){V.key==="Escape"?e.onclose():V.key==="ArrowLeft"?ne(t,Math.max(0,x(t)-5),!0):V.key==="ArrowRight"&&ne(t,Math.min(100,x(t)+5),!0)}var p=Op();St("keydown",Ji,v),St("mouseup",Ji,d),St("mousemove",Ji,l);var b=E(p);b.__click=function(...V){e.onclose?.apply(this,V)};var y=E(b);kr(y,{class:"h-6 w-6"}),C(b);var _=R(b,2),S=E(_),A=R(E(S),2),z=E(A,!0);C(A),C(S);var D=R(S,2),M=R(E(D),2),$=E(M),K=R($),P=E(K);C(K),C(M),C(D),C(_);var O=R(_,2);O.__mousedown=c,O.__touchstart=u,O.__touchmove=f,O.__touchend=h,ct(O,"aria-valuemin",0),ct(O,"aria-valuemax",100);var k=E(O),Q=E(k);Q.muted=!0,Me(2),C(k);var se=R(k,2),Y=E(se);Y.muted=!0,Me(2),C(se);var be=R(se,2),ee=R(E(be),2),me=E(ee);xd(me,{class:"text-surface-600 -mr-1 h-5 w-5"});var q=R(me,2);_d(q,{class:"text-surface-600 -ml-1 h-5 w-5"}),C(ee),C(be),C(O),Fi(O,V=>a=V,()=>a),Me(2),C(p),Fi(p,V=>ne(s,V),()=>x(s)),_e((V,ue,oe)=>{ge(z,V),ge($,`${ue??""} `),ge(P,`(-${x(n)??""}%)`),ct(O,"aria-valuenow",oe),ct(Q,"src",e.originalUrl),ar(se,`clip-path: inset(0 0 0 ${x(t)??""}%)`),ct(Y,"src",e.compressedUrl),ar(be,`left: ${x(t)??""}%; transform: translateX(-50%)`),Ge(ee,1,`absolute left-1/2 top-1/2 flex h-12 w-12 -translate-x-1/2 -translate-y-1/2 items-center justify-center rounded-full bg-white shadow-xl transition-transform ${x(i)?"scale-110":"hover:scale-105"}`)},[()=>o(e.originalSize),()=>o(e.compressedSize),()=>Math.round(x(t))]),ft(3,p,()=>Gt,()=>({duration:200})),W(r,p),Xt()}Wt(["click","mousedown","touchstart","touchmove","touchend"]);var Vp=re('<img alt="" class="h-full flex-1 object-cover opacity-40"/>'),Lp=re('<div class="absolute inset-0 flex"></div>'),$p=re('<div class="absolute inset-0 flex items-center justify-center"><div class="border-surface-600 border-t-accent-start h-4 w-4 animate-spin rounded-full border-2"></div></div>'),Wp=re('<div class="bg-surface-700 text-surface-200 absolute -top-8 z-20 -translate-x-1/2 transform whitespace-nowrap rounded px-2 py-1 text-xs"> </div>'),Hp=re('<div class="select-none"><div class="bg-surface-800 relative h-14 cursor-crosshair overflow-hidden rounded-lg" role="slider" aria-label="Trim timeline" tabindex="0"><!> <div class="absolute bottom-0 left-0 top-0 bg-black/60"></div> <div class="absolute bottom-0 right-0 top-0 bg-black/60"></div> <div class="absolute bottom-0 top-0 border-y-2 border-purple-500/70"></div> <div role="slider" aria-label="Trim start" tabindex="0"><div class="h-6 w-0.5 rounded-full bg-white/80"></div></div> <div role="slider" aria-label="Trim end" tabindex="0"><div class="h-6 w-0.5 rounded-full bg-white/80"></div></div> <!></div> <div class="mt-2 flex items-center justify-between text-xs"><div class="flex items-center gap-2"><span class="text-surface-500">Start:</span> <span class="font-mono text-purple-400"> </span></div> <div class="flex items-center gap-1.5 rounded-lg bg-purple-500/20 px-2 py-1"><span class="text-surface-400">Duration:</span> <span class="font-mono font-semibold text-purple-400"> </span></div> <div class="flex items-center gap-2"><span class="text-surface-500">End:</span> <span class="font-mono text-purple-400"> </span></div></div></div>');function jp(r,e){Qt(e,!0);let t=We(void 0),i=We(Ti([])),a=We(!1),s=We(!1),n=We(null),o=We(0),c=We(!0),l=We(Ti(e.trimStart)),d=We(Ti(e.trimEnd));Oi(()=>{!x(a)&&!x(s)&&(ne(l,e.trimStart,!0),ne(d,e.trimEnd,!0))}),ua(async()=>{try{const te=document.createElement("video");te.src=e.videoUrl,te.crossOrigin="anonymous",te.muted=!0,await new Promise((Se,Xe)=>{te.onloadedmetadata=()=>Se(),te.onerror=()=>Xe(new Error("Failed to load video")),setTimeout(()=>Xe(new Error("Video load timeout")),5e3)});const le=document.createElement("canvas"),he=le.getContext("2d"),we=Math.min(8,Math.max(4,Math.ceil(e.duration/5))),Ee=[];le.width=160,le.height=90;for(let Se=0;Se<we;Se++){const Xe=e.duration/we*Se+e.duration/we/2;te.currentTime=Xe,await new Promise(at=>{te.onseeked=()=>at(),setTimeout(at,500)}),he.drawImage(te,0,0,le.width,le.height),Ee.push(le.toDataURL("image/jpeg",.5))}ne(i,Ee,!0)}catch(te){console.warn("Could not generate thumbnails:",te)}finally{ne(c,!1)}});function u(te,le){te.preventDefault(),te.stopPropagation(),le==="start"?ne(a,!0):ne(s,!0),window.addEventListener("mousemove",f),window.addEventListener("mouseup",h)}function f(te){if(!x(t))return;const le=x(t).getBoundingClientRect(),Ee=Math.max(0,Math.min(le.width,te.clientX-le.left))/le.width*e.duration;if(x(a)){const Se=x(d)-.5;ne(l,Math.max(0,Math.min(Ee,Se)),!0)}else if(x(s)){const Se=x(l)+.5;ne(d,Math.max(Se,Math.min(Ee,e.duration)),!0)}}function h(){(x(a)||x(s))&&e.onchange(x(l),x(d)),ne(a,!1),ne(s,!1),window.removeEventListener("mousemove",f),window.removeEventListener("mouseup",h)}function g(te){if(!x(t)||x(a)||x(s))return;const le=x(t).getBoundingClientRect(),he=te.clientX-le.left,we=Math.max(0,Math.min(1,he/le.width));ne(n,we*e.duration),ne(o,he)}function m(){ne(n,null)}function v(te){const le=te.shiftKey?1:.1;if(te.key==="ArrowLeft"){if(te.preventDefault(),te.target===document.activeElement){const he=Math.max(0,x(l)-le);he<x(d)-.5&&(ne(l,he,!0),e.onchange(x(l),x(d)))}}else if(te.key==="ArrowRight"&&(te.preventDefault(),te.target===document.activeElement)){const he=Math.min(e.duration,x(d)+le);he>x(l)+.5&&(ne(d,he,!0),e.onchange(x(l),x(d)))}}const p=Ke(()=>x(l)/e.duration*100),b=Ke(()=>x(d)/e.duration*100),y=Ke(()=>x(d)-x(l));var _=Hp(),S=E(_);S.__mousemove=g,ct(S,"aria-valuemin",0),S.__keydown=v;var A=E(S);{var z=te=>{var le=Lp();yt(le,21,()=>x(i),Tt,(he,we)=>{var Ee=Vp();_e(()=>ct(Ee,"src",x(we))),W(he,Ee)}),C(le),W(te,le)},D=te=>{var le=Te(),he=pe(le);{var we=Ee=>{var Se=$p();W(Ee,Se)};ce(he,Ee=>{x(c)&&Ee(we)},!0)}W(te,le)};ce(A,te=>{x(i).length>0?te(z):te(D,!1)})}var M=R(A,2),$=R(M,2),K=R($,2),P=R(K,2);P.__mousedown=te=>u(te,"start");var O=R(P,2);O.__mousedown=te=>u(te,"end");var k=R(O,2);{var Q=te=>{var le=Wp(),he=E(le,!0);C(le),_e(we=>{ar(le,`left: ${x(o)??""}px`),ge(he,we)},[()=>xi(x(n))]),W(te,le)};ce(k,te=>{x(n)!==null&&!x(a)&&!x(s)&&te(Q)})}C(S),Fi(S,te=>ne(t,te),()=>x(t));var se=R(S,2),Y=E(se),be=R(E(Y),2),ee=E(be,!0);C(be),C(Y);var me=R(Y,2),q=R(E(me),2),V=E(q,!0);C(q),C(me);var ue=R(me,2),oe=R(E(ue),2),j=E(oe,!0);C(oe),C(ue),C(se),C(_),_e((te,le,he,we,Ee,Se,Xe)=>{ct(S,"aria-valuenow",te),ct(S,"aria-valuemax",le),ar(M,`width: ${x(p)??""}%`),ar($,`width: ${100-x(b)}%`),ar(K,`left: ${x(p)??""}%; right: ${100-x(b)}%`),Ge(P,1,`absolute bottom-0 top-0 z-10 flex w-3 cursor-ew-resize items-center justify-center bg-purple-500 transition-all ${x(a)?"ring-2 ring-purple-300":"hover:bg-purple-400"}`),ar(P,`left: ${x(p)??""}%; transform: translateX(-50%)`),ct(P,"aria-valuenow",he),Ge(O,1,`absolute bottom-0 top-0 z-10 flex w-3 cursor-ew-resize items-center justify-center bg-purple-500 transition-all ${x(s)?"ring-2 ring-purple-300":"hover:bg-purple-400"}`),ar(O,`left: ${x(b)??""}%; transform: translateX(-50%)`),ct(O,"aria-valuenow",we),ge(ee,Ee),ge(V,Se),ge(j,Xe)},[()=>Math.round(x(y)),()=>Math.round(e.duration),()=>Math.round(x(l)*10)/10,()=>Math.round(x(d)*10)/10,()=>xi(x(l)),()=>xi(x(y)),()=>xi(x(d))]),St("mouseleave",S,m),W(r,_),Xt()}Wt(["mousemove","keydown","mousedown"]);var qp=re('<span class="mt-1 text-xs text-white/60"> </span>'),Kp=re('<div class="absolute inset-0 flex flex-col items-center justify-center bg-black/60 backdrop-blur-sm"><!> <span class="text-sm font-medium text-white"> </span> <!></div>'),Gp=re('<button class="absolute inset-0 flex items-center justify-center bg-black/0 transition-colors hover:bg-black/30"><div class="flex h-12 w-12 items-center justify-center rounded-full bg-white/90 opacity-0 shadow-lg transition-opacity group-hover:opacity-100"><!></div></button>'),Qp=re('<div class="animate-confetti absolute h-1.5 w-1.5 rounded-full"></div>'),Xp=re('<div class="pointer-events-none absolute inset-0 overflow-visible"></div>'),Zp=re('<span class="flex items-center gap-1 rounded-full bg-green-500 px-2 py-1 text-xs font-bold text-white shadow-lg"><!> </span> <!>',1),Yp=re('<span class="rounded-full bg-amber-500 px-2 py-1 text-xs font-bold text-white shadow-lg"> </span>'),Jp=re('<div class="absolute right-2 top-2"><!></div>'),e0=re('<div class="absolute right-2 top-2"><span class="flex items-center gap-1 rounded-full bg-purple-500/80 px-2 py-1 text-xs font-medium text-white shadow-lg"><!> Trimmed</span></div>'),t0=re('<span class="text-purple-300"> </span>'),r0=re('<div class="absolute bottom-2 left-2 rounded bg-black/70 px-1.5 py-0.5 text-xs font-medium text-white"><!></div>'),i0=re('<div class="absolute bottom-2 right-2 rounded bg-black/70 px-1.5 py-0.5 text-xs font-medium text-white"> </div>'),a0=re('<div class="absolute left-2 top-2 flex items-center gap-1 rounded bg-black/70 px-1.5 py-0.5 text-xs font-medium text-white opacity-0 transition-opacity group-hover:opacity-100"><!> Drag to save</div>'),n0=re("<button><!> </button>"),s0=re('<button class="text-surface-500 mt-2 w-full rounded-lg py-1.5 text-xs transition-colors hover:bg-red-500/10 hover:text-red-400" aria-label="Clear trim">Reset to full duration</button>'),o0=re('<div class="mt-3"><!> <!></div>'),c0=re('<div class="flex items-center justify-between gap-2"><span class="text-surface-500 text-xs"> </span> <!></div> <!>',1),l0=re('<div class="bg-surface-700 h-1.5 w-full overflow-hidden rounded-full"><div class="from-accent-start to-accent-end h-full rounded-full bg-gradient-to-r transition-all duration-300"></div></div>'),d0=re('<span class="ml-auto text-[9px] text-purple-400">GPU</span>'),u0=re('<span class="text-surface-500 ml-auto text-[9px]">N/A</span>'),f0=re("<button><span></span> <span> </span> <!></button>"),h0=re('<button class="fixed inset-0 z-40" aria-label="Close"></button> <div class="bg-surface-800 absolute bottom-full left-0 z-50 mb-1 min-w-[100px] overflow-hidden rounded-lg shadow-xl ring-1 ring-white/10"></div>',1),m0=re('<div class="space-y-2"><div class="flex items-start gap-1.5 text-xs text-red-400"><!> <span class="break-words"> </span></div> <div class="flex items-center justify-between"><div class="relative"><button> <!></button> <!></div> <button class="flex items-center gap-1.5 rounded-lg bg-red-500/20 px-4 py-2.5 text-sm font-medium text-red-400 transition-colors hover:bg-red-500/30 sm:py-1.5 sm:text-xs"><!> Retry</button></div></div>'),p0=re('<span class="ml-auto text-[9px] text-purple-400">GPU</span>'),g0=re('<span class="text-surface-500 ml-auto text-[9px]">N/A</span>'),v0=re("<button><span></span> <span> </span> <!></button>"),b0=re('<button class="fixed inset-0 z-40" aria-label="Close"></button> <div class="bg-surface-800 absolute bottom-full left-0 z-50 mb-1 min-w-[100px] overflow-hidden rounded-lg shadow-xl ring-1 ring-white/10"></div>',1),w0=re('<span class="text-surface-500 text-[10px]"> </span>'),y0=re('<button class="text-surface-400 hover:bg-surface-700 hover:text-surface-200 flex h-10 w-10 items-center justify-center rounded-lg transition-all sm:h-7 sm:w-7 sm:rounded" title="Compare"><!></button>'),k0=re('<div class="flex items-center justify-between"><div class="flex items-center gap-1.5"><span class="text-surface-500 text-xs"> </span> <!> <div class="relative"><button title="Re-compress as different format"><span class="mr-0.5 hidden text-[9px] font-normal opacity-80 sm:inline">as</span> <!></button> <!></div> <span class="inline-flex items-center gap-0.5 rounded bg-purple-500/20 px-1.5 py-0.5 text-[10px] font-medium text-purple-400"><!> GPU</span> <!></div> <div class="flex items-center gap-1"><!> <button class="from-accent-start to-accent-end flex h-10 items-center gap-1.5 rounded-lg bg-gradient-to-r px-3 text-sm font-medium text-white transition-all hover:opacity-90 sm:h-7 sm:rounded sm:px-2.5 sm:text-xs"><!></button></div></div>'),x0=re('<div class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4" role="dialog" aria-modal="true" tabindex="-1"><button class="absolute right-4 top-4 z-10 rounded-full bg-white/10 p-3 text-white backdrop-blur-sm transition-colors hover:bg-white/20" aria-label="Close preview"><!></button> <video class="max-h-[85vh] max-w-[95vw] rounded-2xl shadow-2xl" controls autoplay></video></div>',2),_0=re('<div class="glass group relative overflow-hidden rounded-2xl transition-all duration-300 hover:shadow-xl hover:shadow-black/20"><button class="bg-surface-700 text-surface-400 absolute -right-2 -top-2 z-10 flex h-6 w-6 items-center justify-center rounded-full opacity-0 shadow-lg transition-all hover:bg-red-500 hover:text-white group-hover:opacity-100" aria-label="Remove video"><!></button> <div class="bg-surface-800 relative aspect-video w-full overflow-hidden rounded-t-2xl"><video class="h-full w-full object-cover" preload="metadata"></video> <!> <!> <!> <!> <!></div> <div class="p-3"><div class="mb-2 flex items-center justify-between gap-2"><p class="text-surface-200 truncate text-sm font-medium"> </p> <span class="text-surface-400 flex-shrink-0 font-mono text-xs"><!></span></div> <!></div></div> <!> <!>',3);function T0(r,e){Qt(e,!0);let t=We(!1),i=We(!1),a=We(!1),s=We(!1),n=We(""),o=We("");const c=Ke(()=>()=>No()?.supportedVideoCodecs.includes("av1")??!1),l=Ke(()=>()=>No()?.supportedVideoCodecs.includes("hevc")??!1),d=Ke(()=>e.item.compressedSize?Math.round((1-e.item.compressedSize/e.item.originalSize)*100):0),u=Ke(()=>x(d)>0),f=Ke(()=>e.item.status==="pending"?fu(e.item,de.settings):0),h=Ke(()=>ls(e.item)),g=Ke(()=>e.item.trimStart!==void 0||e.item.trimEnd!==void 0);Oi(()=>{x(s)&&e.item.duration&&(ne(n,xi(e.item.trimStart||0),!0),ne(o,xi(e.item.trimEnd??e.item.duration),!0))});const m=[{value:"mp4",label:"MP4",color:"from-orange-500 to-red-500"},{value:"webm",label:"WebM",color:"from-green-500 to-emerald-500"},{value:"hevc",label:"HEVC",color:"from-blue-500 to-cyan-500"},{value:"av1",label:"AV1",color:"from-purple-500 to-pink-500"}];function v(){de.updateItem(e.item.id,{trimStart:void 0,trimEnd:void 0}),ne(s,!1)}function p(L){if(!e.item.compressedBlob||!e.item.compressedUrl)return;const H=Bs(e.item.name,e.item.outputFormat),U=e.item.outputFormat==="webm"?"video/webm":"video/mp4";L.dataTransfer?.setData("DownloadURL",`${U}:${H}:${e.item.compressedUrl}`),L.dataTransfer?.setData("text/plain",e.item.compressedUrl),L.dataTransfer&&(L.dataTransfer.effectAllowed="copy")}function b(){de.removeItem(e.item.id)}function y(){Dp(e.item)}async function _(L){ne(t,!1),L!==e.item.outputFormat&&(Sa.info(`Re-compressing as ${L.toUpperCase()}...`),de.updateItem(e.item.id,{outputFormat:L}),await Oo(e.item.id))}async function S(){await Oo(e.item.id)}function A(){return m.find(H=>H.value===e.item.outputFormat)?.color||"from-gray-500 to-gray-600"}var z=_0(),D=pe(z),M=E(D);M.__click=b;var $=E(M);kr($,{class:"h-3.5 w-3.5"}),C(M);var K=R(M,2),P=E(K);P.muted=!0;var O=R(P,2);{var k=L=>{var H=Kp(),U=E(H);Rd(U,{class:"mb-2 h-8 w-8 animate-spin text-white"});var Z=R(U,2),ie=E(Z);C(Z);var G=R(Z,2);{var ae=ye=>{var ke=qp(),Ie=E(ke,!0);C(ke),_e(()=>ge(Ie,e.item.progressStage)),W(ye,ke)};ce(G,ye=>{e.item.progressStage&&ye(ae)})}C(H),_e(()=>ge(ie,`${e.item.progress??""}%`)),W(L,H)},Q=L=>{var H=Gp();H.__click=()=>ne(i,!0);var U=E(H),Z=E(U);ss(Z,{class:"text-surface-800 ml-0.5 h-5 w-5",fill:"currentColor"}),C(U),C(H),W(L,H)};ce(O,L=>{e.item.status==="processing"?L(k):L(Q,!1)})}var se=R(O,2);{var Y=L=>{var H=Jp(),U=E(H);{var Z=G=>{var ae=Zp(),ye=pe(ae),ke=E(ye);ea(ke,{class:"h-3 w-3"});var Ie=R(ke);C(ye);var Fe=R(ye,2);{var Oe=Qe=>{var Re=Xp();yt(Re,20,()=>Array(12),Tt,(tt,ht,it)=>{var pt=Qp();_e(()=>ar(pt,`
										background: ${["#f97316","#eab308","#22c55e","#8b5cf6","#ec4899"][it%5]??""};
										left: ${50+(Math.random()-.5)*60}%;
										top: 50%;
										animation-delay: ${Math.random()*.4}s;
									`)),W(tt,pt)}),C(Re),W(Qe,Re)};ce(Fe,Qe=>{x(d)>50&&Qe(Oe)})}_e(()=>ge(Ie,` -${x(d)??""}%`)),W(G,ae)},ie=G=>{var ae=Yp(),ye=E(ae);C(ae),_e(ke=>ge(ye,`+${ke??""}%`),[()=>Math.abs(x(d))]),W(G,ae)};ce(U,G=>{x(u)?G(Z):G(ie,!1)})}C(H),W(L,H)},be=L=>{var H=Te(),U=pe(H);{var Z=ie=>{var G=e0(),ae=E(G),ye=E(ae);js(ye,{class:"h-3 w-3"}),Me(),C(ae),C(G),W(ie,G)};ce(U,ie=>{e.item.status==="pending"&&x(g)&&ie(Z)},!0)}W(L,H)};ce(se,L=>{e.item.status==="completed"?L(Y):L(be,!1)})}var ee=R(se,2);{var me=L=>{var H=r0(),U=E(H);{var Z=G=>{var ae=t0(),ye=E(ae,!0);C(ae),_e(ke=>ge(ye,ke),[()=>Sn(x(h))]),W(G,ae)},ie=G=>{var ae=yr();_e(ye=>ge(ae,ye),[()=>Sn(e.item.duration)]),W(G,ae)};ce(U,G=>{x(g)?G(Z):G(ie,!1)})}C(H),W(L,H)};ce(ee,L=>{e.item.duration&&L(me)})}var q=R(ee,2);{var V=L=>{var H=i0(),U=E(H);C(H),_e(()=>ge(U,`${e.item.width??""}Ã—${e.item.height??""}`)),W(L,H)};ce(q,L=>{e.item.width&&e.item.height&&L(V)})}var ue=R(q,2);{var oe=L=>{var H=a0(),U=E(H);Ad(U,{class:"h-3 w-3"}),Me(),C(H),W(L,H)};ce(ue,L=>{e.item.status==="completed"&&e.item.compressedBlob&&L(oe)})}C(K);var j=R(K,2),te=E(j),le=E(te),he=E(le,!0);C(le);var we=R(le,2),Ee=E(we);{var Se=L=>{var H=yr();_e(U=>ge(H,U),[()=>Mn(e.item.compressedSize)]),W(L,H)},Xe=L=>{var H=Te(),U=pe(H);{var Z=ie=>{var G=yr();_e(ae=>ge(G,`~${ae??""}`),[()=>Mn(x(f))]),W(ie,G)};ce(U,ie=>{x(f)>0&&ie(Z)},!0)}W(L,H)};ce(Ee,L=>{e.item.status==="completed"&&e.item.compressedSize?L(Se):L(Xe,!1)})}C(we),C(te);var at=R(te,2);{var w=L=>{var H=c0(),U=pe(H),Z=E(U),ie=E(Z);C(Z);var G=R(Z,2);{var ae=Ie=>{var Fe=n0();Fe.__click=()=>ne(s,!x(s));var Oe=E(Fe);js(Oe,{class:"h-3.5 w-3.5 sm:h-3 sm:w-3"});var Qe=R(Oe);C(Fe),_e(Re=>{Ge(Fe,1,`flex items-center gap-1.5 rounded-lg px-3 py-2 text-sm font-medium transition-all sm:py-1 sm:text-xs ${x(s)||x(g)?"bg-purple-500/20 text-purple-400":"text-surface-500 hover:text-surface-300 hover:bg-surface-700/50"}`),ge(Qe,` ${Re??""}`)},[()=>x(g)?Sn(x(h)):"Trim"]),W(Ie,Fe)};ce(G,Ie=>{e.item.duration&&Ie(ae)})}C(U);var ye=R(U,2);{var ke=Ie=>{var Fe=o0(),Oe=E(Fe);{let tt=Ke(()=>e.item.trimStart||0),ht=Ke(()=>e.item.trimEnd??e.item.duration);jp(Oe,{get videoUrl(){return e.item.originalUrl},get duration(){return e.item.duration},get trimStart(){return x(tt)},get trimEnd(){return x(ht)},onchange:(it,pt)=>{de.updateItem(e.item.id,{trimStart:it>0?it:void 0,trimEnd:pt<e.item.duration?pt:void 0})}})}var Qe=R(Oe,2);{var Re=tt=>{var ht=s0();ht.__click=v,W(tt,ht)};ce(Qe,tt=>{x(g)&&tt(Re)})}C(Fe),ft(3,Fe,()=>Ba,()=>({duration:200})),W(Ie,Fe)};ce(ye,Ie=>{x(s)&&e.item.duration&&Ie(ke)})}_e((Ie,Fe)=>ge(ie,`${Ie??""} â†’ ${Fe??""}`),[()=>e.item.format?.toUpperCase(),()=>e.item.outputFormat.toUpperCase()]),W(L,H)},J=L=>{var H=Te(),U=pe(H);{var Z=G=>{var ae=l0(),ye=E(ae);C(ae),_e(()=>ar(ye,`width: ${e.item.progress??""}%`)),W(G,ae)},ie=G=>{var ae=Te(),ye=pe(ae);{var ke=Fe=>{var Oe=m0(),Qe=E(Oe),Re=E(Qe);Yo(Re,{class:"mt-0.5 h-3.5 w-3.5 flex-shrink-0"});var tt=R(Re,2),ht=E(tt,!0);C(tt),C(Qe);var it=R(Qe,2),pt=E(it),Ht=E(pt);Ht.__click=()=>ne(t,!x(t));var Yt=E(Ht),Be=R(Yt);Fa(Be,{class:"h-3 w-3"}),C(Ht);var Ae=R(Ht,2);{var He=Je=>{var ut=h0(),rr=pe(ut);rr.__click=()=>ne(t,!1);var jt=R(rr,2);yt(jt,21,()=>m,Tt,(dr,xt)=>{const zt=Ke(()=>x(xt).value==="av1"&&!x(c)()||x(xt).value==="hevc"&&!x(l)()),_t=Ke(()=>x(xt).value==="av1"||x(xt).value==="hevc"),Pt=Ke(()=>x(xt).value==="av1"&&x(c)()||x(xt).value==="hevc"&&x(l)());var Et=f0();Et.__click=()=>!x(zt)&&_(x(xt).value);var gt=E(Et),vt=R(gt,2),ir=E(vt,!0);C(vt);var Ze=R(vt,2);{var et=je=>{var st=d0();W(je,st)},$e=je=>{var st=Te(),nt=pe(st);{var ot=It=>{var Lt=u0();W(It,Lt)};ce(nt,It=>{x(_t)&&x(zt)&&It(ot)},!0)}W(je,st)};ce(Ze,je=>{x(_t)&&x(Pt)?je(et):je($e,!1)})}C(Et),_e(()=>{Et.disabled=x(zt),Ge(Et,1,`flex w-full items-center gap-2 px-3 py-2 text-xs transition-colors ${x(zt)?"cursor-not-allowed opacity-40":"hover:bg-surface-700"} ${e.item.outputFormat===x(xt).value?"bg-surface-700/50":""}`),ct(Et,"title",x(zt)?`${x(xt).label} not available on this device`:""),Ge(gt,1,`h-2 w-2 rounded-full bg-gradient-to-r ${x(xt).color??""} ${x(zt)?"opacity-50":""}`),Ge(vt,1,`font-medium ${x(zt)?"text-surface-500 line-through":"text-surface-300"}`),ge(ir,x(xt).label)}),W(dr,Et)}),C(jt),ft(3,jt,()=>Si,()=>({duration:100,start:.95})),W(Je,ut)};ce(Ae,Je=>{x(t)&&Je(He)})}C(pt);var dt=R(pt,2);dt.__click=S;var Nt=E(dt);Nd(Nt,{class:"h-4 w-4 sm:h-3 sm:w-3"}),Me(),C(dt),C(it),C(Oe),_e((Je,ut)=>{ge(ht,e.item.error||"Compression failed"),Ge(Ht,1,`flex items-center gap-1 rounded bg-gradient-to-r ${Je??""} px-2 py-0.5 text-xs font-bold uppercase text-white transition-all hover:opacity-90`),ge(Yt,`${ut??""} `)},[A,()=>e.item.outputFormat.toUpperCase()]),W(Fe,Oe)},Ie=Fe=>{var Oe=Te(),Qe=pe(Oe);{var Re=tt=>{var ht=k0(),it=E(ht),pt=E(it),Ht=E(pt,!0);C(pt);var Yt=R(pt,2);In(Yt,{class:"text-surface-600 h-3 w-3"});var Be=R(Yt,2),Ae=E(Be);Ae.__click=()=>ne(t,!x(t));var He=R(E(Ae)),dt=R(He);Fa(dt,{class:"h-3 w-3"}),C(Ae);var Nt=R(Ae,2);{var Je=gt=>{var vt=b0(),ir=pe(vt);ir.__click=()=>ne(t,!1);var Ze=R(ir,2);yt(Ze,21,()=>m,Tt,(et,$e)=>{const je=Ke(()=>x($e).value==="av1"&&!x(c)()||x($e).value==="hevc"&&!x(l)()),st=Ke(()=>x($e).value==="av1"||x($e).value==="hevc"),nt=Ke(()=>x($e).value==="av1"&&x(c)()||x($e).value==="hevc"&&x(l)());var ot=v0();ot.__click=()=>!x(je)&&_(x($e).value);var It=E(ot),Lt=R(It,2),Kr=E(Lt,!0);C(Lt);var _r=R(Lt,2);{var Gr=oi=>{var va=p0();W(oi,va)},ga=oi=>{var va=Te(),Cl=pe(va);{var Pl=Qa=>{var El=g0();W(Qa,El)};ce(Cl,Qa=>{x(st)&&x(je)&&Qa(Pl)},!0)}W(oi,va)};ce(_r,oi=>{x(st)&&x(nt)?oi(Gr):oi(ga,!1)})}C(ot),_e(()=>{ot.disabled=x(je),Ge(ot,1,`flex w-full items-center gap-2 px-3 py-2 text-xs transition-colors ${x(je)?"cursor-not-allowed opacity-40":"hover:bg-surface-700"} ${e.item.outputFormat===x($e).value?"bg-surface-700/50":""}`),ct(ot,"title",x(je)?`${x($e).label} not available on this device`:""),Ge(It,1,`h-2 w-2 rounded-full bg-gradient-to-r ${x($e).color??""} ${x(je)?"opacity-50":""}`),Ge(Lt,1,`font-medium ${x(je)?"text-surface-500 line-through":"text-surface-300"}`),ge(Kr,x($e).label)}),W(et,ot)}),C(Ze),ft(3,Ze,()=>Si,()=>({duration:100,start:.95})),W(gt,vt)};ce(Nt,gt=>{x(t)&&gt(Je)})}C(Be);var ut=R(Be,2),rr=E(ut);Fn(rr,{class:"h-2.5 w-2.5"}),Me(),C(ut);var jt=R(ut,2);{var dr=gt=>{var vt=w0(),ir=E(vt);C(vt),_e(Ze=>ge(ir,`${Ze??""}s`),[()=>(e.item.compressionDuration/1e3).toFixed(1)]),W(gt,vt)};ce(jt,gt=>{e.item.compressionDuration&&gt(dr)})}C(it);var xt=R(it,2),zt=E(xt);{var _t=gt=>{var vt=y0();vt.__click=()=>ne(a,!0);var ir=E(vt);Ud(ir,{class:"h-4 w-4 sm:h-3.5 sm:w-3.5"}),C(vt),W(gt,vt)};ce(zt,gt=>{e.item.compressedUrl&&gt(_t)})}var Pt=R(zt,2);Pt.__click=y;var Et=E(Pt);za(Et,{class:"h-4 w-4 sm:h-3.5 sm:w-3.5"}),C(Pt),C(xt),C(ht),_e((gt,vt)=>{ge(Ht,e.item.format),Ge(Ae,1,`flex items-center gap-1 rounded bg-gradient-to-r ${gt??""} px-2 py-0.5 text-xs font-bold uppercase text-white transition-all hover:opacity-90`),ge(He,` ${vt??""} `)},[A,()=>e.item.outputFormat.toUpperCase()]),W(tt,ht)};ce(Qe,tt=>{e.item.status==="completed"&&tt(Re)},!0)}W(Fe,Oe)};ce(ye,Fe=>{e.item.status==="error"?Fe(ke):Fe(Ie,!1)},!0)}W(G,ae)};ce(U,G=>{e.item.status==="processing"?G(Z):G(ie,!1)},!0)}W(L,H)};ce(at,L=>{e.item.status==="pending"?L(w):L(J,!1)})}C(j),C(D);var X=R(D,2);{var F=L=>{var H=x0();H.__click=()=>ne(i,!1),H.__keydown=G=>G.key==="Escape"&&ne(i,!1);var U=E(H);U.__click=()=>ne(i,!1);var Z=E(U);kr(Z,{class:"h-6 w-6"}),C(U);var ie=R(U,2);ie.__click=G=>G.stopPropagation(),C(H),_e(()=>ct(ie,"src",e.item.compressedUrl||e.item.originalUrl)),ft(3,H,()=>Gt,()=>({duration:150})),W(L,H)};ce(X,L=>{x(i)&&L(F)})}var T=R(X,2);{var B=L=>{Up(L,{get originalUrl(){return e.item.originalUrl},get compressedUrl(){return e.item.compressedUrl},get originalSize(){return e.item.originalSize},get compressedSize(){return e.item.compressedSize},onclose:()=>ne(a,!1)})};ce(T,L=>{x(a)&&e.item.compressedUrl&&e.item.compressedSize&&L(B)})}_e(()=>{ct(D,"draggable",e.item.status==="completed"&&!!e.item.compressedBlob),ct(D,"role",e.item.status==="completed"&&e.item.compressedBlob?"listitem":void 0),ct(P,"src",e.item.compressedUrl||e.item.originalUrl),ct(le,"title",e.item.name),ge(he,e.item.name)}),St("dragstart",D,p),ft(1,D,()=>Si,()=>({duration:200,start:.95})),ft(2,D,()=>Gt,()=>({duration:150})),W(r,z),Xt()}Wt(["click","keydown"]);function S0(r){const e=r-1;return e*e*e+1}function C0(r,{from:e,to:t},i={}){var{delay:a=0,duration:s=A=>Math.sqrt(A)*120,easing:n=S0}=i,o=getComputedStyle(r),c=o.transform==="none"?"":o.transform,[l,d]=o.transformOrigin.split(" ").map(parseFloat);l/=r.clientWidth,d/=r.clientHeight;var u=P0(r),f=r.clientWidth/t.width/u,h=r.clientHeight/t.height/u,g=e.left+e.width*l,m=e.top+e.height*d,v=t.left+t.width*l,p=t.top+t.height*d,b=(g-v)*f,y=(m-p)*h,_=e.width/t.width,S=e.height/t.height;return{delay:a,duration:typeof s=="function"?s(Math.sqrt(b*b+y*y)):s,easing:n,css:(A,z)=>{var D=z*b,M=z*y,$=A+z*_,K=A+z*S;return`transform: ${c} translate(${D}px, ${M}px) scale(${$}, ${K});`}}}function P0(r){if("currentCSSZoom"in r)return r.currentCSSZoom;for(var e=r,t=1;e!==null;)t*=+getComputedStyle(e).zoom,e=e.parentElement;return t}var E0=re('<div class="bg-accent-start absolute -top-2 left-0 right-0 h-1 rounded-full"></div>'),I0=re('<div class="bg-surface-700 text-surface-300 ring-surface-900 absolute -left-1 -top-1 flex h-6 w-6 items-center justify-center rounded-full text-xs font-bold ring-2"> </div>'),A0=re('<div role="listitem" aria-label="Video item, drag to reorder"><!> <!> <!></div>'),F0=re('<div class="mt-6 sm:mt-8"><div class="mb-4 flex items-center justify-between"><h2 class="text-surface-200 text-lg font-semibold">Videos <span class="text-surface-500 font-normal"> </span></h2> <p class="text-surface-500 text-xs">Drag to reorder â€¢ Processing order: top to bottom</p></div> <div class="grid gap-4 sm:grid-cols-2 sm:gap-6 lg:grid-cols-3 xl:grid-cols-4"></div></div>');function z0(r,e){Qt(e,!0);let t=We(null),i=We(null);function a(y,_,S){ne(t,_,!0),y.dataTransfer&&(y.dataTransfer.effectAllowed="move",y.dataTransfer.setData("text/plain",_.id)),setTimeout(()=>{y.target.classList.add("opacity-50","scale-95")},0)}function s(y){ne(t,null),ne(i,null),y.target.classList.remove("opacity-50","scale-95")}function n(y,_){y.preventDefault(),x(t)&&(y.dataTransfer&&(y.dataTransfer.dropEffect="move"),ne(i,_,!0))}function o(){ne(i,null)}function c(y,_){if(y.preventDefault(),!x(t))return;const S=de.items.findIndex(A=>A.id===x(t).id);S!==-1&&S!==_&&de.reorderItems(S,_),ne(t,null),ne(i,null)}let l=null;function d(y,_){y.touches[0].clientY,l=_}function u(y){}function f(){l=null}var h=F0(),g=E(h),m=E(g),v=R(E(m)),p=E(v);C(v),C(m),Me(2),C(g);var b=R(g,2);yt(b,31,()=>de.items,y=>y.id,(y,_,S)=>{var A=A0();A.__touchstart=P=>d(P,x(_)),A.__touchmove=u,A.__touchend=f;var z=E(A);{var D=P=>{var O=E0();ft(3,O,()=>Gt,()=>({duration:150})),W(P,O)};ce(z,P=>{x(i)===x(S)&&x(t)?.id!==x(_).id&&P(D)})}var M=R(z,2);T0(M,{get item(){return x(_)}});var $=R(M,2);{var K=P=>{var O=I0(),k=E(O,!0);C(O),_e(()=>ge(k,x(S)+1)),W(P,O)};ce($,P=>{x(_).status==="pending"&&P(K)})}C(A),_e(()=>{Ge(A,1,`relative transition-transform duration-200 ${x(i)===x(S)&&x(t)?.id!==x(_).id?"translate-y-2 opacity-70":""}`),ct(A,"draggable",x(_).status!=="processing")}),St("dragstart",A,P=>a(P,x(_),x(S))),St("dragend",A,s),St("dragover",A,P=>n(P,x(S))),St("dragleave",A,o),St("drop",A,P=>c(P,x(S))),gd(A,()=>C0,()=>({duration:300})),W(y,A)}),C(b),C(h),_e(()=>ge(p,`(${de.items.length??""})`)),W(r,h),Xt()}Wt(["touchstart","touchmove","touchend"]);var B0=re('<div class="bg-surface-800 text-surface-200 absolute bottom-full left-1/2 z-50 mb-2 w-64 -translate-x-1/2 rounded-lg p-3 text-left text-sm font-normal shadow-xl ring-1 ring-white/10" role="tooltip"> <div class="border-t-surface-800 absolute left-1/2 top-full -mt-1 -translate-x-1/2 border-4 border-transparent"></div></div>'),M0=re('<button type="button" class="text-surface-500 hover:text-surface-300 relative ml-1 transition-colors" aria-label="More information"><!> <!></button>');function Cn(r,e){let t=We(!1);var i=M0(),a=E(i);ns(a,{class:"h-4 w-4"});var s=R(a,2);{var n=o=>{var c=B0(),l=E(c);Me(),C(c),_e(()=>ge(l,`${e.content??""} `)),ft(3,c,()=>Gt,()=>({duration:100})),W(o,c)};ce(s,o=>{x(t)&&o(n)})}C(i),St("mouseenter",i,()=>ne(t,!0)),St("mouseleave",i,()=>ne(t,!1)),St("focus",i,()=>ne(t,!0)),St("blur",i,()=>ne(t,!1)),W(r,i)}var R0=re("<button> </button>"),D0=re('<button><span class="text-base"> </span> <span class="flex-1 text-left"> </span> <span class="text-surface-500 text-xs"> </span></button>'),N0=re('<div class="border-surface-700/50 border-t p-2"><button class="text-surface-500 hover:text-surface-300 w-full px-3 py-1.5 text-xs transition-colors">Clear target size</button></div>'),O0=re('<button class="fixed inset-0 z-40" aria-label="Close"></button> <div class="bg-surface-800 absolute left-0 top-full z-50 mt-2 w-48 overflow-hidden rounded-xl shadow-xl ring-1 ring-white/10"><div class="border-surface-700/50 border-b p-3"><div class="flex items-center gap-2"><input type="text" class="bg-surface-700 border-surface-600 text-surface-200 placeholder-surface-500 focus:ring-accent-start focus:border-accent-start flex-1 rounded-lg border px-3 py-1.5 text-sm focus:outline-none focus:ring-1" placeholder="Custom MB"/> <button class="bg-accent-start hover:bg-accent-start/80 rounded-lg px-2 py-1.5 text-xs font-medium text-white">Set</button></div></div> <div class="p-1.5"></div> <!></div>',1),U0=re('<p class="text-accent-start hidden self-center text-xs sm:block"> </p>'),V0=re('<span class="absolute -right-1.5 -top-1.5 rounded bg-purple-500 px-1 py-0.5 text-[9px] font-bold text-white">GPU</span>'),L0=re('<span class="bg-surface-600 text-surface-400 absolute -right-1.5 -top-1.5 rounded px-1 py-0.5 text-[9px] font-bold">N/A</span>'),$0=re("<button> <!></button>"),W0=re("<!> <span>Compressing...</span>",1),H0=re("<!> <span> </span>",1),j0=re('<button class="from-accent-start to-accent-end shadow-accent-start/30 hover:shadow-accent-start/40 flex items-center gap-2 rounded-xl bg-gradient-to-r px-5 py-3 text-sm font-semibold text-white shadow-lg transition-all hover:scale-105 hover:shadow-xl disabled:opacity-50 disabled:hover:scale-100 sm:py-2"><!></button>'),q0=re('<button class="bg-surface-700 text-surface-300 hover:bg-surface-600 flex items-center gap-2 rounded-xl px-4 py-2.5 text-sm font-medium transition-all disabled:opacity-50 sm:py-2"><!> <span class="hidden sm:inline"> </span></button>'),K0=re('<div class="text-xs opacity-70"> </div>'),G0=re('<button><div class="font-medium"> </div> <!></button>'),Q0=re('<button><div class="font-medium"> </div> <div class="text-xs opacity-70"> </div></button>'),X0=re("<button> </button>"),Z0=re('<div class="mt-3"><span class="text-surface-500 mb-2 block text-xs">Bitrate</span> <div class="flex gap-1"></div></div>'),Y0=re("<div></div>"),J0=re('<button><div class="text-left"><div class="font-medium"> </div> <div class="text-xs opacity-70"> </div></div> <div class="flex gap-0.5"></div></button>'),eg=re('<span class="text-amber-500">(N/A for WebM)</span>'),tg=re('<div class="border-surface-700/50 bg-surface-900/50 border-t p-4 sm:p-6"><div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-4"><div><div class="mb-3 flex items-center gap-2"><!> <span class="text-surface-300 text-sm font-medium">Resolution</span> <!></div> <div class="grid grid-cols-2 gap-1.5"></div></div> <div><div class="mb-3 flex items-center gap-2"><!> <span class="text-surface-300 text-sm font-medium">Audio Codec</span> <!></div> <div class="grid grid-cols-2 gap-1.5"></div> <!></div> <div><div class="mb-3 flex items-center gap-2"><!> <span class="text-surface-300 text-sm font-medium">Encoding Speed</span> <!></div> <div class="space-y-1.5"></div></div> <div><div class="mb-3 flex items-center gap-2"><!> <span class="text-surface-300 text-sm font-medium">Options</span></div> <div class="space-y-3"><label class="group flex cursor-pointer items-center gap-3"><input type="checkbox" class="bg-surface-700 border-surface-600 text-accent-start focus:ring-accent-start focus:ring-offset-surface-900 h-5 w-5 rounded"/> <div><div class="text-surface-300 group-hover:text-surface-100 text-sm font-medium transition-colors">Remove Location Data</div> <div class="text-surface-500 text-xs">Strip GPS, camera info, and metadata</div></div></label> <label class="group flex cursor-pointer items-center gap-3"><input type="checkbox" class="bg-surface-700 border-surface-600 text-accent-start focus:ring-accent-start focus:ring-offset-surface-900 h-5 w-5 rounded"/> <div><div>Two-Pass Encoding</div> <div class="text-surface-500 text-xs">Better quality, ~2x slower <!></div></div></label></div> <div class="bg-surface-800/50 border-surface-700/50 mt-4 rounded-lg border p-3"><div class="flex items-start gap-2"><!> <p class="text-surface-500 text-xs"><!></p></div></div></div></div></div>'),rg=re('<div class="glass mb-6 overflow-hidden rounded-2xl sm:mb-8"><div class="p-4 sm:p-6"><div class="flex flex-wrap items-center gap-3 sm:gap-4"><div class="flex flex-col gap-1.5"><span class="text-surface-500 hidden text-[10px] uppercase tracking-wider sm:block">Quality</span> <div class="flex gap-1"></div></div> <div class="text-surface-600 hidden items-center gap-2 self-center sm:flex"><div class="bg-surface-700 h-8 w-px"></div> <span class="text-xs font-medium">or</span> <div class="bg-surface-700 h-8 w-px"></div></div> <div class="flex flex-col gap-1.5"><span class="text-surface-500 hidden text-[10px] uppercase tracking-wider sm:block">Target Size</span> <div class="relative"><button> <!></button> <!></div></div> <!> <div class="bg-surface-700/50 hidden h-5 w-px sm:block"></div> <div class="flex gap-1"></div> <div class="flex-1"></div> <button class="text-surface-400 hover:text-surface-200 flex items-center gap-1.5 px-3 py-2.5 text-sm font-medium transition-colors sm:py-1.5"><!> <span class="hidden sm:inline">Advanced</span> <!></button> <!></div></div> <!></div>');function ig(r,e){Qt(e,!0);let t=We(!1),i=We(!1);ua(async()=>{const T=await pa();ne(t,T.supportedVideoCodecs.includes("av1"),!0),ne(i,T.supportedVideoCodecs.includes("hevc"),!0)});const a=[{value:"mp4",label:"MP4",desc:"H.264 â€¢ Universal compatibility"},{value:"webm",label:"WebM",desc:"VP9 â€¢ Modern browsers"},{value:"hevc",label:"HEVC",desc:"H.265 â€¢ Better compression",requiresHardware:!0},{value:"av1",label:"AV1",desc:"Best compression â€¢ Newest",requiresHardware:!0}],s=[{value:"aac",label:"AAC",desc:"Standard"},{value:"opus",label:"Opus",desc:"Modern"},{value:"mp3",label:"MP3",desc:"Legacy"},{value:"copy",label:"Keep Original",desc:"No re-encode"},{value:"none",label:"None",desc:"Remove audio"}],n=[{value:"veryfast",label:"Fast",speed:4,desc:"Quick encoding, slightly larger files"},{value:"medium",label:"Balanced",speed:2,desc:"Good balance of speed and quality"},{value:"slow",label:"Quality",speed:0,desc:"Best quality, slower encoding"}],o=Object.entries(Wa).map(([T,B])=>({key:T,...B})),c=Object.entries(su).map(([T,B])=>({key:T,...B}));let l=We(!1),d=We(!1),u=We(""),f=We(!1);const h=Ke(()=>de.items.filter(T=>T.status==="pending")),g=Ke(()=>x(h).length>0),m=Ke(()=>de.items.some(T=>T.status==="completed")),v=Ke(()=>de.items.some(T=>T.status==="processing")),p=Ke(()=>de.settings.targetSizeMB!==void 0);Oi(()=>{de.settings.targetSizeMB!==void 0&&ne(u,de.settings.targetSizeMB.toString(),!0)});function b(T){de.updateSettings({quality:T,targetSizeMB:void 0}),ne(u,""),ne(f,!1)}function y(T){de.updateSettings({outputFormat:T})}function _(){const T=parseFloat(x(u));!isNaN(T)&&T>0?de.updateSettings({targetSizeMB:T}):de.updateSettings({targetSizeMB:void 0})}function S(T){de.updateSettings({targetSizeMB:T}),ne(u,T.toString(),!0),ne(f,!1)}function A(){de.updateSettings({targetSizeMB:void 0}),ne(u,"")}function z(T){de.updateSettings({resolution:T})}function D(T){de.updateSettings({audioCodec:T})}function M(T){de.updateSettings({audioBitrate:T})}function $(T){de.updateSettings({preset:T})}async function K(){x(g)&&(ne(d,!0),await Ip(x(h).map(T=>T.id)),ne(d,!1))}async function P(){ne(d,!0),await Bp(),ne(d,!1)}var O=rg(),k=E(O),Q=E(k),se=E(Q),Y=R(E(se),2);yt(Y,21,()=>o,Tt,(T,B)=>{var L=R0();L.__click=()=>b(x(B).key);var H=E(L,!0);C(L),_e(()=>{Ge(L,1,`rounded-lg px-3 py-2.5 text-sm font-medium transition-all sm:py-1.5 ${de.settings.quality===x(B).key&&!x(p)?"bg-accent-start shadow-accent-start/30 text-white shadow-md":x(p)?"text-surface-500 hover:text-surface-400 hover:bg-surface-700/30":"text-surface-400 hover:text-surface-200 hover:bg-surface-700/50"}`),ct(L,"title",x(B).desc),ge(H,x(B).label)}),W(T,L)}),C(Y),C(se);var be=R(se,4),ee=R(E(be),2),me=E(ee);me.__click=()=>ne(f,!x(f));var q=E(me),V=R(q);Fa(V,{class:"h-3.5 w-3.5"}),C(me);var ue=R(me,2);{var oe=T=>{var B=O0(),L=pe(B);L.__click=()=>ne(f,!1);var H=R(L,2),U=E(H),Z=E(U),ie=E(Z);Ta(ie),ie.__keydown=Ie=>{Ie.key==="Enter"&&(_(),ne(f,!1))};var G=R(ie,2);G.__click=()=>{_(),ne(f,!1)},C(Z),C(U);var ae=R(U,2);yt(ae,21,()=>c,Tt,(Ie,Fe)=>{var Oe=D0();Oe.__click=()=>S(x(Fe).sizeMB);var Qe=E(Oe),Re=E(Qe,!0);C(Qe);var tt=R(Qe,2),ht=E(tt,!0);C(tt);var it=R(tt,2),pt=E(it);C(it),C(Oe),_e(()=>{Ge(Oe,1,`flex w-full items-center gap-3 rounded-lg px-3 py-2 text-sm transition-all ${de.settings.targetSizeMB===x(Fe).sizeMB?"bg-accent-start/20 text-accent-start":"text-surface-300 hover:bg-surface-700"}`),ge(Re,x(Fe).icon),ge(ht,x(Fe).label),ge(pt,`${x(Fe).sizeMB??""} MB`)}),W(Ie,Oe)}),C(ae);var ye=R(ae,2);{var ke=Ie=>{var Fe=N0(),Oe=E(Fe);Oe.__click=A,C(Fe),W(Ie,Fe)};ce(ye,Ie=>{x(p)&&Ie(ke)})}C(H),bd(ie,()=>x(u),Ie=>ne(u,Ie)),ft(3,H,()=>Ba,()=>({duration:150})),W(T,B)};ce(ue,T=>{x(f)&&T(oe)})}C(ee),C(be);var j=R(be,2);{var te=T=>{var B=U0(),L=E(B);C(B),_e(()=>ge(L,`â†’ Compressing to ${de.settings.targetSizeMB??""} MB`)),W(T,B)};ce(j,T=>{x(p)&&T(te)})}var le=R(j,4);yt(le,21,()=>a,Tt,(T,B)=>{const L=Ke(()=>x(B).value==="av1"&&!x(t)||x(B).value==="hevc"&&!x(i)),H=Ke(()=>x(B).value==="av1"||x(B).value==="hevc"),U=Ke(()=>x(B).value==="av1"&&x(t)||x(B).value==="hevc"&&x(i));var Z=$0();Z.__click=()=>!x(L)&&y(x(B).value);var ie=E(Z),G=R(ie);{var ae=ke=>{var Ie=V0();W(ke,Ie)},ye=ke=>{var Ie=Te(),Fe=pe(Ie);{var Oe=Qe=>{var Re=L0();W(Qe,Re)};ce(Fe,Qe=>{x(H)&&x(L)&&Qe(Oe)},!0)}W(ke,Ie)};ce(G,ke=>{x(H)&&x(U)?ke(ae):ke(ye,!1)})}C(Z),_e(()=>{Z.disabled=x(L),Ge(Z,1,`relative rounded-lg px-3 py-2.5 text-sm font-medium transition-all sm:py-1.5 ${de.settings.outputFormat===x(B).value?"bg-accent-start shadow-accent-start/30 text-white shadow-md":x(L)?"text-surface-600 cursor-not-allowed line-through opacity-40":"text-surface-400 hover:text-surface-200 hover:bg-surface-700/50"}`),ct(Z,"title",x(L)?`${x(B).label} requires hardware encoder (not available on this device)`:x(B).desc),ge(ie,`${x(B).label??""} `)}),W(T,Z)}),C(le);var he=R(le,4);he.__click=()=>ne(l,!x(l));var we=E(he);Ks(we,{class:"h-4 w-4"});var Ee=R(we,4);{var Se=T=>{Td(T,{class:"h-3.5 w-3.5"})},Xe=T=>{Fa(T,{class:"h-3.5 w-3.5"})};ce(Ee,T=>{x(l)?T(Se):T(Xe,!1)})}C(he);var at=R(he,2);{var w=T=>{var B=j0();B.__click=K;var L=E(B);{var H=Z=>{var ie=W0(),G=pe(ie);Hs(G,{class:"h-4 w-4 animate-spin"}),Me(2),W(Z,ie)},U=Z=>{var ie=H0(),G=pe(ie);ss(G,{class:"h-4 w-4"});var ae=R(G,2),ye=E(ae);C(ae),_e(()=>ge(ye,`Compress (${x(h).length??""})`)),W(Z,ie)};ce(L,Z=>{x(d)||x(v)?Z(H):Z(U,!1)})}C(B),_e(()=>B.disabled=x(d)||x(v)),W(T,B)},J=T=>{var B=Te(),L=pe(B);{var H=U=>{var Z=q0();Z.__click=P;var ie=E(Z);{let ye=Ke(()=>x(d)||x(v)?"animate-spin":"");Hs(ie,{get class(){return`h-4 w-4 ${x(ye)??""}`}})}var G=R(ie,2),ae=E(G,!0);C(G),C(Z),_e(()=>{Z.disabled=x(d)||x(v),ge(ae,x(d)||x(v)?"Working...":"Re-compress")}),W(U,Z)};ce(L,U=>{x(m)&&U(H)},!0)}W(T,B)};ce(at,T=>{x(g)?T(w):T(J,!1)})}C(Q),C(k);var X=R(k,2);{var F=T=>{var B=tg(),L=E(B),H=E(L),U=E(H),Z=E(U);Dd(Z,{class:"text-surface-400 h-4 w-4"});var ie=R(Z,4);Cn(ie,{content:"Downscaling reduces file size significantly. 1080p is usually sufficient for most uses. Higher resolutions are best for archival or professional work."}),C(U);var G=R(U,2);yt(G,21,()=>ou,Tt,(Ze,et)=>{var $e=G0();$e.__click=()=>z(x(et).value);var je=E($e),st=E(je,!0);C(je);var nt=R(je,2);{var ot=It=>{var Lt=K0(),Kr=E(Lt,!0);C(Lt),_e(()=>ge(Kr,x(et).pixels)),W(It,Lt)};ce(nt,It=>{x(et).pixels&&It(ot)})}C($e),_e(()=>{Ge($e,1,`rounded-lg px-3 py-2 text-left text-sm transition-all ${de.settings.resolution===x(et).value?"bg-accent-start/20 text-accent-start ring-accent-start/50 ring-1":"text-surface-400 hover:text-surface-200 hover:bg-surface-700/50"}`),ge(st,x(et).label)}),W(Ze,$e)}),C(G),C(H);var ae=R(H,2),ye=E(ae),ke=E(ye);Ld(ke,{class:"text-surface-400 h-4 w-4"});var Ie=R(ke,4);Cn(Ie,{content:"AAC is most compatible with all devices. Opus offers better quality at lower bitrates. Keep Original skips re-encoding for fastest processing."}),C(ye);var Fe=R(ye,2);yt(Fe,21,()=>s,Tt,(Ze,et)=>{var $e=Q0();$e.__click=()=>D(x(et).value);var je=E($e),st=E(je,!0);C(je);var nt=R(je,2),ot=E(nt,!0);C(nt),C($e),_e(()=>{Ge($e,1,`rounded-lg px-3 py-2 text-left text-sm transition-all ${de.settings.audioCodec===x(et).value?"bg-accent-start/20 text-accent-start ring-accent-start/50 ring-1":"text-surface-400 hover:text-surface-200 hover:bg-surface-700/50"}`),ge(st,x(et).label),ge(ot,x(et).desc)}),W(Ze,$e)}),C(Fe);var Oe=R(Fe,2);{var Qe=Ze=>{var et=Z0(),$e=R(E(et),2);yt($e,21,()=>cu,Tt,(je,st)=>{var nt=X0();nt.__click=()=>M(x(st).value);var ot=E(nt,!0);C(nt),_e(()=>{Ge(nt,1,`flex-1 rounded px-2 py-1.5 text-xs transition-all ${de.settings.audioBitrate===x(st).value?"bg-accent-start text-white":"text-surface-400 hover:text-surface-200 hover:bg-surface-700/50"}`),ct(nt,"title",x(st).desc),ge(ot,x(st).label)}),W(je,nt)}),C($e),C(et),W(Ze,et)};ce(Oe,Ze=>{de.settings.audioCodec!=="none"&&de.settings.audioCodec!=="copy"&&Ze(Qe)})}C(ae);var Re=R(ae,2),tt=E(Re),ht=E(tt);ic(ht,{class:"text-surface-400 h-4 w-4"});var it=R(ht,4);Cn(it,{content:"Faster encoding produces larger files. Slower encoding achieves better compression at the same quality level. Use 'Quality' for final exports."}),C(tt);var pt=R(tt,2);yt(pt,21,()=>n,Tt,(Ze,et)=>{var $e=J0();$e.__click=()=>$(x(et).value);var je=E($e),st=E(je),nt=E(st,!0);C(st);var ot=R(st,2),It=E(ot,!0);C(ot),C(je);var Lt=R(je,2);yt(Lt,20,()=>Array(4),Tt,(Kr,_r,Gr)=>{var ga=Y0();_e(()=>Ge(ga,1,`h-3 w-1.5 rounded-sm ${Gr<x(et).speed?"bg-green-500":"bg-surface-600"}`)),W(Kr,ga)}),C(Lt),C($e),_e(()=>{Ge($e,1,`flex w-full items-center justify-between rounded-lg px-3 py-2.5 text-sm transition-all ${de.settings.preset===x(et).value?"bg-accent-start/20 text-accent-start ring-accent-start/50 ring-1":"text-surface-400 hover:text-surface-200 hover:bg-surface-700/50"}`),ge(nt,x(et).label),ge(It,x(et).desc)}),W(Ze,$e)}),C(pt),C(Re);var Ht=R(Re,2),Yt=E(Ht),Be=E(Yt);Ks(Be,{class:"text-surface-400 h-4 w-4"}),Me(2),C(Yt);var Ae=R(Yt,2),He=E(Ae),dt=E(He);Ta(dt),dt.__change=Ze=>de.updateSettings({stripMetadata:Ze.currentTarget.checked}),Me(2),C(He);var Nt=R(He,2),Je=E(Nt);Ta(Je),Je.__change=Ze=>de.updateSettings({twoPass:Ze.currentTarget.checked});var ut=R(Je,2),rr=E(ut),jt=R(rr,2),dr=R(E(jt));{var xt=Ze=>{var et=eg();W(Ze,et)};ce(dr,Ze=>{de.settings.outputFormat==="webm"&&Ze(xt)})}C(jt),C(ut),C(Nt),C(Ae);var zt=R(Ae,2),_t=E(zt),Pt=E(_t);ns(Pt,{class:"text-surface-400 mt-0.5 h-4 w-4 flex-shrink-0"});var Et=R(Pt,2),gt=E(Et);{var vt=Ze=>{var et=yr(`AV1 offers 30-50% better compression than H.264. Requires modern hardware with AV1
									encoder.`);W(Ze,et)},ir=Ze=>{var et=Te(),$e=pe(et);{var je=nt=>{var ot=yr(`HEVC/H.265 offers ~40% better compression than H.264. Wide hardware support on
									modern devices.`);W(nt,ot)},st=nt=>{var ot=Te(),It=pe(ot);{var Lt=_r=>{var Gr=yr("VP9 provides excellent compression for web delivery with wide browser support.");W(_r,Gr)},Kr=_r=>{var Gr=yr("H.264/MP4 is the most compatible format, playable on virtually all devices.");W(_r,Gr)};ce(It,_r=>{de.settings.outputFormat==="webm"?_r(Lt):_r(Kr,!1)},!0)}W(nt,ot)};ce($e,nt=>{de.settings.outputFormat==="hevc"?nt(je):nt(st,!1)},!0)}W(Ze,et)};ce(gt,Ze=>{de.settings.outputFormat==="av1"?Ze(vt):Ze(ir,!1)})}C(Et),C(_t),C(zt),C(Ht),C(L),C(B),_e(()=>{Os(dt,de.settings.stripMetadata),Os(Je,de.settings.twoPass),Je.disabled=de.settings.outputFormat==="webm",Ge(rr,1,`text-surface-300 group-hover:text-surface-100 text-sm font-medium transition-colors ${de.settings.outputFormat==="webm"?"opacity-50":""}`)}),ft(3,B,()=>Ba,()=>({duration:200})),W(T,B)};ce(X,T=>{x(l)&&T(F)})}C(O),_e(()=>{Ge(me,1,`flex items-center gap-1.5 rounded-lg px-3 py-2.5 text-sm font-medium transition-all sm:py-1.5 ${x(p)?"bg-accent-start shadow-accent-start/30 text-white shadow-md":"text-surface-400 hover:text-surface-200 hover:bg-surface-700/50"}`),ge(q,`${x(p)?`${de.settings.targetSizeMB} MB`:"Select..."} `)}),W(r,O),Xt()}Wt(["click","keydown","change"]);var ag=re('<div class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4" role="dialog" aria-modal="true" aria-labelledby="modal-title" tabindex="-1"><div class="glass w-full max-w-md rounded-2xl p-6 shadow-2xl"><div class="mb-4 flex items-start justify-between"><div class="flex items-center gap-3"><div class="flex h-10 w-10 items-center justify-center rounded-xl bg-red-500/20 text-red-500"><!></div> <h2 id="modal-title" class="text-surface-100 text-lg font-semibold"> </h2></div> <button class="text-surface-400 hover:bg-surface-700 hover:text-surface-100 rounded-lg p-2 transition-colors" aria-label="Close"><!></button></div> <p class="text-surface-400 mb-6"> </p> <div class="flex justify-end gap-3"><button class="bg-surface-700 text-surface-300 hover:bg-surface-600 rounded-xl px-5 py-2.5 text-sm font-medium transition-all">Cancel</button> <button class="rounded-xl bg-red-500 px-5 py-2.5 text-sm font-medium text-white shadow-lg shadow-red-500/30 transition-all hover:bg-red-600 hover:shadow-xl hover:shadow-red-500/40"> </button></div></div></div>');function ng(r,e){Qt(e,!0);let t=mr(e,"open",3,!1),i=mr(e,"title",3,"Confirm"),a=mr(e,"message",3,"Are you sure?"),s=mr(e,"confirmText",3,"Confirm");function n(u){u.key==="Escape"&&e.oncancel()}function o(u){u.target===u.currentTarget&&e.oncancel()}var c=Te(),l=pe(c);{var d=u=>{var f=ag();f.__click=o,f.__keydown=n;var h=E(f),g=E(h),m=E(g),v=E(m),p=E(v);rc(p,{class:"h-5 w-5"}),C(v);var b=R(v,2),y=E(b,!0);C(b),C(m);var _=R(m,2);_.__click=function(...P){e.oncancel?.apply(this,P)};var S=E(_);kr(S,{class:"h-5 w-5"}),C(_),C(g);var A=R(g,2),z=E(A,!0);C(A);var D=R(A,2),M=E(D);M.__click=function(...P){e.oncancel?.apply(this,P)};var $=R(M,2);$.__click=function(...P){e.onconfirm?.apply(this,P)};var K=E($,!0);C($),C(D),C(h),C(f),_e(()=>{ge(y,i()),ge(z,a()),ge(K,s())}),ft(3,h,()=>Si,()=>({duration:200,start:.95})),ft(3,f,()=>Gt,()=>({duration:150})),W(u,f)};ce(l,u=>{t()&&u(d)})}W(r,c),Xt()}Wt(["click","keydown"]);var sg=re('<span class="text-surface-500">+</span>'),og=re('<!> <kbd class="bg-surface-700 text-surface-200 min-w-[2rem] rounded-lg px-2.5 py-1.5 text-center text-sm font-medium shadow-sm"> </kbd>',1),cg=re('<div class="bg-surface-800/50 flex items-center justify-between rounded-lg px-4 py-3"><span class="text-surface-300"> </span> <div class="flex items-center gap-1.5"></div></div>'),lg=re('<div><h3 class="text-surface-400 mb-4 text-sm font-semibold uppercase tracking-wider"> </h3> <div class="space-y-3"></div></div>'),dg=re(`<div class="fixed inset-0 z-50 flex items-center justify-center p-4"><button class="absolute inset-0 cursor-default bg-black/80 backdrop-blur-sm" aria-label="Close shortcuts"></button> <div class="bg-surface-900 relative max-h-[85vh] w-full max-w-2xl overflow-auto rounded-2xl shadow-2xl ring-1 ring-white/10" role="dialog" aria-modal="true" aria-labelledby="shortcuts-title" tabindex="-1"><div class="border-surface-700/50 bg-surface-900/95 sticky top-0 z-10 flex items-center justify-between border-b p-6 backdrop-blur-sm"><div class="flex items-center gap-3"><div class="from-accent-start/20 to-accent-end/20 text-accent-start flex h-10 w-10 items-center justify-center rounded-xl bg-gradient-to-br"><!></div> <h2 id="shortcuts-title" class="text-surface-100 text-xl font-bold">Keyboard Shortcuts</h2></div> <button class="text-surface-400 hover:bg-surface-800 hover:text-surface-200 rounded-lg p-2 transition-colors" aria-label="Close"><!></button></div> <div class="space-y-8 p-6"></div> <div class="border-surface-700/50 bg-surface-900/95 sticky bottom-0 border-t p-4 text-center backdrop-blur-sm"><p class="text-surface-500 text-sm">Press <kbd class="bg-surface-700 text-surface-300 rounded px-2 py-0.5">?</kbd> anytime to show
					this help</p></div></div></div>`);function ug(r,e){Qt(e,!0);let t=We(void 0);Oi(()=>{if(e.open&&x(t))return cs(x(t))});const i=[{category:"General",items:[{keys:["Cmd/Ctrl","Shift","D"],action:"Download all as ZIP"},{keys:["Cmd/Ctrl","V"],action:"Paste video from clipboard"},{keys:["Escape"],action:"Clear all videos / Close modal"},{keys:["?"],action:"Show keyboard shortcuts"}]},{category:"Quality Presets",items:[{keys:["1"],action:"Tiny quality preset"},{keys:["2"],action:"Web quality preset"},{keys:["3"],action:"Social quality preset"},{keys:["4"],action:"High quality preset"},{keys:["5"],action:"Lossless quality preset"}]},{category:"Output Format",items:[{keys:["M"],action:"Switch to MP4 format"},{keys:["W"],action:"Switch to WebM format"},{keys:["A"],action:"Switch to AV1 format"}]},{category:"Navigation",items:[{keys:["Tab"],action:"Navigate between elements"},{keys:["Enter"],action:"Activate focused element"},{keys:["Space"],action:"Play/pause preview"}]}];function a(c){c.key==="Escape"&&e.onclose()}var s=Te(),n=pe(s);{var o=c=>{var l=dg(),d=E(l);d.__click=function(...y){e.onclose?.apply(this,y)};var u=R(d,2);u.__keydown=a;var f=E(u),h=E(f),g=E(h),m=E(g);ec(m,{class:"h-5 w-5"}),C(g),Me(2),C(h);var v=R(h,2);v.__click=function(...y){e.onclose?.apply(this,y)};var p=E(v);kr(p,{class:"h-5 w-5"}),C(v),C(f);var b=R(f,2);yt(b,21,()=>i,Tt,(y,_)=>{var S=lg(),A=E(S),z=E(A,!0);C(A);var D=R(A,2);yt(D,21,()=>x(_).items,Tt,(M,$)=>{var K=cg(),P=E(K),O=E(P,!0);C(P);var k=R(P,2);yt(k,21,()=>x($).keys,Tt,(Q,se,Y)=>{var be=og(),ee=pe(be);{var me=ue=>{var oe=sg();W(ue,oe)};ce(ee,ue=>{Y>0&&ue(me)})}var q=R(ee,2),V=E(q,!0);C(q),_e(()=>ge(V,x(se))),W(Q,be)}),C(k),C(K),_e(()=>ge(O,x($).action)),W(M,K)}),C(D),C(S),_e(()=>ge(z,x(_).category)),W(y,S)}),C(b),Me(2),C(u),Fi(u,y=>ne(t,y),()=>x(t)),C(l),ft(3,u,()=>Si,()=>({duration:200,start:.95})),ft(3,l,()=>Gt,()=>({duration:150})),W(c,l)};ce(n,c=>{e.open&&c(o)})}W(r,s),Xt()}Wt(["click","keydown"]);var fg=re('<div class="p-6 text-center"><div class="border-accent-start mx-auto h-8 w-8 animate-spin rounded-full border-2 border-t-transparent"></div> <p class="text-surface-400 mt-2 text-sm">Detecting capabilities...</p></div>'),hg=re('<span class="flex items-center gap-1 text-xs font-medium text-green-400"><!> Available</span>'),mg=re('<span class="text-surface-500 flex items-center gap-1 text-xs"><!> Not supported</span>'),pg=re('<span class="font-medium text-green-400">GPU Enabled ðŸš€</span>'),gg=re('<span class="text-amber-400">Software only</span>'),vg=re('<div class="space-y-1.5 text-xs"><div class="flex items-center justify-between"><span class="text-surface-400">Hardware Acceleration</span> <!></div> <div class="flex items-center justify-between"><span class="text-surface-400">Video Codecs</span> <span class="text-surface-200"> </span></div> <div class="flex items-center justify-between"><span class="text-surface-400">Max Resolution</span> <span class="text-surface-200"> </span></div></div>'),bg=re('<span class="flex items-center gap-1 text-xs font-medium text-green-400"><!> Loaded</span>'),wg=re('<span class="text-xs text-amber-400">Loading...</span>'),yg=re('<span class="text-surface-500 text-xs">Not loaded</span>'),kg=re('<div class="space-y-1.5 text-xs"><div class="flex items-center justify-between"><span class="text-surface-400">Threading</span> <span class="text-surface-200"> </span></div> <div class="flex items-center justify-between"><span class="text-surface-400">Codecs</span> <span class="text-surface-200">H.264, VP9, AV1, AAC, Opus</span></div></div>'),xg=re('<span class="flex items-center gap-1 text-xs text-green-400"><!> Yes</span>'),_g=re('<span class="flex items-center gap-1 text-xs text-amber-400"><!> No</span>'),Tg=re('<div class="flex items-center gap-1.5 rounded-md border border-purple-500/20 bg-purple-500/10 px-2 py-1"><!> <span class="text-xs text-purple-300"> </span></div>'),Sg=re('<div class="flex items-center gap-1.5 rounded-md border border-orange-500/20 bg-orange-500/10 px-2 py-1"><!> <span class="text-xs text-orange-300"> </span></div>'),Cg=re('<div class="border-surface-700/50 mt-2 border-t pt-2"><div class="text-surface-400 mb-2 text-xs uppercase tracking-wider">Encoder Usage</div> <div class="flex gap-3"><!> <!></div></div>'),Pg=re('<div class="flex items-center justify-between"><span class="text-surface-300 text-sm">Total saved</span> <span class="font-mono text-sm text-green-400"> </span></div> <div class="flex items-center justify-between"><span class="text-surface-300 text-sm">Avg. savings</span> <span class="text-accent-start font-mono text-sm"> </span></div> <div class="flex items-center justify-between"><span class="text-surface-300 text-sm">Avg. time</span> <span class="text-surface-200 font-mono text-sm"> </span></div> <!>',1),Eg=re('<div class="border-surface-700/50 border-b p-4"><h4 class="text-surface-400 mb-3 text-xs font-semibold uppercase tracking-wider">Encoders</h4> <div class="bg-surface-800/50 mb-2 rounded-lg p-3"><div class="mb-2 flex items-center justify-between"><div class="flex items-center gap-2"><!> <span class="text-surface-200 text-sm font-medium">WebCodecs</span></div> <!></div> <!></div> <div class="bg-surface-800/50 rounded-lg p-3"><div class="mb-2 flex items-center justify-between"><div class="flex items-center gap-2"><!> <span class="text-surface-200 text-sm font-medium">FFmpeg.wasm</span></div> <!></div> <!></div></div> <div class="border-surface-700/50 border-b p-4"><h4 class="text-surface-400 mb-3 text-xs font-semibold uppercase tracking-wider">System</h4> <div class="space-y-2"><div class="flex items-center justify-between"><div class="text-surface-300 flex items-center gap-2 text-sm"><!> CPU Threads</div> <span class="text-surface-200 font-mono text-sm"> </span></div> <div class="flex items-center justify-between"><div class="text-surface-300 flex items-center gap-2 text-sm"><!> Device Memory</div> <span class="text-surface-200 font-mono text-sm"> </span></div> <div class="flex items-center justify-between"><div class="text-surface-300 flex items-center gap-2 text-sm"><!> SharedArrayBuffer</div> <!></div></div></div> <div class="p-4"><h4 class="text-surface-400 mb-3 text-xs font-semibold uppercase tracking-wider">Session Stats</h4> <div class="space-y-2"><div class="flex items-center justify-between"><span class="text-surface-300 text-sm">Videos processed</span> <span class="text-surface-200 font-mono text-sm"> </span></div> <!></div></div> <div class="px-4 pb-4"><div class="rounded-lg border border-purple-500/20 bg-gradient-to-r from-purple-500/10 to-orange-500/10 p-3"><p class="text-surface-300 text-xs"><span class="font-medium text-purple-400">Hybrid Mode:</span> <!></p></div></div>',1),Ig=re('<div class="bg-surface-900 fixed bottom-4 right-4 z-40 w-96 overflow-hidden rounded-2xl shadow-2xl ring-1 ring-white/10"><div class="border-surface-700/50 from-surface-900 to-surface-800 flex items-center justify-between border-b bg-gradient-to-r px-4 py-3"><div class="flex items-center gap-2"><!> <span class="text-surface-200 text-sm font-semibold">Performance Monitor</span></div> <button class="text-surface-400 hover:bg-surface-800 hover:text-surface-200 rounded p-1 transition-colors" aria-label="Close"><!></button></div> <!></div>');function Ag(r,e){Qt(e,!0);let t=We(null),i=We(!0);ua(async()=>{try{ne(t,await Mp(),!0)}catch(d){console.error("Failed to get capabilities:",d)}finally{ne(i,!1)}});const a=Ke(()=>()=>{const d=de.items.filter(p=>p.status==="completed"),u=d.reduce((p,b)=>p+b.originalSize,0),f=d.reduce((p,b)=>p+(b.compressedSize||0),0),h=d.length>0?d.reduce((p,b)=>p+(b.compressionDuration||0),0)/d.length:0,g=u>0?Math.round((1-f/u)*100):0,m=d.filter(p=>p.encoderUsed==="webcodecs").length,v=d.filter(p=>p.encoderUsed==="ffmpeg").length;return{totalProcessed:d.length,totalOriginal:u,totalCompressed:f,totalSaved:u-f,avgCompressionTime:h,avgSavings:g,webCodecsCount:m,ffmpegCount:v}});function s(d){if(d===0)return"0 B";const u=1024,f=["B","KB","MB","GB"],h=Math.floor(Math.log(d)/Math.log(u));return parseFloat((d/Math.pow(u,h)).toFixed(1))+" "+f[h]}function n(d){return d<1e3?`${Math.round(d)}ms`:`${(d/1e3).toFixed(1)}s`}var o=Te(),c=pe(o);{var l=d=>{var u=Ig(),f=E(u),h=E(f),g=E(h);Zo(g,{class:"text-accent-start h-4 w-4"}),Me(2),C(h);var m=R(h,2);m.__click=function(..._){e.onclose?.apply(this,_)};var v=E(m);kr(v,{class:"h-4 w-4"}),C(m),C(f);var p=R(f,2);{var b=_=>{var S=fg();W(_,S)},y=_=>{var S=Te(),A=pe(S);{var z=D=>{var M=Eg(),$=pe(M),K=R(E($),2),P=E(K),O=E(P),k=E(O);Fn(k,{class:"h-4 w-4 text-purple-400"}),Me(2),C(O);var Q=R(O,2);{var se=Be=>{var Ae=hg(),He=E(Ae);ea(He,{class:"h-3 w-3"}),Me(),C(Ae),W(Be,Ae)},Y=Be=>{var Ae=mg(),He=E(Ae);kr(He,{class:"h-3 w-3"}),Me(),C(Ae),W(Be,Ae)};ce(Q,Be=>{x(t).webCodecs.supported?Be(se):Be(Y,!1)})}C(P);var be=R(P,2);{var ee=Be=>{var Ae=vg(),He=E(Ae),dt=R(E(He),2);{var Nt=_t=>{var Pt=pg();W(_t,Pt)},Je=_t=>{var Pt=gg();W(_t,Pt)};ce(dt,_t=>{x(t).webCodecs.hardwareAcceleration?_t(Nt):_t(Je,!1)})}C(He);var ut=R(He,2),rr=R(E(ut),2),jt=E(rr,!0);C(rr),C(ut);var dr=R(ut,2),xt=R(E(dr),2),zt=E(xt);C(xt),C(dr),C(Ae),_e(_t=>{ge(jt,_t),ge(zt,`${x(t).webCodecs.maxResolution.width??""}Ã—${x(t).webCodecs.maxResolution.height??""}`)},[()=>x(t).webCodecs.supportedVideoCodecs.map(_t=>_t.toUpperCase()).join(", ")]),W(Be,Ae)};ce(be,Be=>{x(t).webCodecs.supported&&Be(ee)})}C(K);var me=R(K,2),q=E(me),V=E(q),ue=E(V);qs(ue,{class:"h-4 w-4 text-orange-400"}),Me(2),C(V);var oe=R(V,2);{var j=Be=>{var Ae=bg(),He=E(Ae);ea(He,{class:"h-3 w-3"}),Me(),C(Ae),W(Be,Ae)},te=Be=>{var Ae=Te(),He=pe(Ae);{var dt=Je=>{var ut=wg();W(Je,ut)},Nt=Je=>{var ut=yg();W(Je,ut)};ce(He,Je=>{de.ffmpegLoading?Je(dt):Je(Nt,!1)},!0)}W(Be,Ae)};ce(oe,Be=>{x(t).ffmpegLoaded?Be(j):Be(te,!1)})}C(q);var le=R(q,2);{var he=Be=>{var Ae=kg(),He=E(Ae),dt=R(E(He),2),Nt=E(dt,!0);C(dt),C(He),Me(2),C(Ae),_e(()=>ge(Nt,x(t).ffmpegMultiThreaded?"Multi-threaded":"Single-threaded")),W(Be,Ae)};ce(le,Be=>{x(t).ffmpegLoaded&&Be(he)})}C(me),C($);var we=R($,2),Ee=R(E(we),2),Se=E(Ee),Xe=E(Se),at=E(Xe);An(at,{class:"text-surface-500 h-4 w-4"}),Me(),C(Xe);var w=R(Xe,2),J=E(w,!0);C(w),C(Se);var X=R(Se,2),F=E(X),T=E(F);Fd(T,{class:"text-surface-500 h-4 w-4"}),Me(),C(F);var B=R(F,2),L=E(B);C(B),C(X);var H=R(X,2),U=E(H),Z=E(U);ic(Z,{class:"text-surface-500 h-4 w-4"}),Me(),C(U);var ie=R(U,2);{var G=Be=>{var Ae=xg(),He=E(Ae);ea(He,{class:"h-3 w-3"}),Me(),C(Ae),W(Be,Ae)},ae=Be=>{var Ae=_g(),He=E(Ae);kr(He,{class:"h-3 w-3"}),Me(),C(Ae),W(Be,Ae)};ce(ie,Be=>{x(t).sharedArrayBuffer?Be(G):Be(ae,!1)})}C(H),C(Ee),C(we);var ye=R(we,2),ke=R(E(ye),2),Ie=E(ke),Fe=R(E(Ie),2),Oe=E(Fe,!0);C(Fe),C(Ie);var Qe=R(Ie,2);{var Re=Be=>{var Ae=Pg(),He=pe(Ae),dt=R(E(He),2),Nt=E(dt,!0);C(dt),C(He);var Je=R(He,2),ut=R(E(Je),2),rr=E(ut);C(ut),C(Je);var jt=R(Je,2),dr=R(E(jt),2),xt=E(dr,!0);C(dr),C(jt);var zt=R(jt,2);{var _t=Pt=>{var Et=Cg(),gt=R(E(Et),2),vt=E(gt);{var ir=$e=>{var je=Tg(),st=E(je);Fn(st,{class:"h-3 w-3 text-purple-400"});var nt=R(st,2),ot=E(nt);C(nt),C(je),_e(It=>ge(ot,`${It??""} GPU`),[()=>x(a)().webCodecsCount]),W($e,je)};ce(vt,$e=>{x(a)().webCodecsCount>0&&$e(ir)})}var Ze=R(vt,2);{var et=$e=>{var je=Sg(),st=E(je);qs(st,{class:"h-3 w-3 text-orange-400"});var nt=R(st,2),ot=E(nt);C(nt),C(je),_e(It=>ge(ot,`${It??""} Software`),[()=>x(a)().ffmpegCount]),W($e,je)};ce(Ze,$e=>{x(a)().ffmpegCount>0&&$e(et)})}C(gt),C(Et),W(Pt,Et)};ce(zt,Pt=>{(x(a)().webCodecsCount>0||x(a)().ffmpegCount>0)&&Pt(_t)})}_e((Pt,Et,gt)=>{ge(Nt,Pt),ge(rr,`${Et??""}%`),ge(xt,gt)},[()=>s(x(a)().totalSaved),()=>x(a)().avgSavings,()=>n(x(a)().avgCompressionTime)]),W(Be,Ae)};ce(Qe,Be=>{x(a)().totalProcessed>0&&Be(Re)})}C(ke),C(ye);var tt=R(ye,2),ht=E(tt),it=E(ht),pt=R(E(it),2);{var Ht=Be=>{var Ae=yr("Using GPU acceleration for MP4/WebM, FFmpeg for AV1 and complex operations.");W(Be,Ae)},Yt=Be=>{var Ae=Te(),He=pe(Ae);{var dt=Je=>{var ut=yr("WebCodecs available (software). FFmpeg used as primary encoder.");W(Je,ut)},Nt=Je=>{var ut=yr("FFmpeg.wasm handles all encoding (software).");W(Je,ut)};ce(He,Je=>{x(t).webCodecs.supported?Je(dt):Je(Nt,!1)},!0)}W(Be,Ae)};ce(pt,Be=>{x(t).webCodecs.supported&&x(t).webCodecs.hardwareAcceleration?Be(Ht):Be(Yt,!1)})}C(it),C(ht),C(tt),_e(Be=>{ge(J,x(t).hardwareConcurrency),ge(L,`${x(t).deviceMemory??""} GB`),ge(Oe,Be)},[()=>x(a)().totalProcessed]),W(D,M)};ce(A,D=>{x(t)&&D(z)},!0)}W(_,S)};ce(p,_=>{x(i)?_(b):_(y,!1)})}C(u),ft(3,u,()=>Ba,()=>({duration:200})),W(d,u)};ce(c,d=>{e.open&&d(l)})}W(r,o),Xt()}Wt(["click"]);var Fg=re('<div class="bg-surface-800/50 flex items-start gap-4 rounded-xl p-4"><div><!></div> <div><div class="flex items-center gap-2"><span class="bg-surface-700 text-surface-300 flex h-5 w-5 items-center justify-center rounded-full text-xs font-bold"></span> <h3 class="text-surface-200 font-semibold"> </h3></div> <p class="text-surface-400 mt-1 text-sm"> </p></div></div>'),zg=re(`<div class="fixed inset-0 z-50 flex items-center justify-center p-4"><button class="absolute inset-0 cursor-default bg-black/80 backdrop-blur-sm" aria-label="Close onboarding"></button> <div class="bg-surface-900 relative w-full max-w-2xl overflow-hidden rounded-2xl shadow-2xl ring-1 ring-white/10" role="dialog" aria-modal="true" aria-labelledby="onboarding-title" tabindex="-1"><div class="relative p-6 pb-4 text-center"><button class="text-surface-400 hover:bg-surface-800 hover:text-surface-200 absolute right-4 top-4 rounded-lg p-2 transition-colors" aria-label="Close"><!></button> <h2 id="onboarding-title" class="text-surface-100 text-2xl font-bold">Welcome to <span class="gradient-text">Squash</span></h2> <p class="text-surface-400 mt-2">GPU-accelerated video compression that's 100% private</p></div> <div class="px-6 pb-4"><div class="grid gap-4 sm:grid-cols-2"></div></div> <div class="border-surface-700/50 bg-surface-900/50 flex items-center justify-between border-t px-6 py-4"><label class="flex cursor-pointer items-center gap-2"><input type="checkbox" class="bg-surface-700 border-surface-600 text-accent-start focus:ring-accent-start focus:ring-offset-surface-900 h-4 w-4 rounded"/> <span class="text-surface-400 text-sm">Don't show this again</span></label> <button class="from-accent-start to-accent-end shadow-accent-start/30 hover:shadow-accent-start/40 rounded-xl bg-gradient-to-r px-6 py-2.5 text-sm font-semibold text-white shadow-lg transition-all hover:shadow-xl">Get Started</button></div></div></div>`);function Bg(r,e){Qt(e,!0);let t=We(!1),i=We(void 0);Oi(()=>{if(e.open&&x(i))return cs(x(i))});const a=[{icon:zn,title:"Drop your videos",desc:"Drag files onto the drop zone, click to browse, or paste with Cmd+V. Supports MP4, WebM, MOV, and AVI.",color:"from-orange-500 to-red-500"},{icon:Od,title:"Choose settings",desc:"Pick a quality preset or set a target file size for platforms like WhatsApp or Discord.",color:"from-blue-500 to-cyan-500"},{icon:ss,title:"Compress",desc:"Click the Compress button. GPU acceleration makes it blazing fast. Watch real-time progress.",color:"from-green-500 to-emerald-500"},{icon:za,title:"Download",desc:"Download individual files or get everything as a ZIP. Drag compressed videos directly to your desktop.",color:"from-purple-500 to-pink-500"}];function s(){e.onclose(x(t))}function n(d){d.key==="Escape"&&s()}var o=Te(),c=pe(o);{var l=d=>{var u=zg(),f=E(u);f.__click=s;var h=R(f,2);h.__keydown=n;var g=E(h),m=E(g);m.__click=s;var v=E(m);kr(v,{class:"h-5 w-5"}),C(m),Me(4),C(g);var p=R(g,2),b=E(p);yt(b,21,()=>a,Tt,(z,D,M)=>{var $=Fg(),K=E($),P=E(K);na(P,()=>x(D).icon,(me,q)=>{q(me,{class:"h-5 w-5 text-white"})}),C(K);var O=R(K,2),k=E(O),Q=E(k);Q.textContent=M+1;var se=R(Q,2),Y=E(se,!0);C(se),C(k);var be=R(k,2),ee=E(be,!0);C(be),C(O),C($),_e(()=>{Ge(K,1,`flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-xl bg-gradient-to-br ${x(D).color??""}`),ge(Y,x(D).title),ge(ee,x(D).desc)}),W(z,$)}),C(b),C(p);var y=R(p,2),_=E(y),S=E(_);Ta(S),Me(2),C(_);var A=R(_,2);A.__click=s,C(y),C(h),Fi(h,z=>ne(i,z),()=>x(i)),C(u),wd(S,()=>x(t),z=>ne(t,z)),ft(3,h,()=>Si,()=>({duration:200,start:.95})),ft(3,u,()=>Gt,()=>({duration:150})),W(d,u)};ce(c,d=>{e.open&&d(l)})}W(r,o),Xt()}Wt(["click","keydown"]);var Mg=re('<div class="mb-6 flex items-center gap-3 rounded-2xl border border-amber-500/30 bg-amber-500/10 p-4 sm:p-5"><!> <div><h3 class="font-semibold text-amber-400">Browser Not Supported</h3> <p class="mt-1 text-sm text-amber-300/80"> <strong>Chrome</strong>, <strong>Edge</strong>, or <strong>Safari 16.4+</strong> for the best experience.</p></div></div>'),Rg=re('<div class="glass group flex flex-col items-center gap-3 rounded-2xl p-4 text-center transition-all hover:scale-[1.02] sm:p-5"><div class="from-accent-start/20 to-accent-end/20 text-accent-start flex h-11 w-11 flex-shrink-0 items-center justify-center rounded-xl bg-gradient-to-br"><!></div> <div><h3 class="text-surface-100 text-sm font-semibold"> </h3> <p class="text-surface-500 mt-1 text-xs leading-relaxed"> </p></div></div>'),Dg=re('<div class="mb-8 text-center sm:mb-12"><div class="bg-accent-start/10 text-accent-start mb-4 inline-flex items-center gap-2 rounded-full px-4 py-1.5 text-sm font-medium"><!> GPU-Accelerated â€¢ Free & Open Source</div> <h1 class="mb-4 text-4xl font-bold tracking-tight sm:text-5xl lg:text-6xl"><span class="gradient-text">Compress</span> videos <br class="hidden sm:block"/> <span class="text-surface-400">at warp speed</span></h1> <p class="text-surface-500 mx-auto mb-8 max-w-2xl text-base leading-relaxed sm:text-lg">GPU-accelerated video compression powered by <a href="https://mediabunny.dev" target="_blank" rel="noopener" class="text-accent-start hover:underline">Mediabunny</a> + WebCodecs. <span class="text-surface-300 font-medium">100% private</span> â€” everything runs locally in your browser.</p> <div class="mx-auto mb-10 max-w-3xl"><!></div> <div class="text-surface-500 mb-8 flex items-center justify-center gap-2"><!> <span class="text-sm">Or press <kbd class="bg-surface-800 text-surface-300 rounded px-2 py-0.5">Cmd+V</kbd> to paste from clipboard</span></div> <div class="mb-10 flex items-center justify-center gap-3 sm:gap-4"><div class="flex flex-col items-center"><div class="bg-surface-800/80 border-surface-700/50 rounded-xl border p-3"><!></div> <span class="text-surface-500 mt-1.5 text-[10px]">Your Video</span></div> <div class="flex items-center gap-1.5 sm:gap-2"><!> <div class="rounded-full border border-green-500/30 bg-green-500/15 px-2.5 py-1"><span class="text-xs font-medium text-green-400">Stays Local</span></div> <!></div> <div class="flex flex-col items-center"><div class="from-accent-start to-accent-end shadow-accent-start/20 rounded-xl bg-gradient-to-br p-3 shadow-lg"><!></div> <span class="text-surface-500 mt-1.5 text-[10px]">Compressed</span></div></div> <div class="mx-auto grid max-w-5xl grid-cols-2 gap-4 sm:gap-5 lg:grid-cols-4"></div></div>'),Ng=re('<div class="flex items-center gap-4"><div class="text-surface-500 text-base">Saved: <span class="text-accent-start font-mono text-lg font-semibold"> </span></div> <span class="rounded-full bg-green-500/10 px-3 py-1 text-sm font-bold text-green-500"> </span></div>'),Og=re('<button class="from-accent-start to-accent-end shadow-accent-start/30 hover:shadow-accent-start/40 flex items-center gap-2 rounded-xl bg-gradient-to-r px-5 py-2.5 text-sm font-medium text-white shadow-lg transition-all hover:scale-105 hover:shadow-xl"><!> <span class="hidden sm:inline">Download All</span> <span class="sm:hidden">ZIP</span></button>'),Ug=re('<div class="glass mb-6 flex flex-wrap items-center justify-between gap-4 rounded-2xl p-4 sm:mb-8 sm:gap-6 sm:p-6"><div class="flex flex-wrap items-center gap-4 sm:gap-8"><div class="flex items-center gap-3"><!> <span class="text-surface-500 text-base"><span class="text-surface-100 text-lg font-semibold"> </span> </span></div> <!></div> <div class="flex items-center gap-3"><button title="Performance monitor (P)"><!> <span class="hidden sm:inline">Stats</span></button> <button class="bg-surface-800 text-surface-400 hover:bg-surface-700 hover:text-surface-200 flex items-center gap-2 rounded-xl px-4 py-2.5 text-sm font-medium transition-all" title="Keyboard shortcuts (?)"><!> <span class="hidden sm:inline">Shortcuts</span></button> <!> <button class="bg-surface-800 text-surface-400 flex items-center gap-2 rounded-xl px-5 py-2.5 text-sm font-medium transition-all hover:bg-red-900/20 hover:text-red-400" title="Press Escape to clear"><!> <span class="hidden sm:inline">Clear All</span></button></div></div>'),Vg=re('<div class="flex min-h-screen flex-col"><!> <div class="fixed inset-0 -z-10 overflow-hidden"><div class="from-accent-start/10 to-accent-end/10 absolute -right-1/4 -top-1/2 h-[800px] w-[800px] rounded-full bg-gradient-to-br blur-3xl"></div> <div class="from-accent-end/10 to-accent-start/10 absolute -bottom-1/2 -left-1/4 h-[600px] w-[600px] rounded-full bg-gradient-to-tr blur-3xl"></div></div> <main class="flex-1 px-4 pb-8 pt-24 sm:px-6 sm:pb-12 sm:pt-28 lg:px-8"><div class="mx-auto max-w-7xl"><!> <!> <!> <!> <!> <!></div></main> <!></div> <!> <!> <!> <!> <!>',1);function Xg(r,e){Qt(e,!0);let t=We(!1),i=We(!1),a=We(!1),s=We(!1),n=We(!0),o=We("");const c=Ke(()=>de.items.length>0),l=Ke(()=>de.items.filter(j=>j.status==="completed").length),d=Ke(()=>de.items.filter(j=>j.status==="completed"&&j.compressedSize).reduce((j,te)=>j+(te.originalSize-(te.compressedSize||0)),0)),u=Ke(()=>de.items.length>0&&Math.round(x(d)/de.items.filter(j=>j.status==="completed").reduce((j,te)=>j+te.originalSize,0)*100)||0);function f(j,te="info"){te==="success"?Sa.success(j):te==="error"?Sa.error(j):Sa.info(j)}async function h(){const j=de.items.filter(te=>te.status==="completed"&&te.compressedBlob);j.length>0&&(await Np(j),f(`Downloaded ${j.length} videos as ZIP`,"success"))}async function g(j){const te=j.clipboardData?.items;if(!te)return;const le=[];for(const he of te)if(he.type.startsWith("video/")){const we=he.getAsFile();we&&le.push(we)}if(le.length>0){j.preventDefault();const he=await de.addFiles(le);he.length>0&&f(`Added ${he.length} video(s) â€” click Compress when ready`,"success")}}function m(j){if(j.target instanceof HTMLInputElement||j.target instanceof HTMLTextAreaElement||j.target instanceof HTMLSelectElement)return;const te=j.metaKey||j.ctrlKey;if(te&&j.shiftKey&&j.key.toLowerCase()==="d"){j.preventDefault(),h();return}if(j.key==="Escape"){x(i)?ne(i,!1):x(a)?ne(a,!1):x(c)&&ne(t,!0);return}if(j.key==="?"||j.shiftKey&&j.key==="/"){j.preventDefault(),ne(i,!0);return}const le={1:"tiny",2:"web",3:"social",4:"high",5:"lossless"};if(le[j.key]){j.preventDefault(),de.updateSettings({quality:le[j.key]}),f(`Quality: ${Wa[le[j.key]].label}`,"info");return}if(j.key.toLowerCase()==="m"&&!te){j.preventDefault(),de.updateSettings({outputFormat:"mp4"}),f("Format: MP4","info");return}if(j.key.toLowerCase()==="w"&&!te){j.preventDefault(),de.updateSettings({outputFormat:"webm"}),f("Format: WebM","info");return}if(j.key.toLowerCase()==="p"&&!te){j.preventDefault(),ne(a,!x(a));return}}ua(()=>{const j=Ep();j.supported||(ne(n,!1),ne(o,j.reason||"WebCodecs not supported",!0)),localStorage.getItem("squash-onboarding-seen")||ne(s,!0),setTimeout(()=>{Rp().then(te=>{te&&console.log("WebCodecs encoder ready")})},500)});function v(j){j&&localStorage.setItem("squash-onboarding-seen","true"),ne(s,!1)}const p=[{icon:An,title:"GPU Accelerated",description:"Up to 100x faster with WebCodecs hardware encoding"},{icon:tc,title:"100% Private",description:"Videos never leave your device â€” zero server uploads"},{icon:Id,title:"Pro Codecs",description:"H.264, H.265/HEVC, VP9, AV1, AAC, Opus"},{icon:Bd,title:"Pure WebCodecs",description:"Powered by Mediabunny â€” tiny bundle, instant start"}];var b=Vg();St("keydown",Ji,m),St("paste",Ji,g);var y=pe(b),_=E(y);qd(_,{});var S=R(_,4),A=E(S),z=E(A);{var D=j=>{var te=Mg(),le=E(te);rc(le,{class:"h-6 w-6 flex-shrink-0 text-amber-500"});var he=R(le,2),we=R(E(he),2),Ee=E(we);Me(6),C(we),C(he),C(te),_e(()=>ge(Ee,`${x(o)??""} Please use `)),ft(1,te,()=>Gt,()=>({duration:200})),W(j,te)};ce(z,j=>{x(n)||j(D)})}var M=R(z,2);{var $=j=>{var te=Dg(),le=E(te),he=E(le);An(he,{class:"h-4 w-4"}),Me(),C(le);var we=R(le,6),Ee=E(we);Zs(Ee,{}),C(we);var Se=R(we,2),Xe=E(Se);Sd(Xe,{class:"h-4 w-4"}),Me(2),C(Se);var at=R(Se,2),w=E(at),J=E(w),X=E(J);zi(X,{class:"text-surface-400 h-5 w-5"}),C(J),Me(2),C(w);var F=R(w,2),T=E(F);In(T,{class:"text-surface-600 h-4 w-4"});var B=R(T,4);In(B,{class:"text-surface-600 h-4 w-4"}),C(F);var L=R(F,2),H=E(L),U=E(H);za(U,{class:"h-5 w-5 text-white"}),C(H),Me(2),C(L),C(at);var Z=R(at,2);yt(Z,21,()=>p,Tt,(ie,G,ae)=>{var ye=Rg(),ke=E(ye),Ie=E(ke);na(Ie,()=>x(G).icon,(ht,it)=>{it(ht,{class:"h-5 w-5"})}),C(ke);var Fe=R(ke,2),Oe=E(Fe),Qe=E(Oe,!0);C(Oe);var Re=R(Oe,2),tt=E(Re,!0);C(Re),C(Fe),C(ye),_e(()=>{ge(Qe,x(G).title),ge(tt,x(G).description)}),ft(1,ye,()=>ac,()=>({y:20,delay:100*ae,duration:300})),W(ie,ye)}),C(Z),C(te),ft(1,te,()=>Gt,()=>({duration:300})),W(j,te)};ce(M,j=>{x(c)||j($)})}var K=R(M,2);{var P=j=>{var te=Ug(),le=E(te),he=E(le),we=E(he);zi(we,{class:"text-accent-start h-6 w-6"});var Ee=R(we,2),Se=E(Ee),Xe=E(Se,!0);C(Se);var at=R(Se);C(Ee),C(he);var w=R(he,2);{var J=G=>{var ae=Ng(),ye=E(ae),ke=R(E(ye)),Ie=E(ke,!0);C(ke),C(ye);var Fe=R(ye,2),Oe=E(Fe);C(Fe),C(ae),_e(Qe=>{ge(Ie,Qe),ge(Oe,`-${x(u)??""}%`)},[()=>Mn(x(d))]),W(G,ae)};ce(w,G=>{x(d)>0&&G(J)})}C(le);var X=R(le,2),F=E(X);F.__click=()=>ne(a,!x(a));var T=E(F);Zo(T,{class:"h-4 w-4"}),Me(2),C(F);var B=R(F,2);B.__click=()=>ne(i,!0);var L=E(B);ec(L,{class:"h-4 w-4"}),Me(2),C(B);var H=R(B,2);{var U=G=>{var ae=Og();ae.__click=h;var ye=E(ae);za(ye,{class:"h-5 w-5"}),Me(4),C(ae),W(G,ae)};ce(H,G=>{x(l)>0&&G(U)})}var Z=R(H,2);Z.__click=()=>ne(t,!0);var ie=E(Z);Vd(ie,{class:"h-5 w-5"}),Me(2),C(Z),C(X),C(te),_e(()=>{ge(Xe,x(l)),ge(at,` of ${de.items.length??""} compressed`),Ge(F,1,`bg-surface-800 text-surface-400 hover:bg-surface-700 hover:text-surface-200 flex items-center gap-2 rounded-xl px-4 py-2.5 text-sm font-medium transition-all ${x(a)?"ring-accent-start/50 text-accent-start ring-1":""}`)}),ft(1,te,()=>Gt,()=>({duration:200})),W(j,te)};ce(K,j=>{x(c)&&j(P)})}var O=R(K,2);{var k=j=>{ig(j,{})};ce(O,j=>{x(c)&&j(k)})}var Q=R(O,2);{var se=j=>{Zs(j,{})};ce(Q,j=>{x(c)&&j(se)})}var Y=R(Q,2);{var be=j=>{z0(j,{})};ce(Y,j=>{x(c)&&j(be)})}C(A),C(S);var ee=R(S,2);nu(ee),C(y);var me=R(y,2);ng(me,{get open(){return x(t)},title:"Clear all videos?",get message(){return`This will remove all ${de.items.length??""} videos from the list. This action cannot be undone.`},confirmText:"Clear All",onconfirm:()=>{de.clearAll(),ne(t,!1),f("All videos cleared","info")},oncancel:()=>ne(t,!1)});var q=R(me,2);ug(q,{get open(){return x(i)},onclose:()=>ne(i,!1)});var V=R(q,2);Ag(V,{get open(){return x(a)},onclose:()=>ne(a,!1)});var ue=R(V,2);Bg(ue,{get open(){return x(s)},onclose:v});var oe=R(ue,2);Xd(oe,{}),W(r,b),Xt()}Wt(["click"]);export{Xg as component};
